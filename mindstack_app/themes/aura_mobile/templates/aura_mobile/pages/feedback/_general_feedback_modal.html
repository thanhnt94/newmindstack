<div id="general-feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Gửi phản hồi chung</h3>
            <button id="close-general-feedback" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div class="space-y-4">
            <div>
                <label for="general-feedback-recipient" class="block text-sm font-medium text-gray-700 mb-1">Người nhận</label>
                <select id="general-feedback-recipient" class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">(Mặc định gửi Admin)</option>
                    {% for user in users %}
                        <option value="{{ user.user_id }}">{{ user.username }}{% if user.user_role == 'admin' %} (Admin){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="general-feedback-text" class="block text-sm font-medium text-gray-700 mb-1">Nội dung</label>
                <textarea id="general-feedback-text" rows="5" class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nhập phản hồi của bạn..."></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-general-feedback" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Hủy</button>
                <button id="submit-general-feedback" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Gửi</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    if (window.__generalFeedbackModalInitialized) {
        return;
    }
    window.__generalFeedbackModalInitialized = true;

    const modal = document.getElementById('general-feedback-modal');
    const textarea = document.getElementById('general-feedback-text');
    const select = document.getElementById('general-feedback-recipient');
    const submitBtn = document.getElementById('submit-general-feedback');
    const closeBtns = [
        document.getElementById('close-general-feedback'),
        document.getElementById('cancel-general-feedback')
    ];

    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;

    const showMessage = (message, level = 'info') => {
        if (typeof window.showFlashMessage === 'function') {
            window.showFlashMessage(message, level);
        } else if (message) {
            alert(message);
        }
    };

    function openGeneralFeedbackModal() {
        if (!modal) return;
        if (textarea) textarea.value = '';
        if (select) select.value = '';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeGeneralFeedbackModal() {
        if (!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    async function submitGeneralFeedback() {
        if (!textarea || !submitBtn) return;

        const feedbackText = (textarea.value || '').trim();
        const recipientId = select ? select.value : '';

        if (!feedbackText) {
            showMessage('Vui lòng nhập nội dung phản hồi.', 'warning');
            textarea.focus({ preventScroll: false });
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang gửi...';

        try {
            const headers = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            };

            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }

            const response = await fetch("{{ url_for('feedback.submit_general_feedback') }}", {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    feedback_text: feedbackText,
                    recipient_id: recipientId || null
                })
            });

            const contentType = response.headers.get('content-type') || '';
            const result = contentType.includes('application/json') ? await response.json() : {};

            if (response.ok && result.success) {
                showMessage(result.message, 'success');
                closeGeneralFeedbackModal();
            } else {
                showMessage(result.message || 'Không thể gửi phản hồi. Vui lòng thử lại.', 'danger');
            }
        } catch (error) {
            console.error('Lỗi gửi phản hồi chung:', error);
            showMessage('Lỗi kết nối. Không thể gửi phản hồi.', 'danger');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Gửi';
        }
    }

    if (submitBtn) {
        submitBtn.addEventListener('click', function(event) {
            event.preventDefault();
            submitGeneralFeedback();
        });
    }

    closeBtns.forEach(btn => {
        if (btn) {
            btn.addEventListener('click', function(event) {
                event.preventDefault();
                closeGeneralFeedbackModal();
            });
        }
    });

    window.openGeneralFeedbackModal = openGeneralFeedbackModal;
    window.closeGeneralFeedbackModal = closeGeneralFeedbackModal;
})();
</script>
