<script>
    (function () {
        if (window.initializeFlashcardAudioControls) {
            return;
        }

        window.initializeFlashcardAudioControls = function initializeFlashcardAudioControls(options) {
            const opts = options || {};
            const formElement = opts.form || (opts.formSelector ? document.querySelector(opts.formSelector) : null);
            if (!formElement) {
                return;
            }

            const itemId = opts.itemId || formElement.dataset.itemId || '';
            const regenerateUrl = opts.regenerateUrl || formElement.dataset.regenerateAudioUrl || '';
            const csrfInput = formElement.querySelector('input[name="csrf_token"]');
            const csrfToken = csrfInput ? csrfInput.value : '';

            const audioGroups = Array.from(formElement.querySelectorAll('[data-audio-side]'));
            if (!audioGroups.length) {
                return;
            }

            let currentAudio = null;
            const audioBaseFolder = (formElement.dataset.audioBaseFolder || '').replace(/^\/+|\/+$/g, '');

            const stopCurrentAudio = () => {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                }
            };

            const resolveAudioUrl = (value) => {
                let raw = (value || '').trim();
                if (!raw) {
                    return '';
                }

                if (/^(?:https?:)?\/\//i.test(raw) || raw.startsWith('data:')) {
                    return raw;
                }

                raw = raw.replace(/\\/g, '/');

                if (raw.startsWith('/')) {
                    return raw;
                }

                const uploadsPrefix = 'uploads/';
                if (raw.startsWith(uploadsPrefix)) {
                    raw = raw.slice(uploadsPrefix.length);
                }

                if (audioBaseFolder && !raw.includes('/')) {
                    raw = `${audioBaseFolder}/${raw}`;
                }

                return `/media/${raw}`;
            };

            const toInputValue = (url) => {
                if (!url) {
                    return '';
                }
                const trimmed = url.trim();
                const staticPrefix = '/static/';
                if (trimmed.startsWith(staticPrefix)) {
                    const relative = trimmed.slice(staticPrefix.length);
                    if (audioBaseFolder && relative.startsWith(`${audioBaseFolder}/`)) {
                        return relative.slice(audioBaseFolder.length + 1);
                    }
                    return relative;
                }
                const originStatic = window.location.origin + staticPrefix;
                if (trimmed.startsWith(originStatic)) {
                    const relative = trimmed.slice(originStatic.length);
                    if (audioBaseFolder && relative.startsWith(`${audioBaseFolder}/`)) {
                        return relative.slice(audioBaseFolder.length + 1);
                    }
                    return relative;
                }
                return trimmed;
            };

            audioGroups.forEach(group => {
                const side = (group.dataset.audioSide || 'front').toLowerCase();
                const audioElement = group.querySelector('audio[data-role="audio-player"]');
                const playButton = group.querySelector('[data-role="play-audio"]');
                const regenerateButton = group.querySelector('[data-role="regenerate-audio"]');
                const statusLabel = group.querySelector('[data-role="audio-status"]');
                const openButton = group.querySelector('[data-role="open-audio"]');
                const urlInputId = group.dataset.audioUrlInputId;
                const contentInputId = group.dataset.audioContentInputId;
                const initialUrl = group.dataset.initialAudioUrl || '';

                const urlInput = urlInputId ? formElement.querySelector(`#${urlInputId}`) : null;
                const contentInput = contentInputId ? formElement.querySelector(`#${contentInputId}`) : null;

                if (!audioElement || !playButton) {
                    return;
                }

                const updateStatus = (message, type) => {
                    if (!statusLabel) {
                        return;
                    }
                    statusLabel.textContent = message || '';
                    statusLabel.classList.remove('hidden', 'text-red-500', 'text-green-600', 'text-blue-600', 'text-gray-500');
                    if (!message) {
                        statusLabel.classList.add('hidden');
                        return;
                    }
                    if (type === 'error') {
                        statusLabel.classList.add('text-red-500');
                    } else if (type === 'success') {
                        statusLabel.classList.add('text-green-600');
                    } else if (type === 'info') {
                        statusLabel.classList.add('text-blue-600');
                    } else {
                        statusLabel.classList.add('text-gray-500');
                    }
                };

                const setOpenButtonVisible = (visible) => {
                    if (!openButton) {
                        return;
                    }
                    openButton.classList.toggle('hidden', !visible);
                };

                const syncAudioWithInput = () => {
                    if (!urlInput) {
                        return;
                    }
                    const resolved = resolveAudioUrl(urlInput.value);
                    if (resolved) {
                        audioElement.src = resolved;
                        audioElement.classList.remove('hidden');
                        audioElement.load();
                        updateStatus('Đang tải audio...', 'info');
                        setOpenButtonVisible(false);
                    } else {
                        audioElement.pause();
                        audioElement.removeAttribute('src');
                        audioElement.load();
                        audioElement.classList.add('hidden');
                        updateStatus('', '');
                        setOpenButtonVisible(false);
                    }
                };

                const openAudioInNewTab = () => {
                    const urlToOpen = urlInput ? resolveAudioUrl(urlInput.value) : (audioElement.getAttribute('src') || '');
                    if (!urlToOpen) {
                        updateStatus('Chưa có audio để mở.', 'error');
                        return;
                    }
                    window.open(urlToOpen, '_blank', 'noopener');
                };

                if (initialUrl) {
                    audioElement.src = initialUrl;
                    audioElement.classList.remove('hidden');
                    setOpenButtonVisible(true);
                } else {
                    syncAudioWithInput();
                }

                if (urlInput) {
                    ['input', 'change'].forEach(evt => {
                        urlInput.addEventListener(evt, () => {
                            setOpenButtonVisible(false);
                            updateStatus('', '');
                            syncAudioWithInput();
                        });
                    });
                }

                if (openButton) {
                    openButton.addEventListener('click', (event) => {
                        event.preventDefault();
                        openAudioInNewTab();
                    });
                }

                playButton.addEventListener('click', () => {
                    const sourceUrl = urlInput ? resolveAudioUrl(urlInput.value) : (audioElement.getAttribute('src') || '');
                    if (!sourceUrl) {
                        updateStatus('Chưa có audio. Vui lòng nhập URL hoặc tái tạo.', 'error');
                        return;
                    }

                    if (currentAudio && currentAudio !== audioElement) {
                        stopCurrentAudio();
                    }

                    audioElement.src = sourceUrl;
                    audioElement.play().then(() => {
                        currentAudio = audioElement;
                        updateStatus('Đang phát audio...', 'info');
                    }).catch(error => {
                        console.error('Không thể phát audio:', error);
                        updateStatus('Không thể phát audio. Vui lòng kiểm tra URL.', 'error');
                    });
                });

                audioElement.addEventListener('loadeddata', () => {
                    if (audioElement.src) {
                        updateStatus('Audio sẵn sàng phát.', 'success');
                        setOpenButtonVisible(true);
                    }
                });

                audioElement.addEventListener('ended', () => {
                    if (currentAudio === audioElement) {
                        currentAudio = null;
                    }
                    updateStatus('', '');
                });

                audioElement.addEventListener('pause', () => {
                    if (currentAudio === audioElement && Math.floor(audioElement.currentTime) === 0) {
                        currentAudio = null;
                        updateStatus('', '');
                    }
                });

                audioElement.addEventListener('error', () => {
                    updateStatus('Không thể tải audio. Vui lòng kiểm tra URL.', 'error');
                    setOpenButtonVisible(false);
                });

                if (regenerateButton) {
                    if (!regenerateUrl || !itemId) {
                        regenerateButton.disabled = true;
                        if (!regenerateUrl) {
                            regenerateButton.title = 'Không tìm thấy đường dẫn tái tạo audio.';
                        } else {
                            regenerateButton.title = 'Vui lòng lưu thẻ trước khi tái tạo audio.';
                        }
                    }

                    regenerateButton.addEventListener('click', async () => {
                        if (!regenerateUrl || !itemId) {
                            return;
                        }

                        const contentToRead = contentInput ? contentInput.value.trim() : '';
                        if (!contentToRead) {
                            updateStatus('Vui lòng nhập nội dung audio trước khi tái tạo.', 'error');
                            if (contentInput) {
                                contentInput.focus();
                            }
                            return;
                        }

                        const originalHtml = regenerateButton.dataset.originalHtml || regenerateButton.innerHTML;
                        if (!regenerateButton.dataset.originalHtml) {
                            regenerateButton.dataset.originalHtml = originalHtml;
                        }

                        regenerateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        regenerateButton.disabled = true;
                        playButton.disabled = true;
                        updateStatus('Đang tạo audio...', 'info');
                        setOpenButtonVisible(false);

                        try {
                            const response = await fetch(regenerateUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest',
                                    ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                                },
                                body: JSON.stringify({
                                    item_id: itemId,
                                    side,
                                    content_to_read: contentToRead
                                })
                            });

                            const result = await response.json();

                            if (response.ok && result && result.success && result.audio_url) {
                                const resolved = result.audio_url;
                                const storedValue = (typeof result.stored_value !== 'undefined') ? result.stored_value : result.relative_path;
                                const inputValue = storedValue ? storedValue : toInputValue(resolved);
                                if (urlInput) {
                                    urlInput.value = inputValue;
                                }
                                audioElement.src = resolved;
                                audioElement.classList.remove('hidden');
                                audioElement.load();
                                updateStatus('Đã tạo audio mới.', 'success');
                                setOpenButtonVisible(true);
                            } else {
                                const message = (result && result.message) || 'Không thể tạo audio.';
                                updateStatus(message, 'error');
                                setOpenButtonVisible(false);
                            }
                        } catch (error) {
                            console.error('Lỗi khi tái tạo audio:', error);
                            updateStatus('Không thể kết nối đến máy chủ.', 'error');
                            setOpenButtonVisible(false);
                        } finally {
                            regenerateButton.innerHTML = regenerateButton.dataset.originalHtml || originalHtml;
                            if (regenerateUrl && itemId) {
                                regenerateButton.disabled = false;
                            }
                            playButton.disabled = false;
                        }
                    });
                }
            });

            document.addEventListener('play', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLAudioElement)) {
                    return;
                }

                if (!audioGroups.some(group => group.contains(target))) {
                    return;
                }

                if (currentAudio && currentAudio !== target) {
                    stopCurrentAudio();
                }
                currentAudio = target;
            }, true);
        };
    })();
</script>
