{% set _v = template_version %}
{% extends _v ~ '/base.html' %}
{% block title %}Tổng kết phiên học - {{ summary.mode_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50 flex flex-col">
    <!-- Header with Confetti Background -->
    <div class="relative bg-gradient-to-br from-indigo-600 to-violet-700 pb-24 pt-12 overflow-hidden">
        <!-- Decorative circles -->
        <div class="absolute top-0 left-0 w-64 h-64 bg-white/10 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
        <div class="absolute bottom-0 right-0 w-96 h-96 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3"></div>

        <div class="container mx-auto px-4 relative z-10 text-center">
            <div
                class="inline-flex items-center justify-center w-20 h-20 bg-white/20 backdrop-blur-md rounded-2xl mb-6 shadow-xl ring-4 ring-white/10">
                <i class="fas fa-trophy text-4xl text-amber-300 drop-shadow-md"></i>
            </div>

            <h1 class="text-3xl md:text-4xl font-black text-white mb-2 tracking-tight">Hoàn thành phiên học!</h1>
            <p class="text-indigo-100 text-lg font-medium">{{ summary.container_name }} • {{ summary.mode_name }}</p>
        </div>
    </div>

    <!-- Stats Cars Container -->
    <div class="container mx-auto px-4 -mt-16 pb-12 relative z-20 max-w-4xl">
        <!-- Main Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <!-- Accuracy -->
            <div class="bg-white rounded-2xl p-6 shadow-xl shadow-indigo-900/5 text-center border border-slate-100">
                <div class="text-emerald-500 mb-2">
                    <i class="fas fa-bullseye text-2xl"></i>
                </div>
                <div class="text-3xl font-black text-slate-800 tracking-tight">{{ summary.accuracy }}%</div>
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">Chính xác</div>
            </div>

            <!-- Points -->
            <div class="bg-white rounded-2xl p-6 shadow-xl shadow-indigo-900/5 text-center border border-slate-100">
                <div class="text-amber-500 mb-2">
                    <i class="fas fa-gem text-2xl"></i>
                </div>
                <div class="text-3xl font-black text-slate-800 tracking-tight">+{{ summary.points }}</div>
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">Điểm số</div>
            </div>

            <!-- Correct/Total -->
            <div class="bg-white rounded-2xl p-6 shadow-xl shadow-indigo-900/5 text-center border border-slate-100">
                <div class="text-indigo-500 mb-2">
                    <i class="fas fa-check-circle text-2xl"></i>
                </div>
                <div class="text-3xl font-black text-slate-800 tracking-tight">{{ summary.correct }}/{{ summary.total }}
                </div>
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">Số câu đúng</div>
            </div>

            <!-- Time -->
            <div class="bg-white rounded-2xl p-6 shadow-xl shadow-indigo-900/5 text-center border border-slate-100">
                <div class="text-blue-500 mb-2">
                    <i class="fas fa-clock text-2xl"></i>
                </div>
                <div class="text-3xl font-black text-slate-800 tracking-tight">{{ summary.duration }}</div>
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">Thời gian</div>
            </div>
        </div>

        <!-- NEW: Review Logs Section -->
        <div class="bg-white rounded-2xl shadow-xl shadow-indigo-900/5 border border-slate-100 overflow-hidden mb-8">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-list-ul text-indigo-500"></i>
                    Chi tiết phiên học
                </h2>
                <span class="text-sm font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                    {{ pagination.total }} lượt xem
                </span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr
                            class="bg-slate-50 border-b border-slate-100 text-xs uppercase text-slate-500 font-semibold tracking-wider">
                            <th class="px-6 py-4">STT</th>
                            <th class="px-6 py-4">Nội dung</th>
                            <th class="px-6 py-4 text-center">Đánh giá</th>
                            <th class="px-6 py-4 text-center">Điểm</th>
                            <th class="px-6 py-4 text-right">Thời gian</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for log in logs %}
                        <tr class="hover:bg-slate-50/50 transition-colors">
                            <td class="px-6 py-4 text-slate-400 font-medium text-sm">
                                {{ (pagination.page - 1) * pagination.per_page + loop.index }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-slate-700">
                                    {% if log.item_content %}
                                    {{ log.item_content | safe }}
                                    {% else %}
                                    <span class="text-red-400 italic">Deleted Item #{{ log.item_id }}</span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-slate-400 mt-0.5">
                                    {{ log.timestamp.strftime('%H:%M:%S') }}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if log.rating >= 4 %}
                                <span
                                    class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700 border border-emerald-200">
                                    <i class="fas fa-check"></i> Good
                                </span>
                                {% elif log.rating >= 2 %}
                                <span
                                    class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700 border border-amber-200">
                                    <i class="fas fa-exclamation"></i> Hard
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-rose-100 text-rose-700 border border-rose-200">
                                    <i class="fas fa-times"></i> Again
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center font-bold text-slate-600">
                                {% if log.score_change > 0 %}
                                <span class="text-amber-500">+{{ log.score_change }}</span>
                                {% else %}
                                <span class="text-slate-300">0</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right text-slate-500 text-sm font-mono">
                                {{ (log.duration_ms / 1000) | round(1) }}s
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">
                                Chưa có dữ liệu chi tiết cho phiên học này.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            {% if pagination.pages > 1 %}
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex items-center justify-between">
                <div class="text-sm text-slate-500">
                    Trang <span class="font-bold text-slate-700">{{ pagination.page }}</span> / {{ pagination.pages }}
                </div>
                <div class="flex gap-2">
                    {% if pagination.has_prev %}
                    <a href="{{ url_for('learning.session_summary', session_id=summary.session_id, page=pagination.prev_num) }}"
                        class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm">
                        <i class="fas fa-chevron-left mr-1"></i> Trước
                    </a>
                    {% else %}
                    <span
                        class="px-3 py-1.5 bg-slate-100 border border-slate-200 rounded-lg text-sm font-medium text-slate-300 cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-1"></i> Trước
                    </span>
                    {% endif %}

                    {% if pagination.has_next %}
                    <a href="{{ url_for('learning.session_summary', session_id=summary.session_id, page=pagination.next_num) }}"
                        class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm">
                        Sau <i class="fas fa-chevron-right ml-1"></i>
                    </a>
                    {% else %}
                    <span
                        class="px-3 py-1.5 bg-slate-100 border border-slate-200 rounded-lg text-sm font-medium text-slate-300 cursor-not-allowed">
                        Sau <i class="fas fa-chevron-right ml-1"></i>
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Desktop Action Buttons (Hidden on Mobile) -->
        <div class="hidden md:grid grid-cols-2 gap-4">
            <a href="{{ url_for('dashboard.dashboard') }}"
                class="flex items-center justify-center gap-3 py-4 bg-white border-2 border-slate-200 text-slate-600 font-bold rounded-2xl hover:border-slate-300 hover:bg-slate-50 transition-all shadow-sm group">
                <i class="fas fa-home group-hover:scale-110 transition-transform"></i>
                Về Trang chủ
            </a>

            <a href="{{ url_for('quiz.quiz_learning.dashboard') }}"
                class="flex items-center justify-center gap-3 py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 hover:shadow-lg hover:shadow-indigo-500/25 transition-all group">
                <i class="fas fa-bolt group-hover:scale-110 transition-transform"></i>
                Quiz Hub
            </a>
        </div>
    </div>

    <!-- Mobile Fixed Bottom Navigation Bar - Simple Clean Style -->
    <div class="fixed bottom-0 left-0 right-0 z-50 md:hidden">
        <div class="bg-white border-t border-slate-200 shadow-lg">
            <div class="grid grid-cols-3 h-16">
                <!-- Home -->
                <a href="{{ url_for('dashboard.dashboard') }}"
                    class="flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-slate-600 transition-colors active:scale-95">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-[10px] font-semibold">Trang chủ</span>
                </a>

                <!-- Quiz Hub -->
                <a href="{{ url_for('quiz.quiz_learning.dashboard') }}"
                    class="flex flex-col items-center justify-center gap-1 text-indigo-600 transition-colors active:scale-95">
                    <i class="fas fa-bolt text-xl"></i>
                    <span class="text-[10px] font-semibold">Quiz</span>
                </a>

                <!-- Vocab Hub -->
                <a href="{{ url_for('vocabulary.dashboard') }}"
                    class="flex flex-col items-center justify-center gap-1 text-emerald-500 hover:text-emerald-600 transition-colors active:scale-95">
                    <i class="fas fa-book text-xl"></i>
                    <span class="text-[10px] font-semibold">Từ vựng</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Padding -->
    <div class="h-16 md:hidden"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    // Celebration Confetti
    document.addEventListener('DOMContentLoaded', () => {
        const duration = 3000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

        function random(min, max) {
            return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function () {
            const timeLeft = animationEnd - Date.now();

            if (timeLeft <= 0) {
                return clearInterval(interval);
            }

            const particleCount = 50 * (timeLeft / duration);

            // since particles fall down, start a bit higher than random
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 250);
    });
</script>
{% endblock %}
