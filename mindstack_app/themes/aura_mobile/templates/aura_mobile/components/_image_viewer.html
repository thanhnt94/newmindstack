{# File: v3/components/_image_viewer.html #}
{# MindStack Image Viewer - Lightbox with Zoom & Pan #}

<style>
    /* MindStack Image Viewer CSS */
    .ms-iv-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .ms-iv-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .ms-iv-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 16px;
        display: flex;
        justify-content: flex-end;
        z-index: 10001;
    }

    .ms-iv-close {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .ms-iv-close:hover {
        background: rgba(255, 255, 255, 0.4);
    }

    .ms-iv-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .ms-iv-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        cursor: zoom-in;
        touch-action: none;
    }

    .ms-iv-img.panning {
        transition: none;
        cursor: grabbing;
    }

    .ms-iv-hint {
        position: absolute;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: rgba(255, 255, 255, 0.8);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        pointer-events: none;
        z-index: 10000;
    }
</style>

<script>
    /**
     * MindStack Image Viewer (Lightbox)
     * Feature: Fullscreen, Zoom (Double Tap), Pan (Drag)
     */
    const MsImageViewer = {
        settings: {
            selector: '.zoomable, .quiz-image, .markdown-body img, .js-question-text img, .js-question-media img, .option-button img, .content-display img, .explanation-content img',
            maxScale: 2.5,
            minScale: 1
        },
        state: {
            isOpen: false,
            scale: 1,
            panning: false,
            pointX: 0,
            pointY: 0,
            startX: 0,
            startY: 0
        },
        elements: {
            overlay: null,
            img: null,
            closeBtn: null
        },

        init(customSelector) {
            if (customSelector) this.settings.selector = customSelector;

            document.body.addEventListener('click', (e) => {
                const target = e.target.closest(this.settings.selector);
                if (target && target.tagName === 'IMG') {
                    e.preventDefault();
                    this.open(target.src);
                }
            });

            this.createDom();
        },

        createDom() {
            if (document.getElementById('ms-image-viewer')) return;

            const overlay = document.createElement('div');
            overlay.id = 'ms-image-viewer';
            overlay.className = 'ms-iv-overlay';
            overlay.innerHTML = `
            <div class="ms-iv-header">
                <button class="ms-iv-close"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="ms-iv-container">
                <img src="" class="ms-iv-img" alt="Fullscreen View">
            </div>
            <div class="ms-iv-hint flex items-center justify-center gap-2">
                <i class="fa-solid fa-expand"></i> <span>Chạm 2 lần để phóng to</span>
            </div>
        `;

            document.body.appendChild(overlay);

            this.elements.overlay = overlay;
            this.elements.img = overlay.querySelector('.ms-iv-img');
            this.elements.closeBtn = overlay.querySelector('.ms-iv-close');

            this.bindEvents();
        },

        bindEvents() {
            const { overlay, img, closeBtn } = this.elements;

            closeBtn.addEventListener('click', () => this.close());
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay || e.target.closest('.ms-iv-container')) {
                    // handled in pointer up
                }
            });

            img.addEventListener('dblclick', (e) => this.handleDoubleTap(e));

            let lastTap = 0;
            img.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    this.handleDoubleTap(e);
                    e.preventDefault();
                }
                lastTap = currentTime;
            });

            img.addEventListener('pointerdown', (e) => this.onPointerDown(e));
            img.addEventListener('pointermove', (e) => this.onPointerMove(e));
            img.addEventListener('pointerup', (e) => this.onPointerUp(e));
            img.addEventListener('pointercancel', (e) => this.onPointerUp(e));
            img.addEventListener('dragstart', (e) => e.preventDefault());
        },

        open(src) {
            this.elements.img.src = src;
            this.elements.overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            this.resetTransform();
            this.state.isOpen = true;
        },

        close() {
            this.elements.overlay.classList.remove('active');
            document.body.style.overflow = '';
            this.elements.img.src = '';
            this.state.isOpen = false;
        },

        resetTransform() {
            this.state.scale = 1;
            this.state.pointX = 0;
            this.state.pointY = 0;
            this.updateTransform();
        },

        handleDoubleTap(e) {
            if (this.state.scale > 1) {
                this.state.scale = 1;
                this.state.pointX = 0;
                this.state.pointY = 0;
            } else {
                this.state.scale = this.settings.maxScale;
            }
            this.updateTransform();
        },

        onPointerDown(e) {
            if (this.state.scale <= 1) return;
            e.preventDefault();
            this.state.panning = true;
            this.state.startX = e.clientX - this.state.pointX;
            this.state.startY = e.clientY - this.state.pointY;
            this.elements.img.classList.add('panning');
        },

        onPointerMove(e) {
            if (!this.state.panning) return;
            e.preventDefault();
            this.state.pointX = e.clientX - this.state.startX;
            this.state.pointY = e.clientY - this.state.startY;
            this.updateTransform();
        },

        onPointerUp(e) {
            this.state.panning = false;
            this.elements.img.classList.remove('panning');
        },

        updateTransform() {
            const { scale, pointX, pointY } = this.state;
            this.elements.img.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        }
    };

    // Auto Init
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => MsImageViewer.init());
    } else {
        MsImageViewer.init();
    }
</script>
