<style>
    /* Gamified Score Toast */
    @import url('https://fonts.googleapis.com/css2?family=Titan+One&display=swap');

    .score-toast-game {
        position: fixed;
        top: 35%;
        /* Pushed down to center in card area */
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'Titan One', cursive;
        /* Chunky, playful font */
        font-size: 5rem;
        color: #facc15;
        /* Bright yellow */
        text-shadow:
            3px 3px 0px #b45309,
            /* Dark orange shadow */
            -1px -1px 0 #fff,
            1px -1px 0 #fff,
            -1px 1px 0 #fff,
            1px 1px 0 #fff,
            0 8px 20px rgba(0, 0, 0, 0.3);
        pointer-events: none;
        pointer-events: none;
        z-index: 999999;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        /* Matches MP duration: ~2.1s */
        animation: scoreFloatUpGame 2.1s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }

    .score-toast-icon {
        font-size: 4rem;
        background: linear-gradient(180deg, #fcd34d 0%, #f59e0b 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(2px 2px 0px #b45309);
        animation: scoreSpin 2s ease-out;
    }

    /* Star Burst Background */
    .score-burst {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(253, 224, 71, 0.4) 0%, rgba(255, 255, 255, 0) 70%);
        transform: translate(-50%, -50%) scale(0);
        z-index: -1;
        animation: burstExpand 1.5s ease-out forwards;
        pointer-events: none;
    }

    @keyframes scoreFloatUpGame {
        0% {
            transform: translate(-50%, 0%) scale(0.2) rotate(-15deg);
            opacity: 0;
        }

        /* Entrance done around 20% (~0.4s) */
        20% {
            transform: translate(-50%, -50%) scale(1.2) rotate(5deg);
            opacity: 1;
        }

        /* Hold phase matching MP display time */
        80% {
            transform: translate(-50%, -55%) scale(1) rotate(-3deg);
            opacity: 1;
        }

        /* Exit phase */
        100% {
            transform: translate(-50%, -120%) scale(0.9) rotate(0deg);
            opacity: 0;
        }
    }

    @keyframes scoreSpin {
        0% {
            transform: rotate(-180deg) scale(0);
        }

        100% {
            transform: rotate(0deg) scale(1);
        }
    }

    @keyframes burstExpand {
        0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
        }

        100% {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 0;
        }
    }
</style>

<script>
    // Gamified Score Notification
    window.showScoreToast = function (input) {
        return new Promise((resolve) => {
            let points = 0;
            let breakdown = null;

            if (typeof input === 'object' && input !== null) {
                points = input.total_score || input.score_earned || 0; // Support multiple keys
                breakdown = input.breakdown;
            } else {
                points = Number(input);
            }

            // Only show if positive points
            if (!points || points <= 0) {
                resolve();
                return;
            }

            const el = document.createElement('div');
            el.className = 'score-toast-game flex flex-col items-center !text-[4rem]'; // Override font size slightly for container safety if needed, but keeping main huge

            // Random encouraging emoji sometimes?
            const emojis = ['â­', 'ðŸ’Ž', 'ðŸŽ‰', 'ðŸ”¥'];
            const icon = emojis[Math.floor(Math.random() * emojis.length)];

            // Build Breakdown HTML
            let breakdownHtml = '';
            if (breakdown) {
                // Map keys to readable labels and icons
                const labelMap = {
                    'base': { label: 'CÆ¡ báº£n', icon: '', color: 'text-white' },
                    'streak': { label: 'Chuá»—i', icon: 'ðŸ”¥', color: 'text-orange-300' },
                    'streak_bonus': { label: 'Chuá»—i', icon: 'ðŸ”¥', color: 'text-orange-300' },
                    'time': { label: 'Tá»‘c Ä‘á»™', icon: 'âš¡', color: 'text-yellow-300' },
                    'time_bonus': { label: 'Tá»‘c Ä‘á»™', icon: 'âš¡', color: 'text-yellow-300' },
                    'difficulty': { label: 'Äá»™ khÃ³', icon: 'ðŸ§ ', color: 'text-purple-300' },
                    'difficulty_mult': { label: 'Äá»™ khÃ³', icon: 'ðŸ§ ', color: 'text-purple-300' },
                    'random': { label: 'May máº¯n', icon: 'ðŸ€', color: 'text-green-300' }
                };

                let delay = 0.2;
                breakdownHtml = '<div class="flex flex-col gap-1 mt-[-10px] text-lg font-bold tracking-wide shadow-black drop-shadow-md">';

                for (const [key, value] of Object.entries(breakdown)) {
                    if (key === 'total') continue; // Skip total
                    if (value <= 0 && value !== 1.0) continue; // Skip zero or neutral multipliers (complex logic simplification)

                    const meta = labelMap[key] || { label: key, icon: 'âœ¨', color: 'text-gray-100' };
                    const displayVal = (value % 1 !== 0) ? `x${value}` : `+${value}`; // Float is multiplier, Int is add

                    breakdownHtml += `
                        <div class="flex items-center justify-between gap-4 ${meta.color} animate-fade-in-up" 
                             style="animation: slideUpFade 0.3s ease-out forwards; animation-delay: ${delay}s; opacity: 0; font-family: 'Inter', sans-serif;">
                            <span class="flex items-center gap-1">${meta.icon} ${meta.label}</span>
                            <span>${displayVal}</span>
                        </div>
                    `;
                    delay += 0.1;
                }
                breakdownHtml += '</div>';
            }

            el.innerHTML = `
            <div class="score-burst"></div>
            <div class="flex items-center gap-2" style="z-index: 2;">
                <i class="fas fa-gem score-toast-icon"></i> 
                <span>+${points}</span>
            </div>
            ${breakdownHtml}
            <style>
                @keyframes slideUpFade {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            </style>
        `;

            document.body.appendChild(el);

            // Haptic feedback if available (mobile)
            if (navigator.vibrate) {
                navigator.vibrate([50, 30, 50]); // Pulse pattern
            }

            // Cleanup
            setTimeout(() => {
                el.remove();
                resolve();
            }, 2500); // Increased duration slightly for reading time
        });
    };
</script>