{% include _v ~ '/modules/notification/center.html' %}
{% include _v ~ '/components/_settings_modal.html' %}

{% include _v ~ '/components/_modal.html' %}

{% include _v ~ '/components/_score_toast.html' %}
<script>


    window.showFlashMessage = function (message, category) {
        const container = document.getElementById('flash-messages-container');
        if (!container) return;
        const alertDiv = document.createElement('div');
        alertDiv.className = `flex items-center p-2 rounded-md shadow-lg bg-gray-800 text-white relative text-sm
transition-opacity duration-500 opacity-100 data-dismissible`;
        alertDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i><span>${message}</span><button class="ml-auto pl-2"
    onclick="this.parentNode.remove()">&times;</button>`;
        if (category === 'success') alertDiv.classList.add('bg-green-500');
        else if (category === 'danger') alertDiv.classList.add('bg-red-500');
        else if (category === 'info') alertDiv.classList.add('bg-blue-500');
        else if (category === 'warning') alertDiv.classList.add('bg-yellow-500');
        else alertDiv.classList.add('bg-gray-500');

        container.appendChild(alertDiv);
        setTimeout(() => alertDiv.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            alertDiv.classList.add('opacity-0');
            setTimeout(() => alertDiv.remove(), 500);
        }, 5000);
    };

    // Hàm loadTabContent này sẽ được cập nhật để tải nội dung AJAX cho các tab trong content_dashboard
    // Tuy nhiên, ở đây nó đang được sử dụng để reload trang.
    // Cần lưu ý nếu có xung đột với logic AJAX của content_dashboard
    window.loadTabContent = function (tabName) {
        window.location.reload();
    };

    // --- VOCAB DETAIL VISUALIZATIONS ---
    window.initVocabDetailCharts = function (container = document) {
        const statsContainer = container.querySelector('.stats-container');
        if (!statsContainer) return;

        const historyJson = statsContainer.getAttribute('data-history');
        if (!historyJson) return;

        let history = [];
        try {
            history = JSON.parse(historyJson);
        } catch (e) { console.error("History parse fail", e); return; }

        if (!history || history.length === 0) return;

        // 1. STABILITY TREND CHART
        const chartCanvas = statsContainer.querySelector('#fsrsHistoryChart');
        if (chartCanvas && typeof Chart !== 'undefined') {
            const labels = history.map(h => {
                const d = new Date(h.timestamp);
                return d.getDate() + '/' + (d.getMonth() + 1);
            }).reverse();

            const stabilityData = history.map(h => {
                const s = (h.fsrs_snapshot && h.fsrs_snapshot.stability) ? h.fsrs_snapshot.stability : 0;
                // If stability is 0, let's look at result for visual feedback on new cards
                return s > 0 ? s : (h.result === 'Correct' ? 0.5 : 0.1);
            }).reverse();

            // Destroy existing if any (important for modal re-opens)
            const existingChart = Chart.getChart(chartCanvas);
            if (existingChart) existingChart.destroy();

            new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Độ ổn định (S)',
                        data: stabilityData,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.05)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: stabilityData.length > 20 ? 0 : 3,
                        pointBackgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { size: 9 }, color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 9 },
                                color: '#94a3b8',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 6
                            }
                        }
                    }
                }
            });
        }

        // 2. ACTIVITY HEATMAP (GitHub Style)
        const heatmapWrap = statsContainer.querySelector('#activity-heatmap');
        if (heatmapWrap) {
            heatmapWrap.innerHTML = ''; // Clear
            const weeks = 12;
            const daysPerWeek = 7;
            const totalDays = weeks * daysPerWeek;

            const now = new Date();
            const activityMap = {};

            // Map history dates to 'YYYY-MM-DD'
            history.forEach(h => {
                const dateKey = new Date(h.timestamp).toISOString().split('T')[0];
                activityMap[dateKey] = (activityMap[dateKey] || 0) + 1;
            });

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = `repeat(${weeks}, 1fr)`;
            grid.style.gridTemplateRows = `repeat(${daysPerWeek}, 1fr)`;
            grid.style.gap = '3px';
            grid.style.width = 'fit-content';

            for (let i = 0; i < totalDays; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - (totalDays - 1 - i));
                const dateKey = d.toISOString().split('T')[0];
                const count = activityMap[dateKey] || 0;

                const cell = document.createElement('div');
                cell.style.width = '10px';
                cell.style.height = '10px';
                cell.style.borderRadius = '2px';
                cell.title = `${dateKey}: ${count} lần học`;

                // Colors
                if (count === 0) cell.style.background = '#f1f5f9';
                else if (count === 1) cell.style.background = '#c7d2fe';
                else if (count === 2) cell.style.background = '#818cf8';
                else cell.style.background = '#4f46e5';

                grid.appendChild(cell);
            }
            heatmapWrap.appendChild(grid);
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        // Tự động đóng flash messages
        document.querySelectorAll('[data-dismissible]').forEach(notification => {
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        });


    });
</script>
<script src="{{ url_for('translator.static', filename='js/translator.js') }}"></script>
{# Image Viewer Helper #}
{% include _v ~ '/components/_image_viewer.html' %}