{# File: mindstack_app/templates/v3/components/_modal.html #}
{# Purpose: Unified Global Modal Component (Iframe-based) #}

<div id="modalOverlay" class="aura-modal-overlay">
    <div class="aura-modal-container" style="max-width: 900px; height: 90vh;">
        <div class="aura-modal-header">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;" id="global-modal-title">Th么ng tin</h3>
            <button class="aura-modal-close" onclick="window.closeModal()">&times;</button>
        </div>
        <div class="aura-modal-body" style="padding: 0; position: relative;">
            <iframe id="modalIframe" style="width: 100%; height: 100%; border: none;" allowtransparency="true"></iframe>
            <div id="global-modal-loading" style="position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: white; z-index: 5;">
                <i class="fas fa-spinner fa-spin text-indigo-500 text-2xl"></i>
            </div>
        </div>
    </div>
</div>

<script>
    // Global Modal Functions (V4 Unified)
    window.openModal = function (url, title = 'Th么ng tin') {
        const modalOverlay = document.getElementById('modalOverlay');
        const modalIframe = document.getElementById('modalIframe');
        const titleEl = document.getElementById('global-modal-title');
        const loadingEl = document.getElementById('global-modal-loading');

        if (modalOverlay && modalIframe) {
            if (titleEl) titleEl.textContent = title;
            if (loadingEl) loadingEl.style.display = 'flex';

            let finalUrl = url.includes('?') ? `${url}&is_modal=true` : `${url}?is_modal=true`;
            modalIframe.src = finalUrl;
            modalOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';

            modalIframe.onload = function () {
                if (loadingEl) loadingEl.style.display = 'none';
                try {
                    // Update title from iframe if available
                    const iframeTitle = modalIframe.contentDocument.title;
                    if (iframeTitle && iframeTitle !== 'Mindstack App' && title === 'Th么ng tin') {
                        titleEl.textContent = iframeTitle;
                    }
                } catch (e) { /* Cross-origin */ }
            };
        }
    };

    window.closeModal = function () {
        const modalOverlay = document.getElementById('modalOverlay');
        const modalIframe = document.getElementById('modalIframe');
        if (modalOverlay && modalIframe) {
            modalOverlay.classList.remove('open');
            modalIframe.src = '';
            document.body.style.overflow = '';
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        const modalOverlay = document.getElementById('modalOverlay');

        // Click delegation
        document.addEventListener('click', function (event) {
            const target = event.target.closest('.open-modal-btn');
            if (target && target.dataset.modalUrl) {
                event.preventDefault();
                window.openModal(target.dataset.modalUrl, target.title || 'Th么ng tin');
            }
        });

        if (modalOverlay) {
            modalOverlay.addEventListener('click', function (event) {
                if (event.target === modalOverlay) {
                    window.closeModal();
                }
            });
        }
    });
</script>