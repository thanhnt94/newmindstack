{# Item Stats Charts Component #}
{# These charts are added to the existing item stats modal #}

<style>
    /* Chart containers in item stats modal */
    .item-chart-container {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
    }

    .item-chart-title {
        font-size: 0.875rem;
        font-weight: 700;
        color: #475569;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .item-chart-wrapper {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        height: 250px;
        position: relative;
    }

    .item-chart-wrapper canvas {
        max-height: 100%;
    }

    .no-data-message {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #94a3b8;
        font-size: 0.875rem;
        font-style: italic;
    }
</style>

<script>
    // Enhance existing item stats modal with charts
    (function () {
        // Store the original openItemStatsModal function
        const originalOpenItemStats = window.openItemStatsModal;

        // Override with chart-enhanced version
        window.openItemStatsModal = function (itemId) {
            // Call original function first
            if (originalOpenItemStats) {
                originalOpenItemStats(itemId);
            }

            // Fetch item stats with chart data
            fetch(`/analytics/api/memory/item/${itemId}?mode=flashcard`)
                .then(response => response.json())
                .then(data => {
                    // Add charts to tabs if they don't exist
                    addChartsToItemModal(data);
                })
                .catch(error => {
                    console.error('Error loading item chart data:', error);
                });
        };

        function addChartsToItemModal(data) {
            // Find the stats modal tabs
            const overviewTab = document.querySelector('#item-stats-overview');
            const detailsTab = document.querySelector('#item-stats-details');

            // Add memory power timeline to overview tab
            if (overviewTab && data.chart_data && data.chart_data.memory_power_timeline) {
                addMemoryPowerChart(overviewTab, data.chart_data.memory_power_timeline);
            }

            // Add review frequency chart to details tab
            if (detailsTab && data.chart_data && data.chart_data.memory_power_timeline) {
                addReviewFrequencyChart(detailsTab, data.chart_data.memory_power_timeline);
            }
        }

        function addMemoryPowerChart(container, timeline) {
            // Check if chart already exists
            let chartContainer = container.querySelector('.item-chart-container');
            if (!chartContainer) {
                chartContainer = document.createElement('div');
                chartContainer.className = 'item-chart-container';
                chartContainer.innerHTML = `
                <div class="item-chart-title">ðŸ“ˆ Lá»‹ch sá»­ Memory Power</div>
                <div class="item-chart-wrapper">
                    <canvas id="itemMemoryPowerChart"></canvas>
                </div>
            `;
                container.appendChild(chartContainer);
            }

            // Render chart
            const ctx = chartContainer.querySelector('canvas');
            if (!ctx || timeline.length === 0) {
                chartContainer.querySelector('.item-chart-wrapper').innerHTML =
                    '<div class="no-data-message">ChÆ°a cÃ³ dá»¯ liá»‡u lá»‹ch sá»­</div>';
                return;
            }

            // Destroy existing chart
            if (window.itemMemoryPowerChartInstance) {
                window.itemMemoryPowerChartInstance.destroy();
            }

            const dates = timeline.map(r => r.date);
            const values = timeline.map(r => r.memory_power);

            window.itemMemoryPowerChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Memory Power (%)',
                        data: values,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 13
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                afterLabel: function (context) {
                                    const index = context.dataIndex;
                                    const rating = timeline[index].rating;
                                    const interval = timeline[index].interval;
                                    return [
                                        `Rating: ${rating}/5`,
                                        `Interval: ${interval} phÃºt`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        function addReviewFrequencyChart(container, timeline) {
            // Check if chart already exists
            let chartContainer = container.querySelector('.item-chart-container');
            if (!chartContainer) {
                chartContainer = document.createElement('div');
                chartContainer.className = 'item-chart-container';
                chartContainer.innerHTML = `
                <div class="item-chart-title">ðŸ“Š PhÃ¢n bá»‘ Rating</div>
                <div class="item-chart-wrapper">
                    <canvas id="itemRatingChart"></canvas>
                </div>
            `;
                container.appendChild(chartContainer);
            }

            // Render chart
            const ctx = chartContainer.querySelector('canvas');
            if (!ctx || timeline.length === 0) {
                chartContainer.querySelector('.item-chart-wrapper').innerHTML =
                    '<div class="no-data-message">ChÆ°a cÃ³ dá»¯ liá»‡u lá»‹ch sá»­</div>';
                return;
            }

            // Destroy existing chart
            if (window.itemRatingChartInstance) {
                window.itemRatingChartInstance.destroy();
            }

            // Count rating distribution
            const ratingCounts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            timeline.forEach(r => {
                if (r.rating !== undefined && r.rating !== null) {
                    ratingCounts[r.rating] = (ratingCounts[r.rating] || 0) + 1;
                }
            });

            window.itemRatingChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0 (Again)', '1', '2 (Hard)', '3', '4 (Good)', '5 (Easy)'],
                    datasets: [{
                        label: 'Sá»‘ láº§n',
                        data: [
                            ratingCounts[0],
                            ratingCounts[1],
                            ratingCounts[2],
                            ratingCounts[3],
                            ratingCounts[4],
                            ratingCounts[5]
                        ],
                        backgroundColor: [
                            '#ef4444',  // Red - Again
                            '#f97316',  // Orange
                            '#f59e0b',  // Amber - Hard
                            '#84cc16',  // Lime
                            '#22c55e',  // Green - Good
                            '#10b981'   // Emerald - Easy
                        ],
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            callbacks: {
                                label: function (context) {
                                    const total = Object.values(ratingCounts).reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                                    return `${context.parsed.y} láº§n (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    })();
</script>
