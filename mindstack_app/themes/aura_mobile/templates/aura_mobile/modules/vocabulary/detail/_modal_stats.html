{# Reusable Item Stats Modal #}
<div id="item-stats-modal" class="aura-modal-overlay">
    <div class="aura-modal-container"
        style="max-width: 900px; height: 95vh; display: flex; flex-direction: column; background: #ffffff;">
        <div id="item-stats-container" class="aura-modal-body" style="padding: 0; flex: 1; overflow-y: auto;">
            <!-- Content loaded here -->
        </div>
    </div>
</div>

<!-- Edit Overlay Modal (appears on top of stats modal) -->
<div id="vocab-edit-overlay-modal" class="aura-modal-overlay" style="z-index: 100001;">
    <div class="aura-modal-container" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">
        <div class="aura-modal-header" style="flex-shrink: 0;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;">Chỉnh sửa</h3>
            <button class="aura-modal-close" onclick="closeVocabEditOverlay()">&times;</button>
        </div>
        <div class="aura-modal-body" style="padding: 0; flex: 1; overflow: hidden; position: relative;">
            <iframe id="vocab-edit-iframe" src="" frameborder="0"
                style="width: 100%; height: 100%; border: none;"></iframe>
            <div id="vocab-edit-loading"
                style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; color: #6366f1; gap: 0.75rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <span>Đang tải...</span>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        // [EDIT OVERLAY FUNCTIONS]
        window.openVocabEditOverlay = function (editUrl) {
            const overlay = document.getElementById('vocab-edit-overlay-modal');
            const iframe = document.getElementById('vocab-edit-iframe');
            const loading = document.getElementById('vocab-edit-loading');
            if (!overlay || !iframe) return;

            overlay.classList.add('active');
            if (loading) loading.style.display = 'flex';
            iframe.style.visibility = 'hidden';

            // Append is_modal=true
            const separator = editUrl.includes('?') ? '&' : '?';
            iframe.src = editUrl + separator + 'is_modal=true';

            iframe.onload = function () {
                if (loading) loading.style.display = 'none';
                iframe.style.visibility = 'visible';
            };
        };

        window.closeVocabEditOverlay = function () {
            const overlay = document.getElementById('vocab-edit-overlay-modal');
            const iframe = document.getElementById('vocab-edit-iframe');
            if (overlay) overlay.classList.remove('active');
            if (iframe) iframe.src = '';
        };

        // [MARKER FUNCTION]
        window.toggleVocabMarker = function (itemId, markerType, btn) {
            if (!btn) return;
            const icon = btn.querySelector('i');
            btn.disabled = true;

            fetch('/api/v3/learning/markers/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({ item_id: itemId, marker_type: markerType })
            })
                .then(r => r.json())
                .then(data => {
                    btn.disabled = false;
                    if (data.success) {
                        const isMarked = data.is_marked;
                        if (isMarked) {
                            if (markerType !== 'difficult') {
                                icon.classList.remove('far');
                                icon.classList.add('fas');
                            }
                            btn.classList.add('active');
                            if (markerType === 'difficult') {
                                btn.style.background = '#ffedd5';
                                btn.style.color = '#ea580c';
                            } else if (markerType === 'ignored') {
                                btn.style.background = '#cbd5e1';
                                btn.style.color = '#475569';
                            } else if (markerType === 'favorite') {
                                btn.style.background = '#ffe4e6';
                                btn.style.color = '#e11d48';
                            }
                        } else {
                            if (markerType !== 'difficult') {
                                icon.classList.remove('fas');
                                icon.classList.add('far');
                            }
                            btn.classList.remove('active');
                            btn.style.background = 'white';
                            btn.style.color = '#94a3b8';
                        }
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    btn.disabled = false;
                });
        };

        window.toggleNoteEdit = function (showEdit) {
            const displayMode = document.getElementById('note-display-mode');
            const editMode = document.getElementById('note-edit-mode');
            if (displayMode && editMode) {
                displayMode.style.display = showEdit ? 'none' : 'block';
                editMode.style.display = showEdit ? 'block' : 'none';
                if (showEdit) {
                    const input = document.getElementById('item-note-input');
                    if (input) input.focus();
                }
            }
        };



        window.saveItemNote = function (itemId) {
            const btn = document.getElementById('save-note-btn');
            const input = document.getElementById('item-note-input');
            if (!btn || !input) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

            let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

            fetch('/learn/vocabulary/api/progress/' + itemId + '/note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ note: input.value })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        btn.innerHTML = '<i class="fas fa-check"></i> Đã lưu';
                        btn.style.background = '#10b981';
                        const staticContent = document.getElementById('note-static-content');
                        if (staticContent) staticContent.textContent = input.value || "Chưa có ghi chú nào.";
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '#4f46e5';
                            btn.disabled = false;
                            toggleNoteEdit(false);
                        }, 1000);
                    } else {
                        alert('Lỗi: ' + data.message);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi kết nối');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        };

        // --- ENHANCED TAB-BASED AI FUNCTIONS ---
        window.toggleStatsAiChat = function () {
            const el = document.getElementById('stats-ai-chat-input');
            if (el) {
                el.classList.toggle('hidden');
                if (!el.classList.contains('hidden')) document.getElementById('stats-ai-question')?.focus();
            }
        };

        window.scrollAiTabs = function (direction) {
            const container = document.getElementById('stats-ai-version-tabs');
            if (container) {
                container.scrollBy({ left: direction * 150, behavior: 'smooth' });
            }
        };

        window.loadStatsAiHistory = function (itemId) {
            const tabsContainer = document.getElementById('stats-ai-version-tabs');
            if (!tabsContainer) return;

            fetch('/learn/ai/ai/item/' + itemId + '/contents?type=explanation')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.contents.length > 0) {
                        renderAiSessionTabs(data.contents, itemId);
                        // Auto preview primary or newest
                        const primary = data.contents.find(c => c.is_primary) || data.contents[0];
                        previewStatsAiContent(primary);
                    } else {
                        tabsContainer.innerHTML = '<div class="text-[10px] text-slate-400 py-1">Chưa có dữ liệu AI.</div>';
                        document.getElementById('stats-ai-content-box').innerHTML = '<div class="text-center text-slate-300 py-12"><i class="fas fa-robot text-4xl mb-3 opacity-20"></i><p class="text-xs">Hãy bấm nút phía trên để AI phân tích.</p></div>';
                    }
                })
                .catch(err => {
                    tabsContainer.innerHTML = '<div class="text-[10px] text-red-400 py-1">Lỗi kết nối.</div>';
                });
        };

        window.renderAiSessionTabs = function (contents, itemId) {
            const container = document.getElementById('stats-ai-version-tabs');
            if (!container) return;

            container.innerHTML = contents.map((c, idx) => {
                const rawTitle = c.user_question ? c.user_question : 'Giải thích gốc';
                // Truncate for tab title
                const displayTitle = rawTitle.length > 15 ? rawTitle.substring(0, 15) + '...' : rawTitle;
                const activeClass = c.is_primary ? 'active' : '';

                return `
                    <div class="ai-session-tab ${activeClass}" 
                         onclick="previewStatsAiContent(${JSON.stringify(c).replace(/"/g, '&quot;')}, this)"
                         title="${rawTitle}">
                        ${displayTitle}
                    </div>
                `;
            }).join('');
        };

        window.previewStatsAiContent = function (contentObj, el) {
            if (el) {
                document.querySelectorAll('.ai-session-tab').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
            }

            const box = document.getElementById('stats-ai-content-box');
            if (!box) return;

            // 1. Show Full Question Box if it exists
            const fullQuestionBox = document.getElementById('stats-ai-full-question-box');
            const fullQuestionText = document.getElementById('stats-ai-full-question-text');
            if (contentObj.user_question) {
                fullQuestionBox.classList.remove('hidden');
                fullQuestionText.textContent = '" ' + contentObj.user_question + ' "';
            } else {
                fullQuestionBox.classList.add('hidden');
            }

            // 2. Update Meta Header
            document.getElementById('stats-ai-author').textContent = contentObj.username || 'Hệ thống';
            document.getElementById('stats-ai-model').textContent = (contentObj.model_name || 'AI Coach').toUpperCase();
            document.getElementById('stats-ai-date').textContent = new Date(contentObj.created_at).toLocaleString('vi-VN');

            const typeLabel = document.getElementById('stats-ai-type-label');
            if (typeLabel) {
                typeLabel.textContent = contentObj.user_question ? 'Hỏi đáp' : 'Giải thích';
                typeLabel.className = contentObj.user_question ?
                    'text-[8px] font-black text-white uppercase bg-indigo-500 px-2 py-0.5 rounded-full' :
                    'text-[8px] font-black text-white uppercase bg-slate-400 px-2 py-0.5 rounded-full';
            }

            // 3. Render Answer Content
            const content = contentObj.content_text;
            if (window.renderMarkdown) {
                box.innerHTML = window.renderMarkdown(content);
            } else if (typeof mistune !== 'undefined') {
                box.innerHTML = mistune.html(content);
            } else {
                box.innerHTML = content.replace(/\n/g, '<br>');
            }

            // 4. Update Footer Actions
            const footer = document.getElementById('stats-ai-footer-actions');
            if (footer) {
                footer.innerHTML = !contentObj.is_primary ? `
                    <button onclick="handleSetPrimaryStatsAiContent(${contentObj.content_id}, ${contentObj.item_id})" class="px-3 py-1 bg-white border border-slate-200 text-slate-600 rounded-lg text-[10px] font-bold hover:text-indigo-600 hover:border-indigo-200 transition-all">
                        <i class="fas fa-thumbtack"></i> Ghim mặc định
                    </button>
                ` : '<span class="text-[10px] font-bold text-indigo-500 italic px-2"><i class="fas fa-check-circle"></i> Bản mặc định</span>';
            }
        };

        window.submitStatsAiQuestion = function (itemId) {
            const input = document.getElementById('stats-ai-question');
            const val = input.value.trim();
            if (!val) return;

            generateStatsAIExplanation(itemId, true, val);
            input.value = '';
            toggleStatsAiChat();
        };

        window.handleSetPrimaryStatsAiContent = function (cid, itemId) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            fetch('/learn/ai/ai/content/' + cid + '/set-primary', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            }).then(() => {
                loadStatsAiHistory(itemId);
            });
        };

        window.generateStatsAIExplanation = function (itemId, force = false, customQuestion = null) {
            const box = document.getElementById('stats-ai-content-box');
            if (!box) return;

            box.innerHTML = '<div class="flex flex-col items-center justify-center py-12 text-indigo-500"><i class="fas fa-spinner fa-spin text-3xl mb-3"></i><p class="text-[10px] font-bold animate-pulse">AI ĐANG PHÂN TÍCH...</p></div>';

            let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

            fetch('/learn/ai/ai/get-ai-response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({
                    item_id: itemId,
                    prompt_type: 'explanation',
                    force_regenerate: force,
                    custom_question: customQuestion
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        loadStatsAiHistory(itemId);
                    } else {
                        box.innerHTML = '<div class="text-red-500 p-4 text-center text-xs">Lỗi: ' + data.message + '</div>';
                    }
                })
                .catch(err => {
                    box.innerHTML = '<div class="text-red-500 p-4 text-center text-xs">Lỗi kết nối.</div>';
                });
        };


        // --- TAB SWITCHING FUNCTIONS ---
        window.switchVocabMainTab = function (targetTabId, btn) {
            if (window.event) window.event.preventDefault();
            const container = btn.closest('.stats-container');
            if (!container) return;
            const tabBtns = container.querySelectorAll('.tab-navigation .tab-btn');
            const tabContents = container.querySelectorAll('.tab-content');
            const subNav = container.querySelector('#header-sub-tabs');
            tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === targetTabId));
            tabContents.forEach(content => {
                const id = content.id.replace('tab-', '');
                if (id === targetTabId) {
                    content.style.display = 'block';
                    content.classList.add('active');
                } else {
                    content.style.display = 'none';
                    content.classList.remove('active');
                }
            });
            if (subNav) subNav.style.display = (targetTabId === 'content') ? 'flex' : 'none';

            // Re-init charts if switching to stats tab
            if (targetTabId === 'stats' && window.initVocabDetailCharts) {
                window.initVocabDetailCharts(container);
            }
        };

        window.switchVocabSubTab = function (targetSubId, btn) {
            if (window.event) window.event.preventDefault();
            const container = btn.closest('.stats-container');
            if (!container) return;
            const subBtns = container.querySelectorAll('.sub-tab-navigation .sub-tab-btn');
            const subContents = container.querySelectorAll('.sub-tab-content');
            subBtns.forEach(b => b.classList.toggle('active', b.dataset.subtab === targetSubId));
            subContents.forEach(content => {
                if (content.id === targetSubId) {
                    content.style.display = 'block';
                    content.classList.add('active');
                    if (targetSubId === 'sub-ai' && typeof window.loadStatsAiHistory === 'function') {
                        const markerBtn = container.querySelector('.js-toggle-vocab-marker');
                        const itemId = markerBtn?.onclick?.toString().match(/\d+/)?.[0];
                        if (itemId) window.loadStatsAiHistory(itemId);
                    }
                } else {
                    content.style.display = 'none';
                    content.classList.remove('active');
                }
            });
        };

        window.selectHistoryItem = function (element, index) {
            // 1. Highlight selected item
            document.querySelectorAll('.js-history-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            // 2. GetData
            const historyScript = document.getElementById('vocab-history-data');
            let history = [];
            try {
                history = JSON.parse(historyScript.textContent) || [];
            } catch (e) {
                console.error("Failed to parse history", e);
                return;
            }

            const log = history[index];
            if (!log) return;

            // 3. Update Detail Bar
            const resultEl = document.getElementById('hist-result');
            const modeEl = document.getElementById('hist-mode-badge');
            const timeEl = document.getElementById('hist-time');
            const durEl = document.getElementById('hist-duration');
            const scoreEl = document.getElementById('hist-score');
            const masteryEl = document.getElementById('hist-mastery');

            // Result Style
            if (resultEl) {
                if (log.result === 'Correct') {
                    resultEl.textContent = 'Đúng';
                    resultEl.style.backgroundColor = '#dcfce7';
                    resultEl.style.color = '#16a34a';
                } else {
                    resultEl.textContent = 'Sai';
                    resultEl.style.backgroundColor = '#fee2e2';
                    resultEl.style.color = '#dc2626';
                }
            }

            // Mode & Time
            if (modeEl) modeEl.textContent = log.mode || 'N/A';

            // Format relative time (naive approx)
            if (timeEl) {
                const date = new Date(log.timestamp);
                timeEl.textContent = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            }

            // Duration
            if (durEl) {
                const durSec = Math.round((log.duration_ms || 0) / 1000);
                durEl.textContent = durSec + 's';
            }

            // Score
            if (scoreEl) {
                const scoreVal = log.score_change || 0;
                scoreEl.textContent = scoreVal >= 0 ? '+' + scoreVal : scoreVal;
            }

            // Mastery (Stability)
            if (masteryEl) {
                let stability = '-';
                if (log.fsrs_snapshot && log.fsrs_snapshot.stability) {
                    stability = parseFloat(log.fsrs_snapshot.stability).toFixed(1);
                }
                masteryEl.textContent = stability;
            }
        };

        // Re-init logic
        window.reinitVocabDetailTabs = function () {
            // Placeholder if needed for more complex init
        };

        const initModal = () => {
            const statsModal = document.getElementById('item-stats-modal');
            const statsContainer = document.getElementById('item-stats-container');
            const closeBtns = document.querySelectorAll('.js-close-stats-modal');

            if (statsModal) {
                statsModal.addEventListener('click', function (e) {
                    if (e.target.closest('.js-close-stats-modal')) {
                        statsModal.classList.remove('active');
                    }
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && statsModal && statsModal.classList.contains('active')) {
                    statsModal.classList.remove('active');
                }
            });

            window.openVocabularyItemStats = function (itemId) {
                if (!statsModal || !statsContainer) return;
                statsModal.classList.add('active');
                statsContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 16rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6366f1;"></i></div>';

                fetch('/learn/vocabulary/item/' + itemId + '/stats?modal=true&_cb=' + new Date().getTime())
                    .then(r => r.text())
                    .then(html => {
                        statsContainer.innerHTML = html;
                        if (window.reinitVocabDetailTabs) window.reinitVocabDetailTabs();

                        // Auto-select first history item
                        const firstHist = statsContainer.querySelector('.js-history-item');
                        if (firstHist && typeof window.selectHistoryItem === 'function') {
                            window.selectHistoryItem(firstHist, 0);
                        }

                        // Initialize Charts
                        if (window.initVocabDetailCharts) {
                            window.initVocabDetailCharts(statsContainer);
                        }

                        const aiSub = document.getElementById('sub-ai');
                        if (aiSub && aiSub.style.display !== 'none') {
                            loadStatsAiHistory(itemId);
                        }
                    });
            };
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initModal);
        } else {
            initModal();
        }
    })();
</script>