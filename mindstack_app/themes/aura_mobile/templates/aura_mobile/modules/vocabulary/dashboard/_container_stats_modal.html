{# Container Stats Modal Component #}
{# This modal shows aggregate statistics for the entire vocabulary set #}

<!-- Container Stats Modal -->
<div id="containerStatsModal" class="aura-modal-overlay hidden">
    <div class="aura-modal-container" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">
        <div class="aura-modal-header" style="flex-shrink: 0;">
            <h3 style="margin: 0; font-size: 1.15rem; font-weight: 700;">üìä Th·ªëng k√™: <span
                    id="container-stats-title">Loading...</span></h3>
            <button class="aura-modal-close" onclick="closeContainerStatsModal()">&times;</button>
        </div>

        <div class="aura-modal-body" style="flex: 1; overflow-y: auto; padding: 1rem;">
            <!-- Summary Cards -->
            <div class="stats-summary-cards">
                <div class="summary-card">
                    <div class="summary-label">Kh·∫£ nƒÉng ghi nh·ªõ</div>
                    <div class="summary-value" id="container-mp">--%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">T·ªïng s·ªë th·∫ª</div>
                    <div class="summary-value" id="container-total">--</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">C·∫ßn √¥n t·∫≠p</div>
                    <div class="summary-value" id="container-due">--</div>
                </div>
            </div>

            <!-- Distribution Chart -->
            <div class="chart-section">
                <h4
                    style="font-size: 1rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    üìä Ph√¢n b·ªë</h4>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>

            <!-- Timeline Chart -->
            <div class="chart-section">
                <h4
                    style="font-size: 1rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    üìà Ti·∫øn ƒë·ªô theo th·ªùi gian</h4>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Summary Cards */
    .stats-summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 1rem;
        border-radius: 1rem;
        text-align: center;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .summary-label {
        font-size: 0.65rem;
        color: #64748b;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
    }

    .summary-value {
        font-size: 1.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Chart Sections */
    .chart-section {
        margin-bottom: 1.5rem;
    }

    .chart-container {
        background: white;
        padding: 0.75rem;
        border-radius: 1rem;
        border: 1px solid #f1f5f9;
        position: relative;
        height: 220px;
    }

    .chart-container canvas {
        max-height: 100%;
    }
</style>

<script>
    // Container Stats Modal Functions
    function openContainerStatsModal(containerId, containerName) {
        const modal = document.getElementById('containerStatsModal');
        const titleEl = document.getElementById('container-stats-title');

        if (titleEl) titleEl.textContent = containerName || 'Loading...';

        // Show modal with animation
        modal.classList.remove('hidden');
        // Small delay to allow display:flex to apply before opacity transition
        requestAnimationFrame(() => {
            modal.classList.add('active');
        });

        // Fetch stats data
        fetch(`/learn/vocabulary/api/stats/container/${containerId}?mode=flashcard`)
            .then(response => response.json())
            .then(data => {
                // Update summary cards
                document.getElementById('container-mp').textContent = (data.retention_rate || 0) + '%';
                document.getElementById('container-total').textContent = data.total_items || 0;
                document.getElementById('container-due').textContent = data.due_items || 0;

                // Render charts with timezone label
                renderDistributionChart(data.chart_data.distribution);
                renderTimelineChart(data.chart_data.timeline, data.timezone_label);
            })
            .catch(error => {
                console.error('Error loading container stats:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™. Vui l√≤ng th·ª≠ l·∫°i.');
                closeContainerStatsModal();
            });
    }

    function closeContainerStatsModal() {
        console.log("closeContainerStatsModal called");
        const modal = document.getElementById('containerStatsModal');
        if (!modal) {
            console.error("modal element not found");
            return;
        }
        modal.classList.remove('active');

        // Wait for transition to finish before hiding display
        setTimeout(() => {
            modal.classList.add('hidden');
            console.log("modal hidden added");
        }, 300);


        // Destroy existing charts
        if (window.distributionChartInstance) {
            window.distributionChartInstance.destroy();
            window.distributionChartInstance = null;
        }
        if (window.timelineChartInstance) {
            window.timelineChartInstance.destroy();
            window.timelineChartInstance = null;
        }
    }

    // Chart Rendering Functions
    function renderDistributionChart(distribution) {
        const ctx = document.getElementById('distributionChart');
        if (!ctx) return;

        // Destroy existing chart
        if (window.distributionChartInstance) {
            window.distributionChartInstance.destroy();
        }

        window.distributionChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Y·∫øu', 'Trung b√¨nh', 'T·ªët'],
                datasets: [{
                    label: 'Kh·∫£ nƒÉng ghi nh·ªõ (%)',
                    data: [distribution.weak, distribution.medium, distribution.strong],
                    backgroundColor: [
                        '#ef4444',  // Red for weak
                        '#f59e0b',  // Orange for medium
                        '#10b981'   // Green for strong
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 10,
                                family: 'Inter, sans-serif'
                            },
                            padding: 10,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderTimelineChart(timeline, tzLabel) {
        const ctx = document.getElementById('timelineChart');
        if (!ctx) return;

        // Destroy existing chart
        if (window.timelineChartInstance) {
            window.timelineChartInstance.destroy();
        }

        // Filter out null values and create corresponding dates
        const validData = [];
        const validDates = [];
        timeline.dates.forEach((date, index) => {
            if (timeline.values[index] !== null) {
                validDates.push(date);
                validData.push(timeline.values[index]);
            }
        });

        window.timelineChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: validDates,
                datasets: [{
                    label: 'Kh·∫£ nƒÉng ghi nh·ªõ (' + (tzLabel || 'UTC') + ')',
                    data: validData,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function (value) {
                                return value + '%';
                            },
                            font: { size: 9 }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: { size: 9 }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // Close modal on outside click
    document.addEventListener('click', function (e) {
        const modal = document.getElementById('containerStatsModal');
        if (e.target === modal) {
            closeContainerStatsModal();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeContainerStatsModal();
        }
    });
</script>