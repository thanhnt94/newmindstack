{# Vocabulary Learning Hub - Set Detail View v4.0 #}

{% set _v = template_version or 'aura_mobile' %}
{% extends _v ~ '/layouts/base.html' %}

{% from _v ~ '/components/components/dashboard_header.html' import render_dashboard_header, mobile_footer,
render_unified_header with context %}

{% block title %}Chi tiết bộ thẻ - MindStack{% endblock %}

{% block head %}
{{ super() }}
{% include _v ~ '/components/_markdown_assets.html' %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
    :root {
        --vocab-primary: #4f46e5;
        --vocab-primary-light: #818cf8;
        --vocab-primary-dark: #4f46e5;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
    }



    /* Steps visibility */
    .vocab-step {
        display: none;
    }

    .vocab-step.active {
        display: block;
    }

    /* Unified Mobile-First Styles */
    body>header,
    body>footer {
        display: none !important;
    }

    body>main {
        padding: 0 !important;
        margin: 0 !important;
        max-width: none !important;
    }

    .vocab-step {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 100;
        background: #f8fafc;
        flex-direction: column;
        overflow: hidden;
        /* Changed from overflow-y: auto to fix header/footer */
    }

    .vocab-step.active {
        display: flex;
    }

    /* Scrollable middle area */
    .vocab-scroll {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
    }

    /* Fixed bottom elements styling */
    /* Fixed bottom elements styling */
    .vocab-pagination-bar {
        flex-shrink: 0;
        background: white;
        border-top: 1px solid #f1f5f9;
        z-index: 50;
        /* Increased */
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
    }

    /* Override 'visible' class if it was doing display: flex */
    .vocab-pagination-bar.visible {
        display: flex !important;
    }

    .vocab-footer {
        flex-shrink: 0;
        z-index: 10;
        background: white;
    }


    /* Modal hide by default - but allow inline style override */
    .vocab-modal:not([style*="flex"]),
    .edit-modal-overlay:not(.active) {
        display: none;
    }

    /* Word List Grid - Responsive Override */
    .js-word-list {
        display: grid !important;
        gap: 1rem !important;
        grid-template-columns: 1fr !important;
    }

    @media (min-width: 768px) {
        .js-word-list {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }

    @media (min-width: 1200px) {
        .js-word-list {
            grid-template-columns: repeat(3, 1fr) !important;
        }
    }



    /* Word Card Fix */
    .js-word-list>div {
        margin-bottom: 0 !important;
    }
</style>
<link rel="stylesheet" href="{{ url_for('static', filename='aura_mobile/vocabulary/css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='aura_mobile/vocabulary/css/dashboard_detail.css') }}">
{% endblock %}





{% block content %}
<div id="vocab-detail-wrapper">
    <!-- Detail View - Unified -->
    <div id="detail-view-wrapper" class="js-detail-view-wrapper">
        <div id="step-detail" class="vocab-step active">
            {% call render_unified_header(title='Tên bộ thẻ', score_overview=score_overview,
            back_url='/learn/vocabulary/', hide_default_actions=True) %}
            <a href="javascript:void(0)"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-slate-500 border border-slate-100 shadow-sm js-edit-set-btn open-modal-btn"
                title="Sửa bộ thẻ" style="display: none;">
                <i class="fas fa-edit text-xs"></i>
            </a>
            <a href="{{ url_for('vocabulary.dashboard') }}"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-slate-500 border border-slate-100 shadow-sm"
                title="Trang chủ">
                <i class="fas fa-home text-xs"></i>
            </a>
            {% endcall %}

            <div class="vocab-scroll">
                <div class="vocab-detail-hero js-detail-cover">
                    <i class="fas fa-book-open"></i>
                </div>

                <div class="vocab-detail-content" style="opacity: 0; transition: opacity 0.3s;">
                    <!-- [MOVED] Active Session Banner -->
                    <div id="active-session-banner-detail" style="display: none;"
                        class="mb-6 rounded-2xl bg-orange-50/80 backdrop-blur border border-orange-100 p-4 shadow-xl shadow-orange-500/10 animate-fadeIn">
                        <div class="flex items-center gap-4">
                            <div
                                class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-orange-400 to-amber-500 flex items-center justify-center text-white shadow-lg shadow-orange-500/30">
                                <i class="fas fa-history text-xl animate-pulse"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-sm font-bold text-orange-900 flex items-center gap-2 mb-1">
                                    <span class="truncate">Đang học dở:</span>
                                    <span
                                        class="js-active-mode-name text-orange-700 uppercase bg-white/50 px-2 py-0.5 rounded text-xs tracking-wider border border-orange-100">--</span>
                                </h3>
                                <div class="flex gap-3 mt-2">
                                    <button
                                        class="js-resume-session px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white text-xs font-bold rounded-lg transition-all shadow-md hover:shadow-lg flex items-center gap-2 group">
                                        <span>Tiếp tục ngay</span> <i
                                            class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h1 class="vocab-detail-title js-detail-title-full">Tên bộ thẻ</h1>
                    <div class="vocab-creator-inline">
                        <div class="vocab-creator-avatar-small js-creator-avatar">A</div>
                        <span class="vocab-creator-name-small js-creator-name">Admin</span>
                    </div>
                    <p class="vocab-detail-desc js-detail-desc">Mô tả bộ thẻ...</p>



                    <!-- Tab Navigation -->
                    <div class="px-4 border-b border-slate-100 flex items-center gap-6 mt-6 mb-4">
                        <button
                            class="py-3 text-sm font-semibold text-indigo-600 border-b-2 border-indigo-600 transition-colors"
                            onclick="switchDetailTab('list')" id="tab-btn-list">
                            Danh sách từ vựng <span id="tab-list-count"
                                class="ml-1 text-xs bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full border border-indigo-100 hidden"></span>
                        </button>
                        <button
                            class="py-3 text-sm font-medium text-slate-500 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-300 transition-colors"
                            onclick="switchDetailTab('stats')" id="tab-btn-stats">
                            Thống kê
                        </button>
                    </div>

                    <!-- Tab Content: Vocabulary List -->
                    <div id="tab-content-list">
                        <!-- Stats (Moved) -->
                        <div class="vocab-detail-stats mb-6">
                            <div class="vocab-stat">
                                <div class="vocab-stat-value js-card-count">0</div>
                                <div class="vocab-stat-label">Flashcard</div>
                            </div>
                            <div class="vocab-stat vocab-stat-progress">
                                <div class="vocab-stat-value vocab-stat-count js-progress-count">0/0</div>
                                <div class="vocab-stat-label">Đã học</div>
                            </div>
                        </div>

                        <!-- Vocab List -->
                        <div id="detail-vocab-list" class="js-word-list space-y-4 px-4 pb-24">
                            <!-- Items rendered by JS -->
                            <div class="flex flex-col gap-4">
                                {% for i in range(5) %}
                                <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm animate-pulse">
                                    <div class="h-4 bg-slate-100 rounded w-1/4 mb-4"></div>
                                    <div class="h-16 bg-slate-50 rounded-xl mb-3"></div>
                                    <div class="h-16 bg-slate-50 rounded-xl"></div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Fixed Pagination for Detail View (Moved inside Tab) -->
                        <div id="detail-pagination-bar" class="vocab-pagination-bar">
                            <button class="pagination-nav-btn js-detail-prev-page" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="pagination-pages js-detail-page-numbers">
                                <span class="page-num active">1</span>
                            </div>
                            <button class="pagination-nav-btn js-detail-next-page" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <!-- Pagination Desktop -->
                        <div class="hidden md:flex justify-center py-6 border-t border-slate-100 js-detail-pagination-bar-desktop"
                            id="detail-pagination-bar-desktop">
                            <!-- Pagination rendered by JS here -->
                        </div>
                    </div>

                    <!-- Tab Content: Statistics (Leaderboard) -->
                    <div id="tab-content-stats" class="hidden px-4 pb-24">
                        <div
                            class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-6 text-white mb-6 shadow-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-white/10 rounded-full blur-2xl">
                            </div>
                            <div class="relative z-10">
                                <h3 class="text-lg font-bold mb-1">Bảng vàng thành tích</h3>
                                <p class="text-indigo-100 text-sm mb-4">Top những người học chăm chỉ nhất bộ thẻ này.
                                </p>

                                <!-- Timeframe Filters -->
                                <div class="flex gap-2 bg-black/20 p-1 rounded-lg backdrop-blur-sm inline-flex">
                                    <button
                                        class="px-3 py-1 text-xs font-semibold rounded-md transition-all js-lb-filter active bg-white text-indigo-700 shadow-sm"
                                        data-tf="all">Toàn bộ</button>
                                    <button
                                        class="px-3 py-1 text-xs font-semibold rounded-md transition-all text-indigo-100 hover:bg-white/10 js-lb-filter"
                                        data-tf="month">Tháng</button>
                                    <button
                                        class="px-3 py-1 text-xs font-semibold rounded-md transition-all text-indigo-100 hover:bg-white/10 js-lb-filter"
                                        data-tf="week">Tuần</button>
                                    <button
                                        class="px-3 py-1 text-xs font-semibold rounded-md transition-all text-indigo-100 hover:bg-white/10 js-lb-filter"
                                        data-tf="day">Hôm nay</button>
                                </div>
                            </div>

                        </div>

                        <div id="set-leaderboard-container" class="space-y-3">
                            <!-- Leaderboard items rendered by JS -->
                            <div class="text-center py-8 text-slate-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Đang tải dữ liệu...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <div class="vocab-footer">
                <button class="vocab-start-btn js-start-learning">
                    <i class="fas fa-play-circle"></i> Bắt đầu học
                </button>
            </div>
        </div>
    </div>





    <!-- STEP 3: Mode Selector (Mobile only, Desktop redirects or uses index.html/modes) -->
    <!-- In this detail.html, we support the mobile wizard flow for consistency -->
    <div id="step-modes" class="vocab-step">
        {% include _v ~ '/modules/vocabulary/dashboard/components/steps/_modes.html' %}
        <div class="step-bottom-bar">
            <button type="button" class="step-continue-btn js-mode-continue" disabled>
                <span>Tiếp tục</span>
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- STEP 4: Flashcard Options -->
    <div id="step-flashcard-options" class="vocab-step">
        {% include _v ~ '/modules/vocabulary/dashboard/components/steps/_flashcard_options.html' %}
    </div>

    <!-- STEP 5: MCQ Options -->
    <div id="step-mcq-options" class="vocab-step">
        <div id="mcq-options-container" class="step-content-container">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

{# Shared Modals #}
{% include _v ~ '/modules/vocabulary/dashboard/_container_stats_modal.html' %}
{% include _v ~ '/modules/vocabulary/dashboard/_item_stats_charts.html' %}
{% include _v ~ '/modules/vocabulary/dashboard/_stats_enhancement.html' %}
{% include _v ~ '/modules/vocabulary/dashboard/_inject_stats_button.html' %}
{% include _v ~ '/modules/vocabulary/stats/_modal_stats.html' %}


<!-- Flashcard Settings Modal -->
<div id="flashcard-settings-modal" class="aura-modal-overlay">
    <div class="aura-modal-container" style="max-height: 85vh; height: auto;">
        <div class="aura-modal-header">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;">Cấu hình học tập</h3>
            <button class="aura-modal-close js-close-settings-modal"><i class="fas fa-times"></i></button>
        </div>
        <div class="aura-modal-body" style="padding: 1.5rem;">
            <div id="settings-dynamic-content-wrapper">
                <!-- Redesigned Settings Content from index.html -->
                {% include _v ~ '/modules/vocabulary/dashboard/components/_flashcard_settings.html'
                ignore
                missing %}
            </div>
        </div>
        <div class="p-6 border-t border-slate-100 bg-white flex gap-3">
            <button
                class="flex-1 py-3 px-4 rounded-xl text-slate-400 font-bold hover:bg-slate-50 transition-colors js-close-settings-modal">Hủy
                bỏ</button>
            <button
                class="flex-1 py-3 px-4 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-xl transition-all js-save-settings">Lưu
                cấu hình</button>
        </div>
    </div>
</div>


<!-- Item Stats Modal -->
{% include _v ~ '/modules/vocabulary/stats/_modal_stats.html' %}
{% endblock %}


{% block scripts %}
{{ super() }}
{# Stats components need their own scripts often or global helpers #}
<script src="{{ url_for('static', filename='aura_mobile/vocabulary/js/dashboard_detail.js') }}"></script>
{% endblock %}