{# Reusable Item Stats Modal #}
<div id="item-stats-modal" class="aura-modal-overlay">
    <div class="aura-modal-container" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">
        <div class="aura-modal-header" style="background: white; flex-shrink: 0;">
            <button class="aura-modal-close js-edit-item-stats" title="Chỉnh sửa thẻ"
                style="display: none; background: #eef2ff; color: #4f46e5;">
                <i class="fas fa-edit"></i>
            </button>
            <div style="flex: 1;"></div>
            <button class="aura-modal-close js-close-stats-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="item-stats-container" class="aura-modal-body" style="padding: 1rem; flex: 1; overflow-y: auto;">
            <!-- Content loaded here -->
        </div>
    </div>
</div>

<!-- Edit Overlay Modal (appears on top of stats modal) -->
<div id="vocab-edit-overlay-modal" class="aura-modal-overlay" style="z-index: 100001;">
    <div class="aura-modal-container" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">
        <div class="aura-modal-header" style="flex-shrink: 0;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;">Chỉnh sửa</h3>
            <button class="aura-modal-close" onclick="closeVocabEditOverlay()">&times;</button>
        </div>
        <div class="aura-modal-body" style="padding: 0; flex: 1; overflow: hidden; position: relative;">
            <iframe id="vocab-edit-iframe" src="" frameborder="0"
                style="width: 100%; height: 100%; border: none;"></iframe>
            <div id="vocab-edit-loading"
                style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; color: #6366f1; gap: 0.75rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <span>Đang tải...</span>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        // [EDIT OVERLAY FUNCTIONS]
        window.openVocabEditOverlay = function (editUrl) {
            const overlay = document.getElementById('vocab-edit-overlay-modal');
            const iframe = document.getElementById('vocab-edit-iframe');
            const loading = document.getElementById('vocab-edit-loading');
            if (!overlay || !iframe) return;

            overlay.classList.add('active');
            if (loading) loading.style.display = 'flex';
            iframe.style.visibility = 'hidden';

            // Append is_modal=true
            const separator = editUrl.includes('?') ? '&' : '?';
            iframe.src = editUrl + separator + 'is_modal=true';

            iframe.onload = function () {
                if (loading) loading.style.display = 'none';
                iframe.style.visibility = 'visible';
            };
        };

        window.closeVocabEditOverlay = function () {
            const overlay = document.getElementById('vocab-edit-overlay-modal');
            const iframe = document.getElementById('vocab-edit-iframe');
            if (overlay) overlay.classList.remove('active');
            if (iframe) iframe.src = '';
        };

        // [MARKER FUNCTION]
        window.toggleVocabMarker = function (itemId, markerType, btn) {
            if (!btn) return;
            const icon = btn.querySelector('i');
            btn.disabled = true;

            fetch('/api/v3/learning/markers/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({ item_id: itemId, marker_type: markerType })
            })
                .then(r => r.json())
                .then(data => {
                    btn.disabled = false;
                    if (data.success) {
                        const isMarked = data.is_marked;
                        if (isMarked) {
                            if (markerType !== 'difficult') {
                                icon.classList.remove('far');
                                icon.classList.add('fas');
                            }
                            btn.classList.add('active');
                            if (markerType === 'difficult') {
                                btn.style.background = '#ffedd5';
                                btn.style.color = '#ea580c';
                            } else if (markerType === 'ignored') {
                                btn.style.background = '#cbd5e1';
                                btn.style.color = '#475569';
                            } else if (markerType === 'favorite') {
                                btn.style.background = '#ffe4e6';
                                btn.style.color = '#e11d48';
                            }
                        } else {
                            if (markerType !== 'difficult') {
                                icon.classList.remove('fas');
                                icon.classList.add('far');
                            }
                            btn.classList.remove('active');
                            btn.style.background = 'white';
                            btn.style.color = '#94a3b8';
                        }
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    btn.disabled = false;
                });
        };

        window.toggleNoteEdit = function (showEdit) {
            const displayMode = document.getElementById('note-display-mode');
            const editMode = document.getElementById('note-edit-mode');
            if (displayMode && editMode) {
                displayMode.style.display = showEdit ? 'none' : 'block';
                editMode.style.display = showEdit ? 'block' : 'none';
                if (showEdit) {
                    const input = document.getElementById('item-note-input');
                    if (input) input.focus();
                }
            }
        };

        window.switchSubTab = function (targetId) {
            const container = document.querySelector('.stats-container') || document.body;
            container.querySelectorAll('.sub-tab-content').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            container.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const target = document.getElementById(targetId);
            if (target) {
                target.style.display = 'block';
                target.classList.add('active');
            }
            const btns = container.querySelectorAll('.sub-tab-btn');
            btns.forEach(btn => {
                const onclickVal = btn.getAttribute('onclick');
                if (onclickVal && onclickVal.includes("'" + targetId + "'")) {
                    btn.classList.add('active');
                }
            });
        };

        window.initStatsModalTabs = function () {
            const modalContainer = document.getElementById('item-stats-container');
            if (!modalContainer) return;

            const tabBtns = modalContainer.querySelectorAll('.tab-btn');
            const tabContents = modalContainer.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const targetTab = this.dataset.tab;
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    tabContents.forEach(content => {
                        if (content.id === 'tab-' + targetTab) {
                            content.style.display = 'block';
                            content.classList.add('active');
                        } else {
                            content.style.display = 'none';
                            content.classList.remove('active');
                        }
                    });
                });
            });
        };

        window.selectHistoryItem = function (el, idx) {
            const container = document.querySelector('.stats-container');
            if (!container) return;

            let historyData = [];
            try {
                historyData = JSON.parse(container.dataset.history || '[]');
            } catch (e) { console.error("History parse error", e); }

            document.querySelectorAll('.js-history-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');

            const log = historyData[idx];
            if (!log) return;

            const histBar = document.getElementById('history-detail-bar');
            const histTime = document.getElementById('hist-time');
            const histResult = document.getElementById('hist-result');

            if (histBar) histBar.style.display = 'flex';
            if (histTime) {
                const date = new Date(log.timestamp);
                histTime.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString();
            }

            const histModeBadge = document.getElementById('hist-mode-badge');
            if (histModeBadge) histModeBadge.textContent = log.mode || 'Flashcard';

            if (histResult) {
                histResult.textContent = log.result === 'Correct' ? 'ĐÚNG' : 'SAI';
                histResult.style.background = log.result === 'Correct' ? '#dcfce7' : '#fee2e2';
                histResult.style.color = log.result === 'Correct' ? '#16a34a' : '#dc2626';
            }

            const histDuration = document.getElementById('hist-duration');
            const histScore = document.getElementById('hist-score');
            const histMastery = document.getElementById('hist-mastery');

            if (histDuration) histDuration.textContent = log.duration_ms ? (log.duration_ms / 1000).toFixed(1) + 's' : '-';
            if (histScore) histScore.textContent = (log.score_change > 0 ? '+' : '') + (log.score_change || 0);
            if (histMastery) histMastery.textContent = (log.mastery_snapshot ? Math.round(log.mastery_snapshot * 100) : 0) + '%';
        };

        window.saveItemNote = function (itemId) {
            const btn = document.getElementById('save-note-btn');
            const input = document.getElementById('item-note-input');
            if (!btn || !input) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

            let csrfToken = '';
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) csrfToken = meta.getAttribute('content');

            fetch('/learn/vocabulary/api/progress/' + itemId + '/note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ note: input.value })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        btn.innerHTML = '<i class="fas fa-check"></i> Đã lưu';
                        btn.style.background = '#10b981';
                        const staticContent = document.getElementById('note-static-content');
                        if (staticContent) staticContent.textContent = input.value || "Chưa có ghi chú nào.";
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '#4f46e5';
                            btn.disabled = false;
                            toggleNoteEdit(false);
                        }, 1000);
                    } else {
                        alert('Lỗi: ' + data.message);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi kết nối');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        };

        window.generateAIExplanation = function (itemId) {
            const btn = document.getElementById('generate-ai-btn');
            const contentBox = document.getElementById('ai-content-box');
            const placeholder = document.getElementById('ai-placeholder');
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';

            let csrfToken = '';
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) csrfToken = meta.getAttribute('content');

            fetch('/learn/vocabulary/api/item/' + itemId + '/generate-ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (placeholder) placeholder.style.display = 'none';
                        const content = data.explanation;
                        if (contentBox) {
                            contentBox.style.display = 'block';
                            if (window.renderMarkdown) {
                                contentBox.innerHTML = window.renderMarkdown(content.trim());
                                contentBox.classList.add('markdown-body');
                                contentBox.style.whiteSpace = 'normal';
                            } else {
                                contentBox.innerHTML = '<div style="white-space: pre-wrap;">' + content + '</div>';
                            }
                        }
                    } else {
                        alert('Lỗi: ' + data.message);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi kết nối: ' + err);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        };

        const initModal = () => {
            const statsModal = document.getElementById('item-stats-modal');
            const statsContainer = document.getElementById('item-stats-container');
            const closeBtns = document.querySelectorAll('.js-close-stats-modal');

            if (closeBtns) {
                closeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        if (statsModal) statsModal.classList.remove('active');
                    });
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && statsModal && statsModal.classList.contains('active')) {
                    statsModal.classList.remove('active');
                }
            });


            window.openVocabularyItemStats = function (itemId) {
                if (!statsModal || !statsContainer) return;

                statsModal.classList.add('active');
                statsContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 16rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6366f1;"></i></div>';

                const editBtn = statsModal.querySelector('.js-edit-item-stats');
                if (editBtn) editBtn.style.display = 'none';

                fetch('/learn/vocabulary/item/' + itemId + '/stats?modal=true&_cb=' + new Date().getTime())
                    .then(r => r.text())
                    .then(html => {
                        statsContainer.innerHTML = html;
                        const contentEl = statsContainer.querySelector('.stats-container');
                        if (contentEl && editBtn) {
                            const canEdit = contentEl.dataset.canEdit === 'true';
                            const editUrl = contentEl.dataset.editUrl;
                            if (canEdit && editUrl) {
                                editBtn.style.display = 'flex';
                                editBtn.onclick = function (e) {
                                    if (e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                    }
                                    openVocabEditOverlay(editUrl);
                                    return false;
                                };
                            }
                        }

                        const mdContainers = statsContainer.querySelectorAll('.js-markdown-content');
                        mdContainers.forEach(container => {
                            if (window.renderMarkdown) {
                                const rawText = container.textContent.trim();
                                container.innerHTML = window.renderMarkdown(rawText);
                                container.style.whiteSpace = 'normal';
                            }
                        });

                        if (window.initStatsModalTabs) window.initStatsModalTabs();
                    })
                    .catch(err => {
                        console.error("Stats load error:", err);
                        statsContainer.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 16rem; color: #94a3b8;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><span>Không thể tải thống kê</span></div>';
                    });
            };
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initModal);
        } else {
            initModal();
        }
    })();
</script>