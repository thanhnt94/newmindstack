{% set _v = template_version or 'aura_mobile' %}
{% extends _v ~ '/layouts/base.html' %}

{% block title %}Chi tiết lần học{% endblock %}

{% block head %}
{{ super() }}
<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(241, 245, 249, 1);
    }

    .stat-label-xs {
        font-size: 0.65rem;
        font-weight: 800;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .font-mono-bold {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<div class="h-screen w-full bg-[#f8fafc] flex flex-col overflow-hidden">
    <!-- 1. HEADER: Result & Action (Static) -->
    <div class="p-4 md:p-6 pb-2 space-y-4 flex-shrink-0">
        <div class="glass-card rounded-2xl p-5 relative overflow-hidden shadow-sm">
            <div
                class="absolute top-0 right-0 w-32 h-32 bg-indigo-50 rounded-full translate-x-1/3 -translate-y-1/3 opacity-40">
            </div>
            <div class="relative z-10 flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-2 text-slate-400 mb-2">
                        <i class="far fa-clock text-xs"></i>
                        <span class="text-[11px] font-bold uppercase tracking-wider">{{ log.timestamp.strftime('%H:%M •
                            %d/%m/%y') }}</span>
                    </div>
                    <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl font-black text-xs shadow-sm shadow-indigo-100/50
                        {% if log.learning_mode == 'flashcard' %}
                            {% if log.rating >= 4 %} bg-emerald-50 text-emerald-600 border border-emerald-100
                            {% elif log.rating >= 3 %} bg-indigo-50 text-indigo-600 border border-indigo-100
                            {% elif log.rating >= 2 %} bg-amber-50 text-amber-600 border border-amber-100
                            {% else %} bg-rose-50 text-rose-600 border border-rose-100 {% endif %}
                        {% else %}
                            {% if log.is_correct %} bg-emerald-50 text-emerald-600 border border-emerald-100
                            {% else %} bg-rose-50 text-rose-600 border border-rose-100 {% endif %}
                        {% endif %}">
                        {% if log.learning_mode == 'flashcard' %}
                        {% if log.rating >= 4 %} <i class="fas fa-laugh-beam"></i> DỄ
                        {% elif log.rating >= 3 %} <i class="fas fa-smile"></i> TỐT
                        {% elif log.rating >= 2 %} <i class="fas fa-meh"></i> KHÓ
                        {% else %} <i class="fas fa-sync-alt"></i> HỌC LẠI {% endif %}
                        {% else %}
                        {% if log.is_correct %} <i class="fas fa-check-circle"></i> ĐÚNG
                        {% else %} <i class="fas fa-times-circle"></i> SAI {% endif %}
                        {% endif %}
                        {% if log.learning_mode == 'flashcard' %}
                        <span class="opacity-50 font-bold">({{ log.rating }})</span>
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <button
                        onclick="window.parent.openModal('{{ url_for('vocabulary.item_stats_page', item_id=log.item_id) }}', 'Xem thẻ')"
                        class="px-4 py-2 bg-white hover:bg-slate-50 text-slate-600 rounded-xl border border-slate-200 flex items-center gap-2 transition-all font-bold text-[11px] shadow-sm active:scale-95">
                        <i class="fas fa-external-link-alt text-[10px]"></i> CHI TIẾT THẺ
                    </button>
                    <div class="text-[10px] font-bold text-slate-300 tracking-tighter uppercase">ID: {{ log.log_id }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex p-1 bg-slate-200/50 rounded-2xl gap-1">
            <button onclick="switchTab('overview')" id="tab-overview"
                class="tab-btn flex-1 py-2.5 rounded-xl text-[11px] font-black uppercase tracking-wider transition-all bg-white text-indigo-600 shadow-sm border border-white">
                Tổng quan
            </button>
            <button onclick="switchTab('content')" id="tab-content"
                class="tab-btn flex-1 py-2.5 rounded-xl text-[11px] font-black uppercase tracking-wider transition-all text-slate-500 hover:text-slate-700">
                Nội dung
            </button>
            <button onclick="switchTab('fsrs')" id="tab-fsrs"
                class="tab-btn flex-1 py-2.5 rounded-xl text-[11px] font-black uppercase tracking-wider transition-all text-slate-500 hover:text-slate-700">
                FSRS Audit
            </button>
        </div>
    </div>

    <!-- 2. SCROLLABLE CONTENT -->
    <div class="flex-1 overflow-y-auto px-4 md:px-6 pb-24">
        <div class="max-w-2xl mx-auto">

            <!-- TAB 1: OVERVIEW -->
            <div id="section-overview" class="tab-section space-y-4">
                <!-- Performance Pills -->
                <div class="flex gap-3">
                    <div class="flex-1 glass-card rounded-2xl p-4 shadow-sm">
                        <div class="stat-label-xs mb-1">Thời gian</div>
                        <div class="flex items-baseline gap-1">
                            <span class="text-xl font-black text-slate-700">{{ (log.review_duration / 1000) | round(1)
                                }}</span>
                            <span class="text-[10px] font-bold text-slate-400">GIÂY</span>
                        </div>
                    </div>
                    {% if score_change %}
                    <div class="flex-1 glass-card bg-amber-50/20 border-amber-100/50 rounded-2xl p-4 shadow-sm">
                        <div class="stat-label-xs text-amber-600/70 mb-1">Điểm nhận</div>
                        <div class="flex items-baseline gap-1">
                            <span class="text-xl font-black text-amber-600">+{{ score_change }}</span>
                            <span class="text-[10px] font-bold text-amber-400">PTS</span>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Context Card -->
                <div class="glass-card rounded-2xl p-5 shadow-sm">
                    <h3 class="stat-label-xs mb-4 flex items-center gap-2">
                        <i class="fas fa-fingerprint text-indigo-400"></i> Ngữ cảnh
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-3 rounded-xl">
                            <div class="stat-label-xs opacity-60 scale-90 origin-left mb-1">Thiết bị</div>
                            <div class="font-bold text-slate-700 text-sm capitalize">{{ (log.context_snapshot or
                                {}).get('input_device', 'N/A') }}</div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl">
                            <div class="stat-label-xs opacity-60 scale-90 origin-left mb-1">Lần học</div>
                            <div class="font-bold text-slate-700 text-sm">#{{ (log.context_snapshot or
                                {}).get('reps_global', 1) }}</div>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between items-center bg-slate-50 p-3 rounded-xl">
                        <span class="stat-label-xs opacity-60">Trạng thái FSRS</span>
                        <span
                            class="px-2 py-0.5 bg-indigo-100 text-indigo-600 rounded text-[9px] font-black uppercase tracking-wider">
                            {{ (log.fsrs_snapshot or {}).get('card_state', 'NEW') | upper }}
                        </span>
                    </div>
                </div>

                <!-- Scoring Receipt -->
                {% if log.gamification_snapshot and log.gamification_snapshot.breakdown %}
                <div class="glass-card rounded-2xl p-6 shadow-sm bg-amber-50/10 border-t-4 border-t-amber-400">
                    <h3 class="stat-label-xs mb-6 flex items-center justify-between">
                        <span><i class="fas fa-receipt text-amber-400 mr-2"></i> BIÊN LAI ĐIỂM</span>
                        <span class="text-[8px] opacity-40">MINDSTACK-GAMIFY-v2</span>
                    </h3>
                    <div class="space-y-4">
                        {% for key, val in log.gamification_snapshot.breakdown.items() %}
                        {% if key != 'total' and val != 0 %}
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-500 font-bold uppercase tracking-tight">
                                {% if key == 'base' %}Điểm cơ bản
                                {% elif key == 'difficulty' %}Thưởng độ khó
                                {% elif key == 'streak' or key == 'streak_bonus' %}Chuỗi học tập
                                {% elif key == 'time' or key == 'time_bonus' %}Thưởng tốc độ
                                {% else %}{{ key | capitalize }}{% endif %}
                            </span>
                            <div class="h-px flex-1 mx-4 border-b border-dashed border-slate-200"></div>
                            <span class="font-mono-bold text-amber-600 text-sm">
                                {% if val is number %}
                                {% if val < 1 and val> 0 %}x{{ val }}{% else %}+{{ val | int }}{% endif %}
                                    {% else %}
                                    {{ val }}
                                    {% endif %}
                            </span>
                        </div>
                        {% endif %}
                        {% endfor %}
                        <div class="pt-4 mt-2 border-t-2 border-slate-100 flex justify-between items-center">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Tổng điểm
                                nhận</span>
                            <span class="text-3xl font-black text-slate-800 tracking-tighter">{{
                                log.gamification_snapshot.total_score or score_change }} <span
                                    class="text-xs text-amber-500 ml-1">PTS</span></span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- TAB 2: CONTENT -->
            <div id="section-content" class="tab-section hidden space-y-4">
                <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                    <div class="bg-slate-50 px-5 py-4 flex justify-between items-center border-b border-slate-100">
                        <span class="stat-label-xs">Nội dung thẻ</span>
                        <span
                            class="px-2 py-0.5 bg-white border border-slate-200 rounded-lg text-[9px] font-black text-slate-400 uppercase">
                            {{ log.learning_mode }}
                        </span>
                    </div>
                    <div class="p-6 space-y-6">
                        <!-- Question/Front -->
                        <div>
                            <div class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-2">MẶT
                                TRƯỚC</div>
                            <div
                                class="text-xl font-bold text-slate-800 leading-relaxed bg-white rounded-2xl p-4 border border-slate-100 shadow-sm">
                                {{ item_content | safe }}
                            </div>
                        </div>

                        <!-- Answer/Back -->
                        <div>
                            <div class="text-[10px] font-black text-emerald-400 uppercase tracking-[0.2em] mb-2">ĐÁP ÁN
                                ĐÚNG</div>
                            <div
                                class="text-lg font-semibold text-slate-600 leading-relaxed bg-emerald-50/50 rounded-2xl p-4 border border-emerald-100 shadow-sm prose prose-sm max-w-none">
                                {{ correct_answer | safe }}
                            </div>
                        </div>

                        <!-- User Answer (If available) -->
                        {% if log.user_answer and log.user_answer != item_content %}
                        <div class="pt-4 border-t border-slate-100">
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">BẠN TRẢ
                                LỜI</div>
                            <div
                                class="flex items-center gap-3 p-3 rounded-xl {% if log.is_correct %}bg-emerald-50 text-emerald-700{% else %}bg-rose-50 text-rose-700{% endif %} font-bold text-md">
                                <i
                                    class="fas {% if log.is_correct %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
                                <span>{{ user_answer_rendered | safe }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- TAB 3: FSRS -->
            <div id="section-fsrs" class="tab-section hidden space-y-4">
                <div class="glass-card rounded-2xl p-6 shadow-sm">
                    <h3 class="stat-label-xs mb-8 flex items-center justify-between">
                        <span><i class="fas fa-microchip text-indigo-400 mr-2"></i> TRẠNG THÁI THUẬT TOÁN</span>
                        <span class="text-[8px] opacity-40 tracking-widest uppercase">DeepFSRS v1.0.4</span>
                    </h3>

                    {% if log.fsrs_snapshot %}
                    <div class="space-y-10">
                        <!-- Stability (S) -->
                        <div class="relative">
                            <div class="flex justify-between items-end mb-4">
                                <div>
                                    <span
                                        class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Stability
                                        (S)</span>
                                    <p class="text-[9px] font-bold text-slate-300 uppercase">Khả năng ghi nhớ (ngày)</p>
                                </div>
                                {% set s_diff = (log.fsrs_snapshot.get('post_stability', 0) -
                                log.fsrs_snapshot.get('pre_stability', 0)) %}
                                <div
                                    class="px-2 py-1 rounded-lg text-[10px] font-black {% if s_diff >= 0 %}bg-emerald-100 text-emerald-600{% else %}bg-rose-100 text-rose-600{% endif %}">
                                    {% if s_diff >= 0 %}+{% endif %}{{ s_diff | round(2) }}
                                </div>
                            </div>
                            <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl">
                                <div class="flex-1 text-center">
                                    <div class="text-[9px] font-black text-slate-300 mb-1 uppercase tracking-tighter">
                                        Trước</div>
                                    <div class="font-mono-bold text-slate-400 text-lg">{{
                                        log.fsrs_snapshot.get('pre_stability', 0) | round(1) }}</div>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm border border-slate-100">
                                    <i class="fas fa-long-arrow-alt-right text-indigo-300"></i>
                                </div>
                                <div class="flex-1 text-center">
                                    <div class="text-[9px] font-black text-indigo-400 mb-1 uppercase tracking-tighter">
                                        Sau</div>
                                    <div class="font-mono-bold text-indigo-600 text-2xl">{{
                                        log.fsrs_snapshot.get('post_stability', 0) | round(1) }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Difficulty (D) -->
                        <div>
                            <div class="flex justify-between items-end mb-4">
                                <div>
                                    <span
                                        class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Difficulty
                                        (D)</span>
                                    <p class="text-[9px] font-bold text-slate-300 uppercase">Độ khó của thẻ</p>
                                </div>
                                {% set d_diff = (log.fsrs_snapshot.get('post_difficulty', 0) -
                                log.fsrs_snapshot.get('pre_difficulty', 0)) %}
                                <div
                                    class="px-2 py-1 rounded-lg text-[10px] font-black {% if d_diff <= 0 %}bg-emerald-100 text-emerald-600{% else %}bg-rose-100 text-rose-600{% endif %}">
                                    {% if d_diff > 0 %}+{% endif %}{{ d_diff | round(2) }}
                                </div>
                            </div>
                            <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl">
                                <div class="flex-1 text-center">
                                    <div class="text-[9px] font-black text-slate-300 mb-1 uppercase tracking-tighter">
                                        Trước</div>
                                    <div class="font-mono-bold text-slate-400 text-lg">{{
                                        log.fsrs_snapshot.get('pre_difficulty', 0) | round(1) }}</div>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm border border-slate-100">
                                    <i class="fas fa-long-arrow-alt-right text-rose-300"></i>
                                </div>
                                <div class="flex-1 text-center">
                                    <div class="text-[9px] font-black text-rose-400 mb-1 uppercase tracking-tighter">Sau
                                    </div>
                                    <div class="font-mono-bold text-rose-500 text-2xl">{{
                                        log.fsrs_snapshot.get('post_difficulty', 0) | round(1) }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Retrievability (R) -->
                        <div
                            class="flex justify-between items-center bg-indigo-600 rounded-2xl p-4 shadow-lg shadow-indigo-100">
                            <div class="flex flex-col text-white">
                                <span class="text-[10px] font-black opacity-60 uppercase tracking-widest">Retrievability
                                    (R)</span>
                                <span class="text-[9px] font-bold opacity-80 uppercase">Độ quên lúc học tập</span>
                            </div>
                            <div class="text-3xl font-black text-white tracking-tighter">
                                {{ (log.fsrs_snapshot.get('retrievability', 0) * 100) | round(1) }}%
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="flex flex-col items-center justify-center py-10 text-slate-300 opacity-50">
                        <i class="fas fa-database text-3xl mb-2"></i>
                        <p class="text-[10px] font-bold uppercase tracking-widest">Không có dữ liệu FSRS</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Footer Section (Static in FSRS tab) -->
            <div id="footer-branding" class="text-center py-12 opacity-30 pointer-events-none hidden">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <div class="h-px w-8 bg-slate-300"></div>
                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em]">MINDSTACK AUDIT</div>
                    <div class="h-px w-8 bg-slate-300"></div>
                </div>
                <div class="text-[8px] font-bold text-slate-300 uppercase tracking-[0.1em]">
                    FSRS-ENGINE v{{ (log.fsrs_snapshot or {}).get('scheduler_ver', '4.5') }} • HASH: {{ log.log_id |
                    string | reverse | truncate(8, True, '') }}
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    function switchTab(tabId) {
        // Toggle Buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-white');
            btn.classList.add('text-slate-500');
        });
        const activeBtn = document.getElementById('tab-' + tabId);
        activeBtn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-white');
        activeBtn.classList.remove('text-slate-500');

        // Toggle Sections
        document.querySelectorAll('.tab-section').forEach(sec => sec.classList.add('hidden'));
        document.getElementById('section-' + tabId).classList.remove('hidden');

        // Contextual branding display
        const branding = document.getElementById('footer-branding');
        if (tabId === 'fsrs') {
            branding.classList.remove('hidden');
        } else {
            branding.classList.add('hidden');
        }

        // Haptic feel (optional)
        if (window.navigator.vibrate) window.navigator.vibrate(5);
    }
</script>
{% endblock %}