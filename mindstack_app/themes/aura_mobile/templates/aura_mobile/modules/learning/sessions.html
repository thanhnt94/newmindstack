{% set _v = template_version or 'aura_mobile' %}
{% extends _v ~ '/layouts/base.html' %}

{% block title %}Quản lý phiên học - MindStack{% endblock %}

{% block head %}
{{ super() }}
<style>
    .sessions-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .session-card {
        background: white;
        border-radius: 1.25rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .session-header {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .session-icon {
        width: 48px;
        height: 48px;
        border-radius: 1rem;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .session-info {
        flex: 1;
    }

    .session-title {
        font-weight: 800;
        color: #1e293b;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }

    .session-meta {
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 500;
    }

    .progress-bar-wrap {
        height: 8px;
        background: #f1f5f9;
        border-radius: 999px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: #6366f1;
        border-radius: 999px;
        transition: width 0.5s ease;
    }

    .session-actions {
        display: flex;
        gap: 0.75rem;
    }

    .btn-resume {
        flex: 1;
        background: #6366f1;
        color: white;
        text-align: center;
        padding: 0.75rem;
        border-radius: 0.75rem;
        font-weight: 700;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-resume:hover {
        background: #4f46e5;
        transform: translateY(-2px);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #94a3b8;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<div class="sessions-container">
    <div class="flex items-center gap-4 mb-6">
        <a href="/" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <h1 class="text-2xl font-black text-slate-800">Quản lý phiên học</h1>
    </div>

    <!-- Tab Nav -->
    <div class="flex p-1 bg-slate-100 rounded-xl mb-6">
        <button onclick="switchTab('active')" id="btn-tab-active"
            class="flex-1 py-2 px-4 rounded-lg text-sm font-bold text-slate-700 bg-white shadow-sm transition-all">
            Đang học
        </button>
        <button onclick="switchTab('history')" id="btn-tab-history"
            class="flex-1 py-2 px-4 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 transition-all">
            Lịch sử
        </button>
    </div>

    <!-- Active Sessions Tab -->
    <div id="tab-active">
        {% if sessions %}
        {% for s in sessions %}
        <div class="session-card">
            <div class="session-header">
                <div class="session-icon"
                    style="background: {% if s.learning_mode == 'quiz' %}linear-gradient(135deg, #f59e0b, #ef4444){% else %}linear-gradient(135deg, #6366f1, #8b5cf6){% endif %}">
                    <i
                        class="fa-solid {% if s.learning_mode == 'quiz' %}fa-bolt{% else %}fa-layer-group{% endif %}"></i>
                </div>
                <div class="session-info">
                    <h3 class="session-title">{{ s.container_name }}</h3>
                    <p class="session-meta">
                        <span
                            class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-slate-100 text-slate-600 mr-2">
                            {{ 'QUIZ' if s.learning_mode == 'quiz' else 'FLASHCARD' }}
                        </span>
                        {{ s.mode_name }} • {{ s.start_time.strftime('%H:%M %d/%m') }}
                    </p>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between text-xs font-bold text-slate-500 uppercase tracking-wider">
                    <span>Tiến độ</span>
                    <span>{{ s.done }}/{{ s.total }} câu</span>
                </div>
                <div class="progress-bar-wrap">
                    <div class="progress-bar-fill"
                        style="width: {{ (s.done / s.total * 100) if s.total > 0 else 0 }}%; background: {% if s.learning_mode == 'quiz' %}#f59e0b{% else %}#6366f1{% endif %};">
                    </div>
                </div>
            </div>

            <div class="session-actions">
                <a href="{{ s.resume_url }}" class="btn-resume"
                    style="background: {% if s.learning_mode == 'quiz' %}#f59e0b{% else %}#6366f1{% endif %};">
                    Tiếp tục học
                </a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon"><i class="fa-solid fa-ghost"></i></div>
            <h2 class="text-xl font-bold text-slate-700 mb-2">Không có phiên học đang mở</h2>
            <p class="text-sm">Hãy bắt đầu học ngay thôi!</p>
            <a href="/" class="mt-6 inline-block bg-slate-800 text-white px-6 py-3 rounded-xl font-bold">Về trang
                chủ</a>
        </div>
        {% endif %}
    </div>

    <!-- History Tab -->
    <div id="tab-history" class="hidden">
        {% if history %}
        {% for h in history %}
        <a href="{{ url_for('session.session_summary', session_id=h.session_id) }}"
            class="session-card opacity-90 hover:opacity-100 transition cursor-pointer hover:shadow-md block no-underline">
            <div class="session-header">
                <div class="session-icon"
                    style="background: {% if h.learning_mode == 'quiz' %}#f59e0b{% else %}#6366f1{% endif %}; opacity: 0.8;">
                    <i
                        class="fa-solid {% if h.learning_mode == 'quiz' %}fa-bolt{% else %}fa-layer-group{% endif %}"></i>
                </div>
                <div class="session-info">
                    <h3 class="session-title text-slate-600">{{ h.container_name }}</h3>
                    <p class="session-meta">
                        <span
                            class="{% if h.status == 'completed' %}text-emerald-600{% else %}text-slate-400{% endif %} font-bold uppercase text-[10px] mr-2">
                            {{ 'HOÀN THÀNH' if h.status == 'completed' else 'ĐÃ HỦY' }}
                        </span>
                        {{ h.end_time.strftime('%H:%M %d/%m') if h.end_time else '---' }}
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2 mt-2">
                <div class="bg-slate-50 p-2 rounded text-center">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Đúng</div>
                    <div class="font-bold text-emerald-600">{{ h.correct }}</div>
                </div>
                <div class="bg-slate-50 p-2 rounded text-center">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Sai</div>
                    <div class="font-bold text-red-500">{{ h.incorrect }}</div>
                </div>
                <div class="bg-slate-50 p-2 rounded text-center">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Điểm</div>
                    <div class="font-bold text-amber-500">+{{ h.points }}</div>
                </div>
            </div>
        </a>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon"><i class="fa-solid fa-clock-rotate-left"></i></div>
            <h2 class="text-xl font-bold text-slate-700 mb-2">Chưa có lịch sử</h2>
            <p class="text-sm">Các phiên học đã hoàn thành sẽ xuất hiện ở đây.</p>
        </div>
        {% endif %}
    </div>

</div>

<script>
    function switchTab(tabName) {
        const btnActive = document.getElementById('btn-tab-active');
        const btnHistory = document.getElementById('btn-tab-history');
        const tabActive = document.getElementById('tab-active');
        const tabHistory = document.getElementById('tab-history');

        if (tabName === 'active') {
            tabActive.classList.remove('hidden');
            tabHistory.classList.add('hidden');

            btnActive.classList.add('bg-white', 'shadow-sm', 'text-slate-700');
            btnActive.classList.remove('text-slate-500');

            btnHistory.classList.remove('bg-white', 'shadow-sm', 'text-slate-700');
            btnHistory.classList.add('text-slate-500');
        } else {
            tabActive.classList.add('hidden');
            tabHistory.classList.remove('hidden');

            btnHistory.classList.add('bg-white', 'shadow-sm', 'text-slate-700');
            btnHistory.classList.remove('text-slate-500');

            btnActive.classList.remove('bg-white', 'shadow-sm', 'text-slate-700');
            btnActive.classList.add('text-slate-500');
        }
    }
</script>
{% endblock %}