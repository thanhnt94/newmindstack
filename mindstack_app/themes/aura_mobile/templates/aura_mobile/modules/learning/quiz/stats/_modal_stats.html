{# Reusable Quiz Item Stats Modal #}
<div id="quiz-item-stats-modal" class="quiz-stats-modal" style="display: none;">
    <div class="quiz-stats-modal-overlay js-close-quiz-stats-modal"></div>
    <div class="quiz-stats-modal-content">
        <!-- Header with edit and close buttons - positioned at corners -->
        <button id="quiz-stats-edit-btn"
            style="display: none; position: absolute; top: 1rem; left: 1rem; width: 36px; height: 36px; border-radius: 50%; background: #f1f5f9; border: none; color: #64748b; font-size: 1rem; cursor: pointer; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s;">
            <i class="fas fa-edit"></i>
        </button>
        <button class="quiz-stats-modal-close js-close-quiz-stats-modal"
            style="position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; background: #f1f5f9; border: none; display: flex; align-items: center; justify-content: center; color: #64748b; cursor: pointer; transition: all 0.2s; z-index: 10;">
            <i class="fas fa-times"></i>
        </button>
        <div id="quiz-item-stats-container" class="quiz-stats-modal-body">
            <!-- Content loaded here -->
        </div>
    </div>
</div>

<!-- Edit Overlay Modal (appears on top of quiz stats modal) -->
<div id="quiz-edit-overlay-modal" class="quiz-edit-overlay" style="display: none;">
    <div class="quiz-edit-overlay-bg" onclick="closeQuizEditOverlay()"></div>
    <div class="quiz-edit-overlay-content">
        <div class="quiz-edit-overlay-header">
            <span class="quiz-edit-overlay-title">Chỉnh sửa câu hỏi</span>
            <button class="quiz-edit-overlay-close" onclick="closeQuizEditOverlay()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="quiz-edit-overlay-body">
            <iframe id="quiz-edit-iframe" src="" frameborder="0"></iframe>
            <div id="quiz-edit-loading" class="quiz-edit-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Đang tải...</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Quiz Stats Modal Styles */
    .quiz-stats-modal {
        position: fixed;
        inset: 0;
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        box-sizing: border-box;
    }

    .quiz-stats-modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
    }

    .quiz-stats-modal-content {
        position: relative;
        width: 100%;
        max-width: 480px;
        max-height: 88vh;
        max-height: 88dvh;
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: quizStatsScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        margin: auto;
    }

    .quiz-stats-modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10;
    }

    .quiz-stats-modal-close:hover {
        background: #e2e8f0;
        color: #ef4444;
    }

    .quiz-stats-modal-body {
        padding: 0;
        flex: 1;
        background: #f8fafc;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @keyframes quizStatsScaleIn {
        from {
            transform: scale(0.95);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Quiz Edit Overlay Modal Styles */
    .quiz-edit-overlay {
        position: fixed;
        inset: 0;
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .quiz-edit-overlay-bg {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
    }

    .quiz-edit-overlay-content {
        position: relative;
        width: 95%;
        max-width: 900px;
        height: 90vh;
        max-height: 90dvh;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: quizStatsScaleIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 1;
    }

    .quiz-edit-overlay-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        flex-shrink: 0;
    }

    .quiz-edit-overlay-title {
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
    }

    .quiz-edit-overlay-close {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quiz-edit-overlay-close:hover {
        background: #fee2e2;
        color: #ef4444;
    }

    .quiz-edit-overlay-body {
        flex: 1;
        position: relative;
        overflow: hidden;
    }

    .quiz-edit-overlay-body iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .quiz-edit-loading {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: white;
        color: #6366f1;
        font-size: 1rem;
        gap: 0.75rem;
    }

    .quiz-edit-loading i {
        font-size: 2rem;
    }
</style>

<script>
    (function () {
        // [EDIT OVERLAY FUNCTIONS]
        window.openQuizEditOverlay = function (editUrl) {
            const overlay = document.getElementById('quiz-edit-overlay-modal');
            const iframe = document.getElementById('quiz-edit-iframe');
            const loading = document.getElementById('quiz-edit-loading');
            if (!overlay || !iframe) return;

            overlay.style.display = 'flex';
            if (loading) loading.style.display = 'flex';
            iframe.style.visibility = 'hidden';
            iframe.src = editUrl;

            iframe.onload = function () {
                if (loading) loading.style.display = 'none';
                iframe.style.visibility = 'visible';
            };
        };

        window.closeQuizEditOverlay = function () {
            const overlay = document.getElementById('quiz-edit-overlay-modal');
            const iframe = document.getElementById('quiz-edit-iframe');
            if (overlay) overlay.style.display = 'none';
            if (iframe) iframe.src = '';
        };

        // [MARKER FUNCTION]
        window.toggleQuizMarker = function (itemId, markerType, btnElement) {
            // Optimistic update
            const isActive = btnElement.classList.contains('active');
            const originalColor = btnElement.style.color;
            const originalBg = btnElement.style.background;

            // Toggle Visuals temporarily
            /* Logic: 
               Difficult: Orange #f97316 / #fff7ed
               Ignored: Slate #64748b / #f1f5f9
               Favorite: Rose #f43f5e / #fff1f2
               Inactive: #cbd5e1 / white
            */
            const styles = {
                'difficult': { color: '#f97316', bg: '#fff7ed' },
                'ignored': { color: '#64748b', bg: '#f1f5f9' },
                'favorite': { color: '#f43f5e', bg: '#fff1f2' }
            };
            const style = styles[markerType];

            if (!isActive) {
                // Activate
                btnElement.classList.add('active');
                btnElement.style.color = style.color;
                btnElement.style.background = style.bg;
            } else {
                // Deactivate
                btnElement.classList.remove('active');
                btnElement.style.color = '#cbd5e1';
                btnElement.style.background = 'white';
            }

            let csrfToken = '';
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) csrfToken = meta.getAttribute('content');

            fetch('/api/v3/learning/markers/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    item_id: itemId,
                    marker_type: markerType
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(`Marker ${markerType} toggled: ${data.is_marked}`);
                        // Ensure final state matches backend
                        if (data.is_marked) {
                            btnElement.classList.add('active');
                            btnElement.style.color = style.color;
                            btnElement.style.background = style.bg;
                        } else {
                            btnElement.classList.remove('active');
                            btnElement.style.color = '#cbd5e1';
                            btnElement.style.background = 'white';
                        }
                        if (window.showToast) window.showToast('success', data.message);
                    } else {
                        console.error('Marker toggle failed:', data.message);
                        // Revert
                        if (isActive) {
                            btnElement.classList.add('active');
                            btnElement.style.color = originalColor;
                            btnElement.style.background = originalBg;
                        } else {
                            btnElement.classList.remove('active');
                            btnElement.style.color = '#cbd5e1';
                            btnElement.style.background = 'white';
                        }
                        alert("Lỗi: " + data.message);
                    }
                })
                .catch(err => {
                    console.error('Error toggling marker:', err);
                    // Revert
                    if (isActive) {
                        btnElement.classList.add('active');
                        btnElement.style.color = originalColor;
                        btnElement.style.background = originalBg;
                    } else {
                        btnElement.classList.remove('active');
                        btnElement.style.color = '#cbd5e1';
                        btnElement.style.background = 'white';
                    }
                });
        };

        // [GLOBAL FUNCTIONS] Defined early for inline onclicks
        window.toggleQuizNoteEdit = function (showEdit) {
            const displayMode = document.getElementById('quiz-note-display-mode');
            const editMode = document.getElementById('quiz-note-edit-mode');
            if (displayMode && editMode) {
                displayMode.style.display = showEdit ? 'none' : 'block';
                editMode.style.display = showEdit ? 'block' : 'none';
                if (showEdit) {
                    const input = document.getElementById('quiz-item-note-input');
                    if (input) input.focus();
                }
            }
        };

        window.toggleQuizSubTabs = function (show) {
            const el = document.getElementById('quiz-header-sub-tabs');
            if (el) el.style.display = show ? 'flex' : 'none';
            const histBar = document.getElementById('quiz-history-detail-bar');
            if (histBar) histBar.style.display = 'none';
        };

        window.switchQuizSubTab = function (targetId) {
            const container = document.querySelector('.stats-container') || document.body;
            container.querySelectorAll('.sub-tab-content').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            container.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const target = document.getElementById(targetId);
            if (target) {
                target.style.display = 'block';
                target.classList.add('active');
            }
            const btns = container.querySelectorAll('.sub-tab-btn');
            btns.forEach(btn => {
                const onclickVal = btn.getAttribute('onclick');
                if (onclickVal && onclickVal.includes("'" + targetId + "'")) {
                    btn.classList.add('active');
                }
            });
        };

        window.initQuizStatsModalTabs = function () {
            const modalContainer = document.getElementById('quiz-item-stats-container');
            if (!modalContainer) return;

            const tabBtns = modalContainer.querySelectorAll('.tab-btn');
            const tabContents = modalContainer.querySelectorAll('.tab-content');
            const histBar = document.getElementById('quiz-history-detail-bar');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const targetTab = this.dataset.tab;
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    tabContents.forEach(content => {
                        if (content.id === 'quiz-tab-' + targetTab) {
                            content.style.display = 'block';
                            content.classList.add('active');
                        } else {
                            content.style.display = 'none';
                            content.classList.remove('active');
                        }
                    });

                    const isNộiDung = targetTab === 'content';
                    const subTabs = document.getElementById('quiz-header-sub-tabs');
                    if (subTabs) subTabs.style.display = isNộiDung ? 'flex' : 'none';

                    const isDetails = targetTab === 'details';
                    if (histBar) histBar.style.display = isDetails ? 'flex' : 'none';

                    if (isDetails) {
                        const items = document.querySelectorAll('.js-history-item');
                        if (items.length > 0 && !document.querySelector('.js-history-item.active')) {
                            selectQuizHistoryItem(items[0], 0);
                        }
                    }
                });
            });
        };

        window.selectQuizHistoryItem = function (el, idx) {
            const container = document.querySelector('.stats-container');
            if (!container) return;

            let historyData = [];
            try {
                historyData = JSON.parse(container.dataset.history || '[]');
            } catch (e) { console.error("History parse error", e); }

            document.querySelectorAll('.js-history-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');

            const log = historyData[idx];
            if (!log) return;

            const histBar = document.getElementById('quiz-history-detail-bar');
            const histTime = document.getElementById('quiz-hist-time');
            const histResult = document.getElementById('quiz-hist-result');

            if (histBar) histBar.style.display = 'flex';
            if (histTime) {
                const date = new Date(log.timestamp);
                histTime.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString();
            }

            const histModeBadge = document.getElementById('quiz-hist-mode-badge');
            if (histModeBadge) histModeBadge.textContent = log.review_type || log.mode || 'Quiz';

            if (histResult) {
                histResult.textContent = log.is_correct ? 'ĐÚNG' : 'SAI';
                histResult.style.background = log.is_correct ? '#dcfce7' : '#fee2e2';
                histResult.style.color = log.is_correct ? '#16a34a' : '#dc2626';
            }

            const histAnswer = document.getElementById('quiz-hist-answer');
            const histScore = document.getElementById('quiz-hist-score');
            const histMastery = document.getElementById('quiz-hist-mastery');
            const histDuration = document.getElementById('quiz-hist-duration');

            if (histAnswer) histAnswer.textContent = log.user_answer || '-';
            if (histScore) histScore.textContent = (log.score_change > 0 ? '+' : '') + (log.score_change || 0);
            if (histMastery) histMastery.textContent = (log.mastery_snapshot !== undefined && log.mastery_snapshot !== null) ? (log.mastery_snapshot * 100).toFixed(1) + '%' : '-';

            // Display duration
            if (histDuration) {
                if (log.duration_ms && log.duration_ms > 0) {
                    const seconds = (log.duration_ms / 1000).toFixed(1);
                    histDuration.textContent = seconds + 's';
                } else {
                    histDuration.textContent = '-';
                }
            }
        };

        window.saveQuizNote = function (itemId) {
            const btn = document.getElementById('quiz-save-note-btn');
            const input = document.getElementById('quiz-item-note-input');
            if (!btn || !input) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

            let csrfToken = '';
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) csrfToken = meta.getAttribute('content');

            fetch('/notes/save/item/' + itemId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ content: input.value })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success || data.status === 'success') {
                        btn.innerHTML = '<i class="fas fa-check"></i> Đã lưu';
                        btn.style.background = '#10b981';
                        const staticContent = document.getElementById('quiz-note-static-content');
                        if (staticContent) staticContent.textContent = input.value || "Chưa có ghi chú nào.";
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '#4f46e5';
                            btn.disabled = false;
                            toggleQuizNoteEdit(false);
                        }, 1000);
                    } else {
                        alert('Lỗi: ' + (data.message || 'Không thể lưu'));
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi kết nối');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        };

        window.generateQuizAI = function (itemId) {
            const btn = document.getElementById('quiz-generate-ai-btn');
            const aiContent = document.getElementById('quiz-stats-ai-content');
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';

            let csrfToken = '';
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) csrfToken = meta.getAttribute('content');

            fetch('/learn/quiz/api/item/' + itemId + '/generate-ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const content = data.explanation;
                        if (aiContent) {
                            if (window.renderMarkdown) {
                                aiContent.innerHTML = window.renderMarkdown(content.trim());
                                aiContent.classList.add('markdown-body');
                                aiContent.style.whiteSpace = 'normal';
                            } else {
                                aiContent.innerHTML = '<div style="white-space: pre-wrap;">' + content + '</div>';
                            }
                            aiContent.style.display = 'block';
                        }
                        const placeholder = document.getElementById('quiz-stats-ai-placeholder');
                        if (placeholder) placeholder.style.display = 'none';

                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    } else {
                        alert('Lỗi: ' + (data.message || 'Không thể tạo giải thích'));
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi kết nối: ' + err);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        };

        const initQuizStatsModal = () => {
            const statsModal = document.getElementById('quiz-item-stats-modal');
            const statsContainer = document.getElementById('quiz-item-stats-container');
            const closeBtns = document.querySelectorAll('.js-close-quiz-stats-modal');

            if (closeBtns) {
                closeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        if (statsModal) statsModal.style.display = 'none';
                    });
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && statsModal && statsModal.style.display !== 'none') {
                    statsModal.style.display = 'none';
                }
            });

            window.openQuizItemStats = function (itemId) {
                if (!statsModal || !statsContainer) {
                    console.error("Quiz Stats Modal elements not found");
                    return;
                }

                statsModal.style.display = 'flex';
                statsContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 16rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6366f1;"></i></div>';

                const editBtn = document.getElementById('quiz-stats-edit-btn');
                if (editBtn) editBtn.style.display = 'none';

                fetch('/learn/quiz/item/' + itemId + '/stats?modal=true&_cb=' + new Date().getTime())
                    .then(r => r.text())
                    .then(html => {
                        statsContainer.innerHTML = html;
                        const contentEl = statsContainer.querySelector('.stats-container');
                        if (contentEl && editBtn) {
                            const canEdit = contentEl.dataset.canEdit === 'true';
                            const editUrl = contentEl.dataset.editUrl;
                            if (canEdit && editUrl) {
                                editBtn.style.display = 'flex';
                                editBtn.onclick = function (e) {
                                    if (e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                    }
                                    openQuizEditOverlay(editUrl);
                                    return false;
                                };
                            }
                        }

                        // [AI COACH] Render Markdown for existing explanation
                        const mdContainers = statsContainer.querySelectorAll('.js-markdown-content');
                        mdContainers.forEach(container => {
                            if (window.renderMarkdown) {
                                const rawText = container.textContent.trim();
                                container.innerHTML = window.renderMarkdown(rawText);
                                container.style.whiteSpace = 'normal';
                            }
                        });

                        if (window.initQuizStatsModalTabs) window.initQuizStatsModalTabs();
                    })
                    .catch(err => {
                        console.error("Quiz Stats load error:", err);
                        statsContainer.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 16rem; color: #94a3b8;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><span>Không thể tải thống kê</span></div>';
                    });
            };
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initQuizStatsModal);
        } else {
            initQuizStatsModal();
        }
    })();
</script>
