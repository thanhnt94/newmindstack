{#
# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html
# Phi√™n b·∫£n: 74.0
# ƒê√É S·ª¨A: ƒê∆∞a c√°c bi·∫øn Jinja ra ngo√†i object window.FlashcardConfig ƒë·ªÉ tr√°nh formatter l√†m h·ªèng syntax (insert space v√†o
{{ }}).
#}

{% set _v = template_version or 'aura_mobile' %}
{% extends _v ~ '/layouts/base.html' %}

{% block title %}H·ªçc Flashcard{% endblock %}

{# CRITICAL: Add flashcard-session-active class to body to hide header/footer on mobile #}
{% block body_class %} flashcard-session-active{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='aura_mobile/vocab_flashcard/css/session.css') }}">
<style>
    /* Smooth Card Transition */
    .card-transition-exit {
        opacity: 0;
        transform: scale(0.98);
        transition: opacity 0.1s ease-out, transform 0.1s ease-out;
    }

    .card-transition-enter {
        opacity: 0;
        transform: scale(1.02);
    }

    .card-transition-enter-active {
        opacity: 1;
        transform: scale(1);
        transition: opacity 0.15s ease-out, transform 0.15s ease-out;
    }
</style>

{% include _v ~ '/components/_markdown_assets.html' %}
{% endblock %}

{% block content %}
{# Mobile view only #}
{# Mobile Interface #}
<div class="flashcard-mobile-view">
    <div class="page-shell">
        <!-- Header - Stats Bar -->
        <!-- Header - Quiz Style Structure -->
        <header class="session-header">
            <div class="fc-header flex-col items-stretch !p-0">
                {# --- Row 1: Badge + Title + Score --- #}
                <div class="flex items-center justify-between px-3 py-2 bg-gradient-to-r from-emerald-500 to-green-600">
                    {# Badge + Title #}
                    <div class="flex items-center gap-2.5 overflow-hidden flex-1 mr-2">
                        <span
                            class="flex-shrink-0 flex items-center gap-1 px-2.5 py-1 bg-white/20 rounded-lg shadow-sm">
                            <i class="fas fa-clone text-white text-[10px]"></i>
                            <span class="text-[10px] font-bold text-white uppercase tracking-wide">FLASHCARD</span>
                        </span>
                        <span class="text-sm font-bold text-white truncate js-fc-title"
                            style="text-shadow: 0 1px 3px rgba(0,0,0,0.3);">{{ container_name }}</span>
                    </div>

                    {# Score Badge #}
                    <div class="flex-shrink-0 flex items-center gap-1 h-7 px-2.5 bg-white/20 rounded-full">
                        <i class="fa-solid fa-gem text-white text-[10px]"></i>
                        <span class="text-xs font-black text-white font-mono js-fc-score">
                            {{ "{:,}".format(current_user.total_score if current_user.total_score is not none else 0) }}
                        </span>
                    </div>
                </div>

                {# --- Row 2: Stats (White) --- #}
                <div class="bg-white border-b border-slate-200">
                    <div class="flex items-center justify-between px-3 py-2">
                        {# Stats Pills #}
                        <div id="fc-mobile-stats-pills"
                            class="flex items-center gap-1.5 text-xs overflow-x-auto no-scrollbar transition-all duration-300">

                            {# Progress Pill #}
                            <div
                                class="stat-pill flex-shrink-0 flex items-center gap-1 px-2 py-1 bg-slate-100 rounded-lg">
                                <i class="fa-solid fa-bars-progress text-slate-500 text-[9px]"></i>
                                <span class="text-slate-700 font-semibold gap-0.5 flex items-center text-[10px]">
                                    <span id="current-q-num">0</span>
                                    <span class="opacity-40 hidden" id="total-q-sep">/</span>
                                    <span id="total-q-num" class="hidden">...</span>
                                </span>
                            </div>

                            {# Correct Pill #}
                            <div
                                class="stat-pill flex-shrink-0 flex items-center gap-1 px-2 py-1 bg-emerald-50 rounded-lg">
                                <i class="fa-solid fa-check text-emerald-500 text-[9px]"></i>
                                <span class="text-emerald-600 font-bold" id="live-correct">0</span>
                            </div>

                            {# Wrong Pill #}
                            <div
                                class="stat-pill flex-shrink-0 flex items-center gap-1 px-2 py-1 bg-rose-50 rounded-lg">
                                <i class="fa-solid fa-times text-rose-500 text-[9px]"></i>
                                <span class="text-rose-600 font-bold" id="live-wrong">0</span>
                            </div>

                            {# Session Points Pill #}
                            <div
                                class="stat-pill flex-shrink-0 flex items-center gap-1 px-2 py-1 bg-amber-50 rounded-lg">
                                <i class="fa-solid fa-gem text-amber-500 text-[9px]"></i>
                                <span class="text-amber-600 font-bold" id="live-session-score">0</span>
                            </div>
                        </div>

                        {# Action Buttons #}
                        <div class="flex items-center gap-1.5 flex-shrink-0 relative">
                            {# ===== Audio Settings Modal (Centered, Self-Contained) ===== #}
                            <div id="audio-settings-modal"
                                class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm transition-opacity duration-200 opacity-0 pointer-events-none"
                                onclick="if(event.target===this) closeAudioModal()">
                                <div class="bg-white rounded-2xl shadow-2xl w-72 p-5 transform transition-transform duration-200 scale-95"
                                    id="audio-settings-modal-content">
                                    <div class="flex items-center justify-between mb-4">
                                        <span class="text-sm font-black text-slate-700 uppercase tracking-wider">üîä √Çm
                                            thanh</span>
                                        <button onclick="closeAudioModal()"
                                            class="w-7 h-7 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center hover:bg-slate-200 transition-colors">
                                            <i class="fas fa-times text-xs"></i>
                                        </button>
                                    </div>
                                    <div class="flex flex-col gap-3">
                                        {# Front Toggle #}
                                        <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-volume-up text-blue-500 text-sm"></i>
                                                <span class="text-sm font-bold text-slate-700">M·∫∑t tr∆∞·ªõc</span>
                                            </div>
                                            <button id="audio-modal-front-toggle"
                                                onclick="window.toggleSideAutoplay('front')"
                                                class="relative w-11 h-6 rounded-full transition-colors duration-200 bg-slate-300">
                                                <div
                                                    class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200">
                                                </div>
                                            </button>
                                        </div>
                                        {# Back Toggle #}
                                        <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-volume-up text-rose-500 text-sm"></i>
                                                <span class="text-sm font-bold text-slate-700">M·∫∑t sau</span>
                                            </div>
                                            <button id="audio-modal-back-toggle"
                                                onclick="window.toggleSideAutoplay('back')"
                                                class="relative w-11 h-6 rounded-full transition-colors duration-200 bg-slate-300">
                                                <div
                                                    class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200">
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <script>
                                // ‚îÄ‚îÄ Audio Modal: 100% self-contained ‚îÄ‚îÄ
                                function openAudioModal() {
                                    const m = document.getElementById('audio-settings-modal');
                                    const c = document.getElementById('audio-settings-modal-content');
                                    if (!m) return;
                                    m.classList.remove('opacity-0', 'pointer-events-none');
                                    m.classList.add('opacity-100', 'pointer-events-auto');
                                    if (c) { c.classList.remove('scale-95'); c.classList.add('scale-100'); }
                                    syncAudioModalUI();
                                }
                                function closeAudioModal() {
                                    const m = document.getElementById('audio-settings-modal');
                                    const c = document.getElementById('audio-settings-modal-content');
                                    if (!m) return;
                                    m.classList.add('opacity-0', 'pointer-events-none');
                                    m.classList.remove('opacity-100', 'pointer-events-auto');
                                    if (c) { c.classList.add('scale-95'); c.classList.remove('scale-100'); }
                                }
                                function syncAudioModalUI() {
                                    const fb = document.getElementById('audio-modal-front-toggle');
                                    const bb = document.getElementById('audio-modal-back-toggle');
                                    _setToggleVisual(fb, !!window.isAudioAutoplayFrontEnabled);
                                    _setToggleVisual(bb, !!window.isAudioAutoplayBackEnabled);
                                }
                                function _setToggleVisual(btn, isOn) {
                                    if (!btn) return;
                                    const knob = btn.querySelector('div');
                                    if (isOn) {
                                        btn.classList.remove('bg-slate-300');
                                        btn.classList.add('bg-emerald-500');
                                        if (knob) { knob.style.transform = 'translateX(1.25rem)'; }
                                    } else {
                                        btn.classList.remove('bg-emerald-500');
                                        btn.classList.add('bg-slate-300');
                                        if (knob) { knob.style.transform = 'translateX(0)'; }
                                    }
                                }
                                // Expose globally so audio_manager.js can call it
                                window.syncAudioModalUI = syncAudioModalUI;
                                window.openAudioModal = openAudioModal;
                                window.closeAudioModal = closeAudioModal;
                            </script>

                            {# Audio Settings Button (opens modal) #}
                            <button onclick="openAudioModal()"
                                class="w-7 h-7 rounded-full bg-slate-50 text-slate-500 flex items-center justify-center hover:bg-slate-100 transition-transform active:scale-90"
                                title="C√†i ƒë·∫∑t √¢m thanh">
                                <i class="fas fa-volume-up text-[10px]"></i>
                            </button>



                            {# Home Button #}
                            <a href="{{ url_for('dashboard.dashboard') }}"
                                class="w-7 h-7 rounded-full bg-slate-50 text-slate-500 flex items-center justify-center hover:bg-slate-100"
                                title="V·ªÅ trang ch·ªß">
                                <i class="fas fa-home text-[10px]"></i>
                            </a>

                            {# Exit Button #}
                            <button onclick="showExitModal()"
                                class="w-7 h-7 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-100"
                                title="Tho√°t">
                                <i class="fa-solid fa-right-from-bracket text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        {# Import and render flashcard card component #}
        {% from 'aura_mobile/modules/vocab_flashcard/components/card.html' import render_flashcard_card %}
        {{ render_flashcard_card() }}
    </div>

    <!-- Exit Confirmation Modal (Added for Header Exit Button) -->
    <div id="exit-confirm-modal"
        class="fixed inset-0 bg-slate-900/40 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300"
        style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform scale-95 transition-transform duration-300"
            id="exit-modal-panel">
            <div class="text-center">
                <div
                    class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl ring-4 ring-rose-50">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">K·∫øt th√∫c phi√™n h·ªçc?</h3>
                <p class="text-slate-500 text-sm mb-6 leading-relaxed">K·∫øt qu·∫£ hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠.</p>
                <div class="flex gap-3">
                    <button onclick="closeExitModal()"
                        class="flex-1 py-2.5 rounded-xl font-bold text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 transition-colors">·ªû
                        l·∫°i</button>
                    <button onclick="confirmExit()"
                        class="flex-1 py-2.5 rounded-xl font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-lg shadow-rose-500/30 transition-all">K·∫øt
                        th√∫c</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Bar -->
    <div class="fc-bottom-bar">
        <!-- Flip Button (shown on front) -->
        <button class="fc-flip-btn js-fc-flip-btn">
            <i class="fas fa-sync-alt"></i>
            <span>L·∫≠t th·∫ª</span>
        </button>

        <!-- Rating Buttons (shown on back) - dynamically populated by JavaScript -->
        <div class="fc-rating-btns js-fc-rating-btns" id="mobile-rating-btns">
            <!-- Buttons will be generated dynamically based on user_button_count -->
        </div>
    </div>
</div>

{# Reusable Item Stats Modal #}
{% include _v ~ '/modules/vocabulary/detail/_modal_stats.html' %}


<script src="{{ url_for('static', filename='aura_mobile/vocab_flashcard/js/audio_manager.js') }}?v=rewrite_v3"></script>
<script src="{{ url_for('static', filename='aura_mobile/vocab_flashcard/js/render_card.js') }}"></script>
<script src="{{ url_for('static', filename='aura_mobile/vocab_flashcard/js/ui_manager.js') }}"></script>
<script src="{{ url_for('static', filename='aura_mobile/vocab_flashcard/js/session_ui.js') }}"></script>

{# ... #}

{# ... #}



{# ... #}


<script src="{{ url_for('static', filename='aura_mobile/vocab_flashcard/js/utils.js') }}"></script>

{% endblock %}

{% block scripts %}
{{ super() }}

<script>
    // Define Jinja variables outside the config object to prevent the auto-formatter from inserting spaces into braces
    const _userButtonCount = {{ user_button_count|default (4) }};
    const _isAutoplaySession = {{ is_autoplay_session|default (false) | tojson }};
    const _autoplayMode = "{{ autoplay_mode|default('') }}";
    const _visualSettings = {{ (saved_visual_settings or { })| tojson }};
    const _autoSaveOn = {{ saved_auto_save|default (true) | tojson }};
    const _currentUserTotalScore = {{ current_user.total_score|default (0) }};
    const _scoreAgain = {{ config.SCORE_FSRS_AGAIN|default (1) }};
    const _scoreHard = {{ config.SCORE_FSRS_HARD|default (5) }};
    const _scoreGood = {{ config.SCORE_FSRS_GOOD|default (10) }};
    const _scoreEasy = {{ config.SCORE_FSRS_EASY|default (15) }};

    // Notification Configs
    const _notifScoreDuration = {{ config.NOTIF_SCORE_DURATION|default (1500) }};
    const _notifScorePosition = "{{ config.NOTIF_SCORE_POSITION|default('center') }}";
    const _notifStreakDuration = {{ config.NOTIF_STREAK_DURATION|default (2000) }};
    const _notifAchievementDuration = {{ config.NOTIF_ACHIEVEMENT_DURATION|default (5000) }};
    const _dbSessionId = {{ db_session_id|default (0) }};
    const _initialProcessedCount = {{ initial_processed_count|default (0) }};
    const _initialCorrectCount = {{ initial_correct_count|default (0) }};
    const _initialIncorrectCount = {{ initial_incorrect_count|default (0) }};
    const _initialVagueCount = {{ initial_vague_count|default (0) }};

    // [SSR] Initial Data
    window.initialFlashcardBatch = {{ (initial_batch or[])| tojson }};

    window.FlashcardConfig = {
        getFlashcardBatchUrl: "{{ url_for('vocab_flashcard.api_get_flashcard_batch') }}",
        flashcardItemApiUrlTemplate: "{{ url_for('vocab_flashcard.api_get_flashcard_item_details', item_id=0) }}",
        submitAnswerUrl: "{{ url_for('vocab_flashcard.api_submit_flashcard_answer') }}",
        endSessionUrl: "{{ url_for('vocab_flashcard.api_end_session_flashcard') }}",
        regenerateAudioUrl: "{{ url_for('vocab_flashcard.api_regenerate_audio_from_content') }}",
        saveSettingsUrl: "{{ url_for('vocab_flashcard.api_save_flashcard_settings') }}",
        vocabDashboardUrl: "{{ url_for('vocab_flashcard.dashboard_home') }}",
        getNoteUrl: "{{ url_for('notes.get_note', reference_type='item', reference_id=0) }}",
        saveNoteUrl: "{{ url_for('notes.save_note', reference_type='item', reference_id=0) }}",
        editFlashcardUrlTemplate: "{{ url_for('content_management.edit_flashcard_item', set_id=0, item_id=0) }}",
        itemStatsUrlTemplate: "{{ url_for('vocabulary.item_stats_page', item_id=0) }}",
        csrfHeaders: { "X-CSRFToken": "{{ csrf_token() }}" },
        userButtonCount: _userButtonCount,
        isAutoplaySession: _isAutoplaySession,
        autoplayMode: _autoplayMode,
        visualSettings: _visualSettings,
        autoSaveOn: _autoSaveOn,
        modeDisplayName: "{{ mode_display_text }}",
        displaySettings: {{ (display_settings or { }) | tojson }},
    dbSessionId: _dbSessionId,
        initialProcessedCount: _initialProcessedCount,
            initialCorrectCount: _initialCorrectCount,
                initialIncorrectCount: _initialIncorrectCount,
                    initialVagueCount: _initialVagueCount,
                        scores: {
        again: _scoreAgain,
            hard: _scoreHard,
                good: _scoreGood,
                    easy: _scoreEasy
    },
    notifications: {
        score_duration: _notifScoreDuration,
            score_position: _notifScorePosition,
                streak_duration: _notifStreakDuration,
                    achievement_duration: _notifAchievementDuration
    }
            };


    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
    if (csrfToken) {
        window.FlashcardConfig.csrfHeaders = { "X-CSRFToken": csrfToken };
    }

    window.currentUserTotalScoreInit = _currentUserTotalScore;
    window.sessionScore = 0;

    // [CRITICAL] Activate Driver API if we have a DB session ID
    if (_dbSessionId && window.setDriverSessionId) {
        window.setDriverSessionId(_dbSessionId);
        console.log('[Session Init] Driver API activated with session ID:', _dbSessionId);
    }

    // Global Exit Modal Logic for Flashcard
    window.showExitModal = function () {
        const exitModal = document.getElementById('exit-confirm-modal');
        const exitPanel = document.getElementById('exit-modal-panel');
        if (exitModal) {
            exitModal.style.display = 'flex';
            setTimeout(() => {
                exitModal.classList.remove('opacity-0', 'hidden');
                exitPanel.classList.remove('scale-95');
                exitPanel.classList.add('scale-100');
            }, 10);
        }
    };

    window.closeExitModal = function () {
        const exitModal = document.getElementById('exit-confirm-modal');
        const exitPanel = document.getElementById('exit-modal-panel');
        if (exitModal) {
            exitModal.classList.add('opacity-0');
            exitPanel.classList.remove('scale-100');
            exitPanel.classList.add('scale-95');
            setTimeout(() => {
                exitModal.classList.add('hidden');
                exitModal.style.display = 'none';
            }, 300);
        }
    };

    window.confirmExit = function () {
        const config = window.FlashcardConfig;
        const endSessionUrl = config?.endSessionUrl;
        if (!endSessionUrl) {
            console.error('FlashcardConfig.endSessionUrl is missing.');
            window.location.href = config?.vocabDashboardUrl || '/';
            return;
        }

        fetch(endSessionUrl, {
            method: 'POST',
            headers: config.csrfHeaders
        })
            .then(response => response.json())
            .then(data => {
                if (data.session_id) {
                    window.location.href = "{{ url_for('vocab_flashcard.session_summary', session_id=0) }}".replace('0', data.session_id);
                } else {
                    window.location.href = config.vocabDashboardUrl;
                }
            })
            .catch(err => {
                console.error('Error ending session:', err);
                window.location.href = config.vocabDashboardUrl;
            });
    };
</script>

<script src="{{ url_for('static', filename='aura_mobile/vocab_flashcard/js/session_manager.js') }}"></script>
<script src="{{ url_for('static', filename='aura_mobile/vocab_flashcard/js/index.js') }}"></script>
<script src="{{ url_for('static', filename='aura_mobile/vocab_flashcard/js/flashcard_viewport.js') }}"></script>
{% endblock %}