{% extends "admin/modules/admin/admin_layout.html" %}
{% set active_page = 'ops_reset' %}

{% block title %}System Reset{% endblock %}
{% block page_title %}Đặt lại Hệ thống (System Reset){% endblock %}
{% block page_subtitle %}Các tác vụ nguy hiểm: Xóa dữ liệu, đặt lại tiến độ và khôi phục cài đặt gốc.{% endblock %}

{% block content %}
<div class="p-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- Reset Learning Progress -->
        <div class="bg-white rounded-xl border border-orange-200 shadow-sm overflow-hidden">
            <div class="p-6">
                <div class="w-12 h-12 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center text-xl mb-4">
                    <i class="fas fa-history"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">Đặt lại Tiến độ Học tập</h3>
                <p class="text-sm text-slate-500 mb-6">
                    Xóa toàn bộ lịch sử ôn tập (FSRS), trạng thái hoàn thành bài học và điểm số của TẤT CẢ người dùng.
                    <br><strong>Dữ liệu không thể khôi phục.</strong>
                </p>
                <button onclick="confirmReset('learning')" class="w-full py-2.5 rounded-lg border border-orange-200 text-orange-700 font-semibold hover:bg-orange-50 transition">
                    Xóa Tiến độ
                </button>
            </div>
        </div>

        <!-- Reset Content -->
        <div class="bg-white rounded-xl border border-red-200 shadow-sm overflow-hidden">
            <div class="p-6">
                <div class="w-12 h-12 rounded-lg bg-red-100 text-red-600 flex items-center justify-center text-xl mb-4">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">Xóa Nội dung (Content)</h3>
                <p class="text-sm text-slate-500 mb-6">
                    Xóa toàn bộ Khóa học, Flashcards, Quiz trong hệ thống.
                    <br><strong>Cảnh báo:</strong> Tiến độ học tập liên quan cũng sẽ bị xóa.
                </p>
                <button onclick="confirmReset('content')" class="w-full py-2.5 rounded-lg border border-red-200 text-red-700 font-semibold hover:bg-red-50 transition">
                    Xóa Nội dung
                </button>
            </div>
        </div>

        <!-- Factory Reset -->
        <div class="bg-slate-900 rounded-xl border border-slate-700 shadow-lg overflow-hidden text-white relative">
            <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">
                <i class="fas fa-radiation"></i>
            </div>
            <div class="p-6 relative z-10">
                <div class="w-12 h-12 rounded-lg bg-slate-800 text-red-500 flex items-center justify-center text-xl mb-4 border border-slate-700">
                    <i class="fas fa-biohazard"></i>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">Factory Reset</h3>
                <p class="text-sm text-slate-400 mb-6">
                    Xóa sạch dữ liệu (Nội dung, User, Tiến độ) đưa hệ thống về trạng thái ban đầu.
                    <br><strong>Chỉ giữ lại tài khoản Admin.</strong>
                </p>
                <button onclick="confirmReset('factory')" class="w-full py-2.5 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition shadow-lg shadow-red-900/50">
                    FACTORY RESET
                </button>
            </div>
        </div>

    </div>
</div>

<script>
    async function confirmReset(type) {
        let message = '';
        let url = '';
        
        if (type === 'learning') {
            message = 'Bạn có CHẮC CHẮN muốn xóa toàn bộ TIẾN ĐỘ HỌC TẬP? Hành động này không thể hoàn tác.';
            url = "{{ url_for('ops.reset_learning') }}";
        } else if (type === 'content') {
            message = 'CẢNH BÁO: Bạn sắp xóa toàn bộ NỘI DUNG. Bạn có chắc chắn không?';
            url = "{{ url_for('ops.reset_content') }}";
        } else if (type === 'factory') {
            message = 'NGUY HIỂM: FACTORY RESET sẽ xóa sạch dữ liệu hệ thống. Vui lòng nhập "CONFIRM" để tiếp tục.';
        }

        if (type === 'factory') {
            const input = prompt(message);
            if (input !== 'CONFIRM') {
                if (input !== null) alert('Mã xác nhận sai. Đã hủy.');
                return;
            }
            url = "{{ url_for('ops.factory_reset') }}";
        } else {
            if (!confirm(message)) return;
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() }}"
                }
            });
            const data = await response.json();
            
            if (data.success) {
                alert('Thành công: ' + data.message);
                window.location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        } catch (e) {
            alert('Lỗi kết nối: ' + e);
        }
    }
</script>
{% endblock %}
