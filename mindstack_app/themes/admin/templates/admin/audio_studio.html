{% extends 'admin/admin_layout.html' %}

{% block title %}Audio Studio | Mindstack Admin{% endblock %}

{% block page_title %}Audio Studio{% endblock %}
{% block page_subtitle %}Trung tâm điều khiển và tạo giọng nói Text-to-Speech{% endblock %}
{% set active_page = 'audio_studio' %}

{% block extra_head %}
<!-- Font Awesome is likely included in admin_layout.html, but keeping it here for safety if not -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    .studio-card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: none;
        overflow: hidden;
    }

    /* The original .studio-header styling is removed as the page_title/subtitle are handled by the layout */

    .form-label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-control,
    .form-select {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        border-color: #d1d5db;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .btn-primary {
        background-color: #4f46e5;
        border-color: #4f46e5;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .btn-primary:hover {
        background-color: #4338ca;
        border-color: #4338ca;
        transform: translateY(-1px);
    }

    .audio-player-wrapper {
        background: #f3f4f6;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    audio {
        width: 100%;
        outline: none;
    }

    #manualConfig {
        display: none;
        margin-top: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px dashed #d1d5db;
    }

    /* Spinner styling is now handled by Font Awesome classes and hidden/shown with 'hidden' class */
    #loadingSpinner {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 mx-auto">
        <div class="studio-card">
            <!-- Tailwind Tabs Header -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button type="button"
                        class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 focus:outline-none"
                        data-target="playground" id="tab-playground">
                        <i class="fas fa-play-circle me-2"></i>Playground
                    </button>
                    <button type="button"
                        class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none"
                        data-target="settings" id="tab-settings">
                        <i class="fas fa-cog me-2"></i>Settings
                    </button>
                    <button type="button"
                        class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none"
                        data-target="maintenance" id="tab-maintenance">
                        <i class="fas fa-tools me-2"></i>Maintenance
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- PANEL: PLAYGROUND -->
                <div class="tab-pane block" id="pane-playground">
                    <form id="audioForm">
                        <!-- Input Text -->
                        <div class="mb-4">
                            <label for="textInput" class="form-label">Nội dung (Text)</label>
                            <textarea class="form-control w-full" id="textInput" rows="4"
                                placeholder="Nhập nội dung cần chuyển đổi thành giọng nói..." required></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Engine Selection -->
                            <div>
                                <label for="engineSelect" class="form-label">TTS Engine</label>
                                <select class="form-select w-full" id="engineSelect">
                                    <option value="edge">Edge TTS (Microsoft)</option>
                                    <option value="gtts">Google TTS (gTTS)</option>
                                </select>
                            </div>

                            <!-- Voice Config -->
                            <div>
                                <label for="voiceId" class="form-label">Voice / Language</label>
                                <select class="form-select w-full" id="voiceId">
                                    <!-- Populated by JS -->
                                </select>
                                <div class="text-xs text-slate-500 mt-1" id="voiceHelp">Select engine to see available
                                    voices.</div>
                            </div>
                        </div>

                        <!-- Advanced Options -->
                        <div class="mb-4">
                            <div class="form-check flex items-center gap-2">
                                <input class="form-check-input" type="checkbox" id="autoVoiceTags">
                                <label class="form-check-label select-none text-sm text-slate-700 font-medium"
                                    for="autoVoiceTags">
                                    Advanced: Parse Voice Tags (e.g. <code>en(m): Hello</code>)
                                </label>
                            </div>
                            <div class="text-xs text-slate-500 ml-6 mt-1 hidden" id="tagsHelp">
                                When enabled, voice selection above is ignored. Use format
                                <code>lang(gender): Text</code> in content.
                            </div>
                        </div>

                        <!-- Manual Mode Toggle -->
                        <div class="mt-6">
                            <div class="form-check form-switch flex items-center gap-2">
                                <input class="form-check-input" type="checkbox" id="manualModeSwitch">
                                <label class="form-check-label select-none" for="manualModeSwitch">
                                    Chế độ thủ công (Manual Save)
                                </label>
                            </div>

                            <!-- Manual Config Section -->
                            <div id="manualConfig">
                                <div class="mb-3">
                                    <label for="targetDir" class="form-label">Target Directory (Relative)</label>
                                    <input type="text" class="form-control w-full" id="targetDir"
                                        placeholder="e.g. uploads/audio/cache">
                                </div>
                                <div class="mb-3">
                                    <label for="filename" class="form-label">Custom Filename</label>
                                    <input type="text" class="form-control w-full" id="filename"
                                        placeholder="e.g. hello_world.mp3">
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-6 flex items-center">
                            <button type="submit" class="btn btn-primary flex items-center gap-2" id="generateBtn">
                                <i class="fas fa-spinner fa-spin hidden" id="loadingSpinner"></i>
                                <span id="btnText">Generate & Preview</span>
                            </button>
                            <div class="ml-auto text-sm text-muted">
                                <span id="statusBadge"></span>
                            </div>
                        </div>

                        <!-- Audio Player -->
                        <div class="audio-player-wrapper opacity-50 transition-opacity duration-300"
                            id="playerContainer">
                            <audio id="audioPlayer" controls>
                                Your browser does not support the audio element.
                            </audio>
                        </div>

                        <!-- File Info -->
                        <div id="fileInfo" class="mt-4 p-3 bg-slate-50 rounded text-sm text-slate-600 hidden">
                            <div class="flex flex-col gap-1">
                                <div><strong>Path:</strong> <span id="physicalPath"
                                        class="font-mono text-xs select-all"></span></div>
                                <div><strong>URL:</strong> <a href="#" id="urlLink" target="_blank"
                                        class="text-indigo-600 hover:underline break-all">...</a></div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- PANEL: SETTINGS -->
                <div class="tab-pane hidden" id="pane-settings">
                    <form id="settingsForm">
                        <div class="alert alert-info border-0 bg-blue-50 text-blue-800 text-sm mb-4">
                            <i class="fas fa-info-circle me-1"></i>
                            Cấu hình mặc định sẽ được sử dụng khi API `get_audio` được gọi mà không có tham số cụ thể.
                        </div>

                        <!-- Default Engine -->
                        <div class="mb-4">
                            <label for="defaultEngine" class="form-label">Default Engine</label>
                            <select class="form-select w-full" id="defaultEngine">
                                <option value="edge" {% if default_engine=='edge' %}selected{% endif %}>Edge TTS
                                </option>
                                <option value="gtts" {% if default_engine=='gtts' %}selected{% endif %}>Google TTS
                                </option>
                            </select>
                        </div>

                        <div class="row g-4">
                            <!-- Default Edge Voice -->
                            <div class="col-md-6">
                                <label for="defaultEdgeVoice" class="form-label">Default Edge Voice</label>
                                <select class="form-select w-full" id="defaultEdgeVoice">
                                    <!-- Populated by JS -->
                                </select>
                            </div>

                            <!-- Default gTTS Voice -->
                            <div class="col-md-6">
                                <label for="defaultGttsVoice" class="form-label">Default gTTS Voice</label>
                                <select class="form-select w-full" id="defaultGttsVoice">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                        </div>

                        <!-- Voice Mappings Section -->
                        <div class="mt-6 pt-4 border-t border-gray-100">
                            <h5 class="text-sm font-bold text-gray-700 mb-3">Custom Voice Mappings (Edge TTS)</h5>
                            <div class="text-xs text-gray-500 mb-3">
                                Define which voice to use for specific codes in your text (e.g. <code>vi(m): ...</code>
                                uses <code>vi-m</code>).
                            </div>

                            <div class="overflow-x-auto">
                                <table class="table w-full text-sm" id="mappingTable">
                                    <thead>
                                        <tr class="text-left bg-gray-50 text-gray-600">
                                            <th class="p-2 rounded-l-lg">Code Key</th>
                                            <th class="p-2">Voice</th>
                                            <th class="p-2 rounded-r-lg w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="mappingBody">
                                        <!-- Rows injected by JS -->
                                    </tbody>
                                </table>
                            </div>

                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addMappingBtn">
                                <i class="fas fa-plus me-1"></i> Add Mapping
                            </button>
                        </div>


                        <div class="mt-6 border-t border-gray-100 pt-4 text-right">
                            <button type="submit" class="btn btn-success flex items-center gap-2 ml-auto"
                                id="saveSettingsBtn">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Tab 4: Maintenance (Migrated from Legacy Voice Panel) -->
                <div class="tab-pane hidden" id="pane-maintenance">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Audio Maintenance Tasks</h3>
                    <p class="text-sm text-gray-500 mb-4">Run background jobs to manage audio files.</p>

                    <div class="space-y-4">
                        <!-- Task: Generate Cache -->
                        <div class="bg-white p-4 rounded shadow-sm flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-800">Generate Audio Cache</h4>
                                <p class="text-xs text-gray-500">Scan all flashcards and pre-generate missing audio
                                    files.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="badge badge-outline text-xs" id="status-generate_audio_cache">Idle</span>
                                <button class="btn btn-sm btn-primary" onclick="startTask('generate_audio_cache')">
                                    <i class="fas fa-play"></i> Start
                                </button>
                            </div>
                        </div>

                        <!-- Task: Clean Orphan Audio -->
                        <div class="bg-white p-4 rounded shadow-sm flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-800">Clean Orphan Audio</h4>
                                <p class="text-xs text-gray-500">Remove audio files that are no longer linked to any
                                    flashcard.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="badge badge-outline text-xs" id="status-clean_audio_cache">Idle</span>
                                <button class="btn btn-sm btn-warning" onclick="startTask('clean_audio_cache')">
                                    <i class="fas fa-broom"></i> Start
                                </button>
                            </div>
                        </div>

                        <!-- Task: Transcribe Quiz -->
                        <div class="bg-white p-4 rounded shadow-sm flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-800">Transcribe Quiz Audio (STT)</h4>
                                <p class="text-xs text-gray-500">Auto-generate text transcripts for quiz questions with
                                    audio.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="badge badge-outline text-xs" id="status-transcribe_quiz_audio">Idle</span>
                                <button class="btn btn-sm btn-secondary" onclick="startTask('transcribe_quiz_audio')">
                                    <i class="fas fa-microphone-alt"></i> Start
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Inject Server Configurations
    const SERVER_CONFIG = {
        defaultEngine: "{{ default_engine }}",
        defaultEdgeVoice: "{{ default_voice_edge }}",
        defaultGttsVoice: "{{ default_voice_gtts }}",
        voiceMapping: {{ voice_mapping | tojson | safe }}
    };

    document.addEventListener('DOMContentLoaded', function () {

        // --- Tab Switching Logic ---
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');

        function switchTab(targetName) {
            // 1. Update Buttons
            tabBtns.forEach(btn => {
                const isTarget = btn.dataset.target === targetName;
                if (isTarget) {
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    btn.classList.add('border-indigo-500', 'text-indigo-600');
                } else {
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    btn.classList.remove('border-indigo-500', 'text-indigo-600');
                }
            });

            // 2. Update Panes
            tabPanes.forEach(pane => {
                if (pane.id === 'pane-' + targetName) {
                    pane.classList.remove('hidden');
                    pane.classList.add('block');
                } else {
                    pane.classList.add('hidden');
                    pane.classList.remove('block');
                }
            });
        }

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.target);
            });
        });


        // --- Existing Logic ---
        const switchBtn = document.getElementById('manualModeSwitch');
        const manualConfig = document.getElementById('manualConfig');
        const form = document.getElementById('audioForm');
        const settingsForm = document.getElementById('settingsForm');

        const generateBtn = document.getElementById('generateBtn');
        const spinner = document.getElementById('loadingSpinner');
        const btnText = document.getElementById('btnText');

        const audioPlayer = document.getElementById('audioPlayer');
        const playerContainer = document.getElementById('playerContainer');
        const fileInfo = document.getElementById('fileInfo');

        const engineSelect = document.getElementById('engineSelect');
        const voiceSelect = document.getElementById('voiceId');

        // Settings Elements
        const defaultEdgeSelect = document.getElementById('defaultEdgeVoice');
        const defaultGttsSelect = document.getElementById('defaultGttsVoice');


        // Voice Data
        const VOICE_OPTIONS = {
            'edge': [
                { code: 'vi-VN-HoaiMyNeural', label: 'Vietnamese - Hoai My (Female)' },
                { code: 'vi-VN-NamMinhNeural', label: 'Vietnamese - Nam Minh (Male)' },
                { code: 'en-US-AriaNeural', label: 'English US - Aria (Female)' },
                { code: 'en-US-ChristopherNeural', label: 'English US - Christopher (Male)' },
                { code: 'en-US-GuyNeural', label: 'English US - Guy (Male)' },
                { code: 'en-US-JennyNeural', label: 'English US - Jenny (Female)' },
                { code: 'ja-JP-NanamiNeural', label: 'Japanese - Nanami (Female)' },
                { code: 'ja-JP-KeitaNeural', label: 'Japanese - Keita (Male)' }
            ],
            'gtts': [
                { code: 'vi', label: 'Vietnamese (Google)' },
                { code: 'en', label: 'English (Google)' },
                { code: 'ja', label: 'Japanese (Google)' }
            ]
        };

        // --- Helper: Populate Select ---
        function populateSelect(selectEl, options, selectedValue) {
            selectEl.innerHTML = '';
            options.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.code;
                opt.textContent = v.label;
                if (v.code === selectedValue) opt.selected = true;
                selectEl.appendChild(opt);
            });
        }

        // --- 1. Init Playground Voices ---
        function updatePlaygroundVoices() {
            const engine = engineSelect.value;
            const voices = VOICE_OPTIONS[engine] || [];
            // Preserve selection if compatible, else select default
            const currentVoice = voiceSelect.value;

            // Determine default to select if resetting
            let defaultToSelect = null;
            if (engine === 'edge') defaultToSelect = SERVER_CONFIG.defaultEdgeVoice;
            else if (engine === 'gtts') defaultToSelect = SERVER_CONFIG.defaultGttsVoice;

            populateSelect(voiceSelect, voices, defaultToSelect);
        }

        engineSelect.addEventListener('change', updatePlaygroundVoices);
        // Initial populate
        engineSelect.value = SERVER_CONFIG.defaultEngine;
        updatePlaygroundVoices();


        // --- 2. Init Settings Tab ---
        populateSelect(defaultEdgeSelect, VOICE_OPTIONS['edge'], SERVER_CONFIG.defaultEdgeVoice);
        populateSelect(defaultGttsSelect, VOICE_OPTIONS['gtts'], SERVER_CONFIG.defaultGttsVoice);

        // --- 2b. Voice Mapping Table Logic ---
        const mappingBody = document.getElementById('mappingBody');
        const addMappingBtn = document.getElementById('addMappingBtn');

        function createVoiceSelect(selectedValue) {
            const sel = document.createElement('select');
            sel.className = 'form-select w-full text-xs py-1';

            // Group: Edge TTS
            const grpEdge = document.createElement('optgroup');
            grpEdge.label = 'Edge TTS';
            VOICE_OPTIONS['edge'].forEach(v => {
                const opt = document.createElement('option');
                opt.value = `edge:${v.code}`;
                opt.textContent = v.label;
                if (`edge:${v.code}` === selectedValue) opt.selected = true;
                grpEdge.appendChild(opt);
            });
            sel.appendChild(grpEdge);

            // Group: Google TTS
            const grpGtts = document.createElement('optgroup');
            grpGtts.label = 'Google TTS';
            VOICE_OPTIONS['gtts'].forEach(v => {
                const opt = document.createElement('option');
                opt.value = `gtts:${v.code}`;
                opt.textContent = v.label;
                if (`gtts:${v.code}` === selectedValue) opt.selected = true;
                grpGtts.appendChild(opt);
            });
            sel.appendChild(grpGtts);

            return sel;
        }

        function addMappingRow(key = '', voice = '') {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100 hover:bg-gray-50';

            // Key Input
            const tdKey = document.createElement('td');
            tdKey.className = 'p-2';
            const inputKey = document.createElement('input');
            inputKey.type = 'text';
            inputKey.className = 'form-control text-xs py-1 w-full font-mono mapping-key';
            inputKey.placeholder = 'e.g. vi-m';
            inputKey.value = key;
            tdKey.appendChild(inputKey);

            // Voice Select
            const tdVoice = document.createElement('td');
            tdVoice.className = 'p-2';
            // Default to first Edge voice if new
            const defaultVal = voice || `edge:${SERVER_CONFIG.defaultEdgeVoice}`;
            const selectVoice = createVoiceSelect(defaultVal);
            selectVoice.className += ' mapping-voice';
            tdVoice.appendChild(selectVoice);

            // Action
            const tdAction = document.createElement('td');
            tdAction.className = 'p-2 text-center';
            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'text-red-500 hover:text-red-700 focus:outline-none';
            delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            delBtn.onclick = function () { tr.remove(); };
            tdAction.appendChild(delBtn);

            tr.appendChild(tdKey);
            tr.appendChild(tdVoice);
            tr.appendChild(tdAction);
            mappingBody.appendChild(tr);
        }

        // Init Table
        let mappingData = SERVER_CONFIG.voiceMapping || {};
        // Safeguard: If mappingData is a string (double-encoded JSON due to bug), parse it.
        if (typeof mappingData === 'string') {
            try {
                mappingData = JSON.parse(mappingData);
            } catch (e) {
                console.error("Failed to parse voiceMapping string:", e);
                mappingData = {};
            }
        }

        Object.entries(mappingData).forEach(([key, voice]) => {
            if (key && isNaN(parseInt(key))) { // Additional check to avoid numeric keys if any slipped in
                addMappingRow(key, voice);
            } else if (key && !isNaN(parseInt(key)) && typeof voice === 'string') {
                // If numeric key but valid voice string, maybe legitimate? 
                // But in our case, numeric keys were bug artifacts.
                // Let's Skip high numeric keys (likely indices) if value matches default
                // or just render them so user can delete.
                // Better: render them but user likely wants to clear.
                // For now, render standard way.
                addMappingRow(key, voice);
            }
        });

        addMappingBtn.addEventListener('click', () => {
            addMappingRow();
        });

        // --- 3. Toggle Manual Mode ---
        switchBtn.addEventListener('change', function () {
            manualConfig.style.display = this.checked ? 'block' : 'none';
        });

        const autoTagsCheckbox = document.getElementById('autoVoiceTags');
        const tagsHelp = document.getElementById('tagsHelp');

        autoTagsCheckbox.addEventListener('change', function () {
            if (this.checked) {
                voiceSelect.disabled = true;
                voiceSelect.classList.add('bg-gray-100', 'text-gray-400');
                tagsHelp.classList.remove('hidden');
            } else {
                voiceSelect.disabled = false;
                voiceSelect.classList.remove('bg-gray-100', 'text-gray-400');
                tagsHelp.classList.add('hidden');
            }
        });

        // --- 4. Handle Save Settings ---
        settingsForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const btn = document.getElementById('saveSettingsBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            // Collect Mappings
            const mappingRows = document.querySelectorAll('#mappingBody tr');
            const newMapping = {};
            mappingRows.forEach(tr => {
                const key = tr.querySelector('.mapping-key').value.trim();
                const voice = tr.querySelector('.mapping-voice').value;
                if (key) {
                    newMapping[key] = voice;
                }
            });

            const payload = {
                default_engine: document.getElementById('defaultEngine').value,
                default_voice_edge: document.getElementById('defaultEdgeVoice').value,
                default_voice_gtts: document.getElementById('defaultGttsVoice').value,
                voice_mapping: newMapping, // Correct key
            };

            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

            try {
                const response = await fetch('/admin/audio/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.success) {
                    if (window.showFlashMessage) window.showFlashMessage(data.message, 'success');
                    // Update local config ref
                    SERVER_CONFIG.defaultEngine = payload.default_engine;
                    SERVER_CONFIG.defaultEdgeVoice = payload.default_voice_edge;
                    SERVER_CONFIG.defaultGttsVoice = payload.default_voice_gtts;
                    SERVER_CONFIG.voiceMapping = payload.voice_mapping; // Update local mapping
                } else {
                    if (window.showFlashMessage) window.showFlashMessage('Error: ' + data.error, 'danger');
                }
            } catch (err) {
                if (window.showFlashMessage) window.showFlashMessage('Network Error', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // --- 5. Handle Generate Audio ---
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            // UI Loading State
            generateBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = 'Processing...';
            playerContainer.classList.add('opacity-50');
            fileInfo.classList.add('hidden');

            // Collect Data
            const payload = {
                text: document.getElementById('textInput').value,
                engine: document.getElementById('engineSelect').value,
                voice: document.getElementById('voiceId').value,
                is_manual: switchBtn.checked,
                target_dir: switchBtn.checked ? document.getElementById('targetDir').value : null,
                custom_filename: switchBtn.checked ? document.getElementById('filename').value : null,
                auto_voice_parsing: autoTagsCheckbox.checked
            };

            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

            try {
                const response = await fetch('/admin/audio/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    // Success
                    const audioUrl = data.data.url;

                    // Update Player
                    audioPlayer.src = audioUrl;
                    playerContainer.classList.remove('opacity-50');

                    // Auto Play
                    audioPlayer.play().catch(e => console.log("Auto-play blocked:", e));

                    // Show Info
                    fileInfo.classList.remove('hidden');
                    document.getElementById('physicalPath').textContent = data.data.physical_path;
                    document.getElementById('urlLink').textContent = audioUrl;
                    document.getElementById('urlLink').href = audioUrl;

                    if (window.showFlashMessage) window.showFlashMessage('Audio generated successfully!', 'success');
                } else {
                    // API Error
                    if (window.showFlashMessage) window.showFlashMessage('Error: ' + (data.error || 'Unknown error'), 'danger');
                }

            } catch (err) {
                console.error(err);
                if (window.showFlashMessage) window.showFlashMessage('Network error or server crash.', 'danger');
            } finally {
                // Reset UI
                generateBtn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = 'Generate & Preview';
            }
        });
    });
</script>
{% endblock %}
