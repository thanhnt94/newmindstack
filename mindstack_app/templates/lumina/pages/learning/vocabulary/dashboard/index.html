{#
File: mindstack_app/templates/lumina/pages/learning/vocabulary/dashboard/index.html
Purpose: Main entry point for Vocabulary Dashboard (Browser View) + Set Detail SPA
#}
{% set _v = template_version or 'lumina' %}
{% extends _v ~ '/base.html' %}

{% block title %}Học từ vựng - MindStack{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* === INLINED VOCABULARY.CSS (REFINED V5 - Added Detail View Styles) === */
    :root {
        --ios-bg: #F2F2F7;
        --ios-card-bg: #FFFFFF;
        --ios-blue: #007AFF;
        --ios-text: #000000;
        --ios-text-secondary: #8E8E93;
        --ios-border: rgba(60, 60, 67, 0.36);
    }

    /* === MOBILE LAYOUT === */
    .lumina-vocab-mobile {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        background: var(--ios-bg);
        padding-bottom: 90px;
        /* Break out of parent padding to be full width */
        margin: -16px;
        width: calc(100% + 32px);
    }

    /* Sticky Header - FIXED positioning */
    .lumina-vocab-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 900;
        background: #FFFFFF;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
    }

    .lumina-vocab-header__top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px 8px;
        height: 44px;
    }

    /* Spacer for fixed header */
    .lumina-vocab-grid {
        margin-top: 110px;
        /* Mobile spacer */
        padding: 16px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .lumina-vocab-title {
        font-size: 17px;
        font-weight: 600;
        color: #000;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }

    .lumina-back-btn {
        font-size: 17px;
        color: var(--ios-blue);
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 400;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
    }

    /* Search Bar Area */
    .lumina-header-content {
        padding: 0 16px 12px;
        background: #FFFFFF;
    }

    .lumina-vocab-search {
        position: relative;
        margin-bottom: 12px;
    }

    .lumina-vocab-search input {
        width: 100%;
        height: 40px;
        background: #F2F2F7;
        border-radius: 12px;
        border: none;
        padding: 0 36px;
        font-size: 17px;
        color: #000;
        outline: none;
        transition: background 0.2s;
    }

    .lumina-vocab-search input:focus {
        background: #E5E5EA;
    }

    .lumina-vocab-search i {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #8E8E93;
        font-size: 16px;
    }

    /* Segmented Control */
    .lumina-segmented-control {
        display: flex;
        background: #F2F2F7;
        padding: 3px;
        border-radius: 9px;
        height: 36px;
    }

    .lumina-segment-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 500;
        color: #000;
        border-radius: 7px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .lumina-segment-btn.active {
        background: #FFFFFF;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        font-weight: 600;
    }

    @media (min-width: 375px) {
        .lumina-vocab-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    /* CARD DESIGN */
    .lumina-set-card {
        background: #FFFFFF;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: none;
        cursor: pointer;
    }

    .lumina-set-card:active {
        transform: scale(0.96);
        transition: transform 0.1s;
    }

    .lumina-set-cover {
        aspect-ratio: 1;
        background: #F2F2F7;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: #D1D1D6;
        position: relative;
    }

    .lumina-set-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .lumina-set-info {
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .lumina-set-title {
        font-size: 16px;
        font-weight: 700;
        color: #1C1C1E;
        line-height: 1.3;
        margin-bottom: 2px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        height: 42px;
    }

    .lumina-set-meta {
        font-size: 13px;
        color: #8E8E93;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .lumina-set-count {
        display: flex;
        align-items: center;
        gap: 4px;
        background: #F2F2F7;
        color: #007AFF;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 11px;
    }

    /* DETAIL VIEW SPECIFIC */
    #vocab-view-detail-mobile {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        overflow-y: auto;
        margin: -16px;
        /* Break parent padding */
        width: calc(100% + 32px);
    }

    .lumina-detail-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }


    /* === DESKTOP OVERRIDES === */
    @media (min-width: 1024px) {
        .lumina-vocab-mobile {
            display: none;
        }

        .lumina-desktop-vocab {
            display: block;
            padding: 40px;
            max-width: 1280px;
            margin: 0 auto;
        }

        .lumina-desktop-header {
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .lumina-desktop-title {
            font-size: 36px;
            font-weight: 800;
            color: #1C1C1E;
            letter-spacing: -1px;
        }

        .lumina-desktop-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .lumina-desktop-tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: #F2F2F7;
            border-radius: 12px;
        }

        .lumina-desktop-tab {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #8E8E93;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lumina-desktop-tab.active {
            background: white;
            color: #1C1C1E;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .lumina-vocab-search {
            margin-bottom: 0;
        }

        .lumina-vocab-grid {
            margin-top: 0;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            padding: 0;
        }

        .lumina-set-card {
            background: #fff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lumina-set-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .lumina-set-cover {
            aspect-ratio: 16/10;
        }

        #vocab-view-detail-mobile {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
{# Configuration for JS #}
<script>
    window.ComponentConfig = {
        activeSetId: {{ active_set_id | tojson | safe if active_set_id else 'null' }}
        };
</script>

{# === Mobile View === #}
<div class="lg:hidden">
    <div id="vocab-view-dashboard-mobile">
        {% include _v ~ '/pages/learning/vocabulary/dashboard/_mobile.html' %}
    </div>
    {% include _v ~ '/pages/learning/vocabulary/dashboard/_detail_mobile.html' %}
</div>

{# === Desktop View === #}
<div class="hidden lg:block">
    <div id="vocab-view-dashboard-desktop">
        {% include _v ~ '/pages/learning/vocabulary/dashboard/_desktop.html' %}
    </div>
    {% include _v ~ '/pages/learning/vocabulary/dashboard/_detail_desktop.html' %}
</div>

{% endblock %}

{% block scripts %}
{{ super() }}

{# INLINED JS LOGIC #}
<script>
    (function () {
        'use strict';

        class VocabularyDashboard {
            constructor() {
                this.state = {
                    category: 'learning',
                    page: 1,
                    search: '',
                    isLoading: false,
                    activeSet: null
                };
                this.searchTimer = null;
                this.currentDetailId = null;
            }

            init() {
                // DOM Elements
                this.els = {
                    dashboardMobile: document.getElementById('vocab-view-dashboard-mobile'),
                    dashboardDesktop: document.getElementById('vocab-view-dashboard-desktop'),
                    detailMobile: document.getElementById('vocab-view-detail-mobile'),
                    detailDesktop: document.getElementById('vocab-view-detail-desktop'),

                    gridMobile: document.getElementById('vocab-grid-mobile'),
                    gridDesktop: document.getElementById('vocab-grid-desktop'),
                };

                this.bindEvents();
                this.loadSets();

                // Check for Deep Link
                if (window.ComponentConfig && window.ComponentConfig.activeSetId) {
                    this.loadSetDetail(window.ComponentConfig.activeSetId);
                }
            }

            bindEvents() {
                // Search
                document.querySelectorAll('.js-vocab-search-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        this.state.search = e.target.value.trim();
                        clearTimeout(this.searchTimer);
                        this.searchTimer = setTimeout(() => { this.state.page = 1; this.loadSets(); }, 300);
                    });
                });

                // Tabs
                const handleTab = (cat) => {
                    this.state.category = cat; this.state.page = 1;
                    this.updateTabUI(); this.loadSets();
                };
                document.querySelectorAll('.js-vocab-tab, .js-desktop-tab').forEach(t => {
                    t.addEventListener('click', () => handleTab(t.dataset.category));
                });
            }

            updateTabUI() {
                const isActive = (t) => t.dataset.category === this.state.category;
                document.querySelectorAll('.js-vocab-tab, .js-desktop-tab').forEach(t => t.classList.toggle('active', isActive(t)));
            }

            // --- DASHBOARD LOGIC ---

            async loadSets() {
                if (this.state.isLoading) return;
                this.state.isLoading = true;
                this.renderLoading(this.els.gridMobile);
                this.renderLoading(this.els.gridDesktop);

                try {
                    const params = new URLSearchParams({ category: this.state.category, page: this.state.page, q: this.state.search });
                    const res = await fetch(`/learn/vocabulary/api/sets?${params}`);
                    const data = await res.json();
                    if (data.success) {
                        this.renderSets(data.sets);
                        this.renderPagination(data);
                    }
                } catch (e) { console.error(e); }
                finally { this.state.isLoading = false; }
            }

            renderSets(sets) {
                const html = sets.length ? sets.map(s => this.createCardHTML(s)).join('') : this.getEmptyHTML();
                this.els.gridMobile.innerHTML = html;
                this.els.gridDesktop.innerHTML = html;
            }

            createCardHTML(set) {
                const cover = this.normalizePath(set.cover_image);
                const coverHTML = cover ? `<img src="${cover}" alt="${set.title}">` : `<i class="fa-solid fa-book-open"></i>`;
                return `
                    <div class="lumina-set-card animate-fadeIn" onclick="window.LuminaVocab.loadSetDetail(${set.id})">
                        <div class="lumina-set-cover">${coverHTML}</div>
                        <div class="lumina-set-info">
                            <div class="lumina-set-title">${set.title}</div>
                            <div class="lumina-set-meta">
                                <span>${set.creator_name || 'Admin'}</span>
                                <div class="lumina-set-count">${set.card_count}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- DETAIL LOGIC ---

            async loadSetDetail(setId) {
                // Show Loading UI immediately (optional)
                this.currentDetailId = setId;
                this.showDetailView();

                // Fetch Data
                try {
                    const res = await fetch(`/learn/vocabulary/api/set/${setId}`);
                    const data = await res.json();

                    if (data.success) {
                        this.state.activeSet = data.set;
                        this.renderDetail(data.set, data.course_stats ? data.course_stats.items : []);
                    }
                } catch (e) {
                    alert("Không thể tải bộ thẻ này.");
                    this.showDashboard();
                }
            }

            renderDetail(set, items) {
                // 1. Update Hero Info
                const updateElements = (prefix) => {
                    const container = document.getElementById(prefix);
                    if (!container) return;

                    const cover = this.normalizePath(set.cover_image);
                    const coverHTML = cover ? `<img src="${cover}">` : `<i class="fa-solid fa-book-open"></i>`;

                    container.querySelector('.lumina-detail-title').textContent = set.title;
                    container.querySelector('.lumina-detail-author').textContent = set.creator_name;
                    container.querySelector('.lumina-detail-count').textContent = set.card_count + ' từ';
                    container.querySelector('.lumina-detail-cover').innerHTML = coverHTML;
                }

                // Mobile
                updateElements('vocab-view-detail-mobile');
                // Desktop
                updateElements('vocab-view-detail-desktop'); // Need to ensure IDs match or use class selectors scoped

                // 2. Render List
                const listHTML = items.map(item => `
                    <div class="flex items-start justify-between py-3 px-2 hover:bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-bold text-gray-900 text-base">${item.term}</div>
                            <div class="text-gray-500 text-sm mt-0.5">${item.definition}</div>
                        </div>
                        <button class="w-8 h-8 rounded-full bg-gray-100 text-blue-500 flex items-center justify-center flex-shrink-0" onclick="window.LuminaVocab.playAudio('${item.term}')">
                            <i class="fa-solid fa-volume-high text-xs"></i>
                        </button>
                    </div>
                `).join('');

                document.getElementById('lumina-detail-list').innerHTML = listHTML;
                // Desktop list
                const deskList = document.getElementById('lumina-detail-list-desktop');
                if (deskList) deskList.innerHTML = listHTML;
            }

            showDetailView() {
                // Hide Dashboard, Show Detail
                this.els.dashboardMobile.classList.add('hidden');
                this.els.detailMobile.classList.remove('hidden');

                this.els.dashboardDesktop.classList.add('hidden');
                this.els.detailDesktop.classList.remove('hidden');

                window.scrollTo(0, 0);

                // Push History
                if (!window.location.pathname.includes('/set/')) {
                    history.pushState({ setId: this.currentDetailId }, '', `/learn/vocabulary/set/${this.currentDetailId}`);
                }
            }

            showDashboard() {
                this.els.dashboardMobile.classList.remove('hidden');
                this.els.detailMobile.classList.add('hidden');

                this.els.dashboardDesktop.classList.remove('hidden');
                this.els.detailDesktop.classList.add('hidden');

                history.pushState({}, '', '/learn/vocabulary/dashboard');
                this.state.activeSet = null;
            }

            startLearning(mode) {
                if (!this.state.activeSet) return;
                const url = `/learn/vocabulary/set/${this.state.activeSet.id}/${mode}`;
                window.location.href = url;
            }

            playAudio(text) {
                // Determine language or use default
                const lang = 'en'; // Should detect or store in set?
                // Use a simple TTS API or browser Speech
                const synth = window.speechSynthesis;
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; // Defaulting to English for now
                synth.speak(u);
            }

            // Utils
            renderLoading(el) { el.innerHTML = `<div class="col-span-full py-12 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>`; }
            getEmptyHTML() { return `<div class="col-span-full py-12 text-center text-gray-400">Chưa có bộ thẻ nào.</div>`; }
            renderPagination(data) { /* Simplified for SPA context, maybe hide for now or implement loadMore */ }
            normalizePath(path) { if (!path) return null; path = path.trim().replace(/\\\\/g, '/'); if (path.startsWith('http') || path.startsWith('/')) return path; if (path.startsWith('uploads/')) return '/' + path; return '/static/' + path; }
            renderError(msg) { /* ... */ }
        }

        window.LuminaVocab = new VocabularyDashboard();
        window.LuminaVocab.init();

        // Handle Back Button
        window.onpopstate = function (e) {
            if (e.state && e.state.setId) {
                window.LuminaVocab.loadSetDetail(e.state.setId);
            } else {
                window.LuminaVocab.showDashboard();
            }
        };
    })();
</script>
{% endblock %}