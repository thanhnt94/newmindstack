{# =============================== #}
{# File: mindstack_app/templates/aura_mobile/pages/learning/quiz/individual/session/index.html #}
{# Purpose: Unified Mobile Quiz Session (Stand-alone) #}
{# Based on Aura 4.4 Logic #}
{# =============================== #}

{% set _v = template_version or 'aura_mobile' %}
{% extends _v ~ '/base.html' %}

{% block title %}L√†m b√†i Quiz{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* === CORE LAYOUT === */
    body {
        background-color: #f8fafc;
        font-family: 'Inter', sans-serif;
    }

    /* Hide Default Header/Nav on Mobile */
    @media (max-width: 1023px) {

        body>header,
        nav.navbar,
        footer,
        .site-footer,
        .back-to-top {
            display: none !important;
        }

        body {
            padding-top: 115px !important;
            /* Header + Tabs */
            padding-bottom: 80px;
            /* Bottom Bar */
        }
    }

    /* === UI COMPONENTS === */
    .cm-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }

    .cm-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f5f9;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .cm-card-body {
        padding: 1.25rem;
        flex: 1;
        position: relative;
    }

    .qb-question-text {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.5;
        margin-bottom: 1rem;
    }

    .qb-question-media img {
        width: 100%;
        max-height: 320px;
        object-fit: contain;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        background: white;
        margin-bottom: 1rem;
    }

    .qb-options-grid {
        display: grid;
        gap: 0.75rem;
    }

    .qb-option-label {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.15s ease;
        background: white;
    }

    .qb-option-label:hover {
        border-color: #94a3b8;
        background: #f8fafc;
    }

    .qb-option-label.selected {
        border-color: #3b82f6;
        background: #eff6ff;
        ring: 1px solid #3b82f6;
    }

    .qb-option-label.correct {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .qb-option-label.incorrect {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .qb-option-label.disabled {
        pointer-events: none;
        opacity: 0.7;
    }

    .qb-option-letter-circle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: #f1f5f9;
        color: #1e293b;
        font-weight: 700;
        font-size: 0.9rem;
        border: 1px solid #e2e8f0;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .qb-option-label.selected .qb-option-letter-circle {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .qb-option-label.correct .qb-option-letter-circle {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    .qb-option-label.incorrect .qb-option-letter-circle {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    /* === MOBILE HEADER & TABS === */
    .qb-mobile-sticky-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .qb-mobile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px 4px 16px;
    }

    .qb-mobile-tabs-container {
        padding: 0 16px 10px 16px;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .qb-mobile-tabs {
        display: flex;
        background: #f1f5f9;
        border-radius: 10px;
        padding: 3px;
    }

    .qb-mobile-tab-item {
        flex: 1;
        text-align: center;
        padding: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #64748b;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .qb-mobile-tab-item.active {
        background: white;
        color: #2563eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    /* === BOTTOM BAR === */
    .qb-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 12px 16px;
        border-top: 1px solid #e2e8f0;
        z-index: 60;
        display: flex;
        gap: 10px;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    .cm-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
    }

    .cm-btn-primary {
        background: #2563eb;
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .cm-btn-primary:disabled {
        background: #94a3b8;
        cursor: not-allowed;
    }

    /* === HUB MODAL === */
    .qb-modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .qb-modal-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 101;
        background: white;
        height: 85vh;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
    }

    .qb-modal-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .qb-modal-overlay.open .qb-modal-container {
        transform: translateY(0);
    }

    .qb-hub-header {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .qb-hub-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
    }

    .qb-hub-tab-item {
        flex: 1;
        text-align: center;
        padding: 12px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .qb-hub-tab-item.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
        background: white;
    }

    .qb-hub-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: white;
    }

    .qb-hub-pane {
        display: none;
    }

    .qb-hub-pane.active {
        display: block;
    }

    /* Helper for hidden */
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
{# === MOBILE APP HEADER === #}
<div class="qb-mobile-sticky-wrapper">
    <div class="qb-mobile-header">
        <div class="flex items-center gap-3">
            <div class="flex flex-col">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Ti·∫øn ƒë·ªô</span>
                {# Added js-stat-progress-text hook #}
                <span id="mobile-progress-display"
                    class="text-lg font-black text-slate-800 leading-none js-stat-progress-text">--/--</span>
            </div>
            <div class="h-6 w-px bg-slate-200"></div>
            <div class="flex flex-col">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">ƒê√∫ng</span>
                {# Added js-stat-correct hook (mapped to score for mobile display) #}
                <span id="mobile-score-display"
                    class="text-lg font-black text-emerald-600 leading-none font-mono js-stat-correct">0</span>
            </div>
        </div>

        <div class="flex gap-2">
            <a href="{{ url_for('dashboard.dashboard') }}"
                class="w-9 h-9 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200"
                title="V·ªÅ th∆∞ vi·ªán"><i class="fas fa-arrow-left"></i></a>
            <button id="mobile-exit-btn" onclick="endQuizSession()"
                class="w-9 h-9 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200"><i
                    class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </div>

    {# === MOBILE TABS === #}
    <div class="qb-mobile-tabs-container">
        <div class="qb-mobile-tabs">
            <div class="qb-mobile-tab-item active" data-tab="game">C√¢u h·ªèi</div>
            <div class="qb-mobile-tab-item" data-tab="stats">Th·ªëng k√™</div>
        </div>
    </div>
</div>

<div class="container mx-auto px-2 py-6 max-w-7xl">
    {# --- TAB: GAMEPLAY --- #}
    <div id="tab-pane-game" class="qb-tab-pane active space-y-6">
        <div class="cm-card">
            <div class="cm-card-header">
                {# Added js-question-header hook #}
                <span class="font-bold text-slate-700 flex items-center gap-2"><i
                        class="fa-solid fa-circle-question text-blue-500"></i> <span id="question-header-text"
                        class="js-question-header">C√¢u h·ªèi --</span></span>
            </div>
            <div class="cm-card-body relative">
                <!-- Loading State -->
                {# Added js-quiz-loading hook #}
                <div id="quiz-loading"
                    class="flex flex-col items-center justify-center py-12 text-blue-500 js-quiz-loading">
                    <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                    <p>ƒêang t·∫£i c√¢u h·ªèi...</p>
                </div>

                <!-- Question Content -->
                {# Added js-quiz-content hook #}
                <div id="quiz-content" class="hidden js-quiz-content">
                    {# Added js-question-text hook #}
                    <h2 id="question-text" class="qb-question-text js-question-text">--</h2>
                    {# Added js-question-media hook #}
                    <div id="question-media" class="qb-question-media hidden js-question-media"></div>

                    {# Added js-options-grid hook #}
                    <div id="question-options" class="qb-options-grid mt-4 js-options-grid">
                        <!-- Options injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback / Result Panel -->
        {# Added js-result-panel hook #}
        <div id="result-panel" class="cm-card border-l-4 border-l-blue-500 hidden js-result-panel">
            <div class="cm-card-body">
                <div class="flex items-start gap-4">
                    {# Added js-feedback-icon hook #}
                    <div id="feedback-icon" class="text-3xl js-feedback-icon">üí°</div>
                    <div class="flex-1">
                        {# Added js-feedback-title hook #}
                        <h3 id="feedback-title" class="text-lg font-bold text-slate-900 js-feedback-title">K·∫øt qu·∫£</h3>
                        <div class="flex gap-4 text-sm mt-2">
                            <div class="bg-slate-50 px-3 py-2 rounded border border-slate-100">
                                <span class="block text-xs text-slate-400 uppercase">ƒê√°p √°n ƒë√∫ng</span>
                                {# Added js-feedback-answer hook #}
                                <span id="feedback-correct-answer"
                                    class="font-bold text-emerald-600 js-feedback-answer">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# --- TAB: STATS --- #}
    <div id="tab-pane-stats" class="qb-tab-pane hidden space-y-6">
        <div class="cm-card">
            <div class="cm-card-header">
                <span class="font-bold text-emerald-600"><i class="fa-solid fa-chart-pie"></i> Th·ªëng k√™ phi√™n</span>
            </div>
            <div class="cm-card-body">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <div class="text-xs text-slate-500 uppercase">ƒê√£ l√†m</div>
                        {# Added js-stat-total hook #}
                        <div id="stat-total" class="text-2xl font-bold text-slate-800 js-stat-total">0</div>
                    </div>
                    <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                        <div class="text-xs text-emerald-600 uppercase">Ch√≠nh x√°c</div>
                        {# Added js-stat-accuracy hook #}
                        <div id="stat-accuracy" class="text-2xl font-bold text-emerald-700 js-stat-accuracy">0%</div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-slate-500 mb-1">
                        <span>Ti·∫øn ƒë·ªô</span>
                        {# Added js-stat-progress-text hook #}
                        <span id="stat-progress-text" class="js-stat-progress-text">0/0</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2.5">
                        {# Added js-stat-progress-bar hook #}
                        <div id="stat-progress-bar" class="bg-blue-600 h-2.5 rounded-full js-stat-progress-bar"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# === MOBILE BOTTOM BAR === #}
<div class="qb-bottom-bar">
    <button type="button" id="open-hub-btn"
        class="qb-mobile-chat-toggle bg-indigo-50 text-indigo-600 border-indigo-200 hidden" aria-label="M·ªü chi ti·∫øt"><i
            class="fa-solid fa-lightbulb text-xl"></i></button>

    <button type="button" id="mobile-action-btn" class="cm-btn cm-btn-primary w-full shadow-lg" disabled>
        <i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n
    </button>
</div>

{# === HUB MODAL (Explanation, AI, Notes) === #}
<div id="explanation-hub-modal" class="qb-modal-overlay">
    <div class="qb-modal-container">
        <div class="qb-hub-header">
            <h3 class="font-bold text-slate-800 text-lg">Chi ti·∫øt & H·ªçc t·∫≠p</h3>
            <button id="close-hub-btn"
                class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="qb-hub-tabs">
            <div class="qb-hub-tab-item active" data-target="hub-expl">üìñ Gi·∫£i th√≠ch</div>
            <div class="qb-hub-tab-item" data-target="hub-ai">ü§ñ AI Coach</div>
            <div class="qb-hub-tab-item" data-target="hub-note">üìù Ghi ch√∫</div>
        </div>
        <div class="qb-hub-content">
            <!-- Expl Tab -->
            <div id="hub-expl" class="qb-hub-pane active">
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-slate-700 leading-relaxed">
                    <h4 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-circle-info"></i> Gi·∫£i th√≠ch:</h4>
                    <div id="hub-explanation-text">Ch∆∞a c√≥ gi·∫£i th√≠ch.</div>
                </div>
            </div>
            <!-- AI Tab -->
            <div id="hub-ai" class="qb-hub-pane">
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-indigo-700 font-bold"><i class="fa-solid fa-robot"></i>
                            <span>AI Ph√¢n T√≠ch</span></div>
                        <button id="ai-generate-btn"
                            class="text-xs bg-white text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-200 font-semibold shadow-sm"><i
                                class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o m·ªõi</button>
                    </div>
                    <div id="hub-ai-content" class="text-sm text-slate-700 leading-relaxed min-h-[100px] markdown-body">
                        Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...</div>
                </div>
            </div>
            <!-- Note Tab -->
            <div id="hub-note" class="qb-hub-pane">
                <textarea id="hub-note-input"
                    class="w-full p-3 rounded-xl border border-slate-200 text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition"
                    rows="8" placeholder="Ghi ch√∫ c·ªßa b·∫°n..."></textarea>
                <button id="hub-note-save"
                    class="mt-2 w-full py-2 rounded-lg bg-blue-100 text-blue-700 font-semibold text-sm hover:bg-blue-200">L∆∞u
                    ghi ch√∫</button>
            </div>
        </div>
    </div>
</div>

<!-- Exit Confirmation Modal (Reused) -->
<div id="exit-confirm-modal"
    class="fixed inset-0 bg-slate-900/40 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300"
    style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform scale-95 transition-transform duration-300"
        id="exit-modal-panel">
        <div class="text-center">
            <div
                class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl ring-4 ring-rose-50">
                <i class="fa-solid fa-right-from-bracket"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">K·∫øt th√∫c phi√™n h·ªçc?</h3>
            <p class="text-slate-500 text-sm mb-6 leading-relaxed">K·∫øt qu·∫£ hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠.</p>
            <div class="flex gap-3">
                <button onclick="closeExitModal()"
                    class="flex-1 py-2.5 rounded-xl font-bold text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 transition-colors">·ªû
                    l·∫°i</button>
                <button onclick="confirmExit()"
                    class="flex-1 py-2.5 rounded-xl font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-lg shadow-rose-500/30 transition-all">K·∫øt
                    th√∫c</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function () {
        // URLs & Meta
        const getQuestionBatchUrl = "{{ url_for('learning.quiz_learning.get_question_batch') }}";
        const submitAnswerBatchUrl = "{{ url_for('learning.quiz_learning.submit_answer_batch') }}";
        const endSessionUrl = "{{ url_for('learning.quiz_learning.end_session') }}";
        const getAiResponseUrl = "{{ url_for('ai_services.get_ai_response') }}";
        const saveNoteUrlTemplate = "{{ url_for('notes.save_note', item_id=0) }}";
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        const SESSION_KEY = 'quiz_session_single_state_mobile';

        // Modal Logic
        const exitModal = document.getElementById('exit-confirm-modal');
        const exitPanel = document.getElementById('exit-modal-panel');

        window.endQuizSession = function () {
            if (exitModal) {
                exitModal.style.display = 'flex';
                setTimeout(() => {
                    exitModal.classList.remove('opacity-0', 'hidden');
                    exitPanel.classList.remove('scale-95');
                    exitPanel.classList.add('scale-100');
                }, 10);
            }
        };

        window.closeExitModal = function () {
            if (exitModal) {
                exitModal.classList.add('opacity-0');
                exitPanel.classList.remove('scale-100');
                exitPanel.classList.add('scale-95');
                setTimeout(() => {
                    exitModal.classList.add('hidden');
                    exitModal.style.display = 'none';
                }, 300);
            }
        };

        window.confirmExit = function () {
            const btn = document.querySelector('button[onclick="confirmExit()"]');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> X·ª≠ l√Ω...';
                btn.disabled = true;
            }

            fetch(endSessionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.session_id) {
                        window.location.href = `/learn/session/${data.session_id}/summary`;
                    } else {
                        window.location.href = "{{ url_for('learning.manage_sessions') }}";
                    }
                })
                .catch(err => {
                    alert("L·ªói k·∫øt n·ªëi.");
                    if (btn) { btn.innerHTML = 'K·∫øt th√∫c'; btn.disabled = false; }
                });
        };

        // State
        let currentBatch = [];
        let currentIndex = 0;
        let userAnswers = {};
        let sessionStats = { total: 0, correct: 0, total_questions: 0 };
        let currentQuestion = null;
        let lastAnswerResult = null;
        let startTime = 0;

        // Helper: Update text/html for matching hooks
        const setText = (selector, text) => document.querySelectorAll(selector).forEach(el => el.textContent = text);
        const setHtml = (selector, html) => document.querySelectorAll(selector).forEach(el => el.innerHTML = html);
        const toggleClass = (selector, cls, force) => document.querySelectorAll(selector).forEach(el => el.classList.toggle(cls, force));

        // Elements
        const dom = {
            loading: document.getElementById('quiz-loading'),
            content: document.getElementById('quiz-content'),
            mobileActionBtn: document.getElementById('mobile-action-btn'),
            // Hub
            hubModal: document.getElementById('explanation-hub-modal'),
            openHubBtn: document.getElementById('open-hub-btn'),
            closeHubBtn: document.getElementById('close-hub-btn'),
            hubExplText: document.getElementById('hub-explanation-text'),
            hubAiContent: document.getElementById('hub-ai-content'),
            aiGenerateBtn: document.getElementById('ai-generate-btn'),
            hubNoteInput: document.getElementById('hub-note-input'),
            hubNoteSave: document.getElementById('hub-note-save'),
        };

        function saveState() {
            const state = { currentBatch, currentIndex, userAnswers, sessionStats, lastAnswerResult };
            sessionStorage.setItem(SESSION_KEY, JSON.stringify(state));
        }

        function loadState() {
            const savedState = sessionStorage.getItem(SESSION_KEY);
            if (!savedState) return false;
            try {
                const state = JSON.parse(savedState);
                currentBatch = state.currentBatch || [];
                currentIndex = state.currentIndex || 0;
                userAnswers = state.userAnswers || {};
                sessionStats = state.sessionStats || { total: 0, correct: 0, total_questions: 0 };
                lastAnswerResult = state.lastAnswerResult || null;

                if (currentBatch.length === 0 || currentIndex >= currentBatch.length) return false;

                currentQuestion = currentBatch[currentIndex];
                showLoading(false);
                renderQuestion(currentQuestion);
                updateStatsUI();

                if (lastAnswerResult && lastAnswerResult.item_id === currentQuestion.item_id) {
                    showFeedback(lastAnswerResult);
                    updateActionButtons(false, '<i class="fa-solid fa-arrow-right"></i> Ti·∫øp theo', 'next');
                } else if (userAnswers[currentQuestion.item_id]) {
                    selectOption(userAnswers[currentQuestion.item_id]);
                }
                return true;
            } catch (e) { return false; }
        }

        async function loadFreshBatch() {
            showLoading(true);
            try {
                const res = await fetch(getQuestionBatchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!res.ok) {
                    if (res.status === 404) return finishSession();
                    throw new Error('Load failed');
                }
                const data = await res.json();
                currentBatch = data.items || [];
                currentIndex = 0;
                userAnswers = {};
                lastAnswerResult = null;
                sessionStats.total_questions = data.total_question_groups_in_session || data.total_items_in_session || 0;

                if (currentBatch.length > 0) {
                    renderQuestion(currentBatch[currentIndex]);
                    updateStatsUI();
                    saveState();
                } else {
                    finishSession();
                }
            } catch (e) {
                alert('L·ªói t·∫£i c√¢u h·ªèi.');
            } finally {
                showLoading(false);
            }
        }

        function renderQuestion(q) {
            currentQuestion = q;
            const qNum = (sessionStats.total + currentIndex + 1);
            setText('.js-question-header', `C√¢u h·ªèi ${qNum}`);
            setHtml('.js-question-text', q.content.question);

            // Media
            const mediaContainer = document.querySelectorAll('.js-question-media');
            let mediaHtml = '';
            if (q.content.question_image_file) {
                mediaHtml += `<img src="${q.content.question_image_file}" alt="Question Image">`;
            }
            mediaContainer.forEach(el => {
                if (mediaHtml) { el.innerHTML = mediaHtml; el.classList.remove('hidden'); }
                else { el.innerHTML = ''; el.classList.add('hidden'); }
            });

            // Options
            const grid = document.querySelector('.js-options-grid');
            if (grid) {
                grid.innerHTML = Object.entries(q.content.options || {}).map(([key, val]) => `
                    <div class="qb-option-label" data-key="${key}">
                        <span class="qb-option-letter-circle">${key}</span>
                        <span class="text-slate-800 font-medium text-lg leading-tight mt-1">${val}</span>
                    </div>
                `).join('');
                grid.querySelectorAll('.qb-option-label').forEach(el => el.addEventListener('click', () => selectOption(el.dataset.key)));
            }

            // Reset UI
            toggleClass('.js-result-panel', 'hidden', true);
            if (dom.openHubBtn) dom.openHubBtn.classList.add('hidden');

            updateActionButtons(true, '<i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n', 'submit', true);

            // Reset Hub
            setText('#hub-explanation-text', "Ch∆∞a c√≥ gi·∫£i th√≠ch.");
            setText('#hub-ai-content', "Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...");
            if (dom.hubNoteInput) dom.hubNoteInput.value = q.note_content || "";
            if (dom.aiGenerateBtn) dom.aiGenerateBtn.disabled = false;

            startTime = Date.now();
        }

        function selectOption(key) {
            if (lastAnswerResult && lastAnswerResult.item_id === currentQuestion.item_id) return;
            document.querySelectorAll('.qb-option-label').forEach(el => {
                el.classList.toggle('selected', el.dataset.key === key);
            });
            userAnswers[currentQuestion.item_id] = key;
            updateActionButtons(false, null, null, true);
            saveState();
        }

        async function submitAnswer() {
            const itemId = currentQuestion.item_id;
            const answer = userAnswers[itemId];
            if (!answer) return;

            updateActionButtons(true, '<i class="fas fa-circle-notch fa-spin"></i> ƒêang g·ª≠i...');
            const duration_ms = Date.now() - startTime;

            try {
                const res = await fetch(submitAnswerBatchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ answers: [{ item_id: itemId, user_answer: answer, duration_ms: duration_ms }] })
                });
                const data = await res.json();
                lastAnswerResult = data.results[0];

                sessionStats.total++;
                if (lastAnswerResult.is_correct) sessionStats.correct++;
                updateStatsUI();

                showFeedback(lastAnswerResult);
                updateActionButtons(false, '<i class="fa-solid fa-arrow-right"></i> Ti·∫øp theo', 'next', false);
                if (dom.openHubBtn) dom.openHubBtn.classList.remove('hidden');

                saveState();
            } catch (e) {
                alert('L·ªói g·ª≠i ƒë√°p √°n.');
                updateActionButtons(false);
            }
        }

        function showFeedback(result) {
            document.querySelectorAll('.qb-option-label').forEach(el => {
                el.classList.add('disabled');
                el.classList.remove('selected');
                if (el.dataset.key === result.correct_answer) el.classList.add('correct');
                if (el.dataset.key === userAnswers[result.item_id] && !result.is_correct) el.classList.add('incorrect');
            });

            toggleClass('.js-result-panel', 'hidden', false);

            if (result.is_correct) {
                setText('.js-feedback-icon', 'üéâ');
                setText('.js-feedback-title', 'Ch√≠nh x√°c!');
                document.querySelectorAll('.js-feedback-title').forEach(el => el.classList.replace('text-rose-600', 'text-emerald-600'));
            } else {
                setText('.js-feedback-icon', 'ü§î');
                setText('.js-feedback-title', 'Sai r·ªìi');
                document.querySelectorAll('.js-feedback-title').forEach(el => el.classList.replace('text-emerald-600', 'text-rose-600'));
            }
            setText('.js-feedback-answer', result.correct_answer);

            if (result.explanation) dom.hubExplText.innerHTML = result.explanation;
            if (currentQuestion.ai_explanation) dom.hubAiContent.innerHTML = currentQuestion.ai_explanation;
        }

        function nextQuestion() {
            lastAnswerResult = null;
            currentIndex++;
            if (currentIndex < currentBatch.length) {
                renderQuestion(currentBatch[currentIndex]);
                saveState();
                // Reset tabs to question
                document.querySelectorAll('.qb-mobile-tab-item[data-tab="game"]').forEach(el => el.click());
            } else {
                loadFreshBatch();
            }
        }

        function finishSession() {
            sessionStorage.removeItem(SESSION_KEY);
            alert('ƒê√£ ho√†n th√†nh phi√™n h·ªçc!');
            window.location.href = "{{ url_for('learning.quiz_learning.dashboard') }}";
        }

        function showLoading(show) {
            toggleClass('.js-quiz-loading', 'hidden', !show);
            toggleClass('.js-quiz-content', 'hidden', show);
        }

        function updateActionButtons(disabled, text, action, primary) {
            const btn = dom.mobileActionBtn;
            if (!btn) return;
            if (disabled !== undefined) btn.disabled = disabled;
            if (text) btn.innerHTML = text;
            if (action) btn.dataset.action = action;
            if (primary !== undefined) {
                // logic for primary style if needed, currently CSS handles it
            }
        }

        function updateStatsUI() {
            setText('.js-stat-total', sessionStats.total);
            setText('.js-stat-correct', sessionStats.correct);
            const acc = sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0;
            setText('.js-stat-accuracy', `${acc}%`);
            setText('.js-stat-progress-text', `${sessionStats.total}/${sessionStats.total_questions}`);
            document.querySelectorAll('.js-stat-progress-bar').forEach(el => el.style.width = `${(sessionStats.total / (sessionStats.total_questions || 1)) * 100}%`);
        }

        // --- Event Listeners ---
        dom.mobileActionBtn.addEventListener('click', () => {
            if (dom.mobileActionBtn.dataset.action === 'submit') submitAnswer();
            else nextQuestion();
        });

        // Tabs
        document.querySelectorAll('.qb-mobile-tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.qb-mobile-tab-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.qb-tab-pane').forEach(p => p.classList.add('hidden'));

                tab.classList.add('active');
                document.getElementById(`tab-pane-${tab.dataset.tab}`).classList.remove('hidden');
            });
        });

        // Hub
        if (dom.openHubBtn) dom.openHubBtn.addEventListener('click', () => dom.hubModal.classList.add('open'));
        if (dom.closeHubBtn) dom.closeHubBtn.addEventListener('click', () => dom.hubModal.classList.remove('open'));

        // Hub Tabs
        document.querySelectorAll('.qb-hub-tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.qb-hub-tab-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.qb-hub-pane').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.add('active');
            });
        });

        // AI & Note API Calls
        // (Simplified for brevity, similar to Aura)
        dom.aiGenerateBtn.addEventListener('click', async () => {
            dom.aiGenerateBtn.disabled = true;
            dom.hubAiContent.textContent = "ƒêang t·∫°o...";
            try {
                const res = await fetch(getAiResponseUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ item_id: currentQuestion.item_id, prompt_type: 'explanation' }) });
                const data = await res.json();
                const content = data.html_content || data.response;
                dom.hubAiContent.innerHTML = content;
                currentQuestion.ai_explanation = content;
            } catch (e) { dom.hubAiContent.textContent = "L·ªói khi g·ªçi AI."; }
            dom.aiGenerateBtn.disabled = false;
        });

        dom.hubNoteSave.addEventListener('click', async () => {
            try {
                await fetch(saveNoteUrlTemplate.replace('0', currentQuestion.item_id), { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ content: dom.hubNoteInput.value }) });
                currentQuestion.note_content = dom.hubNoteInput.value;
                alert('ƒê√£ l∆∞u.');
            } catch (e) { alert('L·ªói l∆∞u.'); }
        });

        // Check Previous State
        if (!loadState()) {
            loadFreshBatch();
        }
    })();
</script>
{% endblock %}