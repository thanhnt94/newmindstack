{# File: quiz/individual/setup/_quiz_custom_options.html #}
{# Adapted from vocabulary/mcq/setup/_options_list.html #}
{# Custom Quiz Options Setup - Pair Builder #}

<div class="mcq-step-container">
    {# Header #}
    <div class="step-header-left">
        <a href="javascript:void(0)" class="step-back-btn js-back-to-modes" onclick="history.back()">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="step-header-content">
            <div class="step-breadcrumb-left">
                <span>HỌC TẬP</span>
                <i class="fas fa-chevron-right"></i>
                <span>TRẮC NGHIỆM</span>
                <i class="fas fa-chevron-right"></i>
                <span class="active">CẤU HÌNH</span>
            </div>
            <h1 class="step-header-title">Thiết lập câu hỏi</h1>
        </div>
    </div>

    {# Selected Set Display #}
    <div class="step-set-display">
        <span class="step-set-label">Bộ đã chọn:</span>
        <span class="step-set-chip">
            <i class="fas fa-layer-group"></i>
            {{ container.title if container else 'Chưa chọn' }}
        </span>
    </div>

    {# Main Content #}
    <div class="step-content">
        <div class="pair-builder-section">
            <div class="pair-builder-header">
                <div class="pair-builder-title">
                    <i class="fas fa-random"></i>
                    <span>Cấu hình các cặp câu hỏi</span>
                </div>
                <p class="pair-builder-desc">Thêm các cặp "Câu hỏi → Đáp án" từ các cột dữ liệu. Hệ thống sẽ trộn ngẫu
                    nhiên tất cả các cặp.</p>
            </div>

            {# Pairs List - Default pair rendered server-side #}
            <div id="pairs-list" class="pairs-list">
                <div class="pair-row" data-index="0">
                    <span class="pair-number">1</span>
                    <div class="pair-selects">
                        {# Assuming available_columns is passed #}
                        <select class="pair-select pair-q">
                            {% for col in available_columns %}
                            <option value="{{ col }}" {% if col=='memrise_prompt' or (col=='front' and 'memrise_prompt'
                                not in available_columns) %}selected{% endif %}>{{ col }}</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-arrow-right pair-arrow"></i>
                        <select class="pair-select pair-a">
                            {% for col in available_columns %}
                            <option value="{{ col }}" {% if col=='memrise_answers' or (col=='back' and 'memrise_answers'
                                not in available_columns) %}selected{% endif %}>{{ col }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="pair-delete-btn" title="Xóa" onclick="mcqDeletePair(this)" disabled>
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Bottom Bar #}
    <div class="step-bottom-bar">
        {# Question Count Selector #}
        <div class="bottom-count-row">
            <label class="bottom-count-label">Số câu:</label>
            <select id="mcq-question-count" class="bottom-count-select">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="30">30</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            {# Answer count removed/hidden as session logic handles options logic (default 4) or we can pass it if
            supported #}
        </div>
        <div class="bottom-buttons-row">
            <button type="button" id="add-pair-btn" class="add-pair-btn" onclick="mcqAddPair()">
                <i class="fas fa-plus"></i>
            </button>
            <button type="button" class="step-continue-btn js-mcq-continue" onclick="mcqStart()">
                <span>Bắt đầu</span>
                <i class="fas fa-play"></i>
            </button>
        </div>
    </div>
</div>

<style>
    /* Inline CSS from Original Template - Keeping for consistency */
    .mcq-step-container {
        min-height: 100%;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
    }

    .step-content {
        flex: 1;
        padding: 1rem;
        padding-bottom: 100px;
        overflow-y: auto;
    }

    .pair-builder-section {
        background: white;
        border-radius: 1rem;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .pair-builder-header {
        margin-bottom: 1rem;
    }

    .pair-builder-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }

    .pair-builder-title i {
        color: #8b5cf6;
    }

    .pair-builder-desc {
        font-size: 0.8rem;
        color: #64748b;
        margin: 0;
        line-height: 1.4;
    }

    .pairs-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .pair-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
    }

    .pair-number {
        width: 24px;
        height: 24px;
        background: #8b5cf6;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 700;
        flex-shrink: 0;
    }

    .pair-selects {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 0;
        overflow: hidden;
    }

    .pair-select {
        flex: 1;
        min-width: 0;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: #334155;
        background: white;
        cursor: pointer;
        text-overflow: ellipsis;
    }

    .pair-select:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .pair-arrow {
        color: #94a3b8;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .pair-delete-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: #94a3b8;
        cursor: pointer;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .pair-delete-btn:hover:not(:disabled) {
        background: #fee2e2;
        color: #ef4444;
    }

    .pair-delete-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .add-pair-btn {
        width: 48px;
        height: 48px;
        border: 2px solid #c4b5fd;
        background: #faf5ff;
        color: #8b5cf6;
        border-radius: 1rem;
        font-size: 1.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .add-pair-btn:hover {
        background: #ede9fe;
        border-color: #8b5cf6;
    }

    .step-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0));
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.06);
        z-index: 50;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .bottom-count-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .bottom-count-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
    }

    .bottom-count-select {
        padding: 0.375rem 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: #334155;
        background: #f8fafc;
        cursor: pointer;
    }

    .bottom-buttons-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .step-continue-btn {
        flex: 1;
        padding: 1rem;
        border-radius: 1rem;
        font-size: 1rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        transition: all 0.2s;
    }

    .step-continue-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }

    .step-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-back-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #f1f5f9;
        color: #64748b;
        transition: all 0.2s;
    }

    .step-back-btn:hover {
        background: #e2e8f0;
        color: #334155;
    }

    .step-breadcrumb-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #94a3b8;
        margin-bottom: 0.25rem;
    }

    .step-breadcrumb-left i {
        font-size: 0.6rem;
    }

    .step-breadcrumb-left span.active {
        color: #8b5cf6;
    }

    .step-header-title {
        font-size: 1.125rem;
        font-weight: 800;
        color: #1e293b;
        margin: 0;
    }

    .step-set-display {
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .step-set-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #64748b;
    }

    .step-set-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: #334155;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .step-set-chip i {
        color: #8b5cf6;
        font-size: 0.75rem;
    }
</style>

<script>
    // Global MCQ Setup Functions
    var mcqSetId = '{{ container.container_id }}';
    var mcqCols = [];
    {% for col in available_columns %}
    mcqCols.push('{{ col }}');
    {% endfor %}
    if (mcqCols.length === 0) mcqCols = ['front', 'back'];

    var mcqDefQ = mcqCols.indexOf('memrise_prompt') >= 0 ? 'memrise_prompt' : (mcqCols.indexOf('front') >= 0 ? 'front' : mcqCols[0]);
    var mcqDefA = mcqCols.indexOf('memrise_answers') >= 0 ? 'memrise_answers' : (mcqCols.indexOf('back') >= 0 ? 'back' : mcqCols[1] || mcqCols[0]);

    function mcqMakeRow(idx) {
        var div = document.createElement('div');
        div.className = 'pair-row';
        var optsQ = '', optsA = '';
        for (var i = 0; i < mcqCols.length; i++) {
            optsQ += '<option value="' + mcqCols[i] + '"' + (mcqCols[i] === mcqDefQ ? ' selected' : '') + '>' + mcqCols[i] + '</option>';
            optsA += '<option value="' + mcqCols[i] + '"' + (mcqCols[i] === mcqDefA ? ' selected' : '') + '>' + mcqCols[i] + '</option>';
        }
        div.innerHTML = '<span class="pair-number">' + (idx + 1) + '</span>' +
            '<div class="pair-selects"><select class="pair-select pair-q">' + optsQ + '</select>' +
            '<i class="fas fa-arrow-right pair-arrow"></i>' +
            '<select class="pair-select pair-a">' + optsA + '</select></div>' +
            '<button type="button" class="pair-delete-btn" title="Xóa" onclick="mcqDeletePair(this)"><i class="fas fa-trash-alt"></i></button>';
        return div;
    }

    function mcqRenum() {
        var list = document.getElementById('pairs-list');
        if (!list) return;
        var rows = list.querySelectorAll('.pair-row');
        for (var i = 0; i < rows.length; i++) {
            rows[i].querySelector('.pair-number').textContent = i + 1;
            rows[i].querySelector('.pair-delete-btn').disabled = (rows.length <= 1);
        }
    }

    function mcqAddPair() {
        var list = document.getElementById('pairs-list');
        if (list) {
            list.appendChild(mcqMakeRow(list.children.length));
            mcqRenum();
        }
    }

    function mcqDeletePair(btn) {
        var list = document.getElementById('pairs-list');
        if (list && list.children.length > 1) {
            btn.closest('.pair-row').remove();
            mcqRenum();
        }
    }

    function mcqStart() {
        var list = document.getElementById('pairs-list');
        if (!list) return;
        var pairs = [];
        var rows = list.querySelectorAll('.pair-row');
        for (var i = 0; i < rows.length; i++) {
            pairs.push({ q: rows[i].querySelector('.pair-q').value, a: rows[i].querySelector('.pair-a').value });
        }
        if (pairs.length === 0) { alert('Thêm ít nhất 1 cặp!'); return; }
        var count = document.getElementById('mcq-question-count').value || 10;

        // Use updated route
        var url = "{{ url_for('learning.quiz_learning.start_quiz_session_by_id', set_id=container.container_id, mode='custom') }}";
        url += "?batch_size=" + count + "&custom_pairs=" + encodeURIComponent(JSON.stringify(pairs));

        window.location.href = url;
    }
</script>
