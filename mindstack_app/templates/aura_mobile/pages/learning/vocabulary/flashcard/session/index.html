{#
# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html
# Phiên bản: 74.0
# ĐÃ SỬA: Đưa các biến Jinja ra ngoài object window.FlashcardConfig để tránh formatter làm hỏng syntax (insert space vào
{{ }}).
#}

{% set _v = template_version %}
{% extends _v ~ '/base.html' %}

{% block title %}Học Flashcard{% endblock %}

{# CRITICAL: Add flashcard-session-active class to body to hide header/footer on mobile #}
{% block body_class %} flashcard-session-active{% endblock %}

{% block head %}
{{ super() }}
{# Header/Footer hiding and padding removal is now handled globally via CSS in _global_styles.html
using the .flashcard-session-active class on the body #}

{# Flashcard Session CSS - External Files stored in template directory #}
{# ... imports ... #}
<link rel="stylesheet" href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/core.css') }}">
<link rel="stylesheet"
    href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/session.css') }}">
<link rel="stylesheet" href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/card.css') }}">
<link rel="stylesheet"
    href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/components.css') }}">

{% include _v ~ '/includes/assets/_markdown_assets.html' %}
{% endblock %}

{% block content %}
{# Mobile view only #}
{# Mobile Interface #}
<div class="flashcard-mobile-view">
    <div class="page-shell">
        <!-- Header - Stats Bar -->
        <!-- Header - Quiz Style Structure -->
        {# Import Shared Header #}
        {% from 'aura_mobile/includes/components/learning_header.html' import render_learning_header %}

        {% call render_learning_header(
        title_selector='js-fc-title',
        badge_text='FLASHCARD',
        badge_icon='fas fa-clone',
        theme_gradient='bg-gradient-to-r from-emerald-500 to-green-600',
        badge_text_color='text-emerald-100',
        badge_icon_color='text-emerald-200',
        show_progress_line=True,
        progress_selector='js-fc-progress-fill',
        progress_color='bg-emerald-500',
        exit_func='showExitModal()',
        show_score=True,
        score_selector='js-fc-score',
        score_value="{:,}".format(current_user.total_score if current_user.total_score is not none else 0)
        ) %}
        {# Left: Score & Stats #}
        <div id="fc-mobile-stats-pills"
            class="flex items-center gap-3 overflow-x-auto no-scrollbar mask-gradient-right flex-1 mr-2 transition-all duration-300">
            {# Total Score #}
            <div
                class="flex items-center gap-1.5 px-2.5 py-1 bg-amber-50 rounded-full border border-amber-100 flex-shrink-0">
                <i class="fa-solid fa-gem text-amber-500 text-xs shadow-amber-glow"></i>
                <span class="text-xs font-black text-amber-600 font-mono tracking-tight js-fc-score">{{
                    "{:,}".format(current_user.total_score if current_user.total_score is not none else 0) }}</span>
            </div>

            {# Divider #}
            <div class="w-px h-4 bg-slate-200 flex-shrink-0"></div>

            {# Progress #}
            <div
                class="stat-pill relative flex-shrink-0 flex items-center gap-1.5 bg-slate-50 px-2 py-0.5 rounded-lg overflow-hidden border border-slate-100">
                <div class="absolute inset-y-0 left-0 bg-emerald-100/50 transition-all duration-300 js-fc-progress-pill-fill"
                    style="width: 0%"></div>
                <i class="fa-solid fa-bars-progress text-slate-400 text-[10px] relative z-10"></i>
                <span class="text-xs font-bold text-slate-600 js-fc-progress-text relative z-10">0/0</span>
            </div>

            {# Standard Session Stats #}
            <div class="flex items-center gap-1.5 flex-shrink-0">
                <i class="fa-solid fa-check text-emerald-500 text-[10px]"></i>
                <span class="text-xs font-bold text-emerald-600 js-fc-session-correct">0</span>
            </div>
            <div class="flex items-center gap-1.5 flex-shrink-0">
                <span class="text-xs font-bold text-amber-500 font-mono js-fc-session-score">+0</span>
            </div>

            {# Card State Badge #}
            <div
                class="stat-pill flex-shrink-0 js-fc-state-badge fc-state-badge state-new hidden px-2 py-0.5 text-[10px] rounded bg-slate-100 text-slate-500 font-bold">
                <span class="js-fc-state-text">NEW</span>
            </div>
        </div>

        {# Right: Tools #}
        <div class="flex items-center gap-2 flex-shrink-0 pl-2 border-l border-slate-100" id="fc-mobile-actions">

            {# Audio Button #}
            <button
                class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100 transition-colors js-fc-audio-btn">
                <i class="fas fa-volume-up text-[10px]"></i>
            </button>

            {# Settings Button #}
            <div class="relative inline-block">
                <button
                    class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition-colors js-fc-settings-toggle">
                    <i class="fas fa-cog text-[10px]"></i>
                </button>
                <div class="fc-settings-menu js-fc-settings-menu z-50 bg-white shadow-xl rounded-xl border border-slate-100 p-2 min-w-[180px]"
                    style="right: 0; top: 110%; display: none;">
                    <button
                        class="fc-settings-item js-fc-image-toggle w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 flex items-center gap-2">
                        <i class="fas fa-image text-slate-400 js-fc-image-icon w-5 text-center"></i>
                        <span class="js-fc-image-text">Hiện ảnh</span>
                    </button>
                    <button
                        class="fc-settings-item js-fc-autoplay-toggle w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 flex items-center gap-2">
                        <i class="fas fa-play text-slate-400 js-fc-autoplay-icon w-5 text-center"></i>
                        <span class="js-fc-autoplay-text">Tự động phát</span>
                    </button>
                    <hr class="my-1 border-slate-100">
                    <button
                        class="fc-settings-item open-feedback-modal-btn js-fc-feedback-btn w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 flex items-center gap-2">
                        <i class="fas fa-flag text-red-400 w-5 text-center"></i>
                        <span>Báo lỗi thẻ</span>
                    </button>
                    <button
                        class="fc-settings-item edit-card-btn js-fc-edit-btn w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 flex items-center gap-2">
                        <i class="fas fa-pencil-alt text-blue-400 w-5 text-center"></i>
                        <span>Sửa thẻ</span>
                    </button>
                </div>
            </div>


        </div>
        {% endcall %}


        {# === NEW: Dynamic Card Info Bar === #}
        <div id="fc-card-info-bar"
            class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200 px-3 py-2 overflow-x-auto no-scrollbar">
            <div class="flex items-center gap-2 text-[10px] whitespace-nowrap min-w-max">
                {# Card Status #}
                <div
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-bold js-card-status-pill">
                    <i class="fas fa-layer-group"></i>
                    <span class="js-card-status-text">MỚI</span>
                </div>

                {# Times Reviewed #}
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-200 text-slate-600">
                    <i class="fas fa-redo"></i>
                    <span><span class="font-bold js-card-times-reviewed">0</span> lần</span>
                </div>

                {# Streak #}
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-100 text-amber-700">
                    <i class="fas fa-fire"></i>
                    <span>Chuỗi: <span class="font-bold js-card-streak">0</span></span>
                </div>

                {# Stability #}
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">
                    <i class="fas fa-shield-alt"></i>
                    <span>Ổn định: <span class="font-bold js-card-stability">0</span> ngày</span>
                </div>

                {# Retrievability #}
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-purple-100 text-purple-700">
                    <i class="fas fa-brain"></i>
                    <span>Nhớ: <span class="font-bold js-card-retrievability">0</span>%</span>
                </div>

                {# Rating Distribution Mini (optional visual) #}
                <div
                    class="inline-flex items-center gap-0.5 px-2 py-1 rounded-full bg-white border border-slate-200 shadow-inner">
                    <span class="w-2 h-2 rounded-full bg-rose-500 js-rating-dot-1"></span>
                    <span class="w-2 h-2 rounded-full bg-amber-500 js-rating-dot-2"></span>
                    <span class="w-2 h-2 rounded-full bg-emerald-500 js-rating-dot-3"></span>
                    <span class="w-2 h-2 rounded-full bg-blue-500 js-rating-dot-4"></span>
                </div>
            </div>
        </div>

        <div class="session-layout">
            <div class="flashcard-wrapper">
                <div class="card-surface">
                    <div class="flashcard-panel">
                        <div class="js-flashcard-content">
                            <div
                                class="flex flex-col items-center justify-center h-full text-emerald-500 min-h-[300px]">
                                <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                                <p>Đang tải thẻ...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Exit Confirmation Modal (Added for Header Exit Button) -->
    <div id="exit-confirm-modal"
        class="fixed inset-0 bg-slate-900/40 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300"
        style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform scale-95 transition-transform duration-300"
            id="exit-modal-panel">
            <div class="text-center">
                <div
                    class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl ring-4 ring-rose-50">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Kết thúc phiên học?</h3>
                <p class="text-slate-500 text-sm mb-6 leading-relaxed">Kết quả hiện tại sẽ được lưu vào lịch sử.</p>
                <div class="flex gap-3">
                    <button onclick="closeExitModal()"
                        class="flex-1 py-2.5 rounded-xl font-bold text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 transition-colors">Ở
                        lại</button>
                    <button onclick="confirmExit()"
                        class="flex-1 py-2.5 rounded-xl font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-lg shadow-rose-500/30 transition-all">Kết
                        thúc</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Bar -->
    <div class="fc-bottom-bar">
        <!-- Flip Button (shown on front) -->
        <button class="fc-flip-btn js-fc-flip-btn">
            <i class="fas fa-sync-alt"></i>
            <span>Lật thẻ</span>
        </button>

        <!-- Rating Buttons (shown on back) - dynamically populated by JavaScript -->
        <div class="fc-rating-btns js-fc-rating-btns" id="mobile-rating-btns">
            <!-- Buttons will be generated dynamically based on user_button_count -->
        </div>
    </div>
</div>

<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/audio_manager.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/render_card.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/ui_manager.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/session_ui.js') }}"></script>
</script>
{#
File: _stats_mobile.html
MỤC ĐÍCH: Giao diện thống kê phiên học tối ưu cho Mobile (App-like design)
#}

<template id="mobile-stats-template">
    <div class="mobile-stats-container h-full flex flex-col bg-slate-50 overflow-hidden rounded-t-2xl">
        <!-- Header -->
        <div
            class="flex items-center justify-between px-4 py-3 bg-white border-b border-slate-200 shadow-sm flex-shrink-0">
            <h3 class="text-lg font-bold text-slate-800">Thống kê phiên học</h3>
            <button id="close-stats-mobile-btn"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Summary Cards (Grid) -->
        <div class="grid grid-cols-2 gap-3 p-4 flex-shrink-0">
            <div
                class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Tổng điểm</span>
                <div class="text-2xl font-black text-blue-600 flex items-center gap-1 mt-1">
                    <i class="fas fa-gem text-blue-500 text-lg"></i>
                    <span id="total-score-display-mobile">-</span>
                </div>
            </div>
            <div
                class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Phiên này</span>
                <div id="session-score-display-mobile" class="text-2xl font-black text-emerald-600 mt-1">+0</div>
            </div>
        </div>

        <!-- Compact History Icons Row -->
        <div class="px-4 mb-3 flex-shrink-0">
            <div class="bg-white rounded-xl border border-slate-100 p-2">
                <div class="flex items-center gap-1 mb-1">
                    <i class="fas fa-history text-slate-400 text-xs"></i>
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Lịch sử phiên</span>
                </div>
                <div id="session-history-icons-mobile" class="flex flex-wrap gap-1">
                    <!-- Icons rendered dynamically: green check = correct, red x = wrong -->
                    <span class="text-xs text-slate-300">Chưa có dữ liệu</span>
                </div>
            </div>
        </div>

        <!-- Tabs (Segmented Control) -->
        <div class="px-4 mb-3 flex-shrink-0">
            <div class="flex p-1 bg-slate-200 rounded-xl">
                <button
                    class="stats-mobile-tab active flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 transition-all"
                    data-target="current-card-stats-pane-mobile">
                    Hiện tại
                </button>
                <button class="stats-mobile-tab flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 transition-all"
                    data-target="previous-card-stats-pane-mobile">
                    Trước đó
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto px-4 pb-24 relative no-scrollbar" id="stats-mobile-scroll-area">
            <div id="current-card-stats-pane-mobile" class="stats-mobile-pane active space-y-4">
                <div id="current-card-stats-mobile" class="stats-stack space-y-4">
                    <!-- Content injected via JS -->
                    <div class="flex flex-col items-center justify-center h-40 text-slate-400">
                        <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
                        <p class="text-sm">Đang tải...</p>
                    </div>
                </div>
            </div>
            <div id="previous-card-stats-pane-mobile" class="stats-mobile-pane hidden space-y-4">
                <div id="previous-card-stats-mobile" class="stats-stack space-y-4">
                    <!-- Content injected via JS -->
                    <div class="flex flex-col items-center justify-center h-40 text-slate-400">
                        <i class="fas fa-history text-2xl mb-2"></i>
                        <p class="text-sm">Chưa có dữ liệu.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Bottom Action -->
        <div class="absolute bottom-5 left-4 right-4 z-20">
            <button id="end-session-mobile-btn"
                class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-rose-200/50 flex items-center justify-center gap-2 transition-transform active:scale-95">
                <i class="fas fa-flag-checkered"></i> Kết thúc phiên học
            </button>
        </div>
    </div>
</template>
{# ... #}

{# ... #}

<div id="statsModal" class="stats-modal-overlay">
    <div id="statsModalContent" class="stats-modal-content">
        <header class="bg-white shadow-md p-4">
            <h3 class="font-bold text-lg">Mindstack</h3>
        </header>

        {# ... #}


        <script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/utils.js') }}"></script>

        {% endblock %}

        {% block scripts %}
        {{ super() }}

        <script>
            // Define Jinja variables outside the config object to prevent the auto-formatter from inserting spaces into braces
            const _userButtonCount = {{ user_button_count | default (4) }};
            const _isAutoplaySession = {{ is_autoplay_session | default (false) | tojson }};
            const _autoplayMode = "{{ autoplay_mode | default('') }}";
            const _visualSettings = {{ (saved_visual_settings or { }) | tojson }};
            const _autoSaveOn = {{ saved_auto_save | default (true) | tojson }};
            const _currentUserTotalScore = {{ current_user.total_score | default (0) }};
            const _scoreAgain = {{ config.SCORE_FSRS_AGAIN | default (1) }};
            const _scoreHard = {{ config.SCORE_FSRS_HARD | default (5) }};
            const _scoreGood = {{ config.SCORE_FSRS_GOOD | default (10) }};
            const _scoreEasy = {{ config.SCORE_FSRS_EASY | default (15) }};

            window.FlashcardConfig = {
                getFlashcardBatchUrl: "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}",
                flashcardItemApiUrlTemplate: "{{ url_for('learning.flashcard_learning.get_flashcard_item_api', item_id=0) }}",
                submitAnswerUrl: "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}",
                endSessionUrl: "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}",
                regenerateAudioUrl: "{{ url_for('learning.flashcard_learning.regenerate_audio_from_content') }}",
                saveSettingsUrl: "{{ url_for('learning.flashcard_learning.save_flashcard_settings') }}",
                vocabDashboardUrl: "{{ url_for('learning.vocabulary.dashboard') }}",
                getNoteUrl: "{{ url_for('notes.get_note', item_id=0) }}",
                saveNoteUrl: "{{ url_for('notes.save_note', item_id=0) }}",
                editFlashcardUrlTemplate: "{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=0, item_id=0) }}",
                itemStatsUrlTemplate: "{{ url_for('learning.vocabulary.item_stats_page', item_id=0) }}",
                csrfHeaders: { "X-CSRFToken": "{{ csrf_token() }}" },
                userButtonCount: _userButtonCount,
                isAutoplaySession: _isAutoplaySession,
                autoplayMode: _autoplayMode,
                visualSettings: _visualSettings,
                autoSaveOn: _autoSaveOn,
                modeDisplayName: "{{ mode_display_text }}",
                displaySettings: {{ (display_settings or { }) | tojson }},
            scores: {
                again: _scoreAgain,
                    hard: _scoreHard,
                        good: _scoreGood,
                            easy: _scoreEasy
            }
  };


            const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
            if (csrfToken) {
                window.FlashcardConfig.csrfHeaders = { "X-CSRFToken": csrfToken };
            }

            window.currentUserTotalScoreInit = _currentUserTotalScore;
            window.sessionScore = 0;

            // Global Exit Modal Logic for Flashcard
            window.showExitModal = function () {
                const exitModal = document.getElementById('exit-confirm-modal');
                const exitPanel = document.getElementById('exit-modal-panel');
                if (exitModal) {
                    exitModal.style.display = 'flex';
                    setTimeout(() => {
                        exitModal.classList.remove('opacity-0', 'hidden');
                        exitPanel.classList.remove('scale-95');
                        exitPanel.classList.add('scale-100');
                    }, 10);
                }
            };

            window.closeExitModal = function () {
                const exitModal = document.getElementById('exit-confirm-modal');
                const exitPanel = document.getElementById('exit-modal-panel');
                if (exitModal) {
                    exitModal.classList.add('opacity-0');
                    exitPanel.classList.remove('scale-100');
                    exitPanel.classList.add('scale-95');
                    setTimeout(() => {
                        exitModal.classList.add('hidden');
                        exitModal.style.display = 'none';
                    }, 300);
                }
            };

            window.confirmExit = function () {
                // We can rely on MindStackModal handling the UI close.
                // Proceed with logic.
                fetch(window.FlashcardConfig.endSessionUrl, {
                    method: 'POST',
                    headers: window.FlashcardConfig.csrfHeaders
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.session_id) {
                            window.location.href = `/learn/session/${data.session_id}/summary`;
                        } else {
                            window.location.href = "{{ url_for('learning.manage_sessions') }}";
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Lỗi kết nối. Vui lòng thử lại.");
                    });
            };
        </script>

        <script
            src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/session_manager.js') }}"></script>
        <script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/index.js') }}"></script>
        <script
            src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/flashcard_viewport.js') }}"></script>
        {% endblock %}