{#
# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html
# Phiên bản: 74.0
# ĐÃ SỬA: Đưa các biến Jinja ra ngoài object window.FlashcardConfig để tránh formatter làm hỏng syntax (insert space vào
{{ }}).
#}

{% set _v = template_version %}
{% extends _v ~ '/base.html' %}

{% block title %}Học Flashcard{% endblock %}

{# CRITICAL: Add flashcard-session-active class to body to hide header/footer on mobile #}
{% block body_class %} flashcard-session-active{% endblock %}

{% block head %}
{{ super() }}
{# Header/Footer hiding and padding removal is now handled globally via CSS in _global_styles.html
using the .flashcard-session-active class on the body #}

{# Flashcard Session CSS - External Files stored in template directory #}
{# ... imports ... #}
<link rel="stylesheet" href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/core.css') }}">
<link rel="stylesheet"
    href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/session.css') }}">
<link rel="stylesheet" href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/card.css') }}">
<link rel="stylesheet"
    href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/components.css') }}">

{% include _v ~ '/includes/assets/_markdown_assets.html' %}
{% endblock %}

{% block content %}
{# Mobile view only #}
{# Mobile Interface #}
<div class="flashcard-mobile-view">
    <div class="page-shell">
        <!-- Header - Stats Bar -->
        <!-- Header - Quiz Style Structure -->
        <div class="fc-header flex-col items-stretch !p-0">
            {# --- Row 1: Badge + Title + Score --- #}
            <div class="flex items-center justify-between px-3 py-2 bg-gradient-to-r from-emerald-500 to-green-600">
                {# Badge + Title #}
                <div class="flex items-center gap-2.5 overflow-hidden flex-1 mr-2">
                    <span id="js-fc-mode-btn"
                        class="flex-shrink-0 flex items-center gap-1 px-2.5 py-1 bg-white/20 rounded-lg shadow-sm"
                        style="cursor: pointer;">
                        <i class="fas fa-clone text-white text-[10px]"></i>
                        <span class="text-[10px] font-bold text-white uppercase tracking-wide">FLASHCARD</span>
                    </span>
                    <span class="text-sm font-bold text-white truncate js-fc-title"
                        style="text-shadow: 0 1px 3px rgba(0,0,0,0.3);">{{ container_name }}</span>
                </div>

                {# Score Badge #}
                <div class="flex-shrink-0 flex items-center gap-1 h-7 px-2.5 bg-white/20 rounded-full">
                    <i class="fa-solid fa-gem text-white text-[10px]"></i>
                    <span class="text-xs font-black text-white font-mono js-fc-score">
                        {{ "{:,}".format(current_user.total_score if current_user.total_score is not none else 0) }}
                    </span>
                </div>
            </div>

            {# --- Row 2: Stats (White) --- #}
            <div class="bg-white border-b border-slate-200">
                <div class="flex items-center justify-between px-3 py-2">
                    {# Stats Pills #}
                    <div id="fc-mobile-stats-pills"
                        class="flex items-center gap-1.5 text-xs overflow-x-auto no-scrollbar max-w-[70%] transition-all duration-300">
                        {# Progress #}
                        <div
                            class="stat-pill relative flex-shrink-0 flex items-center gap-1 px-2 py-1 bg-slate-100 rounded-lg overflow-hidden border border-slate-200">
                            <div class="absolute inset-y-0 left-0 bg-emerald-200/50 transition-all duration-300 js-fc-progress-pill-fill"
                                style="width: 0%"></div>
                            <div class="relative z-10 flex items-center gap-1">
                                <i class="fa-solid fa-bars-progress text-slate-500 text-[9px]"></i>
                                <span class="text-slate-700 font-semibold js-fc-progress-text">0/0</span>
                            </div>
                        </div>

                        {# Session Correct #}
                        <div class="stat-pill flex-shrink-0 flex items-center gap-1 px-2 py-1 bg-emerald-50 rounded-lg">
                            <i class="fa-solid fa-check text-emerald-500 text-[9px]"></i>
                            <span class="text-emerald-600 font-bold js-fc-session-correct">0</span>
                        </div>

                        {# Session Points #}
                        <div class="stat-pill flex-shrink-0 flex items-center gap-1 px-2 py-1 bg-amber-50 rounded-lg">
                            <i class="fa-solid fa-gem text-amber-500 text-[9px]"></i>
                            <span class="text-amber-600 font-bold font-mono js-fc-session-score">+0</span>
                        </div>

                        {# Card State Badge - Shows state (NEW/LEARNED/HARD/MASTER) #}
                        <div class="stat-pill flex-shrink-0 js-fc-state-badge fc-state-badge state-new hidden">
                            <i class="fa-solid fa-layer-group"></i>
                            <span class="js-fc-state-text">NEW</span>
                        </div>
                    </div>

                    {# Action Buttons #}
                    <div class="flex items-center gap-1.5 flex-shrink-0" id="fc-mobile-actions">

                        {# Card Stats Button - Icon Only - HIDDEN by default, shown on back #}
                        <button
                            class="w-7 h-7 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white flex items-center justify-center hover:from-indigo-600 hover:to-purple-600 shadow-sm js-fc-card-details-btn hidden"
                            title="Stats của thẻ">
                            <i class="fas fa-chart-pie text-[10px]"></i>
                        </button>

                        {# Settings Button #}
                        <div class="relative inline-block">
                            <button
                                class="w-7 h-7 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 js-fc-settings-toggle">
                                <i class="fas fa-cog text-[10px]"></i>
                            </button>
                            <div class="fc-settings-menu js-fc-settings-menu z-50" style="right: 0; top: 100%;">
                                <button class="fc-settings-item js-fc-image-toggle">
                                    <i class="fas fa-image js-fc-image-icon"></i>
                                    <span class="js-fc-image-text">Hiện ảnh</span>
                                </button>
                                <button class="fc-settings-item js-fc-autoplay-toggle">
                                    <i class="fas fa-play js-fc-autoplay-icon"></i>
                                    <span class="js-fc-autoplay-text">Tự động phát</span>
                                </button>
                                <button class="fc-settings-item open-feedback-modal-btn js-fc-feedback-btn">
                                    <i class="fas fa-flag"></i>
                                    <span>Báo lỗi thẻ</span>
                                </button>
                                <button class="fc-settings-item edit-card-btn js-fc-edit-btn">
                                    <i class="fas fa-pencil-alt"></i>
                                    <span>Sửa thẻ</span>
                                </button>
                            </div>
                        </div>

                        {# Audio Button - Moved before Home/Exit #}
                        <button
                            class="w-7 h-7 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100 js-fc-audio-btn">
                            <i class="fas fa-volume-up text-[10px]"></i>
                        </button>

                        {# Home Button #}
                        <a href="/"
                            class="w-7 h-7 rounded-full bg-slate-50 text-slate-500 flex items-center justify-center hover:bg-slate-100">
                            <i class="fas fa-home text-[10px]"></i>
                        </a>

                        {# Exit Button #}
                        <button onclick="showExitModal()"
                            class="w-7 h-7 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-100"
                            id="mobile-exit-btn">
                            <i class="fa-solid fa-right-from-bracket text-[10px]"></i>
                        </button>
                    </div>
                </div>
            </div>

            {# Progress Line (Thin, optional, maybe keep it?) #}
            <div class="h-0.5 bg-slate-100 w-full">
                <div class="h-full bg-emerald-500 js-fc-progress-fill transition-all duration-300" style="width: 0%">
                </div>
            </div>
        </div>

        {# === NEW: Dynamic Card Info Bar === #}
        <div id="fc-card-info-bar"
            class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200 px-3 py-2 overflow-x-auto no-scrollbar">
            <div class="flex items-center gap-2 text-[10px] whitespace-nowrap min-w-max">
                {# Card Status #}
                <div
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-bold js-card-status-pill">
                    <i class="fas fa-layer-group"></i>
                    <span class="js-card-status-text">MỚI</span>
                </div>

                {# Times Reviewed #}
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-200 text-slate-600">
                    <i class="fas fa-redo"></i>
                    <span><span class="font-bold js-card-times-reviewed">0</span> lần</span>
                </div>

                {# Streak #}
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-100 text-amber-700">
                    <i class="fas fa-fire"></i>
                    <span>Chuỗi: <span class="font-bold js-card-streak">0</span></span>
                </div>

                {# Stability #}
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">
                    <i class="fas fa-shield-alt"></i>
                    <span>Ổn định: <span class="font-bold js-card-stability">0</span> ngày</span>
                </div>

                {# Retrievability #}
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-purple-100 text-purple-700">
                    <i class="fas fa-brain"></i>
                    <span>Nhớ: <span class="font-bold js-card-retrievability">0</span>%</span>
                </div>

                {# Rating Distribution Mini (optional visual) #}
                <div
                    class="inline-flex items-center gap-0.5 px-2 py-1 rounded-full bg-white border border-slate-200 shadow-inner">
                    <span class="w-2 h-2 rounded-full bg-rose-500 js-rating-dot-1"></span>
                    <span class="w-2 h-2 rounded-full bg-amber-500 js-rating-dot-2"></span>
                    <span class="w-2 h-2 rounded-full bg-emerald-500 js-rating-dot-3"></span>
                    <span class="w-2 h-2 rounded-full bg-blue-500 js-rating-dot-4"></span>
                </div>
            </div>
        </div>

        <div class="session-layout">
            <div class="flashcard-wrapper">
                <div class="card-surface">
                    <div class="flashcard-panel">
                        <div class="js-flashcard-content">
                            <div
                                class="flex flex-col items-center justify-center h-full text-emerald-500 min-h-[300px]">
                                <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                                <p>Đang tải thẻ...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Fixed Bottom Bar -->
    <div class="fc-bottom-bar">
        <!-- Flip Button (shown on front) -->
        <button class="fc-flip-btn js-fc-flip-btn">
            <i class="fas fa-sync-alt"></i>
            <span>Lật thẻ</span>
        </button>

        <!-- Rating Buttons (shown on back) - dynamically populated by JavaScript -->
        <div class="fc-rating-btns js-fc-rating-btns" id="mobile-rating-btns">
            <!-- Buttons will be generated dynamically based on user_button_count -->
        </div>
    </div>
</div>

<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/audio_manager.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/render_card.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/ui_manager.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/session_ui.js') }}"></script>
</script>
{#
File: _stats_mobile.html
MỤC ĐÍCH: Giao diện thống kê phiên học tối ưu cho Mobile (App-like design)
#}

<template id="mobile-stats-template">
    <div class="mobile-stats-container h-full flex flex-col bg-slate-50 overflow-hidden rounded-t-2xl">
        <!-- Header -->
        <div
            class="flex items-center justify-between px-4 py-3 bg-white border-b border-slate-200 shadow-sm flex-shrink-0">
            <h3 class="text-lg font-bold text-slate-800">Thống kê phiên học</h3>
            <button id="close-stats-mobile-btn"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Summary Cards (Grid) -->
        <div class="grid grid-cols-2 gap-3 p-4 flex-shrink-0">
            <div
                class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Tổng điểm</span>
                <div class="text-2xl font-black text-blue-600 flex items-center gap-1 mt-1">
                    <i class="fas fa-gem text-blue-500 text-lg"></i>
                    <span id="total-score-display-mobile">-</span>
                </div>
            </div>
            <div
                class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Phiên này</span>
                <div id="session-score-display-mobile" class="text-2xl font-black text-emerald-600 mt-1">+0</div>
            </div>
        </div>

        <!-- Compact History Icons Row -->
        <div class="px-4 mb-3 flex-shrink-0">
            <div class="bg-white rounded-xl border border-slate-100 p-2">
                <div class="flex items-center gap-1 mb-1">
                    <i class="fas fa-history text-slate-400 text-xs"></i>
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Lịch sử phiên</span>
                </div>
                <div id="session-history-icons-mobile" class="flex flex-wrap gap-1">
                    <!-- Icons rendered dynamically: green check = correct, red x = wrong -->
                    <span class="text-xs text-slate-300">Chưa có dữ liệu</span>
                </div>
            </div>
        </div>

        <!-- Tabs (Segmented Control) -->
        <div class="px-4 mb-3 flex-shrink-0">
            <div class="flex p-1 bg-slate-200 rounded-xl">
                <button
                    class="stats-mobile-tab active flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 transition-all"
                    data-target="current-card-stats-pane-mobile">
                    Hiện tại
                </button>
                <button class="stats-mobile-tab flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 transition-all"
                    data-target="previous-card-stats-pane-mobile">
                    Trước đó
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto px-4 pb-24 relative no-scrollbar" id="stats-mobile-scroll-area">
            <div id="current-card-stats-pane-mobile" class="stats-mobile-pane active space-y-4">
                <div id="current-card-stats-mobile" class="stats-stack space-y-4">
                    <!-- Content injected via JS -->
                    <div class="flex flex-col items-center justify-center h-40 text-slate-400">
                        <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
                        <p class="text-sm">Đang tải...</p>
                    </div>
                </div>
            </div>
            <div id="previous-card-stats-pane-mobile" class="stats-mobile-pane hidden space-y-4">
                <div id="previous-card-stats-mobile" class="stats-stack space-y-4">
                    <!-- Content injected via JS -->
                    <div class="flex flex-col items-center justify-center h-40 text-slate-400">
                        <i class="fas fa-history text-2xl mb-2"></i>
                        <p class="text-sm">Chưa có dữ liệu.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Bottom Action -->
        <div class="absolute bottom-5 left-4 right-4 z-20">
            <button id="end-session-mobile-btn"
                class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-rose-200/50 flex items-center justify-center gap-2 transition-transform active:scale-95">
                <i class="fas fa-flag-checkered"></i> Kết thúc phiên học
            </button>
        </div>
    </div>
</template>
{# ... #}

{# ... #}

<div id="statsModal" class="stats-modal-overlay">
    <div id="statsModalContent" class="stats-modal-content">
        <header class="bg-white shadow-md p-4">
            <h3 class="font-bold text-lg">Mindstack</h3>
        </header>

        {# ... #}


        <script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/utils.js') }}"></script>

        {% endblock %}

        {% block scripts %}
        {{ super() }}

        <script>
            // Define Jinja variables outside the config object to prevent the auto-formatter from inserting spaces into braces
            const _userButtonCount = {{ user_button_count | default (4) }};
            const _isAutoplaySession = {{ is_autoplay_session | default (false) | tojson }};
            const _autoplayMode = "{{ autoplay_mode | default('') }}";
            const _visualSettings = {{ (saved_visual_settings or { }) | tojson }};
            const _autoSaveOn = {{ saved_auto_save | default (true) | tojson }};
            const _currentUserTotalScore = {{ current_user.total_score | default (0) }};
            const _scoreAgain = {{ config.SCORE_FSRS_AGAIN | default (1) }};
            const _scoreHard = {{ config.SCORE_FSRS_HARD | default (5) }};
            const _scoreGood = {{ config.SCORE_FSRS_GOOD | default (10) }};
            const _scoreEasy = {{ config.SCORE_FSRS_EASY | default (15) }};

            window.FlashcardConfig = {
                getFlashcardBatchUrl: "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}",
                flashcardItemApiUrlTemplate: "{{ url_for('learning.flashcard_learning.get_flashcard_item_api', item_id=0) }}",
                submitAnswerUrl: "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}",
                endSessionUrl: "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}",
                regenerateAudioUrl: "{{ url_for('learning.flashcard_learning.regenerate_audio_from_content') }}",
                saveSettingsUrl: "{{ url_for('learning.flashcard_learning.save_flashcard_settings') }}",
                vocabDashboardUrl: "{{ url_for('learning.vocabulary.dashboard') }}",
                getNoteUrl: "{{ url_for('notes.get_note', item_id=0) }}",
                saveNoteUrl: "{{ url_for('notes.save_note', item_id=0) }}",
                editFlashcardUrlTemplate: "{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=0, item_id=0) }}",
                itemStatsUrlTemplate: "{{ url_for('learning.vocabulary.item_stats_page', item_id=0) }}",
                csrfHeaders: { "X-CSRFToken": "{{ csrf_token() }}" },
                userButtonCount: _userButtonCount,
                isAutoplaySession: _isAutoplaySession,
                autoplayMode: _autoplayMode,
                visualSettings: _visualSettings,
                autoSaveOn: _autoSaveOn,
                modeDisplayName: "{{ mode_display_text }}",
                displaySettings: {{ (display_settings or { }) | tojson }},
            scores: {
                again: _scoreAgain,
                    hard: _scoreHard,
                        good: _scoreGood,
                            easy: _scoreEasy
            }
  };


            const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
            if (csrfToken) {
                window.FlashcardConfig.csrfHeaders = { "X-CSRFToken": csrfToken };
            }

            window.currentUserTotalScoreInit = _currentUserTotalScore;
            window.sessionScore = 0;

            // Global Exit Modal Logic for Flashcard
            window.showExitModal = function () {
                const exitModal = document.getElementById('exit-confirm-modal');
                const exitPanel = document.getElementById('exit-modal-panel');
                if (exitModal) {
                    exitModal.style.display = 'flex';
                    setTimeout(() => {
                        exitModal.classList.remove('opacity-0', 'hidden');
                        exitPanel.classList.remove('scale-95');
                        exitPanel.classList.add('scale-100');
                    }, 10);
                }
            };

            window.closeExitModal = function () {
                const exitModal = document.getElementById('exit-confirm-modal');
                const exitPanel = document.getElementById('exit-modal-panel');
                if (exitModal) {
                    exitModal.classList.add('opacity-0');
                    exitPanel.classList.remove('scale-100');
                    exitPanel.classList.add('scale-95');
                    setTimeout(() => {
                        exitModal.classList.add('hidden');
                        exitModal.style.display = 'none';
                    }, 300);
                }
            };

            window.confirmExit = function () {
                // We can rely on MindStackModal handling the UI close.
                // Proceed with logic.
                fetch(window.FlashcardConfig.endSessionUrl, {
                    method: 'POST',
                    headers: window.FlashcardConfig.csrfHeaders
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.session_id) {
                            window.location.href = `/learn/session/${data.session_id}/summary`;
                        } else {
                            window.location.href = "{{ url_for('learning.manage_sessions') }}";
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Lỗi kết nối. Vui lòng thử lại.");
                    });
            };
        </script>

        <script
            src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/session_manager.js') }}"></script>
        <script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/index.js') }}"></script>
        <script
            src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/flashcard_viewport.js') }}"></script>
        {% endblock %}