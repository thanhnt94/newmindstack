{#
File: mindstack_app/modules/content_management/flashcards/templates/_add_edit_flashcard_item_bare.html
Phiên bản: 2.6
MỤC ĐÍCH: Hỗ trợ sửa thẻ trong modal với giao diện Tab.
THAY ĐỔI:
- Fix lỗi Tab AI và Mở rộng (do lỗi cấu trúc HTML/CSS).
- Giữ nguyên giao diện Edge-to-Edge.
- Loại bỏ class rác (no-scrollbar).
#}
<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Force full height and disable body scroll */
        html,
        body {
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            color: #1e293b;
            background-color: #fff;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-fade-in-down {
            animation: fadeInDown 0.2s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="flex flex-col">

    {% set modal_suffix = '?is_modal=true' if is_modal_view else '' %}

    <!-- HEADER (Fixed) -->
    <div
        class="flex-none bg-white border-b border-slate-100 flex items-center justify-between px-4 py-2.5 z-20 shadow-sm">
        <!-- Left: Close & Title -->
        <div class="flex items-center gap-3">
            <button type="button"
                class="group flex items-center justify-center w-8 h-8 rounded-full bg-slate-50 text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition focus:outline-none"
                data-role="close-editor" title="Thoát">
                <i class="fas fa-times"></i>
            </button>
            <div class="flex items-baseline gap-2">
                <h1 class="text-base font-bold text-slate-800 leading-tight">{{ title }}</h1>
                {% if flashcard_item %}
                <span class="text-xs text-slate-400 font-mono">#{{ flashcard_item.item_id }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Right: Actions -->
        <div class="flex items-center gap-2">
            <div class="hidden sm:flex items-center bg-slate-50 rounded-lg p-0.5 border border-slate-100">
                {% if previous_item_id %}
                <a href="{{ url_for('.edit_flashcard_item', set_id=flashcard_set.container_id, item_id=previous_item_id) }}{{ modal_suffix }}"
                    class="w-7 h-7 flex items-center justify-center text-slate-600 hover:bg-white hover:text-blue-600 hover:shadow-sm rounded transition"
                    title="Thẻ trước">
                    <i class="fas fa-chevron-left text-[10px]"></i>
                </a>
                {% else %}
                <span class="w-7 h-7 flex items-center justify-center text-slate-300 cursor-not-allowed"><i
                        class="fas fa-chevron-left text-[10px]"></i></span>
                {% endif %}

                <div class="w-px h-3 bg-slate-200 mx-0.5"></div>

                {% if next_item_id %}
                <a href="{{ url_for('.edit_flashcard_item', set_id=flashcard_set.container_id, item_id=next_item_id) }}{{ modal_suffix }}"
                    class="w-7 h-7 flex items-center justify-center text-slate-600 hover:bg-white hover:text-blue-600 hover:shadow-sm rounded transition"
                    title="Thẻ tiếp">
                    <i class="fas fa-chevron-right text-[10px]"></i>
                </a>
                {% else %}
                <span class="w-7 h-7 flex items-center justify-center text-slate-300 cursor-not-allowed"><i
                        class="fas fa-chevron-right text-[10px]"></i></span>
                {% endif %}
            </div>

            <button type="submit" form="flashcardItemForm"
                class="flex items-center gap-1.5 px-4 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 active:scale-95 transition shadow-sm shadow-blue-600/20">
                <i class="fas fa-check"></i>
                <span>Lưu</span>
            </button>
        </div>
    </div>

    <!-- TABS (Fixed) -->
    <div class="flex-none bg-white border-b border-slate-100 px-4 flex gap-6 z-10 overflow-x-auto">
        <button type="button" data-tab-target="tab-general"
            class="py-2.5 relative text-xs font-bold text-slate-500 hover:text-slate-800 transition focus:outline-none group active-tab whitespace-nowrap">
            <span class="flex items-center gap-1.5"><i class="fas fa-layer-group"></i> Cơ bản</span>
            <span
                class="absolute bottom-[-1px] left-0 w-full h-0.5 bg-blue-600 scale-x-0 group-[.active-tab]:scale-x-100 transition-transform duration-200"></span>
        </button>
        <button type="button" data-tab-target="tab-media"
            class="py-2.5 relative text-xs font-bold text-slate-500 hover:text-slate-800 transition focus:outline-none group whitespace-nowrap">
            <span class="flex items-center gap-1.5"><i class="fas fa-photo-film"></i> Media</span>
            <span
                class="absolute bottom-[-1px] left-0 w-full h-0.5 bg-purple-600 scale-x-0 group-[.active-tab]:scale-x-100 transition-transform duration-200"></span>
        </button>
        <button type="button" data-tab-target="tab-ai"
            class="py-2.5 relative text-xs font-bold text-slate-500 hover:text-slate-800 transition focus:outline-none group whitespace-nowrap">
            <span class="flex items-center gap-1.5"><i class="fas fa-robot"></i> AI</span>
            <span
                class="absolute bottom-[-1px] left-0 w-full h-0.5 bg-orange-600 scale-x-0 group-[.active-tab]:scale-x-100 transition-transform duration-200"></span>
        </button>
        <button type="button" data-tab-target="tab-extended"
            class="py-2.5 relative text-xs font-bold text-slate-500 hover:text-slate-800 transition focus:outline-none group whitespace-nowrap">
            <span class="flex items-center gap-1.5"><i class="fas fa-folder-plus"></i> Mở rộng</span>
            <span
                class="absolute bottom-[-1px] left-0 w-full h-0.5 bg-teal-600 scale-x-0 group-[.active-tab]:scale-x-100 transition-transform duration-200"></span>
        </button>
    </div>

    <!-- CONTENT (Scrollable) -->
    <div class="flex-1 overflow-y-auto custom-scrollbar bg-white relative">
        <div class="p-4 sm:p-6 pb-20 w-full max-w-5xl mx-auto">

            <form id="flashcardItemForm" action="" method="post" class="space-y-6"
                data-image-search-url="{{ image_search_url }}" data-front-source-id="{{ form.front.id }}"
                data-back-source-id="{{ form.back.id }}"
                data-item-id="{{ flashcard_item.item_id if flashcard_item else '' }}"
                data-regenerate-audio-url="{{ regenerate_audio_url }}"
                data-image-base-folder="{{ image_base_folder or '' }}"
                data-audio-base-folder="{{ audio_base_folder or '' }}">
                {{ form.csrf_token }}

                <!-- TAB 1: GENERAL -->
                <div id="tab-general" class="space-y-6 tab-content animate-fade-in">
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Front -->
                        <div
                            class="group bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-400 transition-all p-0">
                            <div
                                class="bg-slate-50 border-b border-slate-100 px-4 py-2 flex justify-between items-center">
                                <label
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer"
                                    for="{{ form.front.id }}">Mặt trước (Front)</label>
                                <span class="text-[10px] text-slate-400 font-mono">TEXT</span>
                            </div>
                            {{ form.front(class="block w-full px-4 py-3 bg-white border-0 focus:ring-0 text-base
                            text-slate-800 placeholder:text-slate-300 min-h-[80px]", rows="3", placeholder="Nhập câu
                            hỏi, từ vựng...") }}
                            {% if form.front.errors %}
                            <p class="px-4 pb-2 text-red-500 text-xs font-medium"><i
                                    class="fas fa-exclamation-circle mr-1"></i> {{ form.front.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Back -->
                        <div
                            class="group bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-400 transition-all p-0">
                            <div
                                class="bg-slate-50 border-b border-slate-100 px-4 py-2 flex justify-between items-center">
                                <label
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer"
                                    for="{{ form.back.id }}">Mặt sau (Back)</label>
                                <span class="text-[10px] text-slate-400 font-mono">TEXT</span>
                            </div>
                            {{ form.back(class="block w-full px-4 py-3 bg-white border-0 focus:ring-0 text-base
                            text-slate-800 placeholder:text-slate-300 min-h-[100px]", rows="5", placeholder="Nhập định
                            nghĩa, câu trả lời...") }}
                            {% if form.back.errors %}
                            <p class="px-4 pb-2 text-red-500 text-xs font-medium"><i
                                    class="fas fa-exclamation-circle mr-1"></i> {{ form.back.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Order -->
                    <div class="flex items-center gap-4">
                        <div class="w-full sm:w-1/3">
                            {{ form.order_in_container.label(class="block text-[10px] font-bold text-slate-500 uppercase
                            tracking-wider mb-1.5") }}
                            <div class="relative">
                                {{ form.order_in_container(class="block w-full px-3 py-2 bg-white border
                                border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pl-9
                                font-mono text-sm text-slate-700 shadow-sm") }}
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-sort-numeric-down text-slate-400 text-xs"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Move Card -->
                    {% if flashcard_item and move_targets %}
                    <div class="border-t border-slate-100 pt-6">
                        <h3
                            class="text-xs font-bold text-slate-800 mb-3 flex items-center gap-2 uppercase tracking-wide">
                            <i class="fas fa-exchange-alt"></i> Di chuyển thẻ
                        </h3>
                        <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                            <div class="flex flex-col sm:flex-row gap-2 items-center">
                                <select name="target_set_id"
                                    class="flex-1 w-full px-3 py-2 bg-white border border-slate-200 rounded-md text-xs text-slate-700 font-medium cursor-pointer focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- Chọn bộ thẻ đến --</option>
                                    {% for target in move_targets %}
                                    <option value="{{ target.container_id }}">{{ target.title }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit"
                                    formaction="{{ url_for('.move_flashcard_item', set_id=flashcard_set.container_id, item_id=flashcard_item.item_id) }}"
                                    class="w-full sm:w-auto px-4 py-2 bg-slate-800 text-white text-xs font-bold rounded-md hover:bg-slate-700 transition">Thực
                                    hiện</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- TAB 2: MEDIA -->
                <div id="tab-media" class="space-y-6 tab-content hidden animate-fade-in">
                    <!-- Front Media -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="bg-slate-50 border-b border-slate-100 px-4 py-2 flex items-center gap-2">
                            <span
                                class="w-5 h-5 rounded bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-[10px]">F</span>
                            <h3 class="font-bold text-slate-700 text-xs uppercase">Mặt trước (Front)</h3>
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- Audio -->
                            <div class="flex flex-col gap-2">
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Audio</label>
                                <div class="flex gap-2">
                                    {{ form.front_audio_content(class="flex-1 px-3 py-2 text-xs bg-white border
                                    border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500", placeholder="Nội dung
                                    tạo audio (TTS)...", rows="3") }}
                                    <button type="button" data-role="regenerate-audio"
                                        class="px-3 py-1 bg-slate-50 border border-slate-200 text-slate-600 rounded-lg hover:bg-white hover:text-blue-600 transition h-auto"
                                        title="Tạo mới">
                                        <i class="fas fa-magic"></i>
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    {{ form.front_audio_url(class="w-full px-3 py-2 text-xs text-slate-500
                                    bg-slate-50/50 border border-slate-200 rounded-lg focus:ring-1 focus:ring-blue-500
                                    placeholder:text-slate-300", placeholder="URL Audio (nếu có)") }}
                                    <div class="flex items-center justify-between gap-2 px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg"
                                        data-audio-side="front" data-audio-url-input-id="{{ form.front_audio_url.id }}"
                                        data-audio-content-input-id="{{ form.front_audio_content.id }}"
                                        data-initial-audio-url="{{ front_audio_url_resolved or '' }}">
                                        <span class="text-[10px] font-bold text-slate-400">PLAYER</span>
                                        <div class="flex items-center gap-2">
                                            <button type="button" data-role="play-audio"
                                                class="w-7 h-7 rounded-full bg-blue-500 text-white hover:bg-blue-600 flex items-center justify-center shadow-sm">
                                                <i class="fas fa-play text-[10px]"></i>
                                            </button>
                                            <audio controls class="h-6 w-20 hidden" data-role="audio-player"></audio>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-slate-100"></div>
                            <!-- Image -->
                            <div data-image-side="front" data-initial-url="{{ front_image_url or '' }}">
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Hình
                                    ảnh</label>
                                <div class="flex gap-4">
                                    <div class="w-24 h-24 bg-slate-100 rounded-lg border border-dashed border-slate-300 flex items-center justify-center relative group overflow-hidden hover:border-blue-400 hover:bg-blue-50 transition"
                                        data-role="image-preview-wrapper">
                                        <div class="text-slate-300" data-role="image-placeholder"><i
                                                class="fas fa-image text-xl"></i></div>
                                        <img src="" class="absolute inset-0 w-full h-full object-cover hidden"
                                            data-role="image-preview">
                                        <button type="button" data-role="remove-image"
                                            class="absolute top-1 right-1 w-5 h-5 bg-black/50 text-white rounded-full flex items-center justify-center hidden group-hover:flex hover:bg-red-500 transition"><i
                                                class="fas fa-times text-[10px]"></i></button>
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <div class="flex gap-2">
                                            <div class="relative flex-1">
                                                <input type="text" data-role="image-query"
                                                    class="w-full pl-7 pr-2 py-1.5 text-xs border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    placeholder="Tìm ảnh...">
                                                <i
                                                    class="fas fa-search absolute left-2.5 top-2 text-slate-400 text-[10px]"></i>
                                            </div>
                                            <button type="button" data-role="search-image"
                                                class="px-3 py-1.5 bg-slate-800 text-white text-[10px] font-bold rounded-lg hover:bg-slate-700">Tìm</button>
                                        </div>
                                        {{ form.front_img(class="w-full px-3 py-1.5 text-[10px] text-slate-500
                                        bg-slate-50 border border-slate-200 rounded-lg focus:ring-1
                                        focus:ring-blue-500", placeholder="URL image") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Back Media -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="bg-slate-50 border-b border-slate-100 px-4 py-2 flex items-center gap-2">
                            <span
                                class="w-5 h-5 rounded bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-[10px]">B</span>
                            <h3 class="font-bold text-slate-700 text-xs uppercase">Mặt sau (Back)</h3>
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- Audio Back -->
                            <div class="flex flex-col gap-2">
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Audio</label>
                                <div class="flex gap-2">
                                    {{ form.back_audio_content(class="flex-1 px-3 py-2 text-xs bg-white border
                                    border-slate-200 rounded-lg focus:ring-2 focus:ring-purple-500", placeholder="Nội
                                    dung tạo audio (TTS)...", rows="3") }}
                                    <button type="button" data-role="regenerate-audio"
                                        class="px-3 py-1 bg-slate-50 border border-slate-200 text-slate-600 rounded-lg hover:bg-white hover:text-purple-600 transition h-auto"
                                        title="Tạo mới">
                                        <i class="fas fa-magic"></i>
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    {{ form.back_audio_url(class="w-full px-3 py-2 text-xs text-slate-500 bg-slate-50/50
                                    border border-slate-200 rounded-lg focus:ring-1 focus:ring-purple-500
                                    placeholder:text-slate-300", placeholder="URL Audio (nếu có)") }}
                                    <div class="flex items-center justify-between gap-2 px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg"
                                        data-audio-side="back" data-audio-url-input-id="{{ form.back_audio_url.id }}"
                                        data-audio-content-input-id="{{ form.back_audio_content.id }}"
                                        data-initial-audio-url="{{ back_audio_url_resolved or '' }}">
                                        <span class="text-[10px] font-bold text-slate-400">PLAYER</span>
                                        <div class="flex items-center gap-2">
                                            <button type="button" data-role="play-audio"
                                                class="w-7 h-7 rounded-full bg-purple-500 text-white hover:bg-purple-600 flex items-center justify-center shadow-sm">
                                                <i class="fas fa-play text-[10px]"></i>
                                            </button>
                                            <audio controls class="h-6 w-20 hidden" data-role="audio-player"></audio>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-slate-100"></div>
                            <!-- Image Back -->
                            <div data-image-side="back" data-initial-url="{{ back_image_url or '' }}">
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Hình
                                    ảnh</label>
                                <div class="flex gap-4">
                                    <div class="w-24 h-24 bg-slate-100 rounded-lg border border-dashed border-slate-300 flex items-center justify-center relative group overflow-hidden hover:border-purple-400 hover:bg-purple-50 transition"
                                        data-role="image-preview-wrapper">
                                        <div class="text-slate-300" data-role="image-placeholder"><i
                                                class="fas fa-image text-xl"></i></div>
                                        <img src="" class="absolute inset-0 w-full h-full object-cover hidden"
                                            data-role="image-preview">
                                        <button type="button" data-role="remove-image"
                                            class="absolute top-1 right-1 w-5 h-5 bg-black/50 text-white rounded-full flex items-center justify-center hidden group-hover:flex hover:bg-red-500 transition"><i
                                                class="fas fa-times text-[10px]"></i></button>
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <div class="flex gap-2">
                                            <div class="relative flex-1">
                                                <input type="text" data-role="image-query"
                                                    class="w-full pl-7 pr-2 py-1.5 text-xs border border-slate-200 rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="Tìm ảnh...">
                                                <i
                                                    class="fas fa-search absolute left-2.5 top-2 text-slate-400 text-[10px]"></i>
                                            </div>
                                            <button type="button" data-role="search-image"
                                                class="px-3 py-1.5 bg-slate-800 text-white text-[10px] font-bold rounded-lg hover:bg-slate-700">Tìm</button>
                                        </div>
                                        {{ form.back_img(class="w-full px-3 py-1.5 text-[10px] text-slate-500
                                        bg-slate-50 border border-slate-200 rounded-lg focus:ring-1
                                        focus:ring-purple-500", placeholder="URL image") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: AI -->
                <div id="tab-ai" class="space-y-6 tab-content hidden animate-fade-in">
                    <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <h3
                            class="text-xs font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2 uppercase text-orange-600 transition-colors">
                            Cấu hình AI
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 mb-1 block uppercase">Custom
                                    Prompt</label>
                                {{ form.ai_prompt(class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg
                                text-sm font-mono focus:ring-2 focus:ring-orange-500", rows="3") }}
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 mb-1 block uppercase">AI
                                    Explanation</label>
                                {{ form.ai_explanation(class="w-full px-3 py-2 bg-slate-50 border border-slate-200
                                rounded-lg text-sm focus:ring-2 focus:ring-orange-500", rows="6") }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: EXTENDED -->
                <div id="tab-extended" class="space-y-6 tab-content hidden animate-fade-in">
                    <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                            <h3 class="text-xs font-bold text-slate-800 uppercase text-teal-600">
                                Dữ liệu tùy chỉnh
                            </h3>
                            <button type="button" id="add-custom-data-btn"
                                class="text-[10px] bg-teal-50 text-teal-700 px-2 py-1 rounded font-bold hover:bg-teal-100 transition flex items-center gap-1">
                                <i class="fas fa-plus"></i> Thêm
                            </button>
                        </div>
                        <div id="custom-data-container" class="space-y-2">
                            {% if flashcard_item and flashcard_item.custom_data %}
                            {% for key, value in flashcard_item.custom_data.items() %}
                            <div class="custom-data-row flex gap-2">
                                <select name="custom_keys[]"
                                    class="flex-1 w-1/3 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold focus:ring-2 focus:ring-teal-500">
                                    <option value="">-- Chọn --</option>
                                    {% for opt in custom_keys_options %}
                                    <option value="{{ opt }}" {% if opt==key %}selected{% endif %}>{{ opt }}</option>
                                    {% endfor %}
                                    {# If existing key is not in allowed list, keep it valid to prevent data loss #}
                                    {% if key and key not in custom_keys_options %}
                                    <option value="{{ key }}" selected>{{ key }} (Chưa cấu hình)</option>
                                    {% endif %}
                                </select>
                                <input type="text" name="custom_values[]" value="{{ value }}"
                                    class="flex-[2] w-2/3 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs"
                                    placeholder="Giá trị">
                                <button type="button"
                                    class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg"
                                    onclick="this.closest('.custom-data-row').remove()"><i
                                        class="fas fa-trash-alt text-xs"></i></button>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-xs text-slate-400 italic text-center py-4" id="empty-custom-data-msg">Không
                                có dữ liệu.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Templates -->
    <template id="custom-data-row-template">
        <div class="custom-data-row flex gap-2 animate-fade-in-down mt-2">
            <select name="custom_keys[]"
                class="flex-1 w-1/3 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold focus:ring-2 focus:ring-teal-500">
                <option value="">-- Chọn --</option>
                {% for opt in custom_keys_options %}
                <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
            </select>
            <input type="text" name="custom_values[]" value=""
                class="flex-[2] w-2/3 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs"
                placeholder="Giá trị">
            <button type="button"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg"
                onclick="this.closest('.custom-data-row').remove()"><i class="fas fa-trash-alt text-xs"></i></button>
        </div>
    </template>

    {% set _v = template_version %}
    {% include _v ~ '/pages/content_management/flashcards/shared/_flashcard_image_control_scripts.html' %}
    {% include _v ~ '/pages/content_management/flashcards/shared/_flashcard_audio_control_scripts.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Init Tabs - Logic switched to ensure robustness
            const tabs = document.querySelectorAll('[data-tab-target]');
            const contents = document.querySelectorAll('.tab-content');

            function activateTab(tabId) {
                // Update Tab Buttons
                tabs.forEach(tab => {
                    const target = tab.dataset.tabTarget;
                    if (target === tabId) {
                        tab.classList.add('text-slate-800', 'active-tab');
                        tab.classList.remove('text-slate-500');
                    } else {
                        tab.classList.remove('text-slate-800', 'active-tab');
                        tab.classList.add('text-slate-500');
                    }
                });

                // Update Content Visibility
                contents.forEach(c => {
                    if (c.id === tabId) {
                        c.classList.remove('hidden');
                    } else {
                        c.classList.add('hidden');
                    }
                });
            }

            // Add click listeners
            tabs.forEach(t => {
                t.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent accidental form submit if type!=button
                    const target = t.dataset.tabTarget;
                    if (target) activateTab(target);
                });
            });

            // Default Tab
            activateTab('tab-general');

            // Init Media
            if (typeof initializeFlashcardImageControls === 'function') initializeFlashcardImageControls({ formSelector: '#flashcardItemForm' });
            if (typeof initializeFlashcardAudioControls === 'function') initializeFlashcardAudioControls({ formSelector: '#flashcardItemForm' });

            // Init Custom Data - Ensure template exists
            const container = document.getElementById('custom-data-container');
            const addBtn = document.getElementById('add-custom-data-btn');
            const template = document.getElementById('custom-data-row-template');
            const emptyMsg = document.getElementById('empty-custom-data-msg');

            if (addBtn && template && container) {
                addBtn.addEventListener('click', () => {
                    if (emptyMsg) emptyMsg.style.display = 'none';
                    const clone = template.content.cloneNode(true);
                    container.appendChild(clone);
                });
            }

            // Close Button
            document.querySelectorAll('[data-role="close-editor"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (window.parent && window.parent.closeModal) window.parent.closeModal();
                    else window.history.back();
                });
            });

            // Form Submit
            const form = document.getElementById('flashcardItemForm');
            let currentItemId = {{ (flashcard_item.item_id if flashcard_item else None) | tojson }};
        const setId = {{ flashcard_set.container_id | tojson }};

        if (form) {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.delete('is_modal');
            form.action = currentUrl.toString();

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                document.querySelectorAll('.text-red-500').forEach(el => el.remove());
                document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));

                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const res = await fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    const data = await res.json();

                    if (res.ok && data.success) {
                        if (data.item_id) { currentItemId = data.item_id; form.dataset.itemId = String(data.item_id); }
                        if (window.parent) {
                            if (window.parent.showFlashMessage) window.parent.showFlashMessage(data.message, 'success');
                            window.parent.dispatchEvent(new CustomEvent('content-management:refresh', {
                                detail: { scope: 'flashcard-item', setId: setId, itemId: currentItemId, action: form.dataset.itemId ? 'update' : 'create', targetTab: 'flashcards' }
                            }));
                            if (typeof window.parent.updateFlashcardCard === 'function') {
                                await window.parent.updateFlashcardCard(currentItemId, setId);
                            }
                            if (window.parent.closeModal) window.parent.closeModal();
                        }
                    } else {
                        if (data.errors) {
                            for (const field in data.errors) {
                                const el = form.querySelector(`[name="${field}"]`);
                                if (el) {
                                    el.classList.add('border-red-500');
                                    // Optional: Add text error
                                }
                            }
                        }
                        if (window.parent && window.parent.showFlashMessage) window.parent.showFlashMessage(data.message || 'Error', 'danger');
                    }
                } catch (err) {
                    console.error(err);
                    if (window.parent && window.parent.showFlashMessage) window.parent.showFlashMessage('Connection error', 'danger');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }
    });
    </script>
</body>

</html>
