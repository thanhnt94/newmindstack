<script>
    (function () {
        if (window.initializeFlashcardImageControls) {
            return;
        }

        window.initializeFlashcardImageControls = function initializeFlashcardImageControls(options) {
            const opts = options || {};
            const formElement = opts.form || (opts.formSelector ? document.querySelector(opts.formSelector) : null);
            if (!formElement) {
                return;
            }

            const searchUrl = opts.searchUrl || formElement.dataset.imageSearchUrl;
            if (!searchUrl) {
                return;
            }

            const fields = Array.from(formElement.querySelectorAll('[data-image-side]'));
            if (!fields.length) {
                return;
            }

            const csrfInput = formElement.querySelector('input[name="csrf_token"]');
            const csrfToken = csrfInput ? csrfInput.value : '';
            const imageBaseFolder = (formElement.dataset.imageBaseFolder || '').replace(/^\/+|\/+$/g, '');

            const getDefaultQuery = (field) => {
                const side = field.dataset.imageSide || 'front';
                const sourceId = side === 'back' ? formElement.dataset.backSourceId : formElement.dataset.frontSourceId;
                if (!sourceId) {
                    return '';
                }
                const sourceField = document.getElementById(sourceId);
                if (!sourceField) {
                    return '';
                }
                return (sourceField.value || '').trim();
            };

            fields.forEach(field => {
                const side = (field.dataset.imageSide || 'front').toLowerCase();
                const urlInput = field.querySelector('[data-role="image-path"]');
                const previewImg = field.querySelector('[data-role="image-preview"]');
                const placeholder = field.querySelector('[data-role="image-placeholder"]');
                const removeBtn = field.querySelector('[data-role="remove-image"]');
                const queryInput = field.querySelector('[data-role="image-query"]');
                const searchBtn = field.querySelector('[data-role="search-image"]');
                const errorLabel = field.querySelector('[data-role="image-error"]');
                const statusLabel = field.querySelector('[data-role="image-status"]');
                const loadingOverlay = field.querySelector('[data-role="image-loading"]');
                const openButton = field.querySelector('[data-role="open-image"]');
                const initialUrl = field.dataset.initialUrl || '';

                if (!urlInput || !searchBtn) {
                    return;
                }

                let currentPreviewUrl = '';

                const setStatus = (message, type) => {
                    if (!statusLabel) {
                        return;
                    }
                    statusLabel.textContent = message || '';
                    statusLabel.classList.remove('hidden', 'text-red-500', 'text-green-600', 'text-blue-600');
                    if (!message) {
                        statusLabel.classList.add('hidden');
                        return;
                    }
                    if (type === 'error') {
                        statusLabel.classList.add('text-red-500');
                    } else if (type === 'success') {
                        statusLabel.classList.add('text-green-600');
                    } else {
                        statusLabel.classList.add('text-blue-600');
                    }
                };

                const setLoading = (isLoading) => {
                    if (!loadingOverlay) {
                        return;
                    }
                    loadingOverlay.classList.toggle('hidden', !isLoading);
                };

                const setOpenButtonVisible = (visible) => {
                    if (!openButton) {
                        return;
                    }
                    openButton.classList.toggle('hidden', !visible);
                };

                const buildPreviewUrl = (value) => {
                    let raw = (value || '').trim();
                    if (!raw) {
                        return '';
                    }

                    if (/^(?:https?:)?\/\//i.test(raw) || raw.startsWith('data:')) {
                        return raw;
                    }

                    raw = raw.replace(/\\/g, '/');

                    if (raw.startsWith('/')) {
                        return raw;
                    }

                    const uploadsPrefix = 'uploads/';
                    if (raw.startsWith(uploadsPrefix)) {
                        raw = raw.slice(uploadsPrefix.length);
                    }

                    if (imageBaseFolder && !raw.includes('/')) {
                        raw = `${imageBaseFolder}/${raw}`;
                    }

                    return `/media/${raw}`;
                };

                const updatePreview = (url) => {
                    const hasUrl = Boolean(url);
                    if (previewImg) {
                        if (hasUrl) {
                            currentPreviewUrl = url;
                            previewImg.src = url;
                            previewImg.classList.remove('hidden');
                            setLoading(true);
                            setStatus('Đang tải hình ảnh...', 'info');
                        } else {
                            currentPreviewUrl = '';
                            previewImg.removeAttribute('src');
                            previewImg.classList.add('hidden');
                            setLoading(false);
                            setStatus('', '');
                        }
                    }
                    if (placeholder) {
                        placeholder.classList.toggle('hidden', hasUrl);
                    }
                    if (removeBtn) {
                        removeBtn.classList.toggle('hidden', !hasUrl);
                    }
                    if (!hasUrl) {
                        setOpenButtonVisible(false);
                    }
                };

                const syncPreviewWithInput = (overrideUrl) => {
                    if (typeof overrideUrl === 'string') {
                        updatePreview(overrideUrl);
                    } else {
                        updatePreview(buildPreviewUrl(urlInput.value));
                    }
                };

                if (previewImg) {
                    previewImg.addEventListener('load', () => {
                        setLoading(false);
                        if (previewImg.src) {
                            setStatus('Đã tải xem trước hình ảnh.', 'success');
                            setOpenButtonVisible(true);
                        } else {
                            setStatus('', '');
                            setOpenButtonVisible(false);
                        }
                    });
                    previewImg.addEventListener('error', () => {
                        setLoading(false);
                        previewImg.classList.add('hidden');
                        previewImg.removeAttribute('src');
                        if (placeholder) {
                            placeholder.classList.remove('hidden');
                        }
                        currentPreviewUrl = '';
                        setStatus('Không thể tải hình ảnh. Vui lòng kiểm tra đường dẫn.', 'error');
                        setOpenButtonVisible(false);
                    });
                }

                if (initialUrl) {
                    updatePreview(initialUrl);
                } else {
                    syncPreviewWithInput('');
                    setLoading(false);
                }

                ['input', 'change'].forEach(evtName => {
                    urlInput.addEventListener(evtName, () => {
                        syncPreviewWithInput();
                        if (errorLabel) {
                            errorLabel.textContent = '';
                            errorLabel.classList.add('hidden');
                        }
                    });
                });

                if (removeBtn) {
                    removeBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        urlInput.value = '';
                        syncPreviewWithInput('');
                        if (errorLabel) {
                            errorLabel.textContent = '';
                            errorLabel.classList.add('hidden');
                        }
                        setStatus('', '');
                        setOpenButtonVisible(false);
                    });
                }

                if (openButton) {
                    openButton.addEventListener('click', (event) => {
                        event.preventDefault();
                        const urlToOpen = currentPreviewUrl || buildPreviewUrl(urlInput.value);
                        if (!urlToOpen) {
                            setStatus('Chưa có hình ảnh để mở.', 'error');
                            return;
                        }
                        window.open(urlToOpen, '_blank', 'noopener');
                    });
                }

                searchBtn.addEventListener('click', async () => {
                    if (errorLabel) {
                        errorLabel.textContent = '';
                        errorLabel.classList.add('hidden');
                    }
                    setStatus('', '');

                    let query = queryInput ? queryInput.value.trim() : '';
                    if (!query) {
                        query = getDefaultQuery(field);
                        if (queryInput && query) {
                            queryInput.value = query;
                        }
                    }

                    if (!query) {
                        const message = 'Vui lòng nhập nội dung để tìm ảnh.';
                        if (errorLabel) {
                            errorLabel.textContent = message;
                            errorLabel.classList.remove('hidden');
                        }
                        setStatus(message, 'error');
                        if (queryInput) {
                            queryInput.focus();
                        }
                        return;
                    }

                    const originalHtml = searchBtn.dataset.originalHtml || searchBtn.innerHTML;
                    if (!searchBtn.dataset.originalHtml) {
                        searchBtn.dataset.originalHtml = originalHtml;
                    }
                    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    searchBtn.disabled = true;

                    try {
                        const response = await fetch(searchUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                                ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                            },
                            body: JSON.stringify({ side, query })
                        });

                        const result = await response.json();

                        if (response.ok && result && result.success && result.image_url) {
                            const storedValue = (typeof result.stored_value !== 'undefined') ? result.stored_value : result.relative_path;
                            urlInput.value = storedValue || '';
                            syncPreviewWithInput(result.image_url);
                        } else {
                            const message = (result && result.message) || 'Không tìm thấy ảnh phù hợp.';
                            if (errorLabel) {
                                errorLabel.textContent = message;
                                errorLabel.classList.remove('hidden');
                            }
                            setStatus(message, 'error');
                        }
                    } catch (error) {
                        console.error('Lỗi tìm ảnh minh họa:', error);
                        const message = 'Không thể kết nối đến máy chủ tìm kiếm ảnh.';
                        if (errorLabel) {
                            errorLabel.textContent = message;
                            errorLabel.classList.remove('hidden');
                        }
                        setStatus(message, 'error');
                    } finally {
                        searchBtn.innerHTML = searchBtn.dataset.originalHtml || originalHtml;
                        searchBtn.disabled = false;
                    }
                });
            });
        };
    })();
</script>