{# File: mindstack_app/templates/aura_mobile/pages/content_management/_index_mobile.html #}
{% from _v ~ '/includes/components/_mobile_components.html' import mobile_header, mobile_footer %}

<div class="flex flex-col h-screen w-full mobile-dashboard bg-slate-50"
    style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

    {# === CLEAN BACKGROUND === #}
    <div class="fixed inset-0 bg-gradient-to-b from-slate-50 to-slate-100 -z-10"></div>

    {# === FIXED TOP HEADER === #}
    {% call mobile_header(
    title='Quản lý nội dung',
    subtitle='CONTENT <span class="text-slate-300 mx-1">›</span> <span id="current-mode-label">VOCABULARY</span>'|safe,
    back_url=url_for('dashboard.dashboard')
    ) %}
    <div class="flex items-center gap-2">
        {# === SEARCH TOGGLE BUTTON === #}
        <button type="button" id="mobile-search-toggle-btn"
            class="w-9 h-9 rounded-xl bg-slate-200 flex items-center justify-center text-slate-600 hover:bg-slate-300 active:scale-95 transition-all"
            title="Tìm kiếm">
            <i class="fa-solid fa-magnifying-glass text-sm"></i>
        </button>

        {# === DYNAMIC ADD BUTTON === #}
        <button type="button" id="mobile-add-btn"
            class="open-modal-btn w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-white shadow-md active:scale-95 transition-all"
            data-modal-url="" title="Thêm mới">
            <i class="fa-solid fa-plus text-sm"></i>
        </button>
    </div>
    {% endcall %}

    {# === COLLAPSIBLE SEARCH BAR === #}
    <div id="mobile-search-bar" class="hidden px-5 py-3 bg-white border-b border-slate-200">
        <div id="mobile-search-form-container">
            {# Search form will be injected here by JavaScript based on active tab #}
            <div class="text-sm text-slate-400 text-center py-2">Đang tải form tìm kiếm...</div>
        </div>
    </div>

    {# === SCROLLABLE MAIN CONTENT === #}
    <div class="flex-grow overflow-y-auto overflow-x-hidden pb-16 no-scrollbar">
        <div id="mobile-tab-content" class="px-5 py-4 min-h-[300px]">
            <div class="flex flex-col items-center justify-center gap-4 text-slate-400 py-12">
                <div class="w-16 h-16 rounded-full bg-indigo-50 flex items-center justify-center">
                    <i class="fa-solid fa-rotate animate-spin text-indigo-400 text-2xl"></i>
                </div>
                <p class="text-sm font-medium text-slate-500">Đang tải nội dung...</p>
            </div>
        </div>
    </div>

    {# === FIXED PAGINATION BAR === #}
    <div id="mobile-fixed-pagination-bar"
        class="fixed bottom-[60px] left-0 right-0 z-[190] bg-white/95 backdrop-blur-sm border-t border-slate-100 px-2 py-2 hidden shadow-[0_-2px_10px_rgba(0,0,0,0.02)]">
        <div id="mobile-fixed-pagination-slot" class="w-full flex justify-center items-center">
            {# JS will move pagination here #}
        </div>
    </div>

    {# === FIXED BOTTOM TAB BAR === #}
    {% call mobile_footer() %}
    <div class="flex w-full h-[50px] bg-slate-100 rounded-2xl p-1 overflow-hidden relative border border-slate-200">
        <button id="mobile-tab-flashcards" data-target="flashcards"
            class="mobile-tab-btn flex-1 flex items-center justify-center gap-2 py-2 text-xs font-bold transition-all duration-300 rounded-xl relative z-10"
            aria-selected="false">
            <i class="fa-solid fa-clone"></i>
            <span>Vocab</span>
        </button>
        <button id="mobile-tab-quizzes" data-target="quizzes"
            class="mobile-tab-btn flex-1 flex items-center justify-center gap-2 py-2 text-xs font-bold transition-all duration-300 rounded-xl relative z-10"
            aria-selected="false">
            <i class="fa-solid fa-circle-question"></i>
            <span>Quiz</span>
        </button>
        <button id="mobile-tab-courses" data-target="courses"
            class="mobile-tab-btn flex-1 flex items-center justify-center gap-2 py-2 text-xs font-bold transition-all duration-300 rounded-xl relative z-10"
            aria-selected="false">
            <i class="fa-solid fa-book"></i>
            <span>Course</span>
        </button>
    </div>
    {% endcall %}
</div>

<style>
    /* Tab button states: Revert to Gradient Style */
    .mobile-tab-btn {
        background: transparent;
        color: #64748b;
        border: none;
        border-radius: 0;
    }

    .mobile-tab-btn[aria-selected="true"] {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        box-shadow: 0 -4px 15px -3px rgba(99, 102, 241, 0.3);
    }

    .mobile-tab-btn:hover:not([aria-selected="true"]) {
        background: #f1f5f9;
        color: #475569;
    }

    /* Hide scrollbar */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Ensure pagination controls fit in fixed bar */
    #mobile-fixed-pagination-slot .pagination,
    #mobile-fixed-pagination-slot>div {
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
    }

    /* Mobile-First Layout - Applied everywhere */
    body>header,
    body>nav,
    body>footer {
        display: none !important;
    }

    main.app-container {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
    }
</style>

<script>
    (function () {
        const coursesListUrl = "{{ url_for('content_management.content_management_courses.list_course_sets') }}";
        const flashcardSetsListUrl = "{{ url_for('content_management.content_management_flashcards.list_flashcard_sets') }}";
        const quizSetsListUrl = "{{ url_for('content_management.content_management_quizzes.list_quiz_sets') }}";

        // Add button URLs
        const addCourseUrl = "{{ url_for('content_management.content_management_courses.add_course_set') }}";
        const addFlashcardUrl = "{{ url_for('content_management.content_management_flashcards.add_flashcard_set') }}";
        const addQuizUrl = "{{ url_for('content_management.content_management_quizzes.add_quiz_set') }}";

        const mobileTabButtons = document.querySelectorAll('.mobile-tab-btn');
        const mobileTabContent = document.getElementById('mobile-tab-content');
        const currentModeLabel = document.getElementById('current-mode-label');
        const mobileAddBtn = document.getElementById('mobile-add-btn');
        const mobileSearchToggleBtn = document.getElementById('mobile-search-toggle-btn');
        const mobileSearchBar = document.getElementById('mobile-search-bar');

        // Pagination Elements
        const mobileFixedPaginationBar = document.getElementById('mobile-fixed-pagination-bar');
        const mobileFixedPaginationSlot = document.getElementById('mobile-fixed-pagination-slot');

        const validTabs = ['flashcards', 'quizzes', 'courses'];
        const SESSION_KEY = 'activeContentTab';
        let currentTab = 'flashcards';

        const modeLabelMap = { 'courses': 'COURSE', 'flashcards': 'VOCABULARY', 'quizzes': 'QUIZ' };
        const addUrlMap = { 'courses': addCourseUrl, 'flashcards': addFlashcardUrl, 'quizzes': addQuizUrl };

        // Search toggle functionality
        if (mobileSearchToggleBtn) {
            mobileSearchToggleBtn.addEventListener('click', function () {
                const isOpen = !mobileSearchBar.classList.contains('hidden');
                if (isOpen) {
                    mobileSearchBar.classList.add('hidden');
                    this.classList.remove('bg-gradient-to-br', 'from-indigo-500', 'to-violet-600', 'text-white', 'shadow-md');
                    this.classList.add('bg-slate-200', 'text-slate-600');
                } else {
                    mobileSearchBar.classList.remove('hidden');
                    this.classList.add('bg-gradient-to-br', 'from-indigo-500', 'to-violet-600', 'text-white', 'shadow-md');
                    this.classList.remove('bg-slate-200', 'text-slate-600');
                    setTimeout(() => {
                        const input = mobileSearchBar.querySelector('input[type="text"]');
                        if (input) input.focus();
                    }, 100);
                }
            });
        }

        // Search URL Map
        const searchUrlMap = {
            'courses': coursesListUrl,
            'flashcards': flashcardSetsListUrl,
            'quizzes': quizSetsListUrl
        };

        // Helper: Move Pagination to Fixed Bar
        function movePaginationToFixedBar() {
            if (!mobileFixedPaginationSlot || !mobileFixedPaginationBar) return;

            // Find existing pagination in content (support varied selectors)
            const paginationEl = mobileTabContent.querySelector('.pagination, nav[aria-label="Page navigation"], nav ul.pagination');

            mobileFixedPaginationSlot.innerHTML = ''; // Clear old

            if (paginationEl) {
                // Determine what to move (the container nav/div or clean UL)
                let target = paginationEl;
                // If it's a UL inside a Nav, take the Nav
                if (paginationEl.tagName === 'UL') {
                    const wrapper = paginationEl.closest('nav');
                    if (wrapper) target = wrapper;
                }
                // If it's the specific mobile pagination div wrapper
                if (paginationEl.classList.contains('pagination') && paginationEl.tagName === 'DIV') {
                    // This matches _pagination_mobile.html root
                    target = paginationEl;
                }

                mobileFixedPaginationSlot.appendChild(target);
                mobileFixedPaginationBar.classList.remove('hidden');
            } else {
                mobileFixedPaginationBar.classList.add('hidden');
            }
        }

        // Update Search Form UI
        function updateSearchForm(tabName) {
            const searchPlaceholderMap = {
                'courses': 'Tìm kiếm khóa học...',
                'flashcards': 'Tìm kiếm flashcard...',
                'quizzes': 'Tìm kiếm quiz...'
            };
            const mobileSearchFormContainer = document.getElementById('mobile-search-form-container');
            if (!mobileSearchFormContainer) return;

            const placeholder = searchPlaceholderMap[tabName] || 'Tìm kiếm...';
            const formHtml = `
                <form id="mobile-search-form" class="flex items-center gap-2 w-full bg-white p-2 rounded-xl border border-slate-200 shadow-sm relative z-20">
                    <div class="relative flex-shrink-0">
                        <select name="search_field" id="mobile-search-field"
                            class="appearance-none bg-slate-50 border-none text-slate-600 text-xs font-medium rounded-lg py-2 pl-3 pr-8 focus:ring-0 cursor-pointer">
                            <option value="title">Tiêu đề</option>
                            <option value="description">Mô tả</option>
                            <option value="tags">Thẻ</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-2 top-1/2 transform -translate-y-1/2 text-[10px] text-slate-400 pointer-events-none"></i>
                    </div>
                    <input type="text" name="q" id="mobile-search-input" placeholder="${placeholder}" 
                        class="flex-1 min-w-0 bg-transparent border-none text-slate-800 placeholder-slate-400 text-sm focus:ring-0 focus:outline-none px-2 py-1.5">
                    <button type="submit" class="flex-shrink-0 bg-indigo-500 text-white w-9 h-9 rounded-lg flex items-center justify-center hover:bg-indigo-600 active:scale-95 transition-all shadow-sm">
                        <i class="fa-solid fa-search text-sm"></i>
                    </button>
                </form>
            `;
            mobileSearchFormContainer.innerHTML = formHtml;

            // Re-attach listener
            const form = document.getElementById('mobile-search-form');
            if (form) {
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    // Basic search submission logic handled here or delegating to fetch
                    const query = document.getElementById('mobile-search-input').value;
                    const searchField = document.getElementById('mobile-search-field').value;

                    const baseUrl = searchUrlMap[currentTab];
                    const searchUrl = baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'q=' + encodeURIComponent(query) + '&search_field=' + searchField;

                    fetchAndUpdate(searchUrl);
                });
            }
        }

        // Global function to clear search and reload
        window.clearMobileSearch = function () {
            loadMobileTabContent(currentTab);
        };

        async function loadMobileTabContent(tabName) {
            currentTab = tabName;

            // Close search bar when switching tabs
            if (mobileSearchBar && !mobileSearchBar.classList.contains('hidden')) {
                mobileSearchBar.classList.add('hidden');
                if (mobileSearchToggleBtn) {
                    mobileSearchToggleBtn.classList.remove('bg-gradient-to-br', 'from-indigo-500', 'to-violet-600', 'text-white', 'shadow-md');
                    mobileSearchToggleBtn.classList.add('bg-slate-200', 'text-slate-600');
                }
            }

            // Update UI
            if (currentModeLabel) currentModeLabel.textContent = modeLabelMap[tabName] || tabName.toUpperCase();
            if (mobileAddBtn) mobileAddBtn.setAttribute('data-modal-url', addUrlMap[tabName] || '');

            // Update tabs
            mobileTabButtons.forEach(btn => {
                const isSelected = btn.dataset.target === tabName;
                btn.setAttribute('aria-selected', isSelected.toString());
            });

            // Show Loading
            mobileTabContent.innerHTML = `
                <div class="flex flex-col items-center justify-center gap-4 text-slate-400 py-12">
                    <div class="w-16 h-16 rounded-full bg-indigo-50 flex items-center justify-center">
                        <i class="fa-solid fa-rotate animate-spin text-indigo-400 text-2xl"></i>
                    </div>
                    <p class="text-sm font-medium text-slate-500">Đang tải ${modeLabelMap[tabName] || tabName}...</p>
                </div>`;

            // Hide Pagination during load
            if (mobileFixedPaginationBar) mobileFixedPaginationBar.classList.add('hidden');

            // Update Search Form for this tab
            updateSearchForm(tabName);

            // Get URL
            let url;
            if (tabName === 'courses') url = coursesListUrl;
            else if (tabName === 'flashcards') url = flashcardSetsListUrl;
            else if (tabName === 'quizzes') url = quizSetsListUrl;

            try {
                // Fetch content
                const response = await fetch(url + window.location.search, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const html = await response.text();
                mobileTabContent.innerHTML = html;

                // Move Pagination
                movePaginationToFixedBar();

            } catch (error) {
                console.error('Error loading tab:', error);
                mobileTabContent.innerHTML = '<div class="text-center p-4 text-red-500">Lỗi tải dữ liệu.</div>';
            }
        }

        async function fetchAndUpdate(url) {
            mobileTabContent.innerHTML = `
                <div class="flex flex-col items-center justify-center gap-4 py-12">
                    <i class="fa-solid fa-rotate animate-spin text-indigo-400 text-2xl"></i>
                </div>
            `;
            if (mobileFixedPaginationBar) mobileFixedPaginationBar.classList.add('hidden');

            try {
                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) throw new Error('Failed');
                mobileTabContent.innerHTML = await response.text();
                movePaginationToFixedBar();
            } catch (e) {
                mobileTabContent.innerHTML = '<p class="text-red-500 text-center py-8">Lỗi tải nội dung.</p>';
            }
        }

        // Window Refresh Event
        window.addEventListener('content-management:refresh', (event) => {
            const targetTab = event?.detail?.targetTab;
            if (targetTab && validTabs.includes(targetTab)) {
                loadMobileTabContent(targetTab);
            } else {
                loadMobileTabContent(currentTab);
            }
        });

        // Event Listeners
        mobileTabButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const target = this.dataset.target;
                if (target !== currentTab) {
                    sessionStorage.setItem(SESSION_KEY, target);
                    const url = new URL(window.location);
                    url.search = '';
                    history.pushState({}, '', url);
                    loadMobileTabContent(target);
                }
            });
        });

        // Pagination Clicks (Content + Fixed Bar)
        const handlePaginationClick = function (event) {
            const link = event.target.closest('a');
            if (link && link.href && link.href.includes('page=')) {
                event.preventDefault();
                fetchAndUpdate(link.href);
            }
        };

        mobileTabContent.addEventListener('click', handlePaginationClick);
        if (mobileFixedPaginationSlot) {
            mobileFixedPaginationSlot.addEventListener('click', handlePaginationClick);
        }

        // Search Form Submit (Delegated listener for safety)
        mobileTabContent.addEventListener('submit', function (event) {
            const form = event.target.closest('form');
            if (form && form.id !== 'mobile-search-form' && form.querySelector('input[name="q"]')) {
                event.preventDefault();
                const formData = new FormData(form);
                const url = new URL(form.action);
                url.searchParams.set('q', formData.get('q'));
                fetchAndUpdate(url.href);
            }
        });

        // Expose
        window.loadMobileTabContent = loadMobileTabContent;

        // Init
        const savedTab = sessionStorage.getItem(SESSION_KEY) || new URLSearchParams(window.location.search).get('tab');
        if (savedTab && validTabs.includes(savedTab)) {
            currentTab = savedTab;
        }
        loadMobileTabContent(currentTab);

    })();
</script>