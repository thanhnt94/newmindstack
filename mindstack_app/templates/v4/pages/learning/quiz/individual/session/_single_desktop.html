{# Desktop Interface Partial (Batch-Like Style) - UPDATED #}

<div class="hidden lg:block cm-shell quiz-shell">
    <div class="cm-container mx-auto px-4 max-w-7xl">

        {# === HEADER GROUP === #}
        <div class="quiz-section-header">
            <div class="cm-heading-group quiz-heading-group">
                <span class="text-sm font-bold text-blue-600 uppercase tracking-wider mb-1 block">Phiên học cá
                    nhân</span>
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Làm bài Quiz</h1>
                <p class="text-slate-500 max-w-2xl">Chọn đáp án chính xác nhất. Kết quả và giải thích chi tiết sẽ hiện
                    ra sau khi bạn trả lời.</p>
                <div class="mt-4">
                    <a href="/" class="text-slate-500 hover:text-blue-600 text-sm font-medium mr-4"><i
                            class="fa-solid fa-arrow-left"></i> Trang chủ</a>
                    <button id="desktop-exit-btn" class="text-red-500 hover:text-red-700 text-sm font-medium"><i
                            class="fa-solid fa-right-from-bracket"></i> Kết thúc phiên</button>
                </div>
            </div>

            {# === STATS CARD === #}
            <div class="quiz-progress-card">
                <div class="progress-card-header">
                    <div class="progress-card-title">
                        <span class="progress-card-icon"><i class="fas fa-chart-pie"></i></span>
                        <div class="flex flex-col">
                            <span class="progress-card-heading">Thống kê phiên</span>
                        </div>
                    </div>
                </div>

                <div class="progress-card-stats-grid">
                    <div class="progress-stat-item">
                        <span class="progress-stat-value js-stat-total">0</span>
                        <span class="progress-stat-label">Đã làm</span>
                    </div>
                    <div class="progress-stat-item">
                        <span class="progress-stat-value text-emerald-600 js-stat-correct">0</span>
                        <span class="progress-stat-label">Đúng</span>
                    </div>
                    <div class="progress-stat-item">
                        <span class="progress-stat-value text-blue-600 js-stat-accuracy">0%</span>
                        <span class="progress-stat-label">Chính xác</span>
                    </div>
                </div>

                <div class="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-1 flex justify-between">
                    <span>Tiến độ</span>
                    <span class="js-stat-progress-text">0/0</span>
                </div>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill js-stat-progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        {# === MAIN QUIZ CARD === #}
        <div class="cm-card cm-card--padded quiz-card">

            <div class="relative min-h-[400px]">
                <!-- Loading State -->
                <div class="absolute inset-0 flex flex-col items-center justify-center text-blue-500 js-quiz-loading">
                    <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                    <p>Đang tải câu hỏi...</p>
                </div>

                <!-- Question Content -->
                <div class="hidden js-quiz-content question-card">
                    <div class="question-meta">
                        <span class="js-question-header">Câu hỏi --</span>
                        <div class="ml-auto flex items-center gap-3">
                            {# --- MARKER BUTTON --- #}
                            <div class="inline-block relative marker-dropdown-container">
                                <button
                                    class="text-slate-400 hover:text-blue-500 transition text-lg js-quiz-marker-toggle"
                                    title="Đánh dấu câu hỏi">
                                    <i class="far fa-bookmark"></i>
                                </button>
                                <div
                                    class="marker-dropdown hidden absolute top-full right-0 z-50 bg-white border border-gray-200 rounded-xl shadow-lg p-2 min-w-[160px] flex flex-col gap-1 mt-1">
                                    <button
                                        class="flex items-center w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm transition-colors text-slate-700 js-quiz-mark-difficult"
                                        data-type="difficult"><i class="fas fa-fire text-orange-500 mr-2 w-4"></i>Khó
                                        (Difficult)</button>
                                    <button
                                        class="flex items-center w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm transition-colors text-slate-700 js-quiz-mark-ignored"
                                        data-type="ignored"><i class="fas fa-eye-slash text-slate-400 mr-2 w-4"></i>Bỏ
                                        qua
                                        (Ignore)</button>
                                    <button
                                        class="flex items-center w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm transition-colors text-slate-700 js-quiz-mark-favorite"
                                        data-type="favorite"><i class="fas fa-heart text-rose-500 mr-2 w-4"></i>Yêu
                                        thích</button>
                                </div>
                            </div>

                            {# --- TRANSCRIPT BUTTON --- #}
                            <button id="desktop-transcript-btn"
                                class="hidden text-slate-500 hover:text-blue-600 text-sm font-semibold transition flex items-center gap-1.5"
                                title="Xem hoặc dịch nội dung Audio">
                                <i class="fa-solid fa-file-lines"></i> <span>Transcript</span>
                            </button>
                            <a href="#" id="desktop-edit-btn"
                                class="hidden text-orange-500 hover:text-orange-700 text-sm font-semibold transition"
                                target="_blank">
                                <i class="fa-solid fa-pen-to-square"></i> Cập nhật
                            </a>
                        </div>
                    </div>

                    <h2 class="question-title js-question-text">--</h2>

                    <div class="mb-6 hidden js-question-media">
                        <!-- Media injected here -->
                    </div>

                    <div class="qb-options-grid js-options-grid">
                        <!-- Options injected here -->
                    </div>

                    <!-- Feedback Area (Desktop Inline) -->
                    <div class="hidden js-result-panel desktop-feedback-box">
                        <div class="text-2xl js-feedback-icon"></div>
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1 js-feedback-title">Title</h4>
                            <p class="text-sm hidden">Đáp án đúng: <span class="font-bold js-feedback-answer">--</span>
                            </p>

                            <!-- Detailed Explanation Block -->
                            <div id="desktop-explanation" class="hidden mt-4 pt-4 border-t border-black/10">
                                <h5 class="font-bold text-sm uppercase text-slate-500 mb-2">Giải thích chi tiết</h5>
                                <div id="desktop-explanation-content"
                                    class="markdown-body text-sm text-slate-800 leading-relaxed"></div>
                            </div>
                        </div>
                    </div>

                    <!-- BATCH-STYLE POST-ANSWER INSIGHTS (Hidden until answered) -->
                    <div id="desktop-insights-area" class="question-insights hidden">

                        <!-- Extra Info: Notes & AI -->
                        <div class="extra-info-area">
                            <!-- User Notes -->
                            <div class="info-section user-note-section">
                                <h4>
                                    <span><i class="fas fa-sticky-note text-yellow-500"></i> Ghi chú của bạn</span>
                                    <button id="desktop-note-edit-btn"
                                        class="hidden text-xs bg-blue-100 text-blue-600 border border-blue-200 px-3 py-1.5 rounded hover:bg-blue-200 font-medium">
                                        <i class="fa-solid fa-pencil"></i> Sửa ghi chú
                                    </button>
                                </h4>

                                <!-- Display Mode -->
                                <div id="desktop-note-display-mode" class="hidden">
                                    <div id="desktop-note-content"
                                        class="content-display min-h-[50px] text-slate-700 whitespace-pre-wrap"></div>
                                </div>

                                <!-- Edit Mode -->
                                <div id="desktop-note-edit-mode" class="hidden">
                                    <textarea id="desktop-note-input" class="note-textarea"
                                        placeholder="Ghi chú cho câu này..."></textarea>
                                    <div class="flex justify-end mt-2 gap-2">
                                        <button id="desktop-note-cancel"
                                            class="cm-btn bg-white hover:bg-slate-100 text-slate-600 border border-slate-300 py-1.5 px-4 text-sm rounded-md">Hủy</button>
                                        <button id="desktop-note-save"
                                            class="cm-btn bg-emerald-600 text-white hover:bg-emerald-700 py-1.5 px-4 text-sm rounded-md">Lưu
                                            ghi chú</button>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Explanation -->
                            <div class="info-section ai-explanation-section">
                                <h4>
                                    <span><i class="fas fa-robot text-blue-500"></i> Giải thích AI</span>
                                    <button id="desktop-ai-generate-btn"
                                        class="text-xs bg-blue-50 text-blue-600 border border-blue-200 px-2 py-1 rounded hover:bg-blue-100">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Tạo mới
                                    </button>
                                </h4>
                                <div id="desktop-ai-content"
                                    class="content-display markdown-body min-h-[50px] text-slate-500 italic">
                                    Chưa có giải thích từ AI. Nhấn nút "Tạo mới" để yêu cầu.
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- End Insights -->

                    <!-- Action Bar -->
                    <div class="desktop-action-bar">
                        <button type="button" id="desktop-action-btn" class="cm-btn cm-btn-primary px-8" disabled>
                            <i class="fa-solid fa-paper-plane"></i> Gửi đáp án
                        </button>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

{# === TRANSCRIPT MODAL === #}
<div id="transcript-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
    aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"
        id="transcript-modal-backdrop"></div>

    <div
        class="relative bg-white rounded-xl shadow-2xl transform transition-all sm:my-8 sm:w-full sm:max-w-xl mx-4 overflow-hidden flex flex-col max-h-[90vh]">
        {# Modal Header #}
        <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex items-center justify-between shadow-sm z-10">
            <h3 class="text-lg leading-6 font-bold text-slate-800 flex items-center gap-2" id="modal-title">
                <i class="fa-solid fa-file-audio text-blue-600"></i>
                Transcript
            </h3>
            <button type="button" id="close-transcript-modal"
                class="text-slate-400 hover:text-slate-600 transition focus:outline-none">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        {# Modal Body #}
        <div class="px-6 py-6 overflow-y-auto flex-1 bg-white relative">

            <div id="transcript-loading"
                class="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center text-blue-600 hidden">
                <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                <p class="font-medium animate-pulse">Đang chuyển đổi giọng nói thành văn bản...</p>
                <p class="text-xs text-slate-400 mt-2">Việc này có thể mất vài giây với audio dài.</p>
            </div>

            <!-- View Mode -->
            <div id="transcript-content"
                class="text-slate-700 text-base leading-relaxed whitespace-pre-wrap font-serif">
                <!-- Content will be injected here -->
            </div>

            <!-- Edit Mode -->
            <div id="transcript-edit-container" class="hidden">
                <textarea id="transcript-editor"
                    class="w-full h-64 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-serif text-base leading-relaxed"
                    placeholder="Nhập nội dung transcript..."></textarea>
            </div>

            <div id="transcript-empty" class="hidden text-center py-8 text-slate-400 flex flex-col items-center">
                <i class="fas fa-quote-right text-4xl mb-3 opacity-20"></i>
                <p>Chưa có nội dung transcript.</p>
            </div>

            <div id="transcript-error"
                class="hidden bg-red-50 text-red-700 p-4 rounded-lg flex items-start gap-3 border border-red-100">
                <i class="fas fa-exclamation-circle mt-0.5 shrink-0"></i>
                <div>
                    <h4 class="font-bold text-sm">Không thể lấy transcript</h4>
                    <p class="text-sm mt-1" id="transcript-error-msg">Lỗi kết nối.</p>
                </div>
            </div>
        </div>

        {# Modal Footer with Actions #}
        <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center rounded-b-2xl">
            <!-- Left: Status/Info -->
            <div class="text-xs text-slate-400 italic">
                AI Speech-to-Text
            </div>

            <!-- Right: Buttons -->
            <div class="flex items-center gap-2">
                <button type="button" id="transcript-edit-btn"
                    class="hidden text-blue-600 hover:text-blue-700 px-3 py-1.5 text-sm font-medium transition">
                    <i class="fas fa-pen mr-1"></i> Sửa
                </button>

                <div id="transcript-edit-actions" class="hidden flex items-center gap-2">
                    <button type="button" id="transcript-cancel-btn"
                        class="text-slate-500 hover:text-slate-700 px-3 py-1.5 text-sm font-medium transition">
                        Hủy
                    </button>
                    <button type="button" id="transcript-save-btn"
                        class="bg-blue-600 text-white hover:bg-blue-700 px-4 py-1.5 rounded-lg text-sm font-medium transition shadow-sm">
                        Lưu
                    </button>
                </div>

                <button type="button" onclick="document.getElementById('transcript-modal').classList.add('hidden')"
                    class="text-slate-500 hover:text-slate-700 px-4 py-2 rounded-lg transition"
                    id="transcript-close-main-btn">
                    Đóng
                </button>
            </div>
        </div>

        {# Modal Footer #}
        <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 flex justify-end gap-2">
            <button type="button" id="close-transcript-modal-btn"
                class="inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm">
                Đóng
            </button>
        </div>
    </div>
</div>