<!-- File: newmindstack/mindstack_app/modules/content_management/courses/templates/_courses_list.html -->
<!-- Phiên bản: 6.0 -->
<!-- ĐÃ TÁI THIẾT KẾ: Đồng bộ phong cách với giao diện Content Management mới. -->

{% from 'v3/includes/_search_form.html' import render_search_form %}
{% from 'v3/includes/_pagination.html' import render_pagination %}

<div class="w-full space-y-8">
    <div class="cm-section-header">
        <div class="cm-heading-group">
            <span class="cm-eyebrow">Kho kiến thức</span>
            <h2 class="cm-heading text-3xl">Khoá học của bạn</h2>
            <p class="cm-subheading">Quản lý cấu trúc bài học và quyền cộng tác nhanh chóng.</p>
        </div>
        <div class="cm-actions">
            <button type="button"
                data-modal-url="{{ url_for('content_management.content_management_courses.add_course_set') }}"
                class="open-modal-btn cm-action cm-action--primary">
                <i class="fas fa-plus-circle"></i>
                <span>Tạo khoá học mới</span>
            </button>
        </div>
    </div>

    <div class="cm-card cm-card--padded">
        {% set display_search_options = {
        'title': 'Tiêu đề',
        'description': 'Mô tả',
        'tags': 'Thẻ'
        } %}
        <div class="cm-search-header">
            <div class="cm-heading-group">
                <h3 class="text-lg font-semibold text-slate-800">Tìm kiếm nhanh</h3>
                <p class="cm-subheading text-sm">Chọn tiêu chí phù hợp để truy cập khoá học cần chỉnh sửa.</p>
            </div>
            <div class="w-full md:w-auto md:min-w-[320px]">
                {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm khóa học...",
                search_field=search_field, search_options=display_search_options) }}
            </div>
        </div>
    </div>

    {% if course_sets %}
    <div class="cm-grid cm-grid--three">
        {% for set in course_sets %}
        <article class="cm-collection-card">
            <div class="flex items-start justify-between gap-4">
                <div class="min-w-0 space-y-2">
                    <h3 class="truncate text-lg font-semibold text-slate-900">{{ set.title }}</h3>
                    <p class="line-clamp-2 text-sm text-slate-500">{{ set.description if set.description else 'Chưa có
                        mô tả cho khoá học này.' }}</p>
                </div>
                <span class="cm-icon-button" aria-hidden="true">
                    <i class="fa-solid fa-book"></i>
                </span>
            </div>

            <div class="cm-collection-meta">
                <span class="cm-tag">
                    <i class="fa-solid fa-tags text-slate-400"></i>
                    <span class="truncate max-w-[160px]" title="{{ set.tags if set.tags else 'Không có thẻ' }}">{{
                        set.tags if set.tags else 'Không có thẻ' }}</span>
                </span>
                <span class="cm-tag">
                    <i class="fa-solid fa-layer-group text-slate-400"></i>
                    <span>{{ set.item_count }} bài học</span>
                </span>
                <span class="cm-tag" title="{{ set.creator_display_name }}">
                    <i class="fa-solid fa-user-pen text-slate-400"></i>
                    <span>{{ set.creator_display_name }}</span>
                </span>
            </div>

            <div class="text-xs text-slate-500 flex items-center gap-2">
                <i class="fa-solid fa-user-shield text-slate-400"></i>
                <span class="font-semibold">Cộng tác:</span>
                <span class="truncate" title="{{ set.editor_display_names | join(', ') }}">{{ set.editor_display_names |
                    join(', ') }}</span>
            </div>

            <div class="cm-divider"></div>

            <div class="flex items-center justify-between">
                <a href="{{ url_for('content_management.content_management_courses.list_lessons', set_id=set.container_id) }}"
                    class="cm-link">
                    <span>Xem bài học</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </a>
                <div class="cm-inline-actions">
                    {% if current_user.user_role == 'admin' or set.creator_user_id == current_user.user_id or
                    (set.contributors and current_user.user_id in set.contributors|map(attribute='user_id')|list and
                    'editor' in set.contributors|selectattr('user_id', 'equalto',
                    current_user.user_id)|map(attribute='permission_level')|list) %}
                    <button type="button"
                        data-modal-url="{{ url_for('content_management.content_management_courses.edit_course_set', set_id=set.container_id) }}"
                        class="open-modal-btn cm-icon-button" title="Chỉnh sửa">
                        <i class="fas fa-pen"></i>
                    </button>
                    {% endif %}

                    {% if current_user.user_role != 'free' and (current_user.user_role == 'admin' or set.creator_user_id
                    == current_user.user_id) %}
                    <a href="{{ url_for('content_management.manage_contributors', container_id=set.container_id) }}"
                        class="cm-icon-button" title="Quản lý quyền">
                        <i class="fas fa-users"></i>
                    </a>
                    {% endif %}

                    {% if current_user.user_role == 'admin' or set.creator_user_id == current_user.user_id %}
                    <form
                        action="{{ url_for('content_management.content_management_courses.delete_course_set', set_id=set.container_id) }}"
                        method="post"
                        onsubmit="return confirm('Bạn có chắc chắn muốn xóa bộ khóa học này và tất cả các bài học của nó?');"
                        class="inline">
                        <button type="submit" class="cm-icon-button" title="Xoá khoá học">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </article>
        {% endfor %}
    </div>
    <div class="pt-4">
        {{ render_pagination(pagination=pagination, search_query=search_query, search_field=search_field) }}
    </div>
    {% else %}
    <div class="cm-empty">
        <span class="cm-empty-icon">
            <i class="fas fa-book"></i>
        </span>
        <h3 class="text-lg font-semibold text-slate-700">Bạn chưa có khoá học nào</h3>
        <p class="text-sm">Tạo khoá học đầu tiên để khởi động lộ trình kiến thức.</p>
    </div>
    {% endif %}
</div>