{# Speed Review Session Template #}
{% extends "v3/base.html" %}
{% block title %}Ôn nhanh - {{ container.title }}{% endblock %}
{% block head %}
{{ super() }}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #ef4444;
        --success: #10b981;
        --error: #ef4444;
        --bg: #f8fafc;
        --surface: #ffffff;
        --text-main: #0f172a;
        --timer-height: 6px;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--bg);
        margin: 0;
        min-height: 100vh;
        /* overflow: hidden; REMOVED to allow native scroll */
    }

    .speed-layout {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        width: 100%;
        position: relative;
    }

    /* Sticky Wrapper for Header + Timer */
    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 100;
        width: 100%;
        background: white;
        /* Ensure opaque */
    }

    /* --- Top Bar: Timer & Stats --- */
    .top-bar {
        background: white;
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        /* border-bottom: 1px solid #e2e8f0; Moved to timer container or wrapper if needed */
        height: 60px;
        box-sizing: border-box;
    }

    .lives-container {
        display: flex;
        gap: 0.25rem;
    }

    .life-heart {
        color: #e2e8f0;
        font-size: 1.25rem;
        transition: color 0.3s;
    }

    .life-heart.active {
        color: #ef4444;
        animation: pulse 1s infinite;
    }

    .score-badge {
        font-weight: 800;
        font-size: 1.1rem;
        color: var(--text-main);
    }

    /* Timer Bar */
    .timer-container {
        position: relative;
        /* Changed from absolute */
        top: 0;
        left: 0;
        width: 100%;
        height: var(--timer-height);
        background: #e2e8f0;
        z-index: 50;
    }

    .timer-bar {
        height: 100%;
        width: 100%;
        background: var(--primary);
        transform-origin: left;
        transition: width 0.1s linear;
    }

    /* Main Content */
    .main-area {
        /* Remove fixed height constraints to allow body scroll */
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        /* Massive padding to ensure nothing is hidden behind valid UI or edges */
        padding-bottom: 10rem;
        overflow-y: scroll;
        /* Force scrollbar validation */
        -webkit-overflow-scrolling: touch;
    }

    .question-card {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 100%;
        max-width: 600px;
        /* margin-bottom: 2rem; REMOVED */
        margin: 2rem auto;
        /* Auto margin for vertical centering when possible */
        margin-top: 1rem;
        border: 2px solid transparent;
        transition: border-color 0.2s;
        /* Scroll internal if long */
        max-height: 40vh;
        overflow-y: auto;
    }

    .q-text {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1.4;
    }

    /* Answer Grid */
    .answers-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        width: 100%;
        max-width: 600px;
    }

    .answer-btn {
        background: white;
        border: 1px solid #cbd5e1;
        border-radius: 12px;
        padding: 1.25rem;
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-main);
        cursor: pointer;
        transition: all 0.15s;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .answer-btn:hover:not(:disabled) {
        background: #f1f5f9;
        transform: translateY(-2px);
        border-color: #94a3b8;
    }

    .answer-btn.correct {
        background: #ecfdf5;
        border-color: var(--success);
        color: #065f46;
        font-weight: 700;
    }

    .answer-btn.wrong {
        background: #fef2f2;
        border-color: var(--error);
        color: #991b1b;
        opacity: 0.7;
    }

    /* Overlay for Feedback */
    .feedback-overlay {
        position: absolute;
        inset: 0;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 60;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .feedback-overlay.active {
        opacity: 1;
        backdrop-filter: blur(1px);
    }

    .feedback-icon {
        font-size: 5rem;
        text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* Modals */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .result-card {
        background: white;
        padding: 2.5rem;
        border-radius: 1.5rem;
        text-align: center;
        max-width: 320px;
        width: 90%;
    }

    .result-title {
        font-size: 2rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
    }

    .result-sub {
        color: #64748b;
        margin-bottom: 2rem;
    }

    .restart-btn {
        width: 100%;
        padding: 1rem;
        background: var(--primary);
        color: white;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        border: none;
        font-size: 1.1rem;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
        }
    }

    @keyframes shrink {
        from {
            width: 100%;
        }

        to {
            width: 0%;
        }
    }

    /* Stats Grid in Modal */
    .result-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin: 1.5rem 0;
        width: 100%;
    }

    .stat-item {
        background: #f8fafc;
        padding: 0.75rem;
        border-radius: 12px;
        text-align: center;
        border: 1px solid #e2e8f0;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--text-main);
    }

    .stat-value.score {
        color: var(--primary);
    }

    .stat-value.time {
        color: #3b82f6;
    }

    .stat-value.wrong {
        color: #ef4444;
    }

    .stat-value.avg {
        color: #8b5cf6;
    }
</style>
{% endblock %}

{% block content %}
<div class="speed-layout">
    <!-- Sticky Header Wrapper -->
    <div class="sticky-header">
        <!-- Top Bar -->
        <div class="top-bar">
            <a href="{{ url_for('learning.vocabulary.dashboard') }}" style="color:#64748b; text-decoration:none;"><i
                    class="fas fa-times"></i></a>
            <div class="lives-container" id="lives-display">
                <!-- Hearts injected by JS -->
            </div>
            <div class="score-badge"><span id="curr-q">1</span>/<span id="total-q">--</span></div>
        </div>

        <!-- Timer -->
        <div class="timer-container">
            <div class="timer-bar" id="timer-bar"></div>
        </div>
    </div>

    <!-- Main -->
    <div class="main-area">
        <div class="question-card" id="q-card">
            <div class="q-text" id="q-text">Đang tải câu hỏi...</div>
        </div>

        <div class="answers-grid" id="answers-grid">
            <!-- Buttons injected by JS -->
        </div>
    </div>

    <!-- Feedback Overlay -->
    <div class="feedback-overlay" id="fb-overlay">
        <div class="feedback-icon" id="fb-icon"></div>
    </div>
</div>

<!-- Game Over Modal -->
<div class="modal-overlay" id="end-modal">
    <div class="result-card">
        <div class="result-title" id="end-title">Game Over</div>
        <div class="result-sub" id="end-msg">Bạn đã hết mạng!</div>

        <div class="result-stats">
            <div class="stat-item">
                <div class="stat-label">Thời gian</div>
                <div class="stat-value time" id="stat-time">00:00</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Tốc độ TB</div>
                <div class="stat-value avg" id="stat-avg">0s</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Sai</div>
                <div class="stat-value wrong" id="stat-wrong">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Điểm số</div>
                <div class="stat-value score" id="stat-score">0</div>
            </div>
        </div>

        <button class="restart-btn" onclick="location.reload()">Chơi lại</button>
        <a href="{{ url_for('learning.vocabulary.dashboard') }}"
            style="display:block; margin-top:1rem; color:#64748b; font-weight:600; text-decoration:none;">Thoát</a>
    </div>
</div>

<div id="session-data" data-set-id="{{ container.container_id }}" data-count="{{ count }}" data-time="{{ time_limit }}"
    data-lives="{{ lives }}" data-custom-pairs='{{ custom_pairs|tojson if custom_pairs else "null" }}'
    data-choices="{{ choices }}" style="display:none"></div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function () {
        // Config
        var dataEl = document.getElementById('session-data');
        var setId = dataEl.dataset.setId;
        var count = parseInt(dataEl.dataset.count);
        var timeLimit = parseInt(dataEl.dataset.time); // seconds
        var maxLives = dataEl.dataset.lives; // '3', '5', 'inf'
        var customPairs = JSON.parse(dataEl.dataset.customPairs || 'null');
        var choicesNum = parseInt(dataEl.dataset.choices);

        // State
        var questions = [];
        var currentIdx = 0;
        var lives = (maxLives === 'inf') ? 999 : parseInt(maxLives);
        var isGameOver = false;
        var timerInterval = null;
        var timeLeft = 0; // ms
        var startTime = 0;

        // Stats
        var sessionStartTimestamp = 0;
        var totalScore = 0;
        var correctCount = 0;
        var wrongCount = 0;

        // UI
        var livesContainer = document.getElementById('lives-display');
        var timerBar = document.getElementById('timer-bar');
        var qText = document.getElementById('q-text');
        var answersGrid = document.getElementById('answers-grid');
        var fbOverlay = document.getElementById('fb-overlay');
        var fbIcon = document.getElementById('fb-icon');
        /** @type {HTMLElement} */
        var endModal = document.getElementById('end-modal');

        // Init
        initLives();
        fetchQuestions();

        function initLives() {
            livesContainer.innerHTML = '';
            if (maxLives === 'inf') {
                livesContainer.innerHTML = '<i class="fas fa-infinity life-heart active" style="color:#ef4444"></i>';
                return;
            }
            for (var i = 0; i < lives; i++) {
                var h = document.createElement('i');
                h.className = 'fas fa-heart life-heart active';
                livesContainer.appendChild(h);
            }
        }

        function updateLivesUI() {
            if (maxLives === 'inf') return;
            var hearts = livesContainer.querySelectorAll('.life-heart');
            // Update active state
            hearts.forEach((h, i) => {
                if (i < lives) h.classList.add('active');
                else h.classList.remove('active');
            });
        }

        function fetchQuestions() {
            var url = '/learn/vocabulary/speed/api/items/' + setId + '?count=' + count + '&choices=' + choicesNum;
            if (customPairs) url += '&custom_pairs=' + encodeURIComponent(JSON.stringify(customPairs));

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.questions.length > 0) {
                        questions = data.questions;
                        document.getElementById('total-q').textContent = questions.length;
                        sessionStartTimestamp = Date.now();
                        startQuestion(0);
                    } else {
                        qText.textContent = "Không đủ dữ liệu câu hỏi.";
                    }
                })
                .catch(err => { console.error(err); qText.textContent = "Lỗi kết nối."; });
        }

        function startQuestion(idx) {
            if (isGameOver) return;
            if (idx >= questions.length) {
                endGame(true);
                return;
            }
            currentIdx = idx;
            document.getElementById('curr-q').textContent = idx + 1;

            // Render UI
            var q = questions[idx];
            qText.textContent = q.question;
            answersGrid.innerHTML = '';

            q.choices.forEach((choice, i) => {
                var btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = choice;
                btn.onclick = () => handleAnswer(i);
                answersGrid.appendChild(btn);
            });

            // Start Timer
            startTimer();
            startTime = Date.now();
        }

        function startTimer() {
            clearInterval(timerInterval);
            var duration = timeLimit * 1000;
            var end = Date.now() + duration;

            // Reset Animation
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            // Force reflow
            void timerBar.offsetWidth;

            // Start CSS transition
            timerBar.style.transition = 'width ' + timeLimit + 's linear';
            timerBar.style.width = '0%';

            timerInterval = setInterval(() => {
                var now = Date.now();
                if (now >= end) {
                    clearInterval(timerInterval);
                    handleTimeOut();
                }
            }, 100);
        }

        function handleAnswer(choiceIdx) {
            try {
                clearInterval(timerInterval);
                timerBar.style.transition = 'none'; // stop anim

                var q = questions[currentIdx];
                var btns = answersGrid.querySelectorAll('.answer-btn');
                btns.forEach(b => b.disabled = true); // Lock input

                var isCorrect = (choiceIdx === q.correct_index);
                var durationMs = Date.now() - startTime;

                // UI Feedback
                if (isCorrect) {
                    btns[choiceIdx].classList.add('correct');
                    scoreUpdate(true);
                    submitResult(q.item_id, true, durationMs, q.choices[choiceIdx]);
                    setTimeout(() => nextQ(), 500); // Fast transition
                } else {
                    btns[choiceIdx].classList.add('wrong');
                    btns[q.correct_index].classList.add('correct'); // Show correct
                    scoreUpdate(false);
                    // Check lives
                    if (maxLives !== 'inf') {
                        lives--;
                        updateLivesUI();
                        if (lives <= 0) {
                            endGame(false);
                            return; // Stop flow
                        }
                    }

                    submitResult(q.item_id, false, durationMs, q.choices[choiceIdx]);
                    if (!isGameOver) setTimeout(() => nextQ(), 1500);
                }
            } catch (err) {
                alert("Lỗi xử lý câu trả lời: " + err.message);
                console.error(err);
            }
        }

        function handleTimeOut() {
            try {
                var q = questions[currentIdx];
                var btns = answersGrid.querySelectorAll('.answer-btn');
                btns.forEach(b => b.disabled = true);

                // Show correct
                btns[q.correct_index].classList.add('correct');

                scoreUpdate(false);

                var isDead = false;
                if (maxLives !== 'inf') {
                    lives--;
                    updateLivesUI();
                    if (lives <= 0) {
                        endGame(false);
                        isDead = true;
                    }
                }

                submitResult(q.item_id, false, timeLimit * 1000, "TIME_OUT");
                if (!isGameOver && !isDead) setTimeout(() => nextQ(), 1500);
            } catch (err) {
                alert("Lỗi xử lý hết giờ: " + err.message);
            }
        }

        function loseLife() {
            if (maxLives !== 'inf') {
                lives--;
                updateLivesUI();
                if (lives <= 0) {
                    endGame(false);
                }
            }
        }

        function nextQ() {
            startQuestion(currentIdx + 1);
        }

        function endGame(isWin) {
            try {
                isGameOver = true;
                // Force display via style to override anything
                endModal.style.display = 'flex';
                endModal.classList.add('active');

                var title = document.getElementById('end-title');
                var msg = document.getElementById('end-msg');

                // Calculate Stats safely
                var sessionDuration = Date.now() - (sessionStartTimestamp || Date.now());
                var totalQ = (correctCount || 0) + (wrongCount || 0);
                var avgTime = totalQ > 0 ? (sessionDuration / totalQ / 1000).toFixed(1) : "0.0";

                // Format Time MM:SS
                var seconds = Math.floor(sessionDuration / 1000);
                var minutes = Math.floor(seconds / 60);
                seconds = seconds % 60;
                var timeStr = (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);

                if (document.getElementById('stat-time')) document.getElementById('stat-time').textContent = timeStr;
                if (document.getElementById('stat-avg')) document.getElementById('stat-avg').textContent = avgTime + 's';
                if (document.getElementById('stat-wrong')) document.getElementById('stat-wrong').textContent = (wrongCount || 0);
                if (document.getElementById('stat-score')) document.getElementById('stat-score').textContent = (totalScore || 0);

                if (isWin) {
                    title.textContent = "Hoàn thành!";
                    title.style.color = "var(--success)";
                    msg.textContent = "Bạn đã hoàn thành bài ôn tập!";
                } else {
                    title.textContent = "Hết mạng!";
                    title.style.color = "var(--error)";
                    msg.textContent = "Bạn đã hết số mạng cho phép.";
                }
            } catch (e) {
                console.error("EndGame Error:", e);
                alert("Game Over! (Error showing stats: " + e.message + ")");
                // Fallback redirect
                window.location.href = "{{ url_for('learning.vocabulary.dashboard') }}";
            }
        }

        function scoreUpdate(isCorrect) {
            if (isCorrect) {
                correctCount++;
                totalScore += 10;
            } else {
                wrongCount++;
            }
        }

        function submitResult(itemId, isCorrect, duration, answerText) {
            fetch('/learn/vocabulary/speed/api/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_id: itemId,
                    correct_index: questions[currentIdx].correct_index, // pass for verification
                    user_answer_index: -1, // Not strict
                    user_answer_text: answerText,
                    duration_ms: duration,
                    is_correct: isCorrect // Speed logic overrides
                })
            });
        }

        /*
        function showFeedback(success) {
            fbIcon.className = success ? 'fas fa-check-circle' : 'fas fa-times-circle';
            fbIcon.style.color = success ? 'var(--success)' : 'var(--error)';
            fbOverlay.classList.add('active');
            setTimeout(() => fbOverlay.classList.remove('active'), 500);
        }
        */

    })();
</script>
{% endblock %}