{# Reusable Item Stats Modal #}
<div id="item-stats-modal" class="vocab-modal" style="display: none;">
    <div class="vocab-modal-overlay js-close-stats-modal"></div>
    <div class="vocab-modal-content">
        <button class="vocab-modal-close js-close-stats-modal">
            <i class="fas fa-times"></i>
        </button>
        <div id="item-stats-container" class="vocab-modal-body">
            <!-- Content loaded here -->
        </div>
    </div>
</div>

<style>
    /* Stats Modal Styles */
    .vocab-modal {
        position: fixed;
        inset: 0;
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        box-sizing: border-box;
    }

    .vocab-modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
    }

    .vocab-modal-content {
        position: relative;
        width: 100%;
        max-width: 450px;
        max-height: 88vh;
        /* Fallback */
        max-height: 88dvh;
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: vocabScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        margin: auto;
        /* Ensure centering */
    }

    .vocab-modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10;
    }

    .vocab-modal-close:hover {
        background: #e2e8f0;
        color: #ef4444;
    }

    .vocab-modal-body {
        padding: 0;
        flex: 1;
        background: #f8fafc;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @keyframes vocabScaleIn {
        from {
            transform: scale(0.95);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<script>
    (function () {
        // Use a slight delay to ensure DOM is ready if injected via AJAX, 
        // but here it's usually static include.
        const initModal = () => {
            const statsModal = document.getElementById('item-stats-modal');
            const statsContainer = document.getElementById('item-stats-container');
            const closeBtns = document.querySelectorAll('.js-close-stats-modal');

            if (closeBtns) {
                closeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        if (statsModal) statsModal.style.display = 'none';
                    });
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && statsModal && statsModal.style.display !== 'none') {
                    statsModal.style.display = 'none';
                }
            });

            window.openVocabularyItemStats = function (itemId) {
                if (!statsModal || !statsContainer) {
                    console.error("Modal elements not found");
                    return;
                }

                statsModal.style.display = 'flex';
                statsContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 16rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6366f1;"></i></div>';

                fetch('/learn/vocabulary/item/' + itemId + '/stats?modal=true&_cb=' + new Date().getTime())
                    .then(function (r) { return r.text(); })
                    .then(function (html) {
                        statsContainer.innerHTML = html;
                        // Initialize tab switching
                        if (window.initStatsModalTabs) window.initStatsModalTabs();
                    })
                    .catch(function (err) {
                        console.error("Stats load error:", err);
                        statsContainer.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 16rem; color: #94a3b8;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><span>Không thể tải thống kê</span></div>';
                    });
            };

            // Tab switching logic
            window.initStatsModalTabs = function () {
                const modalContainer = document.getElementById('item-stats-container');
                if (!modalContainer) return;

                const tabBtns = modalContainer.querySelectorAll('.tab-btn');
                const tabContents = modalContainer.querySelectorAll('.tab-content');

                tabBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const targetTab = this.dataset.tab;
                        tabBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');

                        tabContents.forEach(content => {
                            if (content.id === 'tab-' + targetTab) {
                                content.style.display = 'block';
                                content.classList.add('active');
                            } else {
                                content.style.display = 'none';
                                content.classList.remove('active');
                            }
                        });
                    });
                });
            };

            // [NEW] Sub-tab switching logic
            // [NEW] Sub-tab switching logic
            window.switchSubTab = function (targetId) {
                // Search in the whole stats container or body (since buttons are now in header)
                const container = document.querySelector('.stats-container') || document.body;

                // Hide all sub-tabs content
                container.querySelectorAll('.sub-tab-content').forEach(el => {
                    el.style.display = 'none';
                    el.classList.remove('active');
                });

                // Remove active class from ALL sub-tab buttons
                container.querySelectorAll('.sub-tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Show target content
                const target = document.getElementById(targetId);
                if (target) {
                    target.style.display = 'block';
                    target.classList.add('active');
                }

                // Activate the specific button
                const btns = container.querySelectorAll('.sub-tab-btn');
                btns.forEach(btn => {
                    const onclickVal = btn.getAttribute('onclick');
                    if (onclickVal && onclickVal.includes("'" + targetId + "'")) {
                        btn.classList.add('active');
                    }
                });
            };

            // [NEW] Save Note Logic
            window.saveItemNote = function (itemId) {
                const btn = document.getElementById('save-note-btn');
                const input = document.getElementById('item-note-input');
                if (!btn || !input) return;

                const originalText = btn.innerHTML;

                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

                // Try to get CSRF token from meta tag first, usually safer for static JS
                let csrfToken = '';
                const meta = document.querySelector('meta[name="csrf-token"]');
                if (meta) csrfToken = meta.getAttribute('content');

                fetch('/api/progress/' + itemId + '/note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ note: input.value })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            btn.innerHTML = '<i class="fas fa-check"></i> Đã lưu';
                            btn.style.background = '#10b981';
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.style.background = '#4f46e5';
                                btn.disabled = false;
                            }, 2000);
                        } else {
                            alert('Lỗi: ' + data.message);
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Lỗi kết nối');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    });
            };

            // [NEW] Generate AI Explanation Logic
            window.generateAIExplanation = function (itemId) {
                const btn = document.getElementById('generate-ai-btn');
                const contentBox = document.getElementById('ai-content-box');
                const placeholder = document.getElementById('ai-placeholder');

                if (!btn) return;
                const originalText = btn.innerHTML;

                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';

                let csrfToken = '';
                const meta = document.querySelector('meta[name="csrf-token"]');
                if (meta) csrfToken = meta.getAttribute('content');

                fetch('/api/item/' + itemId + '/generate-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            // Update UI with new content
                            if (placeholder) placeholder.style.display = 'none';
                            if (contentBox) {
                                contentBox.style.display = 'block';
                                contentBox.innerHTML = '<div style="white-space: pre-wrap;">' + data.explanation + '</div>';
                            } else {
                                // Reload modal content if structure is complex, but simple update is better
                                // If content box didn't exist (because if/else blocks in template), we might need to reload.
                                // However, we can structure the template to always have a box.
                                // For now, let's assume we reload the stats modal content by re-fetching.
                                // But cleaner is to reload. Let's try to just update innerHTML of tab-ai.
                                const tabAi = document.querySelector('#sub-ai');
                                if (tabAi) {
                                    tabAi.innerHTML = '<div class="ai-content-box" style="line-height: 1.6; color: #334155; font-size: 0.95rem;"><div style="white-space: pre-wrap;">' + data.explanation + '</div></div>';
                                }
                            }
                        } else {
                            alert('Lỗi: ' + data.message);
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Lỗi kết nối: ' + err);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    });
            };
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initModal);
        } else {
            initModal();
        }
    })();
</script>