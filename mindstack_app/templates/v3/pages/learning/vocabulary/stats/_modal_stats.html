{# Reusable Item Stats Modal #}
<div id="item-stats-modal" class="vocab-modal" style="display: none;">
    <div class="vocab-modal-overlay js-close-stats-modal"></div>
    <div class="vocab-modal-content">
        <button class="vocab-modal-header-btn edit-btn js-edit-item-stats" title="Chỉnh sửa thẻ"
            style="display: none; left: 1rem; right: auto;">
            <i class="fas fa-edit"></i>
        </button>
        <button class="vocab-modal-close js-close-stats-modal">
            <i class="fas fa-times"></i>
        </button>
        <div id="item-stats-container" class="vocab-modal-body">
            <!-- Content loaded here -->
        </div>
    </div>
</div>

<!-- Edit Overlay Modal (appears on top of stats modal) -->
<div id="vocab-edit-overlay-modal" class="vocab-edit-overlay" style="display: none;">
    <div class="vocab-edit-overlay-bg" onclick="closeVocabEditOverlay()"></div>
    <div class="vocab-edit-overlay-content">
        <div class="vocab-edit-overlay-header">
            <span class="vocab-edit-overlay-title">Chỉnh sửa thẻ</span>
            <button class="vocab-edit-overlay-close" onclick="closeVocabEditOverlay()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="vocab-edit-overlay-body">
            <iframe id="vocab-edit-iframe" src="" frameborder="0"></iframe>
            <div id="vocab-edit-loading" class="vocab-edit-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Đang tải...</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Stats Modal Styles */
    .vocab-modal {
        position: fixed;
        inset: 0;
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        box-sizing: border-box;
    }

    .vocab-modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
    }

    .vocab-modal-content {
        position: relative;
        width: 100%;
        max-width: 450px;
        max-height: 88vh;
        /* Fallback */
        max-height: 88dvh;
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: vocabScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        margin: auto;
        /* Ensure centering */
    }

    .vocab-modal-close,
    .vocab-modal-header-btn {
        position: absolute;
        top: 1rem;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10;
    }

    .vocab-modal-close {
        right: 1rem;
    }

    .vocab-modal-header-btn:hover,
    .vocab-modal-close:hover {
        background: #e2e8f0;
    }

    .vocab-modal-close:hover {
        color: #ef4444;
    }

    .edit-btn:hover {
        color: #4f46e5;
    }

    .vocab-modal-body {
        padding: 0;
        flex: 1;
        background: #f8fafc;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @keyframes vocabScaleIn {
        from {
            transform: scale(0.95);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Edit Overlay Modal Styles */
    .vocab-edit-overlay {
        position: fixed;
        inset: 0;
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .vocab-edit-overlay-bg {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
    }

    .vocab-edit-overlay-content {
        position: relative;
        width: 95%;
        max-width: 900px;
        height: 90vh;
        max-height: 90dvh;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: vocabScaleIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 1;
    }

    .vocab-edit-overlay-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        flex-shrink: 0;
    }

    .vocab-edit-overlay-title {
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
    }

    .vocab-edit-overlay-close {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
    }

    .vocab-edit-overlay-close:hover {
        background: #fee2e2;
        color: #ef4444;
    }

    .vocab-edit-overlay-body {
        flex: 1;
        position: relative;
        overflow: hidden;
    }

    .vocab-edit-overlay-body iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .vocab-edit-loading {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: white;
        color: #6366f1;
        font-size: 1rem;
        gap: 0.75rem;
    }

    .vocab-edit-loading i {
        font-size: 2rem;
    }
</style>

<script>
    (function () {
        // [EDIT OVERLAY FUNCTIONS]
        window.openVocabEditOverlay = function (editUrl) {
            const overlay = document.getElementById('vocab-edit-overlay-modal');
            const iframe = document.getElementById('vocab-edit-iframe');
            const loading = document.getElementById('vocab-edit-loading');
            if (!overlay || !iframe) return;

            overlay.style.display = 'flex';
            if (loading) loading.style.display = 'flex';
            iframe.style.visibility = 'hidden';
            iframe.src = editUrl;

            iframe.onload = function () {
                if (loading) loading.style.display = 'none';
                iframe.style.visibility = 'visible';
            };
        };

        window.closeVocabEditOverlay = function () {
            const overlay = document.getElementById('vocab-edit-overlay-modal');
            const iframe = document.getElementById('vocab-edit-iframe');
            if (overlay) overlay.style.display = 'none';
            if (iframe) iframe.src = '';
        };

        // [GLOBAL FUNCTIONS] Defined early for inline onclicks
        window.toggleNoteEdit = function (showEdit) {
            const displayMode = document.getElementById('note-display-mode');
            const editMode = document.getElementById('note-edit-mode');
            if (displayMode && editMode) {
                displayMode.style.display = showEdit ? 'none' : 'block';
                editMode.style.display = showEdit ? 'block' : 'none';
                if (showEdit) {
                    const input = document.getElementById('item-note-input');
                    if (input) input.focus();
                }
            }
        };

        window.toggleSubTabs = function (show) {
            const el = document.getElementById('header-sub-tabs');
            if (el) el.style.display = show ? 'flex' : 'none';
            const histBar = document.getElementById('history-detail-bar');
            if (histBar) histBar.style.display = 'none';
        };

        window.switchSubTab = function (targetId) {
            const container = document.querySelector('.stats-container') || document.body;
            container.querySelectorAll('.sub-tab-content').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            container.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const target = document.getElementById(targetId);
            if (target) {
                target.style.display = 'block';
                target.classList.add('active');
            }
            const btns = container.querySelectorAll('.sub-tab-btn');
            btns.forEach(btn => {
                const onclickVal = btn.getAttribute('onclick');
                if (onclickVal && onclickVal.includes("'" + targetId + "'")) {
                    btn.classList.add('active');
                }
            });
        };

        window.initStatsModalTabs = function () {
            const modalContainer = document.getElementById('item-stats-container');
            if (!modalContainer) return;

            const tabBtns = modalContainer.querySelectorAll('.tab-btn');
            const tabContents = modalContainer.querySelectorAll('.tab-content');
            const histBar = document.getElementById('history-detail-bar');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const targetTab = this.dataset.tab;
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    tabContents.forEach(content => {
                        if (content.id === 'tab-' + targetTab) {
                            content.style.display = 'block';
                            content.classList.add('active');
                        } else {
                            content.style.display = 'none';
                            content.classList.remove('active');
                        }
                    });

                    const isNộiDung = targetTab === 'content';
                    const subTabs = document.getElementById('header-sub-tabs');
                    if (subTabs) subTabs.style.display = isNộiDung ? 'flex' : 'none';

                    const isDetails = targetTab === 'details';
                    if (histBar) histBar.style.display = isDetails ? 'flex' : 'none';

                    if (isDetails) {
                        const items = document.querySelectorAll('.js-history-item');
                        if (items.length > 0 && !document.querySelector('.js-history-item.active')) {
                            selectHistoryItem(items[0], 0);
                        }
                    }
                });
            });
        };

        window.selectHistoryItem = function (el, idx) {
            const container = document.querySelector('.stats-container');
            if (!container) return;

            let historyData = [];
            try {
                historyData = JSON.parse(container.dataset.history || '[]');
            } catch (e) { console.error("History parse error", e); }

            document.querySelectorAll('.js-history-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');

            const log = historyData[idx];
            if (!log) return;

            const histBar = document.getElementById('history-detail-bar');
            const histTime = document.getElementById('hist-time');
            const histResult = document.getElementById('hist-result');

            if (histBar) histBar.style.display = 'flex';
            if (histTime) {
                const date = new Date(log.timestamp);
                histTime.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString();
            }

            const histModeBadge = document.getElementById('hist-mode-badge');
            if (histModeBadge) histModeBadge.textContent = log.mode || 'Flashcard';

            if (histResult) {
                histResult.textContent = log.result === 'Correct' ? 'ĐÚNG' : 'SAI';
                histResult.style.background = log.result === 'Correct' ? '#dcfce7' : '#fee2e2';
                histResult.style.color = log.result === 'Correct' ? '#16a34a' : '#dc2626';
            }

            const histDuration = document.getElementById('hist-duration');
            const histScore = document.getElementById('hist-score');
            const histMastery = document.getElementById('hist-mastery');

            if (histDuration) histDuration.textContent = log.duration_ms ? (log.duration_ms / 1000).toFixed(1) + 's' : '-';
            if (histScore) histScore.textContent = (log.score_change > 0 ? '+' : '') + (log.score_change || 0);
            if (histMastery) histMastery.textContent = (log.mastery_snapshot ? Math.round(log.mastery_snapshot * 100) : 0) + '%';
        };

        window.saveItemNote = function (itemId) {
            const btn = document.getElementById('save-note-btn');
            const input = document.getElementById('item-note-input');
            if (!btn || !input) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

            let csrfToken = '';
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) csrfToken = meta.getAttribute('content');

            fetch('/learn/vocabulary/api/progress/' + itemId + '/note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ note: input.value })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        btn.innerHTML = '<i class="fas fa-check"></i> Đã lưu';
                        btn.style.background = '#10b981';
                        const staticContent = document.getElementById('note-static-content');
                        if (staticContent) staticContent.textContent = input.value || "Chưa có ghi chú nào.";
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '#4f46e5';
                            btn.disabled = false;
                            toggleNoteEdit(false);
                        }, 1000);
                    } else {
                        alert('Lỗi: ' + data.message);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi kết nối');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        };

        window.generateAIExplanation = function (itemId) {
            const btn = document.getElementById('generate-ai-btn');
            const contentBox = document.getElementById('ai-content-box');
            const placeholder = document.getElementById('ai-placeholder');
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';

            let csrfToken = '';
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) csrfToken = meta.getAttribute('content');

            fetch('/learn/vocabulary/api/item/' + itemId + '/generate-ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (placeholder) placeholder.style.display = 'none';
                        const content = data.explanation;
                        if (contentBox) {
                            contentBox.style.display = 'block';
                            if (window.renderMarkdown) {
                                contentBox.innerHTML = window.renderMarkdown(content.trim());
                                contentBox.classList.add('markdown-body');
                                contentBox.style.whiteSpace = 'normal';
                            } else {
                                contentBox.innerHTML = '<div style="white-space: pre-wrap;">' + content + '</div>';
                            }
                        } else {
                            const tabAi = document.querySelector('#sub-ai');
                            if (tabAi) {
                                if (window.renderMarkdown) {
                                    tabAi.innerHTML = '<div class="ai-content-box markdown-body" style="line-height: 1.6; color: #334155; font-size: 0.95rem; white-space: normal;">' + window.renderMarkdown(content.trim()) + '</div>';
                                } else {
                                    tabAi.innerHTML = '<div class="ai-content-box" style="line-height: 1.6; color: #334155; font-size: 0.95rem;"><div style="white-space: pre-wrap;">' + content + '</div></div>';
                                }
                            }
                        }
                    } else {
                        alert('Lỗi: ' + data.message);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi kết nối: ' + err);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        };

        const initModal = () => {
            const statsModal = document.getElementById('item-stats-modal');
            const statsContainer = document.getElementById('item-stats-container');
            const closeBtns = document.querySelectorAll('.js-close-stats-modal');

            if (closeBtns) {
                closeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        if (statsModal) statsModal.style.display = 'none';
                    });
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && statsModal && statsModal.style.display !== 'none') {
                    statsModal.style.display = 'none';
                }
            });

            window.openVocabularyItemStats = function (itemId) {
                if (!statsModal || !statsContainer) {
                    console.error("Modal elements not found");
                    return;
                }

                statsModal.style.display = 'flex';
                statsContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 16rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6366f1;"></i></div>';

                const editBtn = statsModal.querySelector('.js-edit-item-stats');
                if (editBtn) editBtn.style.display = 'none';

                fetch('/learn/vocabulary/item/' + itemId + '/stats?modal=true&_cb=' + new Date().getTime())
                    .then(r => r.text())
                    .then(html => {
                        statsContainer.innerHTML = html;
                        const contentEl = statsContainer.querySelector('.stats-container');
                        if (contentEl && editBtn) {
                            const canEdit = contentEl.dataset.canEdit === 'true';
                            const editUrl = contentEl.dataset.editUrl;
                            if (canEdit && editUrl) {
                                editBtn.style.display = 'flex';
                                editBtn.onclick = function (e) {
                                    if (e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                    }
                                    openVocabEditOverlay(editUrl);
                                    return false;
                                };
                            }
                        }

                        // [AI COACH] Render Markdown for existing explanation
                        const mdContainers = statsContainer.querySelectorAll('.js-markdown-content');
                        mdContainers.forEach(container => {
                            if (window.renderMarkdown) {
                                // Important: We use textContent but remove pre-wrap for proper markdown list rendering
                                const rawText = container.textContent.trim();
                                container.innerHTML = window.renderMarkdown(rawText);
                                container.style.whiteSpace = 'normal';
                            }
                        });

                        if (window.initStatsModalTabs) window.initStatsModalTabs();
                    })
                    .catch(err => {
                        console.error("Stats load error:", err);
                        statsContainer.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 16rem; color: #94a3b8;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><span>Không thể tải thống kê</span></div>';
                    });
            };
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initModal);
        } else {
            initModal();
        }
    })();
</script>