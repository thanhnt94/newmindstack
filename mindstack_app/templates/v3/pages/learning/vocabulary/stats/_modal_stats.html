{# Reusable Item Stats Modal #}
<div id="item-stats-modal" class="vocab-modal" style="display: none;">
    <div class="vocab-modal-overlay js-close-stats-modal"></div>
    <div class="vocab-modal-content">
        <button class="vocab-modal-close js-close-stats-modal">
            <i class="fas fa-times"></i>
        </button>
        <div id="item-stats-container" class="vocab-modal-body">
            <!-- Content loaded here -->
        </div>
    </div>
</div>

<style>
    /* Stats Modal Styles */
    .vocab-modal {
        position: fixed;
        inset: 0;
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .vocab-modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .vocab-modal-content {
        position: relative;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: vocabScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .vocab-modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10;
    }

    .vocab-modal-close:hover {
        background: #e2e8f0;
        color: #ef4444;
    }

    .vocab-modal-body {
        overflow-y: auto;
        padding: 0;
        height: 100%;
        background: #f8fafc;
    }

    @keyframes vocabScaleIn {
        from {
            transform: scale(0.95);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<script>
    (function () {
        // Use a slight delay to ensure DOM is ready if injected via AJAX, 
        // but here it's usually static include.
        const initModal = () => {
            const statsModal = document.getElementById('item-stats-modal');
            const statsContainer = document.getElementById('item-stats-container');
            const closeBtns = document.querySelectorAll('.js-close-stats-modal');

            if (closeBtns) {
                closeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        if (statsModal) statsModal.style.display = 'none';
                    });
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && statsModal && statsModal.style.display !== 'none') {
                    statsModal.style.display = 'none';
                }
            });

            window.openVocabularyItemStats = function (itemId) {
                if (!statsModal || !statsContainer) {
                    console.error("Modal elements not found");
                    return;
                }

                statsModal.style.display = 'flex';
                statsContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 16rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6366f1;"></i></div>';

                fetch('/learn/vocabulary/item/' + itemId + '/stats?modal=true')
                    .then(function (r) { return r.text(); })
                    .then(function (html) {
                        statsContainer.innerHTML = html;
                        // Initialize tab switching
                        if (window.initStatsModalTabs) window.initStatsModalTabs();
                    })
                    .catch(function (err) {
                        console.error("Stats load error:", err);
                        statsContainer.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 16rem; color: #94a3b8;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><span>Không thể tải thống kê</span></div>';
                    });
            };

            // Tab switching logic
            window.initStatsModalTabs = function () {
                const modalContainer = document.getElementById('item-stats-container');
                if (!modalContainer) return;

                const tabBtns = modalContainer.querySelectorAll('.tab-btn');
                const tabContents = modalContainer.querySelectorAll('.tab-content');

                tabBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const targetTab = this.dataset.tab;
                        tabBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');

                        tabContents.forEach(content => {
                            if (content.id === 'tab-' + targetTab) {
                                content.style.display = 'block';
                                content.classList.add('active');
                            } else {
                                content.style.display = 'none';
                                content.classList.remove('active');
                            }
                        });
                    });
                });
            };
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initModal);
        } else {
            initModal();
        }
    })();
</script>