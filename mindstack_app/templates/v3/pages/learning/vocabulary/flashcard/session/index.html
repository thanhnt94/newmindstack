{#
# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html
# Phiên bản: 74.0
# ĐÃ SỬA: Đưa các biến Jinja ra ngoài object window.FlashcardConfig để tránh formatter làm hỏng syntax (insert space vào
{{ }}).
#}

{% extends "v3/base.html" %}
{% from 'v3/includes/navbar/_navbar.html' import render_navbar %}
{% block title %}Học Flashcard{% endblock %}

{# CRITICAL: Add flashcard-session-active class to body to hide header/footer on mobile #}
{% block body_class %} flashcard-session-active{% endblock %}

{% block head %}
{{ super() }}
<script>
  // Remove Tailwind padding from main on mobile viewport
  (function () {
    if (window.innerWidth <= 1023) {
      document.addEventListener('DOMContentLoaded', function () {
        var main = document.querySelector('body > main');
        if (main) {
          main.classList.remove('py-4', 'px-2', 'sm:py-2', 'sm:px-3', 'md:py-4');
          main.style.padding = '0';
          main.style.margin = '0';
        }
        var header = document.querySelector('body > header');
        if (header) {
          header.style.display = 'none';
        }
      });
    }
  })();
</script>

{# Flashcard Session CSS - External Files stored in template directory #}
<link rel="stylesheet" href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/core.css') }}">
<link rel="stylesheet"
  href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/session.css') }}">
<link rel="stylesheet" href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/card.css') }}">
<link rel="stylesheet"
  href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/components.css') }}">
<link rel="stylesheet"
  href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/desktop.css') }}">
<link rel="stylesheet"
  href="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='css/mobile.css') }}">
{% include 'v3/includes/assets/_markdown_assets.html' %}
{% endblock %}

{% block content %}
{# Include Desktop và Mobile partials - visibility kiểm soát bởi CSS class #}

{% include 'v3/pages/learning/vocabulary/flashcard/session/_desktop.html' %}
{% include 'v3/pages/learning/vocabulary/flashcard/session/_mobile.html' %}

{# === SHARED MODALS - Dùng chung cho cả Desktop và Mobile === #}

<div id="endSessionModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <p class="text-lg font-semibold text-gray-800 mb-4">Bạn có chắc chắn muốn kết thúc phiên học hiện tại?</p>
    <p class="text-sm text-gray-600 mb-6">Tiến độ của thẻ chưa trả lời sẽ không được lưu.</p>
    <div class="flex justify-center space-x-4">
      <button id="confirmEndSessionBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Kết
        thúc</button>
      <button id="cancelEndSessionBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Hủy
        bỏ</button>
    </div>
  </div>
</div>

<div id="statsModal" class="stats-modal-overlay">
  <div id="statsModalContent" class="stats-modal-content">
    <header class="bg-white shadow-md">
      {{ render_navbar(current_user, request) }}
    </header>
    <div class="stats-modal-header">
      <h3>Thống kê phiên học</h3>
      <button id="closeStatsModalBtn" class="stats-modal-close-btn">&times;</button>
    </div>
    <div id="statsModalBody" class="stats-modal-body">
      {# Nội dung thống kê sẽ được render vào đây #}
    </div>
  </div>
</div>

{# Nhúng modal AI #}
{% include 'v3/includes/ai_services/_ai_modal.html' %}

{# Nhúng modal Ghi chú #}
{% include 'v3/pages/notes/_note_panel.html' %}

{# Nhúng modal Memory Power #}
{% include 'v3/includes/notification/_memory_power.html' %}

{# Nhúng modal Feedback #}
{% include 'v3/pages/feedback/_feedback_modal.html' %}

{# Nhúng modal Item Stats (Dùng chung với Dashboard) #}
{% include 'v3/pages/learning/vocabulary/stats/_modal_stats.html' %}

{% endblock %}

{% block scripts %}
{{ super() }}

<script>
  // Define Jinja variables outside the config object to prevent the auto-formatter from inserting spaces into braces
  const _userButtonCount = {{ user_button_count | default (4) }};
  const _isAutoplaySession = {{ is_autoplay_session | default (false) | tojson }};
  const _autoplayMode = "{{ autoplay_mode | default('') }}";
  const _visualSettings = {{ (saved_visual_settings or { }) | tojson }};
  const _autoSaveOn = {{ saved_auto_save | default (true) | tojson }};
  const _currentUserTotalScore = {{ current_user.total_score | default (0) }};

  window.FlashcardConfig = {
    getFlashcardBatchUrl: "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}",
    flashcardItemApiUrlTemplate: "{{ url_for('learning.flashcard_learning.get_flashcard_item_api', item_id=0) }}",
    submitAnswerUrl: "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}",
    endSessionUrl: "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}",
    regenerateAudioUrl: "{{ url_for('learning.flashcard_learning.regenerate_audio_from_content') }}",
    saveSettingsUrl: "{{ url_for('learning.flashcard_learning.save_flashcard_settings') }}",
    vocabDashboardUrl: "{{ url_for('learning.vocabulary.dashboard') }}",
    getNoteUrl: "{{ url_for('notes.get_note', item_id=0) }}",
    saveNoteUrl: "{{ url_for('notes.save_note', item_id=0) }}",
    editFlashcardUrlTemplate: "{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=0, item_id=0) }}",
    itemStatsUrlTemplate: "{{ url_for('learning.vocabulary.item_stats_page', item_id=0) }}",
    csrfHeaders: { "X-CSRFToken": "{{ csrf_token() }}" },
    userButtonCount: _userButtonCount,
    isAutoplaySession: _isAutoplaySession,
    autoplayMode: _autoplayMode,
    visualSettings: _visualSettings,
    autoSaveOn: _autoSaveOn,
    modeDisplayName: "{{ mode_display_text }}"
  };

  const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
  if (csrfToken) {
    window.FlashcardConfig.csrfHeaders = { "X-CSRFToken": csrfToken };
  }

  window.currentUserTotalScoreInit = _currentUserTotalScore;
  window.sessionScore = 0;
</script>

<script
  src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/render_card_desktop.js') }}"></script>
<script
  src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/render_card_mobile.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/utils.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/audio_manager.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/ui_manager.js') }}"></script>
<script
  src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/session_manager.js') }}"></script>
<script src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/index.js') }}"></script>
<script
  src="{{ url_for('learning.flashcard_learning.serve_session_asset', filename='js/flashcard_viewport.js') }}"></script>
{% endblock %}