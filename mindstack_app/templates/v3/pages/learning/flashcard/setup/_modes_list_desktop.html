{# File: _flashcard_modes_selection_desktop.html #}
{% set autoplay_mode = namespace(data=None) %}
{% for mode in modes %}
{% if mode.id == 'autoplay' %}
{% set autoplay_mode.data = mode %}
{% endif %}
{% endfor %}

<div class="w-full space-y-3">
    {# Dropdown chọn số nút đánh giá #}
    <div id="button-count-container" class="mb-4 p-4 bg-white rounded-lg border border-gray-200">
        <label for="button-count-select" class="block text-sm font-medium text-gray-700 mb-2">Số nút đánh giá:</label>
        <select id="button-count-select"
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            <option value="3" {% if user_button_count==3 %}selected{% endif %}>3 nút (MindStack: Quên, Mơ hồ, Nhớ)
            </option>
            <option value="4" {% if user_button_count==4 %}selected{% endif %}>4 nút (Anki: Again, Hard, Good, Easy)
            </option>
            <option value="6" {% if user_button_count==6 %}selected{% endif %}>6 nút (Full SM-2: Rất khó -> Rất dễ)
            </option>
        </select>
    </div>



    {# Tùy chọn cho chế độ AutoPlay (ẩn mặc định, hiển thị khi người dùng chọn) #}
    <div id="autoplay-settings-container" class="mb-4 p-4 bg-white rounded-lg border border-blue-200 hidden">
        {% set autoplay_counts = autoplay_mode.data.autoplay_counts if autoplay_mode.data and
        autoplay_mode.data.autoplay_counts is defined else {} %}
        {% set autoplay_learned_count = autoplay_counts.autoplay_learned | default(0) %}
        {% set autoplay_all_count = autoplay_counts.autoplay_all | default(0) %}
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-semibold text-gray-800 flex items-center"><i
                    class="fas fa-headphones mr-2 text-blue-500"></i>Tuỳ chọn AutoPlay</h3>
            <span class="text-xs text-gray-500">Âm thanh sẽ phát tự động trước khi lật thẻ.</span>
        </div>
        <div class="space-y-3">
            <div>
                <p class="text-sm font-medium text-gray-700 mb-2">Phạm vi AutoPlay:</p>
                <div class="grid grid-cols-1 gap-2 sm:grid-cols-2">
                    <label
                        class="autoplay-scope-option flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 transition">
                        <input type="radio" name="autoplay-scope" value="autoplay_learned" class="mr-3"
                            data-count="{{ autoplay_learned_count }}">
                        <span class="text-sm text-gray-700">Chỉ thẻ đã học <span class="text-xs text-gray-500">({{
                                autoplay_learned_count }} thẻ)</span></span>
                    </label>
                    <label
                        class="autoplay-scope-option flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 transition">
                        <input type="radio" name="autoplay-scope" value="autoplay_all" class="mr-3"
                            data-count="{{ autoplay_all_count }}">
                        <span class="text-sm text-gray-700">Toàn bộ thẻ <span class="text-xs text-gray-500">({{
                                autoplay_all_count }} thẻ)</span></span>
                    </label>
                </div>
            </div>
            <div>
                <label for="autoplay-delay-select" class="block text-sm font-medium text-gray-700 mb-2">Thời gian chờ
                    sau mỗi mặt thẻ (giây):</label>
                <select id="autoplay-delay-select"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="1">1 giây</option>
                    <option value="2">2 giây</option>
                    <option value="3">3 giây</option>
                    <option value="5">5 giây</option>
                </select>
            </div>
        </div>
    </div>

    {# Danh sách các chế độ học #}
    <div class="space-y-3">
        {% if modes %}
        {% for mode in modes %}
        {% set is_disabled_mode = (mode.count == 0) %}
        {% if mode.id == 'autoplay' %}
        {% set autoplay_counts = mode.autoplay_counts if mode.autoplay_counts is defined else {} %}
        {% set autoplay_learned_count = autoplay_counts.autoplay_learned | default(0) %}
        {% set autoplay_all_count = autoplay_counts.autoplay_all | default(0) %}
        {% set has_available_autoplay = autoplay_learned_count > 0 or autoplay_all_count > 0 %}
        <div class="flashcard-mode-item bg-white p-4 rounded-lg border border-gray-200 transition-colors duration-200
                            {% if not has_available_autoplay %}opacity-50 cursor-not-allowed{% else %}cursor-pointer hover:bg-gray-100{% endif %}"
            data-mode-id="autoplay" data-count="{{ mode.count }}" data-autoplay-learned="{{ autoplay_learned_count }}"
            data-autoplay-all="{{ autoplay_all_count }}" {% if not has_available_autoplay
            %}title="Không có thẻ phù hợp cho AutoPlay." {% endif %}>
            <div>
                <h3 class="font-semibold text-gray-800 flex items-center"><i
                        class="fas fa-music mr-2 text-blue-500"></i>{{ mode.name }}</h3>
                <p class="text-sm text-gray-500 mt-1">Lắng nghe và lật thẻ tự động theo tốc độ bạn chọn.</p>
            </div>
            <div class="text-right text-sm text-gray-600">
                <div><span class="font-semibold text-gray-700">{{ autoplay_learned_count }}</span> đã học</div>
                <div><span class="font-semibold text-gray-700">{{ autoplay_all_count }}</span> tổng thẻ</div>
            </div>
        </div>
        {% else %}
        <div class="flashcard-mode-item bg-white p-4 rounded-lg border border-gray-200 transition-colors duration-200 flex justify-between items-center
                            {% if is_disabled_mode %}opacity-50 cursor-not-allowed{% else %}cursor-pointer hover:bg-gray-100{% endif %}"
            data-mode-id="{{ mode.id }}" data-count="{{ mode.count }}" {% if is_disabled_mode
            %}title="Chế độ này không có thẻ nào khả dụng." {% endif %}>
            <h3 class="font-semibold text-gray-800">{{ mode.name }}</h3>
            <div class="flex items-center">
                <span class="text-lg font-semibold text-gray-700">{{ mode.count }}</span>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        {% else %}
        <div class="text-center py-12 px-6 text-gray-600">
            <i class="fas fa-info-circle text-5xl text-gray-300 mb-4"></i>
            <p>Không có chế độ học nào khả dụng.</p>
        </div>
        {% endif %}
    </div>

    {# Link to Quiz/MCQ Mode #}
    {% if selected_set_id and selected_set_id != 'all' and ',' not in selected_set_id %}
    <div class="mt-4 pt-4 border-t border-gray-100">
        <h3 class="text-sm font-medium text-gray-500 mb-2 uppercase tracking-wider">Chế độ kiểm tra</h3>
        <a href="{{ url_for('learning.quiz_learning.get_quiz_custom_options', set_id=selected_set_id) }}"
            class="flashcard-mode-item block bg-white p-4 rounded-lg border border-purple-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-200 group no-underline">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-semibold text-purple-700 flex items-center group-hover:text-purple-800">
                        <i class="fas fa-question-circle mr-2 text-purple-500"></i>Luyện tập Trắc nghiệm
                    </h3>
                    <p class="text-sm text-gray-500 mt-1 group-hover:text-gray-600">Kiểm tra kiến thức với câu hỏi trắc
                        nghiệm (MCQ).</p>
                </div>
                <i class="fas fa-chevron-right text-purple-300 group-hover:text-purple-500"></i>
            </div>
        </a>
    </div>
    {% endif %}

    <div class="mt-8">
        <button type="button"
            class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 js-flashcard-continue"
            disabled>
            <span>Bắt đầu phiên học</span>
            <i class="fas fa-play"></i>
        </button>
    </div>
</div>