{# =============================== #}
{# File: mindstack_app/modules/learning/quiz/templates/quiz_battle/room.html #}
{# Phi√™n b·∫£n: 3.2 (Fix Start Error Handling & Leave Redirect) #}
{# =============================== #}

{% extends "v3/base.html" %}

{% block title %}Quiz Battle ¬∑ {{ room_title }}{% endblock %}

{% set hide_header = True %}
{% set hide_footer = True %}

{% block head %}
{{ super() }}
<style>
    /* === CORE LAYOUT === */
    html,
    body {
        height: 100%;
        font-family: 'Inter', sans-serif;
    }

    /* === UI COMPONENTS === */
    .cm-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }

    .cm-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f5f9;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .cm-card-body {
        padding: 1.25rem;
        flex: 1;
        position: relative;
    }

    .cm-card-title {
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Question Text */
    .qb-question-text {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .qb-question-detail {
        color: #64748b;
        font-size: 0.95rem;
        line-height: 1.7;
        margin-bottom: 1rem;
    }

    .qb-question-media img,
    .qb-question-media audio {
        width: 100%;
        max-height: 320px;
        object-fit: contain;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        background: white;
        margin-bottom: 1rem;
    }

    /* Options Grid */
    .qb-options-grid {
        display: grid;
        gap: 0.75rem;
    }

    .qb-option-label {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.15s ease;
        background: white;
    }

    .qb-option-label:hover {
        border-color: #94a3b8;
        background: #f8fafc;
    }

    .qb-option-label.selected,
    .qb-option-label.is-user {
        border-color: #3b82f6;
        background: #eff6ff;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .qb-option-label.correct,
    .qb-option-label.is-correct {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .qb-option-label.incorrect,
    .qb-option-label.is-wrong {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .qb-option-label.disabled {
        pointer-events: none;
        opacity: 0.7;
    }

    .qb-option-letter-circle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: #f1f5f9;
        color: #1e293b;
        font-weight: 700;
        font-size: 0.9rem;
        border: 1px solid #e2e8f0;
        flex-shrink: 0;
    }

    .qb-option-label.selected .qb-option-letter-circle,
    .qb-option-label.is-user .qb-option-letter-circle {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .qb-option-label.correct .qb-option-letter-circle,
    .qb-option-label.is-correct .qb-option-letter-circle {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    .qb-option-label.incorrect .qb-option-letter-circle,
    .qb-option-label.is-wrong .qb-option-letter-circle {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    .qb-option-text {
        flex: 1;
        color: #374151;
        font-size: 1rem;
        line-height: 1.5;
        padding-top: 4px;
    }

    /* Buttons */
    .cm-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
    }

    .cm-btn-primary {
        background: #2563eb;
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .cm-btn-primary:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
    }

    .cm-btn-primary:disabled {
        background: #94a3b8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .cm-btn-danger {
        background: white;
        color: #ef4444;
        border: 1px solid #fecaca;
    }

    .cm-btn-ghost {
        background: transparent;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }

    .cm-btn-ghost:hover {
        background: #f8fafc;
    }

    /* === MESSENGER-STYLE CHAT === */
    .chat-message-row {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        margin-bottom: 4px;
        padding: 2px 0;
    }

    .chat-message-row.chat-me {
        flex-direction: row-reverse;
    }

    .chat-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        color: white;
        flex-shrink: 0;
    }

    .chat-avatar.invisible {
        visibility: hidden;
    }

    .chat-bubble-wrapper {
        max-width: 75%;
        display: flex;
        flex-direction: column;
    }

    .chat-me .chat-bubble-wrapper {
        align-items: flex-end;
    }

    .chat-sender-name {
        font-size: 11px;
        color: #64748b;
        margin-bottom: 2px;
        margin-left: 12px;
        font-weight: 500;
    }

    .chat-bubble {
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        word-break: break-word;
    }

    .chat-other .chat-bubble {
        background: #e5e7eb;
        color: #1f2937;
        border-bottom-left-radius: 4px;
    }

    .chat-me .chat-bubble {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    /* Chat messages container */
    .qb-chat-messages {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding: 16px !important;
        background: linear-gradient(180deg, #f1f5f9 0%, #ffffff 100%) !important;
        flex: 1;
        min-height: 0;
        overflow-y: auto;
    }

    /* === HIDE DEFAULT SITE ELEMENTS ON MOBILE === */
    @media (max-width: 1023px) {

        body>header,
        nav.navbar,
        footer,
        .site-footer,
        .back-to-top {
            display: none !important;
        }

        body {
            padding-top: 70px !important;
            /* Space for mobile header */
            padding-bottom: 90px;
            /* Bottom Bar */
            background: #f8fafc;
        }

        .container {
            padding-left: 12px;
            padding-right: 12px;
            max-width: 100%;
        }

        /* Hide desktop-only elements */
        .lg\:flex,
        .lg\:block,
        .hidden.lg\:flex,
        .hidden.lg\:block,
        .qb-desktop-header {
            display: none !important;
        }

        /* Hide inline submit button on mobile (use bottom bar instead) */
        .qb-desktop-submit-btn,
        #answer-inline-feedback {
            display: none !important;
        }

        /* Hide radio button inputs */
        .qb-option-label input[type="radio"] {
            display: none !important;
        }

        /* Hide the footer stats bar on mobile */
        .cm-card>.bg-slate-50.border-t {
            display: none !important;
        }

        /* Hide result and explanation panels on mobile (shown in Hub modal instead) */
        #answer-result-panel,
        #answer-explanation-panel,
        #question-insight-panel {
            display: none !important;
        }
    }

    /* === MOBILE STICKY HEADER === */
    .qb-mobile-sticky-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        display: none;
        /* Hidden on desktop */
    }

    @media (max-width: 1023px) {
        .qb-mobile-sticky-wrapper {
            display: block;
        }
    }

    .qb-mobile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
    }

    .qb-mobile-header-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .qb-mobile-header-stats {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .qb-mobile-stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .qb-mobile-stat-label {
        font-size: 10px;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .qb-mobile-stat-value {
        font-size: 1rem;
        font-weight: 800;
        color: #1e293b;
        font-variant-numeric: tabular-nums;
    }

    /* === MOBILE BOTTOM BAR === */
    .qb-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 12px 16px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
        border-top: 1px solid #e2e8f0;
        z-index: 60;
        display: none;
        /* Hidden on desktop */
        gap: 10px;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
    }

    @media (max-width: 1023px) {
        .qb-bottom-bar {
            display: flex !important;
        }
    }

    .qb-bottom-bar .cm-btn {
        flex: 1;
        border-radius: 12px;
        padding: 14px;
        font-size: 1rem;
        margin: 0;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .qb-mobile-chat-toggle {
        position: relative;
        background: #eff6ff;
        color: #3b82f6;
        border: 1px solid #dbeafe;
        border-radius: 12px;
        width: 3.25rem;
        height: 3.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        cursor: pointer;
    }

    .qb-chat-unread {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 10px;
        height: 10px;
        background: #ef4444;
        border-radius: 50%;
        display: none;
    }

    .qb-chat-unread.show {
        display: block;
    }

    /* === HUB MODAL (Slide Up) === */
    .qb-modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .qb-modal-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .qb-modal-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 101;
        background: white;
        height: 85vh;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
    }

    .qb-modal-overlay.open .qb-modal-container {
        transform: translateY(0);
    }

    .qb-hub-header {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .qb-hub-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
        flex-shrink: 0;
    }

    .qb-hub-tab-item {
        flex: 1;
        text-align: center;
        padding: 12px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        font-size: 0.875rem;
    }

    .qb-hub-tab-item.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
        background: white;
    }

    .qb-hub-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: white;
    }

    .qb-hub-pane {
        display: none;
    }

    .qb-hub-pane.active {
        display: block;
    }

    /* === LAYOUT GRID === */
    @media (min-width: 1024px) {
        .qb-layout-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .qb-bottom-bar,
        .qb-modal-overlay {
            display: none !important;
        }
    }

    @media (max-width: 1023px) {
        .qb-layout-grid {
            display: block;
            padding-bottom: 100px;
            /* Space for bottom bar */
        }

        /* Hide desktop panels on mobile */
        .qb-chat-panel,
        #tab-pane-stats {
            display: none !important;
        }

        /* Chat panel as fullscreen app-like modal on mobile */
        #quiz-chat-panel.open {
            display: flex !important;
            flex-direction: column;
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 0;
        }

        #quiz-chat-panel.open .qb-chat-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90vh;
            max-height: 90vh;
            background: white;
            border-radius: 24px 24px 0 0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.2);
            animation: slideUpChat 0.3s ease-out;
        }

        @keyframes slideUpChat {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        #quiz-chat-panel.open .qb-hub-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            border-radius: 24px 24px 0 0;
            flex-shrink: 0;
        }

        #quiz-chat-panel.open .qb-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #quiz-chat-panel.open .qb-chat-input-area {
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            background: white;
            border-top: 1px solid #e2e8f0;
            flex-shrink: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
{# === MOBILE STICKY HEADER === #}
<div class="qb-mobile-sticky-wrapper">
    <div class="qb-mobile-header">
        <div class="qb-mobile-header-stats">
            <div class="qb-mobile-stat-item">
                <span class="qb-mobile-stat-label">C√¢u</span>
                <span id="mobile-round-display" class="qb-mobile-stat-value">--</span>
            </div>
            <div class="h-6 w-px bg-slate-200"></div>
            <div class="qb-mobile-stat-item">
                <span class="qb-mobile-stat-label">ƒêi·ªÉm</span>
                <span id="mobile-score-display" class="qb-mobile-stat-value text-emerald-600">0</span>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <span id="mobile-room-code" class="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-600">{{
                room_code }}</span>
            <button id="mobile-stats-btn"
                class="w-9 h-9 rounded-full bg-amber-50 text-amber-600 flex items-center justify-center hover:bg-amber-100"
                title="Th·ªëng k√™ ng∆∞·ªùi ch∆°i">
                <i class="fa-solid fa-chart-bar"></i>
            </button>
            <button id="mobile-leave-btn"
                class="w-9 h-9 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>
    </div>
</div>

<div class="container mx-auto px-2 py-6 max-w-7xl">

    {# === DESKTOP HEADER (Standard Breadcrumb) === #}
    <div class="hidden lg:flex items-center justify-between mb-6">
        <div class="flex items-center gap-2 text-sm text-slate-500">
            <a href="/" class="hover:text-blue-600"><i class="fa-solid fa-house"></i></a>
            <span class="text-slate-300">/</span>
            <a href="{{ url_for('learning.quiz_battle.quiz_battle_dashboard') }}"
                class="hover:text-blue-600 font-medium">Quiz
                Battle</a>
            <span class="text-slate-300">/</span>
            <span class="font-bold text-slate-800">{{ room_title }}</span>
            <span class="ml-2 status-badge" data-status="{{ initial_room.status }}">{{ initial_room.status }}</span>
        </div>

        <div class="flex items-center gap-3">
            <div
                class="text-sm text-slate-600 bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm flex items-center gap-2">
                <span class="text-xs font-bold text-slate-400 uppercase">M√£ ph√≤ng:</span>
                <code class="font-mono font-bold text-blue-600 select-all">{{ room_code }}</code>
                <button id="copy-room-code" class="text-slate-400 hover:text-blue-600 transition-colors"><i
                        class="fa-regular fa-copy"></i></button>
            </div>

            <div class="h-4 w-px bg-slate-300 mx-1"></div>

            <button id="start-room-btn" class="cm-btn cm-btn-primary py-1.5 px-3 text-sm" title="B·∫Øt ƒë·∫ßu"><i
                    class="fa-solid fa-play"></i> <span class="hidden xl:inline">B·∫Øt ƒë·∫ßu</span></button>
            <button id="next-round-btn" class="cm-btn cm-btn-primary py-1.5 px-3 text-sm hidden" title="C√¢u ti·∫øp"><i
                    class="fa-solid fa-forward"></i> <span class="hidden xl:inline">Ti·∫øp theo</span></button>
            <button id="end-room-btn" class="cm-btn cm-btn-danger py-1.5 px-3 text-sm" title="K·∫øt th√∫c"><i
                    class="fa-solid fa-flag-checkered"></i></button>
            <button id="leave-room-btn" class="cm-btn cm-btn-ghost py-1.5 px-3 text-sm" title="R·ªùi ph√≤ng"><i
                    class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </div>

    {# === MOBILE TABS (Moved to Header) === #}

    {# === ALERT BOX === #}
    <div id="room-alert" class="mb-6 hidden p-4 rounded-lg border flex items-start gap-3"></div>

    {# === MAIN GRID === #}
    <style>
        @media (max-width: 1023px) {
            .qb-layout-grid {
                display: block !important;
                /* Stack vertically */
                height: auto !important;
                overflow: visible !important;
                padding-bottom: 100px;
                /* Space for bottom bar */
            }

            .qb-tab-pane {
                display: none;
                /* Controlled by JS tab switcher */
            }

            .qb-tab-pane.active {
                display: block !important;
            }

            /* Hide chat panel on mobile list view, showing only as popup if needed or handled separately */
            .qb-chat-panel {
                display: none !important;
            }
        }
    </style>
    <div class="qb-layout-grid">

        {# --- C·ªòT TR√ÅI: C√ÇU H·ªéI & GAMEPLAY --- #}
        <div id="tab-pane-game" class="qb-tab-pane active space-y-6">

            {# 1. Question Card #}
            <div class="cm-card">
                <div class="cm-card-header qb-desktop-header">
                    <span class="cm-card-title"><i class="fa-solid fa-circle-question text-blue-500"></i> C√¢u h·ªèi</span>
                    <span id="question-timer" class="text-orange-600 font-bold font-mono text-lg"></span>
                </div>
                <div class="cm-card-body relative">
                    <div id="game-status-overlay"
                        class="hidden absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center text-center p-6">
                        <div class="text-slate-400 mb-2 text-4xl"><i class="fa-solid fa-hourglass-half fa-spin"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-700" id="game-overlay-title">ƒêang ch·ªù...</h3>
                        <p class="text-slate-500" id="game-overlay-msg">ƒê·ª£i ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u.</p>
                    </div>

                    <h2 id="question-title" class="qb-question-text">ƒêang t·∫£i d·ªØ li·ªáu...</h2>
                    <div id="question-detail" class="qb-question-detail"></div>
                    <div id="question-media" class="qb-question-media" hidden></div>

                    <form id="answer-form">
                        <div id="question-options" class="qb-options-grid">
                        </div>
                        <div class="mt-6 flex items-center justify-between gap-3 flex-wrap">
                            <p id="answer-inline-feedback" class="text-sm font-medium text-slate-600"></p>
                            <button type="submit" id="submit-answer-btn"
                                class="cm-btn cm-btn-primary w-full sm:w-auto qb-desktop-submit-btn" disabled>
                                <i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n
                            </button>
                        </div>
                        <div id="answer-locked-note" class="hidden mt-3 qb-inline-action-area">
                            <div
                                class="flex items-center gap-2 text-sm font-semibold text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-lg px-3 py-2">
                                <i class="fa-solid fa-lock"></i>
                                <span>ƒê√°p √°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n. B·∫°n kh√¥ng th·ªÉ thay ƒë·ªïi n·ªØa.</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div
                    class="bg-slate-50 px-5 py-3 border-t border-slate-100 flex flex-wrap gap-3 justify-between items-center text-xs text-slate-500">
                    <span id="round-progress">Ti·∫øn ƒë·ªô: --/--</span>
                    <span id="player-answered">ƒê√£ tr·∫£ l·ªùi: -- c√¢u</span>
                    <span id="player-score">T·ªïng ƒëi·ªÉm: --</span>
                    <span id="room-mode">Ch·∫ø ƒë·ªô: --</span>
                </div>
            </div>

            {# 2. Result Panel (·∫®n m·∫∑c ƒë·ªãnh) #}
            <div id="answer-result-panel" class="cm-card border-l-4 border-l-blue-500" hidden>
                <div class="cm-card-body">
                    <div class="flex items-start gap-4">
                        <div id="answer-feedback-icon" class="text-3xl">üí°</div>
                        <div class="flex-1">
                            <h3 id="answer-feedback-title" class="text-lg font-bold text-slate-900">K·∫øt qu·∫£</h3>
                            <p id="answer-feedback-detail" class="text-sm text-slate-600 mb-3"></p>

                            <div class="flex gap-4 text-sm">
                                <div class="bg-slate-50 px-3 py-2 rounded border border-slate-100">
                                    <span class="block text-xs text-slate-400 uppercase">ƒê√°p √°n ƒë√∫ng</span>
                                    <span id="answer-feedback-correct" class="font-bold text-emerald-600">--</span>
                                </div>
                                <div class="bg-slate-50 px-3 py-2 rounded border border-slate-100">
                                    <span class="block text-xs text-slate-400 uppercase">ƒêi·ªÉm c·ªông</span>
                                    <span id="answer-feedback-score" class="font-bold text-blue-600">+0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# 3. Explanation Panel (·∫®n m·∫∑c ƒë·ªãnh) #}
            <div id="answer-explanation-panel" class="cm-card" hidden>
                <div class="cm-card-header">
                    <span class="cm-card-title"><i class="fa-solid fa-book-open text-blue-500"></i> Gi·∫£i th√≠ch</span>
                </div>
                <div class="cm-card-body">
                    <div class="p-3 bg-blue-50 rounded-lg text-sm text-slate-700 border border-blue-100">
                        <div id="answer-feedback-explanation"></div>
                    </div>
                </div>
            </div>

            {# 3. Insight Tabs (AI, Notes) #}
            <div id="question-insight-panel" class="space-y-4" hidden>
                <div class="cm-card">
                    <div
                        class="cm-card-header bg-gradient-to-r from-indigo-50 to-white flex items-center justify-between gap-3">
                        <span class="cm-card-title text-indigo-700"><i class="fa-solid fa-robot"></i> AI Coach</span>
                        <button id="ai-coach-generate-btn"
                            class="text-xs text-blue-600 font-semibold px-3 py-1 rounded-lg border border-blue-100 bg-white hover:bg-blue-50 hidden">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o h∆∞·ªõng d·∫´n AI
                        </button>
                    </div>
                    <div class="cm-card-body text-sm text-slate-600 leading-relaxed" id="question-ai-content">
                        ƒêang ph√¢n t√≠ch...
                    </div>
                </div>

                <div class="cm-card">
                    <div class="cm-card-header">
                        <span class="cm-card-title"><i class="fa-solid fa-note-sticky text-yellow-500"></i> Ghi ch√∫ c√°
                            nh√¢n</span>
                        <button id="question-note-edit" class="text-xs text-blue-600 hover:underline font-medium">S·ª≠a
                            ghi ch√∫</button>
                    </div>
                    <div class="cm-card-body">
                        <div id="question-note-content" class="text-sm text-slate-600 italic">B·∫°n ch∆∞a c√≥ ghi ch√∫ cho
                            c√¢u n√†y.</div>

                        <div id="question-note-editor" class="hidden mt-2 space-y-2">
                            <textarea id="question-note-input"
                                class="w-full rounded-lg border-slate-300 text-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                                rows="3" placeholder="Nh·∫≠p ghi ch√∫ c·ªßa b·∫°n..."></textarea>
                            <div class="flex justify-end gap-2">
                                <button id="question-note-cancel"
                                    class="px-3 py-1.5 rounded text-xs font-medium text-slate-500 hover:bg-slate-100">H·ªßy</button>
                                <button id="question-note-save"
                                    class="px-3 py-1.5 rounded text-xs font-medium bg-blue-600 text-white hover:bg-blue-700">L∆∞u</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="question-feedback-card" class="cm-card">
                    <div class="cm-card-body">
                        <p class="text-xs font-bold uppercase text-slate-400 mb-2">G√≥p √Ω c√¢u h·ªèi</p>
                        <div class="flex gap-2">
                            <input type="text" id="question-feedback-input"
                                class="flex-1 rounded-lg border-slate-200 text-sm p-2"
                                placeholder="B√°o c√°o l·ªói ho·∫∑c g√≥p √Ω...">
                            <button id="question-feedback-submit"
                                class="px-3 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm hover:bg-slate-200"><i
                                    class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        {# --- C·ªòT PH·∫¢I: TH·ªêNG K√ä & CHAT --- #}
        <div class="space-y-6">
            <div id="tab-pane-stats" class="qb-tab-pane space-y-6">

                {# 1. Question Stats #}
                <div class="cm-card">
                    <div class="cm-card-header">
                        <span class="cm-card-title"><i class="fa-solid fa-chart-pie text-emerald-500"></i> Th·ªëng
                            k√™</span>
                        <span id="question-stats-round"
                            class="text-xs font-mono bg-slate-100 px-2 py-1 rounded">#--</span>
                    </div>
                    <div class="cm-card-body">
                        <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                            <div class="p-2 rounded bg-slate-50 border border-slate-100">
                                <div class="text-xs text-slate-400 uppercase">ƒê√£ tr·∫£ l·ªùi</div>
                                <div id="question-stats-total" class="text-xl font-bold text-slate-700">0</div>
                            </div>
                            <div class="p-2 rounded bg-emerald-50 border border-emerald-100">
                                <div class="text-xs text-emerald-600 uppercase">Ch√≠nh x√°c</div>
                                <div id="question-stats-accuracy" class="text-xl font-bold text-emerald-700">--%</div>
                            </div>
                        </div>
                        <p id="question-stats-locked"
                            class="text-xs text-center text-amber-700 bg-amber-50 border border-amber-100 rounded p-2 mb-2 hidden">
                            Tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ xem l·ª±a ch·ªçn c·ªßa m·ªçi ng∆∞·ªùi.
                        </p>
                        <p id="question-stats-empty" class="text-xs text-center text-slate-400 italic">Ch∆∞a c√≥ d·ªØ li·ªáu.
                        </p>
                        <div id="option-distribution" class="space-y-2 text-xs"></div>
                        <div id="option-breakdown" class="space-y-3 text-xs mt-3"></div>
                    </div>
                </div>

                {# 2. Participants #}
                <div class="cm-card max-h-[300px] flex flex-col">
                    <div class="cm-card-header sticky top-0 z-10">
                        <span class="cm-card-title"><i class="fa-solid fa-users text-purple-500"></i> Ng∆∞·ªùi tham
                            gia</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0">
                        <ul id="participants-list" class="divide-y divide-slate-50">
                        </ul>
                    </div>
                </div>

            </div>

            {# 3. Chat Box (Desktop Only - Mobile uses Hub Modal) #}
            <div id="quiz-chat-panel" class="qb-chat-panel hidden lg:block">
                <div class="cm-card qb-chat-container">
                    {# Header - styled like Hub on mobile, overridden on desktop via CSS if needed #}
                    <div
                        class="qb-hub-header flex items-center justify-between bg-white border-b border-slate-100 p-4 md:p-3">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-comments text-blue-500 text-xl md:text-base"></i>
                            <h3 class="font-bold text-slate-800 text-lg md:text-sm">Th·∫£o lu·∫≠n</h3>
                        </div>
                        <button type="button" id="close-chat-btn"
                            class="qb-close-chat-btn w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 md:px-2 md:w-auto md:h-auto md:rounded-lg md:text-xs">
                            <i class="fa-solid fa-xmark md:mr-1"></i> <span class="hidden md:inline">ƒê√≥ng</span>
                        </button>
                    </div>

                    <div id="chat-messages" class="qb-chat-messages flex-1 overflow-y-auto p-4 bg-slate-50">
                        <p class="text-center text-xs text-slate-400 mt-4">B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán...</p>
                    </div>

                    <form id="chat-form" class="qb-chat-input-area p-3 bg-white border-t border-slate-100 flex gap-2">
                        <input type="text" id="chat-input"
                            class="flex-1 rounded-full border-slate-200 text-sm px-4 py-3 md:py-2 focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition outline-none"
                            placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
                        <button type="submit"
                            class="w-10 h-10 md:w-9 md:h-9 rounded-full bg-blue-500 text-white flex items-center justify-center hover:bg-blue-600 shadow-sm transition flex-shrink-0">
                            <i class="fa-solid fa-paper-plane text-sm md:text-xs"></i>
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

{# === MOBILE BOTTOM ACTION BAR === #}
<div class="qb-bottom-bar">
    <button type="button" id="open-hub-btn"
        class="qb-mobile-chat-toggle bg-indigo-50 text-indigo-600 border-indigo-200 hover:bg-indigo-100"
        aria-label="M·ªü chi ti·∫øt">
        <i class="fa-solid fa-lightbulb text-xl"></i>
    </button>

    <button type="button" id="mobile-submit-btn" class="cm-btn cm-btn-primary w-full shadow-lg" disabled>
        <i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n
    </button>

    <button type="button" id="open-chat-btn" class="qb-mobile-chat-toggle" aria-label="M·ªü chat">
        <i class="fa-solid fa-comments text-xl"></i>
        <span id="chat-unread-badge" class="qb-chat-unread" aria-hidden="true"></span>
    </button>
</div>

{# === STATS MODAL (Mobile) === #}
<div id="stats-modal" class="qb-modal-overlay">
    <div class="qb-modal-container">
        <div class="qb-hub-header flex items-center justify-between">
            <h3 class="font-bold text-slate-800 text-lg"><i class="fa-solid fa-chart-bar text-amber-500 mr-2"></i>B·∫£ng
                x·∫øp h·∫°ng</h3>
            <button id="close-stats-btn"
                class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="qb-hub-content">
            <ul id="mobile-participants-list" class="divide-y divide-slate-100">
                <li class="text-center text-slate-400 text-sm py-4">ƒêang t·∫£i...</li>
            </ul>
        </div>
    </div>
</div>

<div id="explanation-hub-modal" class="qb-modal-overlay">
    <div class="qb-modal-container">
        <div class="qb-hub-header flex items-center justify-between">
            <h3 class="font-bold text-slate-800 text-lg">Chi ti·∫øt & H·ªçc t·∫≠p</h3>
            <div class="flex items-center gap-2">
                <button id="open-feedback-modal-btn"
                    class="w-8 h-8 rounded-full bg-amber-50 text-amber-600 flex items-center justify-center hover:bg-amber-100 transition"
                    title="G·ª≠i ph·∫£n h·ªìi">
                    <i class="fa-solid fa-flag"></i>
                </button>
                <button id="close-hub-btn"
                    class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
        <div class="qb-hub-tabs">
            <div class="qb-hub-tab-item active" data-target="hub-expl">üìñ Gi·∫£i th√≠ch</div>
            <div class="qb-hub-tab-item" data-target="hub-ai">ü§ñ AI Coach</div>
            <div class="qb-hub-tab-item" data-target="hub-collab">üìù Ghi ch√∫</div>
        </div>
        <div class="qb-hub-content">

            {# Tab 1: Official Explanation #}
            <div id="hub-expl" class="qb-hub-pane active">
                <div class="mb-4">
                    <span class="text-xs font-bold text-slate-400 uppercase">ƒê√°p √°n ƒë√∫ng</span>
                    <div id="hub-correct-option" class="text-xl font-bold text-emerald-600 mt-1">--</div>
                </div>
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-slate-700 leading-relaxed">
                    <h4 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-circle-info"></i> Gi·∫£i th√≠ch chi
                        ti·∫øt:</h4>
                    <div id="hub-explanation-text">Ch∆∞a c√≥ gi·∫£i th√≠ch.</div>
                </div>
            </div>

            {# Tab 2: AI Coach #}
            <div id="hub-ai" class="qb-hub-pane">
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-indigo-700 font-bold">
                            <i class="fa-solid fa-robot"></i> <span>AI Ph√¢n T√≠ch</span>
                        </div>
                        <button id="hub-ai-generate-btn"
                            class="text-xs bg-white text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-200 font-semibold shadow-sm">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o m·ªõi
                        </button>
                    </div>
                    <div id="hub-ai-content" class="text-sm text-slate-700 leading-relaxed min-h-[100px]">
                        Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch c√¢u h·ªèi n√†y...
                    </div>
                </div>
            </div>

            {# Tab 3: Collab / Notes #}
            <div id="hub-collab" class="qb-hub-pane space-y-6">
                {# Personal Note #}
                <div>
                    <h4 class="font-bold text-slate-800 mb-2"><i class="fa-solid fa-note-sticky text-yellow-500"></i>
                        Ghi ch√∫ c√° nh√¢n</h4>

                    {# Display Mode #}
                    <div id="hub-note-display-wrapper" class="hidden relative group">
                        <div class="absolute top-0 right-0">
                            <button id="hub-note-edit-btn" class="text-xs text-blue-600 font-medium hover:underline">
                                <i class="fa-solid fa-pen"></i> S·ª≠a
                            </button>
                        </div>
                        <div id="hub-note-display"
                            class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap pt-1">
                            <!-- Note content will be rendered here -->
                        </div>
                    </div>

                    {# Edit Mode #}
                    <div id="hub-note-edit-wrapper">
                        <textarea id="hub-note-input"
                            class="w-full p-3 rounded-xl border border-slate-200 text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition"
                            rows="5" placeholder="Ghi l·∫°i nh·ªØng g√¨ b·∫°n h·ªçc ƒë∆∞·ª£c..."></textarea>
                        <button id="hub-note-save"
                            class="mt-2 w-full py-2 rounded-lg bg-blue-100 text-blue-700 font-semibold text-sm hover:bg-blue-200">L∆∞u
                            ghi ch√∫</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{# === FEEDBACK MODAL (New) === #}
<div id="feedback-popup"
    class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-all duration-300 opacity-0 invisible">
    <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-5 transform scale-95 transition-all duration-300">
        <h3 class="text-lg font-bold text-slate-800 mb-2">G·ª≠i ph·∫£n h·ªìi</h3>
        <p class="text-xs text-slate-500 mb-3">B√°o l·ªói c√¢u h·ªèi ho·∫∑c g√≥p √Ω c·∫£i thi·ªán n·ªôi dung.</p>
        <textarea id="popup-feedback-input"
            class="w-full p-3 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-amber-500 outline-none mb-4"
            rows="4" placeholder="Nh·∫≠p n·ªôi dung ph·∫£n h·ªìi..."></textarea>
        <div class="flex justify-end gap-2">
            <button id="popup-feedback-cancel"
                class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm font-semibold hover:bg-slate-200 transition">H·ªßy</button>
            <button id="popup-feedback-submit"
                class="px-4 py-2 rounded-lg bg-amber-500 text-white text-sm font-bold hover:bg-amber-600 shadow-md transition">G·ª≠i</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% include 'v3/includes/chat/chat_widget.html' %}
<script>
    (function () {
        // Initialize variables from template
        const initialRoom = {{ initial_room | tojson
    }};
    const roomCode = {{ room_code | tojson }};
    const currentUserId = {{ current_user_id | tojson }};
    const participantId = {{ participant_id | tojson }};
    const isHost = {{ is_host | tojson }};
    const fetchRoomUrl = {{ url_for('learning.quiz_battle.get_room', room_code = room_code) | tojson }};
    const leaveRoomUrl = {{ url_for('learning.quiz_battle.leave_room', room_code = room_code) | tojson }};
    const startRoomUrl = {{ url_for('learning.quiz_battle.start_room', room_code = room_code) | tojson }};
    const endRoomUrl = {{ url_for('learning.quiz_battle.end_room', room_code = room_code) | tojson }};
    const nextRoundUrl = {{ url_for('learning.quiz_battle.start_next_round', room_code = room_code) | tojson }};
    const getAiResponseUrl = {{ url_for('ai_services.get_ai_response') | tojson }};
    const messagesUrl = {{ url_for('shared.list_chat_messages', room_type = 'quiz-battle', room_code = room_code) | tojson }};
    const postMessageUrl = {{ url_for('shared.post_chat_message', room_type = 'quiz-battle', room_code = room_code) | tojson }};
    const answerUrlTemplate = {{ url_for('learning.quiz_battle.submit_round_answer', room_code = room_code, sequence_number = 0) | tojson }};
    const noteSaveUrlTemplate = {{ url_for('notes.save_note', item_id = 0) | tojson }};
    const feedbackSubmitUrl = {{ url_for('feedback.submit_feedback') | tojson }};
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    const chatPanel = document.getElementById('quiz-chat-panel');
    const openChatBtn = document.getElementById('open-chat-btn');
    const closeChatBtn = document.getElementById('close-chat-btn');
    const unreadBadge = document.getElementById('chat-unread-badge');
    const mobileBreakpoint = window.matchMedia('(max-width: 1024px)');

    // Mobile specific elements
    const mobileRoundDisplay = document.getElementById('mobile-round-display');
    const mobileTimerDisplay = document.getElementById('mobile-timer-display');
    const mobileLeaveBtn = document.getElementById('mobile-leave-btn');
    const mobileSubmitBtn = document.getElementById('mobile-submit-btn');
    const mobileTabs = document.querySelectorAll('.qb-mobile-tab-item');
    const tabPanes = document.querySelectorAll('.qb-tab-pane');

    // Stats Modal elements
    const mobileStatsBtn = document.getElementById('mobile-stats-btn');
    const statsModal = document.getElementById('stats-modal');
    const closeStatsBtn = document.getElementById('close-stats-btn');
    const mobileParticipantsList = document.getElementById('mobile-participants-list');

    // Note UI elements
    const hubNoteDisplayWrapper = document.getElementById('hub-note-display-wrapper');
    const hubNoteDisplay = document.getElementById('hub-note-display');
    const hubNoteEditBtn = document.getElementById('hub-note-edit-btn');
    const hubNoteEditWrapper = document.getElementById('hub-note-edit-wrapper');

    let roomState = initialRoom || {};
    // Force an initial render even if the server already sent an active round
    let lastRenderMeta = { sequence: null, hasMyAnswer: false };
    let roomPollInterval = null;
    let currentQuestionItemId = null;
    let pendingSelections = {};
    let visibleRound = roomState?.active_round || null;
    let pendingRoundSequence = null;
    let forceShowLatestRound = false;
    let chatController = null;
    const aiCoachContentEl = document.getElementById('question-ai-content');
    const aiCoachGenerateBtn = document.getElementById('ai-coach-generate-btn');
    const aiCoachButtonDefaultHtml = '<i class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o h∆∞·ªõng d·∫´n AI';

    // --- Mobile Tabs Logic ---
    mobileTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active from all
            mobileTabs.forEach(t => t.classList.remove('active'));
            tabPanes.forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none'; // Ensure hidden
            });

            // Activate clicked
            tab.classList.add('active');
            const targetId = `tab-pane-${tab.dataset.tab}`;
            const targetPane = document.getElementById(targetId);
            if (targetPane) {
                targetPane.style.display = 'block';
                // Slight delay to allow display:block to apply before adding opacity class for animation
                requestAnimationFrame(() => targetPane.classList.add('active'));
            }
        });
    });

    // Ensure correct initial tab state on load (Desktop ignores this due to CSS)
    if (window.innerWidth < 1024) {
        document.getElementById('tab-pane-game').style.display = 'block';
        document.getElementById('tab-pane-stats').style.display = 'none';
    }

    // --- Mobile Action Bar Sync ---
    if (mobileSubmitBtn) {
        mobileSubmitBtn.addEventListener('click', () => {
            // If button is actually "Next Round" mode
            if (mobileSubmitBtn.dataset.action === 'next') {
                document.getElementById('next-round-btn').click();
            } else if (mobileSubmitBtn.dataset.action === 'start') {
                document.getElementById('start-room-btn').click();
            } else {
                // Submit Answer mode
                const form = document.getElementById('answer-form');
                if (form) form.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });
    }

    if (mobileLeaveBtn) {
        mobileLeaveBtn.addEventListener('click', () => {
            if (confirm('R·ªùi ph√≤ng?')) {
                document.getElementById('leave-room-btn').click();
            }
        });
    }

    // --- Stats Modal Toggle ---
    if (mobileStatsBtn && statsModal) {
        mobileStatsBtn.addEventListener('click', () => {
            statsModal.classList.add('open');
            // Render participants into mobile list
            renderMobileParticipants(roomState.participants || []);
        });
    }

    if (closeStatsBtn && statsModal) {
        closeStatsBtn.addEventListener('click', () => {
            statsModal.classList.remove('open');
        });
    }

    function renderMobileParticipants(participants) {
        if (!mobileParticipantsList) return;
        if (!participants.length) {
            mobileParticipantsList.innerHTML = '<li class="text-center text-slate-400 text-sm py-4">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i.</li>';
            return;
        }

        // Sort by score descending
        const sorted = [...participants].sort((a, b) => (b.session_score || 0) - (a.session_score || 0));

        mobileParticipantsList.innerHTML = sorted.map((p, idx) => {
            const rank = idx + 1;
            const medalEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
            const isMe = p.user_id === currentUserId;
            const bgClass = isMe ? 'bg-blue-50' : '';
            const score = p.session_score || 0;
            const correctCount = p.correct_answers || 0;

            return `
                <li class="flex items-center justify-between px-4 py-3 ${bgClass}">
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold text-amber-500 w-8">${medalEmoji}</span>
                        <div>
                            <div class="font-semibold text-slate-800 text-sm">${p.username || 'Ng∆∞·ªùi ch∆°i'} ${isMe ? '<span class="text-[10px] text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded ml-1">B·∫°n</span>' : ''}</div>
                            <div class="text-xs text-slate-400">${correctCount} c√¢u ƒë√∫ng</div>
                        </div>
                    </div>
                    <div class="font-bold text-lg text-emerald-600">${score}</div>
                </li>
            `;
        }).join('');
    }

    // --- Helper Functions ---
    function setAlert(msg, type = 'info') {
        const box = document.getElementById('room-alert');
        if (!box) return;
        if (!msg) { box.classList.add('hidden'); return; }
        box.classList.remove('hidden', 'bg-blue-50', 'bg-rose-50', 'text-blue-700', 'text-rose-700', 'border-blue-200', 'border-rose-200');

        let icon = '<i class="fa-solid fa-circle-info"></i>';
        if (type === 'error') {
            box.classList.add('bg-rose-50', 'text-rose-700', 'border-rose-200');
            icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
        } else {
            box.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200');
        }
        box.innerHTML = `${icon} <span>${msg}</span>`;
    }

    async function postJson(url, data = {}) {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            // Tr√≠ch xu·∫•t l·ªói th√¥ng minh h∆°n
            let errorMessage = 'C√≥ l·ªói x·∫£y ra.';
            try {
                const errorData = await res.json();
                errorMessage = errorData.description || errorData.message || JSON.stringify(errorData);
            } catch (e) {
                const text = await res.text();
                errorMessage = text.substring(0, 100) + (text.length > 100 ? '...' : '');
            }
            throw new Error(errorMessage);
        }
        return res.json();
    }

    function getMyParticipant() {
        return (roomState.participants || []).find(p => p.user_id === currentUserId);
    }

    function syncNextButtonPlacement() {
        const nextBtn = document.getElementById('next-round-btn');
        if (!nextBtn) return;
        const shouldFloat = !nextBtn.classList.contains('hidden') && mobileBreakpoint.matches;
        nextBtn.classList.toggle('qb-next-mobile-floating', shouldFloat);
    }

    const renderAiContent = (value, options = {}) => {
        if (!aiCoachContentEl) return;
        if (window.applyMarkdownToElement) {
            window.applyMarkdownToElement(aiCoachContentEl, value || '', options);
        } else {
            aiCoachContentEl.textContent = value || '';
        }
    };

    async function generateAiCoachContent() {
        if (!currentQuestionItemId) return;

        if (aiCoachGenerateBtn) {
            aiCoachGenerateBtn.disabled = true;
            aiCoachGenerateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫°o...';
        }
        const hubAiBtn = document.getElementById('hub-ai-generate-btn');
        if (hubAiBtn) {
            hubAiBtn.disabled = true;
            hubAiBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        }

        renderAiContent('AI ƒëang t·∫°o h∆∞·ªõng d·∫´n...');
        const hubAiContent = document.getElementById('hub-ai-content');
        if (hubAiContent) hubAiContent.textContent = 'AI ƒëang t·∫°o h∆∞·ªõng d·∫´n...';

        try {
            const res = await postJson(getAiResponseUrl, {
                item_id: currentQuestionItemId,
                prompt_type: 'explanation',
            });

            const content = res?.response || res?.html_content || '';
            const treatAsHtml = Boolean(res?.html_content);
            if (content) {
                renderAiContent(content, { treatAsHtml });
                if (hubAiContent) {
                    if (window.applyMarkdownToElement) window.applyMarkdownToElement(hubAiContent, content, { treatAsHtml });
                    else hubAiContent.textContent = content;
                }

                if (roomState?.active_round?.question?.item_id === currentQuestionItemId) {
                    roomState.active_round.question.ai_explanation = content;
                }
                aiCoachGenerateBtn?.classList.add('hidden');
            } else {
                const msg = res?.message || 'AI ch∆∞a ph·∫£n h·ªìi h∆∞·ªõng d·∫´n.';
                renderAiContent(msg);
                if (hubAiContent) hubAiContent.textContent = msg;
                aiCoachGenerateBtn?.classList.remove('hidden');
            }
        } catch (err) {
            renderAiContent(`Kh√¥ng t·∫°o ƒë∆∞·ª£c h∆∞·ªõng d·∫´n: ${err.message}`);
            if (hubAiContent) hubAiContent.textContent = `L·ªói: ${err.message}`;
            aiCoachGenerateBtn?.classList.remove('hidden');
        } finally {
            if (aiCoachGenerateBtn) {
                aiCoachGenerateBtn.disabled = false;
                aiCoachGenerateBtn.innerHTML = aiCoachButtonDefaultHtml;
            }
            if (hubAiBtn) {
                hubAiBtn.disabled = false;
                hubAiBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o m·ªõi';
            }
        }
    }

    function renderChatMessages(msgs) {
        const container = document.getElementById('chat-messages');
        if (!container) return;
        container.innerHTML = '';
        if (!msgs.length) {
            container.innerHTML = '<p class="text-center text-sm text-slate-400 py-4">Ch∆∞a c√≥ tin nh·∫Øn. H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán!</p>';
            return;
        }
        msgs.forEach((msg, idx) => {
            const isMe = msg.user_id === currentUserId;
            const showAvatar = !isMe && (idx === 0 || msgs[idx - 1]?.user_id !== msg.user_id);
            const showName = !isMe && showAvatar;

            const div = document.createElement('div');
            div.className = `chat-message-row ${isMe ? 'chat-me' : 'chat-other'}`;

            // Get initials for avatar
            const initials = (msg.username || 'U').substring(0, 2).toUpperCase();
            const avatarColor = `hsl(${(msg.user_id || 0) * 137 % 360}, 60%, 55%)`;

            div.innerHTML = `
                ${!isMe ? `<div class="chat-avatar ${showAvatar ? '' : 'invisible'}" style="background: ${avatarColor}">${initials}</div>` : ''}
                <div class="chat-bubble-wrapper">
                    ${showName ? `<div class="chat-sender-name">${msg.username || 'Ng∆∞·ªùi ch∆°i'}</div>` : ''}
                    <div class="chat-bubble">${msg.content}</div>
                </div>
            `;
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    }

    // --- Room Logic Functions ---
    function renderParticipants(parts) {
        const list = document.getElementById('participants-list');
        if (!list) return;
        list.innerHTML = parts.map(p => {
            const answeredCount = (p.correct_answers || 0) + (p.incorrect_answers || 0);
            const correctCount = p.correct_answers || 0;
            const score = p.session_score || 0;

            return `
                    <li class="px-4 py-3 flex justify-between items-center bg-white hover:bg-slate-50 transition">
                        <div>
                            <p class="text-sm font-semibold text-slate-800 ${p.user_id === currentUserId ? 'text-blue-600' : ''}">
                                ${p.username || 'User'} ${p.is_host ? '<i class=\"fa-solid fa-crown text-yellow-500 text-xs ml-1\"></i>' : ''}
                            </p>
                            <p class="text-[10px] text-slate-500 uppercase">${p.status}</p>
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-center min-w-[210px]">
                            <div>
                                <span class="block text-sm font-bold text-slate-900">${answeredCount}</span>
                                <span class="text-[10px] text-slate-400">ƒë√£ tr·∫£ l·ªùi</span>
                            </div>
                            <div>
                                <span class="block text-sm font-bold text-emerald-700">${correctCount}</span>
                                <span class="text-[10px] text-emerald-500">ƒë√∫ng</span>
                            </div>
                            <div>
                                <span class="block text-sm font-bold text-slate-900">${score}</span>
                                <span class="text-[10px] text-slate-400">ƒëi·ªÉm</span>
                            </div>
                        </div>
                    </li>
                `;
        }).join('');
    }

    function syncVisibleRound() {
        const activeRound = roomState?.active_round || null;
        const matchingHistory = (roomState?.round_history || []).find(
            r => visibleRound && r.sequence_number === visibleRound.sequence_number
        );

        if (matchingHistory) {
            visibleRound = matchingHistory;
        } else if (
            activeRound &&
            visibleRound &&
            activeRound.sequence_number === visibleRound.sequence_number
        ) {
            visibleRound = activeRound;
        }
        if (forceShowLatestRound) {
            visibleRound = activeRound;
            pendingRoundSequence = null;
            forceShowLatestRound = false;
            return;
        }

        if (!visibleRound) {
            visibleRound = activeRound;
            pendingRoundSequence = null;
            return;
        }

        if (activeRound && activeRound.sequence_number > (visibleRound.sequence_number || 0)) {
            pendingRoundSequence = activeRound.sequence_number;
        } else if (!activeRound) {
            visibleRound = null;
            pendingRoundSequence = null;
        } else {
            pendingRoundSequence = null;
        }
    }

    function renderQuestion(round) {
        const overlay = document.getElementById('game-status-overlay');
        const title = document.getElementById('question-title');
        const detail = document.getElementById('question-detail');
        const mediaDiv = document.getElementById('question-media');
        const optionsDiv = document.getElementById('question-options');
        const submitBtn = document.getElementById('submit-answer-btn');
        const lockNote = document.getElementById('answer-locked-note');
        const inlineFeedback = document.getElementById('answer-inline-feedback');

        if (!round || !round.question) {
            if (overlay) {
                overlay.classList.remove('hidden');
                const msgEl = document.getElementById('game-overlay-msg');
                const titleEl = document.getElementById('game-overlay-title');
                if (roomState.status === 'lobby') {
                    titleEl.textContent = 'S·∫£nh ch·ªù';
                    msgEl.textContent = 'Ch·ªß ph√≤ng ch∆∞a b·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u.';
                } else if (roomState.status === 'awaiting_host') {
                    titleEl.textContent = 'Ch·ªù ch·ªß ph√≤ng';
                    msgEl.textContent = 'K·∫øt qu·∫£ ƒë√£ ch·ªët. Ch·ªù chuy·ªÉn sang c√¢u ti·∫øp theo.';
                } else if (roomState.status === 'completed') {
                    titleEl.textContent = 'K·∫øt th√∫c';
                    msgEl.textContent = 'Tr·∫≠n ƒë·∫•u ƒë√£ ho√†n th√†nh. Ki·ªÉm tra b·∫£ng x·∫øp h·∫°ng!';
                } else {
                    titleEl.textContent = 'ƒêang chu·∫©n b·ªã';
                    msgEl.textContent = 'ƒê·ª£i v√≤ng ti·∫øp theo...';
                }
            }
            if (mediaDiv) {
                mediaDiv.hidden = true;
                mediaDiv.innerHTML = '';
            }

            // Mobile Timer Sync
            if (mobileTimerDisplay) mobileTimerDisplay.textContent = '--';
            return;
        }

        const timerEl = document.getElementById('question-timer');
        const timeText = round.time_remaining_seconds ? `${round.time_remaining_seconds}s` : '';
        if (timerEl) timerEl.textContent = timeText;
        if (mobileTimerDisplay) mobileTimerDisplay.textContent = timeText || '--'; // Sync Mobile

        const opts = round.question.options || {};
        const answers = round.answers || [];
        const myAnswer = answers.find(a => a.participant_id === participantId);
        const hasMyAnswer = !!myAnswer;
        const isRoundActive = round.status === 'active';
        const correctOption = myAnswer?.correct_option || round.question.correct_option || null;
        const needFullRender =
            round.sequence_number !== lastRenderMeta.sequence ||
            hasMyAnswer !== lastRenderMeta.hasMyAnswer;

        if (needFullRender) {
            if (overlay) overlay.classList.add('hidden');

            title.textContent = round.question.question || 'C√¢u h·ªèi...';
            detail.textContent = round.question.passage_text || '';

            if (mediaDiv) {
                mediaDiv.innerHTML = '';
                const imageUrl = round.question.question_image_file;
                const audioUrl = round.question.question_audio_file;

                if (imageUrl) {
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = 'H√¨nh ·∫£nh c√¢u h·ªèi';
                    mediaDiv.appendChild(img);
                }

                if (audioUrl) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = audioUrl;
                    mediaDiv.appendChild(audio);
                }

                mediaDiv.hidden = mediaDiv.childElementCount === 0;
            }

            const roundKey = round.sequence_number;
            const selectedOption = hasMyAnswer
                ? myAnswer.selected_option
                : pendingSelections[roundKey] || null;
            const isLocked = hasMyAnswer || !isRoundActive;

            if (!hasMyAnswer && isRoundActive) {
                pendingSelections[roundKey] = selectedOption;
            }

            optionsDiv.innerHTML = Object.entries(opts).map(([key, val]) => {
                const isUserChoice = selectedOption === key || myAnswer?.selected_option === key;
                const isCorrect = correctOption && correctOption === key;
                const classes = ['qb-option-label'];
                if (isUserChoice) classes.push('is-user'); // Simplified class logic relies on CSS
                if (isCorrect) classes.push('is-correct');
                if (isLocked) classes.push('is-locked');
                const badges = [];
                if (isUserChoice) badges.push('<span class="qb-option-badge is-user">B·∫°n ch·ªçn</span>');
                if (isCorrect) badges.push('<span class="qb-option-badge is-correct">ƒê√°p √°n ƒë√∫ng</span>');
                return `
                        <label class="${classes.join(' ')}">
                            <input type="radio" name="selected_option" value="${key}" class="qb-option-input" ${isLocked ? 'disabled' : ''} ${isUserChoice ? 'checked' : ''}>
                            <div class="flex flex-col gap-1 w-full">
                                <div class="flex flex-wrap items-center justify-between w-full">
                                    <div class="flex items-center gap-3">
                                        <span class="qb-option-letter-circle">${key}</span>
                                        <span class="text-slate-800 font-medium text-lg leading-tight">${val}</span>
                                    </div>
                                    ${badges.length ? `<div class="qb-option-badges">${badges.join('')}</div>` : ''}
                                </div>
                            </div>
                        </label>
                    `;
            }).join('');

            if (!hasMyAnswer && isRoundActive) {
                optionsDiv.querySelectorAll('input[name="selected_option"]').forEach(input => {
                    input.addEventListener('change', () => {
                        pendingSelections[round.sequence_number] = input.value;
                        submitBtn.disabled = false;
                        if (mobileSubmitBtn) mobileSubmitBtn.disabled = false; // Enable Mobile Btn

                        // Update visual state - remove is-user from all, add to selected
                        optionsDiv.querySelectorAll('.qb-option-label').forEach(lbl => lbl.classList.remove('is-user'));
                        input.closest('.qb-option-label')?.classList.add('is-user');
                    });
                });
            }

            // Desktop Button Logic
            submitBtn.disabled =
                hasMyAnswer ||
                !participantId ||
                (!hasMyAnswer && !pendingSelections[round.sequence_number]) ||
                !isRoundActive;
            submitBtn.classList.toggle('hidden', hasMyAnswer);
            submitBtn.innerHTML = hasMyAnswer
                ? '<i class="fa-solid fa-check"></i> ƒê√£ tr·∫£ l·ªùi'
                : isRoundActive
                    ? '<i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n'
                    : '<i class="fa-solid fa-hourglass"></i> Ch·ªù c√¢u ti·∫øp theo';

            // Mobile Button Logic Sync (Primary State: Submit Answer)
            if (mobileSubmitBtn) {
                mobileSubmitBtn.disabled = submitBtn.disabled;
                mobileSubmitBtn.dataset.action = 'submit';
                mobileSubmitBtn.innerHTML = submitBtn.innerHTML;
                if (hasMyAnswer) {
                    mobileSubmitBtn.classList.remove('cm-btn-primary');
                    mobileSubmitBtn.classList.add('bg-emerald-100', 'text-emerald-700');
                } else {
                    mobileSubmitBtn.classList.add('cm-btn-primary');
                    mobileSubmitBtn.classList.remove('bg-emerald-100', 'text-emerald-700');
                }
            }

            if (lockNote) lockNote.classList.toggle('hidden', !hasMyAnswer);
            if (inlineFeedback) inlineFeedback.textContent = '';

            const mobileHubBtn = document.getElementById('open-hub-btn');
            if (mobileHubBtn && !hasMyAnswer) mobileHubBtn.classList.add('hidden');

            lastRenderMeta = { sequence: round.sequence_number, hasMyAnswer };
        }

        currentQuestionItemId = round.question.item_id;
        if (hasMyAnswer) updateFeedbackAndInsights(round, myAnswer);
        else {
            document.getElementById('answer-result-panel').hidden = true;
            document.getElementById('answer-explanation-panel').hidden = true;
            document.getElementById('question-insight-panel').hidden = true;
        }

        renderStats(round);
    }

    // --- Mobile Hub Logic ---
    const hubModal = document.getElementById('explanation-hub-modal');
    const openHubBtn = document.getElementById('open-hub-btn');
    const closeHubBtn = document.getElementById('close-hub-btn');
    const hubTabs = document.querySelectorAll('.qb-hub-tab-item');
    const hubPanes = document.querySelectorAll('.qb-hub-pane');

    if (openHubBtn && hubModal) {
        openHubBtn.addEventListener('click', () => hubModal.classList.add('open'));
        closeHubBtn?.addEventListener('click', () => hubModal.classList.remove('open'));
        hubModal.addEventListener('click', (e) => {
            if (e.target === hubModal) hubModal.classList.remove('open');
        });

        hubTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                hubTabs.forEach(t => t.classList.remove('active'));
                hubPanes.forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                const targetId = tab.dataset.target;
                document.getElementById(targetId)?.classList.add('active');
            });
        });
    }

    function updateFeedbackAndInsights(round, answer) {
        const resultPanel = document.getElementById('answer-result-panel');
        const explanationPanel = document.getElementById('answer-explanation-panel');
        const insights = document.getElementById('question-insight-panel');
        const mobileHubBtn = document.getElementById('open-hub-btn');
        if (!answer) return;

        if (mobileHubBtn) mobileHubBtn.classList.remove('hidden');
        resultPanel.hidden = false;
        explanationPanel.hidden = false;
        insights.hidden = false;

        const isCorrect = answer.is_correct;
        document.getElementById('answer-feedback-icon').textContent = isCorrect ? 'üéâ' : 'ü§î';
        document.getElementById('answer-feedback-title').textContent = isCorrect ? 'Ch√≠nh x√°c!' : 'Ch∆∞a ƒë√∫ng';
        document.getElementById('answer-feedback-detail').textContent = isCorrect ? `B·∫°n nh·∫≠n ƒë∆∞·ª£c +${answer.score_delta} ƒëi·ªÉm.` : 'ƒê·ª´ng lo, h√£y xem gi·∫£i th√≠ch b√™n d∆∞·ªõi.';
        document.getElementById('answer-feedback-correct').textContent = answer.correct_option || '?';
        document.getElementById('answer-feedback-score').textContent = (answer.score_delta > 0 ? '+' : '') + answer.score_delta;

        const expDiv = document.getElementById('answer-feedback-explanation');
        const explanationText =
            answer.explanation || round.question.explanation || 'Ch∆∞a c√≥ gi·∫£i th√≠ch.';
        expDiv.innerHTML = explanationText.replace(/\n/g, '<br>');

        // Populate Mobile Hub Data
        const hubCorrectOption = document.getElementById('hub-correct-option');
        const hubExplText = document.getElementById('hub-explanation-text');
        if (hubCorrectOption) hubCorrectOption.textContent = answer.correct_option || '?';
        if (hubExplText) hubExplText.innerHTML = explanationText.replace(/\n/g, '<br>');

        const aiExplanation = round.question.ai_explanation || '';
        renderAiContent(aiExplanation || 'AI ƒëang ngh·ªâ ng∆°i...');

        // Sync AI content to Hub
        const hubAiContent = document.getElementById('hub-ai-content');
        if (hubAiContent) {
            if (window.applyMarkdownToElement) {
                window.applyMarkdownToElement(hubAiContent, aiExplanation || 'Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...', { treatAsHtml: false });
            } else {
                hubAiContent.textContent = aiExplanation || 'Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...';
            }
        }

        if (aiCoachGenerateBtn) {
            aiCoachGenerateBtn.classList.toggle('hidden', Boolean(aiExplanation));
            aiCoachGenerateBtn.disabled = false;
            aiCoachGenerateBtn.innerHTML = aiCoachButtonDefaultHtml;
        }

        const noteContent = round.question.note_content || '';
        // For desktop view (if present)
        const desktopQNoteContent = document.getElementById('question-note-content');
        const desktopQNoteInput = document.getElementById('question-note-input');
        if (desktopQNoteContent) desktopQNoteContent.textContent = noteContent || 'B·∫°n ch∆∞a c√≥ ghi ch√∫.';
        if (desktopQNoteInput) desktopQNoteInput.value = noteContent;

        // For Mobile Hub notes
        const isEditing = hubNoteEditWrapper && !hubNoteEditWrapper.classList.contains('hidden');
        if (!isEditing) {
            if (noteContent) {
                toggleNoteEditMode(false, noteContent); // Show display mode with content
            } else {
                toggleNoteEditMode(true, ''); // Show edit mode (empty)
            }
        }
    }

    function renderStats(round) {
        const answers = round.answers || [];
        const myAnswer = answers.find(a => a.participant_id === participantId);
        const hasMyAnswer = !!myAnswer;
        const answersLocked = round.answers_locked && round.status === 'active';
        const total = answers.length;
        const correct = answers.filter(a => a.is_correct).length;

        document.getElementById('question-stats-round').textContent = `#${round.sequence_number}`;
        if (mobileRoundDisplay) mobileRoundDisplay.textContent = round.sequence_number || '--'; // Sync Mobile

        const lockedNotice = document.getElementById('question-stats-locked');
        const emptyNotice = document.getElementById('question-stats-empty');
        const distDiv = document.getElementById('option-distribution');
        const breakdownDiv = document.getElementById('option-breakdown');

        if (round.status === 'active' && (!hasMyAnswer || answersLocked)) {
            document.getElementById('question-stats-total').textContent = '--';
            document.getElementById('question-stats-accuracy').textContent = '--%';
            lockedNotice.hidden = false;
            emptyNotice.hidden = true;
            distDiv.innerHTML = '';
            breakdownDiv.innerHTML = '';
            return;
        }

        lockedNotice.hidden = true;
        document.getElementById('question-stats-total').textContent = total;
        document.getElementById('question-stats-accuracy').textContent = total ? Math.round((correct / total) * 100) + '%' : '--%';

        if (total === 0) {
            emptyNotice.hidden = false;
            distDiv.innerHTML = '';
            breakdownDiv.innerHTML = '';
            return;
        }

        emptyNotice.hidden = true;
        const counts = {};
        const groupedNames = {};
        answers.forEach(a => {
            counts[a.selected_option] = (counts[a.selected_option] || 0) + 1;
            const label = a.username || `Ng∆∞·ªùi ch∆°i #${a.participant_id}`;
            groupedNames[a.selected_option] = groupedNames[a.selected_option] || [];
            groupedNames[a.selected_option].push(label);
        });

        const options = round.question.options || {};
        distDiv.innerHTML = Object.entries(options).map(([k, v]) => {
            const c = counts[k] || 0;
            const p = Math.round((c / total) * 100);
            const myCorrectOption = myAnswer?.correct_option;
            const isCorrect = myCorrectOption ? k === myCorrectOption : false;
            return `
                    <div class="flex items-center gap-2">
                        <span class="w-4 font-bold ${isCorrect ? 'text-emerald-600' : 'text-slate-500'}">${k}</span>
                        <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full ${isCorrect ? 'bg-emerald-500' : 'bg-blue-400'}" style="width: ${p}%"></div>
                        </div>
                        <span class="text-xs text-slate-400 w-8 text-right">${c}</span>
                    </div>
                `;
        }).join('');

        breakdownDiv.innerHTML = Object.entries(options).map(([k, v]) => {
            const names = groupedNames[k] || [];
            const chips = names.length
                ? names.map(name => `<span class="px-2 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-200">${name}</span>`).join(' ')
                : '<span class="text-slate-400 italic">Ch∆∞a c√≥ ai ch·ªçn</span>';
            return `
                    <div class="space-y-1">
                        <div class="font-semibold text-slate-600">${k}. ${v || ''}</div>
                        <div class="flex flex-wrap gap-2">${chips}</div>
                    </div>
                `;
        }).join('');
    }

    function hydrateUi() {
        // Use optional chaining for elements that might not exist
        const roomStatusEl = document.getElementById('room-status');
        if (roomStatusEl) {
            roomStatusEl.textContent = roomState.status;
            roomStatusEl.dataset.status = roomState.status;
        }

        const roundProgressEl = document.getElementById('round-progress');
        if (roundProgressEl) roundProgressEl.textContent = `Ti·∫øn ƒë·ªô: ${roomState.current_round_number || 0}/${roomState.question_total || 0}`;

        // Mobile Round Sync
        if (mobileRoundDisplay) mobileRoundDisplay.textContent = roomState.current_round_number || '--';

        const me = getMyParticipant();
        const answeredCount = me ? (me.correct_answers || 0) + (me.incorrect_answers || 0) : null;

        const playerAnsweredEl = document.getElementById('player-answered');
        if (playerAnsweredEl) playerAnsweredEl.textContent = `ƒê√£ tr·∫£ l·ªùi: ${answeredCount !== null ? answeredCount : '--'} c√¢u`;

        const playerScoreEl = document.getElementById('player-score');
        if (playerScoreEl) playerScoreEl.textContent = `T·ªïng ƒëi·ªÉm: ${me ? me.session_score || 0 : '--'}`;

        const roomModeEl = document.getElementById('room-mode');
        if (roomModeEl) roomModeEl.textContent = `Ch·∫ø ƒë·ªô: ${roomState.mode === 'TIMED' ? 'T√≠nh gi·ªù' : 'Th∆∞·ªùng'}`;

        renderParticipants(roomState.participants || []);
        syncVisibleRound();
        renderQuestion(visibleRound);

        const canStart = isHost && roomState.status === 'lobby';
        const canAdvance =
            pendingRoundSequence !== null &&
            roomState.status !== 'completed';
        const canEnd = isHost && roomState.status !== 'completed';

        // Desktop Logic
        document.getElementById('start-room-btn').disabled = !canStart;
        document.getElementById('start-room-btn').classList.toggle('hidden', roomState.status !== 'lobby');
        const nextBtn = document.getElementById('next-round-btn');
        nextBtn.classList.toggle('hidden', !canAdvance);
        nextBtn.disabled = !canAdvance;
        document.getElementById('end-room-btn').disabled = !canEnd;
        if (roomState.status === 'completed') {
            document.getElementById('leave-room-btn').innerHTML = '<i class="fa-solid fa-person-walking-arrow-right"></i> Tho√°t';
        }
        // Removed syncNextButtonPlacement();

        // Mobile Button Override Logic (Start/Next takes precedence over Submit)
        if (mobileSubmitBtn) {
            if (canStart) {
                mobileSubmitBtn.disabled = false;
                mobileSubmitBtn.innerHTML = '<i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u';
                mobileSubmitBtn.classList.remove('bg-emerald-100', 'text-emerald-700');
                mobileSubmitBtn.classList.add('cm-btn-primary');
                mobileSubmitBtn.dataset.action = 'start';
            } else if (canAdvance) {
                mobileSubmitBtn.disabled = false;
                mobileSubmitBtn.innerHTML = '<i class="fa-solid fa-forward-step"></i> C√¢u h·ªèi ti·∫øp theo';
                mobileSubmitBtn.classList.remove('bg-emerald-100', 'text-emerald-700');
                mobileSubmitBtn.classList.add('cm-btn-primary');
                mobileSubmitBtn.dataset.action = 'next';
            } else if (roomState.status === 'completed') {
                mobileSubmitBtn.disabled = true;
                mobileSubmitBtn.innerHTML = 'Tr·∫≠n ƒë·∫•u k·∫øt th√∫c';
                mobileSubmitBtn.classList.add('bg-slate-100', 'text-slate-400');
                mobileSubmitBtn.classList.remove('cm-btn-primary');
            }
        }
    }


    async function fetchRoomState(forceLatest = false) {
        try {
            const res = await fetch(fetchRoomUrl);
            if (res.ok) {
                const data = await res.json();
                roomState = data.room;
                if (forceLatest) {
                    forceShowLatestRound = true;
                    lastRenderMeta = { sequence: null, hasMyAnswer: false };
                }
                hydrateUi();
            }
        } catch (e) { console.error("Sync error", e); }
    }

    // --- Event Listeners (ƒê√£ th√™m error handling) ---

    if (aiCoachGenerateBtn) {
        aiCoachGenerateBtn.innerHTML = aiCoachButtonDefaultHtml;
        aiCoachGenerateBtn.addEventListener('click', generateAiCoachContent);
    }
    const hubAiBtn = document.getElementById('hub-ai-generate-btn');
    if (hubAiBtn) {
        hubAiBtn.addEventListener('click', generateAiCoachContent);
    }

    // mobileBreakpoint.addEventListener('change', syncNextButtonPlacement); // Removed as mobile bottom bar handles this

    document.getElementById('start-room-btn').addEventListener('click', async () => {
        try {
            await postJson(startRoomUrl);
            pendingSelections = {};
            forceShowLatestRound = true;
            fetchRoomState(true);
        } catch (e) { setAlert(e.message, 'error'); }
    });

    document.getElementById('end-room-btn').addEventListener('click', async () => {
        if (!confirm('K·∫øt th√∫c tr·∫≠n ƒë·∫•u?')) return;
        try {
            await postJson(endRoomUrl);
            fetchRoomState();
        } catch (e) { setAlert(e.message, 'error'); }
    });

    document.getElementById('next-round-btn').addEventListener('click', async () => {
        try {
            await postJson(nextRoundUrl);
            pendingSelections = {};
            forceShowLatestRound = true;
            fetchRoomState(true);
        } catch (e) { setAlert(e.message, 'error'); }
    });

    document.getElementById('leave-room-btn').addEventListener('click', async () => {
        if (!confirm('R·ªùi ph√≤ng?')) return;
        try {
            await postJson(leaveRoomUrl);
            window.location.href = "{{ url_for('learning.quiz_learning.dashboard') }}";
        } catch (e) { setAlert(e.message, 'error'); }
    });

    document.getElementById('answer-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const selected = new FormData(e.target).get('selected_option');
        if (!selected) return setAlert('Ch·ªçn m·ªôt ƒë√°p √°n!', 'error');

        const btn = document.getElementById('submit-answer-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang g·ª≠i...';

        try {
            const seq = (visibleRound || roomState.active_round).sequence_number;
            const url = answerUrlTemplate.replace('/0/', `/${seq}/`);
            const data = await postJson(url, { selected_option: selected });
            roomState = data.room;
            const mergedAnswer = {
                participant_id: participantId,
                user_id: currentUserId,
                selected_option: selected,
                is_correct: data.answer?.is_correct,
                score_delta: data.answer?.score_delta,
                correct_option: data.answer?.correct_option,
                explanation: data.answer?.explanation,
                answered_at: new Date().toISOString(),
            };
            const roundFromRoom =
                (roomState.round_history || []).find(r => r.sequence_number === seq) ||
                (roomState.active_round?.sequence_number === seq ? roomState.active_round : null) ||
                visibleRound;
            if (roundFromRoom) {
                const existing = (roundFromRoom.answers || []).filter(a => a.participant_id !== participantId);
                roundFromRoom.answers = [...existing, mergedAnswer];
                visibleRound = roundFromRoom;
            }
            pendingSelections[seq] = null;
            // Force a fresh render so the submit button swaps out of the pending state
            // immediately after we record the answer.
            lastRenderMeta = { sequence: null, hasMyAnswer: false };
            hydrateUi();
        } catch (err) {
            setAlert(err.message, 'error');
            btn.disabled = false;
            btn.innerHTML = 'Th·ª≠ l·∫°i';
        }
    });

    chatController = window.sharedChat?.initChat({
        messagesUrl,
        postMessageUrl,
        currentUserId,
        pollInterval: 5000,
        csrfToken,
        elements: {
            messages: document.getElementById('chat-messages'),
            form: document.getElementById('chat-form'),
            input: document.getElementById('chat-input'),
            panel: chatPanel,
            openButton: openChatBtn,
            closeButton: closeChatBtn,
            unreadBadge,
        },
        renderMessages: renderChatMessages,
    });

    chatPanel?.addEventListener('click', (event) => {
        if (event.target === chatPanel) {
            chatController?.setOpen(false);
        }
    });

    // Manual override to ensure chat opens
    openChatBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Chat button clicked. Controller:', chatController);

        if (chatController && typeof chatController.setOpen === 'function') {
            console.log('Calling chatController.setOpen(true)');
            chatController.setOpen(true);
        } else {
            console.warn('Chat controller missing or invalid. Using manual fallback.');
            if (chatPanel) {
                chatPanel.classList.add('open');
                chatPanel.style.visibility = 'visible';
                chatPanel.style.opacity = '1';
                chatPanel.style.pointerEvents = 'auto';
            }
        }
    });

    // Also ensure close button works manually if controller is dead
    closeChatBtn?.addEventListener('click', (e) => {
        if (!chatController) {
            e.preventDefault();
            if (chatPanel) {
                chatPanel.classList.remove('open');
                chatPanel.style.removeProperty('visibility');
                chatPanel.style.removeProperty('opacity');
                chatPanel.style.removeProperty('pointer-events');
            }
        }
    });

    // --- Notes & Feedback Logic (Unified for Desktop & Hub) ---

    // Helper to toggle note edit/display mode
    function toggleNoteEditMode(enableEdit, noteContent = '') {
        const hubNoteInput = document.getElementById('hub-note-input');
        if (enableEdit) {
            if (hubNoteEditWrapper) hubNoteEditWrapper.classList.remove('hidden');
            if (hubNoteDisplayWrapper) hubNoteDisplayWrapper.classList.add('hidden');
            if (hubNoteDisplay) hubNoteDisplay.innerHTML = ''; // Clear display when editing
            if (hubNoteInput) hubNoteInput.value = noteContent; // Pre-fill textarea
        } else {
            if (hubNoteEditWrapper) hubNoteEditWrapper.classList.add('hidden');
            if (hubNoteDisplayWrapper) hubNoteDisplayWrapper.classList.remove('hidden');
            if (hubNoteDisplay) hubNoteDisplay.innerHTML = noteContent.replace(/\n/g, '<br>'); // Display with line breaks
        }
    }

    async function saveNote(content) {
        if (!currentQuestionItemId) {
            setAlert('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c c√¢u h·ªèi.', 'error');
            return;
        }

        const url = noteSaveUrlTemplate.replace('0', currentQuestionItemId);

        try {
            await postJson(url, { content });
        } catch (e) {
            throw e; // Re-throw to be caught by caller
        }

        // Sync UI (Safely)
        const qContent = document.getElementById('question-note-content');
        const qInput = document.getElementById('question-note-input');
        const hubInput = document.getElementById('hub-note-input');

        if (qContent) qContent.textContent = content;
        if (qInput) qInput.value = content;
        if (hubInput) hubInput.value = content;

        // Desktop toggle logic (Safely)
        const qEditor = document.getElementById('question-note-editor');
        if (qEditor && qContent) {
            qEditor.classList.add('hidden');
            qContent.classList.remove('hidden');
        }

        // Mobile Hub Notes: Switch to display mode
        toggleNoteEditMode(false, content);

        setAlert('ƒê√£ l∆∞u ghi ch√∫.', 'success');
        setTimeout(() => setAlert(''), 2000);
    }

    async function sendFeedback(text, inputEl) {
        if (!text) return setAlert('Vui l√≤ng nh·∫≠p n·ªôi dung.', 'error');
        if (!currentQuestionItemId) return setAlert('L·ªói ID c√¢u h·ªèi.', 'error');
        try {
            await postJson(feedbackSubmitUrl, { item_id: currentQuestionItemId, feedback_text: text });
            if (inputEl) inputEl.value = '';
            setAlert('C·∫£m ∆°n ƒë√≥ng g√≥p c·ªßa b·∫°n!', 'success');
            setTimeout(() => setAlert(''), 3000);
        } catch (e) { setAlert(e.message, 'error'); }
    }

    // Desktop Note Events
    document.getElementById('question-note-edit').addEventListener('click', () => {
        document.getElementById('question-note-editor').classList.remove('hidden');
        document.getElementById('question-note-content').classList.add('hidden');
    });
    document.getElementById('question-note-cancel').addEventListener('click', () => {
        document.getElementById('question-note-editor').classList.add('hidden');
        document.getElementById('question-note-content').classList.remove('hidden');
    });
    document.getElementById('question-note-save').addEventListener('click', async () => {
        try { await saveNote(document.getElementById('question-note-input').value); } catch (e) { setAlert(e.message, 'error'); }
    });

    // Mobile Hub Note Event (Save)
    const hubNoteSave = document.getElementById('hub-note-save');
    if (hubNoteSave) {
        hubNoteSave.addEventListener('click', async () => {
            const inputVal = document.getElementById('hub-note-input').value;
            try {
                await saveNote(inputVal);
            } catch (e) {
                setAlert(e.message, 'error');
            }
        });
    }

    // Mobile Hub Note Edit Event
    if (hubNoteEditBtn) {
        hubNoteEditBtn.addEventListener('click', () => {
            const currentNote = hubNoteDisplay?.innerHTML.replace(/<br>/g, '\n') || ''; // Convert <br> back to \n
            toggleNoteEditMode(true, currentNote);
        });
    }

    // Feedback Events (Desktop)
    const desktopFeedbackSubmit = document.getElementById('question-feedback-submit');
    if (desktopFeedbackSubmit) {
        desktopFeedbackSubmit.addEventListener('click', () => {
            const input = document.getElementById('question-feedback-input');
            sendFeedback(input.value.trim(), input);
        });
    }

    // Feedback Events (Mobile Modal)
    const openFeedbackBtn = document.getElementById('open-feedback-modal-btn');
    const feedbackModal = document.getElementById('feedback-popup');
    const feedbackSubmitBtn = document.getElementById('popup-feedback-submit');
    const feedbackCancelBtn = document.getElementById('popup-feedback-cancel');

    if (openFeedbackBtn && feedbackModal) {
        openFeedbackBtn.addEventListener('click', () => {
            // Close Hub Modal first if open
            const hubModal = document.getElementById('explanation-hub-modal');
            if (hubModal && hubModal.classList.contains('open')) {
                hubModal.classList.remove('open');
                // Store a flag to reopen it later if needed
                feedbackModal.dataset.reopenHub = 'true';
            } else {
                feedbackModal.dataset.reopenHub = 'false';
            }

            feedbackModal.classList.remove('hidden', 'invisible', 'opacity-0');
            // Ensure z-index is high enough
            feedbackModal.style.zIndex = '110';
        });

        const closeFeedback = () => {
            feedbackModal.classList.add('invisible', 'opacity-0');
            setTimeout(() => {
                feedbackModal.classList.add('hidden');
                feedbackModal.style.zIndex = ''; // Reset z-index

                // Reopen Hub Modal if it was closed by this action
                if (feedbackModal.dataset.reopenHub === 'true') {
                    const hubModal = document.getElementById('explanation-hub-modal');
                    if (hubModal) hubModal.classList.add('open');
                }
            }, 300);
        };

        feedbackCancelBtn.addEventListener('click', closeFeedback);

        feedbackSubmitBtn.addEventListener('click', async () => {
            const input = document.getElementById('popup-feedback-input');
            await sendFeedback(input.value.trim(), input);
            closeFeedback();
        });

        feedbackModal.addEventListener('click', (e) => {
            if (e.target === feedbackModal) closeFeedback();
        });
    }

    const copyRoomCodeHandler = () => {
        navigator.clipboard.writeText(roomCode);
        setAlert('ƒê√£ sao ch√©p m√£ ph√≤ng!');
        setTimeout(() => setAlert(''), 2000);
    };
    document.getElementById('copy-room-code')?.addEventListener('click', copyRoomCodeHandler);
    document.getElementById('mobile-copy-code')?.addEventListener('click', copyRoomCodeHandler);

    // Init
    hydrateUi();
    roomPollInterval = setInterval(fetchRoomState, 3000);

    window.addEventListener('beforeunload', () => {
        clearInterval(roomPollInterval);
        chatController?.stopPolling();
    });

    }) ();
</script>
{% endblock %}