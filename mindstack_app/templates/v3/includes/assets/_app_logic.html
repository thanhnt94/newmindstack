{% include 'v3/pages/notification/center.html' %}
{% include 'v3/includes/modals/_settings_modal.html' %}

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-content w-full h-full md:w-2/3 lg:w-1/2">
        <iframe id="modalIframe" class="modal-iframe"></iframe>
    </div>
</div>

<style>
    /* Gamified Score Toast */
    .score-toast {
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4rem;
        font-weight: 900;
        color: #fbbf24;
        /* Amber */
        text-shadow: 2px 2px 0px #fff, 0 4px 15px rgba(0, 0, 0, 0.3);
        pointer-events: none;
        z-index: 10000;
        font-family: 'Inter', sans-serif;
        animation: scoreFloatUp 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .score-toast i {
        font-size: 3rem;
        color: #f59e0b;
    }

    @keyframes scoreFloatUp {
        0% {
            transform: translate(-50%, -30%) scale(0.5) rotate(-10deg);
            opacity: 0;
        }

        20% {
            transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
            opacity: 1;
        }

        40% {
            transform: translate(-50%, -55%) scale(1);
        }

        100% {
            transform: translate(-50%, -100%) scale(0.8);
            opacity: 0;
        }
    }
</style>

<script>
    // Các hàm toàn cục để iframe con có thể gọi
    window.openModal = function (url) {
        const modalOverlay = document.getElementById('modalOverlay');
        const modalIframe = document.getElementById('modalIframe');
        if (modalOverlay && modalIframe) {
            let finalUrl = url.includes('?') ? `${url}&is_modal=true` : `${url}?is_modal=true`;
            modalIframe.src = finalUrl;
            modalOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
        }
    };

    window.closeModal = function () {
        const modalOverlay = document.getElementById('modalOverlay');
        const modalIframe = document.getElementById('modalIframe');
        if (modalOverlay && modalIframe) {
            modalOverlay.classList.remove('open');
            modalIframe.src = '';
            document.body.style.overflow = '';
        }
    };

    // Gamified Score Notification
    window.showScoreToast = function (points) {
        // Only show if positive points
        if (points <= 0) return;

        const el = document.createElement('div');
        el.className = 'score-toast';
        // Add star icon for extra flair
        el.innerHTML = `<i class="fas fa-gem text-blue-400"></i> +${points}`;

        document.body.appendChild(el);

        // Haptic feedback if available (mobile)
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }

        setTimeout(() => el.remove(), 1200);
    };

    window.showFlashMessage = function (message, category) {
        const container = document.getElementById('flash-messages-container');
        if (!container) return;
        const alertDiv = document.createElement('div');
        alertDiv.className = `flex items-center p-2 rounded-md shadow-lg bg-gray-800 text-white relative text-sm opacity-100 transition-opacity duration-500" data-dismissible`;
        alertDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i><span>${message}</span><button class="ml-auto pl-2" onclick="this.parentNode.remove()">&times;</button>`;
        if (category === 'success') alertDiv.classList.add('bg-green-500');
        else if (category === 'danger') alertDiv.classList.add('bg-red-500');
        else if (category === 'info') alertDiv.classList.add('bg-blue-500');
        else if (category === 'warning') alertDiv.classList.add('bg-yellow-500');
        else alertDiv.classList.add('bg-gray-500');

        container.appendChild(alertDiv);
        setTimeout(() => alertDiv.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            alertDiv.classList.add('opacity-0');
            setTimeout(() => alertDiv.remove(), 500);
        }, 5000);
    };

    // Hàm loadTabContent này sẽ được cập nhật để tải nội dung AJAX cho các tab trong content_dashboard
    // Tuy nhiên, ở đây nó đang được sử dụng để reload trang.
    // Cần lưu ý nếu có xung đột với logic AJAX của content_dashboard
    window.loadTabContent = function (tabName) {
        window.location.reload();
    };

    document.addEventListener('DOMContentLoaded', function () {
        // Tự động đóng flash messages
        document.querySelectorAll('[data-dismissible]').forEach(notification => {
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        });

        const modalOverlay = document.getElementById('modalOverlay');

        // Lắng nghe sự kiện click để mở modal
        document.addEventListener('click', function (event) {
            const target = event.target.closest('.open-modal-btn');
            if (target && target.dataset.modalUrl) {
                event.preventDefault();
                window.openModal(target.dataset.modalUrl);
            }
        });

        // Lắng nghe sự kiện click để đóng modal
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function (event) {
                if (event.target === modalOverlay) {
                    window.closeModal();
                }
            });
        }
    });
</script>
<script src="{{ url_for('translator.static', filename='js/translator.js') }}"></script>
{# Image Viewer Helper #}
{% include 'v3/includes/assets/_image_viewer.html' %}