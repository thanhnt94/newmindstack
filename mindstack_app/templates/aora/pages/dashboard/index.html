{#
index.html - Dashboard V4 Version
Extends v4/base.html directly. Uses static v4/ paths.
#}
{% set _v = template_version %}
{% extends _v ~ '/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* CSS cho thanh cuộn tùy chỉnh (chỉ áp dụng nơi gán class) */
    .custom-scrollbar-dark::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .custom-scrollbar-dark::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    .custom-scrollbar-dark::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
    }

    .custom-scrollbar-dark::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
        background-clip: content-box;
    }

    /* App-like horizontal scroll (For Mobile) */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-transparent">
    {# --- Giao diện Mobile (App-like) --- #}
    <div class="lg:hidden">
        {% include _v ~ '/pages/dashboard/_mobile.html' %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadActiveSessions();
        });

        async function loadActiveSessions() {
            const containers = {
                mobile: {
                    wrap: document.getElementById('active-sessions-mobile'),
                    list: document.getElementById('active-sessions-list-mobile'),
                    count: document.getElementById('active-sessions-count-mobile')
                },
                desktop: {
                    wrap: document.getElementById('active-sessions-desktop'),
                    list: document.getElementById('active-sessions-list-desktop'),
                    count: document.getElementById('active-sessions-count-desktop')
                }
            };

            try {
                const res = await fetch('/learn/api/active');
                const sessions = await res.json();

                if (sessions && sessions.length > 0) {
                    const totalCount = sessions.length;
                    const limitedSessions = sessions.slice(0, 5);

                    // Logic to render items (shared)
                    const renderSessions = (items) => items.map(s => {
                        const isQuiz = s.learning_mode === 'quiz';
                        const iconClass = isQuiz ? 'fa-bolt' : 'fa-layer-group';
                        const iconBg = isQuiz ? 'bg-amber-100 text-amber-600' : 'bg-indigo-100 text-indigo-600';
                        const btnBg = isQuiz ? 'bg-amber-500' : 'bg-indigo-600';
                        const label = isQuiz ? 'câu' : 'thẻ';

                        return `
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between group hover:border-red-100/50 hover:shadow-md active:scale-[0.98] transition-all">
                            <div class="flex items-center gap-3 min-w-0 flex-1">
                                <div class="w-10 h-10 rounded-xl ${iconBg} flex items-center justify-center text-lg flex-shrink-0">
                                    <i class="fa-solid ${iconClass}"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <h4 class="font-bold text-sm text-slate-800 truncate">${s.container_name}</h4>
                                    <p class="text-[10px] text-slate-400 font-medium">${s.mode_name} • ${s.progress.done}/${s.progress.total} ${label}</p>
                                </div>
                            </div>
                            <a href="${s.resume_url}" class="flex-shrink-0 ${btnBg} text-white px-4 py-2 rounded-xl text-xs font-bold shadow-sm shadow-indigo-100 ml-3">
                                Tiếp tục
                            </a>
                        </div>
                    `;
                    }).join('');

                    const html = renderSessions(limitedSessions);

                    // Update Mobile
                    if (containers.mobile.wrap && containers.mobile.list) {
                        containers.mobile.wrap.classList.remove('hidden');
                        containers.mobile.list.innerHTML = html;
                        if (containers.mobile.count) containers.mobile.count.textContent = `(${totalCount})`;
                    }

                    // Update Desktop
                    if (containers.desktop.wrap && containers.desktop.list) {
                        containers.desktop.wrap.classList.remove('hidden');
                        containers.desktop.list.innerHTML = html;
                        if (containers.desktop.count) containers.desktop.count.textContent = `(${totalCount})`;
                    }
                }
            } catch (e) {
                console.error('Failed to load active sessions', e);
            }
        }
    </script>

    {# --- Giao diện Desktop (Grid Complex) --- #}
    <div class="hidden lg:block">
        {% include _v ~ '/pages/dashboard/_desktop.html' %}
    </div>
</div>
{% endblock %}