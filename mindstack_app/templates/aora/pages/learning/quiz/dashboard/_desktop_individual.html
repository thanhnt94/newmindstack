{# =============================== #}
{% set _v = template_version %}
{# File: mindstack_app/modules/learning/quiz/individual/templates/quiz/individual/_dashboard_individual.html #}
{# Mục đích: Giao diện học Quiz cá nhân (Solo) - Responsive Mobile/Desktop (MATCHING FLASHCARD STRUCTURE) #}
{# =============================== #}

{% from _v ~ '/includes/search/_search_form.html' import render_search_form %}

<style>
    /* === Style CMS cho Individual === */
    .cm-section-card {
        background: white;
        border-radius: 0.75rem;
        /* Match Flashcard shadow-lg */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        border: none;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .tab-filter-button {
        flex-grow: 1;
        padding: 0.75rem;
        text-align: center;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
    }

    .tab-filter-button:hover {
        color: #374151;
    }

    .tab-filter-button.active {
        border-bottom-color: #3b82f6;
        color: #3b82f6;
    }

    /* Quiz Set Card - Premium App Style (like Vocabulary) */
    .quiz-set-card {
        background: white;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .quiz-set-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px rgba(59, 130, 246, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: rgba(59, 130, 246, 0.3);
    }

    .quiz-set-card:active {
        transform: translateY(-2px) scale(0.98);
    }

    .quiz-set-card.selected-item {
        border-color: #3b82f6 !important;
        background-color: #eff6ff !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .quiz-set-cover {
        height: 110px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #06b6d4 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        background-size: cover;
        background-position: center;
        position: relative;
        overflow: hidden;
    }

    .quiz-set-cover::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, transparent 50%, rgba(0, 0, 0, 0.1) 100%);
    }

    .quiz-set-cover i {
        font-size: 2.5rem;
        color: rgba(255, 255, 255, 0.85);
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        position: relative;
        z-index: 1;
    }

    .quiz-set-info {
        padding: 0.875rem;
    }

    .quiz-set-title {
        font-weight: 700;
        color: #1e293b;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.3;
    }

    .quiz-set-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #64748b;
    }

    .quiz-set-count {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        color: #3b82f6;
        background: #eff6ff;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
    }

    .quiz-set-count i {
        font-size: 0.65rem;
    }

    .quiz-set-author {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        color: #64748b;
        font-size: 0.7rem;
    }

    .quiz-set-avatar {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.55rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    /* Pagination Button */
    .pagination-btn {
        padding: 0.5rem 0.75rem;
        background: #f1f5f9;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination-btn:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    .quiz-mode-item {
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .quiz-mode-item:hover {
        border-color: #93c5fd;
        background: #f8fafc;
    }

    .quiz-mode-item.selected-mode {
        border-color: #3b82f6;
        background-color: #eff6ff;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }

    .selected-set-item {
        background-color: #dbeafe;
        color: #1e3a8a;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        margin: 0.25rem;
        display: inline-flex;
        align-items: center;
    }

    .selected-set-item i {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    /* === MOBILE STYLES (max-width: 1023px) === */
    @media (max-width: 1023px) {
        .desktop-only {
            display: none !important;
        }

        /* Force body background to white on mobile for this page */
        body {
            background-color: #f8fafc !important;
        }

        /* Step 0: Mode Selection */
        #quiz-mobile-mode-selection {
            position: relative;
            height: calc(100dvh - 160px);
            min-height: unset;
            overflow: hidden;
            z-index: 30;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 1.5rem;
            margin-top: 0 !important;
        }

        /* Full Screen Containers for Steps - EXACTLY LIKE FLASHCARD */
        #step-1-card,
        #step-2-card {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 999;
            background-color: #fff;
            flex-direction: column;
            height: 100dvh;
            border-radius: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            padding: 0 !important;
            /* Force remove desktop padding */
        }

        /* Visibility Logic */
        .mobile-mode-individual #step-1-card {
            display: flex;
        }

        .mobile-mode-individual.mobile-step-2-active #step-1-card {
            display: none;
        }

        .mobile-mode-individual.mobile-step-2-active #step-2-card {
            display: flex;
        }

        .mobile-mode-individual #quiz-mobile-mode-selection {
            display: none;
        }

        /* Content Areas - Scrollable */
        .mobile-scroll-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.75rem;
            padding-bottom: 1rem;
            background-color: #f8fafc;
        }

        /* Header Sections */
        .mobile-header-section {
            flex-shrink: 0;
            background: white;
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        /* Mobile Segmented Control Tabs */
        .mobile-header-section .flex.border-b {
            border: none !important;
            background-color: #f1f5f9;
            padding: 0.25rem;
            border-radius: 0.75rem;
            gap: 0.25rem;
            margin-bottom: 0.5rem !important;
        }

        .tab-filter-button {
            flex: 1;
            border: none !important;
            border-radius: 0.5rem;
            padding: 0.35rem 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: #64748b;
            background: transparent;
            transition: all 0.2s ease;
        }

        .tab-filter-button.active {
            background-color: white;
            color: #0f172a;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            font-weight: 700;
        }

        /* App-like List Items */
        .quiz-set-item {
            border: 1px solid #e2e8f0 !important;
            border-radius: 0.75rem !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
            margin-bottom: 0.5rem;
            padding: 0.75rem !important;
        }

        .quiz-set-item:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Footer - Flex Item, stays at bottom naturally in column layout */
        .mobile-footer-section {
            flex-shrink: 0;
            background: white;
            padding: 1rem 0.75rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            border-top: 1px solid #f1f5f9;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        /* Button overrides */
        #mobile-step-1-next,
        #mobile-step-2-start,
        #start-learning-btn,
        #bulk-unarchive-btn {
            width: 100%;
            margin: 0;
            border-radius: 1rem;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        #mobile-step-1-next:disabled {
            background-color: #e2e8f0;
            color: #94a3b8;
            box-shadow: none;
        }

        .mobile-control-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0;
            background: #fff;
        }

        .mobile-control-bar #quiz-pagination-slot {
            width: 100%;
            justify-content: center;
            display: flex;
        }
    }

    /* === DESKTOP STYLES (min-width: 1024px) === */
    @media (min-width: 1024px) {
        #quiz-mobile-mode-selection {
            display: none;
        }

        .mobile-only {
            display: none !important;
        }

        /* Restore desktop layout: flex containers within grid */
        #step-1-card,
        #step-2-card {
            display: flex !important;
            position: static !important;
            inset: auto !important;
            height: auto !important;
            background-color: white !important;
            z-index: auto !important;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }

        .mobile-header-section {
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        #quiz-control-bar {
            justify-content: space-between;
        }

        #quiz-pagination-slot {
            justify-content: center;
        }

        /* Hide duplicate pagination inside container - already moved to slot */
        #quiz-sets-container .pagination,
        #quiz-sets-container nav[aria-label="Page navigation"] {
            display: none !important;
        }

        .mobile-footer-section {
            display: none !important;
        }
    }

    /* Toggle Styles */
    .toggle-bg {
        transition: background-color 0.2s ease;
    }

    #limit-toggle:checked~.toggle-bg,
    #mobile-limit-toggle:checked~.toggle-bg {
        background-color: #3b82f6;
    }

    #limit-toggle:checked~.dot,
    #mobile-limit-toggle:checked~.dot {
        transform: translateX(100%);
    }

    .config-header {
        font-size: 0.95rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
</style>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-full">

    {# === MOBILE STEP 0: MODE SELECTION (APP STYLE) === #}
    <div id="quiz-mobile-mode-selection" class="lg:hidden space-y-8 w-full max-w-md mx-auto">
        <div class="text-center mb-4">
            <div
                class="w-24 h-24 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-200 transform -rotate-3">
                <i class="fas fa-question-circle text-white text-4xl drop-shadow-md"></i>
            </div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">Học Quiz</h1>
            <p class="text-slate-500 font-medium mt-2 text-base">Chọn chế độ ôn tập của bạn</p>
        </div>

        <div class="space-y-4 w-full">
            <!-- Individual Mode -->
            <button id="btn-mode-individual"
                class="w-full bg-white p-5 rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-100 flex items-center gap-5 active:scale-95 transition-transform group">
                <div
                    class="w-16 h-16 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl shadow-sm group-hover:bg-emerald-500 group-hover:text-white transition-colors">
                    <i class="fas fa-user"></i>
                </div>
                <div class="text-left flex-grow">
                    <h3 class="font-bold text-slate-800 text-lg mb-0.5">Cá nhân</h3>
                    <p class="text-xs text-slate-500 font-medium">Ôn tập theo tốc độ riêng</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </button>

            <!-- Group Mode -->
            <button id="btn-mode-group"
                class="w-full bg-white p-5 rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-100 flex items-center gap-5 active:scale-95 transition-transform group">
                <div
                    class="w-16 h-16 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-2xl shadow-sm group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                    <i class="fas fa-users"></i>
                </div>
                <div class="text-left flex-grow">
                    <h3 class="font-bold text-slate-800 text-lg mb-0.5">Học nhóm</h3>
                    <p class="text-xs text-slate-500 font-medium">Cùng bạn bè ôn tập</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </button>
        </div>
    </div>

    {# === STEP 1: SELECT SET === #}
    <div id="step-1-card" class="cm-section-card">

        {# Header Group #}
        <div class="mobile-header-section lg:p-0 lg:bg-transparent lg:border-none lg:shadow-none">

            {# Mobile: Back button + Breadcrumb/Title layout #}
            <div class="lg:hidden flex items-center justify-between gap-2 mb-3">
                <div class="flex items-center gap-2 min-w-0">
                    {# Back Button #}
                    <button id="mobile-step-1-back"
                        class="flex-shrink-0 bg-slate-100 text-gray-600 hover:bg-slate-200 rounded-xl w-9 h-9 flex items-center justify-center">
                        <i class="fas fa-arrow-left text-sm"></i>
                    </button>
                    {# Breadcrumb + Title Stack #}
                    <div class="min-w-0">
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">QUIZ <span
                                class="text-slate-300 mx-0.5">›</span> INDIVIDUAL <span
                                class="text-slate-300 mx-0.5">›</span> STEP 1</p>
                        <h2 class="text-base font-bold text-gray-800 leading-tight truncate">Chọn bộ câu hỏi</h2>
                    </div>
                </div>

                <div class="flex items-center gap-2 flex-shrink-0">
                    {# Search Toggle Button #}
                    <button type="button" id="quiz-search-toggle-btn"
                        class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 active:scale-95 transition-all"
                        title="Tìm kiếm">
                        <i class="fa-solid fa-magnifying-glass text-sm"></i>
                    </button>

                    {# Multi-select Toggle Button (Icon style) #}
                    <button type="button" id="multi-select-toggle-btn"
                        class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 active:scale-95 transition-all"
                        title="Chọn nhiều">
                        <i id="multi-select-icon" class="fa-solid fa-hand-pointer text-sm"></i>
                    </button>
                    {# Hidden checkbox to maintain state for JS #}
                    <input type="checkbox" id="multi-select-toggle" class="hidden">
                </div>
            </div>

            {# Desktop Title #}
            <h2 class="hidden lg:flex text-xl sm:text-2xl font-bold text-gray-800 mb-4 items-center justify-between">
                <span class="h2-title-wrapper">
                    <i class="fas fa-list-alt mr-3 text-blue-500"></i>
                    <span>Bước 1: Chọn bộ câu hỏi</span>
                </span>
                {# Selection Mode Toggle #}
                <div class="flex items-center flex-shrink-0 ml-auto">
                    <span class="text-xs font-semibold text-slate-600 mr-2 whitespace-nowrap">Chọn nhiều:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="multi-select-toggle" class="sr-only peer">
                        <div
                            class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                        </div>
                    </label>
                </div>
            </h2>

            <div class="flex border-b border-gray-200 mb-2 lg:mb-4">
                <button id="filter-my" class="tab-filter-button flex items-center justify-center active"
                    data-category="my"><i class="fas fa-user mr-2"></i><span>Của tôi</span></button>
                <button id="filter-learning" class="tab-filter-button flex items-center justify-center"
                    data-category="learning"><i class="fas fa-play-circle mr-2"></i><span>Đang học</span></button>
                <button id="filter-explore" class="tab-filter-button flex items-center justify-center"
                    data-category="explore"><i class="fas fa-globe mr-2"></i><span>Khám phá</span></button>
            </div>

            {# Mobile Collapsible Search Bar #}
            <div id="quiz-search-bar" class="hidden mb-3 lg:hidden">
                <div id="quiz-search-form-container-mobile">
                    {% set display_search_options = {'title':'Tiêu đề','description':'Mô tả','tags':'Thẻ'} %}
                    {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm...",
                    search_field=search_field, search_options=display_search_options) }}
                </div>
            </div>

            {# Desktop Search Form (always visible) #}
            <div class="mb-1 hidden lg:block" id="quiz-search-form-container">
                {% set display_search_options = {'title':'Tiêu đề','description':'Mô tả','tags':'Thẻ'} %}
                {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm...",
                search_field=search_field, search_options=display_search_options) }}
            </div>

            {# Selected Sets Display (Restored) #}
            <div id="selected-sets-display"
                class="flex flex-wrap items-center gap-2 text-xs hidden bg-blue-50 p-2 rounded-lg mb-2 max-h-24 overflow-y-auto">
            </div>
        </div>

        {# Search Result Banner #}
        {% if search_query %}
        <div class="px-4 lg:px-0 mt-2 mb-3">
            <div class="py-2 px-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                <div class="flex items-center gap-2 text-xs text-blue-700">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span>Kết quả cho: <strong>"{{ search_query }}"</strong></span>
                </div>
                <a href="{{ url_for(request.endpoint, view='setup') }}"
                    class="text-blue-500 hover:text-blue-700 text-xs font-medium flex items-center gap-1">
                    <i class="fa-solid fa-xmark"></i> Xóa
                </a>
            </div>
        </div>
        {% endif %}

        {# Scrollable List Content #}
        <div id="quiz-sets-container" class="mobile-scroll-content flex-grow lg:p-0 space-y-3">
            <div class="flex flex-col items-center justify-center h-48 text-blue-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Đang tải danh sách...</p>
            </div>
        </div>

        {# Fixed Control Bar (Toggle + Pagination) - Moved to bottom #}
        <div id="quiz-control-bar"
            class="flex items-center justify-between py-1 px-1 bg-white border-t border-slate-200 lg:border-t lg:border-slate-100 lg:bg-transparent flex-shrink-0 mobile-control-bar">
            <div id="quiz-pagination-slot"
                class="flex justify-end flex-grow items-center empty:hidden [&_.pagination]:m-0 [&_nav]:m-0 [&_.page-item]:m-0 [&_.page-link]:py-1 [&_.page-link]:px-2 [&_.page-link]:text-xs">
            </div>
        </div>

        {# Mobile Step 1 Navigation Bar (Footer) #}
        <div class="mobile-footer-section lg:hidden">
            <button id="mobile-step-1-next"
                class="w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow-sm flex items-center justify-center transition-colors duration-200"
                disabled>
                Tiếp tục <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    {# === STEP 2 === #}
    <div id="step-2-card" class="cm-section-card">
        {# Header #}
        <div class="mobile-header-section lg:p-0 lg:bg-transparent lg:border-none lg:shadow-none">

            {# Mobile: Back button + Breadcrumb/Title layout #}
            <div class="lg:hidden flex items-start mb-1">
                {# Back Button #}
                <button id="mobile-step-2-back"
                    class="mr-3 bg-slate-100 text-gray-600 hover:bg-slate-200 rounded-full w-9 h-9 flex items-center justify-center flex-shrink-0 mt-1">
                    <i class="fas fa-arrow-left"></i>
                </button>
                {# Breadcrumb + Title Stack #}
                <div class="flex flex-col">
                    <div class="flex items-center text-xs text-slate-400 font-medium">
                        <span class="text-blue-500">QUIZ</span>
                        <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
                        <span class="text-blue-500">INDIVIDUAL</span>
                        <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
                        <span class="text-slate-600 font-semibold">STEP 2</span>
                    </div>
                    <h2 id="step-2-title" class="text-xl font-bold text-gray-800">Tùy chỉnh phiên học</h2>
                </div>
            </div>

            {# Desktop Title #}
            <h2 class="hidden lg:flex text-xl sm:text-2xl font-bold text-gray-800 mb-4 items-center truncate">
                <i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Tùy chỉnh phiên học
            </h2>

            {# Mobile: Selected Sets Display - positioned after header #}
            <div id="mobile-selected-sets-header" class="lg:hidden w-full mb-2 hidden">
                <div class="text-xs text-slate-500 mb-1 font-medium">Bộ đã chọn:</div>
                <div id="mobile-selected-sets-chips-header" class="flex flex-wrap gap-1 max-h-12 overflow-y-auto">
                </div>
            </div>
        </div>

        {# List Content #}
        <div id="quiz-modes-container" class="mobile-scroll-content flex-grow lg:p-0">
            <div class="flex flex-col items-center justify-center h-48 text-gray-400">
                <i class="fas fa-info-circle text-4xl mb-3 opacity-50"></i>
                <p>Vui lòng chọn bộ câu hỏi ở bước 1.</p>
            </div>
        </div>

        {# Mobile Footer Step 2 (INSIDE Step 2 Card) #}
        <div class="mobile-footer-section lg:hidden flex-col gap-2">
            {# Mobile: Session Size Selector (New Toggle Style) #}
            <div id="mobile-session-size-row" class="w-full mb-2 hidden">
                <div class="bg-slate-50 rounded-xl border border-slate-200 p-3">
                    <div class="flex justify-between items-center mb-0">
                        <div class="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <i class="fas fa-sort-numeric-up text-blue-500"></i> Số lượng: <span
                                id="mobile-limit-status-text" class="text-blue-500">Tất cả</span>
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <span class="mr-2 text-xs font-medium text-slate-500">Tùy chỉnh</span>
                            <div class="relative">
                                <input type="checkbox" id="mobile-limit-toggle" class="sr-only">
                                <div class="block bg-gray-200 w-8 h-5 rounded-full transition-colors toggle-bg"></div>
                                <div
                                    class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition-transform transform">
                                </div>
                            </div>
                        </label>
                    </div>
                    <div id="mobile-limit-options" class="hidden mt-3">
                        <select id="mobile-session-size-select"
                            class="bg-white border border-slate-200 rounded-lg px-3 py-2 w-full text-sm font-bold text-slate-800 focus:ring-2 focus:ring-blue-300">
                            <option value="5">5 câu</option>
                            <option value="10" selected>10 câu</option>
                            <option value="20">20 câu</option>
                            <option value="30">30 câu</option>
                            <option value="50">50 câu</option>
                            <option value="100">100 câu</option>
                        </select>
                    </div>
                </div>
            </div>

            {# Mobile: Turn Size Selector (Batch Mode) #}
            <div id="mobile-turn-size-row" class="w-full mb-3 hidden">
                <div class="bg-slate-50 rounded-xl border border-slate-200 p-3">
                    <div class="flex justify-between items-center mb-0">
                        <div class="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <i class="fas fa-layer-group text-blue-500"></i> Lượt: <span id="mobile-turn-status-text"
                                class="text-blue-500">1 câu</span>
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <span class="mr-2 text-xs font-medium text-slate-500">Tùy chỉnh</span>
                            <div class="relative">
                                <input type="checkbox" id="mobile-turn-toggle" class="sr-only">
                                <div class="block bg-gray-200 w-8 h-5 rounded-full transition-colors toggle-bg"></div>
                                <div
                                    class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition-transform transform">
                                </div>
                            </div>
                        </label>
                    </div>
                    <div id="mobile-turn-options" class="hidden mt-3">
                        <select id="mobile-turn-size-select"
                            class="bg-white border border-slate-200 rounded-lg px-3 py-2 w-full text-sm font-bold text-slate-800 focus:ring-2 focus:ring-blue-300">
                            <option value="1" selected>1 câu mỗi lượt</option>
                            <option value="2">2 câu mỗi lượt</option>
                            <option value="3">3 câu mỗi lượt</option>
                            <option value="5">5 câu mỗi lượt</option>
                            <option value="10">10 câu mỗi lượt</option>
                        </select>
                    </div>
                </div>
            </div>

            <button id="mobile-step-2-start"
                class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-sm flex items-center justify-center">
                Bắt đầu học <i class="fas fa-play-circle ml-2"></i>
            </button>
        </div>
    </div>
</div>

{# Desktop Footer Actions (Hidden on Mobile) #}
<div class="mt-4 text-center hidden lg:block">
    <button id="start-learning-btn"
        class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto"
        style="display: none;">
        <i class="fas fa-play-circle mr-3"></i> Bắt đầu học
    </button>
    <button id="bulk-unarchive-btn"
        class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto"
        style="display: none;">
        <i class="fas fa-box-open mr-3"></i> Bỏ lưu trữ
    </button>
</div>

<script>
    console.log('>>> _dashboard_individual.js: init');

    // ==== Biến trạng thái ====
    let selectedQuizSetIds = [];
    let selectedQuizMode = null;
    let selectedSessionSize = parseInt("{{ user_default_batch_size | default(10) }}");
    let selectedTurnSize = 1;
    let currentCategory = 'my';  // my, learning, explore
    let currentPage = 1;
    let currentSearchQuery = "{{ search_query | default('') }}";
    let currentSearchField = "{{ search_field | default('all') }}";
    let isMultiSelectMode = false; // Initialized by toggle state

    const quizSetsContainer = document.getElementById('quiz-sets-container');
    const quizModesContainer = document.getElementById('quiz-modes-container');
    const selectedSetsDisplay = document.getElementById('selected-sets-display');
    const step2Title = document.getElementById('step-2-title');
    const quizSearchForm = document.querySelector('#quiz-search-form-container form');
    const mobileNextBtn = document.getElementById('mobile-step-1-next');
    const mobileBackBtn = document.getElementById('mobile-step-2-back');
    const mobileStartBtn = document.getElementById('mobile-step-2-start');

    // === Mobile Search Toggle ===
    const quizSearchToggleBtn = document.getElementById('quiz-search-toggle-btn');
    const quizSearchBar = document.getElementById('quiz-search-bar');

    if (quizSearchToggleBtn && quizSearchBar) {
        quizSearchToggleBtn.addEventListener('click', function () {
            const isOpen = !quizSearchBar.classList.contains('hidden');
            if (isOpen) {
                quizSearchBar.classList.add('hidden');
                this.classList.remove('bg-blue-500', 'text-white');
                this.classList.add('bg-slate-100', 'text-slate-600');
            } else {
                quizSearchBar.classList.remove('hidden');
                this.classList.remove('bg-slate-100', 'text-slate-600');
                this.classList.add('bg-blue-500', 'text-white');
                // Focus input
                const input = quizSearchBar.querySelector('input[name="q"]');
                if (input) input.focus();
            }
        });

        // Inject hidden field to preserve mobile state when searching
        const searchForms = quizSearchBar.querySelectorAll('form');
        searchForms.forEach(form => {
            const hiddenViewInput = document.createElement('input');
            hiddenViewInput.type = 'hidden';
            hiddenViewInput.name = 'view';
            hiddenViewInput.value = 'setup';
            form.appendChild(hiddenViewInput);
        });
    }
    const btnModeIndividual = document.getElementById('btn-mode-individual');
    const btnModeGroup = document.getElementById('btn-mode-group');
    const mobileStep1BackBtn = document.getElementById('mobile-step-1-back');
    const quizSection = document.getElementById('quiz-solo-section');

    // --- START: Mobile Mode Selection Logic ---
    if (btnModeIndividual) {
        btnModeIndividual.addEventListener('click', () => {
            quizSection.classList.add('mobile-mode-individual');
            // Fix: Update URL
            const url = new URL(window.location);
            url.searchParams.set('view', 'setup');
            history.pushState({}, '', url);
        });
    }

    if (btnModeGroup) {
        btnModeGroup.addEventListener('click', () => {
            // Switch to Battle Mode by clicking the tab
            const battleTab = document.querySelector('[data-study-tab="battle"]');
            if (battleTab) battleTab.click();
        });
    }

    if (mobileStep1BackBtn) {
        mobileStep1BackBtn.addEventListener('click', () => {
            quizSection.classList.remove('mobile-mode-individual');
            // Fix: Remove param
            const url = new URL(window.location);
            url.searchParams.delete('view');
            history.pushState({}, '', url);
        });
    }

    // Fix: Restore state on load
    if (new URLSearchParams(window.location.search).get('view') === 'setup') {
        quizSection.classList.add('mobile-mode-individual');
    }

    if (mobileStartBtn) {
        mobileStartBtn.addEventListener('click', () => {
            const startBtn = document.getElementById('start-learning-btn');
            if (startBtn) startBtn.click();
        });
    }

    const preSelectId = new URLSearchParams(window.location.search).get('preSelect');
    if (preSelectId) {
        selectedQuizSetIds = [preSelectId];
        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));

        // Use timeout to allow initial render/state settle
        setTimeout(() => {
            loadQuizModes(selectedQuizSetIds);
            const section = document.getElementById('quiz-solo-section');
            if (section) {
                section.classList.add('mobile-step-2-active');
                updateMobileStep2Display();
            }
        }, 150);
    }
    // --- END: Mobile Mode Selection Logic ---

    // --- START: Toggle References and Syncing ---
    const multiSelectToggle = document.getElementById('multi-select-toggle'); // Hidden checkbox
    const multiSelectBtn = document.getElementById('multi-select-toggle-btn'); // Icon button
    const multiSelectIcon = document.getElementById('multi-select-icon'); // Icon element

    // Function to update button visual state
    function updateMultiSelectButtonUI() {
        if (!multiSelectBtn || !multiSelectIcon) return;

        if (isMultiSelectMode) {
            // Active state - blue background, check-double icon
            multiSelectBtn.classList.remove('bg-slate-100', 'text-slate-600');
            multiSelectBtn.classList.add('bg-blue-500', 'text-white');
            multiSelectIcon.classList.remove('fa-hand-pointer');
            multiSelectIcon.classList.add('fa-check-double');
            multiSelectBtn.title = 'Chế độ chọn nhiều (BẬT)';
        } else {
            // Inactive state - gray background, hand-pointer icon
            multiSelectBtn.classList.remove('bg-blue-500', 'text-white');
            multiSelectBtn.classList.add('bg-slate-100', 'text-slate-600');
            multiSelectIcon.classList.remove('fa-check-double');
            multiSelectIcon.classList.add('fa-hand-pointer');
            multiSelectBtn.title = 'Chọn nhiều';
        }
    }

    // Button click handler
    if (multiSelectBtn && multiSelectToggle) {
        multiSelectBtn.addEventListener('click', () => {
            multiSelectToggle.checked = !multiSelectToggle.checked;
            isMultiSelectMode = multiSelectToggle.checked;
            updateMultiSelectButtonUI();
            handleMultiSelectChange();
        });
    }

    // Determine initial state based on toggle state
    if (multiSelectToggle) {
        isMultiSelectMode = multiSelectToggle.checked;
        updateMultiSelectButtonUI();
        multiSelectToggle.addEventListener('change', (e) => {
            isMultiSelectMode = e.target.checked;
            updateMultiSelectButtonUI();
            handleMultiSelectChange();
        });
    }

    function handleMultiSelectChange() {
        selectedQuizSetIds = []; // Clear selection on mode switch
        localStorage.removeItem('selectedQuizSetIds');
        syncMultiSelectionUI();
        loadQuizSets(currentPage, currentSearchQuery, currentCategory); // Reload to update UI
        updateActionButtons();
    }
    // --- END: Toggle References and Syncing ---


    // URL Configs (Fix paths)
    const quizApiSetsUrl = "{{ url_for('learning.quiz_learning.api_get_quiz_sets') }}";
    const quizModesPartialBaseUrlById = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_by_id', set_id=0) or '#' }}";
    const quizModesPartialBaseUrlAll = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_all') or '#' }}";
    const quizModesPartialBaseUrlMulti = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_multi', set_ids_str='0') or '#' }}";
    const startQuizSessionBaseUrlAllTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_all', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlMultiTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_multi', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlByIdTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_by_id', set_id=0, mode='MODE_PLACEHOLDER') }}";
    const saveQuizSettingsUrl = "{{ url_for('learning.quiz_learning.save_quiz_settings') }}";

    // === Mobile Navigation ===
    function updateMobileNextButton() {
        if (!mobileNextBtn) return;
        const count = selectedQuizSetIds.length;
        mobileNextBtn.innerHTML = `Tiếp tục <i class="fas fa-arrow-right ml-2"></i>`;
        mobileNextBtn.disabled = count === 0;
        if (count > 0) {
            mobileNextBtn.classList.remove('bg-gray-400');
            mobileNextBtn.classList.add('bg-blue-600');
        } else {
            mobileNextBtn.classList.add('bg-gray-400');
            mobileNextBtn.classList.remove('bg-blue-600');
        }
    }

    mobileNextBtn?.addEventListener('click', () => {
        document.getElementById('quiz-solo-section').classList.add('mobile-step-2-active');
        updateMobileStep2Display();
        // Save step to URL
        const url = new URL(window.location);
        url.searchParams.set('mobile_step', '2');
        window.history.replaceState({}, '', url);
    });

    mobileBackBtn?.addEventListener('click', () => {
        document.getElementById('quiz-solo-section').classList.remove('mobile-step-2-active');
        // Remove step from URL
        const url = new URL(window.location);
        url.searchParams.delete('mobile_step');
        window.history.replaceState({}, '', url);
    });

    // Restore mobile step on page load
    function restoreMobileStep() {
        // Use setTimeout to ensure DOM is ready
        setTimeout(() => {
            const urlParams = new URLSearchParams(window.location.search);
            const mobileStep = urlParams.get('mobile_step');
            console.log('restoreMobileStep called:', mobileStep, 'IDs:', selectedQuizSetIds);

            if (mobileStep === '2' && selectedQuizSetIds.length > 0) {
                const soloSection = document.getElementById('quiz-solo-section');
                console.log('Found soloSection:', soloSection);
                if (soloSection) {
                    // Need BOTH classes for step 2 to display on mobile
                    soloSection.classList.add('mobile-step-2-active');
                    console.log('Classes added:', soloSection.className);
                    updateMobileStep2Display();
                    // Also load quiz modes for step 2
                    if (selectedQuizSetIds.length === 1) {
                        loadQuizModes(selectedQuizSetIds[0]);
                    } else {
                        loadQuizModes('multi');
                    }
                }
            }
        }, 100);
    }

    // Update Step 2 mobile selected sets display
    function updateMobileStep2Display() {
        // Selected sets in header
        const headerDisplayEl = document.getElementById('mobile-selected-sets-header');
        const headerChipsEl = document.getElementById('mobile-selected-sets-chips-header');

        // Session size in footer
        const sessionSizeRow = document.getElementById('mobile-session-size-row');
        const turnSizeRow = document.getElementById('mobile-turn-size-row');

        // Show selected sets in header
        if (headerDisplayEl && headerChipsEl) {
            if (selectedQuizSetIds.length > 0) {
                const chipsHtml = selectedQuizSetIds.map(id => {
                    const title = selectedQuizSetTitles[id] || `Bộ #${id}`;
                    return `<span class="inline-flex items-center bg-blue-100 text-blue-700 text-xs font-medium px-2 py-0.5 rounded-full">${title}</span>`;
                }).join('');
                headerChipsEl.innerHTML = chipsHtml;
                headerDisplayEl.classList.remove('hidden');
                if (sessionSizeRow) sessionSizeRow.classList.remove('hidden');
                if (turnSizeRow) turnSizeRow.classList.remove('hidden');
            } else {
                headerDisplayEl.classList.add('hidden');
                if (sessionSizeRow) sessionSizeRow.classList.add('hidden');
                if (turnSizeRow) turnSizeRow.classList.add('hidden');
            }
        }

        // Handle Mobile Limit Toggle Logic
        const mobileLimitToggle = document.getElementById('mobile-limit-toggle');
        const mobileLimitOptions = document.getElementById('mobile-limit-options');
        const mobileLimitStatusText = document.getElementById('mobile-limit-status-text');
        const mobileSessionSelect = document.getElementById('mobile-session-size-select');

        if (mobileLimitToggle && !mobileLimitToggle.dataset.bound) {
            // Initialize mobile toggle state
            if (selectedSessionSize < 999999) {
                mobileLimitToggle.checked = true;
                mobileLimitOptions?.classList.remove('hidden');
                mobileLimitStatusText?.classList.add('hidden');
                if (mobileSessionSelect) mobileSessionSelect.value = selectedSessionSize;
            } else {
                mobileLimitToggle.checked = false;
                mobileLimitOptions?.classList.add('hidden');
                mobileLimitStatusText?.classList.remove('hidden');
            }

            mobileLimitToggle.addEventListener('change', function () {
                if (this.checked) {
                    mobileLimitOptions?.classList.remove('hidden');
                    mobileLimitStatusText?.classList.add('hidden');
                    selectedSessionSize = parseInt(mobileSessionSelect?.value || 10);
                } else {
                    mobileLimitOptions?.classList.add('hidden');
                    mobileLimitStatusText?.classList.remove('hidden');
                    selectedSessionSize = 999999;
                }
                // Sync with desktop selector if exists
                const desktopLimitToggle = document.getElementById('limit-toggle');
                if (desktopLimitToggle) {
                    desktopLimitToggle.checked = this.checked;
                    desktopLimitToggle.dispatchEvent(new Event('change'));
                }
            });

            if (mobileSessionSelect) {
                mobileSessionSelect.addEventListener('change', function () {
                    if (mobileLimitToggle.checked) {
                        selectedSessionSize = parseInt(this.value);
                        // Sync with desktop select if exists
                        const desktopSelect = document.getElementById('session-size-select');
                        if (desktopSelect) desktopSelect.value = this.value;
                    }
                });
            }
            mobileLimitToggle.dataset.bound = "true";
        }

        // Handle Mobile Turn Toggle Logic (Batch Mode)
        const mobileTurnToggle = document.getElementById('mobile-turn-toggle');
        const mobileTurnOptions = document.getElementById('mobile-turn-options');
        const mobileTurnStatusText = document.getElementById('mobile-turn-status-text');
        const mobileTurnSelect = document.getElementById('mobile-turn-size-select');

        if (mobileTurnToggle && !mobileTurnToggle.dataset.bound) {
            // Initialize turn toggle state
            if (selectedTurnSize > 1) {
                mobileTurnToggle.checked = true;
                mobileTurnOptions?.classList.remove('hidden');
                mobileTurnStatusText?.classList.add('hidden');
                if (mobileTurnSelect) mobileTurnSelect.value = selectedTurnSize;
            } else {
                mobileTurnToggle.checked = false;
                mobileTurnOptions?.classList.add('hidden');
                mobileTurnStatusText?.classList.remove('hidden');
            }

            mobileTurnToggle.addEventListener('change', function () {
                if (this.checked) {
                    mobileTurnOptions?.classList.remove('hidden');
                    mobileTurnStatusText?.classList.add('hidden');
                    selectedTurnSize = parseInt(mobileTurnSelect?.value || 1);
                } else {
                    mobileTurnOptions?.classList.add('hidden');
                    mobileTurnStatusText?.classList.remove('hidden');
                    selectedTurnSize = 1;
                }
                // Sync with desktop selector if exists
                const desktopTurnToggle = document.getElementById('turn-toggle');
                if (desktopTurnToggle) {
                    desktopTurnToggle.checked = this.checked;
                    desktopTurnToggle.dispatchEvent(new Event('change'));
                }
            });

            if (mobileTurnSelect) {
                mobileTurnSelect.addEventListener('change', function () {
                    if (mobileTurnToggle.checked) {
                        selectedTurnSize = parseInt(this.value);
                        // Sync with desktop select if exists
                        const desktopSelect = document.getElementById('turn-size-select');
                        if (desktopSelect) desktopSelect.value = this.value;
                    }
                });
            }
            mobileTurnToggle.dataset.bound = "true";
        }
    }

    async function loadQuizSets(page, searchQuery, category) {
        if (!quizSetsContainer) return;
        quizSetsContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-32 text-blue-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Đang tải...</p></div>';

        if (localStorage.getItem('selectedQuizSetIds')) selectedQuizSetIds = JSON.parse(localStorage.getItem('selectedQuizSetIds'));
        else selectedQuizSetIds = [];

        // Fix: Initialize Title Map
        if (localStorage.getItem('selectedQuizSetTitles')) selectedQuizSetTitles = JSON.parse(localStorage.getItem('selectedQuizSetTitles'));
        else selectedQuizSetTitles = {};

        updateSelectedSetsDisplay();
        updateActionButtons();
        updateMobileNextButton(); // Init Mobile Button

        try {
            // Use new JSON API endpoint (like Vocabulary)
            const url = new URL(quizApiSetsUrl, window.location.origin);
            url.searchParams.append('page', page || 1);
            url.searchParams.append('category', category || 'my');
            if (searchQuery) url.searchParams.append('q', searchQuery);

            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error('Failed to fetch');

            const data = await response.json();

            if (data.success && data.sets.length > 0) {
                renderQuizSets(data.sets);
            } else {
                quizSetsContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-48 text-gray-400 col-span-full"><i class="fas fa-folder-open text-4xl mb-3 opacity-50"></i><p>Không có bộ quiz nào</p></div>';
            }

            // Handle pagination
            const paginationSlot = document.getElementById('quiz-pagination-slot');
            if (paginationSlot) {
                if (data.has_next || data.has_prev) {
                    paginationSlot.innerHTML = renderPagination(data.page, data.has_prev, data.has_next);
                    paginationSlot.classList.remove('hidden');
                    addPaginationListeners();
                } else {
                    paginationSlot.innerHTML = '';
                    paginationSlot.classList.add('hidden');
                }
            }

            addQuizSetClickListeners();
            syncMultiSelectionUI();
            restoreMobileStep(); // Restore step 2 if reload

        } catch (e) {
            console.error('loadQuizSets error:', e);
            quizSetsContainer.innerHTML = '<p class="text-center text-rose-500 p-4">Lỗi tải dữ liệu.</p>';
        }
    }

    // Render quiz sets as cards (like Vocabulary)
    function renderQuizSets(sets) {
        let html = '<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-2 xl:grid-cols-3 gap-3 p-1">';

        sets.forEach(s => {
            const coverStyle = s.cover_image ? `background-image: url(/static/${s.cover_image})` : '';
            const authorInitial = (s.creator_name || 'U').charAt(0).toUpperCase();
            const authorName = s.creator_name || 'Unknown';
            const isSelected = selectedQuizSetIds.includes(String(s.id));

            html += `
            <div class="quiz-set-card ${isSelected ? 'selected-item' : ''}" data-set-id="${s.id}" data-set-title="${s.title}">
                <div class="quiz-set-cover" style="${coverStyle}">
                    ${!s.cover_image ? '<i class="fas fa-question-circle"></i>' : ''}
                </div>
                <div class="quiz-set-info">
                    <div class="quiz-set-title">${s.title}</div>
                    <div class="quiz-set-meta">
                        <div class="quiz-set-author">
                            <span class="quiz-set-avatar">${authorInitial}</span>
                            <span>${authorName}</span>
                        </div>
                        <div class="quiz-set-count"><i class="fas fa-list-check"></i>${s.question_count}</div>
                    </div>
                </div>
            </div>`;
        });

        html += '</div>';
        quizSetsContainer.innerHTML = html;
    }

    // Simple pagination renderer
    function renderPagination(currentPage, hasPrev, hasNext) {
        let html = '<div class="flex items-center gap-2">';
        if (hasPrev) {
            html += `<button class="pagination-btn" data-page="${currentPage - 1}"><i class="fas fa-chevron-left"></i></button>`;
        }
        html += `<span class="text-sm text-slate-600">Trang ${currentPage}</span>`;
        if (hasNext) {
            html += `<button class="pagination-btn" data-page="${currentPage + 1}"><i class="fas fa-chevron-right"></i></button>`;
        }
        html += '</div>';
        return html;
    }

    async function loadQuizModes(setId) {
        if (currentFilter === 'archive') return;
        if (!quizModesContainer) return;

        // Reset selected mode when reloading modes to ensure fresh selection
        selectedQuizMode = null;
        updateActionButtons();

        quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-32 text-blue-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Đang tải chế độ...</p></div>';

        try {
            let url;
            if (Array.isArray(setId)) {
                if (setId.length === 0) {
                    quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-48 text-gray-400"><i class="fas fa-info-circle text-4xl mb-3 opacity-50"></i><p>Vui lòng chọn bộ câu hỏi.</p></div>';
                    return;
                }
                if (setId.length === 1 && setId[0] === 'all') url = quizModesPartialBaseUrlAll;
                else url = quizModesPartialBaseUrlMulti.replace('/0', '/' + setId.join(','));
            } else if (setId === 'all') {
                url = quizModesPartialBaseUrlAll;
            } else {
                url = quizModesPartialBaseUrlById.replace('/0', '/' + setId);
            }

            const fullUrl = new URL(url, window.location.origin);
            // Remove passing selected_mode since we reset it
            // if (selectedQuizMode) fullUrl.searchParams.append('selected_mode', selectedQuizMode);
            fullUrl.searchParams.append('user_default_batch_size', selectedSessionSize);

            const response = await fetch(fullUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error();

            quizModesContainer.innerHTML = await response.text();

            // Xử lý Toggle & Dropdown số câu (Desktop)
            const limitToggle = document.getElementById('limit-toggle');
            const limitOptions = document.getElementById('limit-options');
            const limitStatusText = document.getElementById('limit-status-text');
            const sizeSelect = document.getElementById('session-size-select');

            const turnToggle = document.getElementById('turn-toggle');
            const turnOptions = document.getElementById('turn-options');
            const turnStatusText = document.getElementById('turn-status-text');
            const turnSelect = document.getElementById('turn-size-select');

            if (limitToggle) {
                // Initialize
                if (selectedSessionSize < 999999) {
                    limitToggle.checked = true;
                    limitOptions?.classList.remove('hidden');
                    limitStatusText?.classList.add('hidden');
                    if (sizeSelect) sizeSelect.value = selectedSessionSize;
                } else {
                    limitToggle.checked = false;
                    limitOptions?.classList.add('hidden');
                    limitStatusText?.classList.remove('hidden');
                }

                limitToggle.addEventListener('change', function () {
                    if (this.checked) {
                        limitOptions?.classList.remove('hidden');
                        limitStatusText?.classList.add('hidden');
                        selectedSessionSize = parseInt(sizeSelect?.value || 10);
                    } else {
                        limitOptions?.classList.add('hidden');
                        limitStatusText?.classList.remove('hidden');
                        selectedSessionSize = 999999;
                    }
                    // Sync with mobile
                    const mobileLimitToggle = document.getElementById('mobile-limit-toggle');
                    if (mobileLimitToggle && mobileLimitToggle.checked !== this.checked) {
                        mobileLimitToggle.checked = this.checked;
                        mobileLimitToggle.dispatchEvent(new Event('change'));
                    }
                });
            }

            if (sizeSelect) {
                sizeSelect.addEventListener('change', function () {
                    if (limitToggle && limitToggle.checked) {
                        selectedSessionSize = parseInt(this.value);
                        // Sync with mobile
                        const mobileSelect = document.getElementById('mobile-session-size-select');
                        if (mobileSelect) mobileSelect.value = this.value;
                    }
                });
            }

            if (turnToggle) {
                // Initialize Turn Toggle
                if (selectedTurnSize > 1) {
                    turnToggle.checked = true;
                    turnOptions?.classList.remove('hidden');
                    turnStatusText?.classList.add('hidden');
                    if (turnSelect) turnSelect.value = selectedTurnSize;
                } else {
                    turnToggle.checked = false;
                    turnOptions?.classList.add('hidden');
                    turnStatusText?.classList.remove('hidden');
                }

                turnToggle.addEventListener('change', function () {
                    if (this.checked) {
                        turnOptions?.classList.remove('hidden');
                        turnStatusText?.classList.add('hidden');
                        selectedTurnSize = parseInt(turnSelect?.value || 1);
                    } else {
                        turnOptions?.classList.add('hidden');
                        turnStatusText?.classList.remove('hidden');
                        selectedTurnSize = 1;
                    }
                    // Sync with mobile
                    const mobileTurnToggle = document.getElementById('mobile-turn-toggle');
                    if (mobileTurnToggle && mobileTurnToggle.checked !== this.checked) {
                        mobileTurnToggle.checked = this.checked;
                        mobileTurnToggle.dispatchEvent(new Event('change'));
                    }
                });
            }

            if (turnSelect) {
                turnSelect.addEventListener('change', function () {
                    if (turnToggle && turnToggle.checked) {
                        selectedTurnSize = parseInt(this.value);
                        // Sync with mobile
                        const mobileSelect = document.getElementById('mobile-turn-size-select');
                        if (mobileSelect) mobileSelect.value = this.value;
                    }
                });
            }

            // Xử lý Click Mode
            const modes = quizModesContainer.querySelectorAll('.quiz-mode-item');
            modes.forEach(mode => {
                mode.addEventListener('click', function () {
                    if (parseInt(this.dataset.count) === 0) return;
                    modes.forEach(m => m.classList.remove('selected-mode'));
                    this.classList.add('selected-mode');
                    selectedQuizMode = this.dataset.modeId;
                    updateActionButtons();
                });
            });

            // Auto select REMOVED to force user selection
            // updateActionButtons is already called via reset at top, but calling again is fine or just leave it.

        } catch (e) {
            quizModesContainer.innerHTML = '<p class="text-center text-rose-500">Lỗi tải chế độ học.</p>';
        }
    }

    function syncMultiSelectionUI() {
        document.querySelectorAll('.quiz-set-item').forEach(item => {
            const id = item.dataset.setId;
            if (selectedQuizSetIds.includes(id)) item.classList.add('selected-item');
            else item.classList.remove('selected-item');
        });
        updateSelectedSetsDisplay();
        updateMobileNextButton(); // Sync button
    }

    function updateSelectedSetsDisplay() {
        if (!selectedSetsDisplay) return;

        selectedSetsDisplay.innerHTML = ''; // Clear previous content

        if (selectedQuizSetIds.length > 0) {
            selectedSetsDisplay.classList.remove('hidden');

            const selectedTitlesHtml = selectedQuizSetIds.map(setId => {
                // Fix: Try getting title from map first, then DOM, then fallback
                let title = selectedQuizSetTitles[setId];
                if (!title) {
                    const setItem = document.querySelector(`.quiz-set-item[data-set-id="${setId}"]`);
                    title = setItem ? setItem.dataset.title : `Bộ #${setId}`;
                }
                return `
                <span class="selected-set-item">
                    ${title}
                    <i class="fas fa-times ml-1 cursor-pointer" onclick="removeSelectedQuizSet('${setId}')"></i>
                </span>
            `;
            }).join('');

            selectedSetsDisplay.innerHTML = `
            <span class="text-gray-500 text-sm mr-2">Đã chọn:</span>
            ${selectedTitlesHtml}
        `;

            // Only show "Clear All" button if in multi-select mode
            if (isMultiSelectMode) {
                const clearBtn = document.createElement('button');
                clearBtn.className = "text-xs text-rose-500 font-semibold hover:underline ml-2";
                clearBtn.textContent = "Bỏ chọn tất cả";
                clearBtn.onclick = () => {
                    selectedQuizSetIds = [];
                    selectedQuizSetTitles = {}; // Clear titles
                    localStorage.removeItem('selectedQuizSetIds');
                    localStorage.removeItem('selectedQuizSetTitles');
                    syncMultiSelectionUI();
                    loadQuizModes([]);
                    updateActionButtons();
                };
                selectedSetsDisplay.appendChild(clearBtn);
            }

        } else {
            selectedSetsDisplay.classList.add('hidden');
        }
    }

    // Global function to remove a single selected set
    window.removeSelectedQuizSet = (setIdToRemove) => {
        selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setIdToRemove);
        delete selectedQuizSetTitles[setIdToRemove]; // Remove title
        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
        localStorage.setItem('selectedQuizSetTitles', JSON.stringify(selectedQuizSetTitles)); // Sync storage
        syncMultiSelectionUI();
        loadQuizModes(selectedQuizSetIds);
        updateActionButtons();
    };

    // Fix: Add Title Storage
    let selectedQuizSetTitles = {};

    function handleQuizSetSelection(setId, setTitle = null) {
        if (!isMultiSelectMode) {
            // Single Select Mode logic
            selectedQuizSetIds = [setId];
            selectedQuizSetTitles = {}; // Reset titles
            if (setTitle) selectedQuizSetTitles[setId] = setTitle;
        } else {
            // Multi Select Mode logic
            if (setId === 'all' && !selectedQuizSetIds.includes('all')) {
                selectedQuizSetIds = ['all'];
                selectedQuizSetTitles = { 'all': 'Tất cả các bộ' };
            }
            else if (selectedQuizSetIds.includes('all')) {
                selectedQuizSetIds = [setId];
                selectedQuizSetTitles = {};
                if (setTitle) selectedQuizSetTitles[setId] = setTitle;
            }
            else {
                if (selectedQuizSetIds.includes(setId)) {
                    selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setId);
                    delete selectedQuizSetTitles[setId];
                }
                else {
                    selectedQuizSetIds.push(setId);
                    if (setTitle) selectedQuizSetTitles[setId] = setTitle;
                }
            }
        }

        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
        localStorage.setItem('selectedQuizSetTitles', JSON.stringify(selectedQuizSetTitles)); // Save Titles
        syncMultiSelectionUI();
        loadQuizModes(selectedQuizSetIds);
        updateActionButtons();
    }

    function addQuizSetClickListeners() {
        document.querySelectorAll('.quiz-set-card').forEach(item => {
            item.addEventListener('click', function () { handleQuizSetSelection(this.dataset.setId, this.dataset.setTitle); });
        });
    }

    function addPaginationListeners() {
        document.querySelectorAll('.pagination-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                currentPage = parseInt(this.dataset.page) || 1;
                loadQuizSets(currentPage, currentSearchQuery, currentCategory);
            });
        });
    }

    function addArchiveIconListeners() {
        document.querySelectorAll('.archive-icon').forEach(icon => {
            icon.addEventListener('click', async (e) => {
                e.stopPropagation();
                const setId = icon.dataset.setId;
                const url = toggleArchiveUrl.replace('/0', '/' + setId);
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (res.ok) loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
                } catch { }
            });
        });
    }

    function updateActionButtons() {
        const startBtn = document.getElementById('start-learning-btn');

        if (startBtn) {
            startBtn.style.display = 'flex';
            const ready = selectedQuizSetIds.length > 0 && selectedQuizMode;
            startBtn.disabled = !ready;
            startBtn.className = ready
                ? "start-button bg-blue-600 text-white px-8 py-3 rounded-xl text-lg font-bold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-lg shadow-blue-600/30 flex items-center justify-center mx-auto transform hover:-translate-y-1"
                : "start-button bg-gray-400 text-white px-8 py-3 rounded-xl text-lg font-bold cursor-not-allowed flex items-center justify-center mx-auto";
        }
    }

    // Listeners
    quizSearchForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        currentSearchQuery = e.target.elements.q.value;
        currentPage = 1;
        loadQuizSets(currentPage, currentSearchQuery, currentCategory);
    });

    document.querySelectorAll('.tab-filter-button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-filter-button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentCategory = btn.dataset.category;
            currentPage = 1;
            loadQuizSets(currentPage, currentSearchQuery, currentCategory);
        });
    });

    document.getElementById('start-learning-btn')?.addEventListener('click', () => {
        // Clear previous session state from LocalStorage
        localStorage.removeItem('quiz_session_state');
        localStorage.removeItem('quiz_batch_questions');
        localStorage.removeItem('current_batch');

        // Signal new session to the single quiz page
        localStorage.setItem('force_new_session', 'true');

        // ... existing start logic ...
        let startUrl;
        const sessionSize = selectedSessionSize || 10;
        const turnSize = selectedTurnSize || 1;

        if (selectedQuizSetIds.length === 1 && selectedQuizSetIds[0] === 'all') {
            startUrl = new URL(startQuizSessionBaseUrlAllTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
        } else if (selectedQuizSetIds.length === 1) {
            startUrl = new URL(startQuizSessionBaseUrlByIdTemplate.replace('0', selectedQuizSetIds[0]).replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
        } else {
            startUrl = new URL(startQuizSessionBaseUrlMultiTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
            startUrl.searchParams.append('set_ids', selectedQuizSetIds.join(','));
        }
        startUrl.searchParams.append('session_size', sessionSize);
        startUrl.searchParams.append('turn_size', turnSize);
        localStorage.removeItem('selectedQuizSetIds');
        window.location.href = startUrl.toString();
    });

    function updateStep2Content() {
        if (step2Title) step2Title.innerHTML = `<i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Tùy chỉnh phiên học`;
        if (selectedQuizSetIds.length > 0) loadQuizModes(selectedQuizSetIds);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Reset selection on reload (User Request) but keep if preSelect exists
        const psId = new URLSearchParams(window.location.search).get('preSelect');
        if (!psId) {
            localStorage.removeItem('selectedQuizSetIds');
        }
        loadQuizSets(currentPage, currentSearchQuery, currentCategory);
    });
</script>