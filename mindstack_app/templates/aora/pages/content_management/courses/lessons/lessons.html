{% set _v = template_version %}
{% extends _v ~ '/base.html' %}
{% from _v ~ '/includes/search/_search_form.html' import render_search_form %}
{% from _v ~ '/includes/pagination/_pagination.html' import render_pagination %}

{% block title %}Bài học trong khoá học: {{ course.title }}{% endblock %}

{% block head %}
{{ super() }}
{% include _v ~ '/pages/content_management/shared/_shared_styles.html' %}
{% endblock %}

{% block content %}
<div class="cm-shell">
    <div class="cm-container space-y-6">
        <div class="cm-section-header">
            <div class="cm-heading-group">
                <a href="{{ url_for('content_management.content_dashboard', tab='courses') }}" class="cm-link text-sm">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span>Quay lại bảng điều khiển</span>
                </a>
                <span class="cm-eyebrow">Khoá học</span>
                <h1 class="cm-heading">{{ course.title }}</h1>
                <p class="cm-subheading">{{ (course.description or 'Sắp xếp các bài học, cập nhật nội dung và duy trì
                    luồng học tập rõ ràng.') | truncate(110, True, '…') }}</p>
                <div class="cm-chip-row">
                    <span class="cm-pill cm-pill--accent">
                        <i class="fa-solid fa-layer-group"></i>
                        {{ pagination.total }} bài học
                    </span>
                </div>
            </div>
            {% if can_edit %}
            <div class="cm-actions">
                <a href="{{ url_for('content_management.content_management_courses.add_lesson', set_id=course.container_id) }}"
                    class="cm-action cm-action--primary">
                    <i class="fas fa-plus-circle"></i>
                    <span>Thêm bài học mới</span>
                </a>
                <a href="{{ url_for('content_management.content_management_courses.manage_course_excel', set_id=course.container_id) }}"
                    class="cm-action cm-action--ghost">
                    <i class="fa-solid fa-file-excel"></i>
                    <span>Quản lý Excel</span>
                </a>
            </div>
            {% endif %}
        </div>

        <div class="cm-card cm-card--padded">
            <div class="cm-search-header">
                <div class="cm-heading-group">
                    <h2 class="text-lg font-semibold text-slate-800">Tìm kiếm bài học</h2>
                    <p class="cm-subheading text-sm">Lọc theo tiêu đề để nhanh chóng chỉnh sửa đúng nội dung.</p>
                </div>
                <div class="w-full md:w-auto md:min-w-[320px]">
                    {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm bài học...",
                    set_id=course.container_id) }}
                </div>
            </div>
        </div>

        {% if lessons %}
        <div class="cm-grid cm-grid--three">
            {% for lesson in lessons %}
            {% set preview_html = lesson.content.get('content_html') %}
            {% if not preview_html and lesson.content.get('bbcode_content') %}
            {% set preview_html = bbcode_to_html(lesson.content.get('bbcode_content')) %}
            {% endif %}
            <article class="cm-collection-card">
                <div class="flex items-start justify-between gap-4">
                    <div class="space-y-3">
                        <div class="cm-chip-row text-xs font-semibold">
                            <span class="cm-pill cm-pill--accent">
                                <i class="fa-solid fa-graduation-cap"></i>
                                Bài học #<span data-order-label>{{ lesson.order_in_container }}</span>
                            </span>
                            <span class="cm-pill cm-pill--neutral">
                                <i class="fa-solid fa-id-card-clip"></i>
                                ID {{ lesson.item_id }}
                            </span>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900">{{ lesson.content.title }}</h3>
                        {% if preview_html %}
                        <p class="text-sm text-slate-500 line-clamp-4">{{ preview_html | striptags }}</p>
                        {% else %}
                        <p class="text-sm text-slate-400 italic">Bài học này chưa có nội dung hiển thị.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-4 space-y-2 text-xs text-slate-500">
                    {% if lesson.content.estimated_time %}
                    <span class="cm-tag">
                        <i class="fa-regular fa-clock text-slate-400"></i>
                        Thời lượng ước tính: {{ lesson.content.estimated_time }} phút
                    </span>
                    {% endif %}
                    {% if lesson.content.lesson_audio_url or lesson.content.lesson_image_url %}
                    <div class="cm-chip-row">
                        {% if lesson.content.lesson_audio_url %}
                        <span class="cm-tag">
                            <i class="fa-solid fa-volume-high text-slate-400"></i>
                            Audio
                        </span>
                        {% endif %}
                        {% if lesson.content.lesson_image_url %}
                        <span class="cm-tag">
                            <i class="fa-solid fa-image text-slate-400"></i>
                            Hình ảnh
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if lesson.ai_explanation %}
                    <p class="rounded-2xl bg-slate-50 px-4 py-2 text-[0.75rem] text-slate-500">
                        <span class="font-semibold text-slate-600">Giải thích AI:</span>
                        {{ lesson.ai_explanation }}
                    </p>
                    {% endif %}
                </div>

                <div class="cm-divider"></div>
                <div class="flex items-center justify-between">
                    <a href="{{ url_for('content_management.content_management_courses.edit_lesson', set_id=course.container_id, item_id=lesson.item_id) }}"
                        class="cm-link">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <span>Mở trình chỉnh sửa</span>
                    </a>
                    {% if can_edit %}
                    <div class="cm-inline-actions">
                        <a href="{{ url_for('content_management.content_management_courses.edit_lesson', set_id=course.container_id, item_id=lesson.item_id) }}"
                            class="cm-icon-button" title="Chỉnh sửa">
                            <i class="fa-solid fa-pen"></i>
                        </a>
                        <form
                            action="{{ url_for('content_management.content_management_courses.delete_lesson', set_id=course.container_id, item_id=lesson.item_id) }}"
                            method="post" onsubmit="return confirm('Bạn có chắc chắn muốn xóa bài học này?');">
                            <button type="submit" class="cm-icon-button" title="Xoá bài học">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        <div class="pt-6">
            {{ render_pagination(pagination=pagination, search_query=search_query, set_id=course.container_id) }}
        </div>

        {% else %}
        <div class="cm-empty">
            <span class="cm-empty-icon">
                <i class="fa-solid fa-graduation-cap"></i>
            </span>
            <p class="text-sm">Khoá học này chưa có bài học nào hoặc không tìm thấy kết quả phù hợp.</p>
            {% if can_edit %}
            <a href="{{ url_for('content_management.content_management_courses.add_lesson', set_id=course.container_id) }}"
                class="cm-action cm-action--primary">
                <i class="fas fa-plus-circle"></i>
                <span>Thêm bài học đầu tiên</span>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}