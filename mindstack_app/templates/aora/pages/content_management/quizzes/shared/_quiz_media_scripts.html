<script>
(function() {
    if (window.initializeQuizMediaControls) {
        return;
    }

    function normalizeBaseFolder(value) {
        if (!value) {
            return '';
        }
        return String(value).replace(/\\/g, '/').replace(/^\/+|\/+$/g, '');
    }

    function resolveMediaUrl(rawValue, baseFolder) {
        if (!rawValue) {
            return '';
        }
        let raw = String(rawValue).trim();
        if (!raw) {
            return '';
        }
        if (/^(?:https?:)?\/\//i.test(raw) || raw.startsWith('data:')) {
            return raw;
        }
        raw = raw.replace(/\\/g, '/');
        if (raw.startsWith('/')) {
            return raw;
        }
        const uploadsPrefix = 'uploads/';
        if (raw.toLowerCase().startsWith(uploadsPrefix)) {
            raw = raw.slice(uploadsPrefix.length);
        }
        const base = normalizeBaseFolder(baseFolder);
        if (base) {
            const normalizedBase = base.endsWith('/') ? base : `${base}/`;
            if (!raw.startsWith(normalizedBase) && !raw.startsWith(base) && !raw.includes('/')) {
                raw = `${base}/${raw}`;
            }
        }
        return `/static/${raw}`;
    }

    function setupImageField(field, baseFolder) {
        const input = field.querySelector('[data-role="quiz-image-input"]');
        const preview = field.querySelector('[data-role="quiz-image-preview"]');
        const placeholder = field.querySelector('[data-role="quiz-image-placeholder"]');
        const openButton = field.querySelector('[data-role="quiz-open-image"]');
        const statusLabel = field.querySelector('[data-role="quiz-image-status"]');
        const initialUrl = field.dataset.initialUrl || '';

        const setStatus = (message, type) => {
            if (!statusLabel) {
                return;
            }
            statusLabel.textContent = message || '';
            statusLabel.classList.remove('text-green-600', 'text-red-500', 'text-blue-600');
            if (!message) {
                return;
            }
            if (type === 'error') {
                statusLabel.classList.add('text-red-500');
            } else if (type === 'success') {
                statusLabel.classList.add('text-green-600');
            } else {
                statusLabel.classList.add('text-blue-600');
            }
        };

        const togglePreview = (url) => {
            const hasUrl = Boolean(url);
            if (preview) {
                if (hasUrl) {
                    preview.src = url;
                    preview.classList.remove('hidden');
                } else {
                    preview.removeAttribute('src');
                    preview.classList.add('hidden');
                }
            }
            if (placeholder) {
                placeholder.classList.toggle('hidden', hasUrl);
            }
            if (openButton) {
                openButton.classList.toggle('hidden', !hasUrl);
                if (hasUrl) {
                    openButton.onclick = () => window.open(url, '_blank');
                } else {
                    openButton.onclick = null;
                }
            }
        };

        const applyValue = (value) => {
            const resolved = resolveMediaUrl(value, baseFolder);
            if (!resolved) {
                togglePreview('');
                setStatus('', '');
                return;
            }
            togglePreview(resolved);
            setStatus('Đang tải xem trước hình ảnh...', 'info');
        };

        if (preview) {
            preview.addEventListener('load', () => {
                setStatus('Đã tải xem trước hình ảnh.', 'success');
            });
            preview.addEventListener('error', () => {
                togglePreview('');
                setStatus('Không thể tải hình ảnh. Vui lòng kiểm tra đường dẫn.', 'error');
            });
        }

        if (initialUrl) {
            togglePreview(initialUrl);
        }

        if (input) {
            ['change', 'input'].forEach(evt => {
                input.addEventListener(evt, () => {
                    applyValue(input.value);
                });
            });
        }
    }

    function setupAudioField(field, baseFolder) {
        const input = field.querySelector('[data-role="quiz-audio-input"]');
        const player = field.querySelector('[data-role="quiz-audio-player"]');
        const placeholder = field.querySelector('[data-role="quiz-audio-placeholder"]');
        const statusLabel = field.querySelector('[data-role="quiz-audio-status"]');
        const initialUrl = field.dataset.initialUrl || '';

        const setStatus = (message, type) => {
            if (!statusLabel) {
                return;
            }
            statusLabel.textContent = message || '';
            statusLabel.classList.remove('text-green-600', 'text-red-500', 'text-blue-600');
            if (!message) {
                return;
            }
            if (type === 'error') {
                statusLabel.classList.add('text-red-500');
            } else if (type === 'success') {
                statusLabel.classList.add('text-green-600');
            } else {
                statusLabel.classList.add('text-blue-600');
            }
        };

        const togglePlayer = (url) => {
            const hasUrl = Boolean(url);
            if (player) {
                if (hasUrl) {
                    player.src = url;
                    player.classList.remove('hidden');
                } else {
                    player.removeAttribute('src');
                    player.load();
                    player.classList.add('hidden');
                }
            }
            if (placeholder) {
                placeholder.classList.toggle('hidden', hasUrl);
            }
        };

        const applyValue = (value) => {
            const resolved = resolveMediaUrl(value, baseFolder);
            if (!resolved) {
                togglePlayer('');
                setStatus('', '');
                return;
            }
            togglePlayer(resolved);
            setStatus('Đang chuẩn bị xem trước audio...', 'info');
        };

        if (player) {
            player.addEventListener('canplay', () => {
                setStatus('Audio đã sẵn sàng để nghe thử.', 'success');
            });
            player.addEventListener('error', () => {
                togglePlayer('');
                setStatus('Không thể tải audio. Vui lòng kiểm tra đường dẫn.', 'error');
            });
        }

        if (initialUrl) {
            togglePlayer(initialUrl);
        }

        if (input) {
            ['change', 'input'].forEach(evt => {
                input.addEventListener(evt, () => {
                    applyValue(input.value);
                });
            });
        }
    }

    window.initializeQuizMediaControls = function initializeQuizMediaControls(options) {
        const opts = options || {};
        const form = opts.form || (opts.formSelector ? document.querySelector(opts.formSelector) : null);
        if (!form) {
            return;
        }
        const imageBaseFolder = form.dataset.imageBaseFolder || '';
        const audioBaseFolder = form.dataset.audioBaseFolder || '';
        const imageField = form.querySelector('[data-role="quiz-image-field"]');
        const audioField = form.querySelector('[data-role="quiz-audio-field"]');

        if (imageField) {
            setupImageField(imageField, imageBaseFolder);
        }
        if (audioField) {
            setupAudioField(audioField, audioBaseFolder);
        }
    };
})();
</script>
