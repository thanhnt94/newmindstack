{# ================= CONTENT DASHBOARD DESKTOP ================= #}
{# Desktop layout for content management dashboard #}

<div class="cm-shell">
    <div class="cm-container space-y-6">
        <header class="cm-card cm-card--padded">
            <div class="cm-heading-group">
                <span class="cm-eyebrow">Không gian biên tập</span>
                <h1 class="cm-heading">Quản lý nội dung</h1>
            </div>
        </header>

        <section class="cm-card cm-card--padded">
            <div class="cm-tab-bar">
                <button id="tab-flashcards" data-target="flashcards" class="tab-button cm-tab" aria-selected="false">
                    <i class="fa-solid fa-clone text-sm"></i>
                    <span>Vocabulary</span>
                </button>
                <button id="tab-quizzes" data-target="quizzes" class="tab-button cm-tab" aria-selected="false">
                    <i class="fa-solid fa-circle-question text-sm"></i>
                    <span>Quiz</span>
                </button>
                <button id="tab-courses" data-target="courses" class="tab-button cm-tab" aria-selected="false">
                    <i class="fa-solid fa-book text-sm"></i>
                    <span>Course</span>
                </button>
            </div>

            <div id="tab-content" class="min-h-[420px] pt-8">
                <div class="flex flex-col items-center justify-center gap-4 text-slate-500">
                    <span
                        class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-indigo-50 text-indigo-500">
                        <i class="fa-solid fa-rotate"></i>
                    </span>
                    <p class="text-sm sm:text-base font-medium">Đang tải nội dung phù hợp...</p>
                    <p class="text-xs sm:text-sm text-slate-400">Nội dung sẽ xuất hiện ngay khi sẵn sàng.</p>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const coursesListUrl = "{{ url_for('content_management.content_management_courses.list_course_sets') }}";
        const flashcardSetsListUrl = "{{ url_for('content_management.content_management_flashcards.list_flashcard_sets') }}";
        const quizSetsListUrl = "{{ url_for('content_management.content_management_quizzes.list_quiz_sets') }}";

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContent = document.getElementById('tab-content');
        const validTabs = ['courses', 'flashcards', 'quizzes'];
        const SESSION_STORAGE_KEY = 'activeContentTab';

        async function loadTabContent(tabName) {
            tabContent.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500"><svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-3 text-lg">Đang tải nội dung ${tabName}...</p></div>`;

            tabButtons.forEach(button => {
                button.setAttribute('aria-selected', 'false');
                button.dataset.active = 'false';
            });

            const currentTabButton = document.getElementById('tab-' + tabName);
            if (currentTabButton) {
                currentTabButton.setAttribute('aria-selected', 'true');
                currentTabButton.dataset.active = 'true';
                sessionStorage.setItem(SESSION_STORAGE_KEY, tabName);
            }

            let url;
            if (tabName === 'courses') url = coursesListUrl;
            else if (tabName === 'flashcards') url = flashcardSetsListUrl;
            else if (tabName === 'quizzes') url = quizSetsListUrl;
            else {
                tabContent.innerHTML = '<p class="text-red-500">Lỗi: Tab không hợp lệ.</p>';
                return;
            }

            try {
                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                tabContent.innerHTML = await response.text();
            } catch (error) {
                console.error('Lỗi khi tải nội dung tab:', error);
                tabContent.innerHTML = `<p class="text-red-500 text-center">Không thể tải nội dung. Vui lòng thử lại.</p>`;
            }
        }

        window.loadTabContent = loadTabContent;

        tabButtons.forEach(button => {
            button.addEventListener('click', function () {
                loadTabContent(this.dataset.target);
            });
        });

        window.addEventListener('content-management:refresh', (event) => {
            const targetTab = event?.detail?.targetTab;
            if (targetTab && validTabs.includes(targetTab)) {
                loadTabContent(targetTab);
            }
        });

        let initialTab = sessionStorage.getItem(SESSION_STORAGE_KEY) || new URLSearchParams(window.location.search).get('tab');
        if (!initialTab || !validTabs.includes(initialTab)) {
            initialTab = 'flashcards';
        }
        loadTabContent(initialTab);

        async function fetchAndUpdateContent(url) {
            tabContent.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500"><svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-3 text-lg">Đang tải...</p></div>`;
            try {
                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                tabContent.innerHTML = await response.text();
            } catch (error) {
                console.error('Lỗi khi tải nội dung:', error);
                tabContent.innerHTML = `<p class="text-red-500 text-center">Không thể tải nội dung. Vui lòng thử lại.</p>`;
            }
        }

        tabContent.addEventListener('click', function (event) {
            const link = event.target.closest('a');
            if (link && link.href && link.href.includes('page=')) {
                event.preventDefault();
                fetchAndUpdateContent(link.href);
            }
        });

        tabContent.addEventListener('submit', function (event) {
            const form = event.target.closest('form');
            if (form && form.querySelector('input[name="q"]')) {
                event.preventDefault();
                const formData = new FormData(form);
                const searchQuery = formData.get('q');
                const url = new URL(form.action);
                url.searchParams.set('q', searchQuery);
                fetchAndUpdateContent(url.href);
            }
        });
    });
</script>