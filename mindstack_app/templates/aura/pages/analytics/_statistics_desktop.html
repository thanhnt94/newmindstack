{# ================= STATS DESKTOP INTERFACE ================= #}
<style>
    :root {
        --primary-color: #3b82f6;
        --background-color: #f9fafb;
        --card-background: #ffffff;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
        --cal-heatmap-scrolly-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .dashboard-container {
        width: min(100%, 1400px);
        margin: 0 auto;
        padding: 2rem 1rem;
        font-family: 'Inter', sans-serif;
    }

    .dashboard-header {
        font-size: 2.25rem;
        font-weight: 800;
        color: var(--text-primary);
        text-align: center;
        margin-bottom: 2.5rem;
    }

    .stats-section {
        background-color: var(--card-background);
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
    }

    .section-title i {
        color: var(--primary-color);
        margin-right: 0.75rem;
    }

    .overview-section {
        margin-bottom: 2rem;
    }

    .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
    }

    .overview-card {
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
        box-shadow: 0 10px 25px -20px rgba(15, 23, 42, 0.4);
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .overview-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 35px -18px rgba(15, 23, 42, 0.35);
    }

    .overview-card.compact {
        padding: 1.1rem 1.25rem;
    }

    .overview-label {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-secondary);
    }

    .overview-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-primary);
    }

    .overview-card.compact .overview-value {
        font-size: 1.6rem;
    }

    .overview-subtitle {
        font-size: 0.95rem;
        color: var(--text-secondary);
    }

    .overview-grid-secondary {
        margin-top: 1.5rem;
    }

    .analytics-section {
        margin-bottom: 2rem;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .analytics-card {
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        background: var(--card-background);
        box-shadow: 0 10px 35px -25px rgba(15, 23, 42, 0.4);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .analytics-card .stat-chart-body {
        min-height: 260px;
    }

    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1.75rem;
    }

    .insight-card {
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
        background: var(--card-background);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .insight-label {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .insight-label i {
        color: var(--primary-color);
    }

    .insight-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .insight-meta {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .insights-activity {
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
        background: var(--card-background);
        box-shadow: 0 10px 30px -24px rgba(30, 64, 175, 0.25);
    }

    .insights-activity-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .activity-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .activity-item {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-info {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        flex: 1;
    }

    .activity-label {
        font-weight: 600;
        color: var(--text-primary);
    }

    .activity-reason {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    .activity-meta {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .activity-score {
        font-weight: 700;
        min-width: 90px;
        text-align: right;
        font-size: 1rem;
    }

    .activity-score.positive {
        color: #16a34a;
    }

    .activity-score.negative {
        color: #dc2626;
    }

    .activity-empty {
        margin: 0;
        font-size: 0.95rem;
        color: var(--text-secondary);
    }

    /* Bảng xếp hạng */
    .leaderboard-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-control {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background-color: #f9fafb;
    }

    .timeframe-tabs {
        display: flex;
        background-color: #f3f4f6;
        border-radius: 0.5rem;
        padding: 0.25rem;
    }

    .tab-button {
        padding: 0.5rem 1rem;
        border: none;
        background-color: transparent;
        border-radius: 0.375rem;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }

    .tab-button.active {
        background-color: var(--card-background);
        color: var(--primary-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .leaderboard-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .leaderboard-item {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .leaderboard-item:last-child {
        border-bottom: none;
    }

    .rank {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--text-secondary);
        width: 3rem;
        text-align: center;
    }

    .rank .fa-medal {
        font-size: 1.5rem;
    }

    .gold-medal {
        color: #facc15;
    }

    .silver-medal {
        color: #d1d5db;
    }

    .bronze-medal {
        color: #cd7f32;
    }

    .username {
        font-weight: 600;
        color: var(--text-primary);
    }

    .score-value {
        margin-left: auto;
        font-weight: 700;
        color: var(--primary-color);
    }

    .empty-message {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .loader-container {
        display: flex;
        justify-content: center;
        padding: 2rem;
    }

    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Bổ sung cột thứ 3 cho Khoá học */
    .stats-main-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
        gap: 2rem;
    }

    @media (min-width: 1024px) {
        .stats-main-grid {
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
        }
    }

    .stat-cards-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .stat-card {
        display: flex;
        align-items: center;
        background-color: #f9fafb;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
    }

    .stat-card-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .stat-card-icon.score {
        background-color: #fef3c7;
        color: #f59e0b;
    }

    .stat-card-icon.learned {
        background-color: #dcfce7;
        color: #22c55e;
    }

    .stat-card-icon.sets {
        background-color: #dbeafe;
        color: #3b82f6;
    }

    .stat-card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-card-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .stat-detail-section {
        margin-top: 1.75rem;
        border-top: 1px solid var(--border-color);
        padding-top: 1.5rem;
    }

    .stat-detail-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .stat-detail-header label {
        font-weight: 600;
        color: var(--text-primary);
    }

    .stat-detail-select {
        min-width: 220px;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background-color: #f9fafb;
    }

    .stat-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .stat-detail-card {
        background-color: #f9fafb;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .stat-detail-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 0.35rem;
    }

    .stat-detail-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-detail-note {
        margin-top: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .stat-detail-list-container {
        margin-top: 1.25rem;
    }

    .stat-detail-subtitle {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
    }

    .stat-detail-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .stat-detail-list-item {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        background-color: #f9fafb;
    }

    .stat-detail-list-item strong {
        display: block;
        color: var(--text-primary);
        margin-bottom: 0.35rem;
    }

    .stat-detail-list-item span {
        display: block;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .stat-detail-meta {
        display: block;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.35rem;
    }

    /* Modal chi tiết thống kê */
    .stats-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1050;
    }

    .stats-modal.active {
        display: flex;
    }

    .stats-modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(17, 24, 39, 0.55);
    }

    .stats-modal-dialog {
        position: relative;
        background: #ffffff;
        border-radius: 0.75rem;
        width: min(92%, 760px);
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px -12px rgba(30, 64, 175, 0.35);
        overflow: hidden;
    }

    .stats-modal-header {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        padding: 1.5rem 1.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .stats-modal-title {
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .stats-modal-summary {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin: 0;
    }

    .stats-modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        border: none;
        background: transparent;
        font-size: 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
    }

    .stats-modal-tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        padding: 0 1.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        background: #f9fafb;
    }

    .stats-modal-tab {
        border: none;
        background: #e5e7eb;
        color: var(--text-secondary);
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }

    .stats-modal-tab.active {
        background: var(--primary-color);
        color: #ffffff;
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.35);
    }

    .stats-modal-body {
        padding: 1.25rem 1.75rem;
        overflow-y: auto;
        flex: 1;
    }

    .stats-modal-body .stat-detail-list {
        gap: 0.65rem;
    }

    .stats-modal-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.75rem 1.25rem;
        border-top: 1px solid var(--border-color);
    }

    .stats-modal-page-btn {
        border: none;
        background: var(--primary-color);
        color: #ffffff;
        padding: 0.45rem 0.95rem;
        border-radius: 0.45rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s ease-in-out;
    }

    .stats-modal-page-btn[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .stats-modal-page-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Activity charts */
    .stat-chart-section {
        margin-top: 1.75rem;
        border-top: 1px solid var(--border-color);
        padding-top: 1.5rem;
    }

    .stat-chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 0.75rem;
    }

    .stat-chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .stat-chart-range {
        padding: 0.4rem 0.65rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background-color: #f9fafb;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .stat-chart-body {
        position: relative;
        min-height: 220px;
    }

    .stat-chart-body canvas {
        width: 100%;
        height: 220px;
    }

    .stat-chart-empty {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        text-align: center;
        padding: 1rem;
    }
</style>

<div class="dashboard-container">
    <h1 class="dashboard-header"><i class="fas fa-chart-pie"></i> Thống kê</h1>

    <div class="stats-section overview-section">
        <h2 class="section-title"><i class="fas fa-chart-line"></i> Tổng quan nhanh</h2>
        <div class="overview-grid">
            <div class="overview-card">
                <span class="overview-label">Tổng điểm tích lũy</span>
                <span class="overview-value" data-number="{{ dashboard_data.total_score_all_time }}">{{
                    dashboard_data.total_score_all_time }}</span>
                <span class="overview-subtitle">Từ trước tới nay</span>
            </div>
            <div class="overview-card">
                <span class="overview-label">Điểm 30 ngày gần nhất</span>
                <span class="overview-value" data-number="{{ dashboard_data.total_score_last_30_days }}">{{
                    dashboard_data.total_score_last_30_days }}</span>
                <span class="overview-subtitle">Trung bình <span
                        data-number="{{ dashboard_data.average_daily_score_recent }}" data-precision="1">{{
                        dashboard_data.average_daily_score_recent }}</span> điểm/ngày</span>
            </div>
            <div class="overview-card">
                <span class="overview-label">Ngày hoạt động</span>
                <span class="overview-value" data-number="{{ dashboard_data.active_days }}">{{
                    dashboard_data.active_days }}</span>
                <span class="overview-subtitle">Điểm trung bình <span
                        data-number="{{ dashboard_data.average_daily_score }}" data-precision="1">{{
                        dashboard_data.average_daily_score }}</span> điểm/ngày</span>
            </div>
            <div class="overview-card">
                <span class="overview-label">Phiên học</span>
                <span class="overview-value" data-number="{{ dashboard_data.total_activity_entries }}">{{
                    dashboard_data.total_activity_entries }}</span>
                <span class="overview-subtitle">Hoạt động gần nhất: <span
                        data-last-active="{{ dashboard_data.last_activity or '' }}">{{ dashboard_data.last_activity or
                        '' }}</span></span>
            </div>
        </div>
        <div class="overview-grid overview-grid-secondary">
            <div class="overview-card compact">
                <span class="overview-label">Chuỗi học hiện tại</span>
                <span class="overview-value" data-number="{{ dashboard_data.current_learning_streak }}">{{
                    dashboard_data.current_learning_streak }}</span>
                <span class="overview-subtitle">Dài nhất <span
                        data-number="{{ dashboard_data.longest_learning_streak }}">{{
                        dashboard_data.longest_learning_streak }}</span> ngày</span>
            </div>
            <div class="overview-card compact">
                <span class="overview-label">Flashcard thành thạo</span>
                <span class="overview-value" data-number="{{ dashboard_data.flashcard_mastered_count }}">{{
                    dashboard_data.flashcard_mastered_count }}</span>
                <span class="overview-subtitle">Độ chính xác <span
                        data-percent="{{ dashboard_data.flashcard_accuracy_percent if dashboard_data.flashcard_accuracy_percent is not none else '' }}">{{
                        dashboard_data.flashcard_accuracy_percent if dashboard_data.flashcard_accuracy_percent is not
                        none else '--' }}</span></span>
            </div>
            <div class="overview-card compact">
                <span class="overview-label">Trắc nghiệm thành thạo</span>
                <span class="overview-value" data-number="{{ dashboard_data.quiz_mastered_count }}">{{
                    dashboard_data.quiz_mastered_count }}</span>
                <span class="overview-subtitle">Độ chính xác <span
                        data-percent="{{ dashboard_data.quiz_accuracy_percent if dashboard_data.quiz_accuracy_percent is not none else '' }}">{{
                        dashboard_data.quiz_accuracy_percent if dashboard_data.quiz_accuracy_percent is not none else
                        '--' }}</span></span>
            </div>
            <div class="overview-card compact">
                <span class="overview-label">Khoá học đang học</span>
                <span class="overview-value" data-number="{{ dashboard_data.courses_in_progress_count }}">{{
                    dashboard_data.courses_in_progress_count }}</span>
                <span class="overview-subtitle">Hoàn thành TB <span
                        data-percent="{{ dashboard_data.course_avg_completion_percent }}">{{
                        dashboard_data.course_avg_completion_percent }}</span></span>
            </div>
        </div>
    </div>

    <div class="stats-section analytics-section">
        <div class="analytics-grid">
            <div class="analytics-card">
                <div class="stat-chart-header">
                    <span class="stat-chart-title">Xu hướng điểm số</span>
                    <select id="score-trend-range" class="stat-chart-range">
                        <option value="7d">7 ngày</option>
                        <option value="30d" selected>30 ngày</option>
                        <option value="90d">90 ngày</option>
                        <option value="180d">180 ngày</option>
                        <option value="365d">365 ngày</option>
                        <option value="all">Toàn bộ</option>
                    </select>
                </div>
                <div class="stat-chart-body">
                    <div class="loader-container" id="score-trend-loader" style="display: none;">
                        <div class="loader"></div>
                    </div>
                    <p class="stat-chart-empty" id="score-trend-empty" style="display: none;">Không có dữ liệu điểm số
                        để hiển thị.</p>
                    <canvas id="score-trend-chart" aria-label="Biểu đồ xu hướng điểm số"></canvas>
                </div>
                <p class="stat-detail-note" id="score-trend-summary">--</p>
            </div>
            <div class="analytics-card">
                <div class="stat-chart-header">
                    <span class="stat-chart-title">Phân bổ hoạt động</span>
                    <select id="activity-breakdown-range" class="stat-chart-range">
                        <option value="7d">7 ngày</option>
                        <option value="30d" selected>30 ngày</option>
                        <option value="90d">90 ngày</option>
                        <option value="365d">365 ngày</option>
                        <option value="all">Toàn bộ</option>
                    </select>
                </div>
                <div class="stat-chart-body">
                    <div class="loader-container" id="activity-breakdown-loader" style="display: none;">
                        <div class="loader"></div>
                    </div>
                    <p class="stat-chart-empty" id="activity-breakdown-empty" style="display: none;">Không có dữ liệu
                        hoạt động.</p>
                    <canvas id="activity-breakdown-chart" aria-label="Biểu đồ phân bổ hoạt động"></canvas>
                </div>
                <p class="stat-detail-note" id="activity-breakdown-summary">--</p>
            </div>
        </div>
    </div>

    <div class="stats-section insights-section">
        <h2 class="section-title"><i class="fas fa-lightbulb"></i> Thông tin học tập nổi bật</h2>
        <div class="insights-grid">
            <div class="insight-card">
                <span class="insight-label"><i class="fas fa-layer-group"></i> Flashcard</span>
                <span class="insight-value"
                    data-percent="{{ dashboard_data.flashcard_accuracy_percent if dashboard_data.flashcard_accuracy_percent is not none else '' }}">{{
                    dashboard_data.flashcard_accuracy_percent if dashboard_data.flashcard_accuracy_percent is not none
                    else '--' }}</span>
                <span class="insight-meta">Thành thạo <span
                        data-number="{{ dashboard_data.flashcard_mastered_count }}">{{
                        dashboard_data.flashcard_mastered_count }}</span> thẻ</span>
                <span class="insight-meta">Đúng <span data-number="{{ dashboard_data.flashcard_correct_total }}">{{
                        dashboard_data.flashcard_correct_total }}</span> / <span
                        data-number="{{ dashboard_data.flashcard_attempt_total }}">{{
                        dashboard_data.flashcard_attempt_total }}</span> lượt • Chuỗi tốt nhất <span
                        data-number="{{ dashboard_data.flashcard_best_streak_overall }}">{{
                        dashboard_data.flashcard_best_streak_overall }}</span></span>
            </div>
            <div class="insight-card">
                <span class="insight-label"><i class="fas fa-question-circle"></i> Trắc nghiệm</span>
                <span class="insight-value"
                    data-percent="{{ dashboard_data.quiz_accuracy_percent if dashboard_data.quiz_accuracy_percent is not none else '' }}">{{
                    dashboard_data.quiz_accuracy_percent if dashboard_data.quiz_accuracy_percent is not none else '--'
                    }}</span>
                <span class="insight-meta">Thành thạo <span data-number="{{ dashboard_data.quiz_mastered_count }}">{{
                        dashboard_data.quiz_mastered_count }}</span> câu hỏi</span>
                <span class="insight-meta">Đúng <span data-number="{{ dashboard_data.quiz_correct_total }}">{{
                        dashboard_data.quiz_correct_total }}</span> / <span
                        data-number="{{ dashboard_data.quiz_attempt_total }}">{{ dashboard_data.quiz_attempt_total
                        }}</span> lượt • Chuỗi tốt nhất <span
                        data-number="{{ dashboard_data.quiz_best_streak_overall }}">{{
                        dashboard_data.quiz_best_streak_overall }}</span></span>
            </div>
            <div class="insight-card">
                <span class="insight-label"><i class="fas fa-graduation-cap"></i> Khoá học</span>
                <span class="insight-value" data-percent="{{ dashboard_data.course_avg_completion_percent }}">{{
                    dashboard_data.course_avg_completion_percent }}</span>
                <span class="insight-meta">Đang học <span
                        data-number="{{ dashboard_data.courses_in_progress_count }}">{{
                        dashboard_data.courses_in_progress_count }}</span> khoá • Hoàn thành <span
                        data-number="{{ dashboard_data.lessons_completed_count }}">{{
                        dashboard_data.lessons_completed_count }}</span> bài</span>
                <span class="insight-meta">Cập nhật gần nhất: <span
                        data-course-progress="{{ dashboard_data.course_last_progress or '' }}">{{
                        dashboard_data.course_last_progress or '' }}</span></span>
            </div>
        </div>
        <div class="insights-activity">
            <h3 class="insights-activity-title">Hoạt động gần đây</h3>
            {% if recent_activity %}
            <ul class="activity-list">
                {% for entry in recent_activity %}
                <li class="activity-item">
                    <span
                        class="activity-score {% if entry.score_change >= 0 %}positive{% else %}negative{% endif %}">{{
                        '+' if entry.score_change >= 0 else '' }}{{ entry.score_change }} điểm</span>
                    <div class="activity-info">
                        <span class="activity-label">{{ entry.item_type_label }}</span>
                        <span class="activity-reason">{{ entry.reason }}</span>
                        <span class="activity-meta" data-activity-timestamp="{{ entry.timestamp or '' }}">{{
                            entry.timestamp or '' }}</span>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="activity-empty">Chưa có hoạt động nào để hiển thị.</p>
            {% endif %}
        </div>
    </div>

    <div class="stats-section leaderboard-section">
        <h2 class="section-title"><i class="fas fa-trophy"></i> Bảng xếp hạng Người dùng</h2>

        <div class="leaderboard-controls">
            <div class="form-group sort-by-group">
                <label for="sort_by">Sắp xếp theo:</label>
                <select id="sort_by" name="sort_by" class="form-control">
                    <option value="total_score" {% if current_sort_by=='total_score' %}selected{% endif %}>Tổng điểm
                        (trong kỳ)</option>
                    <option value="total_reviews" disabled>Số lượt ôn tập (Flashcard)</option>
                </select>
            </div>
            <div class="form-group timeframe-group">
                <div class="timeframe-tabs">
                    <button type="button" class="tab-button {% if current_timeframe == 'day' %}active{% endif %}"
                        data-timeframe="day">Hôm nay</button>
                    <button type="button" class="tab-button {% if current_timeframe == 'week' %}active{% endif %}"
                        data-timeframe="week">Tuần này</button>
                    <button type="button" class="tab-button {% if current_timeframe == 'month' %}active{% endif %}"
                        data-timeframe="month">Tháng này</button>
                    <button type="button" class="tab-button {% if current_timeframe == 'all_time' %}active{% endif %}"
                        data-timeframe="all_time">Toàn bộ</button>
                </div>
            </div>
        </div>

        <div id="leaderboard-content">
            <ul class="leaderboard-list" id="leaderboard-list-container">
                {% include _v ~ '/pages/analytics/_leaderboard_list.html' %}
            </ul>
            <p class="empty-message" id="leaderboard-empty-message"
                style="display: {% if not leaderboard_data %}block{% else %}none{% endif %};">Không có dữ liệu bảng xếp
                hạng để hiển thị.</p>
            <div class="loader-container" id="leaderboard-loader" style="display: none;">
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <div class="stats-main-grid">
        <div class="stats-column flashcard-stats-column">
            <div class="stats-section">
                <h2 class="section-title">Tổng quan Flashcard</h2>
                <div class="stat-cards-grid">
                    <div class="stat-card" role="button" tabindex="0" data-type="flashcard" data-category="all"
                        data-container-id="all" data-container-title="Tất cả Flashcard"
                        data-title="Tổng điểm Flashcard">
                        <div class="stat-card-icon score"><i class="fas fa-star"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.flashcard_score }}</span>
                            <span class="stat-card-label">Tổng điểm Flashcard</span>
                        </div>
                    </div>
                    <div class="stat-card" role="button" tabindex="0" data-type="flashcard" data-category="mastered"
                        data-container-id="all" data-container-title="Tất cả Flashcard" data-title="Thẻ đã học">
                        <div class="stat-card-icon learned"><i class="fas fa-check-circle"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.learned_distinct_overall }}</span>
                            <span class="stat-card-label">Thẻ đã học</span>
                        </div>
                    </div>
                    <div class="stat-card" role="button" tabindex="0" data-type="flashcard" data-category="mastered"
                        data-container-id="all" data-container-title="Tất cả Flashcard" data-title="Bộ đã học">
                        <div class="stat-card-icon sets"><i class="fas fa-layer-group"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.learned_sets_count }}</span>
                            <span class="stat-card-label">Bộ đã học</span>
                        </div>
                    </div>
                </div>
                <div class="stat-detail-section">
                    <div class="stat-detail-header">
                        <label for="flashcard-set-select">Chi tiết theo bộ</label>
                        <select id="flashcard-set-select" class="stat-detail-select"
                            data-has-options="{{ 'true' if flashcard_sets else 'false' }}" {% if not flashcard_sets
                            %}disabled{% endif %}>
                            {% if flashcard_sets %}
                            {% for flashcard_set in flashcard_sets %}
                            <option value="{{ flashcard_set.id }}" {% if loop.first %}selected{% endif %}>{{
                                flashcard_set.title }}</option>
                            {% endfor %}
                            {% else %}
                            <option value="">Chưa có bộ Flashcard nào</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="loader-container" id="flashcard-detail-loader" style="display: none;">
                        <div class="loader"></div>
                    </div>
                    <p class="empty-message" id="flashcard-detail-empty"
                        style="display: {{ 'none' if flashcard_sets else 'block' }};">Bạn chưa có bộ Flashcard nào đang
                        học.</p>
                    <div class="stat-detail-grid" id="flashcard-detail-metrics" style="display: none;">
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Tổng số thẻ</span>
                            <span class="stat-detail-value" data-flashcard-metric="total_cards">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Đã ôn tập</span>
                            <span class="stat-detail-value" data-flashcard-metric="studied_cards">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Thẻ thành thạo</span>
                            <span class="stat-detail-value" data-flashcard-metric="learned_cards">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Độ chính xác</span>
                            <span class="stat-detail-value" data-flashcard-metric="accuracy">--</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Chuỗi đúng TB</span>
                            <span class="stat-detail-value" data-flashcard-metric="avg_streak">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Chuỗi đúng tốt nhất</span>
                            <span class="stat-detail-value" data-flashcard-metric="best_streak">0</span>
                        </div>
                    </div>
                    <div class="stat-detail-list-container" id="flashcard-learned-container" style="display: none;">
                        <h4 class="stat-detail-subtitle" id="flashcard-detail-subtitle">Danh sách thẻ</h4>
                        <ul class="stat-detail-list" id="flashcard-learned-list"></ul>
                    </div>
                </div>
                <div class="stat-chart-section">
                    <div class="stat-chart-header">
                        <span class="stat-chart-title">Hoạt động gần đây</span>
                        <select id="flashcard-chart-range" class="stat-chart-range">
                            <option value="7d">7 ngày</option>
                            <option value="30d" selected>30 ngày</option>
                            <option value="90d">90 ngày</option>
                            <option value="365d">365 ngày</option>
                            <option value="all">Toàn bộ</option>
                        </select>
                    </div>
                    <div class="stat-chart-body">
                        <div class="loader-container" id="flashcard-chart-loader" style="display: none;">
                            <div class="loader"></div>
                        </div>
                        <p class="stat-chart-empty" id="flashcard-chart-empty" style="display: none;">Chọn một bộ để xem
                            hoạt động.</p>
                        <canvas id="flashcard-activity-chart" aria-label="Biểu đồ hoạt động flashcard"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-column quiz-stats-column">
            <div class="stats-section">
                <h2 class="section-title">Tổng quan Trắc nghiệm</h2>
                <div class="stat-cards-grid">
                    <div class="stat-card" role="button" tabindex="0" data-type="quiz" data-category="all"
                        data-container-id="all" data-container-title="Tất cả Quiz" data-title="Tổng điểm Trắc nghiệm">
                        <div class="stat-card-icon score" style="background-color: #fce7f3; color: #db2777;"><i
                                class="fas fa-trophy"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.quiz_score }}</span>
                            <span class="stat-card-label">Tổng điểm Trắc nghiệm</span>
                        </div>
                    </div>
                    <div class="stat-card" role="button" tabindex="0" data-type="quiz" data-category="learning"
                        data-container-id="all" data-container-title="Tất cả Quiz" data-title="Câu đã trả lời">
                        <div class="stat-card-icon learned" style="background-color: #e0e7ff; color: #4f46e5;"><i
                                class="fas fa-question-circle"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.questions_answered_count }}</span>
                            <span class="stat-card-label">Câu đã trả lời</span>
                        </div>
                    </div>
                    <div class="stat-card" role="button" tabindex="0" data-type="quiz" data-category="mastered"
                        data-container-id="all" data-container-title="Tất cả Quiz" data-title="Bộ đã làm">
                        <div class="stat-card-icon sets" style="background-color: #fee2e2; color: #ef4444;"><i
                                class="fas fa-tasks"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.quiz_sets_started_count }}</span>
                            <span class="stat-card-label">Bộ đã làm</span>
                        </div>
                    </div>
                </div>
                <div class="stat-detail-section">
                    <div class="stat-detail-header">
                        <label for="quiz-set-select">Chi tiết theo bộ</label>
                        <select id="quiz-set-select" class="stat-detail-select"
                            data-has-options="{{ 'true' if quiz_sets else 'false' }}" {% if not quiz_sets %}disabled{%
                            endif %}>
                            {% if quiz_sets %}
                            {% for quiz_set in quiz_sets %}
                            <option value="{{ quiz_set.id }}" {% if loop.first %}selected{% endif %}>{{ quiz_set.title
                                }}</option>
                            {% endfor %}
                            {% else %}
                            <option value="">Chưa có bộ Trắc nghiệm nào</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="loader-container" id="quiz-detail-loader" style="display: none;">
                        <div class="loader"></div>
                    </div>
                    <p class="empty-message" id="quiz-detail-empty"
                        style="display: {{ 'none' if quiz_sets else 'block' }};">Bạn chưa có bộ Trắc nghiệm nào đang
                        làm.</p>
                    <div class="stat-detail-grid" id="quiz-detail-metrics" style="display: none;">
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Tổng số câu hỏi</span>
                            <span class="stat-detail-value" data-quiz-metric="total_questions">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Đã trả lời</span>
                            <span class="stat-detail-value" data-quiz-metric="attempted_questions">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Trả lời đúng</span>
                            <span class="stat-detail-value" data-quiz-metric="total_correct">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Độ chính xác</span>
                            <span class="stat-detail-value" data-quiz-metric="accuracy">--</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Chuỗi đúng TB</span>
                            <span class="stat-detail-value" data-quiz-metric="avg_streak">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Chuỗi đúng tốt nhất</span>
                            <span class="stat-detail-value" data-quiz-metric="best_streak">0</span>
                        </div>
                    </div>
                    <div class="stat-detail-list-container" id="quiz-correct-container" style="display: none;">
                        <h4 class="stat-detail-subtitle" id="quiz-detail-subtitle">Danh sách câu hỏi</h4>
                        <ul class="stat-detail-list" id="quiz-correct-list"></ul>
                    </div>
                </div>
                <div class="stat-chart-section">
                    <div class="stat-chart-header">
                        <span class="stat-chart-title">Hoạt động gần đây</span>
                        <select id="quiz-chart-range" class="stat-chart-range">
                            <option value="7d">7 ngày</option>
                            <option value="30d" selected>30 ngày</option>
                            <option value="90d">90 ngày</option>
                            <option value="365d">365 ngày</option>
                            <option value="all">Toàn bộ</option>
                        </select>
                    </div>
                    <div class="stat-chart-body">
                        <div class="loader-container" id="quiz-chart-loader" style="display: none;">
                            <div class="loader"></div>
                        </div>
                        <p class="stat-chart-empty" id="quiz-chart-empty" style="display: none;">Chọn một bộ để xem hoạt
                            động.</p>
                        <canvas id="quiz-activity-chart" aria-label="Biểu đồ hoạt động trắc nghiệm"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-column course-stats-column">
            <div class="stats-section">
                <h2 class="section-title">Tổng quan Khoá học</h2>
                <div class="stat-cards-grid">
                    <div class="stat-card" role="button" tabindex="0" data-type="course" data-category="completed"
                        data-container-id="all" data-container-title="Tất cả Khoá học" data-title="Bài học hoàn thành">
                        <div class="stat-card-icon learned" style="background-color: #d1fae5; color: #059669;"><i
                                class="fas fa-book-reader"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.lessons_completed_count }}</span>
                            <span class="stat-card-label">Bài học hoàn thành</span>
                        </div>
                    </div>
                    <div class="stat-card" role="button" tabindex="0" data-type="course" data-category="in_progress"
                        data-container-id="all" data-container-title="Tất cả Khoá học" data-title="Khoá học đã bắt đầu">
                        <div class="stat-card-icon sets" style="background-color: #eef2ff; color: #4338ca;"><i
                                class="fas fa-graduation-cap"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.courses_started_count }}</span>
                            <span class="stat-card-label">Khoá học đã bắt đầu</span>
                        </div>
                    </div>
                </div>
                <div class="stat-detail-section">
                    <div class="stat-detail-header">
                        <label for="course-set-select">Chi tiết theo khoá học</label>
                        <select id="course-set-select" class="stat-detail-select"
                            data-has-options="{{ 'true' if course_sets else 'false' }}" {% if not course_sets
                            %}disabled{% endif %}>
                            {% if course_sets %}
                            {% for course_set in course_sets %}
                            <option value="{{ course_set.id }}" {% if loop.first %}selected{% endif %}>{{
                                course_set.title }}</option>
                            {% endfor %}
                            {% else %}
                            <option value="">Chưa có khoá học nào</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="loader-container" id="course-detail-loader" style="display: none;">
                        <div class="loader"></div>
                    </div>
                    <p class="empty-message" id="course-detail-empty"
                        style="display: {{ 'none' if course_sets else 'block' }};">Bạn chưa bắt đầu khoá học nào.</p>
                    <div class="stat-detail-grid" id="course-detail-metrics" style="display: none;">
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Tổng số bài học</span>
                            <span class="stat-detail-value" data-course-metric="total_lessons">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Đã mở</span>
                            <span class="stat-detail-value" data-course-metric="lessons_started">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Hoàn thành</span>
                            <span class="stat-detail-value" data-course-metric="lessons_completed">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Hoàn thành trung bình</span>
                            <span class="stat-detail-value" data-course-metric="avg_completion">--</span>
                        </div>
                    </div>
                    <p class="stat-detail-note" id="course-detail-note" style="display: none;">Hoạt động gần nhất: <span
                            data-course-metric="last_activity">--</span></p>
                    <div class="stat-detail-list-container" id="course-recent-container" style="display: none;">
                        <h4 class="stat-detail-subtitle" id="course-detail-subtitle">Bài học</h4>
                        <ul class="stat-detail-list" id="course-recent-list"></ul>
                    </div>
                </div>
                <div class="stat-chart-section">
                    <div class="stat-chart-header">
                        <span class="stat-chart-title">Hoạt động gần đây</span>
                        <select id="course-chart-range" class="stat-chart-range">
                            <option value="7d">7 ngày</option>
                            <option value="30d" selected>30 ngày</option>
                            <option value="90d">90 ngày</option>
                            <option value="365d">365 ngày</option>
                            <option value="all">Toàn bộ</option>
                        </select>
                    </div>
                    <div class="stat-chart-body">
                        <div class="loader-container" id="course-chart-loader" style="display: none;">
                            <div class="loader"></div>
                        </div>
                        <p class="stat-chart-empty" id="course-chart-empty" style="display: none;">Chọn một khoá học để
                            xem hoạt động.</p>
                        <canvas id="course-activity-chart" aria-label="Biểu đồ hoạt động khoá học"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="stats-modal" id="stats-modal" aria-hidden="true">
    <div class="stats-modal-overlay" data-modal-action="close"></div>
    <div class="stats-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="stats-modal-title">
        <button type="button" class="stats-modal-close" data-modal-action="close" aria-label="Đóng">&times;</button>
        <div class="stats-modal-header">
            <h3 class="stats-modal-title" id="stats-modal-title">Chi tiết thống kê</h3>
            <p class="stats-modal-summary" id="stats-modal-summary">--</p>
        </div>
        <div class="stats-modal-tabs" id="stats-modal-tabs"></div>
        <div class="stats-modal-body">
            <div class="loader-container" id="stats-modal-loader" style="display: none;">
                <div class="loader"></div>
            </div>
            <p class="empty-message" id="stats-modal-empty" style="display: none;">Không có dữ liệu phù hợp.</p>
            <ul class="stat-detail-list" id="stats-modal-list"></ul>
        </div>
        <div class="stats-modal-pagination" id="stats-modal-pagination" style="display: none;">
            <button type="button" class="stats-modal-page-btn" data-modal-page="prev">Trước</button>
            <span class="stats-modal-page-label" id="stats-modal-page-label">Trang 1 / 1</span>
            <button type="button" class="stats-modal-page-btn" data-modal-page="next">Sau</button>
        </div>
    </div>
</div>

<template id="leaderboard-item-template">
    <li class="leaderboard-item">
        <span class="rank"></span>
        <span class="username"></span>
        <span class="score-value"></span>
    </li>
</template>

{# --- DESKTOP JS LOGIC --- #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Logic JS cho Desktop (đã có sẵn từ file gốc)
        // Để tránh lỗi trùng lặp biến, chúng ta sẽ bọc logic này trong một function scope hoặc giữ nguyên nếu nó hoạt động độc lập.
        // Tuy nhiên, vì cấu trúc file được include, JS sẽ chạy trong cùng context.
        // Tốt nhất là trích xuất logic JS ra file riêng hoặc đảm bảo không conflict.
        // Hiện tại, tôi sẽ copy lại logic cũ vào đây để đảm bảo Desktop chạy đúng.

        const timeframeTabs = document.querySelector('.timeframe-tabs');
        const sortBySelect = document.getElementById('sort_by');
        // ... (Rest of the JS logic from original file) ...
        // Do giới hạn độ dài, tôi sẽ giả định logic JS được load từ block scripts chung hoặc file JS riêng.
        // Tuy nhiên, file statistics.html gốc có block scripts khá dài.
        // Để an toàn, tôi sẽ copy logic JS quan trọng vào đây hoặc yêu cầu load từ file static.

        // Thực tế: Logic JS của Statistics khá phức tạp và gắn liền với DOM.
        // Tốt nhất là giữ nguyên logic JS trong statistics.html (phần scripts) và chỉ thay đổi HTML.
        // File _statistics_desktop.html này chỉ chứa HTML Structure.
    });
</script>