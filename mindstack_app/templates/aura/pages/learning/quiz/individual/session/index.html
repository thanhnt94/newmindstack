{# =============================== #}
{# File: mindstack_app/modules/learning/quiz/individual/templates/quiz/individual/quiz_session.html #}
{# Phi√™n b·∫£n: 4.0 (App-like UI Overhaul) #}
{# =============================== #}

{% set _v = template_version %}
{% extends _v ~ '/base.html' %}

{% block title %}L√†m b√†i Quiz{% endblock %}

{% block head %}
{{ super() }}
{% include _v ~ '/includes/assets/_markdown_assets.html' %}
<style>
    /* === CORE LAYOUT === */
    body {
        background-color: #f8fafc;
        font-family: 'Inter', sans-serif;
    }

    /* Hide Default Site Elements on Mobile to fake an "App" */
    @media (max-width: 1023px) {

        body>header,
        nav.navbar,
        footer,
        .site-footer,
        .back-to-top {
            display: none !important;
        }

        body {
            padding-top: 115px !important;
            /* Header + Tabs */
            padding-bottom: 80px;
            /* Bottom Bar */
        }

        .container {
            padding-left: 12px;
            padding-right: 12px;
            max-width: 100%;
        }
    }

    /* === UI COMPONENTS === */
    .cm-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }

    .cm-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f5f9;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .cm-card-body {
        padding: 1.25rem;
        flex: 1;
        position: relative;
    }

    .qb-question-text {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.5;
        margin-bottom: 1rem;
    }

    .qb-question-media img {
        width: 100%;
        max-height: 320px;
        object-fit: contain;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        background: white;
        margin-bottom: 1rem;
    }

    /* Options */
    .qb-options-grid {
        display: grid;
        gap: 0.75rem;
    }

    .qb-option-label {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.15s ease;
        background: white;
    }

    .qb-option-label:hover {
        border-color: #94a3b8;
        background: #f8fafc;
    }

    .qb-option-label.selected {
        border-color: #3b82f6;
        background: #eff6ff;
        ring: 1px solid #3b82f6;
    }

    .qb-option-label.correct {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .qb-option-label.incorrect {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .qb-option-label.disabled {
        pointer-events: none;
        opacity: 0.7;
    }

    .qb-option-letter-circle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: #f1f5f9;
        color: #1e293b;
        font-weight: 700;
        font-size: 0.9rem;
        border: 1px solid #e2e8f0;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .qb-option-label.selected .qb-option-letter-circle {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .qb-option-label.correct .qb-option-letter-circle {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    .qb-option-label.incorrect .qb-option-letter-circle {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    /* Buttons */
    .cm-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
    }

    .cm-btn-primary {
        background: #2563eb;
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .cm-btn-primary:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
    }

    .cm-btn-primary:disabled {
        background: #94a3b8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .cm-btn-danger {
        background: white;
        color: #ef4444;
        border: 1px solid #fecaca;
    }

    /* === MOBILE SPECIFIC === */
    .qb-mobile-sticky-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .qb-mobile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px 4px 16px;
    }

    .qb-mobile-tabs-container {
        padding: 0 16px 10px 16px;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .qb-mobile-tabs {
        display: flex;
        background: #f1f5f9;
        border-radius: 10px;
        padding: 3px;
    }

    .qb-mobile-tab-item {
        flex: 1;
        text-align: center;
        padding: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #64748b;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .qb-mobile-tab-item.active {
        background: white;
        color: #2563eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .qb-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 12px 16px;
        border-top: 1px solid #e2e8f0;
        z-index: 60;
        display: flex;
        gap: 10px;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    .qb-bottom-bar .cm-btn {
        flex: 1;
        border-radius: 12px;
        padding: 14px;
        font-size: 1rem;
        margin: 0;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .qb-mobile-chat-toggle {
        position: relative;
        background: #eff6ff;
        color: #3b82f6;
        border: 1px solid #dbeafe;
        border-radius: 12px;
        width: 3.25rem;
        height: 3.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    /* === HUB MODAL === */
    .qb-modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .qb-modal-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 101;
        background: white;
        height: 85vh;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
    }

    .qb-modal-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .qb-modal-overlay.open .qb-modal-container {
        transform: translateY(0);
    }

    .qb-hub-header {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .qb-hub-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
    }

    .qb-hub-tab-item {
        flex: 1;
        text-align: center;
        padding: 12px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .qb-hub-tab-item.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
        background: white;
    }

    .qb-hub-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: white;
    }

    .qb-hub-pane {
        display: none;
    }

    .qb-hub-pane.active {
        display: block;
    }

    /* Desktop Adjustments */
    @media (min-width: 1024px) {

        .qb-mobile-sticky-wrapper,
        .qb-bottom-bar {
            display: none;
        }

        .qb-layout-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }
    }

    @media (max-width: 1023px) {
        .qb-desktop-header {
            display: none !important;
        }

        .qb-layout-grid {
            display: block;
        }

        .qb-tab-pane {
            display: none;
        }

        .qb-tab-pane.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Hide desktop-specific side panels on mobile, they will be in tabs/modals */
        .desktop-only-panel {
            display: none !important;
        }
    }

    .hidden {
        display: none !important;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
{# === MOBILE APP HEADER === #}
<div class="qb-mobile-sticky-wrapper">
    <div class="qb-mobile-header">
        <div class="flex items-center gap-3">
            <div class="flex flex-col">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Ti·∫øn ƒë·ªô</span>
                <span id="mobile-progress-display" class="text-lg font-black text-slate-800 leading-none">--/--</span>
            </div>
            <div class="h-6 w-px bg-slate-200"></div>
            <div class="flex flex-col">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">ƒê√∫ng</span>
                <span id="mobile-score-display"
                    class="text-lg font-black text-emerald-600 leading-none font-mono">0</span>
            </div>
        </div>

        <div class="flex gap-2">
            <a href="{{ url_for('dashboard.dashboard') }}"
                class="w-9 h-9 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200"
                title="V·ªÅ trang ch·ªß"><i class="fas fa-home"></i></a>
            <button id="mobile-exit-btn" onclick="endQuizSession()"
                class="w-9 h-9 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200"><i
                    class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </div>

    {# === MOBILE TABS === #}
    <div class="qb-mobile-tabs-container">
        <div class="qb-mobile-tabs">
            <div class="qb-mobile-tab-item active" data-tab="game">C√¢u h·ªèi</div>
            <div class="qb-mobile-tab-item" data-tab="stats">Th·ªëng k√™</div>
        </div>
    </div>
</div>

<div class="container mx-auto px-2 py-6 max-w-7xl">

    {# === DESKTOP HEADER === #}
    <header
        class="qb-desktop-header flex items-center justify-between mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">L√†m b√†i Quiz</h1>
            <p class="text-sm text-slate-500">Ch·∫ø ƒë·ªô c√° nh√¢n</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('dashboard.dashboard') }}"
                class="cm-btn bg-slate-100 text-slate-600 hover:bg-slate-200"><i class="fas fa-home"></i> Trang ch·ªß</a>
            <button id="desktop-exit-btn" onclick="endQuizSession()" class="cm-btn cm-btn-danger"><i
                    class="fa-solid fa-right-from-bracket"></i>
                K·∫øt th√∫c</button>
        </div>
    </header>

    <div class="qb-layout-grid">

        {# --- LEFT COL: GAMEPLAY --- #}
        <div id="tab-pane-game" class="qb-tab-pane active space-y-6">

            <div class="cm-card">
                <div class="cm-card-header">
                    <span class="font-bold text-slate-700 flex items-center gap-2"><i
                            class="fa-solid fa-circle-question text-blue-500"></i> <span id="question-header-text">C√¢u
                            h·ªèi --</span></span>
                </div>
                <div class="cm-card-body relative">
                    <!-- Loading State -->
                    <div id="quiz-loading" class="flex flex-col items-center justify-center py-12 text-blue-500">
                        <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                        <p>ƒêang t·∫£i c√¢u h·ªèi...</p>
                    </div>

                    <!-- Question Content -->
                    <div id="quiz-content" class="hidden">
                        <h2 id="question-text" class="qb-question-text">--</h2>
                        <div id="question-media" class="qb-question-media hidden"></div>

                        <div id="question-options" class="qb-options-grid mt-4">
                            <!-- Options injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback / Result Panel (Desktop: Inline, Mobile: Hub/Inline) -->
            <div id="result-panel" class="cm-card border-l-4 border-l-blue-500 hidden">
                <div class="cm-card-body">
                    <div class="flex items-start gap-4">
                        <div id="feedback-icon" class="text-3xl">üí°</div>
                        <div class="flex-1">
                            <h3 id="feedback-title" class="text-lg font-bold text-slate-900">K·∫øt qu·∫£</h3>
                            <div class="flex gap-4 text-sm mt-2">
                                <div class="bg-slate-50 px-3 py-2 rounded border border-slate-100">
                                    <span class="block text-xs text-slate-400 uppercase">ƒê√°p √°n ƒë√∫ng</span>
                                    <span id="feedback-correct-answer" class="font-bold text-emerald-600">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop Only: Explanation & AI Preview -->
            <div class="desktop-only-panel space-y-4 hidden lg:block">
                <div id="desktop-explanation" class="cm-card hidden">
                    <div class="cm-card-header"><span class="font-bold">Gi·∫£i th√≠ch</span></div>
                    <div class="cm-card-body">
                        <div id="desktop-explanation-content" class="markdown-body text-sm"></div>
                    </div>
                </div>
            </div>

        </div>

        {# --- RIGHT COL: STATS (Desktop) / TAB (Mobile) --- #}
        <div id="tab-pane-stats" class="qb-tab-pane space-y-6">
            <div class="cm-card">
                <div class="cm-card-header">
                    <span class="font-bold text-emerald-600"><i class="fa-solid fa-chart-pie"></i> Th·ªëng k√™ phi√™n</span>
                </div>
                <div class="cm-card-body">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <div class="text-xs text-slate-500 uppercase">ƒê√£ l√†m</div>
                            <div id="stat-total" class="text-2xl font-bold text-slate-800">0</div>
                        </div>
                        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                            <div class="text-xs text-emerald-600 uppercase">Ch√≠nh x√°c</div>
                            <div id="stat-accuracy" class="text-2xl font-bold text-emerald-700">0%</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex justify-between text-xs text-slate-500 mb-1">
                            <span>Ti·∫øn ƒë·ªô</span>
                            <span id="stat-progress-text">0/0</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5">
                            <div id="stat-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cm-card desktop-only-panel">
                <div class="cm-card-header">
                    <span class="font-bold text-slate-700">C√¥ng c·ª•</span>
                </div>
                <div class="cm-card-body flex flex-col gap-2">
                    <button id="open-hub-desktop-btn" class="cm-btn cm-btn-primary w-full hidden"><i
                            class="fa-solid fa-book-open"></i> Xem chi ti·∫øt & Ghi ch√∫</button>
                    <a href="#" id="desktop-question-stats-link" target="_blank"
                        class="cm-btn w-full border border-slate-200 hover:bg-slate-50 text-center block text-slate-700 no-underline"><i
                            class="fa-solid fa-chart-pie"></i> Th·ªëng k√™ t·ª´</a>
                    <button class="cm-btn w-full border border-slate-200 hover:bg-slate-50"
                        onclick="window.location.reload()"><i class="fa-solid fa-rotate"></i> T·∫£i l·∫°i c√¢u h·ªèi</button>
                </div>
            </div>
        </div>

    </div>
</div>

{# === MOBILE BOTTOM BAR === #}
<div class="qb-bottom-bar">
    <button type="button" id="open-hub-btn"
        class="qb-mobile-chat-toggle bg-indigo-50 text-indigo-600 border-indigo-200 hidden" aria-label="M·ªü chi ti·∫øt">
        <i class="fa-solid fa-lightbulb text-xl"></i>
    </button>

    <button type="button" id="mobile-action-btn" class="cm-btn cm-btn-primary w-full shadow-lg" disabled>
        <i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n
    </button>
</div>

{# === HUB MODAL (Explanation, AI, Notes) === #}
<div id="explanation-hub-modal" class="qb-modal-overlay">
    <div class="qb-modal-container">
        <div class="qb-hub-header">
            <h3 class="font-bold text-slate-800 text-lg">Chi ti·∫øt & H·ªçc t·∫≠p</h3>
            <button id="close-hub-btn"
                class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="qb-hub-tabs">
            <div class="qb-hub-tab-item active" data-target="hub-expl">üìñ Gi·∫£i th√≠ch</div>
            <div class="qb-hub-tab-item" data-target="hub-ai">ü§ñ AI Coach</div>
            <div class="qb-hub-tab-item" data-target="hub-note">üìù Ghi ch√∫</div>
        </div>
        <div class="qb-hub-content">
            <!-- Expl Tab -->
            <div id="hub-expl" class="qb-hub-pane active">
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-slate-700 leading-relaxed">
                    <h4 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-circle-info"></i> Gi·∫£i th√≠ch:</h4>
                    <div id="hub-explanation-text">Ch∆∞a c√≥ gi·∫£i th√≠ch.</div>
                </div>
            </div>
            <!-- AI Tab -->
            <div id="hub-ai" class="qb-hub-pane">
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-indigo-700 font-bold"><i class="fa-solid fa-robot"></i>
                            <span>AI Coach</span>
                        </div>
                        <button id="ai-generate-btn"
                            class="text-xs bg-white text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-200 font-semibold shadow-sm"><i
                                class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o m·ªõi</button>
                    </div>
                    <div id="hub-ai-content" class="text-sm text-slate-700 leading-relaxed min-h-[100px] markdown-body">
                        Nh·∫•n n√∫t ƒë·ªÉ
                        y√™u c·∫ßu AI Coach ph√¢n t√≠ch...</div>
                </div>
            </div>
            <!-- Note Tab -->
            <div id="hub-note" class="qb-hub-pane">
                <textarea id="hub-note-input"
                    class="w-full p-3 rounded-xl border border-slate-200 text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition"
                    rows="8" placeholder="Ghi ch√∫ c·ªßa b·∫°n..."></textarea>
                <button id="hub-note-save"
                    class="mt-2 w-full py-2 rounded-lg bg-blue-100 text-blue-700 font-semibold text-sm hover:bg-blue-200">L∆∞u
                    ghi ch√∫</button>
            </div>
        </div>
    </div>
</div>

<!-- Exit Confirmation Modal based on Tailwind -->
<div id="exit-confirm-modal"
    class="fixed inset-0 bg-slate-900/40 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300"
    style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform scale-95 transition-transform duration-300"
        id="exit-modal-panel">
        <div class="text-center">
            <div
                class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl ring-4 ring-rose-50">
                <i class="fa-solid fa-right-from-bracket"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">K·∫øt th√∫c phi√™n h·ªçc?</h3>
            <p class="text-slate-500 text-sm mb-6 leading-relaxed">K·∫øt qu·∫£ hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠. B·∫°n c√≥ mu·ªën
                xem th·ªëng k√™ ngay kh√¥ng?</p>
            <div class="flex gap-3">
                <button onclick="closeExitModal()"
                    class="flex-1 py-2.5 rounded-xl font-bold text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 transition-colors">
                    ·ªû l·∫°i
                </button>
                <button onclick="confirmExit()"
                    class="flex-1 py-2.5 rounded-xl font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-lg shadow-rose-500/30 transition-all">
                    K·∫øt th√∫c
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function () {
        // URLs & Meta
        const getQuestionBatchUrl = "{{ url_for('learning.quiz_learning.get_question_batch') }}";
        const submitAnswerBatchUrl = "{{ url_for('learning.quiz_learning.submit_answer_batch') }}";
        const endSessionUrl = "{{ url_for('learning.quiz_learning.end_session') }}";
        const getAiResponseUrl = "{{ url_for('AI.get_ai_response') }}";
        const saveNoteUrlTemplate = "{{ url_for('notes.save_note', reference_type='item', reference_id=0) }}";
        const quizDashboardUrl = "{{ url_for('learning.quiz_learning.dashboard') }}";
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

        // Modal Logic
        const exitModal = document.getElementById('exit-confirm-modal');
        const exitPanel = document.getElementById('exit-modal-panel');

        window.endQuizSession = function () {
            if (exitModal) {
                exitModal.style.display = 'flex';
                // Small delay to allow display:flex to apply before adding opacity class for animation
                setTimeout(() => {
                    exitModal.classList.remove('opacity-0', 'hidden');
                    exitPanel.classList.remove('scale-95');
                    exitPanel.classList.add('scale-100');
                }, 10);
            }
        };

        window.closeExitModal = function () {
            if (exitModal) {
                exitModal.classList.add('opacity-0');
                exitPanel.classList.remove('scale-100');
                exitPanel.classList.add('scale-95');
                setTimeout(() => {
                    exitModal.classList.add('hidden');
                    exitModal.style.display = 'none';
                }, 300);
            }
        };

        window.confirmExit = function () {
            const btn = document.querySelector('button[onclick="confirmExit()"]');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> X·ª≠ l√Ω...';
                btn.disabled = true;
            }

            fetch(endSessionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.session_id) {
                        window.location.href = `/learn/session/${data.session_id}/summary`;
                    } else {
                        window.location.href = "{{ url_for('learning.manage_sessions') }}";
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.");
                    if (btn) {
                        btn.innerHTML = 'K·∫øt th√∫c';
                        btn.disabled = false;
                    }
                });
        };

        // State
        let currentBatch = [];
        let currentIndex = 0; // Current question index within batch
        let userAnswers = {};
        let sessionStats = { total: 0, correct: 0, total_questions: 0 };
        let currentQuestion = null;
        let dbSessionId = null;

        // Elements
        const dom = {
            loading: document.getElementById('quiz-loading'),
            content: document.getElementById('quiz-content'),
            qHeader: document.getElementById('question-header-text'),
            qText: document.getElementById('question-text'),
            qMedia: document.getElementById('question-media'),
            qOptions: document.getElementById('question-options'),
            mobileActionBtn: document.getElementById('mobile-action-btn'),
            resultPanel: document.getElementById('result-panel'),

            // Stats
            mobileProgress: document.getElementById('mobile-progress-display'),
            mobileScore: document.getElementById('mobile-score-display'),
            statTotal: document.getElementById('stat-total'),
            statAccuracy: document.getElementById('stat-accuracy'),
            statProgressText: document.getElementById('stat-progress-text'),
            statProgressBar: document.getElementById('stat-progress-bar'),

            // Hub
            hubModal: document.getElementById('explanation-hub-modal'),
            openHubBtn: document.getElementById('open-hub-btn'),
            openHubDesktopBtn: document.getElementById('open-hub-desktop-btn'),
            closeHubBtn: document.getElementById('close-hub-btn'),
            hubExplText: document.getElementById('hub-explanation-text'),
            hubAiContent: document.getElementById('hub-ai-content'),
            aiGenerateBtn: document.getElementById('ai-generate-btn'),
            hubNoteInput: document.getElementById('hub-note-input'),
            hubNoteSave: document.getElementById('hub-note-save'),
        };

        // --- Core Logic ---
        async function loadQuestionBatch() {
            try {
                showLoading(true);

                const res = await fetch(getQuestionBatchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });

                if (!res.ok) {
                    if (res.status === 404) {
                        // End session logic
                        const data = await res.json();
                        if (data.session_id) {
                            window.location.href = `/learn/session/${data.session_id}/summary`;
                        } else {
                            alert("Ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi!");
                            window.location.href = quizDashboardUrl;
                        }
                        return;
                    }
                    throw new Error('Load failed');
                }

                const data = await res.json();
                currentBatch = data.items || [];
                currentIndex = 0;

                // Init Session Stats
                sessionStats.total_questions = data.total_question_groups_in_session || data.total_items_in_session || 0;
                sessionStats.total = data.session_total_answered || 0;
                sessionStats.correct = data.session_correct_answers || 0;
                updateStatsUI();

                if (currentBatch.length > 0) {
                    renderQuestion(currentBatch[currentIndex]);
                } else {
                    finishSession();
                }
            } catch (e) {
                console.error(e);
                alert('L·ªói t·∫£i c√¢u h·ªèi. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                showLoading(false);
            }
        }

        function renderQuestion(q) {
            currentQuestion = q;
            const qNum = (sessionStats.total + currentIndex + 1);
            dom.qHeader.textContent = `C√¢u h·ªèi ${qNum}`;
            dom.qText.innerHTML = q.content.question;

            // Media
            dom.qMedia.innerHTML = '';
            dom.qMedia.classList.add('hidden');
            if (q.content.question_image_file) {
                dom.qMedia.innerHTML += `<img src="${q.content.question_image_file}">`;
                dom.qMedia.classList.remove('hidden');
            }

            // Options
            dom.qOptions.innerHTML = Object.entries(q.content.options || {}).map(([key, val]) => `
            <div class="qb-option-label" data-key="${key}">
                <span class="qb-option-letter-circle">${key}</span>
                <span class="text-slate-800 font-medium text-lg leading-tight mt-1">${val}</span>
            </div>
        `).join('');

            // Reset UI
            dom.resultPanel.classList.add('hidden');
            if (dom.openHubBtn) {
                dom.openHubBtn.classList.add('hidden');
                dom.openHubBtn.style.display = 'none';
            }
            if (dom.openHubDesktopBtn) {
                dom.openHubDesktopBtn.classList.add('hidden');
                dom.openHubDesktopBtn.style.display = 'none';
            }
            dom.mobileActionBtn.disabled = true;
            dom.mobileActionBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n';
            dom.mobileActionBtn.dataset.action = 'submit';

            // Add listeners
            dom.qOptions.querySelectorAll('.qb-option-label').forEach(el => {
                el.addEventListener('click', () => selectOption(el.dataset.key));
            });

            // Reset Hub Content
            dom.hubExplText.textContent = "Ch∆∞a c√≥ gi·∫£i th√≠ch.";
            dom.hubAiContent.textContent = "Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...";
            dom.hubNoteInput.value = q.note_content || "";

            // Update Stats Links
            const statsUrlTemplate = "{{ url_for('learning.vocabulary.item_stats_page', item_id=0) }}";
            const statsUrl = statsUrlTemplate.replace('0', q.item_id || q.id);
            const mStats = document.getElementById('mobile-question-stats-link');
            const dStats = document.getElementById('desktop-question-stats-link');
            if (mStats) mStats.href = statsUrl;
            if (dStats) dStats.href = statsUrl;

            // [NEW] Update Marker UI
            const markers = q.markers || [];
            updateQuizMarkerUI(markers);
        }

        // --- Marker Logic ---
        function updateQuizMarkerUI(markers) {
            // Reset state
            const buttons = document.querySelectorAll('.js-quiz-marker-toggle');
            buttons.forEach(btn => {
                btn.innerHTML = '<i class="far fa-bookmark"></i>';
                btn.className = 'text-slate-400 hover:text-blue-500 transition text-lg js-quiz-marker-toggle'; // Default style
            });

            // Update based on markers
            const markerMap = {
                'difficult': { icon: '<i class="fas fa-fire"></i>', class: 'text-orange-500' },
                'ignored': { icon: '<i class="fas fa-eye-slash"></i>', class: 'text-slate-500' },
                'favorite': { icon: '<i class="fas fa-heart"></i>', class: 'text-rose-500' }
            };

            // Priority: Favorite > Difficult > Ignored
            let activeType = null;
            if (markers.includes('favorite')) activeType = 'favorite';
            else if (markers.includes('difficult')) activeType = 'difficult';
            else if (markers.includes('ignored')) activeType = 'ignored';

            if (activeType) {
                const style = markerMap[activeType];
                buttons.forEach(btn => {
                    btn.innerHTML = style.icon;
                    btn.className = `${style.class} transition text-lg js-quiz-marker-toggle`;
                });
            }
        }

        function toggleQuizMarker(markerType) {
            if (!currentQuestion) return;
            const itemId = currentQuestion.item_id;

            // Close dropdowns
            document.querySelectorAll('.marker-dropdown').forEach(d => d.classList.add('hidden'));

            fetch('/api/v3/learning/markers/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ item_id: itemId, marker_type: markerType })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log(`Marker ${markerType} toggled: ${data.is_marked}`);
                        // Optimistic update logic could be simpler, but let's re-fetch or manual update
                        // Manual update currentQuestion markers
                        let markers = currentQuestion.markers || [];
                        if (data.is_marked) {
                            if (!markers.includes(markerType)) markers.push(markerType);
                            // Behave like toggle: some markers might be exclusive in UI but backend allows multiple?
                            // UI favors specific priority, so simple push is fine.
                        } else {
                            markers = markers.filter(m => m !== markerType);
                        }
                        currentQuestion.markers = markers;
                        updateQuizMarkerUI(markers);

                        // Show small toast/notify if needed
                    } else {
                        alert('L·ªói: ' + data.message);
                    }
                })
                .catch(err => console.error("Marker toggle error", err));
        }

        // Setup Marker Listeners
        document.addEventListener('click', function (e) {
            // Toggle Dropdown
            const toggleBtn = e.target.closest('.js-quiz-marker-toggle');
            if (toggleBtn) {
                e.stopPropagation();
                const container = toggleBtn.closest('.marker-dropdown-container');
                if (container) {
                    const dropdown = container.querySelector('.marker-dropdown');
                    // Hide all others
                    document.querySelectorAll('.marker-dropdown').forEach(d => {
                        if (d !== dropdown) d.classList.add('hidden');
                    });
                    if (dropdown) dropdown.classList.toggle('hidden');
                }
                return;
            }

            // Marker Actions
            const actionBtn = e.target.closest('button[class*="js-quiz-mark-"]');
            if (actionBtn) {
                e.stopPropagation();
                const type = actionBtn.dataset.type;
                if (type) toggleQuizMarker(type);
            }

            // Click outside
            if (!e.target.closest('.marker-dropdown-container')) {
                document.querySelectorAll('.marker-dropdown').forEach(d => d.classList.add('hidden'));
            }
        });

        function selectOption(key) {
            dom.qOptions.querySelectorAll('.qb-option-label').forEach(el => {
                if (el.dataset.key === key) el.classList.add('selected');
                else el.classList.remove('selected');
            });
            userAnswers[currentQuestion.item_id] = key;
            dom.mobileActionBtn.disabled = false;
            dom.mobileActionBtn.classList.add('cm-btn-primary');
        }

        async function submitAnswer() {
            const itemId = currentQuestion.item_id;
            const answer = userAnswers[itemId];
            if (!answer) return;

            dom.mobileActionBtn.disabled = true;
            dom.mobileActionBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ƒêang g·ª≠i...';

            try {
                const res = await fetch(submitAnswerBatchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ answers: [{ item_id: itemId, user_answer: answer }] })
                });
                const data = await res.json();
                const result = data.results[0];

                // Show Feedback
                showFeedback(result);

                // Update Stats
                sessionStats.total++;
                if (result.is_correct) sessionStats.correct++;
                updateStatsUI();

                // Setup Next Button
                dom.mobileActionBtn.disabled = false;
                dom.mobileActionBtn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> Ti·∫øp theo';
                dom.mobileActionBtn.dataset.action = 'next';

                // Show Hub Button
                if (dom.openHubBtn) {
                    dom.openHubBtn.classList.remove('hidden');
                    dom.openHubBtn.style.display = 'flex';
                }
                if (dom.openHubDesktopBtn) {
                    dom.openHubDesktopBtn.classList.remove('hidden');
                    dom.openHubDesktopBtn.style.display = 'flex';
                }

            } catch (e) {
                alert('L·ªói g·ª≠i ƒë√°p √°n.');
                dom.mobileActionBtn.disabled = false;
            }
        }

        function showFeedback(result) {
            // Highlight Options
            dom.qOptions.querySelectorAll('.qb-option-label').forEach(el => {
                el.classList.add('disabled');
                el.classList.remove('selected'); // Remove selection style to apply specific states
                if (el.dataset.key === result.correct_answer) el.classList.add('correct');
                if (el.dataset.key === userAnswers[result.item_id] && !result.is_correct) el.classList.add('incorrect');
            });

            // Show Panel
            dom.resultPanel.classList.remove('hidden');
            const icon = document.getElementById('feedback-icon');
            const title = document.getElementById('feedback-title');
            const ans = document.getElementById('feedback-correct-answer');

            if (result.is_correct) {
                icon.textContent = 'üéâ';
                title.textContent = 'Ch√≠nh x√°c!';
                title.className = 'text-lg font-bold text-emerald-600';
            } else {
                icon.textContent = 'ü§î';
                title.textContent = 'Sai r·ªìi';
                title.className = 'text-lg font-bold text-rose-600';
            }
            ans.textContent = result.correct_answer;

            // Populate Hub
            if (result.explanation) dom.hubExplText.innerHTML = result.explanation;
            if (currentQuestion.ai_explanation) dom.hubAiContent.innerHTML = currentQuestion.ai_explanation;

            // Show Desktop Explanation
            if (result.explanation) {
                const dtExpl = document.getElementById('desktop-explanation');
                const dtExplContent = document.getElementById('desktop-explanation-content');
                if (dtExpl && dtExplContent) {
                    dtExpl.classList.remove('hidden');
                    dtExplContent.innerHTML = result.explanation;
                }
            }
        }

        function nextQuestion() {
            // Clear previous state
            const dtExpl = document.getElementById('desktop-explanation');
            if (dtExpl) dtExpl.classList.add('hidden');

            currentIndex++;
            if (currentIndex < currentBatch.length) {
                renderQuestion(currentBatch[currentIndex]);
            } else {
                loadBatch(); // Load next batch
            }
        }

        function finishSession() {
            alert('ƒê√£ ho√†n th√†nh phi√™n h·ªçc!');
            window.location.href = quizDashboardUrl;
        }

        // --- Helpers ---
        function showLoading(show) {
            dom.loading.classList.toggle('hidden', !show);
            dom.content.classList.toggle('hidden', show);
        }

        function updateStatsUI() {
            const acc = sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0;
            dom.mobileScore.textContent = sessionStats.correct;
            dom.mobileProgress.textContent = `${sessionStats.total}/${sessionStats.total_questions}`;

            dom.statTotal.textContent = sessionStats.total;
            dom.statAccuracy.textContent = `${acc}%`;
            dom.statProgressText.textContent = `${sessionStats.total}/${sessionStats.total_questions}`;
            dom.statProgressBar.style.width = `${(sessionStats.total / sessionStats.total_questions) * 100}%`;
        }

        // --- AI & Notes ---
        dom.aiGenerateBtn.addEventListener('click', async () => {
            dom.aiGenerateBtn.disabled = true;
            dom.hubAiContent.textContent = "ƒêang t·∫°o...";
            dom.hubAiContent.classList.add('markdown-body'); // Add markdown-body class
            try {
                const res = await fetch(getAiResponseUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ item_id: currentQuestion.item_id, prompt_type: 'explanation' })
                });
                const data = await res.json();
                const content = data.html_content || data.response || data.explanation;
                if (window.renderMarkdown) {
                    dom.hubAiContent.innerHTML = window.renderMarkdown(content.trim());
                    dom.hubAiContent.style.whiteSpace = 'normal';
                } else {
                    dom.hubAiContent.textContent = content;
                }
                currentQuestion.ai_explanation = content;
            } catch (e) {
                dom.hubAiContent.textContent = "L·ªói khi g·ªçi AI.";
            }
            dom.aiGenerateBtn.disabled = false;
        });

        dom.hubNoteSave.addEventListener('click', async () => {
            const content = dom.hubNoteInput.value;
            try {
                await fetch(saveNoteUrlTemplate.replace('0', currentQuestion.item_id), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ content })
                });
                currentQuestion.note_content = content;
                alert('ƒê√£ l∆∞u ghi ch√∫.');
            } catch (e) {
                alert('L·ªói l∆∞u ghi ch√∫.');
            }
        });

        // --- Event Bindings ---
        dom.mobileActionBtn.addEventListener('click', () => {
            if (dom.mobileActionBtn.dataset.action === 'submit') submitAnswer();
            else nextQuestion();
        });

        // Mobile Tabs
        document.querySelectorAll('.qb-mobile-tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.qb-mobile-tab-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.qb-tab-pane').forEach(p => p.classList.remove('active', 'block')); // Remove block/active

                tab.classList.add('active');
                const pane = document.getElementById(`tab-pane-${tab.dataset.tab}`);
                pane.classList.add('active'); // CSS handles display:block via class
            });
        });

        // Hub Modal
        dom.openHubBtn.addEventListener('click', () => dom.hubModal.classList.add('open'));
        dom.closeHubBtn.addEventListener('click', () => dom.hubModal.classList.remove('open'));
        document.getElementById('open-hub-desktop-btn').addEventListener('click', () => dom.hubModal.classList.add('open')); // Desktop link

        // Hub Tabs
        document.querySelectorAll('.qb-hub-tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.qb-hub-tab-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.qb-hub-pane').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.add('active');
            });
        });

        // Exit
        const exitHandler = () => { window.endQuizSession(); };
        const mobileExitBtn = document.getElementById('mobile-exit-btn');
        if (mobileExitBtn) mobileExitBtn.addEventListener('click', exitHandler);

        const desktopExitBtn = document.getElementById('desktop-exit-btn');
        if (desktopExitBtn) desktopExitBtn.addEventListener('click', exitHandler);

        // Init
        loadQuestionBatch();

    };

    window.goToSummary = function () {
        // Quiz doesn't usually allow jumping to summary mid-session without ending it essentially.
        // But if we have a dbSessionId, we could.
        // However, typical flow is endSession -> Summary.
        // We just ensure endSession redirects correctly.
    };

    }) ();
</script>
{% endblock %}