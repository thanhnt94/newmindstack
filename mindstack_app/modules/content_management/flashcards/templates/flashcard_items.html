{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}
{% from 'includes/_pagination.html' import render_pagination %}

{% block title %}Thẻ trong bộ: {{ flashcard_set.title }}{% endblock %}

{% block head %}
    {{ super() }}
    {% include 'content_management/_shared_styles.html' %}
{% endblock %}

{% block content %}
<div class="cm-shell" data-accent="sky">
    <div class="cm-container space-y-6">
        <div class="cm-section-header">
            <div class="cm-heading-group">
                <a href="{{ url_for('content_management.content_dashboard', tab='flashcards') }}" class="cm-link text-sm">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span>Quay lại bảng điều khiển</span>
                </a>
                <span class="cm-eyebrow">Bộ thẻ ghi nhớ</span>
                <h1 class="cm-heading">{{ flashcard_set.title }}</h1>
                <p class="cm-subheading">{{ (flashcard_set.description or 'Quản lý cặp thẻ, sắp xếp thứ tự và cập nhật nội dung nhanh chóng.') | truncate(110, True, '…') }}</p>
                <div class="cm-chip-row">
                    <span class="cm-pill cm-pill--accent">
                        <i class="fa-solid fa-clone"></i>
                        {{ pagination.total }} thẻ
                    </span>
                    {% if can_edit %}
                    <span class="cm-pill cm-pill--neutral">
                        <i class="fa-solid fa-arrows-up-down"></i>
                        Kéo thả để sắp xếp
                    </span>
                    {% endif %}
                </div>
            </div>
            {% if can_edit %}
            <div class="cm-actions">
                <a href="{{ url_for('content_management.content_management_flashcards.add_flashcard_item', set_id=flashcard_set.container_id) }}"
                   data-modal-url="{{ url_for('content_management.content_management_flashcards.add_flashcard_item', set_id=flashcard_set.container_id) }}"
                   class="open-modal-btn cm-action cm-action--primary">
                    <i class="fas fa-plus-circle"></i>
                    <span>Thêm thẻ mới</span>
                </a>
                <a href="{{ url_for('content_management.content_management_flashcards.export_flashcard_set', set_id=flashcard_set.container_id) }}" class="cm-action cm-action--ghost">
                    <i class="fas fa-file-export"></i>
                    <span>Xuất gói ZIP</span>
                </a>
                <a href="{{ url_for('content_management.content_management_flashcards.manage_flashcard_excel', set_id=flashcard_set.container_id) }}" class="cm-action cm-action--ghost">
                    <i class="fas fa-table"></i>
                    <span>Cập nhật Excel</span>
                </a>
            </div>
            {% endif %}
        </div>

        <div class="cm-card cm-card--padded">
            {% set display_item_search_options = {
                'front': 'Mặt trước',
                'back': 'Mặt sau',
                'front_audio_content': 'Audio mặt trước (text)',
                'back_audio_content': 'Audio mặt sau (text)',
                'front_img': 'Ảnh mặt trước (URL)',
                'back_img': 'Ảnh mặt sau (URL)'
            } %}
            <div class="cm-search-header">
                <div class="cm-heading-group">
                    <h2 class="text-lg font-semibold text-slate-800">Tìm kiếm thẻ</h2>
                    <p class="cm-subheading text-sm">Kết hợp bộ lọc và tìm kiếm để chỉnh sửa nhanh các cặp thẻ quan trọng.</p>
                </div>
                <div class="w-full md:w-auto md:min-w-[320px]">
                    {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm thẻ...", set_id=flashcard_set.container_id, search_field=search_field, search_options=display_item_search_options) }}
                </div>
            </div>
        </div>

        {% if flashcard_items %}
        {% if can_edit %}
        <div class="cm-chip-row text-xs font-semibold">
            <span class="cm-pill cm-pill--accent">
                <i class="fa-solid fa-hand"></i>
                Kéo biểu tượng <i class="fa-solid fa-grip-lines"></i> để sắp xếp lại.
            </span>
            <div data-reorder-feedback class="hidden text-sm font-semibold"></div>
        </div>
        {% endif %}

        <div data-draggable-list
             data-can-edit="{{ 'true' if can_edit else 'false' }}"
             data-reorder-url="{{ url_for('content_management.content_management_flashcards.reorder_flashcard_items', set_id=flashcard_set.container_id) }}"
             data-start-order="{{ flashcard_items[0].order_in_container if flashcard_items else 1 }}"
             class="cm-grid cm-grid--three">
            {% for item in flashcard_items %}
            <article class="cm-collection-card"
                     data-draggable-item
                     data-item-id="{{ item.item_id }}"
                     data-current-order="{{ item.order_in_container }}"
                     draggable="true">
                <div class="flex items-start justify-between gap-4">
                    <div class="space-y-3">
                        <div class="cm-chip-row text-xs font-semibold">
                            <span class="cm-pill cm-pill--accent">
                                <i class="fa-solid fa-clone"></i>
                                Thẻ #<span data-order-label>{{ item.order_in_container }}</span>
                            </span>
                            <span class="cm-pill cm-pill--neutral">
                                <i class="fa-solid fa-id-card-clip"></i>
                                ID {{ item.item_id }}
                            </span>
                        </div>
                        <div class="space-y-2">
                            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">Mặt trước</h3>
                            <p class="text-base font-semibold text-slate-900">{{ item.content.front }}</p>
                            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">Mặt sau</h3>
                            <p class="text-sm text-slate-600">{{ item.content.back }}</p>
                        </div>
                    </div>
                    {% if can_edit %}
                    <button type="button" class="cm-icon-button" data-drag-handle title="Giữ và kéo để sắp xếp">
                        <i class="fa-solid fa-grip-lines"></i>
                    </button>
                    {% endif %}
                </div>

                <div class="mt-4 space-y-2 text-xs text-slate-500">
                    <div class="cm-chip-row">
                        {% if item.content.front_audio_content or item.content.front_audio_url %}
                        <span class="cm-tag">
                            <i class="fa-solid fa-volume-high text-slate-400"></i>
                            Audio mặt trước
                        </span>
                        {% endif %}
                        {% if item.content.back_audio_content or item.content.back_audio_url %}
                        <span class="cm-tag">
                            <i class="fa-solid fa-volume-high text-slate-400"></i>
                            Audio mặt sau
                        </span>
                        {% endif %}
                        {% if item.content.front_img or item.content.back_img %}
                        <span class="cm-tag">
                            <i class="fa-solid fa-image text-slate-400"></i>
                            Hình ảnh
                        </span>
                        {% endif %}
                    </div>
                    {% if item.ai_explanation %}
                    <p class="rounded-2xl bg-slate-50 px-4 py-2 text-[0.75rem] text-slate-500">
                        <span class="font-semibold text-slate-600">Giải thích AI:</span>
                        {{ item.ai_explanation }}
                    </p>
                    {% endif %}
                </div>

                <div class="cm-divider"></div>
                <div class="flex items-center justify-between">
                    <a href="{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=flashcard_set.container_id, item_id=item.item_id) }}"
                       data-modal-url="{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=flashcard_set.container_id, item_id=item.item_id) }}"
                       class="open-modal-btn cm-link">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <span>Mở trình chỉnh sửa</span>
                    </a>
                    {% if can_edit %}
                    <div class="cm-inline-actions">
                        <button type="button" data-modal-url="{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=flashcard_set.container_id, item_id=item.item_id) }}" class="open-modal-btn cm-icon-button" title="Chỉnh sửa">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <form action="{{ url_for('content_management.content_management_flashcards.delete_flashcard_item', set_id=flashcard_set.container_id, item_id=item.item_id) }}" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn xóa thẻ này?');">
                            <button type="submit" class="cm-icon-button" title="Xoá thẻ">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        <div class="pt-6">
            {{ render_pagination(pagination=pagination, search_query=search_query, set_id=flashcard_set.container_id, search_field=search_field) }}
        </div>

        {% else %}
        <div class="cm-empty">
            <span class="cm-empty-icon">
                <i class="fa-solid fa-clone"></i>
            </span>
            <p class="text-sm">Bộ thẻ này chưa có thẻ nào hoặc không tìm thấy kết quả phù hợp.</p>
            {% if can_edit %}
            <a href="{{ url_for('content_management.content_management_flashcards.add_flashcard_item', set_id=flashcard_set.container_id) }}"
               data-modal-url="{{ url_for('content_management.content_management_flashcards.add_flashcard_item', set_id=flashcard_set.container_id) }}"
               class="open-modal-btn cm-action cm-action--primary">
                <i class="fas fa-plus-circle"></i>
                <span>Thêm thẻ đầu tiên</span>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        (function() {
            window.addEventListener('content-management:refresh', function(event) {
                const detail = event?.detail || {};
                if (detail.scope === 'flashcard-item' && Number(detail.setId || detail.containerId) === {{ flashcard_set.container_id }}) {
                    window.location.reload();
                }
            });

            const list = document.querySelector('[data-draggable-list]');
            if (!list || list.dataset.canEdit !== 'true') {
                return;
            }

            const reorderUrl = list.dataset.reorderUrl;
            if (!reorderUrl) {
                return;
            }

            const csrfToken = '{{ csrf_token() }}';
            const startOrder = parseInt(list.dataset.startOrder || '1', 10);
            const feedback = document.querySelector('[data-reorder-feedback]');
            let draggedItem = null;
            let feedbackTimeout = null;

            const setFeedback = (type, message) => {
                if (!feedback) return;
                clearTimeout(feedbackTimeout);
                feedback.textContent = message;
                feedback.classList.remove('hidden', 'text-slate-500', 'text-emerald-600', 'text-rose-600');
                const colorClass = type === 'success' ? 'text-emerald-600' : type === 'error' ? 'text-rose-600' : 'text-slate-500';
                feedback.classList.add(colorClass);
                feedbackTimeout = setTimeout(() => {
                    feedback.classList.add('hidden');
                    feedback.classList.remove(colorClass);
                }, 3500);
            };

            list.querySelectorAll('[data-drag-handle]').forEach(handle => {
                handle.setAttribute('draggable', 'false');
            });

            const getDragAfterElement = (container, y) => {
                const elements = [...container.querySelectorAll('[data-draggable-item]:not(.dragging)')];
                return elements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset, element: child };
                    }
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
            };

            list.addEventListener('dragstart', event => {
                const item = event.target.closest('[data-draggable-item]');
                if (!item || !event.target.closest('[data-drag-handle]')) {
                    event.preventDefault();
                    return;
                }
                draggedItem = item;
                item.classList.add('dragging', 'opacity-60', 'ring-2', 'ring-sky-200');
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', item.dataset.itemId);
            });

            const finalizeDrag = () => {
                if (!draggedItem) {
                    return;
                }
                draggedItem.classList.remove('dragging', 'opacity-60', 'ring-2', 'ring-sky-200');
                draggedItem = null;
                persistOrder();
            };

            list.addEventListener('dragend', finalizeDrag);
            list.addEventListener('drop', event => {
                event.preventDefault();
                finalizeDrag();
            });

            list.addEventListener('dragover', event => {
                if (!draggedItem) {
                    return;
                }
                event.preventDefault();
                const afterElement = getDragAfterElement(list, event.clientY);
                if (!afterElement) {
                    list.appendChild(draggedItem);
                } else if (afterElement !== draggedItem) {
                    list.insertBefore(draggedItem, afterElement);
                }
            });

            const persistOrder = async () => {
                const items = Array.from(list.querySelectorAll('[data-draggable-item]'));
                if (items.length <= 1) {
                    return;
                }

                let hasChanges = false;
                const payload = [];
                const updates = [];

                items.forEach((item, index) => {
                    const newOrder = startOrder + index;
                    const currentOrder = Number(item.dataset.currentOrder);
                    if (currentOrder !== newOrder) {
                        hasChanges = true;
                    }
                    payload.push({ item_id: Number(item.dataset.itemId), order: newOrder });
                    updates.push({ item, newOrder });
                });

                if (!hasChanges) {
                    return;
                }

                updates.forEach(({ item, newOrder }) => {
                    const label = item.querySelector('[data-order-label]');
                    if (label) {
                        label.textContent = newOrder;
                    }
                    item.dataset.currentOrder = newOrder;
                });

                setFeedback('info', 'Đang lưu thứ tự mới...');

                try {
                    const response = await fetch(reorderUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                        },
                        body: JSON.stringify({ order: payload })
                    });

                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || 'Không thể cập nhật thứ tự.');
                    }
                    setFeedback('success', data.message || 'Đã cập nhật thứ tự!');
                } catch (error) {
                    console.error('Reorder error:', error);
                    setFeedback('error', error.message || 'Không thể cập nhật thứ tự.');
                }
            };
        })();
    </script>
{% endblock %}
