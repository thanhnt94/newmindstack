{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}
{% from 'includes/_pagination.html' import render_pagination %}

{% block title %}Bài học trong khoá học: {{ course.title }}{% endblock %}

{% block head %}
    {{ super() }}
    {% include 'content_management/_shared_styles.html' %}
{% endblock %}

{% block content %}
<div class="cm-shell" data-accent="indigo">
    <div class="cm-container space-y-6">
        <div class="cm-section-header">
            <div class="cm-heading-group">
                <a href="{{ url_for('content_management.content_dashboard', tab='courses') }}" class="cm-link text-sm">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span>Quay lại bảng điều khiển</span>
                </a>
                <span class="cm-eyebrow">Khoá học</span>
                <h1 class="cm-heading">{{ course.title }}</h1>
                <p class="cm-subheading">{{ (course.description or 'Sắp xếp các bài học, cập nhật nội dung và duy trì luồng học tập rõ ràng.') | truncate(110, True, '…') }}</p>
                <div class="cm-chip-row">
                    <span class="cm-pill cm-pill--accent">
                        <i class="fa-solid fa-layer-group"></i>
                        {{ pagination.total }} bài học
                    </span>
                    {% if can_edit %}
                    <span class="cm-pill cm-pill--neutral">
                        <i class="fa-solid fa-arrows-up-down"></i>
                        Kéo thả để sắp xếp
                    </span>
                    {% endif %}
                </div>
            </div>
            {% if can_edit %}
            <div class="cm-actions">
                <a href="{{ url_for('content_management.content_management_courses.add_lesson', set_id=course.container_id) }}" class="cm-action cm-action--primary">
                    <i class="fas fa-plus-circle"></i>
                    <span>Thêm bài học mới</span>
                </a>
            </div>
            {% endif %}
        </div>

        <div class="cm-card cm-card--padded">
            <div class="cm-search-header">
                <div class="cm-heading-group">
                    <h2 class="text-lg font-semibold text-slate-800">Tìm kiếm bài học</h2>
                    <p class="cm-subheading text-sm">Lọc theo tiêu đề để nhanh chóng chỉnh sửa đúng nội dung.</p>
                </div>
                <div class="w-full md:w-auto md:min-w-[320px]">
                    {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm bài học...", set_id=course.container_id) }}
                </div>
            </div>
        </div>

        {% if lessons %}
        {% if can_edit %}
        <div class="cm-chip-row text-xs font-semibold">
            <span class="cm-pill cm-pill--accent">
                <i class="fa-solid fa-hand"></i>
                Kéo biểu tượng <i class="fa-solid fa-grip-lines"></i> để sắp xếp.
            </span>
            <div data-reorder-feedback class="hidden text-sm font-semibold"></div>
        </div>
        {% endif %}

        <div data-draggable-list
             data-can-edit="{{ 'true' if can_edit else 'false' }}"
             data-reorder-url="{{ url_for('content_management.content_management_courses.reorder_lessons', set_id=course.container_id) }}"
             data-start-order="{{ lessons[0].order_in_container if lessons else 1 }}"
             class="cm-grid cm-grid--three">
            {% for lesson in lessons %}
            {% set preview_html = lesson.content.get('content_html') %}
            {% if not preview_html and lesson.content.get('bbcode_content') %}
                {% set preview_html = bbcode_to_html(lesson.content.get('bbcode_content')) %}
            {% endif %}
            <article class="cm-collection-card"
                     data-draggable-item
                     data-item-id="{{ lesson.item_id }}"
                     data-current-order="{{ lesson.order_in_container }}"
                     draggable="true">
                <div class="flex items-start justify-between gap-4">
                    <div class="space-y-3">
                        <div class="cm-chip-row text-xs font-semibold">
                            <span class="cm-pill cm-pill--accent">
                                <i class="fa-solid fa-graduation-cap"></i>
                                Bài học #<span data-order-label>{{ lesson.order_in_container }}</span>
                            </span>
                            <span class="cm-pill cm-pill--neutral">
                                <i class="fa-solid fa-id-card-clip"></i>
                                ID {{ lesson.item_id }}
                            </span>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900">{{ lesson.content.title }}</h3>
                        {% if preview_html %}
                        <p class="text-sm text-slate-500 line-clamp-4">{{ preview_html | striptags }}</p>
                        {% else %}
                        <p class="text-sm text-slate-400 italic">Bài học này chưa có nội dung hiển thị.</p>
                        {% endif %}
                    </div>
                    {% if can_edit %}
                    <button type="button" class="cm-icon-button" data-drag-handle title="Giữ và kéo để sắp xếp">
                        <i class="fa-solid fa-grip-lines"></i>
                    </button>
                    {% endif %}
                </div>

                <div class="mt-4 space-y-2 text-xs text-slate-500">
                    {% if lesson.content.estimated_time %}
                    <span class="cm-tag">
                        <i class="fa-regular fa-clock text-slate-400"></i>
                        Thời lượng ước tính: {{ lesson.content.estimated_time }} phút
                    </span>
                    {% endif %}
                    {% if lesson.content.lesson_audio_url or lesson.content.lesson_image_url %}
                    <div class="cm-chip-row">
                        {% if lesson.content.lesson_audio_url %}
                        <span class="cm-tag">
                            <i class="fa-solid fa-volume-high text-slate-400"></i>
                            Audio
                        </span>
                        {% endif %}
                        {% if lesson.content.lesson_image_url %}
                        <span class="cm-tag">
                            <i class="fa-solid fa-image text-slate-400"></i>
                            Hình ảnh
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if lesson.ai_explanation %}
                    <p class="rounded-2xl bg-slate-50 px-4 py-2 text-[0.75rem] text-slate-500">
                        <span class="font-semibold text-slate-600">Giải thích AI:</span>
                        {{ lesson.ai_explanation }}
                    </p>
                    {% endif %}
                </div>

                <div class="cm-divider"></div>
                <div class="flex items-center justify-between">
                    <a href="{{ url_for('content_management.content_management_courses.edit_lesson', set_id=course.container_id, item_id=lesson.item_id) }}" class="cm-link">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <span>Mở trình chỉnh sửa</span>
                    </a>
                    {% if can_edit %}
                    <div class="cm-inline-actions">
                        <a href="{{ url_for('content_management.content_management_courses.edit_lesson', set_id=course.container_id, item_id=lesson.item_id) }}" class="cm-icon-button" title="Chỉnh sửa">
                            <i class="fa-solid fa-pen"></i>
                        </a>
                        <form action="{{ url_for('content_management.content_management_courses.delete_lesson', set_id=course.container_id, item_id=lesson.item_id) }}" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn xóa bài học này?');">
                            <button type="submit" class="cm-icon-button" title="Xoá bài học">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        <div class="pt-6">
            {{ render_pagination(pagination=pagination, search_query=search_query, set_id=course.container_id) }}
        </div>

        {% else %}
        <div class="cm-empty">
            <span class="cm-empty-icon">
                <i class="fa-solid fa-graduation-cap"></i>
            </span>
            <p class="text-sm">Khoá học này chưa có bài học nào hoặc không tìm thấy kết quả phù hợp.</p>
            {% if can_edit %}
            <a href="{{ url_for('content_management.content_management_courses.add_lesson', set_id=course.container_id) }}" class="cm-action cm-action--primary">
                <i class="fas fa-plus-circle"></i>
                <span>Thêm bài học đầu tiên</span>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        (function() {
            const list = document.querySelector('[data-draggable-list]');
            if (!list || list.dataset.canEdit !== 'true') {
                return;
            }

            const reorderUrl = list.dataset.reorderUrl;
            if (!reorderUrl) {
                return;
            }

            const csrfToken = '{{ csrf_token() }}';
            const startOrder = parseInt(list.dataset.startOrder || '1', 10);
            const feedback = document.querySelector('[data-reorder-feedback]');
            let draggedItem = null;
            let feedbackTimeout = null;

            const setFeedback = (type, message) => {
                if (!feedback) return;
                clearTimeout(feedbackTimeout);
                feedback.textContent = message;
                feedback.classList.remove('hidden', 'text-slate-500', 'text-emerald-600', 'text-rose-600');
                const colorClass = type === 'success' ? 'text-emerald-600' : type === 'error' ? 'text-rose-600' : 'text-slate-500';
                feedback.classList.add(colorClass);
                feedbackTimeout = setTimeout(() => {
                    feedback.classList.add('hidden');
                    feedback.classList.remove(colorClass);
                }, 3500);
            };

            list.querySelectorAll('[data-drag-handle]').forEach(handle => {
                handle.setAttribute('draggable', 'false');
            });

            const getDragAfterElement = (container, y) => {
                const elements = [...container.querySelectorAll('[data-draggable-item]:not(.dragging)')];
                return elements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset, element: child };
                    }
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
            };

            list.addEventListener('dragstart', event => {
                const item = event.target.closest('[data-draggable-item]');
                if (!item || !event.target.closest('[data-drag-handle]')) {
                    event.preventDefault();
                    return;
                }
                draggedItem = item;
                item.classList.add('dragging', 'opacity-60', 'ring-2', 'ring-indigo-200');
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', item.dataset.itemId);
            });

            const finalizeDrag = () => {
                if (!draggedItem) {
                    return;
                }
                draggedItem.classList.remove('dragging', 'opacity-60', 'ring-2', 'ring-indigo-200');
                draggedItem = null;
            };

            list.addEventListener('dragend', finalizeDrag);
            list.addEventListener('drop', finalizeDrag);

            list.addEventListener('dragover', event => {
                event.preventDefault();
                if (!draggedItem) {
                    return;
                }
                const afterElement = getDragAfterElement(list, event.clientY);
                if (!afterElement) {
                    list.appendChild(draggedItem);
                } else {
                    list.insertBefore(draggedItem, afterElement);
                }
            });

            list.addEventListener('drop', async () => {
                const items = [...list.querySelectorAll('[data-draggable-item]')];
                const payload = items.map((item, index) => ({
                    item_id: item.dataset.itemId,
                    order_in_container: startOrder + index
                }));

                try {
                    const response = await fetch(reorderUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ items: payload })
                    });

                    if (!response.ok) {
                        throw new Error('Không thể cập nhật thứ tự bài học.');
                    }

                    items.forEach((item, index) => {
                        const label = item.querySelector('[data-order-label]');
                        if (label) {
                            label.textContent = startOrder + index;
                        }
                    });

                    setFeedback('success', 'Đã cập nhật lại thứ tự bài học.');
                } catch (error) {
                    console.error(error);
                    setFeedback('error', 'Không thể cập nhật thứ tự bài học.');
                }
            });
        })();
    </script>
{% endblock %}
