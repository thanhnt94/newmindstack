{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}
{% from 'includes/_pagination.html' import render_pagination %}

{% block title %}Bài học trong khoá học: {{ course.title }}{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-indigo-50 via-white to-slate-100 py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">
            <div class="space-y-3">
                <a href="{{ url_for('content_management.content_dashboard', tab='courses') }}" class="inline-flex items-center gap-2 text-sm font-semibold text-indigo-600 transition hover:text-indigo-800">
                    <i class="fa-solid fa-arrow-left"></i>
                    Quay lại Quản lý nội dung
                </a>
                <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-indigo-500">Khoá học</p>
                    <h1 class="mt-2 text-3xl sm:text-4xl font-bold text-slate-900">{{ course.title }}</h1>
                    <p class="mt-3 text-sm text-slate-500 max-w-3xl">{{ course.description or 'Sắp xếp và quản lý các bài học trong khoá học của bạn. Kéo thả để thay đổi thứ tự, chỉnh sửa nội dung và duy trì luồng học tập mạch lạc.' }}</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-xs font-semibold text-slate-500">
                    <span class="inline-flex items-center gap-2 rounded-full bg-indigo-100/80 px-3 py-1 text-indigo-600">
                        <i class="fa-solid fa-layer-group"></i>
                        {{ pagination.total }} bài học
                    </span>
                    {% if can_edit %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-emerald-100/80 px-3 py-1 text-emerald-600">
                        <i class="fa-solid fa-arrow-up-right-dots"></i>
                        Kéo thả để sắp xếp
                    </span>
                    {% endif %}
                </div>
            </div>
            {% if can_edit %}
            <div class="flex flex-wrap items-center justify-start gap-3">
                <a href="{{ url_for('content_management.content_management_courses.add_lesson', set_id=course.container_id) }}" class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-indigo-500/30 transition duration-200 hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">
                    <i class="fas fa-plus-circle"></i>
                    Thêm bài học mới
                </a>
            </div>
            {% endif %}
        </div>

        <div class="rounded-3xl border border-slate-200/70 bg-white/90 p-6 shadow-sm shadow-slate-200/40">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div class="space-y-1">
                    <h2 class="text-lg font-semibold text-slate-800">Tìm kiếm bài học</h2>
                    <p class="text-sm text-slate-500">Lọc theo tiêu đề để nhanh chóng chỉnh sửa đúng nội dung.</p>
                </div>
                <div class="w-full md:w-auto md:min-w-[320px]">
                    {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm bài học...", set_id=course.container_id) }}
                </div>
            </div>
        </div>

        {% if lessons %}
        {% if can_edit %}
        <div class="flex flex-wrap items-center justify-between gap-3 text-xs font-semibold text-slate-500">
            <div class="flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-indigo-100 text-indigo-500"><i class="fa-solid fa-hand"></i></span>
                <span>Kéo thả biểu tượng <i class="fa-solid fa-grip-lines"></i> để thay đổi thứ tự bài học trong trang hiện tại.</span>
            </div>
            <div data-reorder-feedback class="hidden text-sm font-semibold"></div>
        </div>
        {% endif %}

        <div data-draggable-list
             data-can-edit="{{ 'true' if can_edit else 'false' }}"
             data-reorder-url="{{ url_for('content_management.content_management_courses.reorder_lessons', set_id=course.container_id) }}"
             data-start-order="{{ lessons[0].order_in_container if lessons else 1 }}"
             class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            {% for lesson in lessons %}
            {% set preview_html = lesson.content.get('content_html') %}
            {% if not preview_html and lesson.content.get('bbcode_content') %}
                {% set preview_html = bbcode_to_html(lesson.content.get('bbcode_content')) %}
            {% endif %}
            <article class="group relative overflow-hidden rounded-2xl border border-slate-200/70 bg-white/95 p-6 shadow-sm transition duration-200 hover:-translate-y-1 hover:shadow-xl"
                     data-draggable-item
                     data-item-id="{{ lesson.item_id }}"
                     data-current-order="{{ lesson.order_in_container }}"
                     draggable="true">
                <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-indigo-500 via-sky-400 to-purple-500 opacity-70"></div>
                <div class="flex items-start justify-between gap-4">
                    <div class="space-y-3">
                        <div class="flex flex-wrap items-center gap-3 text-xs font-semibold text-slate-500">
                            <span class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1 text-indigo-600">
                                <i class="fa-solid fa-graduation-cap"></i>
                                <span>Bài học #<span data-order-label>{{ lesson.order_in_container }}</span></span>
                            </span>
                            <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
                                <i class="fa-solid fa-id-card-clip text-slate-400"></i>
                                <span>ID: {{ lesson.item_id }}</span>
                            </span>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900">{{ lesson.content.title }}</h3>
                        {% if preview_html %}
                        <p class="text-sm text-slate-500 line-clamp-4">{{ preview_html | striptags }}</p>
                        {% else %}
                        <p class="text-sm text-slate-400 italic">Bài học này chưa có nội dung hiển thị.</p>
                        {% endif %}
                    </div>
                    {% if can_edit %}
                    <button type="button" class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-slate-100 text-slate-400 transition hover:bg-slate-200" data-drag-handle title="Giữ và kéo để sắp xếp">
                        <i class="fa-solid fa-grip-lines"></i>
                    </button>
                    {% endif %}
                </div>

                <div class="mt-4 space-y-2 text-xs text-slate-500">
                    {% if lesson.content.estimated_time %}
                    <div class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
                        <i class="fa-regular fa-clock text-slate-400"></i>
                        <span>Thời lượng ước tính: {{ lesson.content.estimated_time }} phút</span>
                    </div>
                    {% endif %}
                    {% if lesson.content.lesson_audio_url or lesson.content.lesson_image_url %}
                    <div class="flex flex-wrap items-center gap-2">
                        {% if lesson.content.lesson_audio_url %}
                        <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
                            <i class="fa-solid fa-volume-high text-slate-400"></i>
                            Audio
                        </span>
                        {% endif %}
                        {% if lesson.content.lesson_image_url %}
                        <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
                            <i class="fa-solid fa-image text-slate-400"></i>
                            Hình ảnh
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if lesson.ai_explanation %}
                    <p class="rounded-2xl bg-slate-50 px-4 py-2 text-[0.75rem] text-slate-500">
                        <span class="font-semibold text-slate-600">Giải thích AI:</span>
                        {{ lesson.ai_explanation }}
                    </p>
                    {% endif %}
                </div>

                <div class="mt-6 flex items-center justify-between border-t border-slate-200 pt-4">
                    <a href="{{ url_for('content_management.content_management_courses.edit_lesson', set_id=course.container_id, item_id=lesson.item_id) }}" class="inline-flex items-center gap-2 text-sm font-semibold text-indigo-600 transition hover:text-indigo-800">
                        <i class="fa-solid fa-pen-to-square"></i> Mở trình chỉnh sửa
                    </a>
                    {% if can_edit %}
                    <div class="flex items-center gap-2">
                        <a href="{{ url_for('content_management.content_management_courses.edit_lesson', set_id=course.container_id, item_id=lesson.item_id) }}" class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-indigo-50 text-indigo-600 transition hover:bg-indigo-100" title="Chỉnh sửa">
                            <i class="fa-solid fa-pen"></i>
                        </a>
                        <form action="{{ url_for('content_management.content_management_courses.delete_lesson', set_id=course.container_id, item_id=lesson.item_id) }}" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn xóa bài học này?');">
                            <button type="submit" class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-rose-50 text-rose-600 transition hover:bg-rose-100" title="Xoá bài học">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        <div class="pt-6">
            {{ render_pagination(pagination=pagination, search_query=search_query, set_id=course.container_id) }}
        </div>

        {% else %}
        <div class="rounded-3xl border border-dashed border-slate-200 bg-white/90 p-10 text-center text-slate-500">
            <span class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-indigo-50 text-indigo-500">
                <i class="fa-solid fa-graduation-cap text-2xl"></i>
            </span>
            <p class="mt-4 text-base">Khoá học này chưa có bài học nào hoặc không tìm thấy kết quả phù hợp.</p>
            {% if can_edit %}
            <a href="{{ url_for('content_management.content_management_courses.add_lesson', set_id=course.container_id) }}" class="mt-4 inline-flex items-center gap-2 rounded-full bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-indigo-500/30 transition duration-200 hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">
                <i class="fas fa-plus-circle"></i> Thêm bài học đầu tiên
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        (function() {
            const list = document.querySelector('[data-draggable-list]');
            if (!list || list.dataset.canEdit !== 'true') {
                return;
            }

            const reorderUrl = list.dataset.reorderUrl;
            if (!reorderUrl) {
                return;
            }

            const csrfToken = '{{ csrf_token() }}';
            const startOrder = parseInt(list.dataset.startOrder || '1', 10);
            const feedback = document.querySelector('[data-reorder-feedback]');
            let draggedItem = null;
            let feedbackTimeout = null;

            const setFeedback = (type, message) => {
                if (!feedback) return;
                clearTimeout(feedbackTimeout);
                feedback.textContent = message;
                feedback.classList.remove('hidden', 'text-slate-500', 'text-emerald-600', 'text-rose-600');
                const colorClass = type === 'success' ? 'text-emerald-600' : type === 'error' ? 'text-rose-600' : 'text-slate-500';
                feedback.classList.add(colorClass);
                feedbackTimeout = setTimeout(() => {
                    feedback.classList.add('hidden');
                    feedback.classList.remove(colorClass);
                }, 3500);
            };

            list.querySelectorAll('[data-drag-handle]').forEach(handle => {
                handle.setAttribute('draggable', 'false');
            });

            const getDragAfterElement = (container, y) => {
                const elements = [...container.querySelectorAll('[data-draggable-item]:not(.dragging)')];
                return elements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset, element: child };
                    }
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
            };

            list.addEventListener('dragstart', event => {
                const item = event.target.closest('[data-draggable-item]');
                if (!item || !event.target.closest('[data-drag-handle]')) {
                    event.preventDefault();
                    return;
                }
                draggedItem = item;
                item.classList.add('dragging', 'opacity-60', 'ring-2', 'ring-indigo-200');
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', item.dataset.itemId);
            });

            const finalizeDrag = () => {
                if (!draggedItem) {
                    return;
                }
                draggedItem.classList.remove('dragging', 'opacity-60', 'ring-2', 'ring-indigo-200');
                draggedItem = null;
                persistOrder();
            };

            list.addEventListener('dragend', finalizeDrag);
            list.addEventListener('drop', event => {
                event.preventDefault();
                finalizeDrag();
            });

            list.addEventListener('dragover', event => {
                if (!draggedItem) {
                    return;
                }
                event.preventDefault();
                const afterElement = getDragAfterElement(list, event.clientY);
                if (!afterElement) {
                    list.appendChild(draggedItem);
                } else if (afterElement !== draggedItem) {
                    list.insertBefore(draggedItem, afterElement);
                }
            });

            const persistOrder = async () => {
                const items = Array.from(list.querySelectorAll('[data-draggable-item]'));
                if (items.length <= 1) {
                    return;
                }

                let hasChanges = false;
                const payload = [];
                const updates = [];

                items.forEach((item, index) => {
                    const newOrder = startOrder + index;
                    const currentOrder = Number(item.dataset.currentOrder);
                    if (currentOrder !== newOrder) {
                        hasChanges = true;
                    }
                    payload.push({ item_id: Number(item.dataset.itemId), order: newOrder });
                    updates.push({ item, newOrder });
                });

                if (!hasChanges) {
                    return;
                }

                updates.forEach(({ item, newOrder }) => {
                    const label = item.querySelector('[data-order-label]');
                    if (label) {
                        label.textContent = newOrder;
                    }
                    item.dataset.currentOrder = newOrder;
                });

                setFeedback('info', 'Đang lưu thứ tự mới...');

                try {
                    const response = await fetch(reorderUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                        },
                        body: JSON.stringify({ order: payload })
                    });

                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || 'Không thể cập nhật thứ tự.');
                    }
                    setFeedback('success', data.message || 'Đã cập nhật thứ tự!');
                } catch (error) {
                    console.error('Reorder error:', error);
                    setFeedback('error', error.message || 'Không thể cập nhật thứ tự.');
                }
            };
        })();
    </script>
{% endblock %}
