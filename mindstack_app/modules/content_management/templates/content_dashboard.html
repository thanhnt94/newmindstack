<!-- File: newmindstack/mindstack_app/modules/content_management/templates/content_dashboard.html -->
<!-- Phiên bản: 2.8 -->
<!-- Mục đích: Hiển thị bảng điều khiển tổng quan cho việc quản lý nội dung với giao diện tab động (AJAX). -->
<!--           Cung cấp các tab để chuyển đổi giữa Khóa học, Bộ thẻ và Bộ câu hỏi. -->
<!--           Đã khắc phục lỗi highlight cho tab active một cách tối thiểu. -->
<!--           Thiết kế responsive với Tailwind CSS. -->

{% extends "base.html" %}

{% block title %}Quản Lý Nội Dung - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for active tab */
        .tab-button.active {
            /* DÒNG ĐƯỢC CHỈNH SỬA: Thêm màu nền và !important để đảm bảo highlight */
            @apply border-b-4 border-blue-500 text-blue-600 font-bold bg-blue-50 !important; 
        }
        /* Ensure tab content fills available width */
        #tab-content {
            width: 100%;
            @apply flex items-start;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 sm:mb-8 text-center">
        Bảng Điều Khiển Quản Lý Nội Dung
    </h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6">
                {% for category, message in messages %}
                    <div class="p-3 mb-2 rounded-lg text-white
                                {% if category == 'success' %}bg-green-500
                                {% elif category == 'danger' %}bg-red-500
                                {% elif category == 'info' %}bg-blue-500
                                {% elif category == 'warning' %}bg-yellow-500
                                {% else %}bg-gray-500{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8">
        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6 flex-wrap justify-center sm:justify-start">
            <button id="tab-courses" class="tab-button py-3 px-4 sm:px-6 text-lg sm:text-xl text-gray-700 hover:text-blue-600 focus:outline-none transition duration-150 ease-in-out active" data-target="courses">
                <i class="fas fa-book mr-2"></i> Khóa học
            </button>
            <button id="tab-flashcards" class="tab-button py-3 px-4 sm:px-6 text-lg sm:text-xl text-gray-700 hover:text-blue-600 focus:outline-none transition duration-150 ease-in-out" data-target="flashcards">
                <i class="fas fa-clone mr-2"></i> Thẻ ghi nhớ
            </button>
            <button id="tab-quizzes" class="tab-button py-3 px-4 sm:px-6 text-lg sm:text-xl text-gray-700 hover:text-blue-600 focus:outline-none transition duration-150 ease-in-out" data-target="quizzes">
                <i class="fas fa-question-circle mr-2"></i> Bộ câu hỏi
            </button>
        </div>

        <!-- Content Area -->
        <div id="tab-content" class="min-h-[300px] flex items-center justify-center text-gray-500">
            <!-- Content will be loaded here via AJAX -->
            <p>Đang tải nội dung...</p>
        </div>
    </div>

    <!-- Nút quay lại trang chủ -->
    <div class="flex justify-center mt-10">
        <a href="{{ url_for('main.dashboard') }}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Quay lại trang chủ
        </a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContent = document.getElementById('tab-content');

        /**
         * Tải nội dung cho tab được chọn bằng AJAX.
         * @param {string} tabName - Tên của tab (e.g., 'courses', 'flashcards', 'quizzes').
         */
        async function loadTabContent(tabName) {
            // Cải thiện thông báo tải
            tabContent.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-blue-500">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-lg">Đang tải nội dung ${tabName}...</p>
                </div>
            `;

            // Loại bỏ lớp 'active' khỏi tất cả các nút tab
            tabButtons.forEach(button => button.classList.remove('active'));
            // Thêm lớp 'active' vào nút tab hiện tại
            document.getElementById('tab-' + tabName).classList.add('active');

            let url;
            if (tabName === 'courses') {
                url = "{{ url_for('content_management.content_management_courses.list_courses') }}";
            } else if (tabName === 'flashcards') {
                url = "{{ url_for('content_management.content_management_flashcards.list_flashcard_sets') }}";
            } else if (tabName === 'quizzes') {
                url = "{{ url_for('content_management.content_management_quizzes.list_quiz_sets') }}";
            } else {
                tabContent.innerHTML = '<p class="text-red-500">Lỗi: Tab không hợp lệ.</p>';
                return;
            }

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Đánh dấu đây là yêu cầu AJAX
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
                }
                const html = await response.text();
                tabContent.innerHTML = html;
            } catch (error) {
                console.error('Lỗi khi tải nội dung tab:', error);
                tabContent.innerHTML = `<p class="text-red-500 text-center">Không thể tải nội dung. Vui lòng thử lại. Lỗi: ${error.message}</p>`;
            }
        }

        // Gắn sự kiện click cho các nút tab
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                loadTabContent(this.dataset.target);
            });
        });

        // Tải nội dung mặc định khi trang được tải (ví dụ: tab khóa học)
        loadTabContent('courses');
    });
</script>
{% endblock %}
