<!-- File: newmindstack/mindstack_app/modules/content_management/templates/content_dashboard.html -->
<!-- Phiên bản: 2.16 -->
<!-- Mục đích: Hiển thị bảng điều khiển tổng quan cho việc quản lý nội dung với giao diện tab động (AJAX). -->
<!--           Cung cấp các tab để chuyển đổi giữa Khóa học, Bộ thẻ và Bộ câu hỏi. -->
<!--           Đã khắc phục lỗi highlight cho tab active bằng cách sử dụng sessionStorage. -->
<!--           Đã loại bỏ các import CSS trùng lặp và chuyển áp dụng kiểu active trực tiếp bằng JS. -->
<!--           Đã sửa lỗi JavaScript không thể phân tích cú pháp url_for. -->
<!--           Đã đảm bảo hiệu ứng active cho tab hiển thị bằng cách thêm/bớt class Tailwind trực tiếp. -->
<!--           ĐÃ SỬA: Loại bỏ khối hiển thị flash messages trùng lặp. -->
<!--           Thiết kế responsive với Tailwind CSS. -->

{% extends "base.html" %}

{% block title %}Quản Lý Nội Dung - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    {# Loại bỏ các import CSS trùng lặp và style tùy chỉnh cho .tab-button.active #}
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure tab content fills available width */
        #tab-content {
            width: 100%;
            display: flex; /* @apply flex */
            align-items: flex-start; /* @apply items-start */
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 sm:mb-8 text-center">
        Bảng Điều Khiển Quản Lý Nội Dung
    </h1>

    {# ĐÃ SỬA: Loại bỏ khối hiển thị flash messages trùng lặp, vì base.html đã xử lý #}
    {#
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6">
                {% for category, message in messages %}
                    <div class="p-3 mb-2 rounded-lg text-white
                                {% if category == 'success' %}bg-green-500
                                {% elif category == 'danger' %}bg-red-500
                                {% elif category == 'info' %}bg-blue-500
                                {% elif category == 'warning' %}bg-yellow-500
                                {% else %}bg-gray-500{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    #}

    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8">
        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6 flex-wrap justify-center sm:justify-start">
            <button id="tab-courses" class="tab-button py-3 px-4 sm:px-6 text-lg sm:text-xl text-gray-700 hover:text-blue-600 focus:outline-none transition duration-150 ease-in-out" data-target="courses">
                <i class="fas fa-book mr-2"></i> Khóa học
            </button>
            <button id="tab-flashcards" class="tab-button py-3 px-4 sm:px-6 text-lg sm:text-xl text-gray-700 hover:text-blue-600 focus:outline-none transition duration-150 ease-in-out" data-target="flashcards">
                <i class="fas fa-clone mr-2"></i> Thẻ ghi nhớ
            </button>
            <button id="tab-quizzes" class="tab-button py-3 px-4 sm:px-6 text-lg sm:text-xl text-gray-700 hover:text-blue-600 focus:outline-none transition duration-150 ease-in-out" data-target="quizzes">
                <i class="fas fa-question-circle mr-2"></i> Bộ câu hỏi
            </button>
        </div>

        <!-- Content Area -->
        <div id="tab-content" class="min-h-[300px] flex items-center justify-center text-gray-500">
            <!-- Content will be loaded here via AJAX -->
            <p>Đang tải nội dung...</p>
        </div>
    </div>

    <!-- Nút quay lại trang chủ -->
    <div class="flex justify-center mt-10">
        <a href="{{ url_for('main.dashboard') }}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Quay lại trang chủ
        </a>
    </div>
</div>

<script>
    // Khai báo các URL mà Flask đã xử lý trước khi JavaScript chạy
    const coursesListUrl = "{{ url_for('content_management.content_management_courses.list_courses') }}";
    const flashcardSetsListUrl = "{{ url_for('content_management.content_management_flashcards.list_flashcard_sets') }}";
    const quizSetsListUrl = "{{ url_for('content_management.content_management_quizzes.list_quiz_sets') }}";

    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContent = document.getElementById('tab-content');
        const validTabs = ['courses', 'flashcards', 'quizzes']; // Danh sách các tab hợp lệ
        const SESSION_STORAGE_KEY = 'activeContentTab'; // Khóa để lưu trữ trong sessionStorage

        // Các lớp Tailwind CSS để thêm/bớt cho tab active
        const activeClasses = [
            'border-b-4', 'border-blue-500', 'text-blue-600', 'font-bold', 'bg-blue-100', 'shadow-sm'
        ];
        // Các lớp Tailwind CSS mặc định cho tab inactive (hover và transition)
        const defaultClasses = [
            'text-gray-700', 'hover:text-blue-600', 'focus:outline-none', 'transition', 'duration-150', 'ease-in-out'
        ];


        /**
         * Tải nội dung cho tab được chọn bằng AJAX.
         * @param {string} tabName - Tên của tab (e.g., 'courses', 'flashcards', 'quizzes').
         */
        async function loadTabContent(tabName) {
            // Cải thiện thông báo tải
            tabContent.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-blue-500">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-lg">Đang tải nội dung ${tabName}...</p>
                </div>
            `;

            // Loại bỏ tất cả các lớp active và thêm lại lớp default cho tất cả các nút tab
            tabButtons.forEach(button => {
                button.classList.remove(...activeClasses); // Loại bỏ lớp active
                button.classList.add(...defaultClasses); // Thêm lại lớp default
            });
            
            // Thêm lớp 'active' (các lớp Tailwind cụ thể) vào nút tab hiện tại
            const currentTabButton = document.getElementById('tab-' + tabName);
            if (currentTabButton) {
                currentTabButton.classList.add(...activeClasses); // Thêm các lớp active
                currentTabButton.classList.remove(...defaultClasses); // Loại bỏ các lớp default để tránh xung đột
                // LƯU TRẠNG THÁI TAB VÀO sessionStorage
                sessionStorage.setItem(SESSION_STORAGE_KEY, tabName);
            }

            let url;
            // Sử dụng các biến JavaScript đã được định nghĩa sẵn
            if (tabName === 'courses') {
                url = coursesListUrl;
            } else if (tabName === 'flashcards') {
                url = flashcardSetsListUrl;
            } else if (tabName === 'quizzes') {
                url = quizSetsListUrl;
            } else {
                tabContent.innerHTML = '<p class="text-red-500">Lỗi: Tab không hợp lệ.</p>';
                return;
            }

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Đánh dấu đây là yêu cầu AJAX
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
                }
                const html = await response.text();
                tabContent.innerHTML = html;
            } catch (error) {
                console.error('Lỗi khi tải nội dung tab:', error);
                tabContent.innerHTML = `<p class="text-red-500 text-center">Không thể tải nội dung. Vui lòng thử lại. Lỗi: ${error.message}</p>`;
            }
        }

        // Gắn sự kiện click cho các nút tab
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                loadTabContent(this.dataset.target);
            });
        });

        // XÁC ĐỊNH TAB SẼ ĐƯỢC TẢI KHI TRANG ĐƯỢC TẢI LẦN ĐẦU (Ưu tiên sessionStorage)
        let initialTab = sessionStorage.getItem(SESSION_STORAGE_KEY); // Lấy tab đã lưu từ sessionStorage

        // Nếu không có tab đã lưu hoặc tab đã lưu không hợp lệ, kiểm tra URL parameter (nếu có)
        if (!initialTab || !validTabs.includes(initialTab)) {
            const urlParams = new URLSearchParams(window.location.search);
            initialTab = urlParams.get('tab');
        }

        // Nếu vẫn không có tab hợp lệ, mặc định là 'courses'
        if (!initialTab || !validTabs.includes(initialTab)) {
            initialTab = 'courses';
        }
        
        loadTabContent(initialTab);
    });
</script>
{% endblock %}
