<!-- File: newmindstack/mindstack_app/modules/content_management/templates/content_dashboard.html -->
<!-- Phiên bản: 3.3 -->
<!-- ĐÃ SỬA: Xóa nút "Quay lại trang chủ". -->
<!-- ĐÃ SỬA: Cải thiện layout, sử dụng bóng đổ và khoảng trắng để giao diện phẳng và hiện đại hơn. -->
<!-- ĐÃ SỬA: Khắc phục lỗi BuildError bằng cách đổi tên endpoint list_courses thành list_course_sets. -->
<!-- ĐÃ SỬA: Cập nhật tiêu đề trang từ "Bảng Điều Khiển Quản Lý Nội Dung" thành "Quản lý nội dung" và tối ưu thẩm mỹ. -->

{% extends "base.html" %}

{% block title %}Quản Lý Nội Dung - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .content-dashboard-hero {
            background: radial-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.12), transparent 55%),
                        radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.12), transparent 45%),
                        radial-gradient(circle at 50% 100%, rgba(59, 130, 246, 0.18), transparent 50%);
        }
        .content-dashboard-card {
            backdrop-filter: blur(18px);
        }
        @media (max-width: 640px) {
            .content-dashboard-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .content-dashboard-tabs::-webkit-scrollbar {
                display: none;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-indigo-50 via-white to-slate-100 min-h-[calc(100vh-6rem)] py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-10">
        <header class="content-dashboard-hero rounded-3xl border border-white/60 bg-white/60 shadow-[0_30px_60px_-30px_rgba(79,70,229,0.35)] px-6 sm:px-10 py-10 flex flex-col xl:flex-row gap-10">
            <div class="max-w-3xl space-y-4">
                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-indigo-500">Không gian biên tập</p>
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Quản lý nội dung học tập</h1>
                <p class="text-sm sm:text-base text-slate-600 leading-relaxed">
                    Tổ chức mọi khóa học, bộ thẻ và bộ câu hỏi của bạn ở một nơi. Tất cả nội dung được đồng bộ hoá với hệ thống mục tiêu học tập,
                    giúp bạn kiểm soát tiến độ tạo nội dung nhanh chóng, trực quan và linh hoạt hơn.
                </p>
                <div class="flex flex-wrap gap-3 pt-2">
                    <span class="inline-flex items-center gap-2 rounded-full bg-indigo-100/80 px-3 py-1 text-xs font-semibold text-indigo-600">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Giao diện mới hiện đại
                    </span>
                    <span class="inline-flex items-center gap-2 rounded-full bg-sky-100 px-3 py-1 text-xs font-semibold text-sky-700">
                        <i class="fa-solid fa-arrows-up-down"></i> Kéo thả sắp xếp nội dung
                    </span>
                    <span class="inline-flex items-center gap-2 rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">
                        <i class="fa-solid fa-pen-to-square"></i> Chỉnh sửa nhanh chóng
                    </span>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full xl:w-auto">
                <div class="content-dashboard-card rounded-2xl border border-white/60 bg-white/70 shadow-inner p-5 flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Khóa học</span>
                        <span class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-indigo-100 text-indigo-600"><i class="fa-solid fa-book"></i></span>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed">Thiết kế lộ trình bài học, quản lý nội dung, và phân quyền cộng tác viên.</p>
                </div>
                <div class="content-dashboard-card rounded-2xl border border-white/60 bg-white/70 shadow-inner p-5 flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Thẻ ghi nhớ</span>
                        <span class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-sky-100 text-sky-600"><i class="fa-solid fa-clone"></i></span>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed">Gom nhóm kiến thức, kết hợp audio/hình ảnh và cập nhật hàng loạt bằng Excel.</p>
                </div>
                <div class="content-dashboard-card rounded-2xl border border-white/60 bg-white/70 shadow-inner p-5 flex flex-col gap-3 sm:col-span-2">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Bộ câu hỏi</span>
                        <span class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-rose-100 text-rose-600"><i class="fa-solid fa-question"></i></span>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed">Tạo đề luyện tập, giải thích đáp án rõ ràng và đồng bộ với hệ thống mục tiêu.</p>
                </div>
            </div>
        </header>

        <section class="content-dashboard-card rounded-3xl border border-white/60 bg-white/80 shadow-[0_20px_40px_-24px_rgba(15,23,42,0.35)]">
            <div class="px-4 sm:px-8 pt-6">
                <div class="content-dashboard-tabs flex items-center gap-3 overflow-hidden rounded-full bg-slate-100/70 p-1">
                    <button id="tab-courses" data-target="courses" class="tab-button flex-1 min-w-[160px] rounded-full px-4 py-3 text-sm font-semibold text-slate-500 transition-all duration-200 hover:bg-white/70 hover:text-indigo-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">
                        <span class="flex items-center justify-center gap-2">
                            <i class="fa-solid fa-book text-base"></i>
                            <span>Khoá học</span>
                        </span>
                    </button>
                    <button id="tab-flashcards" data-target="flashcards" class="tab-button flex-1 min-w-[160px] rounded-full px-4 py-3 text-sm font-semibold text-slate-500 transition-all duration-200 hover:bg-white/70 hover:text-indigo-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">
                        <span class="flex items-center justify-center gap-2">
                            <i class="fa-solid fa-clone text-base"></i>
                            <span>Thẻ ghi nhớ</span>
                        </span>
                    </button>
                    <button id="tab-quizzes" data-target="quizzes" class="tab-button flex-1 min-w-[160px] rounded-full px-4 py-3 text-sm font-semibold text-slate-500 transition-all duration-200 hover:bg-white/70 hover:text-indigo-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">
                        <span class="flex items-center justify-center gap-2">
                            <i class="fa-solid fa-circle-question text-base"></i>
                            <span>Bộ câu hỏi</span>
                        </span>
                    </button>
                </div>
            </div>

            <div id="tab-content" class="min-h-[420px] px-4 sm:px-8 pb-10 pt-8">
                <div class="flex flex-col items-center justify-center gap-4 text-slate-500">
                    <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-indigo-50 text-indigo-500">
                        <i class="fa-solid fa-rotate"></i>
                    </span>
                    <p class="text-sm sm:text-base font-medium">Đang tải nội dung phù hợp...</p>
                    <p class="text-xs sm:text-sm text-slate-400">Một giây thôi nhé! Nội dung sẽ xuất hiện ngay khi sẵn sàng.</p>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {# Giữ nguyên script cũ #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ĐÃ SỬA: Đổi tên endpoint list_courses thành list_course_sets
            const coursesListUrl = "{{ url_for('content_management.content_management_courses.list_course_sets') }}";
            const flashcardSetsListUrl = "{{ url_for('content_management.content_management_flashcards.list_flashcard_sets') }}";
            const quizSetsListUrl = "{{ url_for('content_management.content_management_quizzes.list_quiz_sets') }}";
            
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContent = document.getElementById('tab-content');
            const validTabs = ['courses', 'flashcards', 'quizzes'];
            const SESSION_STORAGE_KEY = 'activeContentTab';

            const activeClasses = ['bg-white', 'text-indigo-600', 'shadow-sm'];
            const defaultClasses = ['text-slate-500'];

            async function loadTabContent(tabName) {
                tabContent.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500"><svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-3 text-lg">Đang tải nội dung ${tabName}...</p></div>`;
                
                tabButtons.forEach(button => {
                    button.classList.remove(...activeClasses);
                    button.classList.add(...defaultClasses);
                    button.setAttribute('aria-selected', 'false');
                    button.dataset.active = 'false';
                });

                const currentTabButton = document.getElementById('tab-' + tabName);
                if (currentTabButton) {
                    currentTabButton.classList.add(...activeClasses);
                    currentTabButton.classList.remove(...defaultClasses);
                    currentTabButton.setAttribute('aria-selected', 'true');
                    currentTabButton.dataset.active = 'true';
                    sessionStorage.setItem(SESSION_STORAGE_KEY, tabName);
                }

                let url;
                if (tabName === 'courses') url = coursesListUrl;
                else if (tabName === 'flashcards') url = flashcardSetsListUrl;
                else if (tabName === 'quizzes') url = quizSetsListUrl;
                else {
                    tabContent.innerHTML = '<p class="text-red-500">Lỗi: Tab không hợp lệ.</p>';
                    return;
                }

                try {
                    const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    tabContent.innerHTML = await response.text();
                } catch (error) {
                    console.error('Lỗi khi tải nội dung tab:', error);
                    tabContent.innerHTML = `<p class="text-red-500 text-center">Không thể tải nội dung. Vui lòng thử lại.</p>`;
                }
            }
            
            window.loadTabContent = loadTabContent;

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    loadTabContent(this.dataset.target);
                });
            });

            let initialTab = sessionStorage.getItem(SESSION_STORAGE_KEY) || new URLSearchParams(window.location.search).get('tab');
            if (!initialTab || !validTabs.includes(initialTab)) {
                initialTab = 'courses';
            }
            loadTabContent(initialTab);

            async function fetchAndUpdateContent(url) {
                tabContent.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500"><svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-3 text-lg">Đang tải...</p></div>`;
                try {
                    const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    tabContent.innerHTML = await response.text();
                } catch (error) {
                    console.error('Lỗi khi tải nội dung:', error);
                    tabContent.innerHTML = `<p class="text-red-500 text-center">Không thể tải nội dung. Vui lòng thử lại.</p>`;
                }
            }

            tabContent.addEventListener('click', function(event) {
                const link = event.target.closest('a');
                if (link && link.href && link.href.includes('page=')) {
                    event.preventDefault();
                    fetchAndUpdateContent(link.href);
                }
            });

            tabContent.addEventListener('submit', function(event) {
                const form = event.target.closest('form');
                if (form && form.querySelector('input[name="q"]')) {
                    event.preventDefault();
                    const formData = new FormData(form);
                    const searchQuery = formData.get('q');
                    const url = new URL(form.action);
                    url.searchParams.set('q', searchQuery);
                    fetchAndUpdateContent(url.href);
                }
            });
        });
    </script>
{% endblock %}