{% extends "base.html" %}

{% block title %}Quản lý Excel - {{ quiz_set.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-wrap justify-between items-start gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-semibold text-gray-800 flex items-center gap-3">
                <i class="fas fa-database text-purple-500"></i>
                <span>Quản lý Excel cho bộ câu hỏi</span>
            </h1>
            <p class="text-gray-600 mt-1">{{ quiz_set.title }}</p>
            {% if item_count is not none %}
            <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500 mt-3">
                <span class="flex items-center gap-2">
                    <i class="fas fa-list-ol text-purple-400"></i>
                    {{ "{:,}".format(item_count) }} câu hỏi
                </span>
                {% if quiz_set.updated_at %}
                <span class="flex items-center gap-2">
                    <i class="fas fa-history text-purple-400"></i>
                    Cập nhật lần cuối: {{ quiz_set.updated_at.strftime('%d/%m/%Y %H:%M') }}
                </span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="flex flex-wrap items-center gap-3">
            <a href="{{ export_excel_url }}" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition duration-300 flex items-center shadow-md">
                <i class="fas fa-file-export mr-2"></i> Xuất file Excel
            </a>
            <a href="{{ template_excel_url }}" class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-md hover:border-purple-400 hover:text-purple-600 transition duration-300 flex items-center shadow-sm">
                <i class="fas fa-download mr-2"></i> Tải template trống
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div class="xl:col-span-2 space-y-6">
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800">Nhập dữ liệu từ Excel</h2>
                        <p class="text-sm text-gray-500 mt-1">Kéo thả file Excel (.xlsx) đã chỉnh sửa để cập nhật nhanh bộ câu hỏi.</p>
                    </div>
                    <div class="flex items-center text-sm text-blue-600 gap-2">
                        <i class="fas fa-info-circle"></i>
                        <span>File được xử lý trực tiếp trên máy chủ của bạn.</span>
                    </div>
                </div>

                <form id="quizExcelImportForm" method="post" enctype="multipart/form-data" class="space-y-5">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div data-role="quiz-excel-drop-zone"
                         class="relative border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 px-6 py-10 text-center transition duration-200 cursor-pointer">
                        <input type="file"
                               name="excel_file"
                               id="quiz_excel_file"
                               accept=".xlsx"
                               class="hidden"
                               required>
                        <div class="flex flex-col items-center gap-3 pointer-events-none">
                            <span class="flex h-12 w-12 items-center justify-center rounded-full bg-purple-100 text-purple-500">
                                <i class="fas fa-file-excel text-xl"></i>
                            </span>
                            <div>
                                <p class="text-lg font-medium text-gray-800">Thả file Excel vào đây hoặc bấm để chọn</p>
                                <p class="text-sm text-gray-500" data-role="quiz-excel-helper">Hỗ trợ định dạng .xlsx, dung lượng tối đa 10MB.</p>
                            </div>
                        </div>
                        <button type="button"
                                class="absolute top-3 right-3 text-xs text-gray-500 hover:text-red-500 transition hidden"
                                data-role="quiz-excel-clear"
                                aria-label="Xóa file đã chọn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="bg-purple-50 border border-purple-100 rounded-lg px-4 py-3 hidden" data-role="quiz-excel-summary">
                        <p class="text-sm font-medium text-purple-700 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            <span data-role="quiz-excel-name">Chưa chọn file</span>
                        </p>
                        <p class="text-xs text-purple-600 mt-1" data-role="quiz-excel-meta"></p>
                    </div>

                    <p class="text-sm hidden" data-role="quiz-excel-status"></p>

                    <div class="flex flex-wrap items-center justify-end gap-3">
                        <button type="submit"
                                data-role="quiz-excel-submit"
                                class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 transition duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <i class="fas fa-file-import mr-2"></i> Nhập Excel
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Các cột quan trọng trong sheet <code class="bg-gray-100 px-2 py-1 rounded text-sm">Data</code></h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-gray-600">
                                <th class="px-4 py-3 font-medium">Cột</th>
                                <th class="px-4 py-3 font-medium">Ý nghĩa</th>
                                <th class="px-4 py-3 font-medium">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">item_id</td>
                                <td class="px-4 py-3 text-gray-600">Định danh duy nhất của câu hỏi hiện có.</td>
                                <td class="px-4 py-3 text-gray-500">Để trống để tạo câu hỏi mới.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">order_in_container</td>
                                <td class="px-4 py-3 text-gray-600">Thứ tự mong muốn của câu hỏi trong bộ.</td>
                                <td class="px-4 py-3 text-gray-500">Số nguyên; bỏ trống để giữ nguyên.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">action</td>
                                <td class="px-4 py-3 text-gray-600">Kiểm soát thao tác áp dụng cho từng dòng.</td>
                                <td class="px-4 py-3 text-gray-500 space-y-1">
                                    <div><code>update</code> hoặc để trống: cập nhật câu hỏi có <code>item_id</code>.</div>
                                    <div><code>keep</code>/<code>skip</code>: giữ nguyên dữ liệu hiện tại (vẫn có thể đổi thứ tự).</div>
                                    <div><code>create</code>/<code>new</code>: luôn tạo câu hỏi mới.</div>
                                    <div><code>delete</code>: xóa câu hỏi tương ứng.</div>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">question &amp; option_*</td>
                                <td class="px-4 py-3 text-gray-600">Nội dung câu hỏi và các đáp án lựa chọn.</td>
                                <td class="px-4 py-3 text-gray-500">Option A/B và đáp án đúng là bắt buộc.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">question_image_file / question_audio_file</td>
                                <td class="px-4 py-3 text-gray-600">Media đi kèm câu hỏi.</td>
                                <td class="px-4 py-3 text-gray-500">Hỗ trợ URL tuyệt đối hoặc đường dẫn tương đối trong thư mục media.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">group_id</td>
                                <td class="px-4 py-3 text-gray-600">Mã nhận diện để gom các câu hỏi vào cùng một group.</td>
                                <td class="px-4 py-3 text-gray-500">Cùng một <code>group_id</code> sẽ chia sẻ nội dung theo cấu hình <code>group_shared_components</code>.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">group_shared_components</td>
                                <td class="px-4 py-3 text-gray-600">Liệt kê các phần sẽ dùng chung giữa các câu (ví dụ: <code>image,audio,explanation,prompt</code>).</td>
                                <td class="px-4 py-3 text-gray-500">Importer sẽ lấy giá trị đầu tiên của từng thành phần và áp cho các dòng còn lại cùng <code>group_id</code>.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">group_item_order</td>
                                <td class="px-4 py-3 text-gray-600">Thứ tự câu hỏi bên trong group.</td>
                                <td class="px-4 py-3 text-gray-500">Tách biệt với <code>order_in_container</code> để thể hiện trình tự nhiều bước.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Tóm tắt cách xuất dữ liệu</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-gray-600">
                                <th class="px-4 py-3 font-medium">Vị trí nút hành động</th>
                                <th class="px-4 py-3 font-medium">Mục đích</th>
                                <th class="px-4 py-3 font-medium">Lưu ý Media trong Excel</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">Trong trang Cập nhật Excel</td>
                                <td class="px-4 py-3 text-gray-600">Xuất file Excel để dễ chỉnh sửa và nhập trở lại.</td>
                                <td class="px-4 py-3 text-gray-500">Đường dẫn/URL giữ nguyên như trong CSDL (đường dẫn tương đối không bị thay đổi). Không sao chép media.</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-gray-800">Trong trang Danh sách câu hỏi</td>
                                <td class="px-4 py-3 text-gray-600">Tạo gói ZIP để di chuyển/sao lưu, bao gồm Excel và media.</td>
                                <td class="px-4 py-3 text-gray-500 space-y-1">
                                    <div>Đường dẫn media trong Excel được chuẩn hoá về dạng gốc (ví dụ: <code>uploads/&lt;thư_mục&gt;/...</code>).</div>
                                    <div>Nếu gặp đường dẫn tuyệt đối, file sẽ được đưa vào thư mục tương ứng trong gói ZIP và Excel chỉ lưu tên file.</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-sm text-purple-600">
                    <i class="fas fa-external-link-alt mr-1"></i>
                    Nút xuất ZIP hiển thị tại trang <a href="{{ url_for('content_management.content_management_quizzes.list_quiz_items', set_id=quiz_set.container_id) }}" class="text-purple-600 underline">Danh sách câu hỏi</a> (liên kết trực tiếp: <a href="{{ export_zip_url }}" class="underline">{{ export_zip_url }}</a>).
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Hướng dẫn nhanh</h2>
                <ul class="list-disc list-inside text-gray-700 space-y-2 text-sm">
                    <li>Xuất file Excel hiện tại để tham khảo cấu trúc chuẩn.</li>
                    <li>Cột <strong>action</strong> hỗ trợ <code>update</code>, <code>keep</code>/<code>skip</code>, <code>create</code>, <code>delete</code> để thao tác nhanh.</li>
                    <li>Sheet <code>Info</code> có thể khai báo <code>image_base_folder</code> và <code>audio_base_folder</code>; hệ thống sẽ áp dụng tự động khi nhập.</li>
                    <li>Dùng bộ 3 cột <code>group_id</code>, <code>group_shared_components</code> và <code>group_item_order</code> để gom nhóm và sắp xếp câu hỏi nhiều bước.</li>
                    <li>Sau khi nhập thành công hệ thống sẽ tự động chuẩn hóa lại thứ tự.</li>
                    <li>Dùng nút <strong>Tải template trống</strong> ở đầu trang để lấy file mẫu đúng cấu trúc (không kèm dữ liệu).</li>
                </ul>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 space-y-4">
                <div class="flex items-start gap-3">
                    <span class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 text-blue-500 mt-1">
                        <i class="fas fa-shield-alt"></i>
                    </span>
                    <div class="text-sm text-gray-600">
                        <h3 class="text-base font-semibold text-gray-800 mb-1">Sao lưu trước khi nhập</h3>
                        <p>Tải về gói dữ liệu hiện tại để có thể hoàn tác nhanh nếu cần.</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="flex h-10 w-10 items-center justify-center rounded-full bg-green-100 text-green-500 mt-1">
                        <i class="fas fa-robot"></i>
                    </span>
                    <div class="text-sm text-gray-600">
                        <h3 class="text-base font-semibold text-gray-800 mb-1">Tự động ánh xạ media</h3>
                        <p>Đường dẫn tương đối sẽ được ánh xạ vào thư mục media mặc định của bộ câu hỏi.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8">
        <a href="{{ url_for('content_management.content_management_quizzes.list_quiz_items', set_id=quiz_set.container_id) }}" class="text-blue-600 hover:text-blue-800 flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Quay lại danh sách câu hỏi
        </a>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('quizExcelImportForm');
        if (!form) {
            return;
        }

        const dropZone = form.querySelector('[data-role="quiz-excel-drop-zone"]');
        const fileInput = form.querySelector('#quiz_excel_file');
        const helper = form.querySelector('[data-role="quiz-excel-helper"]');
        const summaryBox = form.querySelector('[data-role="quiz-excel-summary"]');
        const fileNameLabel = form.querySelector('[data-role="quiz-excel-name"]');
        const fileMetaLabel = form.querySelector('[data-role="quiz-excel-meta"]');
        const clearButton = form.querySelector('[data-role="quiz-excel-clear"]');
        const submitButton = form.querySelector('[data-role="quiz-excel-submit"]');
        const statusLabel = form.querySelector('[data-role="quiz-excel-status"]');

        const formatBytes = (bytes) => {
            if (!bytes && bytes !== 0) {
                return '';
            }
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) {
                return '0 B';
            }
            const i = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), sizes.length - 1);
            const value = bytes / Math.pow(1024, i);
            return `${value.toFixed(i === 0 ? 0 : 1)} ${sizes[i]}`;
        };

        const formatDate = (timestamp) => {
            if (!timestamp) {
                return '';
            }
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) {
                return '';
            }
            return date.toLocaleString('vi-VN');
        };

        const resetState = () => {
            fileInput.value = '';
            submitButton.disabled = true;
            if (statusLabel) {
                statusLabel.textContent = '';
                statusLabel.classList.add('hidden');
                statusLabel.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
            }
            if (helper) {
                helper.classList.remove('hidden');
            }
            if (summaryBox) {
                summaryBox.classList.add('hidden');
            }
            if (clearButton) {
                clearButton.classList.add('hidden');
            }
            if (dropZone) {
                dropZone.classList.remove('ring-2', 'ring-purple-500', 'bg-purple-50');
            }
        };

        const showStatus = (message, type) => {
            if (!statusLabel) {
                return;
            }
            statusLabel.textContent = message || '';
            statusLabel.classList.remove('text-red-600', 'text-green-600', 'text-blue-600', 'hidden');
            if (!message) {
                statusLabel.classList.add('hidden');
                return;
            }
            if (type === 'error') {
                statusLabel.classList.add('text-red-600');
            } else if (type === 'success') {
                statusLabel.classList.add('text-green-600');
            } else {
                statusLabel.classList.add('text-blue-600');
            }
        };

        const updateSummary = (file) => {
            if (!summaryBox || !file) {
                return;
            }
            summaryBox.classList.remove('hidden');
            fileNameLabel.textContent = file.name;
            const metaParts = [];
            if (file.size) {
                metaParts.push(`Dung lượng ${formatBytes(file.size)}`);
            }
            if (file.lastModified) {
                metaParts.push(`Chỉnh sửa lần cuối ${formatDate(file.lastModified)}`);
            }
            fileMetaLabel.textContent = metaParts.join(' · ');
        };

        const applyFile = (file) => {
            if (!file) {
                resetState();
                return;
            }

            const valid = file.name.toLowerCase().endsWith('.xlsx');
            if (!valid) {
                resetState();
                showStatus('Định dạng tệp không hợp lệ. Vui lòng chọn file .xlsx.', 'error');
                return;
            }

            const maxSize = 10 * 1024 * 1024;
            if (file.size && file.size > maxSize) {
                resetState();
                showStatus('Dung lượng tệp vượt quá 10MB. Vui lòng tối ưu hoặc tách nhỏ dữ liệu.', 'error');
                return;
            }

            if (typeof DataTransfer !== 'undefined') {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
            }

            submitButton.disabled = false;
            if (helper) {
                helper.classList.add('hidden');
            }
            if (clearButton) {
                clearButton.classList.remove('hidden');
            }
            if (dropZone) {
                dropZone.classList.add('ring-2', 'ring-purple-500', 'bg-purple-50');
            }
            updateSummary(file);
            showStatus('Tệp đã được chuẩn bị. Bấm "Nhập Excel" để tải lên.', 'info');
        };

        resetState();

        if (dropZone) {
            dropZone.addEventListener('click', () => fileInput.click());

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    dropZone.classList.add('ring-2', 'ring-purple-500', 'bg-purple-50');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    if (eventName === 'dragleave') {
                        dropZone.classList.remove('ring-2', 'ring-purple-500', 'bg-purple-50');
                    }
                });
            });

            dropZone.addEventListener('drop', (event) => {
                const files = event.dataTransfer?.files;
                if (files && files.length) {
                    if (typeof DataTransfer === 'undefined') {
                        try {
                            fileInput.files = files;
                        } catch (error) {
                            console.warn('Không thể gán FileList cho input:', error);
                        }
                    }
                    applyFile(files[0]);
                }
            });
        }

        fileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files && files.length) {
                applyFile(files[0]);
            } else {
                resetState();
            }
        });

        if (clearButton) {
            clearButton.addEventListener('click', (event) => {
                event.preventDefault();
                resetState();
            });
        }

        form.addEventListener('submit', () => {
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-75');
                const originalHtml = submitButton.dataset.originalHtml || submitButton.innerHTML;
                if (!submitButton.dataset.originalHtml) {
                    submitButton.dataset.originalHtml = originalHtml;
                }
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang tải lên';
            }
            showStatus('Đang xử lý file, vui lòng không rời khỏi trang...', 'info');
        });
    });
</script>
{% endblock %}
{% endblock %}
