{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}
{% from 'includes/_pagination.html' import render_pagination %}

{% block title %}Câu hỏi trong bộ: {{ quiz_set.title }}{% endblock %}

{% block head %}
    {{ super() }}
    {% include 'content_management/_shared_styles.html' %}
{% endblock %}

{% block content %}
<div class="cm-shell" data-accent="rose">
    <div class="cm-container space-y-6">
        <div class="cm-section-header">
            <div class="cm-heading-group">
                <a href="{{ url_for('content_management.content_dashboard', tab='quizzes') }}" class="cm-link text-sm">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span>Quay lại bảng điều khiển</span>
                </a>
                <span class="cm-eyebrow">Bộ câu hỏi</span>
                <h1 class="cm-heading">{{ quiz_set.title }}</h1>
                <p class="cm-subheading">{{ (quiz_set.description or 'Quản lý câu hỏi luyện tập, chỉnh sửa đáp án và giữ trải nghiệm kiểm tra mạch lạc.') | truncate(110, True, '…') }}</p>
                <div class="cm-chip-row">
                    <span class="cm-pill cm-pill--accent">
                        <i class="fa-solid fa-circle-question"></i>
                        {{ pagination.total }} câu hỏi
                    </span>
                    {% if can_edit %}
                    <span class="cm-pill cm-pill--neutral">
                        <i class="fa-solid fa-arrows-up-down"></i>
                        Kéo thả để sắp xếp
                    </span>
                    {% endif %}
                </div>
            </div>
            {% if can_edit %}
            <div class="cm-actions">
                <a href="{{ url_for('content_management.content_management_quizzes.add_quiz_item', set_id=quiz_set.container_id) }}"
                   data-modal-url="{{ url_for('content_management.content_management_quizzes.add_quiz_item', set_id=quiz_set.container_id) }}"
                   class="open-modal-btn cm-action cm-action--primary">
                    <i class="fas fa-plus-circle"></i>
                    <span>Thêm câu hỏi</span>
                </a>
                <a href="{{ url_for('content_management.content_management_quizzes.export_quiz_set', set_id=quiz_set.container_id) }}" class="cm-action cm-action--ghost">
                    <i class="fas fa-file-export"></i>
                    <span>Xuất gói ZIP</span>
                </a>
                <a href="{{ url_for('content_management.content_management_quizzes.manage_quiz_excel', set_id=quiz_set.container_id) }}" class="cm-action cm-action--ghost">
                    <i class="fas fa-table"></i>
                    <span>Cập nhật Excel</span>
                </a>
            </div>
            {% endif %}
        </div>

        <div class="cm-card cm-card--padded">
            {% set display_item_search_options = {
                'question': 'Câu hỏi',
                'option_a': 'Lựa chọn A',
                'option_b': 'Lựa chọn B',
                'option_c': 'Lựa chọn C',
                'option_d': 'Lựa chọn D',
                'correct_answer': 'Đáp án đúng',
                'guidance': 'Giải thích/Gợi ý',
                'pre_question_text': 'Văn bản trước câu hỏi',
                'passage_text': 'Đoạn văn',
                'question_image_file': 'Ảnh câu hỏi (URL)',
                'question_audio_file': 'Audio câu hỏi (URL)'
            } %}
            <div class="cm-search-header">
                <div class="cm-heading-group">
                    <h2 class="text-lg font-semibold text-slate-800">Tìm kiếm câu hỏi</h2>
                    <p class="cm-subheading text-sm">Kết hợp bộ lọc để cập nhật nội dung và đáp án phù hợp.</p>
                </div>
                <div class="w-full md:w-auto md:min-w-[320px]">
                    {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm câu hỏi...", set_id=quiz_set.container_id, search_field=search_field, search_options=display_item_search_options) }}
                </div>
            </div>
        </div>

        {% if quiz_items %}
        {% if can_edit %}
        <div class="cm-chip-row text-xs font-semibold">
            <span class="cm-pill cm-pill--accent">
                <i class="fa-solid fa-hand"></i>
                Kéo biểu tượng <i class="fa-solid fa-grip-lines"></i> để sắp xếp.
            </span>
            <div data-reorder-feedback class="hidden text-sm font-semibold"></div>
        </div>
        {% endif %}

        <div data-draggable-list
             data-can-edit="{{ 'true' if can_edit else 'false' }}"
             data-reorder-url="{{ url_for('content_management.content_management_quizzes.reorder_quiz_items', set_id=quiz_set.container_id) }}"
             data-start-order="{{ quiz_items[0].order_in_container if quiz_items else 1 }}"
             class="cm-grid cm-grid--three">
            {% for item in quiz_items %}
            <article class="cm-collection-card"
                     data-draggable-item
                     data-item-id="{{ item.item_id }}"
                     data-current-order="{{ item.order_in_container }}"
                     draggable="true">
                <div class="flex items-start justify-between gap-4">
                    <div class="space-y-3">
                        <div class="cm-chip-row text-xs font-semibold">
                            <span class="cm-pill cm-pill--accent">
                                <i class="fa-solid fa-circle-question"></i>
                                Câu hỏi #<span data-order-label>{{ item.order_in_container }}</span>
                            </span>
                            <span class="cm-pill cm-pill--neutral">
                                <i class="fa-solid fa-id-card-clip"></i>
                                ID {{ item.item_id }}
                            </span>
                        </div>
                        <h3 class="text-base font-semibold text-slate-900">{{ item.content.question }}</h3>
                        <div class="space-y-1 text-sm text-slate-600">
                            <p><span class="font-semibold text-slate-500">Đáp án đúng:</span> {{ item.content.correct_answer }}</p>
                            <ul class="list-disc space-y-1 pl-5 text-xs text-slate-500">
                                <li><span class="font-semibold text-slate-600">A:</span> {{ item.content.options.A }}</li>
                                <li><span class="font-semibold text-slate-600">B:</span> {{ item.content.options.B }}</li>
                                {% if item.content.options.C %}<li><span class="font-semibold text-slate-600">C:</span> {{ item.content.options.C }}</li>{% endif %}
                                {% if item.content.options.D %}<li><span class="font-semibold text-slate-600">D:</span> {{ item.content.options.D }}</li>{% endif %}
                            </ul>
                        </div>
                    </div>
                    {% if can_edit %}
                    <button type="button" class="cm-icon-button" data-drag-handle title="Giữ và kéo để sắp xếp">
                        <i class="fa-solid fa-grip-lines"></i>
                    </button>
                    {% endif %}
                </div>

                <div class="mt-4 space-y-2 text-xs text-slate-500">
                    {% if item.content.question_image_file %}
                    <span class="cm-tag">
                        <i class="fa-solid fa-image text-slate-400"></i>
                        Hình ảnh đính kèm
                    </span>
                    {% endif %}
                    {% if item.content.question_audio_file %}
                    <span class="cm-tag">
                        <i class="fa-solid fa-volume-high text-slate-400"></i>
                        Audio câu hỏi
                    </span>
                    {% endif %}
                    {% if item.content.explanation %}
                    <p class="rounded-2xl bg-slate-50 px-4 py-2 text-[0.75rem] text-slate-500">
                        <span class="font-semibold text-slate-600">Gợi ý/Giải thích:</span>
                        {{ item.content.explanation }}
                    </p>
                    {% endif %}
                    {% if item.ai_explanation %}
                    <p class="rounded-2xl bg-slate-50 px-4 py-2 text-[0.75rem] text-slate-500">
                        <span class="font-semibold text-slate-600">Giải thích AI:</span>
                        {{ item.ai_explanation }}
                    </p>
                    {% endif %}
                </div>

                <div class="cm-divider"></div>
                <div class="flex items-center justify-between">
                    <a href="{{ url_for('content_management.content_management_quizzes.edit_quiz_item', set_id=quiz_set.container_id, item_id=item.item_id) }}"
                       data-modal-url="{{ url_for('content_management.content_management_quizzes.edit_quiz_item', set_id=quiz_set.container_id, item_id=item.item_id) }}"
                       class="open-modal-btn cm-link">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <span>Mở trình chỉnh sửa</span>
                    </a>
                    {% if can_edit %}
                    <div class="cm-inline-actions">
                        <button type="button" data-modal-url="{{ url_for('content_management.content_management_quizzes.edit_quiz_item', set_id=quiz_set.container_id, item_id=item.item_id) }}" class="open-modal-btn cm-icon-button" title="Chỉnh sửa">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <form action="{{ url_for('content_management.content_management_quizzes.delete_quiz_item', set_id=quiz_set.container_id, item_id=item.item_id) }}" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn xóa câu hỏi này?');">
                            <button type="submit" class="cm-icon-button" title="Xoá câu hỏi">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        <div class="pt-6">
            {{ render_pagination(pagination=pagination, search_query=search_query, set_id=quiz_set.container_id, search_field=search_field) }}
        </div>

        {% else %}
        <div class="cm-empty">
            <span class="cm-empty-icon">
                <i class="fa-solid fa-circle-question"></i>
            </span>
            <p class="text-sm">Bộ quiz này chưa có câu hỏi nào hoặc không tìm thấy kết quả phù hợp.</p>
            {% if can_edit %}
            <a href="{{ url_for('content_management.content_management_quizzes.add_quiz_item', set_id=quiz_set.container_id) }}"
               data-modal-url="{{ url_for('content_management.content_management_quizzes.add_quiz_item', set_id=quiz_set.container_id) }}"
               class="open-modal-btn cm-action cm-action--primary">
                <i class="fas fa-plus-circle"></i>
                <span>Thêm câu hỏi đầu tiên</span>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        (function() {
            window.addEventListener('content-management:refresh', function(event) {
                const detail = event?.detail || {};
                if (detail.scope === 'quiz-item' && Number(detail.setId || detail.containerId) === {{ quiz_set.container_id }}) {
                    window.location.reload();
                }
            });

            const list = document.querySelector('[data-draggable-list]');
            if (!list || list.dataset.canEdit !== 'true') {
                return;
            }

            const reorderUrl = list.dataset.reorderUrl;
            if (!reorderUrl) {
                return;
            }

            const csrfToken = '{{ csrf_token() }}';
            const startOrder = parseInt(list.dataset.startOrder || '1', 10);
            const feedback = document.querySelector('[data-reorder-feedback]');
            let draggedItem = null;
            let feedbackTimeout = null;

            const setFeedback = (type, message) => {
                if (!feedback) return;
                clearTimeout(feedbackTimeout);
                feedback.textContent = message;
                feedback.classList.remove('hidden', 'text-slate-500', 'text-emerald-600', 'text-rose-600');
                const colorClass = type === 'success' ? 'text-emerald-600' : type === 'error' ? 'text-rose-600' : 'text-slate-500';
                feedback.classList.add(colorClass);
                feedbackTimeout = setTimeout(() => {
                    feedback.classList.add('hidden');
                    feedback.classList.remove(colorClass);
                }, 3500);
            };

            list.querySelectorAll('[data-drag-handle]').forEach(handle => {
                handle.setAttribute('draggable', 'false');
            });

            const getDragAfterElement = (container, y) => {
                const elements = [...container.querySelectorAll('[data-draggable-item]:not(.dragging)')];
                return elements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset, element: child };
                    }
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
            };

            list.addEventListener('dragstart', event => {
                const item = event.target.closest('[data-draggable-item]');
                if (!item || !event.target.closest('[data-drag-handle]')) {
                    event.preventDefault();
                    return;
                }
                draggedItem = item;
                item.classList.add('dragging', 'opacity-60', 'ring-2', 'ring-rose-200');
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', item.dataset.itemId);
            });

            const finalizeDrag = () => {
                if (!draggedItem) {
                    return;
                }
                draggedItem.classList.remove('dragging', 'opacity-60', 'ring-2', 'ring-rose-200');
                draggedItem = null;
            };

            list.addEventListener('dragend', finalizeDrag);
            list.addEventListener('drop', finalizeDrag);

            list.addEventListener('dragover', event => {
                event.preventDefault();
                if (!draggedItem) {
                    return;
                }
                const afterElement = getDragAfterElement(list, event.clientY);
                if (!afterElement) {
                    list.appendChild(draggedItem);
                } else {
                    list.insertBefore(draggedItem, afterElement);
                }
            });

            list.addEventListener('drop', async () => {
                const items = [...list.querySelectorAll('[data-draggable-item]')];
                const payload = items.map((item, index) => ({
                    item_id: item.dataset.itemId,
                    order_in_container: startOrder + index
                }));

                try {
                    const response = await fetch(reorderUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ items: payload })
                    });

                    if (!response.ok) {
                        throw new Error('Không thể cập nhật thứ tự câu hỏi.');
                    }

                    items.forEach((item, index) => {
                        const label = item.querySelector('[data-order-label]');
                        if (label) {
                            label.textContent = startOrder + index;
                        }
                    });

                    setFeedback('success', 'Đã cập nhật lại thứ tự câu hỏi.');
                } catch (error) {
                    console.error(error);
                    setFeedback('error', 'Không thể cập nhật thứ tự câu hỏi.');
                }
            });
        })();
    </script>
{% endblock %}
