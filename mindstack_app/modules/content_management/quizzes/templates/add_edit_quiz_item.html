<!-- File: newmindstack/mindstack_app/modules/content_management/templates/quizzes/add_edit_quiz_item.html -->
<!-- Phiên bản: 3.1 -->
<!-- MỤC ĐÍCH: Cập nhật template form để hỗ trợ các trường StringField thay vì URLField cho media. -->
<!-- ĐÃ SỬA: Sửa các trường `question_image_file` và `question_audio_file` để hiển thị đúng. -->

{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="flex justify-center">
    <div class="w-full md:w-2/3 lg:w-1/2">
        <div class="bg-white shadow-lg p-8 border border-gray-200 rounded-xl">
            {% set modal_suffix = '?is_modal=true' if is_modal_view else '' %}
            <div class="flex items-center justify-between mb-4">
                {% if previous_item_id %}
                <a href="{{ url_for('.edit_quiz_item', set_id=quiz_set.container_id, item_id=previous_item_id) }}{{ modal_suffix }}"
                   class="flex items-center px-3 py-2 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-md transition-colors">
                    <i class="fas fa-chevron-left mr-2"></i>
                    <span>Câu trước</span>
                </a>
                {% else %}
                <span></span>
                {% endif %}
                {% if next_item_id %}
                <a href="{{ url_for('.edit_quiz_item', set_id=quiz_set.container_id, item_id=next_item_id) }}{{ modal_suffix }}"
                   class="flex items-center px-3 py-2 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-md transition-colors">
                    <span>Câu tiếp</span>
                    <i class="fas fa-chevron-right ml-2"></i>
                </a>
                {% else %}
                <span></span>
                {% endif %}
            </div>
            <h2 class="text-2xl font-bold text-center mb-6 flex items-center justify-center">
                <i class="fas fa-plus-circle text-blue-500 mr-3"></i> {{ title }}
            </h2>
            <p class="text-center text-gray-600 mb-6">Điền thông tin dưới đây để {{ "tạo câu hỏi mới" if title == "Thêm Câu hỏi Quiz mới" else "sửa câu hỏi" }}.</p>

            <form action="" method="post" class="space-y-6"
                  id="quizItemForm"
                  data-image-base-folder="{{ image_base_folder or '' }}"
                  data-audio-base-folder="{{ audio_base_folder or '' }}">
                {{ form.csrf_token }}
                
                <div>
                    {{ form.question.label(class="block text-sm font-medium text-gray-700") }}
                    {{ form.question(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", rows="3", placeholder="Nội dung câu hỏi") }}
                    {% if form.question.errors %}
                        <div class="text-red-500 text-xs mt-1">
                            {% for error in form.question.errors %}<p>{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div>
                    {{ form.pre_question_text.label(class="block text-sm font-medium text-gray-700") }}
                    {{ form.pre_question_text(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", rows="2", placeholder="Văn bản/giới thiệu trước câu hỏi (nếu có)") }}
                    {% if form.pre_question_text.errors %}
                        <div class="text-red-500 text-xs mt-1">
                            {% for error in form.pre_question_text.errors %}<p>{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        {{ form.option_a.label(class="block text-sm font-medium text-gray-700") }}
                        {{ form.option_a(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="Lựa chọn A") }}
                        {% if form.option_a.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.option_a.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        {{ form.option_b.label(class="block text-sm font-medium text-gray-700") }}
                        {{ form.option_b(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="Lựa chọn B") }}
                        {% if form.option_b.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.option_b.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        {{ form.option_c.label(class="block text-sm font-medium text-gray-700") }}
                        {{ form.option_c(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="Lựa chọn C (tùy chọn)") }}
                        {% if form.option_c.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.option_c.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        {{ form.option_d.label(class="block text-sm font-medium text-gray-700") }}
                        {{ form.option_d(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="Lựa chọn D (tùy chọn)") }}
                        {% if form.option_d.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.option_d.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div>
                    {{ form.correct_answer_text.label(class="block text-sm font-medium text-gray-700") }}
                    {{ form.correct_answer_text(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500") }}
                    {% if form.correct_answer_text.errors %}
                        <div class="text-red-500 text-xs mt-1">
                            {% for error in form.correct_answer_text.errors %}<p>{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Thông tin bổ sung</h3>
                    <div>
                        {{ form.guidance.label(class="block text-sm font-medium text-gray-700") }}
                        {{ form.guidance(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", rows="3", placeholder="Gợi ý hoặc giải thích chi tiết cho câu hỏi") }}
                        {% if form.guidance.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.guidance.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div data-role="quiz-image-field" data-initial-url="{{ image_preview_url or '' }}">
                            {{ form.question_image_file.label(class="block text-sm font-medium text-gray-700") }}
                            <div class="mt-2 space-y-3">
                                {{ form.question_image_file(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="URL hình ảnh câu hỏi hoặc đường dẫn tương đối", **{'data-role': 'quiz-image-input'}) }}
                                <div class="relative border border-dashed border-gray-300 rounded-lg overflow-hidden bg-gray-50">
                                    <img data-role="quiz-image-preview" src="{{ image_preview_url or '' }}" alt="Xem trước hình ảnh" class="w-full max-h-64 object-contain{% if not image_preview_url %} hidden{% endif %}">
                                    <div data-role="quiz-image-placeholder" class="flex items-center justify-center text-sm text-gray-400 py-12{% if image_preview_url %} hidden{% endif %}">
                                        Chưa có ảnh để xem trước.
                                    </div>
                                </div>
                                <button type="button" data-role="quiz-open-image" class="text-sm text-blue-600 hover:text-blue-800 transition-colors duration-200 flex items-center gap-2{% if not image_preview_url %} hidden{% endif %}">
                                    <i class="fas fa-external-link-alt"></i>
                                    <span>Mở ảnh trong tab mới</span>
                                </button>
                                <p class="text-xs text-gray-500" data-role="quiz-image-status"></p>
                            </div>
                            {% if form.question_image_file.errors %}
                                <div class="text-red-500 text-xs mt-1">
                                    {% for error in form.question_image_file.errors %}<p>{{ error }}</p>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div data-role="quiz-audio-field" data-initial-url="{{ audio_preview_url or '' }}">
                            {{ form.question_audio_file.label(class="block text-sm font-medium text-gray-700") }}
                            <div class="mt-2 space-y-3">
                                {{ form.question_audio_file(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="URL file âm thanh câu hỏi hoặc đường dẫn tương đối", **{'data-role': 'quiz-audio-input'}) }}
                                <div class="border border-gray-200 rounded-lg bg-gray-50 p-4">
                                    <audio controls data-role="quiz-audio-player" class="w-full{% if not audio_preview_url %} hidden{% endif %}">
                                        {% if audio_preview_url %}<source src="{{ audio_preview_url }}">{% endif %}
                                    </audio>
                                    <div data-role="quiz-audio-placeholder" class="text-sm text-gray-400 text-center{% if audio_preview_url %} hidden{% endif %}">
                                        Chưa có audio để nghe thử.
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500" data-role="quiz-audio-status"></p>
                            </div>
                            {% if form.question_audio_file.errors %}
                                <div class="text-red-500 text-xs mt-1">
                                    {% for error in form.question_audio_file.errors %}<p>{{ error }}</p>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mt-4">
                        {{ form.group_id.label(class="block text-sm font-medium text-gray-700") }}
                        {{ form.group_id(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="Nhập ID group nếu câu hỏi thuộc nhóm") }}
                        {% if form.group_id.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.group_id.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mt-4">
                        {{ form.group_item_order.label(class="block text-sm font-medium text-gray-700") }}
                        {{ form.group_item_order(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="Thứ tự của câu trong group") }}
                        {% if form.group_item_order.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.group_item_order.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mt-4">
                        {{ form.group_shared_components.label(class="block text-sm font-medium text-gray-700") }}
                        {{ form.group_shared_components(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder="VD: image,audio,explanation,prompt") }}
                        {% if form.group_shared_components.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.group_shared_components.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    {{ form.ai_prompt.label(class="block text-sm font-medium text-gray-700") }}
                    <p class="text-xs text-gray-500 mb-2">{{ form.ai_prompt.description }}</p>
                    {{ form.ai_prompt(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500", rows="3", placeholder="Nhập prompt tùy chỉnh...") }}
                    {% if form.ai_prompt.errors %}
                        <div class="text-red-500 text-xs mt-1">
                            {% for error in form.ai_prompt.errors %}<p>{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                </div>

                {# Trường ai_explanation chỉ để hiển thị, không cho sửa trực tiếp #}
                {% if form.ai_explanation.data %}
                <div class="border-t border-gray-200 pt-6">
                    {{ form.ai_explanation.label(class="block text-sm font-medium text-gray-700") }}
                    {{ form.ai_explanation(class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 focus:outline-none", rows="5") }}
                </div>
                {% endif %}

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="window.history.back()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400 transition duration-300 flex items-center">
                        <i class="fas fa-times mr-2"></i> Hủy
                    </button>
                    {{ form.submit(class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition duration-300 flex items-center") }}
                </div>
            </form>

            {% if quiz_item and move_targets %}
            <div class="border-t border-gray-200 pt-6 mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Di chuyển câu hỏi sang bộ khác</h3>
                <form method="post" action="{{ url_for('.move_quiz_item', set_id=quiz_set.container_id, item_id=quiz_item.item_id) }}" class="flex flex-col md:flex-row gap-3 items-start md:items-end">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="w-full md:w-2/3">
                        <label for="move_quiz_target" class="block text-sm font-medium text-gray-700">Chọn bộ Quiz đích</label>
                        <select id="move_quiz_target" name="target_set_id" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Chọn bộ Quiz --</option>
                            {% for target in move_targets %}
                                <option value="{{ target.container_id }}">{{ target.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition duration-300 flex items-center">
                        <i class="fas fa-share mr-2"></i> Di chuyển câu hỏi
                    </button>
                </form>
                <p class="text-xs text-gray-500 mt-2">Câu hỏi sẽ được thêm vào cuối cùng của bộ Quiz được chọn.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {% include '_quiz_media_scripts.html' %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.initializeQuizMediaControls) {
                window.initializeQuizMediaControls({ formSelector: '#quizItemForm' });
            }
        });
    </script>
{% endblock %}