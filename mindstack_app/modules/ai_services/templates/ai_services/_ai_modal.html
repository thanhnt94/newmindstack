{#
    # File: mindstack_app/modules/ai_services/templates/ai_services/_ai_modal.html
    # Phiên bản: 2.1
    # TÍNH NĂNG: Cung cấp modal để hiển thị các chức năng AI (giải thích, ví dụ, v.v.).
    # ĐÃ SỬA: Sửa lỗi BuildError bằng cách trỏ url_for đến đúng endpoint 'ai_services.get_ai_response'.
#}
<div id="ai-modal" class="custom-modal-overlay">
    <div class="custom-modal-content !max-w-2xl w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Mindstack AI</h3>
            <button id="close-ai-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div class="text-left space-y-4">
            <h4 id="ai-modal-term" class="text-sm font-semibold text-purple-600"></h4>
            <div id="ai-response-container" class="markdown-body bg-gray-50 p-4 rounded-md min-h-[150px] max-h-[40vh] overflow-y-auto">
                <div class="text-gray-500">Câu trả lời của AI sẽ xuất hiện ở đây.</div>
            </div>
        </div>
    </div>
</div>

<script>
let currentAiItemId = null

/**
 * Mô tả: Mở modal AI và thiết lập các thông tin cần thiết.
 * @param {string} itemId - ID của học liệu đang được yêu cầu hỗ trợ.
 * @param {string} termContent - Nội dung mặt trước của thẻ.
 */
function openAiModal(itemId, termContent) {
    const aiModal = document.getElementById('ai-modal')
    if (!aiModal || aiModal.style.display === 'flex') return

    const aiModalTerm = document.getElementById('ai-modal-term')
    const aiResponseContainer = document.getElementById('ai-response-container')

    currentAiItemId = itemId
    if(aiModalTerm) aiModalTerm.textContent = termContent

    aiModal.style.display = 'flex'
    fetchAiResponse()
}

/**
 * Mô tả: Đóng modal AI và reset trạng thái.
 */
function closeAiModal() {
    const aiModal = document.getElementById('ai-modal')
    if (aiModal) {
        aiModal.style.display = 'none'
    }
    currentAiItemId = null
    const aiResponseContainer = document.getElementById('ai-response-container')
    if (aiResponseContainer) {
        aiResponseContainer.innerHTML = `<div class="text-gray-500">Câu trả lời của AI sẽ xuất hiện ở đây.</div>`
    }
}

/**
 * Mô tả: Gửi yêu cầu đến server để nhận phản hồi từ AI.
 */
async function fetchAiResponse() {
    const aiResponseContainer = document.getElementById('ai-response-container')
    if (!currentAiItemId || !aiResponseContainer) return

    aiResponseContainer.innerHTML = `<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin text-2xl text-purple-500"></i><span class="ml-3 text-gray-600">AI đang suy nghĩ...</span></div>`

    try {
        // SỬA LỖI: Đổi 'get_ai_support' thành 'get_ai_response' cho đúng với tên route
        const response = await fetch("{{ url_for('ai_services.get_ai_response') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({
                item_id: currentAiItemId,
                prompt_type: 'explanation'
            })
        })
        const result = await response.json()
        if (response.ok && result.success) {
            const rawContent = result.html_content || result.response || ''
            if (window.applyMarkdownToElement) {
                window.applyMarkdownToElement(aiResponseContainer, rawContent, { treatAsHtml: Boolean(result.html_content) })
            } else {
                aiResponseContainer.innerHTML = rawContent
            }
        } else {
            aiResponseContainer.innerHTML = `<p class="text-red-500">${result.message || 'Có lỗi xảy ra.'}</p>`
        }
    } catch (error) {
        console.error('Lỗi khi gọi AI:', error)
        aiResponseContainer.innerHTML = `<p class="text-red-500">Lỗi kết nối. Không thể nhận phản hồi từ AI.</p>`
    }
}

// Gắn event listener khi DOM sẵn sàng
document.addEventListener('DOMContentLoaded', function() {
    const closeBtn = document.getElementById('close-ai-modal-btn')
    if (closeBtn) {
        closeBtn.addEventListener('click', closeAiModal)
    }

})
</script>
