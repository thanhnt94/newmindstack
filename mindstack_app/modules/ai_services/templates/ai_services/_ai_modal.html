{#
    File: mindstack_app/templates/includes/_ai_modal.html
    Phiên bản: 1.4
    Mục đích: Template cho modal (cửa sổ) chung để tương tác với Trợ lý AI.
              ĐÃ SỬA: Loại bỏ khai báo biến trùng lặp.
#}
<style>
    .ai-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .ai-modal-overlay.open {
        display: flex;
        opacity: 1;
    }
    .ai-modal-content {
        background-color: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }
    .ai-modal-overlay.open .ai-modal-content {
        transform: scale(1);
    }
    .ai-modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .ai-modal-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .ai-modal-header .close-button {
        font-size: 1.5rem;
        color: #6b7280;
        cursor: pointer;
        background: none;
        border: none;
    }
    .ai-modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex-grow: 1;
    }
    .ai-prompt-buttons {
        display: none; /* Ẩn các nút prompt */
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }
    .ai-prompt-btn {
        background-color: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .ai-prompt-btn:hover {
        background-color: #e5e7eb;
        border-color: #9ca3af;
    }
    .ai-custom-prompt-area {
        display: none; /* Ẩn ô nhập prompt tùy chỉnh */
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        resize: vertical;
        min-height: 80px;
    }
    .ai-response-area {
        margin-top: 1.5rem;
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        min-height: 100px;
        font-family: 'Inter', sans-serif;
        line-height: 1.6;
        color: #374151;
    }
    .ai-loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
    }
    .ai-loading-spinner i {
        margin-right: 0.5rem;
    }
</style>

<div id="ai-modal" class="ai-modal-overlay">
    <div class="ai-modal-content">
        <div class="ai-modal-header">
            <h2><i class="fas fa-robot text-blue-500"></i> Trợ lý AI</h2>
            <button id="ai-modal-close-btn" class="close-button">&times;</button>
        </div>
        <div class="ai-modal-body">
            <p class="text-gray-600 mb-2">Hỏi AI về thẻ này:</p>
            <p class="text-lg font-semibold text-gray-800 mb-4" id="ai-modal-term">Đang tải...</p>
            
            <div class="ai-prompt-buttons">
                <button class="ai-prompt-btn" data-prompt-type="explain">Giải thích</button>
                <button class="ai-prompt-btn" data-prompt-type="example">Cho ví dụ</button>
            </div>

            <textarea id="ai-custom-prompt" class="ai-custom-prompt-area" placeholder="Hoặc nhập câu hỏi của riêng bạn..."></textarea>
            
            <div id="ai-response-container" class="ai-response-area">
                <div class="text-gray-500">Câu trả lời của AI sẽ xuất hiện ở đây.</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const aiModal = document.getElementById('ai-modal');
    const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
    const aiModalTerm = document.getElementById('ai-modal-term');
    const aiResponseContainer = document.getElementById('ai-response-container');
    const getAiResponseUrl = "{{ url_for('ai_services.get_ai_response') }}";
    
    let currentAiItemId = null;
    
    // Hàm này sẽ được gọi từ trang cha
    window.openAiModal = function(itemId, termContent, itemContent) {
        currentAiItemId = itemId;
        aiModalTerm.textContent = termContent; // Sử dụng dữ liệu từ trang cha
        aiModal.classList.add('open');
        
        fetchAiResponse('explanation', itemContent);
    };

    function closeAiModal() {
        aiModal.classList.remove('open');
        currentAiItemId = null;
        aiResponseContainer.innerHTML = `<div class="text-gray-500">Câu trả lời của AI sẽ xuất hiện ở đây.</div>`; // Reset nội dung
    }

    async function fetchAiResponse(promptType, itemContent) {
        if (!currentAiItemId) return;

        aiResponseContainer.innerHTML = `
            <div class="ai-loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>AI đang suy nghĩ...</span>
            </div>`;

        try {
            const response = await fetch(getAiResponseUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_id: currentAiItemId,
                    prompt_type: promptType,
                    custom_question: itemContent
                })
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                aiResponseContainer.innerHTML = marked.parse(result.response);
            } else {
                aiResponseContainer.innerHTML = `<p class="text-red-500">Lỗi: ${result.message || 'Không thể nhận phản hồi từ AI.'}</p>`;
            }
        } catch (error) {
            console.error('Lỗi khi gọi API AI:', error);
            aiResponseContainer.innerHTML = `<p class="text-red-500">Lỗi kết nối đến máy chủ AI.</p>`;
        }
    }

    aiModalCloseBtn.addEventListener('click', closeAiModal);
    aiModal.addEventListener('click', (event) => {
        if (event.target === aiModal) {
            closeAiModal();
        }
    });

</script>