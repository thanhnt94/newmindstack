<!-- mindstack_app/modules/learning/quiz_learning/templates/quiz_session.html -->
<!-- Phiên bản: 2.4 -->
<!-- MỤC ĐÍCH: Sửa lỗi không hiển thị media (hình ảnh, audio) và nâng cấp tính năng tự động tạo giải thích AI. -->

{% extends "base.html" %}

{% block title %}Làm bài Quiz{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .quiz-card {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .question-card {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border-width: 1px;
            border-color: #e5e7eb;
            margin-bottom: 1.5rem;
        }
        .option-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem;
            border-width: 1px;
            border-color: #d1d5db;
            border-radius: 0.5rem;
            text-align: left;
            color: #1f2937;
            transition-property: all;
            transition-duration: 200ms;
            background-color: #ffffff;
            cursor: pointer;
        }
        .option-button:hover {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }
        .option-button.selected {
            background-color: #dbeafe;
            border-color: #2563eb;
        }
        .option-button.correct {
            background-color: #dcfce7;
            border-color: #16a34a;
        }
        .option-button.incorrect {
            background-color: #fee2e2;
            border-color: #dc2626;
        }
        .feedback-box {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
        }
        .feedback-correct {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .feedback-incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .feedback-explanation {
            background-color: #f3f4f6;
            color: #1f2937;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        .control-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition-property: all;
            transition-duration: 300ms;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .quiz-image {
            display: block;
            margin-left: auto;
            margin-right: auto;
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: zoom-in;
        }
        
        /* Cập nhật CSS cho thanh công cụ */
        .question-toolbar {
            display: flex; /* Sửa: Luôn hiển thị thanh toolbar */
            justify-content: flex-end;
            gap: 0.5rem;
            padding-top: 1rem;
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .toolbar-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .extra-info-area {
            display: none; /* Ẩn mặc định */
            margin-top: 1rem;
            space-y: 1rem;
        }
        .info-section {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        .info-section h4 {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Căn lề cho nút Sửa */
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .info-section .content-display {
            color: #374151;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 50px; /* Chiều cao tối thiểu */
        }
        .note-textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            resize: vertical;
        }
        /* CSS để gộp và căn chỉnh các nút công cụ */
        .quiz-action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .quiz-action-buttons .toolbar-btn {
            flex-shrink: 0;
        }
        /* THÊM MỚI: CSS để ẩn modal feedback theo mặc định */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .custom-modal-overlay.open {
            display: flex;
        }
        .custom-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            max-width: 400px;
        }

        /* Thêm Media Query để tối ưu cho di động */
        @media (max-width: 640px) {
            .main-quiz-container {
                padding: 0 !important; /* Đã sửa: Giảm padding ra sát màn hình */
            }
            .quiz-card {
                padding: 0.25rem !important;
                border-radius: 0 !important; /* Đã sửa: Xóa bo tròn để sát viền hơn */
            }
            .question-card {
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            h1.text-3xl {
                font-size: 1.5rem !important;
            }
            #quiz-progress.text-xl {
                font-size: 1rem !important;
            }
            .question-card h2.text-xl {
                font-size: 1rem !important;
            }
            .option-button {
                padding: 0.5rem !important;
                font-size: 0.875rem !important;
            }
            .option-button span {
                white-space: normal !important;
            }
            .feedback-box {
                padding: 0.5rem !important;
            }
            .feedback-explanation {
                padding: 0.5rem !important;
            }
            .quiz-controls {
                gap: 0.25rem !important;
            }
            .control-button {
                padding: 0.75rem 1rem !important; /* Tăng padding để nút to hơn */
                font-size: 0.875rem !important; /* Tăng font size */
                flex-grow: 1 !important; /* Mở rộng nút để chiếm hết không gian */
            }
            .control-button-text {
                display: inline !important; /* Hiển thị lại chữ */
            }
            .question-toolbar {
                gap: 0.25rem !important;
            }
            .toolbar-btn {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.5rem !important;
            }
            .toolbar-btn span {
                display: none;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="w-full px-4 py-4 sm:px-6 sm:py-6 lg:px-8 lg:py-8 main-quiz-container">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 sm:mb-8 text-center">
        Làm bài Quiz
        <span id="quiz-progress" class="text-gray-500 text-xl"></span>
    </h1>

    <div class="bg-white rounded-xl shadow-md p-6 quiz-card">
        <div id="quiz-content" class="flex-grow">
            <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]">
                <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                <p>Đang tải câu hỏi...</p>
            </div>
        </div>

        <div id="quiz-controls" class="mt-6 flex justify-between items-center quiz-controls">
            <button id="end-session-btn" class="control-button bg-gray-300 text-gray-800 hover:bg-gray-400">
                <i class="fas fa-times-circle mr-2"></i> <span class="control-button-text">Kết thúc</span>
            </button>
            <button id="submit-batch-btn" class="control-button bg-blue-600 text-white hover:bg-blue-700">
                <i class="fas fa-paper-plane mr-2"></i> <span class="control-button-text">Gửi đáp án</span>
            </button>
            <button id="next-batch-btn" class="control-button bg-green-600 text-white hover:bg-green-700" style="display: none;">
                <i class="fas fa-arrow-right mr-2"></i> <span class="control-button-text">Tiếp theo</span>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        let currentQuestionBatch = [];
        let currentBatchMeta = { startIndex: 0, totalItemsInSession: 0 };
        let userAnswers = {};
        let isBatchSubmitted = false;

        const quizContentDiv = document.getElementById('quiz-content');
        const quizProgressSpan = document.getElementById('quiz-progress');
        const submitBatchBtn = document.getElementById('submit-batch-btn');
        const nextBatchBtn = document.getElementById('next-batch-btn');
        const endSessionBtn = document.getElementById('end-session-btn');
        
        const getQuestionBatchUrl = "{{ url_for('learning.quiz_learning.get_question_batch') }}";
        const submitAnswerBatchUrl = "{{ url_for('learning.quiz_learning.submit_answer_batch') }}";
        const endSessionUrl = "{{ url_for('learning.quiz_learning.end_session') }}";
        const saveNoteUrl = "{{ url_for('notes.save_note', item_id=0) }}";
        const getAiResponseUrl = "{{ url_for('ai_services.get_ai_response') }}"; // URL mới cho AI
        const editQuizItemUrl = "{{ url_for('content_management.content_management_quizzes.edit_quiz_item', set_id=0, item_id=0) }}";
        const quizItemApiBaseUrl = "{{ url_for('learning.quiz_learning.get_quiz_item_api', item_id=0) }}";

        const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
        const csrfHeaders = csrfToken ? { 'X-CSRFToken': csrfToken } : {};

        function formatTextForHtml(text) {
            if (text === null || text === undefined) return '';
            const tempDiv = document.createElement('div');
            tempDiv.textContent = text;
            return tempDiv.innerHTML.replace(/\r?\n/g, '<br>');
        }

        function renderMarkdownContent(text, options = {}) {
            if (text === null || text === undefined) return '';
            if (window.renderMarkdown) {
                return window.renderMarkdown(text, options);
            }
            return formatTextForHtml(String(text));
        }

        function setMarkdownContent(element, text, options = {}) {
            if (!element) return;
            if (window.applyMarkdownToElement) {
                window.applyMarkdownToElement(element, text, options);
            } else {
                element.innerHTML = renderMarkdownContent(text, options);
                element.classList.add('markdown-body');
            }
        }

        function buildQuestionCardHtml(questionData, index, batchMeta) {
            const questionNumber = (batchMeta.startIndex || 0) + index + 1;
            const totalQuestions = batchMeta.totalItemsInSession || questionNumber;
            const content = questionData.content || {};
            let optionsHtml = '';
            const options = content.options || {};
            ['A', 'B', 'C', 'D'].forEach(key => {
                if (options[key]) {
                    optionsHtml += `<button class="option-button" data-question-id="${questionData.item_id}" data-option="${key}"><span class="font-bold mr-2">${key}:</span> <span>${formatTextForHtml(options[key])}</span></button>`;
                }
            });

            let mediaHtml = '';
            if (content.question_image_file) {
                mediaHtml += `<img src="${formatTextForHtml(content.question_image_file)}" alt="Hình ảnh câu hỏi" class="quiz-image my-4">`;
            }
            if (content.question_audio_file) {
                mediaHtml += `<audio controls src="${formatTextForHtml(content.question_audio_file)}" class="w-full mb-4"></audio>`;
            }

            const aiExplanationHtml = questionData.ai_explanation
                ? renderMarkdownContent(questionData.ai_explanation)
                : '<span class="italic text-gray-500">Chưa có giải thích từ AI.</span>';

            const noteContentHtml = questionData.note_content
                ? formatTextForHtml(questionData.note_content)
                : '<span class="italic text-gray-500">Bạn chưa có ghi chú.</span>';

            return `
                <div class="question-card" data-item-id="${questionData.item_id}">
                    <p class="text-gray-500 text-sm mb-2">Câu ${questionNumber} / ${totalQuestions}</p>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">${formatTextForHtml(content.question)}</h2>
                    ${mediaHtml}
                    <div class="options-container space-y-3">${optionsHtml}</div>
                    <div class="feedback-area mt-4"></div>

                    <div class="extra-info-area">
                        <div class="user-note-section info-section mb-4" style="display: none;">
                            <h4>
                                <span><i class="fas fa-sticky-note text-yellow-500"></i> Ghi chú của bạn</span>
                                <button class="toolbar-btn edit-note-btn"><i class="fas fa-pencil-alt"></i> Sửa</button>
                            </h4>
                            <div class="note-view-mode">
                                <div class="content-display note-content-display">${noteContentHtml}</div>
                            </div>
                            <div class="note-edit-mode" style="display:none;">
                                <textarea class="note-textarea">${questionData.note_content || ''}</textarea>
                                <div class="flex justify-end mt-2 space-x-2">
                                    <button class="bg-gray-200 text-gray-800 px-4 py-1 rounded-md text-sm cancel-note-btn">Hủy</button>
                                    <button class="bg-green-600 text-white px-4 py-1 rounded-md text-sm save-note-btn">Lưu</button>
                                </div>
                            </div>
                        </div>
                        <div class="ai-explanation-section info-section" style="display: none;">
                            <h4><i class="fas fa-robot text-blue-500"></i> Giải thích của AI</h4>
                            <div class="content-display markdown-body">${aiExplanationHtml}</div>
                        </div>
                    </div>

                    <div class="question-toolbar flex justify-end gap-2">
                        <button class="toolbar-btn toggle-ai-btn" style="display: none;"><i class="fas fa-robot"></i> <span>Giải thích AI</span></button>
                        <button class="toolbar-btn open-feedback-modal-btn" data-item-id="${questionData.item_id}" data-item-title="${content.question}"><i class="fas fa-flag"></i> <span>Phản hồi</span></button>
                        <button class="toolbar-btn edit-quiz-btn" data-item-id="${questionData.item_id}" data-set-id="${questionData.container_id}"><i class="fas fa-pencil-alt"></i> <span>Sửa</span></button>
                    </div>
                </div>
            `;
        }

        function attachOptionHandlers(scopeElement = quizContentDiv) {
            scopeElement.querySelectorAll('.option-button').forEach(button => {
                button.addEventListener('click', function() {
                    if (!isBatchSubmitted) {
                        const questionId = this.dataset.questionId;
                        quizContentDiv.querySelectorAll(`.option-button[data-question-id="${questionId}"]`).forEach(btn => btn.classList.remove('selected'));
                        this.classList.add('selected');
                        userAnswers[questionId] = this.dataset.option;
                    }
                });
            });
        }

        function displayQuestionBatch(batchData) {
            currentQuestionBatch = batchData.items;
            currentBatchMeta = {
                startIndex: batchData.start_index || 0,
                totalItemsInSession: batchData.total_items_in_session || batchData.items.length
            };
            userAnswers = {};
            isBatchSubmitted = false;
            submitBatchBtn.style.display = 'block';
            submitBatchBtn.disabled = false;
            nextBatchBtn.style.display = 'none';

            const fullBatchContentHtml = currentQuestionBatch
                .map((questionData, index) => buildQuestionCardHtml(questionData, index, currentBatchMeta))
                .join('');

            quizContentDiv.innerHTML = fullBatchContentHtml;
            quizProgressSpan.textContent = `(${currentBatchMeta.startIndex + 1}-${currentBatchMeta.startIndex + currentQuestionBatch.length} / ${currentBatchMeta.totalItemsInSession})`;

            attachOptionHandlers(quizContentDiv);
        }

        async function submitAnswerBatch() {
            if (isBatchSubmitted) return;
            const allAnswered = currentQuestionBatch.every(q => userAnswers.hasOwnProperty(q.item_id));
            if (!allAnswered) {
                showCustomAlert("Vui lòng trả lời tất cả các câu hỏi trong nhóm.");
                return;
            }

            isBatchSubmitted = true;
            submitBatchBtn.disabled = true;

            const answersToSend = Object.keys(userAnswers).map(itemId => ({
                item_id: parseInt(itemId),
                user_answer: userAnswers[itemId]
            }));

            try {
                const response = await fetch(submitAnswerBatchUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json', ...csrfHeaders },
                     body: JSON.stringify({ answers: answersToSend })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const responseData = await response.json();

                responseData.results.forEach(result => {
                    const questionCard = document.querySelector(`.question-card[data-item-id="${result.item_id}"]`);
                    if (questionCard) {
                        const feedbackArea = questionCard.querySelector('.feedback-area');
                        let feedbackHtml = result.is_correct ? `<div class="feedback-box feedback-correct">Đáp án chính xác!</div>` : `<div class="feedback-box feedback-incorrect">Sai rồi. Đáp án đúng là ${formatTextForHtml(result.correct_answer)}.</div>`;
                        if (result.explanation) {
                            feedbackHtml += `<div class="feedback-explanation"><strong>Giải thích:</strong> <div class="feedback-explanation-content mt-2"></div></div>`;
                        }
                        feedbackArea.innerHTML = feedbackHtml;

                        if (result.explanation) {
                            const explanationContent = feedbackArea.querySelector('.feedback-explanation-content');
                            setMarkdownContent(explanationContent, result.explanation);
                        }

                        questionCard.querySelectorAll('.option-button').forEach(button => {
                            button.classList.remove('selected');
                            if (button.dataset.option === result.correct_answer) button.classList.add('correct');
                            else if (button.dataset.option === userAnswers[result.item_id] && !result.is_correct) button.classList.add('incorrect');
                            button.disabled = true;
                        });
                        
                        questionCard.querySelector('.question-toolbar').style.display = 'flex';
                        questionCard.querySelector('.extra-info-area').style.display = 'block';
                        questionCard.querySelector('.user-note-section').style.display = 'block';
                        questionCard.querySelector('.toggle-ai-btn').style.display = 'inline-flex';
                    }
                });

                submitBatchBtn.style.display = 'none';
                nextBatchBtn.style.display = 'block';

            } catch (error) {
                showCustomAlert('Có lỗi xảy ra khi gửi đáp án.');
                isBatchSubmitted = false;
                submitBatchBtn.disabled = false;
            }
        }
        
        async function getNextQuestionBatch() {
            quizContentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải câu hỏi...</p></div>`;
            submitBatchBtn.disabled = true;
            nextBatchBtn.style.display = 'none';
            try {
                const response = await fetch(getQuestionBatchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) {
                    if (response.status === 404) {
                        const endMessage = await response.json();
                        quizContentDiv.innerHTML = `<div class="text-center py-12 px-6 text-gray-600"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h3 class="text-xl font-semibold text-gray-700 mb-2">Hoàn thành phiên học!</h3><p class="text-gray-500">${formatTextForHtml(endMessage.message)}</p><button id="return-to-dashboard-btn" class="control-button bg-blue-600 text-white hover:bg-blue-700 mt-6"><i class="fas fa-home mr-2"></i> Quay lại Dashboard</button></div>`;
                        quizProgressSpan.textContent = '';
                        submitBatchBtn.style.display = 'none';
                        nextBatchBtn.style.display = 'none';
                        endSessionBtn.style.display = 'none';
                        document.getElementById('return-to-dashboard-btn').addEventListener('click', () => window.location.href = "{{ url_for('learning.quiz_learning.quiz_learning_dashboard') }}");
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const batchData = await response.json();
                displayQuestionBatch(batchData);
            }
            catch (error) {
                console.error('Lỗi khi tải nhóm câu hỏi:', error);
                quizContentDiv.innerHTML = `<p class="text-red-500 text-center">Không thể tải câu hỏi. Vui lòng thử lại.</p>`;
                submitBatchBtn.disabled = false;
                submitBatchBtn.style.display = 'block';
            }
        }
        
        endSessionBtn.addEventListener('click', () => showCustomConfirm('Bạn có chắc chắn muốn kết thúc phiên học hiện tại?', async () => { /* ... */ }));
        function showCustomAlert(message) { /* ... */ }
        function showCustomConfirm(message, onConfirm) { /* ... */ }
        
        submitBatchBtn.addEventListener('click', submitAnswerBatch);
        nextBatchBtn.addEventListener('click', getNextQuestionBatch);
        document.addEventListener('DOMContentLoaded', getNextQuestionBatch);

        window.updateQuizQuestion = async function(itemId, setId) {
            if (!itemId) {
                return;
            }

            try {
                const response = await fetch(quizItemApiBaseUrl.replace('/0', `/${itemId}`), {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const payload = await response.json();
                if (!payload.success || !payload.item) {
                    throw new Error(payload.message || 'Không nhận được dữ liệu câu hỏi hợp lệ.');
                }

                const updatedItem = payload.item;
                const questionIndex = currentQuestionBatch.findIndex(q => q.item_id === updatedItem.item_id);
                if (questionIndex !== -1) {
                    currentQuestionBatch[questionIndex] = updatedItem;
                } else {
                    currentQuestionBatch.push(updatedItem);
                }

                delete userAnswers[itemId];
                delete userAnswers[String(itemId)];

                const questionCard = document.querySelector(`.question-card[data-item-id="${itemId}"]`);
                const renderIndex = questionIndex !== -1 ? questionIndex : currentQuestionBatch.length - 1;
                const newHtml = buildQuestionCardHtml(updatedItem, renderIndex, currentBatchMeta);
                const tempWrapper = document.createElement('div');
                tempWrapper.innerHTML = newHtml.trim();
                const newElement = tempWrapper.firstElementChild;

                if (questionCard) {
                    questionCard.replaceWith(newElement);
                } else {
                    quizContentDiv.appendChild(newElement);
                }

                attachOptionHandlers(newElement);

                if (window.showFlashMessage) {
                    window.showFlashMessage('Câu hỏi đã được cập nhật thành công!', 'success');
                }
            } catch (error) {
                console.error('Không thể tải lại câu hỏi sau khi chỉnh sửa:', error);
                if (window.showFlashMessage) {
                    window.showFlashMessage('Không thể tải lại câu hỏi sau khi chỉnh sửa. Vui lòng tải lại trang để cập nhật thay đổi.', 'warning');
                } else {
                    alert('Không thể tải lại câu hỏi sau khi chỉnh sửa. Vui lòng tải lại trang.');
                }
            }
        };

        // ==========================================================
        // SCRIPT ĐÃ CẬP NHẬT HOÀN TOÀN
        // ==========================================================
        quizContentDiv.addEventListener('click', async function(event) {
            const questionCard = event.target.closest('.question-card');
            if (!questionCard) return;
            const itemId = questionCard.dataset.itemId;

            // Xử lý nút bật/tắt giải thích AI
            if (event.target.closest('.toggle-ai-btn')) {
                const aiSection = questionCard.querySelector('.ai-explanation-section');
                const contentDisplay = aiSection.querySelector('.content-display');
                const placeholderText = "Chưa có giải thích từ AI.";

                // Nếu đang ẩn thì bật lên
                if (aiSection.style.display === 'none') {
                    aiSection.style.display = 'block';

                    // Nếu nội dung là placeholder, gọi API để tạo mới
                    if (contentDisplay.textContent.trim() === placeholderText) {
                        contentDisplay.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo giải thích...';
                        try {
                            const response = await fetch(getAiResponseUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', ...csrfHeaders },
                                body: JSON.stringify({ item_id: itemId, prompt_type: 'explanation' })
                            });
                            const result = await response.json();
                            if (result.success) {
                                const rawResponse = result.html_content || result.response || '';
                                setMarkdownContent(contentDisplay, rawResponse, { treatAsHtml: Boolean(result.html_content) });
                                // Cập nhật lại dữ liệu trong JS object để không phải gọi lại
                                const questionInBatch = currentQuestionBatch.find(q => q.item_id == itemId);
                                if (questionInBatch) questionInBatch.ai_explanation = result.response || result.html_content || '';
                            } else {
                                contentDisplay.innerHTML = `<span class="italic text-red-500">${result.message || 'Lỗi khi tạo giải thích.'}</span>`;
                            }
                        } catch (error) {
                            contentDisplay.innerHTML = `<span class="italic text-red-500">Lỗi kết nối.</span>`;
                        }
                    }
                } else { // Nếu đang hiện thì ẩn đi
                    aiSection.style.display = 'none';
                }
            }
            
            // THÊM MỚI: Xử lý nút mở modal Feedback
            if (event.target.closest('.open-feedback-modal-btn')) {
                const itemId = event.target.closest('.open-feedback-modal-btn').dataset.itemId;
                const itemTitle = event.target.closest('.open-feedback-modal-btn').dataset.itemTitle;
                if (window.openFeedbackModal) {
                    window.openFeedbackModal(itemId, itemTitle);
                }
            }

            // THÊM MỚI: Xử lý nút Sửa nhanh
            if (event.target.closest('.edit-quiz-btn')) {
                const editBtn = event.target.closest('.edit-quiz-btn');
                const itemId = editBtn.dataset.itemId;
                const setId = editBtn.dataset.setId;
                if (window.parent && window.parent.openModal) {
                    const url = editQuizItemUrl.replace('/0', `/${setId}`).replace('/0', `/${itemId}`);
                    window.parent.openModal(url);
                }
            }

            // Xử lý nút Sửa ghi chú
            if (event.target.closest('.edit-note-btn')) {
                const noteSection = questionCard.querySelector('.user-note-section');
                noteSection.querySelector('.note-view-mode').style.display = 'none';
                noteSection.querySelector('.note-edit-mode').style.display = 'block';
            }

            // Xử lý nút Hủy ghi chú
            if (event.target.closest('.cancel-note-btn')) {
                const noteSection = questionCard.querySelector('.user-note-section');
                noteSection.querySelector('.note-view-mode').style.display = 'block';
                noteSection.querySelector('.note-edit-mode').style.display = 'none';
            }
            
            // Xử lý nút Lưu ghi chú
            if (event.target.closest('.save-note-btn')) {
                const saveBtn = event.target.closest('.save-note-btn');
                const noteSection = questionCard.querySelector('.user-note-section');
                const textarea = noteSection.querySelector('.note-textarea');
                const content = textarea.value;

                saveBtn.textContent = 'Đang lưu...';
                saveBtn.disabled = true;

                try {
                    const response = await fetch(saveNoteUrl.replace('/0', `/${itemId}`), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...csrfHeaders },
                        body: JSON.stringify({ content })
                    });
                    const result = await response.json();
                    if (result.success) {
                        const displayDiv = noteSection.querySelector('.note-content-display');
                        displayDiv.innerHTML = content ? formatTextForHtml(content) : '<span class="italic text-gray-500">Bạn chưa có ghi chú.</span>';
                        // Cập nhật lại JS object
                        const questionInBatch = currentQuestionBatch.find(q => q.item_id == itemId);
                        if (questionInBatch) questionInBatch.note_content = content;
                        
                        noteSection.querySelector('.note-view-mode').style.display = 'block';
                        noteSection.querySelector('.note-edit-mode').style.display = 'none';
                        showFlashMessage('Đã lưu ghi chú!', 'success');
                    } else {
                        showCustomAlert(result.message || 'Lỗi khi lưu ghi chú.');
                    }
                } catch (error) {
                    showCustomAlert('Lỗi kết nối khi lưu ghi chú.');
                } finally {
                    saveBtn.textContent = 'Lưu';
                    saveBtn.disabled = false;
                }
            }
        });
    </script>
    {# THÊM MỚI: Nhúng modal feedback vào trang này #}
    {% include 'feedback/_feedback_modal.html' %}
{% endblock %}