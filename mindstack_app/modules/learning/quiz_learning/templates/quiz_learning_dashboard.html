{# =============================== #}
{# File: mindstack_app/modules/learning/quiz_learning/templates/quiz_learning_dashboard.html #}
{# Phiên bản: 1.67 #}
{# Mục đích: Giao diện chính để chọn bộ câu hỏi và chế độ học Quiz. #}
{# ĐÃ SỬA: Cập nhật logic JavaScript để lấy giá trị batch_size từ dropdown trực tiếp khi nhấn nút "Bắt đầu". #}
{# ĐÃ SỬA: Cập nhật URL template để sử dụng query parameter cho batch_size thay vì path variable để linh hoạt hơn. #}
{# ĐÃ SỬA: Sửa lỗi tạo URL với placeholder. #}
{# =============================== #}

{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}

{% block title %}Học Quiz - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .selected-item {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .selected-mode {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .start-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .tab-filter-button.active { 
            border-bottom: 2px solid #3b82f6; 
            color: #3b82f6; 
        }
        .tab-filter-button {
            transition: all 0.2s ease-in-out;
            color: #6b7280;
            font-weight: 500;
        }

        .quiz-title-wrapper { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 2rem; 
            width: 100%;
        }
        .quiz-title-badge {
            width: 100%;
            max-width: 100%;
            background: #e0f2fe;
            color: #1e3a8a;
            font-size: 2rem;
            font-weight: 800;
            padding: 0.75rem 2.5rem;
            border-radius: 9999px;
            border: 2px solid #bfdbfe;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-shadow: none;
            letter-spacing: 0.05em;
            transition: all .3s ease;
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
        }
        .quiz-title-badge .fa-question-circle { 
            margin-right: .75rem;
            font-size: 2.25rem;
        }
        .quiz-title-badge:hover { 
            box-shadow: 0 6px 14px rgba(30,58,138,0.20);
            border-color: #60a5fa;
            transform: translateY(-2px);
        }
        
        .quiz-set-item {
            position: relative;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        .quiz-set-item:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); transform: translateY(-2px); }

        .archive-icon {
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s ease;
        }
        .archive-icon:hover {
            color: #3b82f6;
        }
        .archived .archive-icon {
            color: #3b82f6;
        }
        
        .multi-select-toggle-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .multi-select-toggle {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
            margin-left: 0.5rem;
        }
        .multi-select-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .multi-select-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .multi-select-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .multi-select-slider {
            background-color: #2196F3;
        }
        input:checked + .multi-select-slider:before {
            transform: translateX(16px);
        }

        .selected-sets-container {
            margin-bottom: 1rem;
            min-height: 2.5rem;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
            padding: 0.5rem;
            color: #4b5563;
            font-size: 0.875rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .selected-set-item {
            background-color: #dbeafe;
            color: #1e3a8a;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.25rem;
            display: inline-flex;
            align-items: center;
        }
        .selected-set-item i {
            margin-left: 0.5rem;
            font-size: 0.6rem;
            cursor: pointer;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-1 py-4 sm:px-6 sm:py-6 lg:px-8 lg:py-8">
    <div class="quiz-title-wrapper">
        <div id="quizTitle" class="quiz-title-badge"><i class="fas fa-question-circle"></i>Quiz</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mx-auto max-w-full">
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                <i class="fas fa-list-alt mr-3 text-blue-500"></i> Bước 1: Chọn một bộ câu hỏi
            </h2>
            <div class="flex items-center justify-between mb-4">
                <div class="flex space-x-4 border-b border-gray-200">
                    <button id="filter-doing" class="tab-filter-button flex items-center p-2 {% if current_filter == 'doing' %}active{% endif %}" data-filter="doing"><i class="fas fa-play-circle mr-2"></i> Đang làm</button>
                    <button id="filter-explore" class="tab-filter-button flex items-center p-2 {% if current_filter == 'explore' %}active{% endif %}" data-filter="explore"><i class="fas fa-globe mr-2"></i> Khám phá</button>
                    <button id="filter-archive" class="tab-filter-button flex items-center p-2 {% if current_filter == 'archive' %}active{% endif %}" data-filter="archive"><i class="fas fa-archive mr-2"></i> Archive</button>
                </div>
                <div class="multi-select-toggle-container">
                    <label for="multi-select-toggle-input">Chọn nhiều</label>
                    <label class="multi-select-toggle">
                        <input type="checkbox" id="multi-select-toggle-input">
                        <span class="multi-select-slider"></span>
                    </label>
                </div>
            </div>
            <div id="selected-sets-display" class="selected-sets-container hidden">
                <span class="text-gray-500">Bộ quiz đã chọn:</span>
            </div>
            <div id="quiz-sets-container" class="flex-grow">
                <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]">
                    <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                    <p>Đang tải danh sách bộ câu hỏi...</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                <i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học
            </h2>
            <div id="quiz-modes-container" class="flex-grow">
                <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                    <i class="fas fa-info-circle text-4xl mb-3"></i>
                    <p>Vui lòng chọn một bộ câu hỏi trước.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8 text-center">
        <button id="start-learning-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" disabled>
            <i class="fas fa-play-circle mr-3"></i> Bắt đầu làm bài
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    console.log('>>> quiz_learning_dashboard.js: init');

    {# ==== Biến trạng thái ==== #}
    let selectedQuizSetId = null;
    let selectedQuizSetIds = [];
    let selectedQuizMode = null;
    let selectedSessionSize = parseInt("{{ user_default_batch_size | default(10) }}");
    let currentFilter = "{{ current_filter | default('doing') }}";
    let doingPage = 1; let explorePage = 1; let archivePage = 1; let currentPage = (currentFilter === 'doing' ? doingPage : (currentFilter === 'explore' ? explorePage : archivePage));
    let currentSearchQuery = "{{ search_query | default('') }}";
    let currentSearchField = "{{ search_field | default('all') }}";
    let isMultiSelectMode = false;

    const quizSetsContainer = document.getElementById('quiz-sets-container');
    const quizModesContainer = document.getElementById('quiz-modes-container');
    const startLearningBtn = document.getElementById('start-learning-btn');
    const multiSelectToggleInput = document.getElementById('multi-select-toggle-input');
    const selectedSetsDisplay = document.getElementById('selected-sets-display');
    {# Element cho nút "Làm tất cả các bộ" #}
    let allSetsButton = null;

    {# ==== URL ==== #}
    const quizModesPartialBaseUrlById = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_by_id', set_id=0) or '#' }}";
    const quizModesPartialBaseUrlAll = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_all') or '#' }}";
    const quizModesPartialBaseUrlMulti = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_multi', set_ids_str='0') or '#' }}";
    const startQuizSessionBaseUrlAllTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_all', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlMultiTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_multi', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlByIdTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_by_id', set_id=0, mode='MODE_PLACEHOLDER') }}";
    const getQuizSetsPartialUrl = "{{ url_for('learning.quiz_learning.get_quiz_sets_partial') or '#' }}";
    const saveQuizSettingsUrl = "{{ url_for('learning.quiz_learning.save_quiz_settings') }}";
    const toggleArchiveUrl = "{{ url_for('learning.quiz_learning.toggle_archive', set_id=0) or '#' }}";

    {# Hàm ẩn/hiện nút "Làm tất cả các bộ" #}
    function toggleAllSetsButtonVisibility() {
        if (!allSetsButton) {
            allSetsButton = document.querySelector('.quiz-set-item[data-set-id="all"]');
        }
        if (allSetsButton) {
            allSetsButton.style.display = isMultiSelectMode ? 'none' : 'flex';
        }
    }
    
    {# ==== AJAX: Tải danh sách bộ Quiz ==== #}
    async function loadQuizSets(page, searchQuery, searchField, filter) {
        console.log('loadQuizSets', page, searchQuery, searchField, filter);
        quizSetsContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải danh sách bộ câu hỏi...</p></div>';

        selectedQuizSetIds = [];
        selectedQuizSetId = null;
        updateSelectedSetsDisplay();

        quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
        updateStartButtonState();

        if (!getQuizSetsPartialUrl || getQuizSetsPartialUrl === '#') {
            console.error('getQuizSetsPartialUrl không hợp lệ.');
            quizSetsContainer.innerHTML = '<p class="text-red-500 text-center">Lỗi cấu hình URL. Vui lòng liên hệ quản trị viên.</p>';
            return;
        }
        try {
            const url = new URL(getQuizSetsPartialUrl, window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('q', searchQuery || '');
            url.searchParams.append('search_field', searchField || 'all');
            url.searchParams.append('filter', filter || 'doing');

            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const html = await response.text();
            quizSetsContainer.innerHTML = html;
            addQuizSetClickListeners();
            addPaginationAndSearchListeners();
            addArchiveIconListeners();
            updateQuizSetProgressColors();
            syncMultiSelectionUI();
            
            {# Gọi hàm để ẩn/hiện nút "Làm tất cả các bộ" sau khi tải nội dung #}
            toggleAllSetsButtonVisibility();
        } catch (e) {
            console.error('Lỗi loadQuizSets:', e);
            quizSetsContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải danh sách bộ câu hỏi. Vui lòng thử lại.</p>';
        }
    }

    {# ==== AJAX: Tải chế độ học ==== #}
    async function loadQuizModes(setId) {
        console.log('loadQuizModes ->', setId);
        quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải chế độ học...</p></div>';
        try {
            let url;
            if (Array.isArray(setId)) {
                if (setId.length === 0) {
                     quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
                     updateStartButtonState();
                     return;
                }
                const setIdsStr = setId.join(',');
                url = quizModesPartialBaseUrlMulti.replace('/0', '/' + setIdsStr);
            } else if (setId === 'all') {
                url = quizModesPartialBaseUrlAll;
            } else {
                url = quizModesPartialBaseUrlById.replace('/0', '/' + setId);
            }
            if (!url || url === '#') { throw new Error('URL chế độ học không hợp lệ'); }

            const fullUrl = new URL(url, window.location.origin);
            if (selectedQuizMode) { fullUrl.searchParams.append('selected_mode', selectedQuizMode); }
            fullUrl.searchParams.append('user_default_batch_size', selectedSessionSize);

            const response = await fetch(fullUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const html = await response.text();
            quizModesContainer.innerHTML = html;
            addQuizModeClickListeners();

            const sessionSizeSelect = document.getElementById('session-size-select');
            if (sessionSizeSelect) {
                sessionSizeSelect.value = selectedSessionSize;
                sessionSizeSelect.addEventListener('change', async function(){
                    selectedSessionSize = parseInt(this.value);
                    updateStartButtonState();
                    try {
                        const res = await fetch(saveQuizSettingsUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ batch_size: selectedSessionSize }) });
                        const js = await res.json();
                        if (!js.success) { console.error('Lưu batch_size lỗi:', js.message); }
                    } catch (err) { console.error('AJAX lưu batch_size lỗi:', err); }
                });
            }

            if (!selectedQuizMode) {
                const available = Array.from(quizModesContainer.querySelectorAll('.quiz-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                if (available.length > 0) { available[0].click(); }
                else { selectedQuizMode = null; updateStartButtonState(); }
            } else {
                const prev = quizModesContainer.querySelector('[data-mode-id="' + selectedQuizMode + '"]');
                if (prev && parseInt(prev.dataset.count) > 0) { prev.click(); }
                else {
                    selectedQuizMode = null; updateStartButtonState();
                    const available2 = Array.from(quizModesContainer.querySelectorAll('.quiz-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                    if (available2.length > 0) { available2[0].click(); }
                }
            }
        } catch (e) {
            console.error('Lỗi loadQuizModes:', e);
            quizModesContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải chế độ học. Vui lòng thử lại.</p>';
        }
    }

    {# Đồng bộ trạng thái UI của multi-selection sau khi tải DOM #}
    function syncMultiSelectionUI() {
        if (isMultiSelectMode) {
            document.querySelectorAll('.quiz-set-item').forEach(item => {
                const setId = item.dataset.setId;
                if (selectedQuizSetIds.includes(setId)) {
                    item.classList.add('selected-item');
                } else {
                    item.classList.remove('selected-item');
                }
            });
            updateSelectedSetsDisplay();
        }
        {# Cập nhật hiển thị nút 'Archive' #}
        document.querySelectorAll('.archive-icon').forEach(icon => {
            icon.style.display = isMultiSelectMode ? 'none' : '';
        });
    }

    {# Cập nhật hiển thị các bộ đã chọn #}
    function updateSelectedSetsDisplay() {
        if (selectedQuizSetIds.length > 0) {
            selectedSetsDisplay.classList.remove('hidden');
            selectedSetsDisplay.innerHTML = `<span class="text-gray-500 mr-2">Bộ quiz đã chọn:</span>`;
            selectedQuizSetIds.forEach(setId => {
                const item = document.querySelector(`.quiz-set-item[data-set-id="${setId}"]`);
                if (item) {
                    const title = item.querySelector('h3').textContent;
                    const selectedItemHtml = `
                        <div class="selected-set-item" data-set-id="${setId}">
                            <span>${title}</span>
                            <i class="fas fa-times-circle remove-selected-set"></i>
                        </div>
                    `;
                    selectedSetsDisplay.insertAdjacentHTML('beforeend', selectedItemHtml);
                }
            });
        } else {
            selectedSetsDisplay.classList.add('hidden');
        }

        document.querySelectorAll('.remove-selected-set').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const setIdToRemove = this.closest('.selected-set-item').dataset.setId;
                handleQuizSetSelection(setIdToRemove);
            });
        });
    }

    {# Xử lý logic chọn một/chọn nhiều #}
    function handleQuizSetSelection(setId) {
        const item = document.querySelector(`.quiz-set-item[data-set-id="${setId}"]`);
        if (!item) return;

        if (isMultiSelectMode) {
            if (setId === 'all') {
                {# Bỏ qua nút "Làm tất cả các bộ" khi multi-select được bật #}
                return;
            }

            if (selectedQuizSetIds.includes(setId)) {
                selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setId);
                item.classList.remove('selected-item');
            } else {
                selectedQuizSetIds.push(setId);
                item.classList.add('selected-item');
            }

            selectedQuizMode = null;
            if (selectedQuizSetIds.length > 0) {
                 {# Tải chế độ học cho toàn bộ các bộ đã chọn #}
                loadQuizModes(selectedQuizSetIds);
            } else {
                quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
            }
        } else {
            if (selectedQuizSetId === setId) {
                selectedQuizSetId = null;
                item.classList.remove('selected-item');
                quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
            } else {
                document.querySelectorAll('.quiz-set-item').forEach(el => el.classList.remove('selected-item'));
                selectedQuizSetId = setId;
                item.classList.add('selected-item');
                loadQuizModes(selectedQuizSetId);
            }
        }
        updateStartButtonState();
        updateSelectedSetsDisplay();
    }


    // ==== Listener: click chọn bộ Quiz ====
    function addQuizSetClickListeners() {
        document.querySelectorAll('.quiz-set-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                const totalItems = parseInt(this.dataset.totalItems);
                if (totalItems === 0) { ev.preventDefault(); ev.stopPropagation(); return; }
                const setId = this.dataset.setId;
                handleQuizSetSelection(setId);
            });
        });
    }

    // ==== Listener: click chọn chế độ học ====
    function addQuizModeClickListeners() {
        // SỬA LỖI: Gắn event listener cho từng item thay vì chạy logic trực tiếp
        document.querySelectorAll('.quiz-mode-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                const modeCount = parseInt(this.dataset.count);
                if (modeCount === 0) {
                    ev.preventDefault();
                    ev.stopPropagation();
                    return;
                }
                document.querySelectorAll('.quiz-mode-item').forEach(function(el){ el.classList.remove('selected-mode'); });
                this.classList.add('selected-mode');
                selectedQuizMode = this.dataset.modeId;
                updateStartButtonState();
            });
        });
    }

    // ==== Listener: search + pagination trong partial danh sách ====
    function addPaginationAndSearchListeners() {
        const searchForm = quizSetsContainer.querySelector('form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e){
                e.preventDefault();
                const data = new FormData(searchForm);
                currentSearchQuery = data.get('q') || '';
                currentSearchField = data.get('search_field') || 'all';
                if (currentFilter === 'doing') { doingPage = 1; } else if (currentFilter === 'explore') { explorePage = 1; } else { archivePage = 1; }
                currentPage = 1;
                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            });
        }
        document.querySelectorAll('.pagination a').forEach(function(a){
            a.addEventListener('click', function(e){
                e.preventDefault();
                const url = new URL(this.href, window.location.origin);
                const page = parseInt(url.searchParams.get('page')) || 1;
                const q = url.searchParams.get('q') || '';
                const search_field = url.searchParams.get('search_field') || 'all';
                const filter = url.searchParams.get('filter') || 'doing';
                if (filter === 'doing') { doingPage = page; } else if (filter === 'explore') { explorePage = page; } else { archivePage = page; }
                currentPage = page;
                loadQuizSets(currentPage, q, search_field, filter);
            });
        });
    }

    {# Listener cho icon Archive #}
    function addArchiveIconListeners() {
        document.querySelectorAll('.archive-icon').forEach(function(icon){
            icon.addEventListener('click', async function(event){
                event.stopPropagation();
                const setId = this.dataset.setId;
                if (!setId) return;

                const url = toggleArchiveUrl.replace('/0', '/' + setId);

                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const itemElement = this.closest('.quiz-set-item');
                        if (currentFilter === 'archive' && !result.is_archived) {
                            itemElement.remove();
                        } else if ((currentFilter === 'doing' || currentFilter === 'explore') && result.is_archived) {
                            itemElement.remove();
                        } else {
                            if (result.is_archived) {
                                itemElement.classList.add('archived');
                                this.title = "Bỏ lưu trữ";
                                this.querySelector('i').classList.add('text-blue-500');
                                this.querySelector('i').classList.remove('text-gray-400');
                            } else {
                                itemElement.classList.remove('archived');
                                this.title = "Lưu trữ";
                                this.querySelector('i').classList.remove('text-blue-500');
                                this.querySelector('i').classList.add('text-gray-400');
                            }
                        }

                        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);

                        window.showFlashMessage(result.message, 'success');

                    } else {
                        window.showFlashMessage(result.message || 'Có lỗi xảy ra khi cập nhật trạng thái lưu trữ.', 'danger');
                    }
                } catch (e) {
                    console.error('Lỗi AJAX toggle archive:', e);
                    window.showFlashMessage('Không thể kết nối đến máy chủ.', 'danger');
                }
            });
        });
    }

    // ==== Trạng thái nút bắt đầu ====
    function updateStartButtonState() {
        const selectedCount = isMultiSelectMode ? selectedQuizSetIds.length : (selectedQuizSetId ? 1 : 0);
        const isSelected = selectedCount > 0;
        const modeAvailable = selectedQuizMode !== null;

        const sessionSizeSelect = document.getElementById('session-size-select');
        const isSessionSizeSelected = sessionSizeSelect && sessionSizeSelect.value;
        
        if (isSelected && modeAvailable && isSessionSizeSelected) {
            startLearningBtn.disabled = false;
            startLearningBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            startLearningBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        } else {
            startLearningBtn.disabled = true;
            startLearningBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            startLearningBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        }
    }

    // ==== Cập nhật màu chữ theo % ====
    function updateQuizSetProgressColors() {
        document.querySelectorAll('.quiz-set-item').forEach(function(item){
            const pct = parseInt(item.dataset.completionPercentage || '0');
            const txt = item.querySelector('.quiz-set-completion-text');
            if (txt) { txt.style.color = (pct > 50 ? '#111' : '#333'); }
        });
    }

    // ==== Nút bắt đầu ====
    startLearningBtn.addEventListener('click', function(){
        const currentBatchSize = document.getElementById('session-size-select').value;
        let startUrl;

        if (isMultiSelectMode) {
            if (selectedQuizSetIds.length > 0 && selectedQuizMode && currentBatchSize) {
                const setIdsStr = selectedQuizSetIds.join(',');
                startUrl = new URL(startQuizSessionBaseUrlMultiTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                startUrl.searchParams.append('set_ids', setIdsStr);
                startUrl.searchParams.append('batch_size', currentBatchSize);
                window.location.href = startUrl.toString();
            }
        } else {
            if (selectedQuizSetId && selectedQuizMode && currentBatchSize) {
                if (selectedQuizSetId === 'all') {
                    startUrl = new URL(startQuizSessionBaseUrlAllTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                    startUrl.searchParams.append('batch_size', currentBatchSize);
                } else {
                    startUrl = new URL(startQuizSessionBaseUrlByIdTemplate.replace('0', selectedQuizSetId).replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                    startUrl.searchParams.append('batch_size', currentBatchSize);
                }
                window.location.href = startUrl.toString();
            }
        }
    });

    // ==== Chuyển tab Doing/Explore/Archive ====
    document.querySelectorAll('.tab-filter-button').forEach(function(button) {
        button.addEventListener('click', function() {
            const newFilter = this.dataset.filter;
            if (currentFilter !== newFilter) {
                if (currentFilter === 'doing') { doingPage = currentPage; }
                else if (currentFilter === 'explore') { explorePage = currentPage; }
                else if (currentFilter === 'archive') { archivePage = currentPage; }

                currentFilter = newFilter;
                if (currentFilter === 'doing') { currentPage = doingPage; }
                else if (currentFilter === 'explore') { currentPage = explorePage; }
                else { currentPage = archivePage; }

                document.querySelectorAll('.tab-filter-button').forEach(function(btn){
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            }
        });
    });

    {# Xử lý toggle multi-selection #}
    multiSelectToggleInput.addEventListener('change', function() {
        isMultiSelectMode = this.checked;
        selectedQuizSetId = null;
        selectedQuizSetIds = [];
        document.querySelectorAll('.quiz-set-item').forEach(item => item.classList.remove('selected-item'));
        updateStartButtonState();
        updateSelectedSetsDisplay();

        document.querySelectorAll('.archive-icon').forEach(icon => {
            icon.style.display = this.checked ? 'none' : '';
        });

        {# THAY ĐỔI: Ẩn/hiện nút "Làm tất cả các bộ" khi toggle thay đổi #}
        toggleAllSetsButtonVisibility();

        if (!this.checked) {
            {# Khi tắt multi-selection, tải lại các chế độ học để quay về trạng thái ban đầu #}
            quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
        }
    });

    // ==== Khởi tạo ====
    document.addEventListener('DOMContentLoaded', function(){
        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
    });
    </script>
{% endblock %}
