{# =============================== #}
{# File: mindstack_app/modules/learning/quiz_learning/templates/quiz_learning_dashboard.html #}
{# Phiên bản: 1.14 #}
{# Mục đích: Khắc phục lỗi font size và padding quá lớn trên di động. #}
{# ĐÃ SỬA: Tối ưu CSS cho tab, đảm bảo hiển thị trên một hàng và chữ to hơn. #}
{# =============================== #}

{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}

{% block title %}Học Quiz - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .selected-item {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .selected-mode {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .start-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .tab-filter-button.active { 
            border-bottom: 2px solid #3b82f6; 
            color: #3b82f6; 
        }
        .tab-filter-button {
            transition: all 0.2s ease-in-out;
            color: #6b7280;
            font-weight: 500;
        }
        
        .quiz-title-wrapper { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 2rem; 
            width: 100%;
        }
        .quiz-title-badge {
            width: 100%;
            max-width: 100%;
            background: #e0f2fe;
            color: #1e3a8a;
            font-size: 2rem;
            font-weight: 800;
            padding: 0.75rem 2.5rem;
            border-radius: 9999px;
            border: 2px solid #bfdbfe;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-shadow: none;
            letter-spacing: 0.05em;
            transition: all .3s ease;
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
        }
        .quiz-title-badge .fa-question-circle { 
            margin-right: .75rem;
            font-size: 2.25rem;
        }
        .quiz-title-badge:hover {
            box-shadow: 0 6px 14px rgba(30,58,138,0.20);
            border-color: #60a5fa;
            transform: translateY(-2px);
        }

        .study-mode-tabs {
            display: inline-flex;
            background: #e5e7eb;
            border-radius: 9999px;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .study-mode-tab {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            color: #4b5563;
            border: 1px solid transparent;
            background: transparent;
            transition: all 0.2s ease-in-out;
        }

        .study-mode-tab.active {
            background: #ffffff;
            color: #1d4ed8;
            border-color: #bfdbfe;
            box-shadow: 0 4px 6px rgba(0,0,0,0.06);
        }
        
        .quiz-set-item {
            position: relative;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        .quiz-set-item:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); transform: translateY(-2px); }

        .archive-icon {
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s ease;
        }
        .archive-icon:hover {
            color: #3b82f6;
        }
        .archived .archive-icon {
            color: #3b82f6;
        }
        
        .tabs-and-toggle-wrapper {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .tab-group {
            display: flex;
            flex-grow: 1;
            min-width: 0;
            overflow: hidden;
            flex-wrap: nowrap; /* ĐÃ SỬA */
        }
        .tab-filter-button {
            flex-grow: 1;
            flex-shrink: 1;
            padding: 0.75rem 0.5rem;
            text-align: center;
            white-space: nowrap;
            font-size: 0.875rem;
            overflow: hidden; /* THÊM MỚI */
            text-overflow: ellipsis; /* THÊM MỚI */
        }
        .tab-filter-button i {
            margin-right: 0.5rem;
        }
        .tab-filter-button span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        @media (max-width: 639px) {
            .tab-filter-button {
                font-size: 0.875rem !important; /* ĐÃ SỬA: Tăng font size */
                padding: 0.5rem 0.25rem !important;
            }
        }
        @media (min-width: 640px) {
            .tab-group {
                justify-content: space-between;
            }
            .tab-filter-button {
                font-size: 1rem;
            }
        }

        .selected-sets-container {
            margin-bottom: 1rem;
            min-height: 2.5rem;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
            padding: 0.5rem;
            color: #4b5563;
            font-size: 0.875rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .selected-set-item {
            background-color: #dbeafe;
            color: #1e3a8a;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.25rem;
            display: inline-flex;
            align-items: center;
        }
        .selected-set-item i {
            margin-left: 0.5rem;
            font-size: 0.6rem;
            cursor: pointer;
        }

        /* THÊM MỚI: CSS tối ưu cho màn hình di động */
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }
            .quiz-title-wrapper {
                margin-bottom: 1rem;
            }
            .quiz-title-badge {
                font-size: 1.25rem;
                padding: 0.5rem 1rem;
            }
            .quiz-title-badge .fa-question-circle {
                font-size: 1.5rem;
                margin-right: 0.5rem;
            }
            .grid > div {
                padding: 0.5rem;
            }
            h2.sm\:text-2xl {
                font-size: 1.125rem; /* text-lg */
            }
            .p-6 {
                padding: 1rem;
            }
            .mb-4 {
                margin-bottom: 0.75rem;
            }
            .quiz-set-item {
                padding: 0.75rem;
            }
            .quiz-set-item .text-lg {
                font-size: 0.9rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-1 py-4 sm:px-6 sm:py-6 lg:px-8 lg:py-8">
    <div class="quiz-title-wrapper">
        <div id="quizTitle" class="quiz-title-badge"><i class="fas fa-question-circle"></i>Quiz</div>
    </div>

    <div class="flex justify-center mb-6">
        <div class="study-mode-tabs" role="tablist" aria-label="Chế độ làm quiz">
            <button class="study-mode-tab active" data-study-tab="solo" role="tab" aria-selected="true">Học 1 mình</button>
            <button class="study-mode-tab" data-study-tab="group" role="tab" aria-selected="false">Thi đấu nhóm</button>
        </div>
    </div>

    <div id="quiz-solo-section" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mx-auto max-w-full">
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                    <i class="fas fa-list-alt mr-3 text-blue-500"></i> Bước 1: Chọn một bộ câu hỏi
                </h2>
                <div class="mb-4">
                    <div class="tabs-and-toggle-wrapper">
                        <div class="tab-group">
                            <button id="filter-doing" class="tab-filter-button flex items-center justify-center {% if current_filter == 'doing' %}active{% endif %}" data-filter="doing"><i class="fas fa-play-circle mr-2"></i><span>Đang làm</span></button>
                            <button id="filter-explore" class="tab-filter-button flex items-center justify-center {% if current_filter == 'explore' %}active{% endif %}" data-filter="explore"><i class="fas fa-globe mr-2"></i><span>Khám phá</span></button>
                            <button id="filter-archive" class="tab-filter-button flex items-center justify-center {% if current_filter == 'archive' %}active{% endif %}" data-filter="archive"><i class="fas fa-archive mr-2"></i><span>Archive</span></button>
                        </div>
                    </div>
                </div>
                <div id="selected-sets-display" class="selected-sets-container hidden">
                    <span class="text-gray-500">Bộ quiz đã chọn:</span>
                </div>
                <div id="quiz-sets-container" class="flex-grow">
                    <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]">
                        <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                        <p>Đang tải danh sách bộ câu hỏi...</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                <h2 id="step-2-title" class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                    <i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học
                </h2>
                <div id="quiz-modes-container" class="flex-grow">
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                        <i class="fas fa-info-circle text-4xl mb-3"></i>
                        <p>Vui lòng chọn một bộ câu hỏi trước.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            <button id="start-learning-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" style="display: none;">
                <i class="fas fa-play-circle mr-3"></i> Bắt đầu làm bài
            </button>
            <button id="bulk-unarchive-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" style="display: none;">
                <i class="fas fa-box-open mr-3"></i> Bỏ lưu trữ
            </button>
        </div>
    </div>

    <div id="quiz-group-section" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-start gap-3 mb-4">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-700"><i class="fas fa-swords"></i></div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Quiz Battle</h2>
                        <p class="text-sm text-gray-600">Thách đấu theo nhóm với kho câu hỏi có sẵn. Vào nhanh phòng công khai hoặc mở phòng riêng để mời bạn bè.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 rounded-lg border border-purple-100 bg-purple-50">
                        <h3 class="font-semibold text-purple-800 mb-2"><i class="fas fa-bolt mr-2"></i>Tham gia tức thì</h3>
                        <p class="text-sm text-gray-700">Xem danh sách phòng đang mở và vào ngay để so điểm theo thời gian thực.</p>
                    </div>
                    <div class="p-4 rounded-lg border border-indigo-100 bg-indigo-50">
                        <h3 class="font-semibold text-indigo-800 mb-2"><i class="fas fa-lock mr-2"></i>Trận riêng tư</h3>
                        <p class="text-sm text-gray-700">Tạo phòng đặt mật khẩu, chọn bộ câu hỏi và luật chơi riêng cho đội của bạn.</p>
                    </div>
                </div>
                <div class="mt-6 flex flex-wrap gap-3">
                    <a href="{{ url_for('learning.quiz_battle.dashboard') }}" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">
                        <i class="fas fa-trophy mr-2"></i> Mở Quiz Battle
                    </a>
                    <a href="{{ url_for('learning.quiz_learning.quiz_learning_dashboard') }}#quiz-solo-section" class="inline-flex items-center px-4 py-2 bg-white text-indigo-700 border border-indigo-200 rounded-lg shadow-sm hover:bg-indigo-50 transition">
                        <i class="fas fa-user mr-2"></i> Quay lại học một mình
                    </a>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2"><i class="fas fa-lightbulb text-yellow-500"></i> Mẹo thi đấu</h3>
                <ul class="space-y-3 text-sm text-gray-700 list-disc list-inside">
                    <li>Kiểm tra kết nối và mic trước trận để trao đổi nhanh.</li>
                    <li>Chia đội cân bằng và thống nhất thời gian mỗi lượt.</li>
                    <li>Sau trận, truy cập thống kê để xem điểm và câu sai phổ biến.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    console.log('>>> quiz_learning_dashboard.js: init');

    {# ==== Biến trạng thái ==== #}
    let selectedQuizSetIds = [];
    let selectedQuizMode = null;
    let selectedSessionSize = parseInt("{{ user_default_batch_size | default(10) }}");
    let currentFilter = "{{ current_filter | default('doing') }}";
    let doingPage = 1; let explorePage = 1; let archivePage = 1; let currentPage = (currentFilter === 'doing' ? doingPage : (currentFilter === 'explore' ? explorePage : archivePage));
    let currentSearchQuery = "{{ search_query | default('') }}";
    let currentSearchField = "{{ search_field | default('all') }}";
    let isMultiSelectMode = true;
    let currentStudyMode = 'solo';

    const quizSetsContainer = document.getElementById('quiz-sets-container');
    const quizModesContainer = document.getElementById('quiz-modes-container');
    const startLearningBtn = document.getElementById('start-learning-btn');
    const bulkUnarchiveBtn = document.getElementById('bulk-unarchive-btn');
    const selectedSetsDisplay = document.getElementById('selected-sets-display');
    const step2Title = document.getElementById('step-2-title');
    const studyModeTabs = document.querySelectorAll('[data-study-tab]');
    const soloSection = document.getElementById('quiz-solo-section');
    const groupSection = document.getElementById('quiz-group-section');
    
    const rightPanel = document.querySelector('.lg\\:grid-cols-2 > div:nth-child(2)');

    let allSetsButton = null;

    const quizModesPartialBaseUrlById = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_by_id', set_id=0) or '#' }}";
    const quizModesPartialBaseUrlAll = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_all') or '#' }}";
    const quizModesPartialBaseUrlMulti = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_multi', set_ids_str='0') or '#' }}";
    const startQuizSessionBaseUrlAllTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_all', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlMultiTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_multi', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlByIdTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_by_id', set_id=0, mode='MODE_PLACEHOLDER') }}";
    const getQuizSetsPartialUrl = "{{ url_for('learning.quiz_learning.get_quiz_sets_partial') or '#' }}";
    const saveQuizSettingsUrl = "{{ url_for('learning.quiz_learning.save_quiz_settings') }}";
    const toggleArchiveUrl = "{{ url_for('learning.quiz_learning.toggle_archive', set_id=0) or '#' }}";
    const bulkUnarchiveUrl = "{{ url_for('learning.quiz_learning.bulk_unarchive') }}";
    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfHeaders = csrfTokenMeta ? { 'X-CSRFToken': csrfTokenMeta.getAttribute('content') } : {};

    studyModeTabs.forEach((tab) => {
        tab.addEventListener('click', () => {
            const selectedMode = tab.dataset.studyTab;
            if (!selectedMode || selectedMode === currentStudyMode) return;

            currentStudyMode = selectedMode;
            studyModeTabs.forEach((btn) => {
                const isActive = btn.dataset.studyTab === selectedMode;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });

            if (selectedMode === 'solo') {
                soloSection.classList.remove('hidden');
                groupSection.classList.add('hidden');
                updateActionButtons();
            } else {
                soloSection.classList.add('hidden');
                groupSection.classList.remove('hidden');
                startLearningBtn.style.display = 'none';
                bulkUnarchiveBtn.style.display = 'none';
            }
        });
    });

    function toggleAllSetsButtonVisibility() {
        if (!allSetsButton) {
            allSetsButton = document.querySelector('.quiz-set-item[data-set-id="all"]');
        }
        if (allSetsButton) {
            allSetsButton.style.display = (currentFilter === 'doing') ? 'flex' : 'none';
        }
    }
    
    async function loadQuizSets(page, searchQuery, searchField, filter) {
        console.log('loadQuizSets', page, searchQuery, searchField, filter);
        quizSetsContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải danh sách bộ câu hỏi...</p></div>';
        
        // Load selected IDs from localStorage on initial load
        if (localStorage.getItem('selectedQuizSetIds')) {
            selectedQuizSetIds = JSON.parse(localStorage.getItem('selectedQuizSetIds'));
        } else {
            selectedQuizSetIds = [];
        }

        selectedQuizSetId = null;
        updateSelectedSetsDisplay();

        updateActionButtons();

        if (!getQuizSetsPartialUrl || getQuizSetsPartialUrl === '#') {
            console.error('getQuizSetsPartialUrl không hợp lệ.');
            quizSetsContainer.innerHTML = '<p class="text-red-500 text-center">Lỗi cấu hình URL. Vui lòng liên hệ quản trị viên.</p>';
            return;
        }
        try {
            const url = new URL(getQuizSetsPartialUrl, window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('q', searchQuery || '');
            url.searchParams.append('search_field', searchField || 'all');
            url.searchParams.append('filter', filter || 'doing');
            url.searchParams.append('is_multi_select_mode', 'true');

            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const html = await response.text();
            quizSetsContainer.innerHTML = html;
            addQuizSetClickListeners();
            addPaginationAndSearchListeners();
            addArchiveIconListeners();
            updateQuizSetProgressColors();
            syncMultiSelectionUI();
            
            toggleAllSetsButtonVisibility();
        } catch (e) {
            console.error('Lỗi loadQuizSets:', e);
            quizSetsContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải danh sách bộ câu hỏi. Vui lòng thử lại.</p>';
        }
    }

    async function loadQuizModes(setId) {
        console.log('loadQuizModes ->', setId);
        if (currentFilter === 'archive') { return; } 
        quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải chế độ học...</p></div>';
        try {
            let url;
            if (Array.isArray(setId)) {
                if (setId.length === 0) {
                     quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
                     updateActionButtons();
                     return;
                }
                if (setId.length === 1 && setId[0] === 'all') {
                    url = quizModesPartialBaseUrlAll;
                } else {
                    const setIdsStr = setId.join(',');
                    url = quizModesPartialBaseUrlMulti.replace('/0', '/' + setIdsStr);
                }
            } else if (setId === 'all') {
                url = quizModesPartialBaseUrlAll;
            } else {
                url = quizModesPartialBaseUrlById.replace('/0', '/' + setId);
            }
            if (!url || url === '#') { throw new Error('URL chế độ học không hợp lệ'); }

            const fullUrl = new URL(url, window.location.origin);
            if (selectedQuizMode) { fullUrl.searchParams.append('selected_mode', selectedQuizMode); }
            fullUrl.searchParams.append('user_default_batch_size', selectedSessionSize);

            const response = await fetch(fullUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const html = await response.text();
            quizModesContainer.innerHTML = html;
            addQuizModeClickListeners();

            const sessionSizeSelect = document.getElementById('session-size-select');
            if (sessionSizeSelect) {
                sessionSizeSelect.value = selectedSessionSize;
                sessionSizeSelect.addEventListener('change', async function(){
                    selectedSessionSize = parseInt(this.value);
                    updateActionButtons();
                    try {
                        const headers = { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', ...csrfHeaders };
                        const res = await fetch(saveQuizSettingsUrl, { method: 'POST', headers, body: JSON.stringify({ batch_size: selectedSessionSize }) });
                        const contentType = res.headers.get('content-type') || '';
                        let js = {};
                        if (contentType.includes('application/json')) {
                            js = await res.json();
                        } else {
                            const raw = await res.text();
                            throw new Error(`INVALID_JSON_RESPONSE:${raw.slice(0, 200)}`);
                        }
                        if (!res.ok || !js.success) { console.error('Lưu batch_size lỗi:', js.message || res.statusText); }
                    } catch (err) { console.error('AJAX lưu batch_size lỗi:', err); }
                });
            }

            if (!selectedQuizMode) {
                const available = Array.from(quizModesContainer.querySelectorAll('.quiz-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                if (available.length > 0) { available[0].click(); }
                else { selectedQuizMode = null; updateActionButtons(); }
            } else {
                const prev = quizModesContainer.querySelector('[data-mode-id="' + selectedQuizMode + '"]');
                if (prev && parseInt(prev.dataset.count) > 0) { prev.click(); }
                else {
                    selectedQuizMode = null; updateActionButtons();
                    const available2 = Array.from(quizModesContainer.querySelectorAll('.quiz-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                    if (available2.length > 0) { available2[0].click(); }
                }
            }
        } catch (e) {
            console.error('Lỗi loadQuizModes:', e);
            quizModesContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải chế độ học. Vui lòng thử lại.</p>';
        }
    }

    function syncMultiSelectionUI() {
        if (isMultiSelectMode) {
            document.querySelectorAll('.quiz-set-item').forEach(item => {
                const setId = item.dataset.setId;
                if (selectedQuizSetIds.includes(setId)) {
                    item.classList.add('selected-item');
                } else {
                    item.classList.remove('selected-item');
                }
            });
            updateSelectedSetsDisplay();
        }
        document.querySelectorAll('.archive-icon').forEach(icon => {
            icon.style.display = (currentFilter === 'doing' || currentFilter === 'explore') ? '' : 'none';
        });
    }

    function updateSelectedSetsDisplay() {
        if (selectedQuizSetIds.length > 0) {
            selectedSetsDisplay.classList.remove('hidden');
            selectedSetsDisplay.innerHTML = `<span class="text-gray-500 mr-2">Bộ quiz đã chọn:</span>`;
            
            // Lấy thông tin chi tiết của các bộ đã chọn từ DOM hiện tại hoặc từ localStorage
            const allSelectedItems = new Map();
            document.querySelectorAll('.quiz-set-item').forEach(item => { // Lặp qua TẤT CẢ các item trên trang
                const setId = item.dataset.setId;
                if (selectedQuizSetIds.includes(setId)) {
                     const title = item.querySelector('h3').textContent;
                     allSelectedItems.set(setId, title);
                }
            });
            
            // Cải thiện logic để lấy thông tin từ localStorage nếu không có trên trang hiện tại
            selectedQuizSetIds.forEach(setId => {
                let title;
                if (allSelectedItems.has(setId)) {
                    title = allSelectedItems.get(setId);
                } else if (setId === 'all') {
                    title = 'Làm tất cả các bộ';
                } else {
                    // Lấy title từ localStorage nếu có
                    const storedTitles = JSON.parse(localStorage.getItem('selectedQuizSetTitles')) || {};
                    title = storedTitles[setId] || setId; // Dùng ID làm fallback
                }

                if (title) {
                    const selectedItemHtml = `
                        <div class="selected-set-item" data-set-id="${setId}">
                            <span>${title}</span>
                            <i class="fas fa-times-circle remove-selected-set"></i>
                        </div>
                    `;
                    selectedSetsDisplay.insertAdjacentHTML('beforeend', selectedItemHtml);
                }
            });
            
        } else {
            selectedSetsDisplay.classList.add('hidden');
        }

        document.querySelectorAll('.remove-selected-set').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const setIdToRemove = this.closest('.selected-set-item').dataset.setId;
                handleQuizSetSelection(setIdToRemove);
            });
        });
    }

    function handleQuizSetSelection(setId) {
        // Clear selection if "all" is selected and a new item is clicked
        if (setId !== 'all' && selectedQuizSetIds.includes('all')) {
            const allButton = document.querySelector('.quiz-set-item[data-set-id="all"]');
            if (allButton) {
                allButton.classList.remove('selected-item');
            }
            selectedQuizSetIds = [];
        }
        // Clear selection if an item is selected and "all" is clicked
        if (setId === 'all' && selectedQuizSetIds.some(id => id !== 'all')) {
            document.querySelectorAll('.quiz-set-item.selected-item').forEach(el => el.classList.remove('selected-item'));
            selectedQuizSetIds = [];
        }

        const item = document.querySelector(`.quiz-set-item[data-set-id="${setId}"]`);
        
        if (selectedQuizSetIds.includes(setId)) {
            selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setId);
            if (item) item.classList.remove('selected-item');
        } else {
            selectedQuizSetIds.push(setId);
            if (item) item.classList.add('selected-item');
        }
        
        // Cập nhật localStorage
        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
        // Lấy và lưu title vào localStorage
        const storedTitles = JSON.parse(localStorage.getItem('selectedQuizSetTitles')) || {};
        if (item) {
            storedTitles[setId] = item.querySelector('h3').textContent;
        }
        localStorage.setItem('selectedQuizSetTitles', JSON.stringify(storedTitles));


        selectedQuizMode = null;
        if (selectedQuizSetIds.length > 0 && currentFilter !== 'archive') {
            loadQuizModes(selectedQuizSetIds);
        } else {
            if (currentFilter !== 'archive') {
                quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
            } else {
                updateStep2Content();
            }
        }
        
        updateActionButtons();
        updateSelectedSetsDisplay();
        toggleAllSetsButtonVisibility();
    }


    function addQuizSetClickListeners() {
        document.querySelectorAll('.quiz-set-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                const totalItems = parseInt(this.dataset.totalItems);
                if (currentFilter !== 'doing' && this.dataset.setId === 'all') { 
                    ev.preventDefault(); ev.stopPropagation(); return; 
                }
                if (currentFilter !== 'archive' && totalItems === 0 && this.dataset.setId !== 'all') { 
                    ev.preventDefault(); ev.stopPropagation(); return; 
                }
                const setId = this.dataset.setId;
                handleQuizSetSelection(setId);
            });
        });
    }

    function addQuizModeClickListeners() {
        document.querySelectorAll('.quiz-mode-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                const modeCount = parseInt(this.dataset.count);
                if (modeCount === 0) {
                    ev.preventDefault();
                    ev.stopPropagation();
                    return;
                }
                document.querySelectorAll('.quiz-mode-item').forEach(function(el){ el.classList.remove('selected-mode'); });
                this.classList.add('selected-mode');
                selectedQuizMode = this.dataset.modeId;
                updateActionButtons();
            });
        });
    }

    function addPaginationAndSearchListeners() {
        const searchForm = quizSetsContainer.querySelector('form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e){
                e.preventDefault();
                // Save selected IDs to localStorage before leaving the page
                localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
                const data = new FormData(searchForm);
                currentSearchQuery = data.get('q') || '';
                currentSearchField = data.get('search_field') || 'all';
                if (currentFilter === 'doing') { doingPage = 1; } else if (currentFilter === 'explore') { explorePage = 1; } else { archivePage = 1; }
                currentPage = 1;
                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            });
        }
        document.querySelectorAll('.pagination a').forEach(function(a){
            a.addEventListener('click', function(e){
                e.preventDefault();
                // Save selected IDs to localStorage before leaving the page
                localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
                const url = new URL(this.href, window.location.origin);
                const page = parseInt(url.searchParams.get('page')) || 1;
                const q = url.searchParams.get('q') || '';
                const search_field = url.searchParams.get('search_field') || 'all';
                const filter = url.searchParams.get('filter') || 'doing';
                if (filter === 'doing') { doingPage = page; } else if (filter === 'explore') { explorePage = page; } else { archivePage = page; }
                currentPage = page;
                loadQuizSets(currentPage, q, search_field, filter);
            });
        });
    }

    function addArchiveIconListeners() {
        document.querySelectorAll('.archive-icon').forEach(function(icon){
            icon.addEventListener('click', async function(event){
                event.stopPropagation();
                const setId = this.dataset.setId;
                if (!setId) return;

                const url = toggleArchiveUrl.replace('/0', '/' + setId);

                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const itemElement = this.closest('.quiz-set-item');
                        if (currentFilter === 'archive' && !result.is_archived) {
                            itemElement.remove();
                        } else if ((currentFilter === 'doing' || currentFilter === 'explore') && result.is_archived) {
                            itemElement.remove();
                        } else {
                            if (result.is_archived) {
                                itemElement.classList.add('archived');
                                this.title = "Bỏ lưu trữ";
                                this.querySelector('i').classList.add('text-blue-500');
                                this.querySelector('i').classList.remove('text-gray-400');
                            } else {
                                itemElement.classList.remove('archived');
                                this.title = "Lưu trữ";
                                this.querySelector('i').classList.remove('text-blue-500');
                                this.querySelector('i').classList.add('text-gray-400');
                            }
                        }
                        
                        // Cập nhật lại danh sách ID đã chọn sau khi thay đổi trạng thái archive
                        selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setId);
                        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));

                        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);

                        window.showFlashMessage(result.message, 'success');

                    } else {
                        window.showFlashMessage(result.message || 'Có lỗi xảy ra khi cập nhật trạng thái lưu trữ.', 'danger');
                    }
                } catch (e) {
                    console.error('Lỗi AJAX toggle archive:', e);
                    window.showFlashMessage('Không thể kết nối đến máy chủ.', 'danger');
                }
            });
        });
    }

    function updateActionButtons() {
        const selectedCount = selectedQuizSetIds.length;
        const isSelected = selectedCount > 0;

        if (currentStudyMode === 'group') {
            startLearningBtn.style.display = 'none';
            bulkUnarchiveBtn.style.display = 'none';
            return;
        }

        if (currentFilter === 'archive') {                
            startLearningBtn.style.display = 'none';
            bulkUnarchiveBtn.style.display = 'block';
            if (isSelected) {
                bulkUnarchiveBtn.disabled = false;
                bulkUnarchiveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                bulkUnarchiveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                bulkUnarchiveBtn.disabled = true;
                bulkUnarchiveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                bulkUnarchiveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        } else {
            bulkUnarchiveBtn.style.display = 'none';
            startLearningBtn.style.display = 'block';
            const modeAvailable = selectedQuizMode !== null;
            const sessionSizeSelect = document.getElementById('session-size-select');
            const isSessionSizeSelected = sessionSizeSelect && sessionSizeSelect.value;
            
            if (isSelected && modeAvailable && isSessionSizeSelected) {
                startLearningBtn.disabled = false;
                startLearningBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                startLearningBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                startLearningBtn.disabled = true;
                startLearningBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                startLearningBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }
    }

    function updateQuizSetProgressColors() {
        document.querySelectorAll('.quiz-set-item').forEach(function(item){
            const pct = parseInt(item.dataset.completionPercentage || '0');
            const txt = item.querySelector('.quiz-set-completion-text');
            if (txt) { txt.style.color = (pct > 50 ? '#111' : '#333'); }
        });
    }
    
    // THAY ĐỔI: Thêm event listener cho nút Start để xóa localStorage
    startLearningBtn.addEventListener('click', function(){
        const currentBatchSize = document.getElementById('session-size-select').value;
        let startUrl;
        
        if (selectedQuizSetIds.length > 0 && selectedQuizMode) {
            localStorage.removeItem('selectedQuizSetIds'); // Xóa localStorage khi bắt đầu phiên học
            const setIdsStr = selectedQuizSetIds.join(',');
            if (selectedQuizSetIds.length === 1 && selectedQuizSetIds[0] === 'all') {
                startUrl = new URL(startQuizSessionBaseUrlAllTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            } else if (selectedQuizSetIds.length === 1 && selectedQuizSetIds[0] !== 'all') {
                startUrl = new URL(startQuizSessionBaseUrlByIdTemplate.replace('0', selectedQuizSetIds[0]).replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            } else {
                startUrl = new URL(startQuizSessionBaseUrlMultiTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                startUrl.searchParams.append('set_ids', setIdsStr);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            }
            window.location.href = startUrl.toString();
        }
    });
    
    // THAY ĐỔI: Thêm event listener cho nút Unarchive để xóa localStorage
    bulkUnarchiveBtn.addEventListener('click', async function(){
        if (selectedQuizSetIds.length === 0) {
            window.showFlashMessage('Vui lòng chọn ít nhất một bộ quiz để bỏ lưu trữ.', 'warning');
            return;
        }

        try {
            const response = await fetch(bulkUnarchiveUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ set_ids: selectedQuizSetIds })
            });

            const result = await response.json();
            if (response.ok && result.success) {
                localStorage.removeItem('selectedQuizSetIds'); // Xóa localStorage sau khi bỏ lưu trữ
                window.showFlashMessage(result.message, 'success');
                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            } else {
                window.showFlashMessage(result.message || 'Có lỗi xảy ra khi bỏ lưu trữ.', 'danger');
            }
        } catch (e) {
            console.error('Lỗi khi bỏ lưu trữ hàng loạt:', e);
            window.showFlashMessage('Không thể kết nối đến máy chủ.', 'danger');
        }
    });

    document.querySelectorAll('.tab-filter-button').forEach(function(button) {
        button.addEventListener('click', function() {
            const newFilter = this.dataset.filter;
            if (currentFilter !== newFilter) {
                if (currentFilter === 'doing') { doingPage = currentPage; }
                else if (currentFilter === 'explore') { explorePage = currentPage; }
                else if (currentFilter === 'archive') { archivePage = currentPage; }

                currentFilter = newFilter;
                if (currentFilter === 'doing') { currentPage = doingPage; }
                else if (currentFilter === 'explore') { currentPage = explorePage; }
                else { currentPage = archivePage; }

                document.querySelectorAll('.tab-filter-button').forEach(function(btn){
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                isMultiSelectMode = true; 
                
                updateStep2Content();
                
                // Save selected IDs to localStorage before loading new page
                localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));

                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            }
        });
    });
    
    function updateStep2Content() {
        const isMobile = window.innerWidth < 640;
        if (currentFilter === 'archive') {
            rightPanel.style.display = isMobile ? 'none' : 'flex';
            step2Title.innerHTML = `<i class="fas fa-info-circle mr-3 text-blue-500"></i> Bỏ lưu trữ`;
            
            if (!isMobile) {
                quizModesContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-700 p-4">
                        <p class="text-base text-center mb-4">
                            Hãy chọn các bộ cần để bỏ lưu trữ trên giao diện.
                        </p>
                    </div>
                `;
            }
        } else {
            rightPanel.style.display = 'flex';
            step2Title.innerHTML = `<i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học`;
            if (selectedQuizSetIds.length > 0) {
                 const setIdsStr = selectedQuizSetIds.join(',');
                 loadQuizModes(setIdsStr);
            } else {
                 quizModesContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                        <i class="fas fa-info-circle text-4xl mb-3"></i>
                        <p>Vui lòng chọn một bộ câu hỏi trước.</p>
                    </div>
                `;
            }
        }
    }


    document.addEventListener('DOMContentLoaded', function(){
        isMultiSelectMode = true; 
        updateStep2Content();
        
        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
    });
    
    // Xóa localStorage khi người dùng đóng/refresh trang
    window.addEventListener('beforeunload', function() {
        localStorage.removeItem('selectedQuizSetIds');
    });

    </script>
{% endblock %}