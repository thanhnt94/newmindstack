<!-- File: newmindstack/mindstack_app/modules/learning/quiz_learning/templates/quiz_learning_dashboard.html -->
<!-- Phiên bản: 1.19 -->
<!-- Mục đích: Giao diện chính để chọn bộ câu hỏi và chế độ học Quiz. -->
<!-- ĐÃ SỬA: Tải trực tiếp danh sách bộ Quiz thay vì dùng AJAX ban đầu. -->
<!-- ĐÃ SỬA: Bỏ phân trang trong template. -->

{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}
{% from 'includes/_pagination.html' import render_pagination %} {# Vẫn giữ import nhưng không dùng #}


{% block title %}Học Quiz - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .selected-item {
            border-color: #3b82f6 !important; /* blue-500 */
            background-color: #eff6ff !important; /* blue-50 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* ring-blue-500 */
        }
        .selected-mode {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .start-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .tab-filter-button.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 sm:mb-8 text-center">
        Học Quiz
    </h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Bước 1: Chọn một bộ câu hỏi -->
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-list-alt mr-3 text-blue-500"></i> Bước 1: Chọn một bộ câu hỏi
            </h2>
            <div id="quiz-sets-container" class="flex-grow">
                {# Nội dung danh sách bộ câu hỏi được tải trực tiếp từ backend #}
                {% if error_message %}
                    <p class="text-red-500 text-center py-4">{{ error_message }}</p>
                {% else %}
                    <div class="mb-4">
                        {# Form tìm kiếm cho bộ Quiz #}
                        {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm bộ câu hỏi...", search_field=search_field, search_options=quiz_set_search_options) }}
                    </div>

                    <div class="flex space-x-2 mb-4">
                        <button id="filter-doing" class="tab-filter-button px-4 py-2 rounded-md font-medium transition-colors duration-200 {% if current_filter == 'doing' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700{% endif %}" data-filter="doing">
                            <i class="fas fa-play-circle mr-2"></i> Đang làm
                        </button>
                        <button id="filter-explore" class="tab-filter-button px-4 py-2 rounded-md font-medium transition-colors duration-200 {% if current_filter == 'explore' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700{% endif %}" data-filter="explore">
                            <i class="fas fa-globe mr-2"></i> Khám phá
                        </button>
                    </div>

                    {% if quiz_sets %}
                    <div class="space-y-3">
                        {# Option để học tất cả các bộ #}
                        <div class="quiz-set-item bg-gray-50 p-4 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors duration-200 flex justify-between items-center" data-set-id="all">
                            <div>
                                <h3 class="font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-infinity mr-2 text-gray-600"></i> Làm tất cả các bộ
                                </h3>
                            </div>
                            {# Số lượng tổng cộng sẽ được tính ở backend và hiển thị ở chế độ học #}
                        </div>

                        {% for set in quiz_sets %}
                        <div class="quiz-set-item bg-white p-4 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors duration-200" data-set-id="{{ set.container_id }}">
                            <h3 class="font-semibold text-gray-800">{{ set.title }}</h3>
                            <p class="text-gray-600 text-sm">{{ set.item_count }} câu</p>
                            <p class="text-gray-500 text-xs">tạo bởi {{ set.creator.username }}</p>
                        </div>
                        {% endfor %}
                    </div>

                    {# Phân trang đã bị bỏ đi #}
                    {% else %}
                    <div class="text-center py-12 px-6 text-gray-600">
                        <i class="fas fa-question-circle text-5xl text-gray-300 mb-4"></i>
                        <p>Không tìm thấy bộ câu hỏi nào phù hợp.</p>
                        <p class="text-sm text-gray-500 mt-2">Hãy thử thay đổi bộ lọc hoặc tìm kiếm.</p>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Bước 2: Chọn chế độ học -->
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học
            </h2>
            <div id="quiz-modes-container" class="flex-grow">
                <!-- Nội dung chế độ học sẽ được tải ở đây qua AJAX -->
                <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                    <i class="fas fa-info-circle text-4xl mb-3"></i>
                    <p>Vui lòng chọn một bộ câu hỏi trước.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Nút Bắt đầu học -->
    <div class="mt-8 text-center">
        <button id="start-learning-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" disabled>
            <i class="fas fa-play-circle mr-3"></i> Bắt đầu làm bài
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        let selectedQuizSetId = null;
        let selectedQuizMode = null;
        let currentFilter = "{{ current_filter }}"; 

        const quizSetsContainer = document.getElementById('quiz-sets-container');
        const quizModesContainer = document.getElementById('quiz-modes-container');
        const startLearningBtn = document.getElementById('start-learning-btn');
        const filterDoingBtn = document.getElementById('filter-doing');
        const filterExploreBtn = document.getElementById('filter-explore');

        // Khai báo các URL cơ sở một lần khi template được render
        // Sử dụng các endpoint rõ ràng
        const quizModesPartialBaseUrlById = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_by_id', set_id=0) }}";
        const quizModesPartialBaseUrlAll = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_all') }}";
        const startQuizSessionBaseUrlById = "{{ url_for('learning.quiz_learning.start_quiz_session_by_id', set_id=0, mode='placeholder_mode') }}";
        const startQuizSessionBaseUrlAll = "{{ url_for('learning.quiz_learning.start_quiz_session_all', mode='placeholder_mode') }}";


        // Hàm để tải danh sách bộ Quiz (chỉ dùng cho AJAX sau lần tải đầu)
        async function loadQuizSets(page = 1, searchQuery = '', searchField = 'all', filter = 'doing') {
            quizSetsContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải danh sách bộ câu hỏi...</p></div>`;
            try {
                const url = new URL("{{ url_for('learning.quiz_learning.get_quiz_sets_partial') }}");
                url.searchParams.append('page', page); // Vẫn truyền page nhưng backend sẽ bỏ qua
                url.searchParams.append('q', searchQuery);
                url.searchParams.append('search_field', searchField);
                url.searchParams.append('filter', filter);

                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                // Thay thế toàn bộ nội dung của quizSetsContainer bằng phản hồi AJAX
                quizSetsContainer.innerHTML = await response.text();
                addQuizSetClickListeners();
                // addPaginationAndSearchListeners(); // Bỏ gọi vì không còn phân trang
            } catch (error) {
                console.error('Lỗi khi tải danh sách bộ Quiz:', error);
                quizSetsContainer.innerHTML = `<p class="text-red-500 text-center">Không thể tải danh sách bộ câu hỏi. Vui lòng thử lại.</p>`;
            }
        }

        // Hàm để tải các chế độ học
        async function loadQuizModes(setId) {
            quizModesContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải chế độ học...</p></div>`;
            try {
                let url;
                if (setId === 'all') {
                    url = quizModesPartialBaseUrlAll;
                } else {
                    url = quizModesPartialBaseUrlById.replace('/0', `/${setId}`);
                }
                
                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                quizModesContainer.innerHTML = await response.text();
                addQuizModeClickListeners();
                const firstMode = quizModesContainer.querySelector('.quiz-mode-item');
                if (firstMode) {
                    firstMode.click();
                }
            } catch (error) {
                console.error('Lỗi khi tải chế độ học:', error);
                quizModesContainer.innerHTML = `<p class="text-red-500 text-center">Không thể tải chế độ học. Vui lòng thử lại.</p>`;
            }
        }

        // Hàm thêm listener cho các bộ Quiz
        function addQuizSetClickListeners() {
            document.querySelectorAll('.quiz-set-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.quiz-set-item').forEach(el => el.classList.remove('selected-item'));
                    this.classList.add('selected-item');
                    selectedQuizSetId = this.dataset.setId;
                    updateStartButtonState();
                    loadQuizModes(selectedQuizSetId);
                });
            });
        }

        // Hàm thêm listener cho các chế độ học
        function addQuizModeClickListeners() {
            document.querySelectorAll('.quiz-mode-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.quiz-mode-item').forEach(el => el.classList.remove('selected-mode'));
                    this.classList.add('selected-mode');
                    selectedQuizMode = this.dataset.modeId;
                    updateStartButtonState();
                });
            });
        }

        // Hàm thêm listener cho form tìm kiếm (phân trang đã bỏ)
        function addPaginationAndSearchListeners() {
            const searchForm = quizSetsContainer.querySelector('form');
            if (searchForm) {
                searchForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const formData = new FormData(searchForm);
                    const q = formData.get('q') || '';
                    const search_field = formData.get('search_field') || 'all';
                    loadQuizSets(1, q, search_field, currentFilter);
                });
            }
        }

        // Cập nhật trạng thái nút "Bắt đầu học"
        function updateStartButtonState() {
            if (selectedQuizSetId && selectedQuizMode) {
                startLearningBtn.disabled = false;
            } else {
                startLearningBtn.disabled = true;
            }
        }

        // Listener cho nút "Bắt đầu học"
        startLearningBtn.addEventListener('click', function() {
            if (selectedQuizSetId && selectedQuizMode) {
                let startUrl;
                if (selectedQuizSetId === 'all') {
                    startUrl = startQuizSessionBaseUrlAll.replace('placeholder_mode', selectedQuizMode);
                } else {
                    startUrl = startQuizSessionBaseUrlById.replace('/0', `/${selectedQuizSetId}`).replace('placeholder_mode', selectedQuizMode);
                }
                
                window.location.href = startUrl;
            }
        });

        // Listener cho các nút tab lọc (Đang làm, Khám phá)
        filterDoingBtn.addEventListener('click', function() {
            if (currentFilter !== 'doing') {
                currentFilter = 'doing';
                filterDoingBtn.classList.add('active');
                filterDoingBtn.classList.remove('bg-gray-100', 'text-gray-700');
                filterDoingBtn.classList.add('bg-blue-600', 'text-white');

                filterExploreBtn.classList.remove('active');
                filterExploreBtn.classList.add('bg-gray-100', 'text-gray-700');
                filterExploreBtn.classList.remove('bg-blue-600', 'text-white');
                
                loadQuizSets(1, '', 'all', currentFilter); 
            }
        });

        filterExploreBtn.addEventListener('click', function() {
            if (currentFilter !== 'explore') {
                currentFilter = 'explore';
                filterExploreBtn.classList.add('active');
                filterExploreBtn.classList.remove('bg-gray-100', 'text-gray-700');
                filterExploreBtn.classList.add('bg-blue-600', 'text-white');

                filterDoingBtn.classList.remove('active');
                filterDoingBtn.classList.add('bg-gray-100', 'text-gray-700');
                filterDoingBtn.classList.remove('bg-blue-600', 'text-white');

                loadQuizSets(1, '', 'all', currentFilter); 
            }
        });


        // Gắn lại Event Listeners sau khi nội dung được render trực tiếp
        document.addEventListener('DOMContentLoaded', function() {
            addQuizSetClickListeners();
            addPaginationAndSearchListeners(); // Vẫn cần để gắn listener cho form tìm kiếm
            // Cập nhật trạng thái active của nút filter ban đầu
            if (currentFilter === 'doing') {
                filterDoingBtn.classList.add('active');
                filterDoingBtn.classList.remove('bg-gray-100', 'text-gray-700');
                filterDoingBtn.classList.add('bg-blue-600', 'text-white');
            } else if (currentFilter === 'explore') {
                filterExploreBtn.classList.add('active');
                filterExploreBtn.classList.remove('bg-gray-100', 'text-gray-700');
                filterExploreBtn.classList.add('bg-blue-600', 'text-white');
            }
        });
    </script>
{% endblock %}
