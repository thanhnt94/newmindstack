<!-- =============================== -->
<!-- File: mindstack_app/modules/learning/quiz_learning/templates/quiz_learning_dashboard.html -->
<!-- Phiên bản: 1.54 (UI – Badge + Icon, giữ nguyên logic) -->
<!-- Mục đích: Giao diện chính để chọn bộ câu hỏi và chế độ học Quiz. -->
<!-- THAY ĐỔI 1.54:
  - Tiêu đề Quiz thêm icon câu hỏi (FontAwesome) + hiệu ứng vào trang (fade/scale).
  - Không thay đổi logic AJAX, URL hay dữ liệu.  -->
<!-- =============================== -->

{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}
{# Macro render_pagination không dùng trực tiếp ở đây; phần danh sách sử dụng trong _quiz_sets_selection.html #}

{% block title %}Học Quiz - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* bg-gray-50 */
        }
        /* Chọn item & mode */
        .selected-item {
            border-color: #3b82f6 !important; /* blue-500 */
            background-color: #eff6ff !important; /* blue-50 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .selected-mode {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        /* Nút bắt đầu */
        .start-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .tab-filter-button.active { background-color: #3b82f6; color: #fff; }

        /* Một số class giao diện list item (không quyết định màu progress bar) */
        .quiz-set-item {
            position: relative;
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb; /* border-gray-200 */
            overflow: hidden;
            padding: 1rem; /* p-4 */
            transition: all 0.3s ease;
        }
        .quiz-set-item:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); transform: translateY(-2px); }
        .quiz-set-completion-text { font-size: 1rem; font-weight: 600; white-space: nowrap; padding-left: .5rem; padding-right: .5rem; }

        /* ====== TIÊU ĐỀ QUIZ – Badge khung mềm với icon ====== */
        .quiz-title-wrapper { display: flex; justify-content: center; margin-bottom: 2rem; }
        .quiz-title-badge {
            background: linear-gradient(135deg, #e0f2fe, #f0f9ff); /* xanh nhạt rất dịu */
            color: #1e3a8a;
            font-size: 2rem; font-weight: 800;
            padding: 0.75rem 2.5rem; border-radius: 9999px; border: 2px solid #bfdbfe;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            letter-spacing: 0.05em;
            opacity: 0; transform: scale(0.9); transition: all .6s ease;
            display: inline-flex; align-items: center;
        }
        .quiz-title-badge .fa-question-circle { margin-right: .5rem; }
        .quiz-title-badge.show { opacity: 1; transform: scale(1); }
        .quiz-title-badge:hover { box-shadow: 0 6px 14px rgba(30,58,138,0.20); border-color: #60a5fa; }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-1 py-4 sm:px-6 sm:py-6 lg:px-8 lg:py-8">
    <!-- TIÊU ĐỀ QUIZ – Badge khung mềm -->
    <div class="quiz-title-wrapper">
        <div id="quizTitle" class="quiz-title-badge"><i class="fas fa-question-circle"></i>Quiz</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Bước 1: Chọn một bộ câu hỏi -->
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                <i class="fas fa-list-alt mr-3 text-blue-500"></i> Bước 1: Chọn một bộ câu hỏi
            </h2>
            <div class="flex space-x-2 mb-4">
                <button id="filter-doing" class="tab-filter-button px-4 py-2 rounded-md font-medium transition-colors duration-200 {% if current_filter == 'doing' %}active{% endif %}" data-filter="doing"><i class="fas fa-play-circle mr-2"></i> Đang làm</button>
                <button id="filter-explore" class="tab-filter-button px-4 py-2 rounded-md font-medium transition-colors duration-200 {% if current_filter == 'explore' %}active{% endif %}" data-filter="explore"><i class="fas fa-globe mr-2"></i> Khám phá</button>
            </div>
            <div id="quiz-sets-container" class="flex-grow">
                <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]">
                    <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                    <p>Đang tải danh sách bộ câu hỏi...</p>
                </div>
            </div>
        </div>

        <!-- Bước 2: Chọn chế độ học -->
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                <i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học
            </h2>
            <div id="quiz-modes-container" class="flex-grow">
                <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                    <i class="fas fa-info-circle text-4xl mb-3"></i>
                    <p>Vui lòng chọn một bộ câu hỏi trước.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Nút Bắt đầu học -->
    <div class="mt-8 text-center">
        <button id="start-learning-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" disabled>
            <i class="fas fa-play-circle mr-3"></i> Bắt đầu làm bài
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    // Hiệu ứng cho tiêu đề Quiz (fade-in + scale)
    window.addEventListener('DOMContentLoaded', function() {
        var title = document.getElementById('quizTitle');
        if (title) { setTimeout(function(){ title.classList.add('show'); }, 200); }
    });

    console.log('>>> quiz_learning_dashboard.js: init');

    // ==== Biến trạng thái ====
    var selectedQuizSetId = null;
    var selectedQuizMode = null;
    var selectedSessionSize = parseInt("{{ user_default_batch_size | default(10) }}");
    var currentFilter = "{{ current_filter | default('doing') }}";
    var doingPage = 1; var explorePage = 1; var currentPage = (currentFilter === 'doing' ? doingPage : explorePage);

    var quizSetsContainer = document.getElementById('quiz-sets-container');
    var quizModesContainer = document.getElementById('quiz-modes-container');
    var startLearningBtn = document.getElementById('start-learning-btn');
    var filterDoingBtn = document.getElementById('filter-doing');
    var filterExploreBtn = document.getElementById('filter-explore');

    // ==== URL ==== (lấy từ Flask Jinja; không đổi route)
    var quizModesPartialBaseUrlById = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_by_id', set_id=0) or '#' }}";
    var quizModesPartialBaseUrlAll = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_all') or '#' }}";
    var startQuizSessionBaseUrlByIdTemplate = "/learn/start_quiz_session/SET_ID_PLACEHOLDER/MODE_PLACEHOLDER/BATCH_SIZE_PLACEHOLDER";
    var startQuizSessionBaseUrlAllTemplate = "/learn/start_quiz_session/all/MODE_PLACEHOLDER/BATCH_SIZE_PLACEHOLDER";
    var getQuizSetsPartialUrl = "{{ url_for('learning.quiz_learning.get_quiz_sets_partial') or '#' }}";
    var saveQuizSettingsUrl = "{{ url_for('learning.quiz_learning.save_quiz_settings') }}";

    // ==== AJAX: Tải danh sách bộ Quiz ====
    async function loadQuizSets(page, searchQuery, searchField, filter) {
        console.log('loadQuizSets', page, searchQuery, searchField, filter);
        quizSetsContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải danh sách bộ câu hỏi...</p></div>';

        // Reset lựa chọn khi đổi danh sách
        selectedQuizSetId = null; selectedQuizMode = null;
        quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
        updateStartButtonState();

        if (!getQuizSetsPartialUrl || getQuizSetsPartialUrl === '#') {
            console.error('getQuizSetsPartialUrl không hợp lệ.');
            quizSetsContainer.innerHTML = '<p class="text-red-500 text-center">Lỗi cấu hình URL. Vui lòng liên hệ quản trị viên.</p>';
            return;
        }
        try {
            var url = new URL(getQuizSetsPartialUrl, window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('q', searchQuery || '');
            url.searchParams.append('search_field', searchField || 'all');
            url.searchParams.append('filter', filter || 'doing');

            var response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            var html = await response.text();
            quizSetsContainer.innerHTML = html;
            addQuizSetClickListeners();
            addPaginationAndSearchListeners();
            updateQuizSetProgressColors();
        } catch (e) {
            console.error('Lỗi loadQuizSets:', e);
            quizSetsContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải danh sách bộ câu hỏi. Vui lòng thử lại.</p>';
        }
    }

    // ==== AJAX: Tải chế độ học ====
    async function loadQuizModes(setId) {
        console.log('loadQuizModes ->', setId);
        quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải chế độ học...</p></div>';
        try {
            var url;
            if (setId === 'all') { url = quizModesPartialBaseUrlAll; }
            else { url = quizModesPartialBaseUrlById.replace('/0', '/' + setId); }
            if (!url || url === '#') { throw new Error('URL chế độ học không hợp lệ'); }

            var fullUrl = new URL(url, window.location.origin);
            if (selectedQuizMode) { fullUrl.searchParams.append('selected_mode', selectedQuizMode); }
            fullUrl.searchParams.append('user_default_batch_size', selectedSessionSize);

            var response = await fetch(fullUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            var html = await response.text();
            quizModesContainer.innerHTML = html;
            addQuizModeClickListeners();

            // Gắn dropdown số câu hỏi và lưu cài đặt
            var sessionSizeSelect = document.getElementById('session-size-select');
            if (sessionSizeSelect) {
                sessionSizeSelect.value = selectedSessionSize;
                sessionSizeSelect.addEventListener('change', async function(){
                    selectedSessionSize = parseInt(this.value);
                    updateStartButtonState();
                    try {
                        var res = await fetch(saveQuizSettingsUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ batch_size: selectedSessionSize }) });
                        var js = await res.json();
                        if (!js.success) { console.error('Lưu batch_size lỗi:', js.message); }
                    } catch (err) { console.error('AJAX lưu batch_size lỗi:', err); }
                });
            }

            // Tự động chọn mode đầu tiên khả dụng nếu chưa chọn
            if (!selectedQuizMode) {
                var available = Array.from(quizModesContainer.querySelectorAll('.quiz-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                if (available.length > 0) { available[0].click(); }
                else { selectedQuizMode = null; updateStartButtonState(); }
            } else {
                var prev = quizModesContainer.querySelector('[data-mode-id="' + selectedQuizMode + '"]');
                if (prev && parseInt(prev.dataset.count) > 0) { prev.click(); }
                else {
                    selectedQuizMode = null; updateStartButtonState();
                    var available2 = Array.from(quizModesContainer.querySelectorAll('.quiz-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                    if (available2.length > 0) { available2[0].click(); }
                }
            }
        } catch (e) {
            console.error('Lỗi loadQuizModes:', e);
            quizModesContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải chế độ học. Vui lòng thử lại.</p>';
        }
    }

    // ==== Listener: click chọn bộ Quiz ====
    function addQuizSetClickListeners() {
        document.querySelectorAll('.quiz-set-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                var totalItems = parseInt(this.dataset.totalItems);
                if (totalItems === 0) { ev.preventDefault(); ev.stopPropagation(); return; }
                document.querySelectorAll('.quiz-set-item').forEach(function(el){ el.classList.remove('selected-item'); });
                this.classList.add('selected-item');
                selectedQuizSetId = this.dataset.setId;
                updateStartButtonState();
                loadQuizModes(selectedQuizSetId);
            });
        });
    }

    // ==== Listener: click chọn chế độ học ====
    function addQuizModeClickListeners() {
        document.querySelectorAll('.quiz-mode-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                var modeCount = parseInt(this.dataset.count);
                if (modeCount === 0) { ev.preventDefault(); ev.stopPropagation(); return; }
                document.querySelectorAll('.quiz-mode-item').forEach(function(el){ el.classList.remove('selected-mode'); });
                this.classList.add('selected-mode');
                selectedQuizMode = this.dataset.modeId;
                updateStartButtonState();
            });
        });
    }

    // ==== Listener: search + pagination trong partial danh sách ====
    function addPaginationAndSearchListeners() {
        var searchForm = quizSetsContainer.querySelector('form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e){
                e.preventDefault();
                var data = new FormData(searchForm);
                var q = data.get('q') || '';
                var search_field = data.get('search_field') || 'all';
                if (currentFilter === 'doing') { doingPage = 1; } else { explorePage = 1; }
                currentPage = 1;
                loadQuizSets(currentPage, q, search_field, currentFilter);
            });
        }
        document.querySelectorAll('.pagination a').forEach(function(a){
            a.addEventListener('click', function(e){
                e.preventDefault();
                var url = new URL(this.href, window.location.origin);
                var page = parseInt(url.searchParams.get('page')) || 1;
                var q = url.searchParams.get('q') || '';
                var search_field = url.searchParams.get('search_field') || 'all';
                if (currentFilter === 'doing') { doingPage = page; } else { explorePage = page; }
                currentPage = page;
                loadQuizSets(currentPage, q, search_field, currentFilter);
            });
        });
    }

    // ==== Trạng thái nút bắt đầu ====
    function updateStartButtonState() {
        var isSetSelectable = false;
        if (selectedQuizSetId === 'all') { isSetSelectable = true; }
        else if (selectedQuizSetId !== null) {
            var el = document.querySelector('.quiz-set-item[data-set-id="' + selectedQuizSetId + '"]');
            if (el) { var total = parseInt(el.dataset.totalItems); isSetSelectable = (total > 0); }
        }
        var isModeSelectable = false;
        if (selectedQuizMode !== null) {
            var modeEl = quizModesContainer.querySelector('[data-mode-id="' + selectedQuizMode + '"]');
            if (modeEl) { var cnt = parseInt(modeEl.dataset.count); isModeSelectable = (cnt > 0); }
        }
        if (isSetSelectable && isModeSelectable && selectedSessionSize) {
            startLearningBtn.disabled = false;
            startLearningBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            startLearningBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        } else {
            startLearningBtn.disabled = true;
            startLearningBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            startLearningBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        }
    }

    // ==== Cập nhật màu chữ theo % (không còn đặt background-size ở đây) ====
    function updateQuizSetProgressColors() {
        document.querySelectorAll('.quiz-set-item').forEach(function(item){
            var pct = parseInt(item.dataset.completionPercentage || '0');
            var txt = item.querySelector('.quiz-set-completion-text');
            if (txt) { txt.style.color = (pct > 50 ? '#111' : '#333'); }
        });
    }

    // ==== Nút bắt đầu ====
    startLearningBtn.addEventListener('click', function(){
        if (selectedQuizSetId && selectedQuizMode && selectedSessionSize) {
            var startUrl;
            if (selectedQuizSetId === 'all') {
                startUrl = startQuizSessionBaseUrlAllTemplate
                    .replace('MODE_PLACEHOLDER', selectedQuizMode)
                    .replace('BATCH_SIZE_PLACEHOLDER', selectedSessionSize);
            } else {
                startUrl = startQuizSessionBaseUrlByIdTemplate
                    .replace('SET_ID_PLACEHOLDER', selectedQuizSetId)
                    .replace('MODE_PLACEHOLDER', selectedQuizMode)
                    .replace('BATCH_SIZE_PLACEHOLDER', selectedSessionSize);
            }
            window.location.href = startUrl;
        }
    });

    // ==== Chuyển tab Doing/Explore ====
    filterDoingBtn.addEventListener('click', function(){
        if (currentFilter !== 'doing') {
            if (currentFilter === 'explore') { explorePage = currentPage; }
            currentFilter = 'doing'; currentPage = doingPage;
            filterDoingBtn.classList.add('active','bg-blue-600','text-white');
            filterDoingBtn.classList.remove('bg-gray-100','text-gray-700');
            filterExploreBtn.classList.remove('active','bg-blue-600','text-white');
            filterExploreBtn.classList.add('bg-gray-100','text-gray-700');
            loadQuizSets(currentPage, '', 'all', currentFilter);
        }
    });
    filterExploreBtn.addEventListener('click', function(){
        if (currentFilter !== 'explore') {
            if (currentFilter === 'doing') { doingPage = currentPage; }
            currentFilter = 'explore'; currentPage = explorePage;
            filterExploreBtn.classList.add('active','bg-blue-600','text-white');
            filterExploreBtn.classList.remove('bg-gray-100','text-gray-700');
            filterDoingBtn.classList.remove('active','bg-blue-600','text-white');
            filterDoingBtn.classList.add('bg-gray-100','text-gray-700');
            loadQuizSets(currentPage, '', 'all', currentFilter);
        }
    });

    // ==== Khởi tạo ====
    document.addEventListener('DOMContentLoaded', function(){
        loadQuizSets(currentPage, "{{ search_query }}", "{{ search_field }}", currentFilter);
    });
    </script>
{% endblock %}
