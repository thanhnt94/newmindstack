{% extends 'base.html' %}
{% block title %}Phòng học Flashcard chung - {{ room_payload.room_code }}{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    /* --- 1. GLOBAL LAYOUT RESET (Application Mode) --- */
    html {
      height: 100%;
      overflow: hidden; /* Chặn scroll ở root */
    }

    body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Chặn scroll ở body */
      background-color: #f9fafb;
      display: flex;
      flex-direction: column;
    }

    /* Ép footer xuống đáy, main chiếm hết phần còn lại */
    body > footer {
      flex-shrink: 0;
      z-index: 10;
    }

    /* Main container của base.html */
    body > main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Quan trọng để flex con scroll được */
      padding: 0 !important;
      margin: 0 !important;
      max-width: none !important;
      width: 100%;
      overflow: hidden;
    }

    /* --- 2. PAGE SHELL (Lớp vỏ) --- */
    .page-shell {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%; /* Fill 100% main */
      padding: 1rem 1.25rem 1.5rem; /* Padding tổng thể */
      gap: 1rem;
      background: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08), transparent 25%),
        radial-gradient(circle at 90% 30%, rgba(59, 130, 246, 0.06), transparent 25%),
        #f8fafc;
      overflow: hidden; /* Không scroll ở đây */
    }

    @media (max-width: 1024px) {
      .page-shell {
        padding: 0;
        gap: 0;
        background: #f8fafc;
      }
      body > footer { display: none !important; }
    }

    /* --- 3. HERO CARD (Header) --- */
    .hero-card {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
      padding: 1rem 1.5rem;
      
      /* Layout */
      width: 100%;
      max-width: 1440px;
      margin: 0 auto;
      flex-shrink: 0; /* Không co lại */
    }

    @media (max-width: 1024px) {
      .hero-card { display: none; }
    }

    /* --- 4. SESSION LAYOUT (Content Chính) --- */
    .session-layout {
      display: grid;
      grid-template-columns: minmax(0, 5fr) minmax(360px, 2fr);
      gap: 1.25rem;
      
      /* Layout Fill */
      width: 100%;
      max-width: 1440px;
      margin: 0 auto;
      
      flex: 1; /* Chiếm toàn bộ chiều cao còn lại */
      min-height: 0; /* Cho phép con scroll */
      overflow: hidden; /* Chặn scroll tràn ra ngoài */
    }

    @media (max-width: 1024px) {
      .session-layout {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 0 !important;
      }
    }

    /* --- 5. LEFT COLUMN: FLASHCARD --- */
    .card-surface {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.1);
      overflow: hidden;
    }

    .flashcard-panel {
      display: flex;
      flex-direction: column;
      height: 100%; /* Fill cột trái */
      padding: 1.25rem;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(248, 250, 252, 0.96));
      gap: 1rem;
      min-height: 0; /* Fix flex overflow */
    }

    @media (max-width: 1024px) {
      .flashcard-panel { padding: 1rem; gap: 0.75rem; }
    }

    .flashcard-card-container {
      perspective: 1200px;
      width: 100%;
      flex: 1; /* Fill phần còn lại của panel */
      display: flex;
      flex-direction: column;
      min-height: 0; /* Fix flex overflow */
      position: relative;
    }

    .flashcard-card {
      width: 100%;
      height: 100%; /* Card chiếm hết container */
      position: relative;
      background-color: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 18px;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.08);
      transform-style: preserve-3d;
      transition: box-shadow .3s ease, transform .3s ease;
      /* Vars */
      --card-accent-bg: linear-gradient(135deg, #6366f1, #2563eb);
      --card-accent-hover-bg: linear-gradient(135deg, #4f46e5, #1d4ed8);
      --card-accent-rgb: 37, 99, 235;
      --card-accent-shadow: 0 16px 32px rgba(var(--card-accent-rgb), 0.22);
      --card-accent-hover-shadow: 0 20px 40px rgba(var(--card-accent-rgb), 0.3);
    }

    .face {
      position: absolute; inset: 0;
      padding: 60px 1.5rem 1.5rem 1.5rem;
      display: flex; flex-direction: column; justify-content: space-between;
      gap: 10px; backface-visibility: hidden;
      transition: transform .6s ease-in-out, opacity .3s ease-in-out;
      z-index: 1; opacity: 0; pointer-events: none;
      overflow: hidden;
    }

    .front { transform: rotateY(0deg); }
    .back { transform: rotateY(180deg); }

    .flashcard-card:not(.flipped) .front { opacity: 1; pointer-events: auto; }
    .flashcard-card:not(.flipped) .back { opacity: 0; pointer-events: none; }
    .flashcard-card.flipped .front { transform: rotateY(180deg); opacity: 0; pointer-events: none; }
    .flashcard-card.flipped .back { transform: rotateY(360deg); opacity: 1; pointer-events: auto; }

    ._card-container {
      flex: 1 1 auto; min-height: 0;
      padding: 0 1rem; display: flex; flex-direction: column; overflow: hidden;
    }

    .text-area {
      flex-grow: 1; min-height: 0; width: 100%;
      overflow-y: auto; /* Scroll nội dung thẻ nếu dài */
      padding: 1rem 0; display: flex; align-items: center; justify-content: center;
      scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;
    }

    /* --- 6. RIGHT COLUMN: SIDEBAR (Quan trọng) --- */
    .session-sidebar {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      height: 100%; /* Fill chiều cao lưới cha */
      min-height: 0; /* Fix flex overflow */
      overflow: hidden; /* Chặn scroll tổng sidebar */
    }

    .sidebar-card {
      padding: 1.1rem 1.2rem;
      display: flex; flex-direction: column; gap: 0.75rem;
      flex-shrink: 0; /* Info cards không bị bóp méo */
    }

    /* CHAT PANEL TRONG SIDEBAR */
    .session-sidebar .chat-panel {
      flex: 1; /* Chiếm hết không gian còn lại */
      min-height: 0; /* Quan trọng: cho phép co lại */
      display: flex;
      flex-direction: column;
      background: transparent; /* Bỏ background overlay của mobile */
      padding: 0;
      position: relative;
      inset: auto;
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* CHAT BOX */
    .chat-box {
      background: #ffffff;
      border-radius: 20px; /* Khớp bo góc */
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      height: 100%; /* Fill chat panel */
      min-height: 0;
      padding: 1.1rem 1.2rem;
      gap: 0.5rem;
    }

    /* KHUNG TIN NHẮN */
    .chat-messages {
      flex: 1; /* Chiếm hết không gian trống giữa header và input */
      min-height: 0; /* Cho phép scroll */
      overflow-y: auto; /* Bật scroll dọc */
      padding: 0.5rem;
      border-radius: 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      /* Styling scrollbar */
      scrollbar-width: thin;
    }

    .chat-messages p.text-slate-500 { text-align: center; margin-top: 1rem; }

    /* --- OTHER UI --- */
    .card-toolbar {
      display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;
      padding: 0.75rem 1rem; position: absolute; width: 100%; top: 0; left: 0; z-index: 30;
      background: rgba(255, 255, 255, 0.94); border-bottom: 1px solid rgba(148, 163, 184, 0.18); backdrop-filter: blur(8px);
    }
    .toolbar-left, .toolbar-right { display: inline-flex; align-items: center; gap: 0.35rem; flex: 1; }
    .toolbar-right { justify-content: flex-end; }
    .card-toolbar .mobile-info-btn { display: none; }
    
    .card-toolbar .label {
      text-transform: uppercase; font-weight: 700; color: #475569; font-size: 0.95rem;
      padding: 0.35rem 0.75rem; background: #f8fafc; border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35); box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06); flex: 1; text-align: center;
    }
    .card-toolbar .icon-btn, .card-toolbar .play-audio-btn { cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .card-toolbar .icon-btn { width: 40px; height: 40px; border-radius: 12px; background: #f8fafc; color: #475569; border: 1px solid rgba(148, 163, 184, 0.28); }
    .card-toolbar .play-audio-btn { width: 44px; height: 44px; border-radius: 14px; background: var(--card-accent-bg); color: #fff; border: none; box-shadow: var(--card-accent-shadow); }
    
    .flashcard-content-text { font-size: clamp(1.25rem, 5vw, 2rem); font-weight: 700; color: #1f2937; text-align: center; max-width: 100%; }
    .back .flashcard-content-text { font-size: clamp(1rem, 4vw, 22px); line-height: 1.5; color: #111827; text-align: left; white-space: pre-wrap; }

    .actions { display: none; gap: 1rem; padding: 1.25rem 1.5rem; width: 100%; background: linear-gradient(180deg, #f8fafc 0%, #ffffff 55%); border-top: 1px solid #e2e8f0; z-index: 2; }
    .actions.visible { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .btn { border: none; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; border-radius: 0.9rem; cursor: pointer; padding: 0.9rem 1.25rem; box-shadow: 0 12px 26px rgba(15, 23, 42, 0.08); transition: all 0.2s ease; }
    .rating-btn { color: #fff; flex-direction: row; text-align: left; padding: 0.75rem 1rem; }
    .rating-btn__icon { width: 2rem; height: 2rem; border-radius: 999px; background: rgba(255, 255, 255, 0.18); display: inline-flex; align-items: center; justify-content: center; }
    .rating-btn--again { background: linear-gradient(135deg, #f87171, #dc2626); }
    .rating-btn--hard { background: linear-gradient(135deg, #f59e0b, #b45309); color: #1f2937; } .rating-btn--hard .rating-btn__icon { background: rgba(15, 23, 42, 0.12); color: #1f2937; }
    .rating-btn--good { background: linear-gradient(135deg, #34d399, #059669); }
    .pill { display: inline-flex; align-items: center; gap: 0.4rem; border-radius: 999px; padding: 0.4rem 0.85rem; font-weight: 600; font-size: 0.85rem; }

    /* --- MOBILE OVERRIDES --- */
    .mobile-chat-toggle { display: none; position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999; width: 3.5rem; height: 3.5rem; border-radius: 50%; background: linear-gradient(135deg, #4f46e5, #0ea5e9); color: #fff; align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .mobile-chat-toggle.is-active { opacity: 0; visibility: hidden; pointer-events: none; }
    
    .chat-panel .close-chat-btn { display: none; } /* Ẩn nút đóng ở desktop */
    .mobile-score-banner, .mobile-info-panel { display: none; }

    @media (max-width: 1024px) {
      .session-sidebar { display: none !important; } /* Ẩn cột phải ở mobile */
      .actions { padding: 0.75rem; gap: 0.5rem; position: sticky; bottom: 0; }
      .flashcard-card-container { min-height: 60vh; }
      .card-toolbar .mobile-info-btn { display: inline-flex; }
      
      /* Chat Panel Mobile Overlay */
      .chat-panel {
        display: flex; position: fixed; inset: 0; z-index: 9990;
        background: rgba(15, 23, 42, 0.45); backdrop-filter: blur(8px);
        align-items: flex-end; justify-content: center; padding: 0.75rem;
        opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.3s ease;
      }
      .chat-panel .chat-box {
        width: 100%; max-width: 720px; height: 90vh !important; 
        background: #ffffff; border-radius: 18px 18px 0 0; padding-bottom: 1.5rem;
        transform: translateY(12%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .chat-panel.open { opacity: 1; visibility: visible; pointer-events: auto; }
      .chat-panel.open .chat-box { transform: translateY(0); }
      .chat-panel .close-chat-btn { display: inline-flex; } /* Hiện nút đóng ở mobile */
      
      .mobile-chat-toggle { display: flex; }
      .mobile-info-panel { display: none; position: fixed; inset: 0; z-index: 50; background: rgba(15, 23, 42, 0.4); align-items: flex-end; justify-content: center; }
      .mobile-info-panel.open { display: flex; }
      .mobile-info-sheet { width: 100%; max-width: 720px; background: #ffffff; border-radius: 18px 18px 0 0; padding: 1.25rem; overflow-y: auto; max-height: 78vh; }
      .mobile-score-banner { display: flex; flex-direction: column; gap: 0.75rem; padding: 0.75rem; border-radius: 12px; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; }
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-shell">
  <!-- HERO CARD: Thông tin phòng -->
  <div class="hero-card">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div>
        <p class="text-xs uppercase tracking-[0.25em] text-slate-500">Phòng học Flashcard</p>
        <h1 class="text-3xl font-extrabold text-slate-900">{{ room_payload.title or 'Phòng học chung' }}</h1>
        <div class="flex items-center flex-wrap gap-2 mt-2 text-sm text-slate-600">
          <span class="pill bg-slate-100 text-slate-700"><i class="fas fa-layer-group"></i> {{ room_payload.container_title or ('Bộ #' ~ room_payload.container_id) }}</span>
          <span class="pill bg-indigo-50 text-indigo-700"><i class="fas fa-bolt"></i> Chế độ: {{ room_payload.mode }}</span>
          <span class="pill bg-emerald-50 text-emerald-700"><i class="fas fa-user"></i> Chủ phòng: {{ room_payload.host_username or '—' }}</span>
          <span class="pill bg-slate-200 text-slate-800 font-mono">Mã: {{ room_payload.room_code }}</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" id="copy-room-code" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
          <i class="fas fa-copy"></i> Sao chép mã
        </button>
        <a href="{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
          <i class="fas fa-arrow-left"></i> Quay lại danh sách phòng
        </a>
      </div>
    </div>
  </div>

  <div class="session-layout">
    <!-- CỘT TRÁI: FLASHCARD -->
    <div class="card-surface flashcard-panel" id="collab-learning-card">
      <div class="flex items-start justify-between gap-3 collab-room-meta hidden lg:flex">
        <div>
          <p class="text-sm text-slate-500">Thẻ tiếp theo sẽ xuất hiện khi tất cả thành viên đã trả lời.</p>
          <div class="flex items-center gap-2 mt-2 text-sm text-slate-600">
            <span class="pill bg-amber-50 text-amber-700"><i class="fas fa-circle-notch animate-spin"></i> Đang tải thẻ đầu tiên...</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-right">
            <p class="text-xs text-slate-500">Điểm của bạn</p>
            <p class="text-2xl font-extrabold text-indigo-600" id="collab-user-score">{{ current_user.total_score or 0 }}</p>
          </div>
          <button type="button" id="collab-refresh-round" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
            <i class="fas fa-rotate"></i> Làm mới thẻ
          </button>
        </div>
      </div>

      <div class="flashcard-card-container">
        <div class="flashcard-card" id="collab-card">
          <div class="face front">
            <div class="card-toolbar">
              <div class="toolbar-left">
                <button type="button" class="icon-btn mobile-info-btn open-mobile-info-btn" title="Mở menu phòng"><i class="fas fa-bars"></i></button>
                <button type="button" class="icon-btn collab-ai-btn" title="Mindstack AI"><i class="fas fa-robot"></i></button>
                <button type="button" class="icon-btn collab-note-btn" title="Ghi chú"><i class="fas fa-sticky-note"></i></button>
              </div>
              <span class="label">Mặt trước</span>
              <div class="toolbar-right">
                <button type="button" class="icon-btn collab-feedback-btn" title="Phản hồi"><i class="fas fa-flag"></i></button>
                <button type="button" class="icon-btn collab-edit-btn" title="Chỉnh sửa"><i class="fas fa-pencil-alt"></i></button>
                <button type="button" class="play-audio-btn collab-audio-btn" title="Nghe nội dung"><i class="fas fa-headphones"></i></button>
              </div>
            </div>
            <div class="_card-container">
              <div class="text-area"><div id="collab-card-front" class="flashcard-content-text">—</div></div>
            </div>
            <div class="flex justify-center p-4">
              <button type="button" id="collab-flip-btn" class="flip-card-btn">
                <i class="fas fa-sync-alt"></i> Lật thẻ
              </button>
            </div>
          </div>
            <div class="face back">
              <div class="card-toolbar">
                <div class="toolbar-left">
                <button type="button" class="icon-btn mobile-info-btn open-mobile-info-btn" title="Mở menu phòng"><i class="fas fa-bars"></i></button>
                  <button type="button" class="icon-btn collab-ai-btn" title="Mindstack AI"><i class="fas fa-robot"></i></button>
                  <button type="button" class="icon-btn collab-note-btn" title="Ghi chú"><i class="fas fa-sticky-note"></i></button>
                </div>
              <span class="label">Mặt sau</span>
              <div class="toolbar-right">
                <button type="button" class="icon-btn collab-feedback-btn" title="Phản hồi"><i class="fas fa-flag"></i></button>
                <button type="button" class="icon-btn collab-edit-btn" title="Chỉnh sửa"><i class="fas fa-pencil-alt"></i></button>
                <button type="button" class="play-audio-btn collab-audio-btn" title="Nghe nội dung"><i class="fas fa-headphones"></i></button>
              </div>
            </div>
            <div class="_card-container">
              <div class="text-area"><div id="collab-card-back" class="flashcard-content-text">—</div></div>
            </div>
            <div class="actions" id="collab-answer-actions" data-button-count="3">
              <button type="button" data-answer="quên" class="collab-answer-btn btn rating-btn rating-btn--again">
                <span class="rating-btn__icon"><i class="fas fa-times"></i></span>
                <span class="rating-btn__title">Quên</span>
              </button>
              <button type="button" data-answer="mơ_hồ" class="collab-answer-btn btn rating-btn rating-btn--hard">
                <span class="rating-btn__icon"><i class="fas fa-adjust"></i></span>
                <span class="rating-btn__title">Mơ hồ</span>
              </button>
              <button type="button" data-answer="nhớ" class="collab-answer-btn btn rating-btn rating-btn--good">
                <span class="rating-btn__icon"><i class="fas fa-check"></i></span>
                <span class="rating-btn__title">Nhớ</span>
              </button>
            </div>
            <p id="collab-answer-feedback" class="text-xs text-slate-600 px-6 pb-2"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- CỘT PHẢI: SIDEBAR + CHAT -->
    <div class="session-sidebar" id="sidebar-container">
      <!-- Info Card 1 -->
      <div class="card-surface sidebar-card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold text-slate-800">Trạng thái lượt & thành viên</p>
            <p class="text-xs text-slate-500">Theo dõi tiến trình</p>
          </div>
          <span id="collab-round-step" class="text-xs font-mono text-slate-500"></span>
        </div>
        <div class="combined-status">
          <div class="space-y-2">
            <p class="text-sm font-semibold text-slate-800">Diễn biến lượt</p>
            <div id="collab-round-status" class="flex flex-col gap-2 text-sm text-slate-700"></div>
          </div>
          <div class="space-y-2">
            <div class="flex items-center justify-between text-sm font-semibold text-slate-800">
              <span>Danh sách tham gia</span>
              <span class="pill bg-slate-100 text-slate-700 text-xs" id="collab-participant-count">{{ room_payload.participants | length }}</span>
            </div>
            <ul id="collab-round-participants" class="divide-y divide-slate-200 text-sm text-slate-700"></ul>
          </div>
        </div>
      </div>

      <!-- Info Card 2 -->
      <div class="card-surface sidebar-card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Thông tin phòng</p>
            <p class="text-lg font-semibold text-slate-900">{{ room_payload.container_title or ('Bộ #' ~ room_payload.container_id) }}</p>
          </div>
          <span class="pill bg-indigo-50 text-indigo-700"><i class="fas fa-bolt"></i> {{ room_payload.mode }}</span>
        </div>
        <div class="grid grid-cols-2 gap-3 text-sm text-slate-700">
          <div class="bg-slate-50 rounded-lg p-3">
            <p class="text-xs text-slate-500">Chủ phòng</p>
            <p class="font-semibold">{{ room_payload.host_username or '—' }}</p>
          </div>
          <div class="bg-slate-50 rounded-lg p-3">
            <p class="text-xs text-slate-500">Tổng thành viên</p>
            <p class="font-semibold" id="collab-participant-count-static">{{ room_payload.participants | length }}</p>
          </div>
        </div>
      </div>
      
      <!-- Chat Panel (Desktop: Sẽ được JS move vào đây) -->
      <!-- Lưu ý: Khi ở trong sidebar, nó sẽ chiếm flex: 1 -->
    </div>
  </div>

  <!-- CHAT PANEL: Mặc định nằm ngoài để JS move -->
  <div id="collab-chat-panel" class="chat-panel">
    <!-- class chat-box sẽ là flex container -->
    <div class="chat-box">
      <div class="flex items-center justify-between flex-shrink-0">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Trò chuyện</p>
          <p class="text-lg font-semibold text-slate-900">Trao đổi trong phòng</p>
        </div>
        <button type="button" class="close-chat-btn inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-sm font-semibold text-slate-700 hover:bg-slate-200">
          <i class="fas fa-times"></i> Đóng
        </button>
      </div>
      
      <div class="mobile-score-banner flex-shrink-0">
        <div id="collab-chat-round-status" class="text-sm font-medium text-slate-700 pb-2 border-b border-slate-100">
           Đang tải trạng thái...
        </div>
        <div class="pt-2">
           <div class="flex justify-between items-center mb-1">
              <p class="text-xs uppercase tracking-wide text-slate-500">Bảng xếp hạng</p>
              <span class="text-xs text-slate-400" id="collab-chat-participant-count">0 thành viên</span>
           </div>
           <ul id="collab-chat-participants" class="grid grid-cols-2 gap-2 text-sm"></ul>
        </div>
      </div>

      <div id="collab-chat-messages" class="chat-messages space-y-2 text-sm text-slate-800">
        <p class="text-slate-500">Đang tải tin nhắn...</p>
      </div>
      
      <form id="collab-chat-form" class="flex gap-2 flex-shrink-0 pt-2">
        <input id="collab-chat-input" type="text" class="flex-1 rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-indigo-200" placeholder="Nhập tin nhắn..." autocomplete="off">
        <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
          <i class="fas fa-paper-plane"></i> Gửi
        </button>
      </form>
    </div>
  </div>

  <!-- MOBILE INFO PANEL -->
  <div id="collab-mobile-info-panel" class="mobile-info-panel">
    <div class="mobile-info-sheet space-y-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Phòng học Flashcard</p>
          <p class="text-xl font-bold text-slate-900">{{ room_payload.title or 'Phòng học chung' }}</p>
          <p class="text-sm text-slate-600">Chế độ: {{ room_payload.mode }} · Mã: {{ room_payload.room_code }}</p>
        </div>
        <button type="button" class="icon-btn close-mobile-info-btn" title="Đóng"><i class="fas fa-times"></i></button>
      </div>

      <div class="rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-2">
        <p class="text-sm text-slate-600">Thẻ tiếp theo sẽ xuất hiện khi tất cả thành viên đã trả lời.</p>
        <div id="collab-round-status-mobile" class="flex flex-wrap items-center gap-2 text-sm text-slate-700">
          <span class="pill bg-amber-50 text-amber-700"><i class="fas fa-circle-notch animate-spin"></i> Đang tải thẻ đầu tiên...</span>
        </div>
        <div class="flex items-center justify-between gap-3 pt-2 border-t border-slate-200">
          <div>
            <p class="text-xs text-slate-500">Điểm của bạn</p>
            <p class="text-2xl font-extrabold text-indigo-600" id="collab-user-score-mobile-menu">{{ current_user.total_score or 0 }}</p>
          </div>
          <div class="text-right">
            <p class="text-xs text-slate-500">Thứ tự thẻ</p>
            <p class="text-sm font-semibold text-slate-800" id="collab-round-step-mobile">—</p>
          </div>
          <button type="button" id="collab-refresh-round-mobile" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
            <i class="fas fa-rotate"></i> Làm mới thẻ
          </button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 text-sm text-slate-700">
        <div class="bg-slate-50 rounded-lg p-3">
          <p class="text-xs text-slate-500">Chủ phòng</p>
          <p class="font-semibold">{{ room_payload.host_username or '—' }}</p>
        </div>
        <div class="bg-slate-50 rounded-lg p-3">
          <p class="text-xs text-slate-500">Trạng thái</p>
          <p class="font-semibold capitalize">{{ room_payload.status }}</p>
        </div>
        <div class="bg-slate-50 rounded-lg p-3">
          <p class="text-xs text-slate-500">Mã phòng</p>
          <p class="font-mono tracking-widest text-sm">{{ room_payload.room_code }}</p>
        </div>
        <div class="bg-slate-50 rounded-lg p-3">
          <p class="text-xs text-slate-500">Tổng thành viên</p>
          <p class="font-semibold" id="collab-participant-count-mobile">{{ room_payload.participants | length }}</p>
        </div>
      </div>

      <div class="space-y-2">
        <p class="text-sm font-semibold text-slate-800">Danh sách tham gia</p>
        <ul id="collab-round-participants-mobile" class="divide-y divide-slate-200 text-sm text-slate-700"></ul>
      </div>
    </div>
  </div>

  <button type="button" id="open-chat-btn" class="mobile-chat-toggle" aria-label="Mở chat">
    <i class="fas fa-comments" aria-hidden="true"></i>
  </button>

  {% include 'notes/_note_panel.html' %}
  {% include 'ai_services/_ai_modal.html' %}
  {% include 'feedback/_feedback_modal.html' %}
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const setVh = () => {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    };

    setVh();
    window.addEventListener('resize', setVh);
    window.addEventListener('orientationchange', setVh);

    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('flashcard-session-active');
    });
    window.addEventListener('beforeunload', () => {
      document.body.classList.remove('flashcard-session-active');
    });

    document.getElementById('copy-room-code')?.addEventListener('click', () => {
      const code = {{ room_payload.room_code | tojson }};
      navigator.clipboard.writeText(code).catch(() => {});
    });

    // --- FIX: LOGIC TỰ ĐỘNG CHUYỂN VỊ TRÍ KHUNG CHAT ---
    (() => {
      const chatPanel = document.getElementById('collab-chat-panel');
      const sidebarContainer = document.getElementById('sidebar-container');
      const pageShell = document.querySelector('.page-shell');

      const repositionChat = () => {
        if (!chatPanel || !sidebarContainer || !pageShell) return;
        
        const isMobile = window.innerWidth <= 1024;

        if (isMobile) {
          if (chatPanel.parentElement !== pageShell) {
            pageShell.appendChild(chatPanel);
          }
        } else {
          if (chatPanel.parentElement !== sidebarContainer) {
            sidebarContainer.appendChild(chatPanel);
          }
        }
      };

      repositionChat();
      window.addEventListener('resize', repositionChat);
    })();

    // Flashcard Logic
    (() => {
      const nextCardUrl = {{ url_for('learning.flashcard_collab.get_next_card', room_code=room_payload.room_code) | tojson }};
      const submitAnswerUrl = {{ url_for('learning.flashcard_collab.submit_collab_answer', room_code=room_payload.room_code) | tojson }};
      const currentUserId = {{ current_user.user_id }};
      const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfHeaders = csrfTokenMeta ? { 'X-CSRFToken': csrfTokenMeta.getAttribute('content') } : {};

      const cardFrontEl = document.getElementById('collab-card-front');
      const cardBackEl = document.getElementById('collab-card-back');
      const cardEl = document.getElementById('collab-card');
      const statusEl = document.getElementById('collab-round-status');
      const participantsEl = document.getElementById('collab-round-participants');
      const answerButtons = document.querySelectorAll('.collab-answer-btn');
      const answerActionsEl = document.getElementById('collab-answer-actions');
      const feedbackEl = document.getElementById('collab-answer-feedback');
      const refreshBtn = document.getElementById('collab-refresh-round');
      const refreshBtnMobile = document.getElementById('collab-refresh-round-mobile');
      const flipBtn = document.getElementById('collab-flip-btn');
      const roundStepEl = document.getElementById('collab-round-step');
      const userScoreEl = document.getElementById('collab-user-score');
      const mobileUserScoreMenuEl = document.getElementById('collab-user-score-mobile-menu');
      
      const chatRoundStatusEl = document.getElementById('collab-chat-round-status');
      const chatParticipantsEl = document.getElementById('collab-chat-participants');
      const chatParticipantCountEl = document.getElementById('collab-chat-participant-count');

      const participantCountEls = [
        document.getElementById('collab-participant-count'),
        document.getElementById('collab-participant-count-static'),
        document.getElementById('collab-participant-count-mobile'),
      ].filter(Boolean);
      const noteButtons = document.querySelectorAll('.collab-note-btn');
      const aiButtons = document.querySelectorAll('.collab-ai-btn');
      const feedbackButtons = document.querySelectorAll('.collab-feedback-btn');
      const editButtons = document.querySelectorAll('.collab-edit-btn');
      const audioButtons = document.querySelectorAll('.collab-audio-btn');
      const notePanel = document.getElementById('note-panel');
      const noteTextarea = document.getElementById('note-textarea');
      const saveNoteBtn = document.getElementById('save-note-btn');
      const cancelNoteBtn = document.getElementById('cancel-note-btn');
      const mobileInfoPanel = document.getElementById('collab-mobile-info-panel');
      const openMobileInfoBtns = document.querySelectorAll('.open-mobile-info-btn');
      const closeMobileInfoBtn = document.querySelector('.close-mobile-info-btn');
      const mobileRoundStatusEl = document.getElementById('collab-round-status-mobile');
      const mobileRoundParticipantsEl = document.getElementById('collab-round-participants-mobile');
      const mobileRoundStepEl = document.getElementById('collab-round-step-mobile');

      const editUrlTemplate = {{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=room_payload.container_id, item_id=0) | tojson }};

      let currentRound = null;
      let currentCardId = null;
      let isFetching = false;
      let pollHandle = null;
      let hasAnsweredCurrentCard = false;
      let isSpeaking = false;

      const toggleMobileInfoPanel = (isOpen) => {
        if (!mobileInfoPanel) return;
        mobileInfoPanel.classList.toggle('open', isOpen);
      };

      const syncAnswerButtonsAvailability = () => {
        const shouldDisable = hasAnsweredCurrentCard || !cardEl?.classList.contains('flipped');
        answerButtons.forEach((btn) => {
          btn.disabled = shouldDisable;
          btn.classList.toggle('opacity-60', shouldDisable);
        });
      };

      const showFrontSide = () => {
        if (!cardEl) return;
        cardEl.classList.remove('flipped');
        answerActionsEl?.classList.remove('visible');
        flipBtn?.classList.remove('hidden');
        feedbackEl.textContent = '';
        hasAnsweredCurrentCard = false;
        syncAnswerButtonsAvailability();
      };

      const showBackSide = () => {
        if (!cardEl) return;
        cardEl.classList.add('flipped');
        answerActionsEl?.classList.add('visible');
        flipBtn?.classList.add('hidden');
        syncAnswerButtonsAvailability();
      };

      const setLoadingState = (message) => {
        const content = message || 'Đang tải...';
        const loadingHtml = `<span class="text-slate-600">${content}</span>`;
        
        if (statusEl) statusEl.innerHTML = content;
        if (mobileRoundStatusEl) mobileRoundStatusEl.innerHTML = loadingHtml;
        if (chatRoundStatusEl) chatRoundStatusEl.innerHTML = loadingHtml;
      };

      const renderParticipants = (participants = []) => {
        if (!participants.length) {
          const emptyHtml = '<li class="py-2 text-slate-500">Chưa có thành viên đang hoạt động.</li>';
          participantsEl.innerHTML = emptyHtml;
          if (mobileRoundParticipantsEl) mobileRoundParticipantsEl.innerHTML = emptyHtml;
          if (chatParticipantsEl) chatParticipantsEl.innerHTML = '<li class="col-span-2 text-xs text-slate-500 italic">Trống</li>';
          
          participantCountEls.forEach((el) => el.textContent = '0');
          if (chatParticipantCountEl) chatParticipantCountEl.textContent = '0 thành viên';
          return;
        }

        const renderedParticipants = participants.map((participant) => {
          const statusLabel = participant.has_answered ? 'Đã trả lời' : 'Chưa trả lời';
          const statusClass = participant.has_answered ? 'text-green-600' : 'text-slate-500';
          return `
            <li class="py-2 flex items-center justify-between">
              <div>
                <p class="font-semibold">${participant.username || 'Người dùng #' + participant.user_id}</p>
                <p class="text-xs text-slate-500">ID: ${participant.user_id}</p>
              </div>
              <span class="text-xs font-semibold ${statusClass}">${statusLabel}</span>
            </li>
          `;
        }).join('');

        const renderedChatParticipants = participants.map((participant) => {
          const isMe = Number(participant.user_id) === Number(currentUserId);
          const statusDot = participant.has_answered 
            ? '<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>' 
            : '<span class="inline-block w-2 h-2 rounded-full bg-slate-300 mr-1"></span>';
          const score = participant.total_score || 0;
          
          return `
            <li class="flex items-center justify-between bg-white rounded border border-slate-100 px-2 py-1 shadow-sm">
              <div class="flex items-center truncate mr-2">
                ${statusDot}
                <span class="truncate font-medium text-slate-700 ${isMe ? 'text-indigo-600' : ''}">
                  ${isMe ? 'Bạn' : (participant.username || `#${participant.user_id}`)}
                </span>
              </div>
              <span class="font-bold text-slate-900">${score}</span>
            </li>
          `;
        }).join('');

        participantsEl.innerHTML = renderedParticipants;
        if (mobileRoundParticipantsEl) mobileRoundParticipantsEl.innerHTML = renderedParticipants;
        if (chatParticipantsEl) chatParticipantsEl.innerHTML = renderedChatParticipants;

        participantCountEls.forEach((el) => el.textContent = participants.length);
        if (chatParticipantCountEl) chatParticipantCountEl.textContent = `${participants.length} thành viên`;
      };

      const renderRound = (roundPayload) => {
        currentRound = roundPayload;
        const { item, participants = [], all_answered: allAnswered, status } = roundPayload;

        const itemId = item?.item_id || null;
        if (itemId !== currentCardId) {
          currentCardId = itemId;
          showFrontSide();
        }

        cardFrontEl.textContent = (item?.content?.front || 'Không có nội dung mặt trước').trim();
        cardBackEl.textContent = (item?.content?.back || 'Không có nội dung mặt sau').trim();
        renderParticipants(participants);

        const currentUserParticipation = participants.find((p) => Number(p.user_id) === Number(currentUserId));
        hasAnsweredCurrentCard = !!currentUserParticipation?.has_answered;
        feedbackEl.textContent = hasAnsweredCurrentCard ? 'Bạn đã trả lời, vui lòng chờ mọi người hoàn tất.' : 'Nhấn “Lật thẻ” để xem đáp án.';
        if (hasAnsweredCurrentCard) {
          showBackSide();
        } else {
          syncAnswerButtonsAvailability();
        }

        let statusHtml = '';
        if (status === 'completed' && allAnswered) {
          statusHtml = '<span class="pill bg-emerald-50 text-emerald-700"><i class="fas fa-check-circle"></i> Tất cả thành viên đã trả lời. Đang chuẩn bị thẻ tiếp theo...</span>';
        } else if (!allAnswered) {
          statusHtml = '<span class="pill bg-amber-50 text-amber-700"><i class="fas fa-hourglass-half"></i> Đang chờ tất cả thành viên trả lời...</span>';
        } else {
          statusHtml = '<span class="pill bg-indigo-50 text-indigo-700"><i class="fas fa-circle"></i> Đang hiển thị thẻ mới.</span>';
        }

        if (statusEl) statusEl.innerHTML = statusHtml;
        if (mobileRoundStatusEl) mobileRoundStatusEl.innerHTML = statusHtml;
        if (chatRoundStatusEl) chatRoundStatusEl.innerHTML = statusHtml;

        roundStepEl.textContent = `Thẻ #${item?.item_id || '—'}`;
        if (mobileRoundStepEl) mobileRoundStepEl.textContent = `Thẻ #${item?.item_id || '—'}`;
      };

      const fetchRound = async (showLoader = false) => {
        if (isFetching) return;
        isFetching = true;
        if (showLoader) setLoadingState('Đang tải thẻ...');
        try {
          const response = await fetch(nextCardUrl, { credentials: 'same-origin' });
          if (!response.ok) {
            throw new Error('Không thể tải thẻ.');
          }
          const payload = await response.json();
          if (payload) {
            renderRound(payload);
          }
        } catch (err) {
          const errorHtml = `<span class="text-rose-600">${err.message || 'Không thể tải thẻ.'}</span>`;
          if (statusEl) statusEl.innerHTML = errorHtml;
          if (mobileRoundStatusEl) mobileRoundStatusEl.innerHTML = errorHtml;
          if (chatRoundStatusEl) chatRoundStatusEl.innerHTML = errorHtml;
        } finally {
          isFetching = false;
        }
      };

      const submitAnswer = async (answerLabel) => {
        if (!currentRound?.item?.item_id || isFetching) return;
        isFetching = true;
        feedbackEl.textContent = 'Đang gửi câu trả lời...';

        if (cardEl && !cardEl.classList.contains('flipped')) {
          showBackSide();
        }

        try {
          const response = await fetch(submitAnswerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({
              item_id: currentRound.item.item_id,
              answer: answerLabel,
            }),
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload?.description || 'Không thể gửi câu trả lời.');
          }

          const payload = await response.json();
          if (payload?.round) {
            renderRound(payload.round);
          }

          const result = payload?.result;
          if (result && typeof result.updated_total_score === 'number') {
            if (userScoreEl) userScoreEl.textContent = result.updated_total_score;
            if (mobileUserScoreMenuEl) mobileUserScoreMenuEl.textContent = result.updated_total_score;
          }
          if (result?.answer_result === 'correct') {
            feedbackEl.textContent = 'Bạn đã trả lời đúng. Chờ các thành viên khác để chuyển thẻ.';
          } else if (result?.answer_result === 'incorrect') {
            feedbackEl.textContent = 'Bạn đã trả lời sai. Chờ các thành viên khác để chuyển thẻ.';
          } else {
            feedbackEl.textContent = 'Đã ghi nhận câu trả lời của bạn.';
          }
          hasAnsweredCurrentCard = true;
          syncAnswerButtonsAvailability();
        } catch (err) {
          feedbackEl.textContent = err.message || 'Có lỗi xảy ra.';
          fetchRound(true);
        } finally {
          isFetching = false;
        }
      };

      const startPolling = () => {
        if (pollHandle) return;
        pollHandle = setInterval(() => fetchRound(false), 4000);
      };

      const stopPolling = () => {
        if (!pollHandle) return;
        clearInterval(pollHandle);
        pollHandle = null;
      };

      answerButtons.forEach((btn) => {
        btn.addEventListener('click', () => submitAnswer(btn.dataset.answer));
      });

      flipBtn?.addEventListener('click', showBackSide);

      refreshBtn?.addEventListener('click', () => fetchRound(true));
      refreshBtnMobile?.addEventListener('click', () => fetchRound(true));

      openMobileInfoBtns.forEach((btn) => btn.addEventListener('click', () => toggleMobileInfoPanel(true)));
      closeMobileInfoBtn?.addEventListener('click', () => toggleMobileInfoPanel(false));
      mobileInfoPanel?.addEventListener('click', (evt) => {
        if (evt.target === mobileInfoPanel) toggleMobileInfoPanel(false);
      });

      const stopSpeaking = () => {
        if (window.speechSynthesis && isSpeaking) {
          window.speechSynthesis.cancel();
          isSpeaking = false;
        }
      };

      const speakCard = () => {
        if (!window.speechSynthesis || !currentRound?.item) return;
        stopSpeaking();
        const utterFront = new SpeechSynthesisUtterance(cardFrontEl.textContent || '');
        const utterBack = new SpeechSynthesisUtterance(cardBackEl.textContent || '');
        utterFront.lang = 'vi-VN';
        utterBack.lang = 'vi-VN';
        utterBack.onend = () => { isSpeaking = false; };
        isSpeaking = true;
        window.speechSynthesis.speak(utterFront);
        window.speechSynthesis.speak(utterBack);
      };

      audioButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!isSpeaking) {
            speakCard();
          } else {
            stopSpeaking();
          }
        });
      });

      const toggleNotePanel = (isOpen) => {
        if (!notePanel) return;
        notePanel.classList.toggle('open', isOpen);
      };

      const loadNote = async (itemId) => {
        if (!itemId || !noteTextarea) return;
        noteTextarea.value = 'Đang tải ghi chú...';
        try {
          const response = await fetch(`{{ url_for('notes.get_note', item_id=0) }}`.replace('0', itemId), { credentials: 'same-origin' });
          const payload = await response.json();
          noteTextarea.value = payload?.content || '';
        } catch (err) {
          noteTextarea.value = 'Không thể tải ghi chú.';
        }
      };

      const saveNote = async (itemId) => {
        if (!itemId || !noteTextarea) return;
        try {
          const response = await fetch(`{{ url_for('notes.save_note', item_id=0) }}`.replace('0', itemId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({ content: noteTextarea.value || '' }),
          });
          const payload = await response.json();
          if (!response.ok || !payload?.success) {
            throw new Error(payload?.message || 'Không thể lưu ghi chú.');
          }
          feedbackEl.textContent = 'Đã lưu ghi chú của bạn.';
          toggleNotePanel(false);
        } catch (err) {
          feedbackEl.textContent = err.message || 'Có lỗi khi lưu ghi chú.';
        }
      };

      noteButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!currentCardId) {
            feedbackEl.textContent = 'Chưa có thẻ để tạo ghi chú.';
            return;
          }
          toggleNotePanel(true);
          loadNote(currentCardId);
        });
      });

      cancelNoteBtn?.addEventListener('click', () => toggleNotePanel(false));
      saveNoteBtn?.addEventListener('click', () => saveNote(currentCardId));

      aiButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!currentCardId) return;
          openAiModal(currentCardId, cardFrontEl.textContent || '');
        });
      });

      feedbackButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!currentCardId || !window.openFeedbackModal) return;
          openFeedbackModal(currentCardId, cardFrontEl.textContent || '');
        });
      });

      editButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!currentCardId || !editUrlTemplate) return;
          const url = editUrlTemplate.replace('/0', `/${currentCardId}`);
          if (window.parent && typeof window.parent.openModal === 'function') {
            window.parent.openModal(url);
          } else {
            window.open(url, '_blank');
          }
        });
      });

      fetchRound(true);
      startPolling();

      window.addEventListener('beforeunload', stopPolling);
    })();

    // Chat Logic
    document.addEventListener('DOMContentLoaded', () => {
      const messagesUrl = {{ url_for('shared.list_chat_messages', room_type='flashcard-collab', room_code=room_payload.room_code) | tojson }};
      const postMessageUrl = {{ url_for('shared.post_chat_message', room_type='flashcard-collab', room_code=room_payload.room_code) | tojson }};
      const chatMessages = document.getElementById('collab-chat-messages');
      const chatForm = document.getElementById('collab-chat-form');
      const chatInput = document.getElementById('collab-chat-input');
      const chatPanel = document.getElementById('collab-chat-panel');
      const openChatBtn = document.getElementById('open-chat-btn');
      const closeChatBtn = chatPanel?.querySelector('.close-chat-btn');
      const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfHeaders = csrfTokenMeta ? { 'X-CSRFToken': csrfTokenMeta.getAttribute('content') } : {};

      if (!openChatBtn) return;

      let pollHandle = null;

      const renderMessages = (messages = []) => {
        chatMessages.innerHTML = '';

        if (!messages.length) {
          chatMessages.innerHTML = '<p class="text-slate-500">Chưa có tin nhắn nào.</p>';
          return;
        }

        messages.forEach((message) => {
          const bubble = document.createElement('div');
          bubble.className = 'rounded-lg border border-slate-200 bg-white p-2 shadow-sm';

          const author = document.createElement('p');
          author.className = 'text-sm font-semibold text-slate-800';
          author.textContent = message.username || `Người dùng #${message.user_id}`;

          const content = document.createElement('p');
          content.className = 'text-sm text-slate-700';
          content.textContent = message.content;

          const meta = document.createElement('p');
          meta.className = 'text-xs text-slate-500';
          meta.textContent = message.created_at
            ? new Date(message.created_at).toLocaleTimeString('vi-VN')
            : '';

          bubble.appendChild(author);
          bubble.appendChild(content);
          bubble.appendChild(meta);
          chatMessages.appendChild(bubble);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      const loadMessages = async () => {
        try {
          const response = await fetch(messagesUrl, { credentials: 'same-origin' });
          if (!response.ok) {
            throw new Error('Không thể tải tin nhắn.');
          }
          const payload = await response.json();
          renderMessages(payload?.messages || []);
        } catch (err) {
          chatMessages.innerHTML = `<p class="text-sm text-rose-600">${err.message || 'Không thể tải tin nhắn.'}</p>`;
        }
      };

      const sendMessage = async (content) => {
        if (!content.trim()) return;

        chatInput.disabled = true;
        try {
          const response = await fetch(postMessageUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({ content }),
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload?.description || 'Không thể gửi tin nhắn.');
          }

          chatInput.value = '';
          await loadMessages();
        } catch (err) {
          chatMessages.insertAdjacentHTML(
            'beforeend',
            `<p class="text-sm text-rose-600">${err.message || 'Không thể gửi tin nhắn.'}</p>`
          );
        } finally {
          chatInput.disabled = false;
          chatInput.focus();
        }
      };

      chatForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        sendMessage(chatInput.value || '');
      });

      const setChatOpen = (isOpen) => {
        if (!chatPanel) return;
        
        if (isOpen) {
            chatPanel.classList.add('open');
            chatPanel.style.opacity = '1'; 
            chatPanel.style.visibility = 'visible';
            chatPanel.style.pointerEvents = 'auto';
        } else {
            chatPanel.classList.remove('open');
            chatPanel.style.opacity = ''; 
            chatPanel.style.visibility = '';
            chatPanel.style.pointerEvents = '';
        }
        
        openChatBtn.classList.toggle('is-active', isOpen);
        openChatBtn.setAttribute('aria-pressed', isOpen ? 'true' : 'false');

        if (isOpen && window.matchMedia('(max-width: 1024px)').matches) {
          setTimeout(() => chatInput?.focus({ preventScroll: true }), 100);
        }
      };

      openChatBtn.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        setChatOpen(!chatPanel?.classList.contains('open'));
      });
      
      closeChatBtn?.addEventListener('click', () => setChatOpen(false));
      chatPanel?.addEventListener('click', (event) => {
        if (event.target === chatPanel) {
          setChatOpen(false);
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          setChatOpen(false);
        }
      });

      const startPolling = () => {
        if (pollHandle) return;
        pollHandle = setInterval(loadMessages, 7000);
      };

      const stopPolling = () => {
        if (!pollHandle) return;
        clearInterval(pollHandle);
        pollHandle = null;
      };

      loadMessages();
      startPolling();
      window.addEventListener('beforeunload', stopPolling);
    });
  </script>
{% endblock %}