{% extends 'base.html' %}
{% block title %}Phòng học Flashcard chung - {{ room_payload.room_code }}{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    body.flashcard-session-active > main {
      padding: 0 !important;
      margin: 0;
      max-width: none;
    }

    .page-shell {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: calc(100vh - 64px);
      padding: 1.5rem 1.25rem 2rem;
      background: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08), transparent 25%),
        radial-gradient(circle at 90% 30%, rgba(59, 130, 246, 0.06), transparent 25%),
        #f8fafc;
    }

    .hero-card {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
      padding: 1.25rem 1.5rem;
    }

    .session-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.4fr) minmax(360px, 1fr);
      gap: 1.25rem;
      width: 100%;
      margin: 0 auto;
      max-width: 1440px;
      align-items: start;
    }

    @media (max-width: 1024px) {
      .session-layout {
        display: flex;
        flex-direction: column;
      }
    }

    .card-surface {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.1);
      overflow: hidden;
    }

    .flashcard-panel {
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 1rem;
      height: 100%;
      padding: 1.25rem;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(248, 250, 252, 0.96));
      position: relative;
    }

    .flashcard-card-container {
      perspective: 1200px;
      width: 100%;
      height: 100%;
      min-height: 300px;
    }

    .card-actions-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }

    .pill-button {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.65rem 1rem;
      border-radius: 999px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      color: #0f172a;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .pill-button:hover {
      background: #e2e8f0;
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
    }

    .flashcard-card {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 18px;
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
      overflow: hidden;
      transform-style: preserve-3d;
      transition: transform .6s ease, box-shadow .2s ease;
    }

    .flashcard-card:hover {
      box-shadow: 0 20px 44px rgba(15, 23, 42, 0.14);
    }

    .card-toolbar {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 0.5rem;
      padding: 0.65rem 1rem;
      position: absolute;
      inset: 0 0 auto 0;
      background: rgba(255, 255, 255, 0.94);
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      backdrop-filter: blur(6px);
      z-index: 5;
    }

    .card-toolbar .label {
      font-size: 0.9rem;
      font-weight: 700;
      color: #64748b;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .card-toolbar .pill {
      background: #eef2ff;
      color: #4338ca;
      padding: 0.45rem 0.85rem;
    }

    .face {
      position: absolute;
      inset: 0;
      padding: 64px 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 1rem;
      backface-visibility: hidden;
      transition: transform .6s ease, opacity .3s ease;
    }

    .face .flashcard-text {
      font-size: 2rem;
      font-weight: 700;
      color: #0f172a;
      text-align: center;
      line-height: 1.4;
    }

    .face.back .flashcard-text {
      font-size: 1.1rem;
      font-weight: 500;
      color: #1f2937;
      text-align: left;
      white-space: pre-wrap;
    }

    .face.back {
      transform: rotateY(180deg);
    }

    .flashcard-card.flipped .front {
      transform: rotateY(180deg);
      opacity: 0;
      pointer-events: none;
    }

    .flashcard-card.flipped .back {
      transform: rotateY(360deg);
      opacity: 1;
      pointer-events: auto;
    }

    .flashcard-card:not(.flipped) .back {
      opacity: 0;
      pointer-events: none;
    }

    .flip-card-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.85rem 1.6rem;
      border-radius: 0.85rem;
      font-weight: 700;
      border: none;
      background: linear-gradient(135deg, #6366f1, #2563eb);
      color: white;
      box-shadow: 0 12px 28px rgba(99, 102, 241, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .flip-card-btn:hover {
      transform: translateY(-1px);
      background: linear-gradient(135deg, #4f46e5, #1d4ed8);
      box-shadow: 0 16px 32px rgba(79, 70, 229, 0.28);
    }

    .flip-card-btn:focus-visible {
      outline: 3px solid rgba(79, 70, 229, 0.35);
      outline-offset: 3px;
    }

    .answer-grid {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.75rem;
    }

    .answer-grid.visible {
      display: grid;
    }

    .answer-button {
      border-radius: 12px;
      padding: 0.9rem 1rem;
      font-weight: 700;
      border: 1px solid transparent;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      width: 100%;
    }

    .answer-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    .answer-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      border-radius: 999px;
      padding: 0.4rem 0.85rem;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .sidebar-card {
      padding: 1.1rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .combined-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .chat-box {
      height: 420px;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      padding: 0.75rem;
    }

    .chat-panel {
      position: relative;
    }

    .mobile-chat-toggle {
      display: none;
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 30;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.2);
    }

    .chat-panel .close-chat-btn {
      display: none;
    }

    @media (max-width: 1024px) {
      .chat-panel {
        display: none;
      }

      .chat-panel.open {
        display: flex;
        position: fixed;
        inset: 0;
        z-index: 40;
        background: rgba(15, 23, 42, 0.45);
        padding: 1rem;
        align-items: center;
        justify-content: center;
      }

      .chat-panel.open .chat-box {
        max-width: 720px;
        width: 100%;
        max-height: 90vh;
        background: #ffffff;
      }

      .chat-panel.open .close-chat-btn {
        display: inline-flex;
      }

      .mobile-chat-toggle {
        display: inline-flex;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="hero-card">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div>
        <p class="text-xs uppercase tracking-[0.25em] text-slate-500">Phòng học Flashcard</p>
        <h1 class="text-3xl font-extrabold text-slate-900">{{ room_payload.title or 'Phòng học chung' }}</h1>
        <div class="flex items-center flex-wrap gap-2 mt-2 text-sm text-slate-600">
          <span class="pill bg-slate-100 text-slate-700"><i class="fas fa-layer-group"></i> {{ room_payload.container_title or ('Bộ #' ~ room_payload.container_id) }}</span>
          <span class="pill bg-indigo-50 text-indigo-700"><i class="fas fa-bolt"></i> Chế độ: {{ room_payload.mode }}</span>
          <span class="pill bg-emerald-50 text-emerald-700"><i class="fas fa-user"></i> Chủ phòng: {{ room_payload.host_username or '—' }}</span>
          <span class="pill bg-slate-200 text-slate-800 font-mono">Mã: {{ room_payload.room_code }}</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" id="copy-room-code" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
          <i class="fas fa-copy"></i> Sao chép mã
        </button>
        <a href="{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
          <i class="fas fa-arrow-left"></i> Quay lại danh sách phòng
        </a>
      </div>
    </div>
  </div>

  <div class="session-layout">
    <div class="card-surface flashcard-panel" id="collab-learning-card">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-sm text-slate-500">Thẻ tiếp theo sẽ xuất hiện khi tất cả thành viên đã trả lời.</p>
          <div class="flex items-center gap-2 mt-2 text-sm" id="collab-round-status">
            <span class="pill bg-amber-50 text-amber-700"><i class="fas fa-circle-notch animate-spin"></i> Đang tải thẻ đầu tiên...</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-right">
            <p class="text-xs text-slate-500">Điểm của bạn</p>
            <p class="text-2xl font-extrabold text-indigo-600" id="collab-user-score">{{ current_user.total_score or 0 }}</p>
          </div>
          <button type="button" id="collab-refresh-round" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
            <i class="fas fa-rotate"></i> Làm mới thẻ
          </button>
        </div>
      </div>

      <div class="flashcard-card-container">
        <div class="flashcard-card" id="collab-card">
          <div class="card-toolbar">
            <span class="label">Flashcard</span>
            <div class="text-sm text-center text-slate-600">
              <i class="fas fa-eye"></i> Lật thẻ để xem đáp án
            </div>
            <span class="pill text-xs"><i class="fas fa-rotate"></i> Ấn để lật</span>
          </div>
          <div class="face front">
            <p class="label text-sm text-slate-500">Mặt trước</p>
            <p id="collab-card-front" class="flashcard-text">—</p>
          </div>
          <div class="face back">
            <p class="label text-sm text-slate-500">Mặt sau</p>
            <p id="collab-card-back" class="flashcard-text">—</p>
          </div>
        </div>
      </div>

      <div class="flex justify-center pt-2">
        <button type="button" id="collab-flip-btn" class="flip-card-btn">
          <i class="fas fa-sync-alt"></i> Lật thẻ
        </button>
      </div>

      <div class="card-actions-bar">
        <button type="button" id="collab-note-btn" class="pill-button"><i class="fas fa-sticky-note"></i> Ghi chú</button>
        <button type="button" id="collab-ai-btn" class="pill-button"><i class="fas fa-robot"></i> Mindstack AI</button>
        <button type="button" id="collab-audio-btn" class="pill-button"><i class="fas fa-headphones"></i> Nghe nội dung</button>
      </div>

      <div class="space-y-2">
        <p class="text-sm font-semibold text-slate-800">Câu trả lời của bạn</p>
        <div class="answer-grid" id="collab-answer-actions">
          <button type="button" data-answer="quên" class="collab-answer-btn answer-button bg-rose-50 text-rose-700">
            <i class="fas fa-times-circle"></i> Quên
          </button>
          <button type="button" data-answer="mơ_hồ" class="collab-answer-btn answer-button bg-amber-50 text-amber-700">
            <i class="fas fa-minus-circle"></i> Mơ hồ
          </button>
          <button type="button" data-answer="nhớ" class="collab-answer-btn answer-button bg-emerald-50 text-emerald-700">
            <i class="fas fa-check-circle"></i> Nhớ
          </button>
        </div>
        <p id="collab-answer-feedback" class="text-xs text-slate-600"></p>
      </div>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="bg-slate-50 rounded-xl border border-slate-200 p-3 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-semibold text-slate-800">Trạng thái lượt & thành viên</p>
              <p class="text-xs text-slate-500">Theo dõi tiến trình và tình trạng tham gia</p>
            </div>
            <span id="collab-round-step" class="text-xs font-mono text-slate-500"></span>
          </div>
          <div class="combined-status">
            <div class="space-y-2">
              <p class="text-sm font-semibold text-slate-800">Diễn biến lượt</p>
              <div id="collab-round-status" class="flex flex-col gap-2 text-sm text-slate-700"></div>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm font-semibold text-slate-800">
                <span>Danh sách tham gia</span>
                <span class="pill bg-slate-100 text-slate-700 text-xs" id="collab-participant-count">{{ room_payload.participants | length }}</span>
              </div>
              <ul id="collab-round-participants" class="divide-y divide-slate-200 text-sm text-slate-700"></ul>
            </div>
          </div>
        </div>
        <div class="bg-slate-50 rounded-xl border border-slate-200 p-3">
          <p class="text-sm font-semibold text-slate-800 mb-2">Hướng dẫn nhanh</p>
          <ul class="list-disc list-inside text-sm text-slate-600 space-y-1">
            <li>Chọn mức độ ghi nhớ giống như khi học cá nhân.</li>
            <li>Phòng tự động chuyển thẻ khi mọi người đã trả lời.</li>
            <li>Sử dụng trò chuyện bên phải để phối hợp cùng nhóm.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="session-sidebar space-y-3">
      <div class="card-surface sidebar-card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Thông tin phòng</p>
            <p class="text-lg font-semibold text-slate-900">{{ room_payload.container_title or ('Bộ #' ~ room_payload.container_id) }}</p>
          </div>
          <span class="pill bg-indigo-50 text-indigo-700"><i class="fas fa-bolt"></i> {{ room_payload.mode }}</span>
        </div>
        <div class="grid grid-cols-2 gap-3 text-sm text-slate-700">
          <div class="bg-slate-50 rounded-lg p-3">
            <p class="text-xs text-slate-500">Chủ phòng</p>
            <p class="font-semibold">{{ room_payload.host_username or '—' }}</p>
          </div>
          <div class="bg-slate-50 rounded-lg p-3">
            <p class="text-xs text-slate-500">Trạng thái</p>
            <p class="font-semibold capitalize">{{ room_payload.status }}</p>
          </div>
          <div class="bg-slate-50 rounded-lg p-3">
            <p class="text-xs text-slate-500">Mã phòng</p>
            <p class="font-mono tracking-widest text-sm">{{ room_payload.room_code }}</p>
          </div>
          <div class="bg-slate-50 rounded-lg p-3">
            <p class="text-xs text-slate-500">Tổng thành viên</p>
            <p class="font-semibold" id="collab-participant-count-static">{{ room_payload.participants | length }}</p>
          </div>
        </div>
      </div>

      <div id="collab-chat-panel" class="chat-panel">
        <div class="card-surface sidebar-card chat-box">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Trò chuyện</p>
              <p class="text-lg font-semibold text-slate-900">Trao đổi trong phòng</p>
            </div>
            <button type="button" class="close-chat-btn inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-sm font-semibold text-slate-700 hover:bg-slate-200">
              <i class="fas fa-times"></i> Đóng
            </button>
          </div>
          <div id="collab-chat-messages" class="chat-messages space-y-2 text-sm text-slate-800">
            <p class="text-slate-500">Đang tải tin nhắn...</p>
          </div>
          <form id="collab-chat-form" class="flex gap-2">
            <input id="collab-chat-input" type="text" class="flex-1 rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-indigo-200" placeholder="Nhập tin nhắn..." autocomplete="off">
            <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
              <i class="fas fa-paper-plane"></i> Gửi
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <button type="button" id="open-chat-btn" class="mobile-chat-toggle pill-button"><i class="fas fa-comments"></i> Mở chat</button>

  {% include 'notes/_note_panel.html' %}
  {% include 'ai_services/_ai_modal.html' %}
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('flashcard-session-active');
    });
    window.addEventListener('beforeunload', () => {
      document.body.classList.remove('flashcard-session-active');
    });

    document.getElementById('copy-room-code')?.addEventListener('click', () => {
      const code = {{ room_payload.room_code | tojson }};
      navigator.clipboard.writeText(code).catch(() => {});
    });

    (() => {
      const nextCardUrl = {{ url_for('learning.flashcard_collab.get_next_card', room_code=room_payload.room_code) | tojson }};
      const submitAnswerUrl = {{ url_for('learning.flashcard_collab.submit_collab_answer', room_code=room_payload.room_code) | tojson }};
      const currentUserId = {{ current_user.user_id }};
      const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfHeaders = csrfTokenMeta ? { 'X-CSRFToken': csrfTokenMeta.getAttribute('content') } : {};

      const cardFrontEl = document.getElementById('collab-card-front');
      const cardBackEl = document.getElementById('collab-card-back');
      const cardEl = document.getElementById('collab-card');
      const statusEl = document.getElementById('collab-round-status');
      const participantsEl = document.getElementById('collab-round-participants');
      const answerButtons = document.querySelectorAll('.collab-answer-btn');
      const answerActionsEl = document.getElementById('collab-answer-actions');
      const feedbackEl = document.getElementById('collab-answer-feedback');
      const refreshBtn = document.getElementById('collab-refresh-round');
      const flipBtn = document.getElementById('collab-flip-btn');
      const roundStepEl = document.getElementById('collab-round-step');
      const userScoreEl = document.getElementById('collab-user-score');
      const participantCountEls = [
        document.getElementById('collab-participant-count'),
        document.getElementById('collab-participant-count-static'),
      ].filter(Boolean);
      const noteBtn = document.getElementById('collab-note-btn');
      const aiBtn = document.getElementById('collab-ai-btn');
      const audioBtn = document.getElementById('collab-audio-btn');
      const notePanel = document.getElementById('note-panel');
      const noteTextarea = document.getElementById('note-textarea');
      const saveNoteBtn = document.getElementById('save-note-btn');
      const cancelNoteBtn = document.getElementById('cancel-note-btn');

      let currentRound = null;
      let currentCardId = null;
      let isFetching = false;
      let pollHandle = null;
      let hasAnsweredCurrentCard = false;
      let isSpeaking = false;

      const syncAnswerButtonsAvailability = () => {
        const shouldDisable = hasAnsweredCurrentCard || !cardEl?.classList.contains('flipped');
        answerButtons.forEach((btn) => {
          btn.disabled = shouldDisable;
          btn.classList.toggle('opacity-60', shouldDisable);
        });
      };

      const showFrontSide = () => {
        if (!cardEl) return;
        cardEl.classList.remove('flipped');
        answerActionsEl?.classList.remove('visible');
        flipBtn?.classList.remove('hidden');
        feedbackEl.textContent = '';
        hasAnsweredCurrentCard = false;
        syncAnswerButtonsAvailability();
      };

      const showBackSide = () => {
        if (!cardEl) return;
        cardEl.classList.add('flipped');
        answerActionsEl?.classList.add('visible');
        flipBtn?.classList.add('hidden');
        syncAnswerButtonsAvailability();
      };

      const setLoadingState = (message) => {
        statusEl.innerHTML = message || 'Đang tải...';
      };

      const renderParticipants = (participants = []) => {
        if (!participants.length) {
          participantsEl.innerHTML = '<li class="py-2 text-slate-500">Chưa có thành viên đang hoạt động.</li>';
          participantCountEls.forEach((el) => {
            el.textContent = '0';
          });
          return;
        }

        participantsEl.innerHTML = participants.map((participant) => {
          const statusLabel = participant.has_answered ? 'Đã trả lời' : 'Chưa trả lời';
          const statusClass = participant.has_answered ? 'text-green-600' : 'text-slate-500';
          return `
            <li class="py-2 flex items-center justify-between">
              <div>
                <p class="font-semibold">${participant.username || 'Người dùng #' + participant.user_id}</p>
                <p class="text-xs text-slate-500">ID: ${participant.user_id}</p>
              </div>
              <span class="text-xs font-semibold ${statusClass}">${statusLabel}</span>
            </li>
          `;
        }).join('');

        participantCountEls.forEach((el) => {
          el.textContent = participants.length;
        });
      };

      const renderRound = (roundPayload) => {
        currentRound = roundPayload;
        const { item, participants = [], all_answered: allAnswered, status } = roundPayload;

        const itemId = item?.item_id || null;
        if (itemId !== currentCardId) {
          currentCardId = itemId;
          showFrontSide();
        }

        cardFrontEl.textContent = (item?.content?.front || 'Không có nội dung mặt trước').trim();
        cardBackEl.textContent = (item?.content?.back || 'Không có nội dung mặt sau').trim();
        renderParticipants(participants);

        const currentUserParticipation = participants.find((p) => Number(p.user_id) === Number(currentUserId));
        hasAnsweredCurrentCard = !!currentUserParticipation?.has_answered;
        feedbackEl.textContent = hasAnsweredCurrentCard ? 'Bạn đã trả lời, vui lòng chờ mọi người hoàn tất.' : 'Nhấn “Lật thẻ” để xem đáp án.';
        if (hasAnsweredCurrentCard) {
          showBackSide();
        } else {
          syncAnswerButtonsAvailability();
        }

        if (status === 'completed' && allAnswered) {
          statusEl.innerHTML = '<span class="pill bg-emerald-50 text-emerald-700"><i class="fas fa-check-circle"></i> Tất cả thành viên đã trả lời. Đang chuẩn bị thẻ tiếp theo...</span>';
        } else if (!allAnswered) {
          statusEl.innerHTML = '<span class="pill bg-amber-50 text-amber-700"><i class="fas fa-hourglass-half"></i> Đang chờ tất cả thành viên trả lời...</span>';
        } else {
          statusEl.innerHTML = '<span class="pill bg-indigo-50 text-indigo-700"><i class="fas fa-circle"></i> Đang hiển thị thẻ mới.</span>';
        }

        roundStepEl.textContent = `Thẻ #${item?.item_id || '—'}`;
      };

      const fetchRound = async (showLoader = false) => {
        if (isFetching) return;
        isFetching = true;
        if (showLoader) setLoadingState('Đang tải thẻ...');
        try {
          const response = await fetch(nextCardUrl, { credentials: 'same-origin' });
          if (!response.ok) {
            throw new Error('Không thể tải thẻ.');
          }
          const payload = await response.json();
          if (payload) {
            renderRound(payload);
          }
        } catch (err) {
          statusEl.innerHTML = `<span class="text-rose-600">${err.message || 'Không thể tải thẻ.'}</span>`;
        } finally {
          isFetching = false;
        }
      };

      const submitAnswer = async (answerLabel) => {
        if (!currentRound?.item?.item_id || isFetching) return;
        isFetching = true;
        feedbackEl.textContent = 'Đang gửi câu trả lời...';

        if (cardEl && !cardEl.classList.contains('flipped')) {
          showBackSide();
        }

        try {
          const response = await fetch(submitAnswerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({
              item_id: currentRound.item.item_id,
              answer: answerLabel,
            }),
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload?.description || 'Không thể gửi câu trả lời.');
          }

          const payload = await response.json();
          if (payload?.round) {
            renderRound(payload.round);
          }

          const result = payload?.result;
          if (result && typeof result.updated_total_score === 'number' && userScoreEl) {
            userScoreEl.textContent = result.updated_total_score;
          }
          if (result?.answer_result === 'correct') {
            feedbackEl.textContent = 'Bạn đã trả lời đúng. Chờ các thành viên khác để chuyển thẻ.';
          } else if (result?.answer_result === 'incorrect') {
            feedbackEl.textContent = 'Bạn đã trả lời sai. Chờ các thành viên khác để chuyển thẻ.';
          } else {
            feedbackEl.textContent = 'Đã ghi nhận câu trả lời của bạn.';
          }
          hasAnsweredCurrentCard = true;
          syncAnswerButtonsAvailability();
        } catch (err) {
          feedbackEl.textContent = err.message || 'Có lỗi xảy ra.';
          fetchRound(true);
        } finally {
          isFetching = false;
        }
      };

      const startPolling = () => {
        if (pollHandle) return;
        pollHandle = setInterval(() => fetchRound(false), 4000);
      };

      const stopPolling = () => {
        if (!pollHandle) return;
        clearInterval(pollHandle);
        pollHandle = null;
      };

      answerButtons.forEach((btn) => {
        btn.addEventListener('click', () => submitAnswer(btn.dataset.answer));
      });

      flipBtn?.addEventListener('click', showBackSide);

      refreshBtn?.addEventListener('click', () => fetchRound(true));

      const stopSpeaking = () => {
        if (window.speechSynthesis && isSpeaking) {
          window.speechSynthesis.cancel();
          isSpeaking = false;
        }
      };

      const speakCard = () => {
        if (!window.speechSynthesis || !currentRound?.item) return;
        stopSpeaking();
        const utterFront = new SpeechSynthesisUtterance(cardFrontEl.textContent || '');
        const utterBack = new SpeechSynthesisUtterance(cardBackEl.textContent || '');
        utterFront.lang = 'vi-VN';
        utterBack.lang = 'vi-VN';
        utterBack.onend = () => { isSpeaking = false; };
        isSpeaking = true;
        window.speechSynthesis.speak(utterFront);
        window.speechSynthesis.speak(utterBack);
      };

      audioBtn?.addEventListener('click', () => {
        if (!isSpeaking) {
          speakCard();
        } else {
          stopSpeaking();
        }
      });

      const toggleNotePanel = (isOpen) => {
        if (!notePanel) return;
        notePanel.classList.toggle('open', isOpen);
      };

      const loadNote = async (itemId) => {
        if (!itemId || !noteTextarea) return;
        noteTextarea.value = 'Đang tải ghi chú...';
        try {
          const response = await fetch(`{{ url_for('notes.get_note', item_id=0) }}`.replace('0', itemId), { credentials: 'same-origin' });
          const payload = await response.json();
          noteTextarea.value = payload?.content || '';
        } catch (err) {
          noteTextarea.value = 'Không thể tải ghi chú.';
        }
      };

      const saveNote = async (itemId) => {
        if (!itemId || !noteTextarea) return;
        try {
          const response = await fetch(`{{ url_for('notes.save_note', item_id=0) }}`.replace('0', itemId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({ content: noteTextarea.value || '' }),
          });
          const payload = await response.json();
          if (!response.ok || !payload?.success) {
            throw new Error(payload?.message || 'Không thể lưu ghi chú.');
          }
          feedbackEl.textContent = 'Đã lưu ghi chú của bạn.';
          toggleNotePanel(false);
        } catch (err) {
          feedbackEl.textContent = err.message || 'Có lỗi khi lưu ghi chú.';
        }
      };

      noteBtn?.addEventListener('click', () => {
        if (!currentCardId) {
          feedbackEl.textContent = 'Chưa có thẻ để tạo ghi chú.';
          return;
        }
        toggleNotePanel(true);
        loadNote(currentCardId);
      });

      cancelNoteBtn?.addEventListener('click', () => toggleNotePanel(false));
      saveNoteBtn?.addEventListener('click', () => saveNote(currentCardId));

      aiBtn?.addEventListener('click', () => {
        if (!currentCardId) return;
        openAiModal(currentCardId, cardFrontEl.textContent || '');
      });

      fetchRound(true);
      startPolling();

      window.addEventListener('beforeunload', stopPolling);
    })();

    (() => {
      const messagesUrl = {{ url_for('shared.list_chat_messages', room_type='flashcard-collab', room_code=room_payload.room_code) | tojson }};
      const postMessageUrl = {{ url_for('shared.post_chat_message', room_type='flashcard-collab', room_code=room_payload.room_code) | tojson }};
      const chatMessages = document.getElementById('collab-chat-messages');
      const chatForm = document.getElementById('collab-chat-form');
      const chatInput = document.getElementById('collab-chat-input');
      const chatPanel = document.getElementById('collab-chat-panel');
      const openChatBtn = document.getElementById('open-chat-btn');
      const closeChatBtn = chatPanel?.querySelector('.close-chat-btn');
      const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfHeaders = csrfTokenMeta ? { 'X-CSRFToken': csrfTokenMeta.getAttribute('content') } : {};

      let pollHandle = null;

      const renderMessages = (messages = []) => {
        chatMessages.innerHTML = '';

        if (!messages.length) {
          chatMessages.innerHTML = '<p class="text-slate-500">Chưa có tin nhắn nào.</p>';
          return;
        }

        messages.forEach((message) => {
          const bubble = document.createElement('div');
          bubble.className = 'rounded-lg border border-slate-200 bg-white p-2 shadow-sm';

          const author = document.createElement('p');
          author.className = 'text-sm font-semibold text-slate-800';
          author.textContent = message.username || `Người dùng #${message.user_id}`;

          const content = document.createElement('p');
          content.className = 'text-sm text-slate-700';
          content.textContent = message.content;

          const meta = document.createElement('p');
          meta.className = 'text-xs text-slate-500';
          meta.textContent = message.created_at
            ? new Date(message.created_at).toLocaleTimeString('vi-VN')
            : '';

          bubble.appendChild(author);
          bubble.appendChild(content);
          bubble.appendChild(meta);
          chatMessages.appendChild(bubble);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      const loadMessages = async () => {
        try {
          const response = await fetch(messagesUrl, { credentials: 'same-origin' });
          if (!response.ok) {
            throw new Error('Không thể tải tin nhắn.');
          }
          const payload = await response.json();
          renderMessages(payload?.messages || []);
        } catch (err) {
          chatMessages.innerHTML = `<p class="text-sm text-rose-600">${err.message || 'Không thể tải tin nhắn.'}</p>`;
        }
      };

      const sendMessage = async (content) => {
        if (!content.trim()) return;

        chatInput.disabled = true;
        try {
          const response = await fetch(postMessageUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({ content }),
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload?.description || 'Không thể gửi tin nhắn.');
          }

          chatInput.value = '';
          await loadMessages();
        } catch (err) {
          chatMessages.insertAdjacentHTML(
            'beforeend',
            `<p class="text-sm text-rose-600">${err.message || 'Không thể gửi tin nhắn.'}</p>`
          );
        } finally {
          chatInput.disabled = false;
          chatInput.focus();
        }
      };

      chatForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        sendMessage(chatInput.value || '');
      });

      const setChatOpen = (isOpen) => {
        if (!chatPanel) return;
        chatPanel.classList.toggle('open', isOpen);
      };

      openChatBtn?.addEventListener('click', () => setChatOpen(true));
      closeChatBtn?.addEventListener('click', () => setChatOpen(false));
      chatPanel?.addEventListener('click', (event) => {
        if (event.target === chatPanel) {
          setChatOpen(false);
        }
      });

      const startPolling = () => {
        if (pollHandle) return;
        pollHandle = setInterval(loadMessages, 7000);
      };

      const stopPolling = () => {
        if (!pollHandle) return;
        clearInterval(pollHandle);
        pollHandle = null;
      };

      loadMessages();
      startPolling();
      window.addEventListener('beforeunload', stopPolling);
    })();
  </script>
{% endblock %}
