{% extends "base.html" %}

{% block title %}Quiz Battle{% endblock %}

{% block content %}
<div class="py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-10">
        <header class="bg-white rounded-3xl shadow-sm border border-slate-100 p-8 flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
            <div>
                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-indigo-500">Quiz Battle</p>
                <h1 class="mt-3 text-3xl sm:text-4xl font-bold text-slate-900">Thách đấu quiz theo thời gian thực</h1>
                <p class="mt-4 text-slate-600 max-w-2xl">
                    Rủ bạn bè vào phòng Quiz Battle để so tài kiến thức. Bạn có thể chọn chế độ Test chậm để chờ mọi người hoàn thành
                    hoặc bật chế độ Giới hạn thời gian để tự động chuyển câu hỏi khi hết giờ.
                </p>
            </div>
            <div class="flex gap-3 flex-wrap">
                <a href="{{ url_for('learning.quiz_learning.quiz_learning_dashboard') }}" class="inline-flex items-center gap-2 px-5 py-3 rounded-2xl bg-indigo-600 text-white font-semibold shadow-md hover:bg-indigo-500">
                    <i class="fa-solid fa-layer-group"></i> Chọn bộ quiz
                </a>
                <a href="{{ url_for('stats.dashboard') }}" class="inline-flex items-center gap-2 px-5 py-3 rounded-2xl bg-white border border-slate-200 text-slate-800 font-semibold hover:bg-slate-50">
                    <i class="fa-solid fa-chart-line"></i> Xem thành tích
                </a>
            </div>
        </header>

        <section class="grid gap-6 md:grid-cols-2">
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <h2 class="text-xl font-semibold text-slate-900">Hai chế độ thi đấu</h2>
                <div class="space-y-4">
                    <article class="p-4 rounded-2xl border border-emerald-100 bg-emerald-50">
                        <div class="flex items-center gap-3">
                            <span class="w-10 h-10 rounded-2xl bg-white flex items-center justify-center text-emerald-600"><i class="fa-solid fa-users"></i></span>
                            <div>
                                <h3 class="font-semibold text-emerald-700">Test chậm</h3>
                                <p class="text-sm text-emerald-600">Mỗi câu hỏi chỉ chuyển khi tất cả thành viên đã trả lời xong, phù hợp để thảo luận kỹ.</p>
                            </div>
                        </div>
                    </article>
                    <article class="p-4 rounded-2xl border border-amber-100 bg-amber-50">
                        <div class="flex items-center gap-3">
                            <span class="w-10 h-10 rounded-2xl bg-white flex items-center justify-center text-amber-600"><i class="fa-solid fa-stopwatch"></i></span>
                            <div>
                                <h3 class="font-semibold text-amber-700">Giới hạn thời gian</h3>
                                <p class="text-sm text-amber-600">Đặt số lượng câu hỏi và thời gian trả lời mỗi câu. Khi hết giờ hệ thống tự động chuyển câu.</p>
                            </div>
                        </div>
                    </article>
                </div>
                <p class="text-sm text-slate-500">Bạn có thể cấu hình chế độ ngay khi tạo phòng để phù hợp với tốc độ của cả nhóm.</p>
            </div>

            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-6">
                <div>
                    <h2 class="text-xl font-semibold text-slate-900">Tạo phòng mới</h2>
                    <p class="text-sm text-slate-500">Chọn bộ quiz và cấu hình chế độ thi đấu bên dưới, sau đó chia sẻ mã phòng cho bạn bè.</p>
                </div>
                <form id="battle-settings-form" class="space-y-4">
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-slate-700">Chọn bộ quiz</label>
                        <div class="space-y-3">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="flex-1">
                                    <input type="text" id="quiz-search-input" class="w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập tên bộ quiz, thẻ hoặc từ khóa">
                                </div>
                                <button type="button" id="refresh-quiz-list" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-2xl border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50">
                                    <i class="fa-solid fa-rotate"></i> Tải danh sách
                                </button>
                            </div>
                            <p id="quiz-search-status" class="text-xs text-slate-500">Đang tải danh sách bộ quiz khả dụng...</p>
                            <div id="quiz-selection-grid" class="grid gap-3 sm:grid-cols-2"></div>
                            <p class="text-xs text-slate-500">Bấm vào một bộ quiz để sử dụng ngay. Hệ thống tự lọc các bộ bạn có quyền truy cập.</p>
                            <div class="flex flex-wrap items-center gap-3 text-sm">
                                <span class="font-semibold text-slate-700">Đã chọn:</span>
                                <span id="selected-quiz-label" class="text-slate-500 italic">Chưa chọn bộ nào</span>
                                <button type="button" id="clear-quiz-selection" class="text-xs font-semibold text-rose-600 hidden">Bỏ chọn</button>
                            </div>
                        </div>
                        <input type="hidden" name="container_id" id="selected-container-id">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Tiêu đề phòng</label>
                        <input type="text" name="title" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Quiz Battle tối nay" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Số lượng câu hỏi</label>
                        <input type="number" min="1" name="question_limit" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Để trống nếu muốn dùng toàn bộ bộ quiz">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Hiển thị phòng</label>
                        <div class="mt-2 flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-6 text-sm text-slate-600">
                            <label class="inline-flex items-center gap-2">
                                <input type="radio" name="visibility" value="public" class="text-indigo-600" checked>
                                <span>Công khai · hiện ở dashboard</span>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="radio" name="visibility" value="private" class="text-indigo-600">
                                <span>Riêng tư · chỉ vào được bằng mã</span>
                            </label>
                        </div>
                        <p class="mt-2 text-xs text-slate-500">Bạn vẫn có thể gửi mã phòng cho người khác kể cả khi đặt chế độ công khai.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Chế độ thi</label>
                        <select name="mode" id="battle-mode" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="SLOW">Test chậm</option>
                            <option value="TIMED">Giới hạn thời gian</option>
                        </select>
                    </div>
                    <div id="timed-config" class="hidden">
                        <label class="block text-sm font-medium text-slate-700">Thời gian cho mỗi câu (giây)</label>
                        <input type="number" min="5" name="time_per_question_seconds" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Ví dụ: 30">
                        <p class="mt-2 text-xs text-slate-500">Ở chế độ giới hạn thời gian, câu hỏi sẽ tự chuyển sau khi hết số giây này.</p>
                    </div>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-500">
                        <i class="fa-solid fa-plus"></i> Tạo phòng ngay
                    </button>
                </form>
                <div id="room-creation-result" class="text-sm"></div>
            </div>
        </section>

        <section class="grid gap-6 lg:grid-cols-3">
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <div class="flex items-center justify-between gap-3">
                    <div>
                        <h2 class="text-xl font-semibold text-slate-900">Phòng công khai</h2>
                        <p class="text-sm text-slate-500">Nhìn thấy ngay những phòng đang mở để tham gia nhanh.</p>
                    </div>
                    <button type="button" id="refresh-public-rooms" class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl border border-slate-200 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                        <i class="fa-solid fa-rotate"></i> Tải lại
                    </button>
                </div>
                <div id="public-rooms-list" class="space-y-3 text-sm text-slate-600">
                    <p class="text-slate-500">Đang tải danh sách phòng...</p>
                </div>
            </div>
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <div class="flex items-center justify-between gap-3">
                    <div>
                        <h2 class="text-xl font-semibold text-slate-900">Phòng của bạn</h2>
                        <p class="text-sm text-slate-500">Các phòng bạn đang tham gia hoặc chủ trì.</p>
                    </div>
                    <button type="button" id="refresh-my-rooms" class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl border border-slate-200 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                        <i class="fa-solid fa-rotate"></i> Tải lại
                    </button>
                </div>
                <div id="my-rooms-list" class="space-y-3 text-sm text-slate-600">
                    <p class="text-slate-500">Đang kiểm tra phòng bạn đã tham gia...</p>
                </div>
            </div>
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <h2 class="text-xl font-semibold text-slate-900">Tham gia bằng mã</h2>
                <p class="text-sm text-slate-500">Nhập mã phòng mà bạn bè gửi cho bạn để vào ngay cả phòng riêng tư.</p>
                <form id="join-room-form" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Mã phòng</label>
                        <input type="text" id="join-room-code" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 uppercase tracking-widest focus:border-indigo-500 focus:ring-indigo-500" placeholder="Ví dụ: ABC123" maxlength="12" required>
                    </div>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl bg-slate-900 text-white font-semibold shadow hover:bg-slate-800">
                        <i class="fa-solid fa-right-to-bracket"></i> Vào phòng
                    </button>
                </form>
                <p id="join-room-feedback" class="text-sm"></p>
            </div>
        </section>

        <section class="grid gap-6 md:grid-cols-2">
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <h2 class="text-xl font-semibold text-slate-900">Hướng dẫn nhanh</h2>
                <ol class="list-decimal pl-5 space-y-2 text-sm text-slate-600">
                    <li>Chọn bộ quiz ở bảng bên phải, đặt tiêu đề phòng rồi bấm <strong>Tạo phòng ngay</strong>.</li>
                    <li>Sao chép mã phòng được tạo và gửi cho mọi người để họ tham gia từ dashboard này.</li>
                    <li>Sau khi vào phòng, hệ thống sẽ hiển thị chat nội bộ cùng danh sách người chơi để bạn điều khiển.</li>
                    <li>Chủ phòng có thể chuyển chế độ, khóa phòng hoặc kết thúc trận bất kỳ lúc nào.</li>
                </ol>
                <p class="text-xs text-slate-500">Chat chỉ xuất hiện bên trong phòng để đảm bảo riêng tư giữa các thành viên tham gia.</p>
            </div>
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <h2 class="text-xl font-semibold text-slate-900">Mẹo sử dụng</h2>
                <ul class="list-disc pl-5 text-sm text-slate-600 space-y-2">
                    <li>Chia sẻ mã phòng sau khi tạo để mọi người tham gia qua nút “Join”.</li>
                    <li>Ở chế độ giới hạn thời gian, hệ thống tự động khóa câu hỏi khi hết giờ nên hãy trả lời thật nhanh.</li>
                    <li>Chat và bảng xếp hạng sẽ hiển thị trong phòng để mọi người trao đổi chiến thuật.</li>
                    <li>Có thể xem lịch sử battle của bạn ở endpoint <code class="px-2 py-1 bg-slate-100 rounded">/learning/quiz-battle/history</code>.</li>
                </ul>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function() {
        const modeSelect = document.getElementById('battle-mode');
        const timedConfig = document.getElementById('timed-config');
        const creationForm = document.getElementById('battle-settings-form');
        const resultBox = document.getElementById('room-creation-result');
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const selectedContainerInput = document.getElementById('selected-container-id');
        const selectedQuizLabel = document.getElementById('selected-quiz-label');
        const quizSelectionGrid = document.getElementById('quiz-selection-grid');
        const quizSearchInput = document.getElementById('quiz-search-input');
        const quizSearchStatus = document.getElementById('quiz-search-status');
        const refreshQuizBtn = document.getElementById('refresh-quiz-list');
        const clearQuizSelectionBtn = document.getElementById('clear-quiz-selection');
        const publicRoomsContainer = document.getElementById('public-rooms-list');
        const myRoomsContainer = document.getElementById('my-rooms-list');
        const refreshPublicRoomsBtn = document.getElementById('refresh-public-rooms');
        const refreshMyRoomsBtn = document.getElementById('refresh-my-rooms');
        const joinRoomForm = document.getElementById('join-room-form');
        const joinRoomCodeInput = document.getElementById('join-room-code');
        const joinRoomFeedback = document.getElementById('join-room-feedback');
        const quizSetsEndpoint = "{{ url_for('learning.quiz_battle.list_available_quizzes') }}";
        const createRoomUrl = "{{ url_for('learning.quiz_battle.create_room') }}";
        const publicRoomsUrl = "{{ url_for('learning.quiz_battle.list_public_rooms') }}";
        const myRoomsUrl = "{{ url_for('learning.quiz_battle.list_my_active_rooms') }}";
        const joinRoomUrlTemplate = "{{ url_for('learning.quiz_battle.join_room', room_code='__ROOM_CODE__') }}";
        let quizCache = new Map();
        let selectedQuizId = null;
        let searchTimeout = null;

        const statusLabels = {
            lobby: 'Đang mở sảnh',
            in_progress: 'Đang thi',
            awaiting_host: 'Chờ chủ phòng',
            completed: 'Đã kết thúc',
        };

        function formatStatus(status) {
            return statusLabels[status] || status;
        }

        function formatMode(mode) {
            return mode === 'TIMED' ? 'Giới hạn thời gian' : 'Test chậm';
        }

        function renderRoomList(rooms, container, { emptyMessage = 'Không có phòng nào.' } = {}) {
            if (!container) {
                return;
            }
            container.innerHTML = '';
            if (!rooms.length) {
                container.innerHTML = `<p class="text-slate-500">${emptyMessage}</p>`;
                return;
            }

            rooms.forEach((room) => {
                const activePlayers = (room.participants || []).filter((p) => p.status === 'active').length;
                const card = document.createElement('div');
                card.className = 'rounded-2xl border border-slate-200 p-4';
                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">${room.title}</p>
                            <p class="text-xs text-slate-500">Mã phòng: <span class="font-mono tracking-widest">${room.room_code}</span></p>
                        </div>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${room.status === 'in_progress' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}">${formatStatus(room.status)}</span>
                    </div>
                    <div class="mt-3 flex flex-col gap-1 text-xs text-slate-500">
                        <span><i class="fa-solid fa-users"></i> ${activePlayers} người đang hoạt động</span>
                        <span><i class="fa-solid fa-layer-group"></i> ${room.question_total} câu · ${formatMode(room.mode)}</span>
                        <span><i class="fa-solid fa-eye${room.is_public ? '' : '-slash'}"></i> ${room.is_public ? 'Công khai' : 'Riêng tư'}</span>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-2">
                        <button type="button" class="join-room-button inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl text-sm font-semibold ${room.is_public ? 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}" data-room-code="${room.room_code}">
                            <i class="fa-solid fa-right-to-bracket"></i> Tham gia
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function loadPublicRooms() {
            if (!publicRoomsContainer) {
                return;
            }
            publicRoomsContainer.innerHTML = '<p class="text-slate-500">Đang tải phòng công khai...</p>';
            try {
                const response = await fetch(publicRoomsUrl);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                renderRoomList(data.rooms || [], publicRoomsContainer, { emptyMessage: 'Chưa có phòng công khai nào.' });
            } catch (error) {
                publicRoomsContainer.innerHTML = '<p class="text-rose-500">Không thể tải phòng công khai.</p>';
            }
        }

        async function loadMyRooms() {
            if (!myRoomsContainer) {
                return;
            }
            myRoomsContainer.innerHTML = '<p class="text-slate-500">Đang tải phòng của bạn...</p>';
            try {
                const response = await fetch(myRoomsUrl);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                renderRoomList(data.rooms || [], myRoomsContainer, { emptyMessage: 'Bạn chưa ở phòng nào.' });
            } catch (error) {
                myRoomsContainer.innerHTML = '<p class="text-rose-500">Không thể tải danh sách phòng của bạn.</p>';
            }
        }

        async function attemptJoinRoom(roomCode) {
            if (!roomCode) {
                return { ok: false, message: 'Vui lòng nhập mã phòng.' };
            }
            const cleanedCode = roomCode.trim().toUpperCase();
            const joinUrl = joinRoomUrlTemplate.replace('__ROOM_CODE__', encodeURIComponent(cleanedCode));
            try {
                const response = await fetch(joinUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                });
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                await response.json();
                return { ok: true, message: `✅ Đã tham gia phòng ${cleanedCode}. Mở phòng trong tab khác để bắt đầu.` };
            } catch (error) {
                return { ok: false, message: `❌ Không thể tham gia phòng: ${error.message}` };
            }
        }

        function updateSelectedQuizDisplay() {
            if (selectedQuizId && quizCache.has(selectedQuizId)) {
                const quiz = quizCache.get(selectedQuizId);
                selectedQuizLabel.textContent = `${quiz.title} (${quiz.question_count} câu hỏi)`;
                clearQuizSelectionBtn.classList.remove('hidden');
            } else {
                selectedQuizLabel.textContent = 'Chưa chọn bộ nào';
                clearQuizSelectionBtn.classList.add('hidden');
            }
        }

        function highlightSelection() {
            quizSelectionGrid.querySelectorAll('[data-quiz-id]').forEach((node) => {
                if (node.dataset.quizId === selectedQuizId) {
                    node.classList.add('ring-2', 'ring-indigo-500');
                } else {
                    node.classList.remove('ring-2', 'ring-indigo-500');
                }
            });
        }

        function renderQuizCards(containers) {
            quizSelectionGrid.innerHTML = '';
            quizCache = new Map();
            if (!containers.length) {
                quizSelectionGrid.innerHTML = '<p class="text-sm text-slate-500 col-span-full">Không tìm thấy bộ quiz phù hợp. Thử từ khóa khác hoặc kiểm tra quyền truy cập của bạn.</p>';
                highlightSelection();
                return;
            }
            for (const container of containers) {
                quizCache.set(String(container.container_id), container);
                const card = document.createElement('button');
                card.type = 'button';
                card.dataset.quizId = String(container.container_id);
                card.className = 'text-left rounded-2xl border border-slate-200 p-4 hover:border-indigo-400 hover:shadow transition';
                const tagText = container.tags ? `<p class="text-xs uppercase tracking-[0.3em] text-indigo-500 mt-2">${container.tags}</p>` : '';
                card.innerHTML = `
                    <p class="text-sm font-semibold text-slate-900">${container.title}</p>
                    <p class="mt-1 text-xs text-slate-500">${container.description || 'Không có mô tả'}</p>
                    <p class="mt-2 text-xs text-slate-500">${container.question_count} câu hỏi · ${container.is_public ? 'Công khai' : 'Riêng tư'}</p>
                    ${tagText}
                `;
                quizSelectionGrid.appendChild(card);
            }
            highlightSelection();
        }

        async function loadQuizSets(query = '') {
            quizSearchStatus.textContent = 'Đang tải danh sách...';
            try {
                const url = new URL(quizSetsEndpoint, window.location.origin);
                if (query) {
                    url.searchParams.set('q', query);
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                renderQuizCards(data.containers || []);
                const count = (data.containers || []).length;
                quizSearchStatus.textContent = count ? `Đã tải ${count} bộ quiz khả dụng.` : 'Không có bộ quiz nào khớp với tìm kiếm.';
            } catch (error) {
                quizSelectionGrid.innerHTML = '<p class="text-sm text-rose-500 col-span-full">Không thể tải danh sách bộ quiz.</p>';
                quizSearchStatus.textContent = 'Có lỗi khi tải danh sách. Thử lại sau.';
            }
        }

        quizSelectionGrid.addEventListener('click', (event) => {
            const card = event.target.closest('[data-quiz-id]');
            if (!card) {
                return;
            }
            const quizId = card.dataset.quizId;
            if (!quizCache.has(quizId)) {
                return;
            }
            selectedQuizId = quizId;
            selectedContainerInput.value = quizId;
            updateSelectedQuizDisplay();
            highlightSelection();
        });

        clearQuizSelectionBtn.addEventListener('click', () => {
            selectedQuizId = null;
            selectedContainerInput.value = '';
            updateSelectedQuizDisplay();
            highlightSelection();
        });

        quizSearchInput.addEventListener('input', () => {
            const query = quizSearchInput.value.trim();
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadQuizSets(query), 350);
        });

        refreshQuizBtn.addEventListener('click', () => {
            loadQuizSets(quizSearchInput.value.trim());
        });

        refreshPublicRoomsBtn?.addEventListener('click', loadPublicRooms);
        refreshMyRoomsBtn?.addEventListener('click', loadMyRooms);

        modeSelect.addEventListener('change', function() {
            if (this.value === 'TIMED') {
                timedConfig.classList.remove('hidden');
            } else {
                timedConfig.classList.add('hidden');
            }
        });

        document.addEventListener('click', async (event) => {
            const button = event.target.closest('.join-room-button');
            if (!button) {
                return;
            }
            const roomCode = button.dataset.roomCode;
            const result = await attemptJoinRoom(roomCode);
            if (joinRoomFeedback) {
                joinRoomFeedback.innerHTML = result.message;
            }
            if (result.ok) {
                loadPublicRooms();
                loadMyRooms();
            }
        });

        joinRoomForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            const roomCode = joinRoomCodeInput.value;
            const result = await attemptJoinRoom(roomCode);
            if (joinRoomFeedback) {
                joinRoomFeedback.innerHTML = result.message;
            }
            if (result.ok) {
                joinRoomCodeInput.value = '';
                loadPublicRooms();
                loadMyRooms();
            }
        });

        creationForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            resultBox.textContent = 'Đang tạo phòng...';
            const formData = new FormData(creationForm);
            const payload = Object.fromEntries(formData.entries());
            if (!payload.container_id) {
                resultBox.innerHTML = '❌ Vui lòng chọn một bộ quiz trước khi tạo phòng.';
                return;
            }
            if (!payload.question_limit) {
                delete payload.question_limit;
            } else {
                payload.question_limit = Number(payload.question_limit);
            }
            if (!payload.time_per_question_seconds || payload.mode !== 'TIMED') {
                delete payload.time_per_question_seconds;
            } else {
                payload.time_per_question_seconds = Number(payload.time_per_question_seconds);
            }
            payload.container_id = Number(payload.container_id);
            try {
                const response = await fetch(createRoomUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                resultBox.innerHTML = `✅ Đã tạo phòng <strong>${data.room.title}</strong> với mã <strong>${data.room.room_code}</strong>. ${data.room.is_public ? 'Phòng đang hiển thị ở mục Phòng công khai.' : 'Gửi mã này cho bạn bè để họ tham gia.'}`;
                loadPublicRooms();
                loadMyRooms();
            } catch (error) {
                resultBox.innerHTML = `❌ Không thể tạo phòng: ${error.message}`;
            }
        });

        loadQuizSets();
        updateSelectedQuizDisplay();
        loadPublicRooms();
        loadMyRooms();
    })();
</script>
{% endblock %}
