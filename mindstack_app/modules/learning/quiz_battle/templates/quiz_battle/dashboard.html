{% extends "base.html" %}

{% block title %}Quiz Battle{% endblock %}

{% block head %}
{{ super() }}
<style>
    .qb-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    .qb-status-live {
        background: #fef3c7;
        color: #92400e;
    }

    .qb-status-lobby {
        background: #e0f2fe;
        color: #075985;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 lg:px-8 lg:py-8 space-y-6">
    <div class="bg-white rounded-xl shadow-lg p-6 space-y-4">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="space-y-1">
                <p class="text-xs font-semibold uppercase tracking-[0.25em] text-indigo-600">Học theo nhóm</p>
                <h1 class="text-2xl font-bold text-slate-900">Thi đấu quiz cùng đội của bạn</h1>
                <p class="text-sm text-slate-600 max-w-3xl">Danh sách phòng công khai và phòng bạn tham gia hiển thị ngay tại đây. Chọn phòng có sẵn, nhập mã hoặc tạo phòng mới tương tự trải nghiệm học nhóm flashcard.</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button type="button" id="open-create-room" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700">
                    <i class="fa-solid fa-plus"></i><span>Tạo phòng mới</span>
                </button>
                <button type="button" id="refresh-public-rooms" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-blue-200 bg-blue-50 text-blue-700 font-semibold hover:bg-blue-100">
                    <i class="fa-solid fa-rotate"></i><span>Tải phòng công khai</span>
                </button>
                <button type="button" id="refresh-my-rooms" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-200 bg-slate-50 text-slate-700 font-semibold hover:bg-slate-100">
                    <i class="fa-solid fa-user-group"></i><span>Tải phòng của bạn</span>
                </button>
            </div>
        </div>

        <div class="grid gap-4 lg:grid-cols-3">
            <div class="lg:col-span-2 grid gap-4 md:grid-cols-2">
                <section class="p-4 rounded-xl border border-blue-100 bg-blue-50 space-y-3">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-600">Phòng công khai</p>
                            <h2 class="text-lg font-semibold text-slate-900">Vào nhanh không cần mã</h2>
                            <p class="text-sm text-blue-900/80">Danh sách cập nhật liên tục. Bấm để vào ngay.</p>
                        </div>
                    </div>
                    <div id="public-rooms-list" class="space-y-3 text-sm text-slate-600">
                        <p class="text-slate-500">Đang tải danh sách phòng...</p>
                    </div>
                </section>

                <section class="p-4 rounded-xl border border-indigo-100 bg-indigo-50 space-y-3">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-indigo-600">Phòng của bạn</p>
                            <h2 class="text-lg font-semibold text-slate-900">Tiếp tục trận đang chơi</h2>
                            <p class="text-sm text-indigo-900/80">Những phòng bạn làm chủ hoặc đã tham gia.</p>
                        </div>
                    </div>
                    <div id="my-rooms-list" class="space-y-3 text-sm text-slate-600">
                        <p class="text-slate-500">Đang kiểm tra phòng bạn đã tham gia...</p>
                    </div>
                </section>
            </div>

            <section class="p-4 rounded-xl border border-slate-200 bg-slate-50 space-y-3">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-right-to-bracket"></i> Tham gia bằng mã</h3>
                <p class="text-sm text-slate-600">Nhập mã do chủ phòng chia sẻ (kể cả phòng riêng tư).</p>
                <form id="join-room-form" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Mã phòng</label>
                        <input type="text" id="join-room-code" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-2 uppercase tracking-widest focus:border-indigo-500 focus:ring-indigo-500" placeholder="Ví dụ: ABC123" maxlength="12" required>
                    </div>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">
                        <i class="fa-solid fa-door-open"></i><span>Vào phòng</span>
                    </button>
                </form>
                <p id="join-room-feedback" class="text-sm"></p>
                <ul class="list-disc list-inside text-xs text-slate-600 space-y-1">
                    <li>Phòng công khai và phòng riêng đều vào được bằng mã.</li>
                    <li>Chia sẻ mã này cho bạn bè để học cùng.</li>
                </ul>
            </section>
        </div>

        <section id="create-room-section" class="bg-white rounded-xl shadow-lg p-6 space-y-4">
            <div class="space-y-1">
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2"><i class="fa-solid fa-plus-circle text-indigo-600"></i> Tạo phòng Quiz Battle mới</h2>
                <p class="text-sm text-gray-600">Chọn bộ quiz, điều chỉnh chế độ và quyết định hiển thị phòng tương tự cách tạo phòng học nhóm flashcard.</p>
            </div>

            <div class="grid gap-4 lg:grid-cols-3">
                <div class="lg:col-span-2 space-y-3">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-700">Tìm bộ quiz</label>
                            <input type="text" id="quiz-search-input" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập tên bộ quiz hoặc từ khóa">
                        </div>
                        <button type="button" id="refresh-quiz-list" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50">
                            <i class="fa-solid fa-rotate"></i> Tải danh sách
                        </button>
                    </div>
                    <p id="quiz-search-status" class="text-xs text-slate-500">Đang tải danh sách bộ quiz khả dụng...</p>
                    <div id="quiz-selection-grid" class="grid gap-3 sm:grid-cols-2"></div>
                    <div class="flex flex-wrap items-center gap-2 text-sm text-gray-700">
                        <span class="font-semibold">Đã chọn:</span>
                        <span id="selected-quiz-label" class="text-gray-500 italic">Chưa chọn bộ nào</span>
                        <button type="button" id="clear-quiz-selection" class="text-xs font-semibold text-rose-600 hidden">Bỏ chọn</button>
                    </div>
                </div>

                <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                    <form id="battle-settings-form" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Tiêu đề phòng</label>
                            <input type="text" name="title" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Quiz Battle tối nay" required>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Số câu hỏi (tuỳ chọn)</label>
                                <input type="number" min="1" name="question_limit" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Để trống dùng toàn bộ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Hiển thị phòng</label>
                                <select name="visibility" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="private">Riêng tư (chia sẻ mã)</option>
                                    <option value="public">Công khai</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Chế độ thi</label>
                            <select name="mode" id="battle-mode" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="SLOW">Test chậm</option>
                                <option value="TIMED">Giới hạn thời gian</option>
                            </select>
                        </div>
                        <div id="timed-config" class="hidden">
                            <label class="block text-sm font-medium text-slate-700">Thời gian mỗi câu (giây)</label>
                            <input type="number" min="5" name="time_per_question_seconds" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Ví dụ: 30">
                            <p class="mt-1 text-xs text-slate-500">Câu hỏi sẽ tự chuyển sau số giây này ở chế độ giới hạn thời gian.</p>
                        </div>
                        <input type="hidden" name="container_id" id="selected-container-id">
                        <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">
                            <i class="fa-solid fa-plus"></i><span>Tạo phòng</span>
                        </button>
                        <div id="room-creation-result" class="text-sm"></div>
                    </form>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function() {
        const modeSelect = document.getElementById('battle-mode');
        const timedConfig = document.getElementById('timed-config');
        const creationForm = document.getElementById('battle-settings-form');
        const resultBox = document.getElementById('room-creation-result');
        const csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfMetaTag ? csrfMetaTag.getAttribute('content') : '';
        const selectedContainerInput = document.getElementById('selected-container-id');
        const selectedQuizLabel = document.getElementById('selected-quiz-label');
        const quizSelectionGrid = document.getElementById('quiz-selection-grid');
        const quizSearchInput = document.getElementById('quiz-search-input');
        const quizSearchStatus = document.getElementById('quiz-search-status');
        const refreshQuizBtn = document.getElementById('refresh-quiz-list');
        const clearQuizSelectionBtn = document.getElementById('clear-quiz-selection');
        const publicRoomsContainer = document.getElementById('public-rooms-list');
        const myRoomsContainer = document.getElementById('my-rooms-list');
        const refreshPublicRoomsBtn = document.getElementById('refresh-public-rooms');
        const refreshMyRoomsBtn = document.getElementById('refresh-my-rooms');
        const joinRoomForm = document.getElementById('join-room-form');
        const joinRoomCodeInput = document.getElementById('join-room-code');
        const joinRoomFeedback = document.getElementById('join-room-feedback');
        const createRoomSection = document.getElementById('create-room-section');
        const openCreateRoomBtn = document.getElementById('open-create-room');
        const quizSetsEndpoint = "{{ url_for('learning.quiz_battle.list_available_quizzes') }}";
        const createRoomUrl = "{{ url_for('learning.quiz_battle.create_room') }}";
        const publicRoomsUrl = "{{ url_for('learning.quiz_battle.list_public_rooms') }}";
        const myRoomsUrl = "{{ url_for('learning.quiz_battle.list_my_active_rooms') }}";
        const joinRoomUrlTemplate = "{{ url_for('learning.quiz_battle.join_room', room_code='__ROOM_CODE__') }}";
        const roomViewUrlTemplate = "{{ url_for('learning.quiz_battle.view_room', room_code='__ROOM_CODE__') }}";
        let quizCache = new Map();
        let selectedQuizId = null;
        let searchTimeout = null;

        const statusLabels = {
            lobby: 'Đang mở sảnh',
            in_progress: 'Đang thi',
            awaiting_host: 'Chờ chủ phòng',
            completed: 'Đã kết thúc',
        };

        openCreateRoomBtn?.addEventListener('click', () => {
            resultBox.textContent = '';
            if (createRoomSection) {
                createRoomSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            if (quizSearchInput) {
                quizSearchInput.focus();
            }
        });

        function formatStatus(status) {
            return statusLabels[status] || status;
        }

        function formatMode(mode) {
            return mode === 'TIMED' ? 'Giới hạn thời gian' : 'Test chậm';
        }

        function renderRoomList(rooms, container, { emptyMessage = 'Không có phòng nào.', canVisitDirectly = false } = {}) {
            if (!container) {
                return;
            }
            container.innerHTML = '';
            if (!rooms.length) {
                container.innerHTML = `<p class="text-slate-500">${emptyMessage}</p>`;
                return;
            }

            rooms.forEach((room) => {
                const activePlayers = (room.participants || []).filter((p) => p.status === 'active').length;
                const viewUrl = roomViewUrlTemplate.replace('__ROOM_CODE__', encodeURIComponent(room.room_code));
                const card = document.createElement('div');
                card.className = 'p-4 rounded-xl border border-slate-200 bg-white shadow-sm space-y-3';
                const statusClass = room.status === 'in_progress' ? 'qb-badge qb-status-live' : 'qb-badge qb-status-lobby';
                const joinClass = room.is_public
                    ? 'join-room-button inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700'
                    : 'join-room-button inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-200 bg-amber-50 text-amber-700 hover:bg-amber-100';
                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">${room.title}</p>
                            <p class="text-xs text-slate-500">Mã phòng: <span class="font-mono tracking-widest">${room.room_code}</span></p>
                        </div>
                        <span class="${statusClass}">${formatStatus(room.status)}</span>
                    </div>
                    <div class="text-sm text-slate-600 space-y-1">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-users"></i> ${activePlayers} người đang hoạt động</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> ${room.question_total} câu · ${formatMode(room.mode)}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-eye${room.is_public ? '' : '-slash'}"></i> ${room.is_public ? 'Công khai' : 'Riêng tư'}</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-auto">
                        <button type="button" class="${joinClass}" data-room-code="${room.room_code}">
                            <i class="fa-solid fa-right-to-bracket"></i> Tham gia
                        </button>
                        ${canVisitDirectly ? `<a href="${viewUrl}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 text-slate-800 font-semibold hover:bg-slate-100">
                            <i class="fa-solid fa-door-open"></i> Vào phòng
                        </a>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function loadPublicRooms() {
            if (!publicRoomsContainer) {
                return;
            }
            publicRoomsContainer.innerHTML = '<p class="text-slate-500">Đang tải phòng công khai...</p>';
            try {
                const response = await fetch(publicRoomsUrl);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                renderRoomList(data.rooms || [], publicRoomsContainer, { emptyMessage: 'Chưa có phòng công khai nào.' });
            } catch (error) {
                publicRoomsContainer.innerHTML = '<p class="text-rose-500">Không thể tải phòng công khai.</p>';
            }
        }

        async function loadMyRooms() {
            if (!myRoomsContainer) {
                return;
            }
            myRoomsContainer.innerHTML = '<p class="text-slate-500">Đang tải phòng của bạn...</p>';
            try {
                const response = await fetch(myRoomsUrl);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                renderRoomList(data.rooms || [], myRoomsContainer, { emptyMessage: 'Bạn chưa ở phòng nào.', canVisitDirectly: true });
            } catch (error) {
                myRoomsContainer.innerHTML = '<p class="text-rose-500">Không thể tải danh sách phòng của bạn.</p>';
            }
        }

        async function attemptJoinRoom(roomCode) {
            if (!roomCode) {
                return { ok: false, message: 'Vui lòng nhập mã phòng.' };
            }
            const cleanedCode = roomCode.trim().toUpperCase();
            const joinUrl = joinRoomUrlTemplate.replace('__ROOM_CODE__', encodeURIComponent(cleanedCode));
            try {
                const joinHeaders = {
                    'Content-Type': 'application/json',
                };
                if (csrfToken) {
                    joinHeaders['X-CSRFToken'] = csrfToken;
                }
                const response = await fetch(joinUrl, {
                    method: 'POST',
                    headers: joinHeaders,
                });
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                await response.json();
                const redirectUrl = roomViewUrlTemplate.replace('__ROOM_CODE__', encodeURIComponent(cleanedCode));
                return { ok: true, message: `✅ Đã tham gia phòng ${cleanedCode}. Đang chuyển đến giao diện phòng...`, redirectUrl };
            } catch (error) {
                return { ok: false, message: `❌ Không thể tham gia phòng: ${error.message}` };
            }
        }

        function updateSelectedQuizDisplay() {
            if (selectedQuizId && quizCache.has(selectedQuizId)) {
                const quiz = quizCache.get(selectedQuizId);
                selectedQuizLabel.textContent = `${quiz.title} (${quiz.question_count} câu hỏi)`;
                clearQuizSelectionBtn.classList.remove('hidden');
            } else {
                selectedQuizLabel.textContent = 'Chưa chọn bộ nào';
                clearQuizSelectionBtn.classList.add('hidden');
            }
        }

        function highlightSelection() {
            quizSelectionGrid.querySelectorAll('[data-quiz-id]').forEach((node) => {
                if (node.dataset.quizId === selectedQuizId) {
                    node.classList.add('ring-2', 'ring-indigo-500');
                } else {
                    node.classList.remove('ring-2', 'ring-indigo-500');
                }
            });
        }

        function renderQuizCards(containers) {
            quizSelectionGrid.innerHTML = '';
            quizCache = new Map();
            if (!containers.length) {
                quizSelectionGrid.innerHTML = '<p class="text-sm text-slate-500 col-span-full">Không tìm thấy bộ quiz phù hợp. Thử từ khóa khác hoặc kiểm tra quyền truy cập của bạn.</p>';
                highlightSelection();
                return;
            }
            for (const container of containers) {
                quizCache.set(String(container.container_id), container);
                const card = document.createElement('button');
                card.type = 'button';
                card.dataset.quizId = String(container.container_id);
                card.className = 'text-left rounded-2xl border border-slate-200 p-4 hover:border-indigo-400 hover:shadow transition';
                const tagText = container.tags ? `<p class="text-xs uppercase tracking-[0.3em] text-indigo-500 mt-2">${container.tags}</p>` : '';
                card.innerHTML = `
                    <p class="text-sm font-semibold text-slate-900">${container.title}</p>
                    <p class="mt-1 text-xs text-slate-500">${container.description || 'Không có mô tả'}</p>
                    <p class="mt-2 text-xs text-slate-500">${container.question_count} câu hỏi · ${container.is_public ? 'Công khai' : 'Riêng tư'}</p>
                    ${tagText}
                `;
                quizSelectionGrid.appendChild(card);
            }
            highlightSelection();
        }

        async function loadQuizSets(query = '') {
            quizSearchStatus.textContent = 'Đang tải danh sách...';
            try {
                const url = new URL(quizSetsEndpoint, window.location.origin);
                if (query) {
                    url.searchParams.set('q', query);
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                renderQuizCards(data.containers || []);
                const count = (data.containers || []).length;
                quizSearchStatus.textContent = count ? `Đã tải ${count} bộ quiz khả dụng.` : 'Không có bộ quiz nào khớp với tìm kiếm.';
            } catch (error) {
                quizSelectionGrid.innerHTML = '<p class="text-sm text-rose-500 col-span-full">Không thể tải danh sách bộ quiz.</p>';
                quizSearchStatus.textContent = 'Có lỗi khi tải danh sách. Thử lại sau.';
            }
        }

        quizSelectionGrid.addEventListener('click', (event) => {
            const card = event.target.closest('[data-quiz-id]');
            if (!card) {
                return;
            }
            const quizId = card.dataset.quizId;
            if (!quizCache.has(quizId)) {
                return;
            }
            selectedQuizId = quizId;
            selectedContainerInput.value = quizId;
            updateSelectedQuizDisplay();
            highlightSelection();
        });

        clearQuizSelectionBtn.addEventListener('click', () => {
            selectedQuizId = null;
            selectedContainerInput.value = '';
            updateSelectedQuizDisplay();
            highlightSelection();
        });

        quizSearchInput.addEventListener('input', () => {
            const query = quizSearchInput.value.trim();
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadQuizSets(query), 350);
        });

        refreshQuizBtn.addEventListener('click', () => {
            loadQuizSets(quizSearchInput.value.trim());
        });

        refreshPublicRoomsBtn?.addEventListener('click', loadPublicRooms);
        refreshMyRoomsBtn?.addEventListener('click', loadMyRooms);

        modeSelect.addEventListener('change', function() {
            if (this.value === 'TIMED') {
                timedConfig.classList.remove('hidden');
            } else {
                timedConfig.classList.add('hidden');
            }
        });

        document.addEventListener('click', async (event) => {
            const button = event.target.closest('.join-room-button');
            if (!button) {
                return;
            }
            const roomCode = button.dataset.roomCode;
            const result = await attemptJoinRoom(roomCode);
            if (joinRoomFeedback) {
                joinRoomFeedback.innerHTML = result.message;
            }
            if (result.ok) {
                if (result.redirectUrl) {
                    window.location.href = result.redirectUrl;
                    return;
                }
                loadPublicRooms();
                loadMyRooms();
            }
        });

        joinRoomForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            const roomCode = joinRoomCodeInput.value;
            const result = await attemptJoinRoom(roomCode);
            if (joinRoomFeedback) {
                joinRoomFeedback.innerHTML = result.message;
            }
            if (result.ok) {
                joinRoomCodeInput.value = '';
                if (result.redirectUrl) {
                    window.location.href = result.redirectUrl;
                    return;
                }
                loadPublicRooms();
                loadMyRooms();
            }
        });

        creationForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            resultBox.textContent = 'Đang tạo phòng...';
            const formData = new FormData(creationForm);
            const payload = Object.fromEntries(formData.entries());
            if (!payload.container_id) {
                resultBox.innerHTML = '❌ Vui lòng chọn một bộ quiz trước khi tạo phòng.';
                return;
            }
            if (!payload.question_limit) {
                delete payload.question_limit;
            } else {
                payload.question_limit = Number(payload.question_limit);
            }
            if (!payload.time_per_question_seconds || payload.mode !== 'TIMED') {
                delete payload.time_per_question_seconds;
            } else {
                payload.time_per_question_seconds = Number(payload.time_per_question_seconds);
            }
            payload.container_id = Number(payload.container_id);
            try {
                const creationHeaders = {
                    'Content-Type': 'application/json',
                };
                if (csrfToken) {
                    creationHeaders['X-CSRFToken'] = csrfToken;
                }
                const response = await fetch(createRoomUrl, {
                    method: 'POST',
                    headers: creationHeaders,
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                resultBox.innerHTML = `✅ Đã tạo phòng <strong>${data.room.title}</strong> với mã <strong>${data.room.room_code}</strong>. ${data.room.is_public ? 'Phòng đang hiển thị ở mục Phòng công khai.' : 'Gửi mã này cho bạn bè để họ tham gia.'}`;
                loadPublicRooms();
                loadMyRooms();
            } catch (error) {
                resultBox.innerHTML = `❌ Không thể tạo phòng: ${error.message}`;
            }
        });

        loadQuizSets();
        updateSelectedQuizDisplay();
        loadPublicRooms();
        loadMyRooms();
    })();
</script>
{% endblock %}
