{% extends "base.html" %}

{% block title %}Quiz Battle{% endblock %}

{% block content %}
<div class="py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-10">
        <header class="bg-white rounded-3xl shadow-sm border border-slate-100 p-8 flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
            <div>
                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-indigo-500">Quiz Battle</p>
                <h1 class="mt-3 text-3xl sm:text-4xl font-bold text-slate-900">Thách đấu quiz theo thời gian thực</h1>
                <p class="mt-4 text-slate-600 max-w-2xl">
                    Rủ bạn bè vào phòng Quiz Battle để so tài kiến thức. Bạn có thể chọn chế độ Test chậm để chờ mọi người hoàn thành
                    hoặc bật chế độ Giới hạn thời gian để tự động chuyển câu hỏi khi hết giờ.
                </p>
            </div>
            <div class="flex gap-3 flex-wrap">
                <a href="{{ url_for('learning.quiz_learning.quiz_learning_dashboard') }}" class="inline-flex items-center gap-2 px-5 py-3 rounded-2xl bg-indigo-600 text-white font-semibold shadow-md hover:bg-indigo-500">
                    <i class="fa-solid fa-layer-group"></i> Chọn bộ quiz
                </a>
                <a href="{{ url_for('stats.dashboard') }}" class="inline-flex items-center gap-2 px-5 py-3 rounded-2xl bg-white border border-slate-200 text-slate-800 font-semibold hover:bg-slate-50">
                    <i class="fa-solid fa-chart-line"></i> Xem thành tích
                </a>
            </div>
        </header>

        <section class="grid gap-6 md:grid-cols-2">
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <h2 class="text-xl font-semibold text-slate-900">Hai chế độ thi đấu</h2>
                <div class="space-y-4">
                    <article class="p-4 rounded-2xl border border-emerald-100 bg-emerald-50">
                        <div class="flex items-center gap-3">
                            <span class="w-10 h-10 rounded-2xl bg-white flex items-center justify-center text-emerald-600"><i class="fa-solid fa-users"></i></span>
                            <div>
                                <h3 class="font-semibold text-emerald-700">Test chậm</h3>
                                <p class="text-sm text-emerald-600">Mỗi câu hỏi chỉ chuyển khi tất cả thành viên đã trả lời xong, phù hợp để thảo luận kỹ.</p>
                            </div>
                        </div>
                    </article>
                    <article class="p-4 rounded-2xl border border-amber-100 bg-amber-50">
                        <div class="flex items-center gap-3">
                            <span class="w-10 h-10 rounded-2xl bg-white flex items-center justify-center text-amber-600"><i class="fa-solid fa-stopwatch"></i></span>
                            <div>
                                <h3 class="font-semibold text-amber-700">Giới hạn thời gian</h3>
                                <p class="text-sm text-amber-600">Đặt số lượng câu hỏi và thời gian trả lời mỗi câu. Khi hết giờ hệ thống tự động chuyển câu.</p>
                            </div>
                        </div>
                    </article>
                </div>
                <p class="text-sm text-slate-500">Bạn có thể cấu hình chế độ ngay khi tạo phòng để phù hợp với tốc độ của cả nhóm.</p>
            </div>

            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-6">
                <div>
                    <h2 class="text-xl font-semibold text-slate-900">Tạo phòng mới</h2>
                    <p class="text-sm text-slate-500">Chọn bộ quiz và cấu hình chế độ thi đấu bên dưới, sau đó chia sẻ mã phòng cho bạn bè.</p>
                </div>
                <form id="battle-settings-form" class="space-y-4">
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-slate-700">Chọn bộ quiz</label>
                        <div class="space-y-3">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="flex-1">
                                    <input type="text" id="quiz-search-input" class="w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập tên bộ quiz, thẻ hoặc từ khóa">
                                </div>
                                <button type="button" id="refresh-quiz-list" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-2xl border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50">
                                    <i class="fa-solid fa-rotate"></i> Tải danh sách
                                </button>
                            </div>
                            <p id="quiz-search-status" class="text-xs text-slate-500">Đang tải danh sách bộ quiz khả dụng...</p>
                            <div id="quiz-selection-grid" class="grid gap-3 sm:grid-cols-2"></div>
                            <p class="text-xs text-slate-500">Bấm vào một bộ quiz để sử dụng ngay. Hệ thống tự lọc các bộ bạn có quyền truy cập.</p>
                            <div class="flex flex-wrap items-center gap-3 text-sm">
                                <span class="font-semibold text-slate-700">Đã chọn:</span>
                                <span id="selected-quiz-label" class="text-slate-500 italic">Chưa chọn bộ nào</span>
                                <button type="button" id="clear-quiz-selection" class="text-xs font-semibold text-rose-600 hidden">Bỏ chọn</button>
                            </div>
                        </div>
                        <input type="hidden" name="container_id" id="selected-container-id">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Tiêu đề phòng</label>
                        <input type="text" name="title" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Quiz Battle tối nay" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Số lượng câu hỏi</label>
                        <input type="number" min="1" name="question_limit" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Để trống nếu muốn dùng toàn bộ bộ quiz">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Chế độ thi</label>
                        <select name="mode" id="battle-mode" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="SLOW">Test chậm</option>
                            <option value="TIMED">Giới hạn thời gian</option>
                        </select>
                    </div>
                    <div id="timed-config" class="hidden">
                        <label class="block text-sm font-medium text-slate-700">Thời gian cho mỗi câu (giây)</label>
                        <input type="number" min="5" name="time_per_question_seconds" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Ví dụ: 30">
                        <p class="mt-2 text-xs text-slate-500">Ở chế độ giới hạn thời gian, câu hỏi sẽ tự chuyển sau khi hết số giây này.</p>
                    </div>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-500">
                        <i class="fa-solid fa-plus"></i> Tạo phòng ngay
                    </button>
                </form>
                <div id="room-creation-result" class="text-sm"></div>
            </div>
        </section>

        <section class="grid gap-6 md:grid-cols-2">
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <h2 class="text-xl font-semibold text-slate-900">Hướng dẫn nhanh</h2>
                <ol class="list-decimal pl-5 space-y-2 text-sm text-slate-600">
                    <li>Chọn bộ quiz ở bảng bên phải, đặt tiêu đề phòng rồi bấm <strong>Tạo phòng ngay</strong>.</li>
                    <li>Sao chép mã phòng được tạo và gửi cho mọi người để họ tham gia từ dashboard này.</li>
                    <li>Sau khi vào phòng, hệ thống sẽ hiển thị chat nội bộ cùng danh sách người chơi để bạn điều khiển.</li>
                    <li>Chủ phòng có thể chuyển chế độ, khóa phòng hoặc kết thúc trận bất kỳ lúc nào.</li>
                </ol>
                <p class="text-xs text-slate-500">Chat chỉ xuất hiện bên trong phòng để đảm bảo riêng tư giữa các thành viên tham gia.</p>
            </div>
            <div class="bg-white rounded-3xl border border-slate-100 p-8 space-y-4">
                <h2 class="text-xl font-semibold text-slate-900">Mẹo sử dụng</h2>
                <ul class="list-disc pl-5 text-sm text-slate-600 space-y-2">
                    <li>Chia sẻ mã phòng sau khi tạo để mọi người tham gia qua nút “Join”.</li>
                    <li>Ở chế độ giới hạn thời gian, hệ thống tự động khóa câu hỏi khi hết giờ nên hãy trả lời thật nhanh.</li>
                    <li>Chat và bảng xếp hạng sẽ hiển thị trong phòng để mọi người trao đổi chiến thuật.</li>
                    <li>Có thể xem lịch sử battle của bạn ở endpoint <code class="px-2 py-1 bg-slate-100 rounded">/learning/quiz-battle/history</code>.</li>
                </ul>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function() {
        const modeSelect = document.getElementById('battle-mode');
        const timedConfig = document.getElementById('timed-config');
        const creationForm = document.getElementById('battle-settings-form');
        const resultBox = document.getElementById('room-creation-result');
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const selectedContainerInput = document.getElementById('selected-container-id');
        const selectedQuizLabel = document.getElementById('selected-quiz-label');
        const quizSelectionGrid = document.getElementById('quiz-selection-grid');
        const quizSearchInput = document.getElementById('quiz-search-input');
        const quizSearchStatus = document.getElementById('quiz-search-status');
        const refreshQuizBtn = document.getElementById('refresh-quiz-list');
        const clearQuizSelectionBtn = document.getElementById('clear-quiz-selection');
        const quizSetsEndpoint = "{{ url_for('learning.quiz_battle.list_available_quizzes') }}";
        const createRoomUrl = "{{ url_for('learning.quiz_battle.create_room') }}";
        let quizCache = new Map();
        let selectedQuizId = null;
        let searchTimeout = null;

        function updateSelectedQuizDisplay() {
            if (selectedQuizId && quizCache.has(selectedQuizId)) {
                const quiz = quizCache.get(selectedQuizId);
                selectedQuizLabel.textContent = `${quiz.title} (${quiz.question_count} câu hỏi)`;
                clearQuizSelectionBtn.classList.remove('hidden');
            } else {
                selectedQuizLabel.textContent = 'Chưa chọn bộ nào';
                clearQuizSelectionBtn.classList.add('hidden');
            }
        }

        function highlightSelection() {
            quizSelectionGrid.querySelectorAll('[data-quiz-id]').forEach((node) => {
                if (node.dataset.quizId === selectedQuizId) {
                    node.classList.add('ring-2', 'ring-indigo-500');
                } else {
                    node.classList.remove('ring-2', 'ring-indigo-500');
                }
            });
        }

        function renderQuizCards(containers) {
            quizSelectionGrid.innerHTML = '';
            quizCache = new Map();
            if (!containers.length) {
                quizSelectionGrid.innerHTML = '<p class="text-sm text-slate-500 col-span-full">Không tìm thấy bộ quiz phù hợp. Thử từ khóa khác hoặc kiểm tra quyền truy cập của bạn.</p>';
                highlightSelection();
                return;
            }
            for (const container of containers) {
                quizCache.set(String(container.container_id), container);
                const card = document.createElement('button');
                card.type = 'button';
                card.dataset.quizId = String(container.container_id);
                card.className = 'text-left rounded-2xl border border-slate-200 p-4 hover:border-indigo-400 hover:shadow transition';
                const tagText = container.tags ? `<p class="text-xs uppercase tracking-[0.3em] text-indigo-500 mt-2">${container.tags}</p>` : '';
                card.innerHTML = `
                    <p class="text-sm font-semibold text-slate-900">${container.title}</p>
                    <p class="mt-1 text-xs text-slate-500">${container.description || 'Không có mô tả'}</p>
                    <p class="mt-2 text-xs text-slate-500">${container.question_count} câu hỏi · ${container.is_public ? 'Công khai' : 'Riêng tư'}</p>
                    ${tagText}
                `;
                quizSelectionGrid.appendChild(card);
            }
            highlightSelection();
        }

        async function loadQuizSets(query = '') {
            quizSearchStatus.textContent = 'Đang tải danh sách...';
            try {
                const url = new URL(quizSetsEndpoint, window.location.origin);
                if (query) {
                    url.searchParams.set('q', query);
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                renderQuizCards(data.containers || []);
                const count = (data.containers || []).length;
                quizSearchStatus.textContent = count ? `Đã tải ${count} bộ quiz khả dụng.` : 'Không có bộ quiz nào khớp với tìm kiếm.';
            } catch (error) {
                quizSelectionGrid.innerHTML = '<p class="text-sm text-rose-500 col-span-full">Không thể tải danh sách bộ quiz.</p>';
                quizSearchStatus.textContent = 'Có lỗi khi tải danh sách. Thử lại sau.';
            }
        }

        quizSelectionGrid.addEventListener('click', (event) => {
            const card = event.target.closest('[data-quiz-id]');
            if (!card) {
                return;
            }
            const quizId = card.dataset.quizId;
            if (!quizCache.has(quizId)) {
                return;
            }
            selectedQuizId = quizId;
            selectedContainerInput.value = quizId;
            updateSelectedQuizDisplay();
            highlightSelection();
        });

        clearQuizSelectionBtn.addEventListener('click', () => {
            selectedQuizId = null;
            selectedContainerInput.value = '';
            updateSelectedQuizDisplay();
            highlightSelection();
        });

        quizSearchInput.addEventListener('input', () => {
            const query = quizSearchInput.value.trim();
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadQuizSets(query), 350);
        });

        refreshQuizBtn.addEventListener('click', () => {
            loadQuizSets(quizSearchInput.value.trim());
        });

        modeSelect.addEventListener('change', function() {
            if (this.value === 'TIMED') {
                timedConfig.classList.remove('hidden');
            } else {
                timedConfig.classList.add('hidden');
            }
        });

        creationForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            resultBox.textContent = 'Đang tạo phòng...';
            const formData = new FormData(creationForm);
            const payload = Object.fromEntries(formData.entries());
            if (!payload.container_id) {
                resultBox.innerHTML = '❌ Vui lòng chọn một bộ quiz trước khi tạo phòng.';
                return;
            }
            if (!payload.question_limit) {
                delete payload.question_limit;
            } else {
                payload.question_limit = Number(payload.question_limit);
            }
            if (!payload.time_per_question_seconds || payload.mode !== 'TIMED') {
                delete payload.time_per_question_seconds;
            } else {
                payload.time_per_question_seconds = Number(payload.time_per_question_seconds);
            }
            payload.container_id = Number(payload.container_id);
            try {
                const response = await fetch(createRoomUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                resultBox.innerHTML = `✅ Đã tạo phòng <strong>${data.room.title}</strong> với mã <strong>${data.room.room_code}</strong>. Chia sẻ mã này với bạn bè để bắt đầu!`;
            } catch (error) {
                resultBox.innerHTML = `❌ Không thể tạo phòng: ${error.message}`;
            }
        });

        loadQuizSets();
        updateSelectedQuizDisplay();
    })();
</script>
{% endblock %}
