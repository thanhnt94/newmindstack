{% extends "base.html" %}

{% block title %}Quiz Battle ¬∑ {{ room_title }}{% endblock %}

{% block head %}
{{ super() }}
<style>
    .qb-session-shell {
        padding: 2rem clamp(1rem, 4vw, 3rem);
        background: #f8fafc;
        min-height: calc(100vh - 80px);
    }

    .qb-session-panel {
        background: #ffffff;
        border-radius: 1.25rem;
        border: 1px solid #e2e8f0;
        padding: 1.5rem;
        box-shadow: 0 25px 45px -30px rgba(15, 23, 42, 0.25);
    }

    .qb-session-header {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
        color: #0f172a;
    }

    @media (min-width: 768px) {
        .qb-session-header {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
    }

    .qb-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: rgba(148, 163, 184, 0.18);
        color: #0f172a;
    }

    .qb-status-badge[data-status="in_progress"] {
        background: rgba(251, 191, 36, 0.2);
        color: #b45309;
    }

    .qb-status-badge[data-status="completed"] {
        background: rgba(16, 185, 129, 0.16);
        color: #047857;
    }

    .qb-room-grid {
        display: grid;
        gap: 1.5rem;
    }

    @media (min-width: 960px) {
        .qb-room-grid {
            grid-template-columns: 2fr 1fr;
        }
    }

    .qb-question-card {
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        padding: 1.5rem;
        background: #fdfdfd;
    }

    .qb-question-options {
        display: grid;
        gap: 0.85rem;
        margin-top: 1rem;
    }

    .qb-option {
        border: 1px solid #cbd5f5;
        border-radius: 1rem;
        padding: 0.85rem 1rem;
        display: flex;
        gap: 0.85rem;
        background: #ffffff;
        align-items: center;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .qb-option:hover {
        border-color: #818cf8;
        box-shadow: 0 10px 20px -15px rgba(99, 102, 241, 0.6);
    }

    .qb-option input {
        accent-color: #6366f1;
        width: 1.25rem;
        height: 1.25rem;
    }

    .qb-sidebar-card {
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        padding: 1.25rem;
        background: #ffffff;
    }

    .qb-participant-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .qb-participant-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
    }

    .qb-chat-box {
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .qb-chat-messages {
        padding: 1rem;
        flex: 1;
        overflow-y: auto;
        border-bottom: 1px solid #e2e8f0;
        max-height: 320px;
    }

    .qb-chat-message {
        margin-bottom: 0.75rem;
    }

    .qb-chat-message strong {
        color: #0f172a;
    }

    .qb-chat-form {
        padding: 1rem;
        display: flex;
        gap: 0.5rem;
    }

    .qb-chat-form input {
        flex: 1;
        border: 1px solid #cbd5f5;
        border-radius: 999px;
        padding: 0.75rem 1rem;
    }

    .qb-chat-form button {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(120deg, #6366f1, #8b5cf6);
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        box-shadow: 0 18px 30px -18px rgba(79, 70, 229, 0.85);
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.3s ease;
    }

    .qb-chat-form button:hover {
        transform: translateY(-1px);
        box-shadow: 0 20px 35px -18px rgba(79, 70, 229, 0.9);
    }

    .qb-chat-form button:focus-visible {
        outline: 2px solid #c7d2fe;
        outline-offset: 2px;
    }

    .qb-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    .qb-action-btn {
        border-radius: 999px;
        padding: 0.65rem 1.25rem;
        border: 1px solid #cbd5f5;
        background: #ffffff;
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        gap: 0.35rem;
        align-items: center;
        transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .qb-action-btn:hover {
        border-color: #6366f1;
        color: #4338ca;
        background: #eef2ff;
    }

    .qb-action-btn--danger {
        border-color: #fecaca;
        color: #b91c1c;
    }

    .qb-alert {
        margin-bottom: 1rem;
        color: #b91c1c;
        min-height: 1.25rem;
    }

    .qb-alert[data-variant="info"] {
        color: #2563eb;
    }

    .qb-timer {
        font-weight: 600;
        color: #ea580c;
    }

    .qb-inline-feedback {
        font-size: 0.9rem;
        color: #475569;
    }

    .qb-feedback-card {
        margin-top: 1rem;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .qb-knowledge-panel {
        margin-top: 1.25rem;
        display: grid;
        gap: 1rem;
    }

    @media (min-width: 768px) {
        .qb-knowledge-panel {
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }
    }

    .qb-knowledge-card,
    .qb-note-card {
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        padding: 1.25rem;
        box-shadow: 0 18px 35px -25px rgba(15, 23, 42, 0.4);
    }

    .qb-knowledge-card__header {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .qb-knowledge-label {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.7rem;
        color: #94a3b8;
        font-weight: 700;
    }

    .qb-knowledge-chip {
        border-radius: 999px;
        background: #eef2ff;
        color: #4338ca;
        font-weight: 600;
        padding: 0.2rem 0.85rem;
        font-size: 0.75rem;
    }

    .qb-knowledge-title {
        font-size: 1.05rem;
        font-weight: 600;
        color: #0f172a;
        margin: 0.15rem 0 0;
    }

    .qb-knowledge-text {
        font-size: 0.95rem;
        color: #475569;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .qb-note-card {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .qb-note-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .qb-note-btn {
        border: none;
        border-radius: 999px;
        background: #111827;
        color: #ffffff;
        font-weight: 600;
        padding: 0.4rem 1.1rem;
        cursor: pointer;
        font-size: 0.9rem;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .qb-note-btn--ghost {
        background: transparent;
        color: #475569;
        border: 1px solid #cbd5f5;
        box-shadow: none;
    }

    .qb-note-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .qb-note-btn:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px -12px rgba(15, 23, 42, 0.3);
    }

    .qb-note-link {
        font-size: 0.85rem;
        color: #6366f1;
        text-decoration: underline;
    }

    .qb-note-view {
        min-height: 3rem;
        font-size: 0.95rem;
        color: #334155;
    }

    .qb-note-editor {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .qb-note-textarea,
    .qb-feedback-textarea {
        width: 100%;
        border-radius: 0.85rem;
        border: 1px solid #cbd5f5;
        padding: 0.75rem 1rem;
        resize: vertical;
        min-height: 110px;
        font-size: 0.95rem;
        font-family: inherit;
        color: #0f172a;
    }

    .qb-note-editor-actions,
    .qb-feedback-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .qb-feedback-hint {
        font-size: 0.8rem;
        color: #94a3b8;
    }

    .qb-feedback-lite .qb-note-btn {
        background: #2563eb;
    }

    .qb-feedback-status {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .qb-feedback-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .qb-feedback-card[data-state="correct"] .qb-feedback-icon {
        background: #dcfce7;
        color: #15803d;
    }

    .qb-feedback-card[data-state="incorrect"] .qb-feedback-icon {
        background: #fee2e2;
        color: #b91c1c;
    }

    .qb-feedback-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #0f172a;
    }

    .qb-feedback-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
    }

    .qb-feedback-meta-item {
        padding: 0.75rem 1rem;
        border-radius: 0.85rem;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.85rem;
        color: #475569;
    }

    .qb-feedback-meta-item strong {
        font-size: 1.2rem;
        color: #0f172a;
    }

    .qb-feedback-explanation {
        border-radius: 0.85rem;
        border: 1px dashed #cbd5f5;
        padding: 1rem;
        background: #f9fafb;
        font-size: 0.95rem;
        color: #1f2937;
    }

    .qb-question-stats-card {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .qb-question-stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
    }

    .qb-question-stats-chip {
        padding: 0.2rem 0.65rem;
        background: #eef2ff;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #4338ca;
    }

    .qb-question-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
    }

    .qb-question-stat {
        border: 1px solid #e2e8f0;
        border-radius: 0.9rem;
        padding: 0.9rem 1rem;
        background: #f8fafc;
    }

    .qb-question-stat-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.08em;
    }

    .qb-question-stat-value {
        font-size: 1.35rem;
        font-weight: 700;
        color: #0f172a;
    }

    .qb-question-stat-value--accent {
        color: #0ea5e9;
    }

    .qb-option-distribution {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .qb-option-distribution-row {
        display: grid;
        grid-template-columns: 1fr minmax(140px, 2fr) auto;
        gap: 0.75rem;
        align-items: center;
    }

    .qb-option-distribution-label span {
        font-weight: 600;
        color: #0f172a;
    }

    .qb-option-distribution-label small {
        display: block;
        color: #64748b;
        font-size: 0.8rem;
    }

    .qb-option-distribution-track {
        width: 100%;
        height: 0.5rem;
        border-radius: 999px;
        background: #e2e8f0;
        overflow: hidden;
    }

    .qb-option-distribution-bar {
        display: block;
        height: 100%;
        border-radius: inherit;
        background: linear-gradient(90deg, #c7d2fe, #6366f1);
    }

    .qb-option-distribution-row[data-correct="true"] .qb-option-distribution-bar {
        background: linear-gradient(90deg, #86efac, #16a34a);
    }

    .qb-option-distribution-meta {
        font-size: 0.85rem;
        color: #475569;
        font-variant-numeric: tabular-nums;
    }

    .qb-empty-state {
        font-size: 0.9rem;
        color: #94a3b8;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="qb-session-shell">
    <div class="qb-session-header">
        <div>
            <p class="uppercase tracking-[0.3em] text-sm text-slate-500">Quiz Battle</p>
            <h1 class="text-3xl font-bold text-slate-900" id="room-title">{{ room_title }}</h1>
            <p class="text-slate-600 mt-1">M√£ ph√≤ng: <span class="font-mono tracking-widest font-semibold text-slate-900" id="room-code">{{ room_code }}</span></p>
        </div>
        <div class="text-right space-y-3">
            <span class="qb-status-badge" id="room-status" data-status="{{ initial_room.status }}">{{ initial_room.status|upper}}</span>
            <div class="qb-actions">
                <button type="button" class="qb-action-btn" id="copy-room-code">
                    <i class="fa-solid fa-copy"></i> Sao ch√©p m√£
                </button>
                <button type="button" class="qb-action-btn" id="start-room-btn">
                    <i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu tr·∫≠n
                </button>
                <button type="button" class="qb-action-btn qb-action-btn--danger" id="end-room-btn">
                    <i class="fa-solid fa-flag-checkered"></i> K·∫øt th√∫c
                </button>
                <button type="button" class="qb-action-btn qb-action-btn--danger" id="leave-room-btn">
                    <i class="fa-solid fa-person-walking-arrow-right"></i> R·ªùi ph√≤ng
                </button>
            </div>
        </div>
    </div>
    <p class="qb-alert" id="room-alert"></p>
    <div class="qb-room-grid">
        <div class="space-y-4">
            <div class="qb-session-panel">
                <div class="qb-question-card">
                    <p class="text-xs uppercase tracking-[0.35em] text-slate-500">C√¢u h·ªèi hi·ªán t·∫°i</p>
                    <h2 class="text-2xl font-semibold text-slate-900 mt-2" id="question-title">ƒêang t·∫£i d·ªØ li·ªáu...</h2>
                    <p class="text-sm text-slate-600 mt-2" id="question-detail"></p>
                    <p class="text-sm qb-timer mt-2" id="question-timer"></p>
                    <form id="answer-form" class="mt-4 space-y-3">
                        <div class="qb-question-options" id="question-options"></div>
                        <button type="submit" class="cm-action cm-action--primary" id="submit-answer-btn">
                            <i class="fa-solid fa-check"></i> G·ª≠i ƒë√°p √°n
                        </button>
                    </form>
                    <p class="text-sm mt-2 qb-inline-feedback" id="answer-inline-feedback"></p>
                </div>
                <div class="qb-feedback-card" id="answer-feedback-panel" hidden>
                    <div class="qb-feedback-status">
                        <div class="qb-feedback-icon" id="answer-feedback-icon">‚ú®</div>
                        <div>
                            <p class="qb-feedback-title" id="answer-feedback-title">K·∫øt qu·∫£</p>
                            <p class="text-sm text-slate-600" id="answer-feedback-detail"></p>
                        </div>
                    </div>
                    <div class="qb-feedback-meta">
                        <div class="qb-feedback-meta-item">
                            <span>ƒê√°p √°n ƒë√∫ng</span>
                            <strong id="answer-feedback-correct">--</strong>
                        </div>
                        <div class="qb-feedback-meta-item">
                            <span>ƒêi·ªÉm s·ªë</span>
                            <strong id="answer-feedback-score">0</strong>
                        </div>
                    </div>
                    <div class="qb-feedback-explanation" id="answer-feedback-explanation"></div>
                </div>
                <div class="qb-knowledge-panel" id="question-insight-panel" hidden>
                    <div class="qb-knowledge-card">
                        <div class="qb-knowledge-card__header">
                            <div>
                                <p class="qb-knowledge-label">G·ª£i √Ω ch√≠nh th·ª©c</p>
                                <p class="qb-knowledge-title">Gi·∫£i th√≠ch c·ªßa b·ªô ƒë·ªÅ</p>
                            </div>
                            <span class="qb-knowledge-chip text-xs text-slate-400">M·ªü khi b·∫°n ƒë√£ tr·∫£ l·ªùi</span>
                        </div>
                        <div class="qb-knowledge-text" id="question-guidance-content"></div>
                    </div>
                    <div class="qb-knowledge-card">
                        <div class="qb-knowledge-card__header">
                            <div>
                                <p class="qb-knowledge-label">AI Coach</p>
                                <p class="qb-knowledge-title">Gi·∫£i th√≠ch c·ªßa AI</p>
                            </div>
                        </div>
                        <div class="qb-knowledge-text" id="question-ai-content"></div>
                    </div>
                    <div class="qb-note-card" id="question-note-card">
                        <div class="qb-knowledge-card__header">
                            <div>
                                <p class="qb-knowledge-label">Ghi ch√∫ c√° nh√¢n</p>
                                <p class="qb-knowledge-title">Ghi ch√∫ c·ªßa b·∫°n</p>
                            </div>
                            <div class="qb-note-actions">
                                <button type="button" class="qb-note-btn qb-note-btn--ghost" id="question-note-edit"><i class="fa-solid fa-pen"></i> S·ª≠a</button>
                                <a href="{{ url_for('notes.manage_notes') }}" target="_blank" rel="noopener" class="qb-note-link">Qu·∫£n l√Ω ghi ch√∫</a>
                            </div>
                        </div>
                        <div class="qb-note-view" id="question-note-content"></div>
                        <div class="qb-note-editor" id="question-note-editor" hidden>
                            <textarea id="question-note-input" class="qb-note-textarea" rows="3" placeholder="Ghi l·∫°i ƒëi·ªÅu b·∫°n mu·ªën ghi nh·ªõ..."></textarea>
                            <div class="qb-note-editor-actions">
                                <button type="button" class="qb-note-btn qb-note-btn--ghost" id="question-note-cancel">H·ªßy</button>
                                <button type="button" class="qb-note-btn" id="question-note-save">L∆∞u</button>
                            </div>
                        </div>
                    </div>
                    <div class="qb-knowledge-card qb-feedback-lite" id="question-feedback-card" hidden>
                        <div class="qb-knowledge-card__header">
                            <div>
                                <p class="qb-knowledge-label">Ph·∫£n h·ªìi nhanh</p>
                                <p class="qb-knowledge-title">Gi√∫p ch√∫ng t√¥i c·∫£i thi·ªán</p>
                            </div>
                        </div>
                        <textarea class="qb-feedback-textarea" id="question-feedback-input" rows="3" placeholder="C√≥ ƒëi·ªÉm n√†o ch∆∞a h·ª£p l√Ω? Chia s·∫ª v·ªõi ch√∫ng t√¥i..."></textarea>
                        <div class="qb-feedback-actions">
                            <button type="button" class="qb-note-btn" id="question-feedback-submit"><i class="fa-solid fa-paper-plane"></i> G·ª≠i ph·∫£n h·ªìi</button>
                            <p class="qb-feedback-hint">Ph·∫£n h·ªìi c·ªßa b·∫°n ch·ªâ hi·ªÉn th·ªã v·ªõi ƒë·ªôi ng≈© bi√™n so·∫°n.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="qb-session-panel">
                <h3 class="text-lg font-semibold text-slate-900">Di·ªÖn bi·∫øn</h3>
                <p class="text-sm text-slate-600 mt-1" id="round-progress"></p>
                <p class="text-sm text-slate-600" id="room-mode"></p>
            </div>
        </div>
        <div class="space-y-4">
            <div class="qb-session-panel">
                <h3 class="text-lg font-semibold text-slate-900">Ng∆∞·ªùi tham gia</h3>
                <ul class="qb-participant-list mt-3" id="participants-list"></ul>
            </div>
            <div class="qb-session-panel qb-question-stats-card" id="question-stats-card">
                <div class="qb-question-stats-header">
                    <h3 class="text-lg font-semibold text-slate-900">Th·ªëng k√™ c√¢u h·ªèi</h3>
                    <span class="qb-question-stats-chip" id="question-stats-round">Ch∆∞a b·∫Øt ƒë·∫ßu</span>
                </div>
                <div class="qb-question-stats-grid">
                    <div class="qb-question-stat">
                        <p class="qb-question-stat-label">L∆∞·ª£t tr·∫£ l·ªùi</p>
                        <p class="qb-question-stat-value" id="question-stats-total">0</p>
                    </div>
                    <div class="qb-question-stat">
                        <p class="qb-question-stat-label">Tr·∫£ l·ªùi ƒë√∫ng</p>
                        <p class="qb-question-stat-value" id="question-stats-correct">0</p>
                    </div>
                    <div class="qb-question-stat">
                        <p class="qb-question-stat-label">ƒê·ªô ch√≠nh x√°c</p>
                        <p class="qb-question-stat-value qb-question-stat-value--accent" id="question-stats-accuracy">--</p>
                    </div>
                </div>
                <p class="qb-empty-state" id="question-stats-empty">Ch∆∞a c√≥ ai tr·∫£ l·ªùi c√¢u h·ªèi n√†y.</p>
                <div class="qb-option-distribution" id="option-distribution"></div>
            </div>
            <div class="qb-chat-box">
                <div class="qb-chat-messages" id="chat-messages">
                    <p class="text-sm text-slate-500">ƒêang t·∫£i tin nh·∫Øn...</p>
                </div>
                <form class="qb-chat-form" id="chat-form">
                    <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
                    <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function() {
        const initialRoom = {{ initial_room | tojson }};
        const roomCode = {{ room_code | tojson }};
        const currentUserId = {{ current_user_id | tojson }};
        const participantId = {{ participant_id | tojson }};
        const isHost = {{ is_host | tojson }};
        const fetchRoomUrl = {{ url_for('learning.quiz_battle.get_room', room_code=room_code) | tojson }};
        const leaveRoomUrl = {{ url_for('learning.quiz_battle.leave_room', room_code=room_code) | tojson }};
        const startRoomUrl = {{ url_for('learning.quiz_battle.start_room', room_code=room_code) | tojson }};
        const endRoomUrl = {{ url_for('learning.quiz_battle.end_room', room_code=room_code) | tojson }};
        const messagesUrl = {{ url_for('learning.quiz_battle.list_messages', room_code=room_code) | tojson }};
        const postMessageUrl = {{ url_for('learning.quiz_battle.post_message', room_code=room_code) | tojson }};
        const answerUrlTemplate = {{ url_for('learning.quiz_battle.submit_round_answer', room_code=room_code, sequence_number=0) | tojson }};
        const noteSaveUrlTemplate = {{ url_for('notes.save_note', item_id=0) | tojson }};
        const feedbackSubmitUrl = {{ url_for('feedback.submit_feedback') | tojson }};
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

        let roomState = initialRoom || {};
        let lastRenderedRound = roomState?.active_round?.sequence_number || null;
        let roomPollInterval = null;
        let chatPollInterval = null;
        let messagesLoaded = false;
        const statusLabelMap = {
            lobby: 'ƒêang m·ªü s·∫£nh',
            in_progress: 'ƒêang thi ƒë·∫•u',
            awaiting_host: 'Ch·ªù ch·ªß ph√≤ng',
            completed: 'ƒê√£ k·∫øt th√∫c'
        };

        const statusBadge = document.getElementById('room-status');
        const roundProgress = document.getElementById('round-progress');
        const roomMode = document.getElementById('room-mode');
        const questionTitle = document.getElementById('question-title');
        const questionDetail = document.getElementById('question-detail');
        const questionOptions = document.getElementById('question-options');
        const questionTimer = document.getElementById('question-timer');
        const answerInlineFeedback = document.getElementById('answer-inline-feedback');
        const answerFeedbackPanel = document.getElementById('answer-feedback-panel');
        const answerFeedbackTitle = document.getElementById('answer-feedback-title');
        const answerFeedbackDetail = document.getElementById('answer-feedback-detail');
        const answerFeedbackCorrect = document.getElementById('answer-feedback-correct');
        const answerFeedbackScore = document.getElementById('answer-feedback-score');
        const answerFeedbackExplanation = document.getElementById('answer-feedback-explanation');
        const answerFeedbackIcon = document.getElementById('answer-feedback-icon');
        const questionStatsRound = document.getElementById('question-stats-round');
        const questionStatsTotal = document.getElementById('question-stats-total');
        const questionStatsCorrect = document.getElementById('question-stats-correct');
        const questionStatsAccuracy = document.getElementById('question-stats-accuracy');
        const questionStatsEmpty = document.getElementById('question-stats-empty');
        const optionDistribution = document.getElementById('option-distribution');
        const participantsList = document.getElementById('participants-list');
        const alertBox = document.getElementById('room-alert');
        const answerForm = document.getElementById('answer-form');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const startRoomBtn = document.getElementById('start-room-btn');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const endRoomBtn = document.getElementById('end-room-btn');
        const copyCodeBtn = document.getElementById('copy-room-code');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const insightsPanel = document.getElementById('question-insight-panel');
        const guidanceContent = document.getElementById('question-guidance-content');
        const aiContent = document.getElementById('question-ai-content');
        const noteView = document.getElementById('question-note-content');
        const noteEditor = document.getElementById('question-note-editor');
        const noteTextarea = document.getElementById('question-note-input');
        const noteEditBtn = document.getElementById('question-note-edit');
        const noteCancelBtn = document.getElementById('question-note-cancel');
        const noteSaveBtn = document.getElementById('question-note-save');
        const feedbackCard = document.getElementById('question-feedback-card');
        const feedbackInput = document.getElementById('question-feedback-input');
        const feedbackSubmitBtn = document.getElementById('question-feedback-submit');

        let currentQuestionItemId = null;

        function setAlert(message, variant = 'info') {
            if (!alertBox) {
                return;
            }
            alertBox.dataset.variant = variant;
            alertBox.textContent = message || '';
        }

        function setExplanationContent(target, text, emptyMessage = 'Ch∆∞a c√≥ gi·∫£i th√≠ch cho c√¢u h·ªèi n√†y.') {
            if (!target) {
                return;
            }
            target.innerHTML = '';
            const cleaned = typeof text === 'string' ? text.trim() : '';
            if (!cleaned) {
                const emptyParagraph = document.createElement('p');
                emptyParagraph.className = 'text-sm text-slate-500';
                emptyParagraph.textContent = emptyMessage;
                target.appendChild(emptyParagraph);
                return;
            }
            const paragraphs = cleaned.split(/\n\n+/);
            paragraphs.forEach((chunk) => {
                const paragraph = document.createElement('p');
                paragraph.textContent = chunk.replace(/\n+/g, ' ');
                target.appendChild(paragraph);
            });
        }

        function toggleNoteEditor(show) {
            if (!noteEditor || !noteView) {
                return;
            }
            if (show) {
                noteEditor.hidden = false;
                noteView.hidden = true;
                noteTextarea?.focus();
            } else {
                noteEditor.hidden = true;
                noteView.hidden = false;
            }
        }

        function getNoteSaveUrl(itemId) {
            if (!noteSaveUrlTemplate || !itemId) {
                return null;
            }
            return noteSaveUrlTemplate.replace(/0$/, String(itemId));
        }

        function setInsightControlsEnabled(enabled) {
            [noteEditBtn, noteCancelBtn, noteSaveBtn].forEach((button) => {
                if (button) {
                    button.disabled = !enabled;
                }
            });
            if (noteTextarea) {
                noteTextarea.disabled = !enabled;
            }
        }

        function setFeedbackControlsEnabled(enabled) {
            if (feedbackInput) {
                feedbackInput.disabled = !enabled;
                if (!enabled) {
                    feedbackInput.value = '';
                }
            }
            if (feedbackSubmitBtn) {
                feedbackSubmitBtn.disabled = !enabled;
            }
        }

        function updateNoteView(content) {
            if (!noteView) {
                return;
            }
            setExplanationContent(noteView, content || '', 'B·∫°n ch∆∞a c√≥ ghi ch√∫.');
            if (noteTextarea) {
                noteTextarea.value = content || '';
            }
        }

        function toggleInsightPanel(show) {
            if (!insightsPanel) {
                return;
            }
            insightsPanel.hidden = !show;
            if (!show) {
                toggleNoteEditor(false);
                if (feedbackCard) {
                    feedbackCard.hidden = true;
                }
            }
        }

        function updateInsightPanel(question, answeredByMe) {
            if (!question || !answeredByMe) {
                toggleInsightPanel(false);
                return;
            }
            toggleInsightPanel(true);
            if (guidanceContent) {
                setExplanationContent(
                    guidanceContent,
                    question.explanation || '',
                    'C√¢u h·ªèi n√†y ch∆∞a c√≥ g·ª£i √Ω chi ti·∫øt.'
                );
            }
            if (aiContent) {
                setExplanationContent(
                    aiContent,
                    question.ai_explanation || '',
                    'Ch∆∞a c√≥ gi·∫£i th√≠ch t·ª´ AI cho c√¢u h·ªèi n√†y.'
                );
            }
            updateNoteView(question.note_content || '');
            if (feedbackCard) {
                feedbackCard.hidden = false;
            }
        }

        async function saveCurrentNote() {
            if (!currentQuestionItemId || !noteTextarea || !noteSaveBtn) {
                return;
            }
            const content = noteTextarea.value || '';
            const url = getNoteSaveUrl(currentQuestionItemId);
            if (!url) {
                return;
            }
            try {
                noteSaveBtn.disabled = true;
                const response = await postJson(url, { content });
                if (!response?.success) {
                    throw new Error(response?.message || 'Kh√¥ng th·ªÉ l∆∞u ghi ch√∫.');
                }
                if (roomState?.active_round?.question) {
                    roomState.active_round.question.note_content = content;
                }
                updateNoteView(content);
                toggleNoteEditor(false);
                setAlert('ƒê√£ l∆∞u ghi ch√∫ c·ªßa b·∫°n.', 'info');
            } catch (error) {
                setAlert(`Kh√¥ng th·ªÉ l∆∞u ghi ch√∫: ${error.message}`, 'error');
            } finally {
                noteSaveBtn.disabled = false;
            }
        }

        setInsightControlsEnabled(false);
        setFeedbackControlsEnabled(false);

        function formatMode(room) {
            if (!room) {
                return '';
            }
            if (room.mode === 'TIMED' && room.time_per_question_seconds) {
                return `Ch·∫ø ƒë·ªô gi·ªõi h·∫°n th·ªùi gian ¬∑ ${room.time_per_question_seconds}s m·ªói c√¢u`;
            }
            return 'Ch·∫ø ƒë·ªô test ch·∫≠m ¬∑ chuy·ªÉn c√¢u khi m·ªçi ng∆∞·ªùi tr·∫£ l·ªùi xong';
        }

        function formatStatus(status) {
            return statusLabelMap[status] || status;
        }

        function renderAnswerFeedbackPanel(result) {
            if (!answerFeedbackPanel) {
                return;
            }
            if (!result) {
                answerFeedbackPanel.hidden = true;
                return;
            }
            const isCorrect = Boolean(result.is_correct);
            answerFeedbackPanel.hidden = false;
            answerFeedbackPanel.dataset.state = isCorrect ? 'correct' : 'incorrect';
            if (answerFeedbackIcon) {
                answerFeedbackIcon.textContent = isCorrect ? 'üéâ' : 'üí°';
            }
            if (answerFeedbackTitle) {
                answerFeedbackTitle.textContent = isCorrect ? 'Tuy·ªát v·ªùi!' : 'Ch∆∞a ch√≠nh x√°c';
            }
            if (answerFeedbackDetail) {
                answerFeedbackDetail.textContent = isCorrect
                    ? `B·∫°n ƒë∆∞·ª£c +${result.score_delta} ƒëi·ªÉm cho c√¢u n√†y.`
                    : 'H√£y xem l·∫°i ƒë√°p √°n ƒë√∫ng v√† t·ª± tin ·ªü c√¢u ti·∫øp theo.';
            }
            if (answerFeedbackCorrect) {
                answerFeedbackCorrect.textContent = result.correct_option || '--';
            }
            if (answerFeedbackScore) {
                const delta = Number(result.score_delta) || 0;
                answerFeedbackScore.textContent = delta >= 0 ? `+${delta}` : `${delta}`;
            }
            setExplanationContent(answerFeedbackExplanation, result.explanation || '');
        }

        function renderQuestionStats(round) {
            if (!questionStatsRound) {
                return;
            }
            if (!round || !round.question) {
                questionStatsRound.textContent = 'Ch∆∞a b·∫Øt ƒë·∫ßu';
                if (questionStatsTotal) {
                    questionStatsTotal.textContent = '0';
                }
                if (questionStatsCorrect) {
                    questionStatsCorrect.textContent = '0';
                }
                if (questionStatsAccuracy) {
                    questionStatsAccuracy.textContent = '--';
                }
                if (questionStatsEmpty) {
                    questionStatsEmpty.hidden = false;
                    questionStatsEmpty.textContent = 'Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c m·ªü.';
                }
                if (optionDistribution) {
                    optionDistribution.innerHTML = '';
                }
                return;
            }
            questionStatsRound.textContent = `C√¢u #${round.sequence_number}`;
            const answers = round.answers || [];
            const total = answers.length;
            const correct = answers.filter((answer) => answer.is_correct).length;
            if (questionStatsTotal) {
                questionStatsTotal.textContent = `${total}`;
            }
            if (questionStatsCorrect) {
                questionStatsCorrect.textContent = `${correct}`;
            }
            if (questionStatsAccuracy) {
                questionStatsAccuracy.textContent = total ? `${Math.round((correct / total) * 100)}%` : '--';
            }
            if (questionStatsEmpty) {
                questionStatsEmpty.hidden = total > 0;
                if (!total) {
                    questionStatsEmpty.textContent = 'Ch∆∞a c√≥ ai tr·∫£ l·ªùi c√¢u h·ªèi n√†y.';
                }
            }
            if (!optionDistribution) {
                return;
            }
            optionDistribution.innerHTML = '';
            const options = round.question.options || {};
            const optionKeys = Object.keys(options);
            if (!optionKeys.length || !total) {
                return;
            }
            const optionCounts = answers.reduce((accumulator, answer) => {
                const key = answer.selected_option;
                if (key) {
                    accumulator[key] = (accumulator[key] || 0) + 1;
                }
                return accumulator;
            }, {});
            const myAnswer = answers.find((answer) => answer.participant_id === participantId);
            const correctOption = myAnswer?.correct_option;
            optionKeys.forEach((key) => {
                const count = optionCounts[key] || 0;
                const percent = total ? Math.round((count / total) * 100) : 0;
                const row = document.createElement('div');
                row.className = 'qb-option-distribution-row';
                if (correctOption && key === correctOption) {
                    row.dataset.correct = 'true';
                }
                const label = document.createElement('div');
                label.className = 'qb-option-distribution-label';
                const labelTitle = document.createElement('span');
                labelTitle.textContent = key;
                const labelDesc = document.createElement('small');
                labelDesc.textContent = options[key] || '';
                label.appendChild(labelTitle);
                label.appendChild(labelDesc);
                const track = document.createElement('div');
                track.className = 'qb-option-distribution-track';
                const bar = document.createElement('span');
                bar.className = 'qb-option-distribution-bar';
                bar.style.width = `${percent}%`;
                track.appendChild(bar);
                const meta = document.createElement('div');
                meta.className = 'qb-option-distribution-meta';
                meta.textContent = `${count} (${percent}%)`;
                row.appendChild(label);
                row.appendChild(track);
                row.appendChild(meta);
                optionDistribution.appendChild(row);
            });
        }

        function renderParticipants(participants) {
            if (!participantsList) {
                return;
            }
            participantsList.innerHTML = '';
            if (!participants?.length) {
                participantsList.innerHTML = '<li class="text-sm text-slate-500">Ch∆∞a c√≥ ng∆∞·ªùi tham gia.</li>';
                return;
            }
            for (const participant of participants) {
                const item = document.createElement('li');
                item.className = 'qb-participant-item';
                const nameSpan = document.createElement('span');
                const nameText = participant.username || `User #${participant.user_id}`;
                const roleText = participant.is_host ? ' ¬∑ Ch·ªß ph√≤ng' : '';
                const statusText = participant.status === 'active' ? '' : ` (${participant.status})`;
                nameSpan.textContent = `${nameText}${roleText}${statusText}`;
                const scoreSpan = document.createElement('span');
                scoreSpan.className = 'font-semibold';
                scoreSpan.textContent = `${participant.session_score || 0}ƒë`;
                if (participant.user_id === currentUserId) {
                    nameSpan.style.color = '#4f46e5';
                }
                item.appendChild(nameSpan);
                item.appendChild(scoreSpan);
                participantsList.appendChild(item);
            }
        }

        function renderQuestion(round) {
            if (!round || !round.question) {
                questionTitle.textContent = 'Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c m·ªü.';
                questionDetail.textContent = 'ƒê·ª£i ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu ho·∫∑c v√≤ng k·∫ø ti·∫øp ƒë∆∞·ª£c t·∫°o.';
                questionOptions.innerHTML = '';
                submitAnswerBtn.disabled = true;
                questionTimer.textContent = '';
                if (answerInlineFeedback) {
                    answerInlineFeedback.textContent = '';
                }
                renderAnswerFeedbackPanel(null);
                renderQuestionStats(null);
                lastRenderedRound = null;
                currentQuestionItemId = null;
                setInsightControlsEnabled(false);
                setFeedbackControlsEnabled(false);
                updateInsightPanel(null, false);
                return;
            }
            const question = round.question;
            questionTitle.textContent = question.question || 'C√¢u h·ªèi ch∆∞a c√≥ n·ªôi dung';
            questionDetail.textContent = question.passage_text || '';
            questionOptions.innerHTML = '';
            const answeredByMe = round.answers?.some((answer) => answer.participant_id === participantId);
            const canAnswer = Boolean(participantId);
            const isNewRound = round.sequence_number !== lastRenderedRound;
            const options = question.options || {};
            const optionKeys = Object.keys(options);
            optionKeys.forEach((optionKey) => {
                const wrapper = document.createElement('label');
                wrapper.className = 'qb-option';
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'selected_option';
                input.value = optionKey;
                const textWrap = document.createElement('div');
                const title = document.createElement('p');
                title.className = 'text-sm font-semibold text-slate-900';
                title.textContent = optionKey;
                const description = document.createElement('p');
                description.className = 'text-sm text-slate-600';
                description.textContent = options[optionKey] || 'Kh√¥ng c√≥ n·ªôi dung';
                textWrap.appendChild(title);
                textWrap.appendChild(description);
                wrapper.appendChild(input);
                wrapper.appendChild(textWrap);
                questionOptions.appendChild(wrapper);
            });
            if (!optionKeys.length) {
                const emptyState = document.createElement('p');
                emptyState.className = 'text-sm text-slate-500';
                emptyState.textContent = 'C√¢u h·ªèi n√†y ch∆∞a c√≥ ƒë√°p √°n l·ª±a ch·ªçn.';
                questionOptions.appendChild(emptyState);
            }
            submitAnswerBtn.disabled = answeredByMe || !canAnswer;
            if (round.time_remaining_seconds != null) {
                questionTimer.textContent = `Th·ªùi gian c√≤n l·∫°i: ${round.time_remaining_seconds}s`;
            } else {
                questionTimer.textContent = '';
            }
            const questionId = Number(question.item_id);
            currentQuestionItemId = Number.isFinite(questionId) && questionId > 0 ? questionId : null;
            const canUseInsights = Boolean(answeredByMe && currentQuestionItemId);
            setInsightControlsEnabled(canUseInsights);
            setFeedbackControlsEnabled(canUseInsights);
            if (!canUseInsights) {
                toggleInsightPanel(false);
            }
            updateInsightPanel(question, answeredByMe);
            if (answerInlineFeedback) {
                if (answeredByMe) {
                    answerInlineFeedback.textContent = 'B·∫°n ƒë√£ g·ª≠i ƒë√°p √°n cho c√¢u h·ªèi n√†y.';
                } else if (!canAnswer) {
                    answerInlineFeedback.textContent = 'B·∫°n kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y.';
                } else {
                    answerInlineFeedback.textContent = '';
                }
            }
            if (isNewRound) {
                if (answerInlineFeedback) {
                    answerInlineFeedback.textContent = '';
                }
                renderAnswerFeedbackPanel(null);
            }
            lastRenderedRound = round.sequence_number;
            renderQuestionStats(round);
        }

        function updateRoundMeta(room) {
            if (!room) {
                return;
            }
            const current = room.current_round_number || 0;
            const total = room.question_total || 0;
            roundProgress.textContent = `Ti·∫øn ƒë·ªô: ${current}/${total} c√¢u h·ªèi`;
            roomMode.textContent = formatMode(room);
        }

        function updateStatusBadge(status) {
            if (!statusBadge) {
                return;
            }
            statusBadge.dataset.status = status;
            statusBadge.textContent = formatStatus(status);
        }

        function getAnswerUrl(sequenceNumber) {
            return answerUrlTemplate.replace('/0/', `/${sequenceNumber}/`);
        }

        async function postJson(url, payload) {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            const response = await fetch(url, {
                method: 'POST',
                headers,
                body: payload ? JSON.stringify(payload) : '{}'
            });
            if (!response.ok) {
                throw new Error(await response.text());
            }
            return response.json();
        }

        async function fetchRoomState() {
            try {
                const response = await fetch(fetchRoomUrl);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                roomState = data.room;
                hydrateUi();
            } catch (error) {
                setAlert(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ph√≤ng: ${error.message}`, 'error');
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch(messagesUrl);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                renderMessages(data.messages || []);
            } catch (error) {
                if (!messagesLoaded) {
                    chatMessages.innerHTML = '';
                    const errorMsg = document.createElement('p');
                    errorMsg.className = 'text-sm text-rose-500';
                    errorMsg.textContent = error.message;
                    chatMessages.appendChild(errorMsg);
                }
            }
        }

        function renderMessages(messages) {
            if (!chatMessages) {
                return;
            }
            messagesLoaded = true;
            chatMessages.innerHTML = '';
            if (!messages.length) {
                chatMessages.innerHTML = '<p class="text-sm text-slate-500">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</p>';
                return;
            }
            for (const message of messages) {
                const bubble = document.createElement('div');
                bubble.className = 'qb-chat-message';
                const timestamp = message.created_at ? new Date(message.created_at).toLocaleTimeString() : '';
                const meta = document.createElement('p');
                const strong = document.createElement('strong');
                strong.textContent = message.username || '·∫®n danh';
                const time = document.createElement('span');
                time.className = 'text-xs text-slate-500';
                time.textContent = timestamp;
                meta.appendChild(strong);
                if (timestamp) {
                    meta.append(' ');
                    meta.appendChild(time);
                }
                const body = document.createElement('p');
                body.className = 'text-sm text-slate-700';
                body.textContent = message.content;
                bubble.appendChild(meta);
                bubble.appendChild(body);
                chatMessages.appendChild(bubble);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hydrateUi() {
            if (!roomState) {
                return;
            }
            updateStatusBadge(roomState.status);
            renderParticipants(roomState.participants);
            renderQuestion(roomState.active_round);
            updateRoundMeta(roomState);
            if (roomState.status === 'completed') {
                submitAnswerBtn.disabled = true;
            }
            setAlert('');
            updateControlStates();
        }

        function updateControlStates() {
            const status = roomState?.status;
            const canStart = isHost && status === 'lobby';
            const canEnd = isHost && status !== 'completed';
            startRoomBtn.disabled = !canStart;
            endRoomBtn.disabled = !canEnd;
            if (status === 'completed') {
                leaveRoomBtn.textContent = 'Tho√°t kh·ªèi ph√≤ng';
            }
        }

        noteEditBtn?.addEventListener('click', () => {
            if (!currentQuestionItemId) {
                return;
            }
            toggleNoteEditor(true);
        });

        noteCancelBtn?.addEventListener('click', () => {
            if (!noteTextarea) {
                toggleNoteEditor(false);
                return;
            }
            const content = roomState?.active_round?.question?.note_content || '';
            noteTextarea.value = content;
            toggleNoteEditor(false);
        });

        noteSaveBtn?.addEventListener('click', saveCurrentNote);

        feedbackSubmitBtn?.addEventListener('click', async () => {
            if (!currentQuestionItemId || !feedbackInput) {
                return;
            }
            const feedbackText = feedbackInput.value.trim();
            if (!feedbackText) {
                setAlert('Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi tr∆∞·ªõc khi g·ª≠i.', 'error');
                return;
            }
            try {
                feedbackSubmitBtn.disabled = true;
                const response = await postJson(feedbackSubmitUrl, {
                    item_id: currentQuestionItemId,
                    feedback_text: feedbackText,
                });
                if (!response?.success) {
                    throw new Error(response?.message || 'Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi.');
                }
                feedbackInput.value = '';
                setAlert('C·∫£m ∆°n b·∫°n! Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.', 'info');
            } catch (error) {
                setAlert(`Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi: ${error.message}`, 'error');
            } finally {
                feedbackSubmitBtn.disabled = false;
            }
        });

        answerForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!roomState?.active_round) {
                return;
            }
            const formData = new FormData(answerForm);
            const selected = formData.get('selected_option');
            if (!selected) {
                setAlert('Vui l√≤ng ch·ªçn ƒë√°p √°n tr∆∞·ªõc khi g·ª≠i.', 'error');
                return;
            }
            try {
                submitAnswerBtn.disabled = true;
                const answerUrl = getAnswerUrl(roomState.active_round.sequence_number);
                const data = await postJson(answerUrl, { selected_option: selected });
                roomState = data.room;
                hydrateUi();
                renderAnswerFeedbackPanel(data.answer);
            } catch (error) {
                submitAnswerBtn.disabled = false;
                setAlert(`Kh√¥ng th·ªÉ g·ª≠i ƒë√°p √°n: ${error.message}`, 'error');
            }
        });

        startRoomBtn?.addEventListener('click', async () => {
            if (!isHost) {
                return;
            }
            try {
                startRoomBtn.disabled = true;
                const data = await postJson(startRoomUrl);
                roomState = data.room;
                hydrateUi();
                setAlert('‚úÖ ƒê√£ kh·ªüi ƒë·ªông tr·∫≠n ƒë·∫•u.');
            } catch (error) {
                startRoomBtn.disabled = false;
                setAlert(`Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu: ${error.message}`, 'error');
            }
        });

        endRoomBtn?.addEventListener('click', async () => {
            if (!isHost) {
                return;
            }
            if (!confirm('K·∫øt th√∫c tr·∫≠n ƒë·∫•u ngay b√¢y gi·ªù?')) {
                return;
            }
            try {
                endRoomBtn.disabled = true;
                const data = await postJson(endRoomUrl);
                roomState = data.room;
                hydrateUi();
                setAlert('Tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c.');
            } catch (error) {
                endRoomBtn.disabled = false;
                setAlert(`Kh√¥ng th·ªÉ k·∫øt th√∫c: ${error.message}`, 'error');
            }
        });

        leaveRoomBtn?.addEventListener('click', async () => {
            if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën r·ªùi ph√≤ng?')) {
                return;
            }
            try {
                await postJson(leaveRoomUrl);
                setAlert('B·∫°n ƒë√£ r·ªùi ph√≤ng. H√£y ƒë√≥ng tab n√†y.', 'info');
            } catch (error) {
                setAlert(`Kh√¥ng th·ªÉ r·ªùi ph√≤ng: ${error.message}`, 'error');
            }
        });

        copyCodeBtn?.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(roomCode);
                setAlert('ƒê√£ sao ch√©p m√£ ph√≤ng.', 'info');
            } catch (_) {
                setAlert('Kh√¥ng th·ªÉ sao ch√©p m√£.', 'error');
            }
        });

        chatForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            const content = chatInput.value.trim();
            if (!content) {
                return;
            }
            try {
                await postJson(postMessageUrl, { content });
                chatInput.value = '';
                loadMessages();
            } catch (error) {
                setAlert(`Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn: ${error.message}`, 'error');
            }
        });

        hydrateUi();
        loadMessages();
        roomPollInterval = setInterval(fetchRoomState, 5000);
        chatPollInterval = setInterval(loadMessages, 7000);

        window.addEventListener('beforeunload', () => {
            if (roomPollInterval) {
                clearInterval(roomPollInterval);
            }
            if (chatPollInterval) {
                clearInterval(chatPollInterval);
            }
        });
    })();
</script>
{% endblock %}
