<!-- mindstack_app/modules/learning/course_learning/templates/course_session.html -->
<!-- Phiên bản: 2.1 -->
<!-- Mục đích: Sửa lỗi jinja2.exceptions.UndefinedError: 'lessonId' is undefined. -->
<!--           Lỗi xảy ra do truyền một biến JavaScript vào hàm url_for của Jinja2. -->

{% extends "base.html" %}

{% block title %}{{ lesson.content.get('title', 'Bài học') }}{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .lesson-content-wrapper {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* CSS để định dạng nội dung HTML từ BBCode */
        .parsed-content b, .parsed-content strong {
            font-weight: 600;
        }
        .parsed-content i, .parsed-content em {
            font-style: italic;
        }
        .parsed-content u {
            text-decoration: underline;
        }
        .parsed-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .parsed-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .parsed-content li {
            margin-bottom: 0.25rem;
        }
        .parsed-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .parsed-content pre, .parsed-content code {
            background-color: #f3f4f6;
            border-radius: 0.25rem;
            padding: 0.75rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <a href="{{ url_for('learning.course_learning.course_learning_dashboard') }}" class="text-blue-600 hover:text-blue-800 mb-6 inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Quay lại danh sách khóa học
        </a>

        <div class="lesson-content-wrapper">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">{{ lesson.content.get('title', 'Không có tiêu đề') }}</h1>
            <p class="text-sm text-gray-500 mb-6">Trong khóa học: {{ course.title }}</p>

            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Nội dung bài học:</h2>
            
            <div class="prose max-w-none parsed-content">
                {{ bbcode_to_html(lesson.content.get('bbcode_content', '')) | safe }}
            </div>

            <!-- Vùng đánh giá tiến độ -->
            <div class="mt-8 border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Đánh giá tiến độ của bạn</h3>
                <div class="flex items-center space-x-4">
                    <input id="progress-slider" type="range" min="0" max="100" step="25" value="{{ current_percentage }}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="progress-value" class="font-bold text-blue-600 text-lg w-12 text-center">{{ current_percentage }}%</span>
                </div>
                <div class="flex justify-end mt-4">
                    <button id="update-progress-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition duration-300">
                        Cập nhật tiến độ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const slider = document.getElementById('progress-slider');
        const progressValue = document.getElementById('progress-value');
        const updateBtn = document.getElementById('update-progress-btn');
        
        if (slider && progressValue) {
            slider.addEventListener('input', function() {
                progressValue.textContent = this.value + '%';
            });
        }

        if (updateBtn) {
            updateBtn.addEventListener('click', function() {
                const percentage = slider.value;
                updateBtn.textContent = 'Đang cập nhật...';
                updateBtn.disabled = true;

                // SỬA LỖI: Truyền trực tiếp biến lesson.item_id của Jinja2 vào url_for
                // thay vì sử dụng biến JavaScript 'lessonId'.
                fetch(`{{ url_for('learning.course_learning.update_lesson_progress', lesson_id=lesson.item_id) }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ percentage: percentage })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showFlashMessage('Đã cập nhật tiến độ thành công!', 'success');
                    } else {
                        showFlashMessage(data.message || 'Có lỗi xảy ra.', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    showFlashMessage('Lỗi kết nối. Không thể cập nhật.', 'danger');
                })
                .finally(() => {
                    updateBtn.textContent = 'Cập nhật tiến độ';
                    updateBtn.disabled = false;
                });
            });
        }
    });
</script>
{% endblock %}

