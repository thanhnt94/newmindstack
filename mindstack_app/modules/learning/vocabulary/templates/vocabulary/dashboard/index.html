{# Vocabulary Learning Hub - Main Dashboard v1.0 #}
{% extends "base.html" %}
{% block title %}Học từ vựng - MindStack{% endblock %}
{% block head %}
{{ super() }}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
    :root {
        --vocab-primary: #6366f1;
        --vocab-primary-light: #818cf8;
        --vocab-primary-dark: #4f46e5;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
    }

    /* Mobile full-screen steps */
    @media (max-width: 1023px) {

        body>header,
        body>footer {
            display: none !important;
        }

        body>main {
            padding: 0 !important;
            margin: 0 !important;
            max-width: none !important;
        }

        .vocab-step {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: #f8fafc;
            flex-direction: column;
            overflow-y: auto;
        }

        .vocab-step.active {
            display: flex;
        }
    }

    @media (min-width: 1024px) {
        .vocab-step {
            display: block !important;
            position: static !important;
        }

        #step-detail,
        #step-modes,
        #step-flashcard-options,
        #step-mcq-options {
            display: none !important;
        }

        #step-detail.active,
        #step-modes.active,
        #step-flashcard-options.active,
        #step-mcq-options.active {
            display: block !important;
        }
    }

    /* Header */
    .vocab-header {
        background: white;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-shrink: 0;
    }

    .vocab-back-btn {
        width: 36px;
        height: 36px;
        border-radius: 0.75rem;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
    }

    .vocab-back-btn:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    .vocab-title {
        font-weight: 700;
        color: #1e293b;
        font-size: 1.125rem;
    }

    /* Search */
    .vocab-search-wrap {
        padding: 0.75rem 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .vocab-search {
        display: flex;
        align-items: center;
        background: #f1f5f9;
        border-radius: 0.75rem;
        padding: 0.5rem 0.75rem;
        gap: 0.5rem;
    }

    .vocab-search i {
        color: #94a3b8;
    }

    .vocab-search input {
        border: none;
        background: transparent;
        flex: 1;
        font-size: 0.875rem;
        outline: none;
    }

    /* Category Tabs */
    .vocab-tabs {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .vocab-tab {
        flex: 1;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: #64748b;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .vocab-tab.active {
        background: var(--vocab-primary);
        color: white;
    }

    /* Grid */
    .vocab-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        padding: 1rem;
    }

    @media (min-width: 640px) {
        .vocab-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .vocab-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
    }

    /* Set Card - Premium App Style */
    .vocab-set-card {
        background: white;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .vocab-set-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px rgba(99, 102, 241, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: rgba(99, 102, 241, 0.3);
    }

    .vocab-set-card:active {
        transform: translateY(-2px) scale(0.98);
    }

    .vocab-set-cover {
        height: 110px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        background-size: cover;
        background-position: center;
        position: relative;
        overflow: hidden;
    }

    .vocab-set-cover::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, transparent 50%, rgba(0, 0, 0, 0.1) 100%);
    }

    .vocab-set-cover i {
        font-size: 2.5rem;
        color: rgba(255, 255, 255, 0.85);
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        position: relative;
        z-index: 1;
    }

    .vocab-set-info {
        padding: 0.875rem;
    }

    .vocab-set-title {
        font-weight: 700;
        color: #1e293b;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.3;
    }

    .vocab-set-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #64748b;
    }

    .vocab-set-count {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        color: #6366f1;
        background: #eef2ff;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
    }

    .vocab-set-count i {
        font-size: 0.65rem;
    }

    .vocab-set-author {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        color: #64748b;
        font-size: 0.7rem;
    }

    .vocab-set-avatar {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.55rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    /* Detail View */
    .vocab-detail-hero {
        height: 200px;
        background: linear-gradient(135deg, #c7d2fe, #ddd6fe);
        display: flex;
        align-items: center;
        justify-content: center;
        background-size: cover;
        background-position: center;
        position: relative;
    }

    .vocab-detail-hero i {
        font-size: 4rem;
        color: rgba(99, 102, 241, 0.4);
    }

    .vocab-detail-content {
        padding: 1.25rem;
    }

    .vocab-detail-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }

    .vocab-detail-desc {
        color: #64748b;
        font-size: 0.875rem;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .vocab-detail-creator {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
    }

    .vocab-creator-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--vocab-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .vocab-creator-name {
        font-weight: 600;
        color: #1e293b;
    }

    .vocab-creator-role {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .vocab-detail-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .vocab-stat {
        flex: 1;
        text-align: center;
        padding: 0.75rem;
        background: #f1f5f9;
        border-radius: 0.75rem;
    }

    .vocab-stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--vocab-primary);
    }

    .vocab-stat-label {
        font-size: 0.7rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    /* Fixed Footer */
    .vocab-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        z-index: 200;
    }

    .vocab-start-btn {
        width: 100%;
        padding: 1rem;
        background: var(--vocab-primary);
        color: white;
        font-weight: 700;
        font-size: 1rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .vocab-start-btn:hover {
        background: var(--vocab-primary-dark);
    }

    /* Mode Cards */
    .vocab-mode-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        margin-bottom: 0.4rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .vocab-mode-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .vocab-mode-icon {
        width: 50px;
        height: 50px;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vocab-mode-icon i {
        font-size: 1.25rem;
        color: white;
    }

    .vocab-mode-icon.purple {
        background: linear-gradient(135deg, #7c3aed, #a78bfa);
    }

    .vocab-mode-icon.blue {
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
    }

    .vocab-mode-icon.green {
        background: linear-gradient(135deg, #10b981, #34d399);
    }

    .vocab-mode-icon.yellow {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
    }

    .vocab-mode-info {
        flex: 1;
    }

    .vocab-mode-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }

    .vocab-mode-desc {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    /* Scroll area */
    .vocab-scroll {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 100px;
    }

    /* Loading */
    .vocab-loading {
        text-align: center;
        padding: 3rem;
        color: #94a3b8;
    }

    .vocab-loading i {
        font-size: 2rem;
        color: var(--vocab-primary);
    }

    /* Empty */
    .vocab-empty {
        text-align: center;
        padding: 3rem;
        color: #94a3b8;
    }

    .vocab-empty i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #cbd5e1;
    }

    /* Desktop layout */
    @media (min-width: 1024px) {
        .vocab-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .vocab-desktop-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .vocab-footer {
            position: static;
            box-shadow: none;
            border: none;
            padding: 0;
            margin-top: 1rem;
        }

        .vocab-detail-hero {
            height: 250px;
            border-radius: 1rem;
        }
    }

    /* Step Header (new design) */
    .step-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .step-back-btn,
    .step-home-btn {
        width: 36px;
        height: 36px;
        border-radius: 0.75rem;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .step-back-btn:hover,
    .step-home-btn:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    /* Breadcrumb - larger text as requested */
    .step-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .breadcrumb-item {
        color: #94a3b8;
    }

    .breadcrumb-item.active {
        color: #3b82f6;
    }

    .breadcrumb-sep {
        color: #cbd5e1;
        font-size: 0.65rem;
    }

    /* Simplified Step Header - Centered Breadcrumb */
    .step-header-simple {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-breadcrumb-centered {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Bottom Navigation Bar */
    .step-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0));
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
        z-index: 50;
        gap: 0.75rem;
    }

    .step-nav-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        flex: 1;
    }

    .step-nav-back {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }

    .step-nav-back:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    .step-nav-home {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .step-nav-home:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        color: white;
    }

    /* Scroll area with bottom nav padding */
    .step-scroll-with-nav {
        padding: 0.75rem !important;
        padding-bottom: 100px !important;
    }

    /* Left-Aligned Step Header - 2 Rows */
    .step-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-header-content {
        flex: 1;
    }

    .step-breadcrumb-left {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #94a3b8;
        margin-bottom: 0.25rem;
    }

    .step-breadcrumb-left i {
        font-size: 0.6rem;
        color: #cbd5e1;
    }

    .step-breadcrumb-left .active {
        color: #8b5cf6;
    }

    .step-header-title {
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    /* Selected Set Display */
    .step-set-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-set-label {
        font-size: 0.8rem;
        color: #64748b;
    }

    .step-set-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #334155;
    }

    .step-set-chip i {
        color: #8b5cf6;
        font-size: 0.7rem;
    }

    /* Selectable Mode Cards */
    .mode-select-card {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 1rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.75rem;
    }

    .mode-select-card:hover {
        border-color: #c4b5fd;
        background: #faf5ff;
    }

    .mode-select-card.selected {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #faf5ff, #ede9fe);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
    }

    .mode-select-icon {
        width: 44px;
        height: 44px;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.125rem;
        flex-shrink: 0;
    }

    .mode-select-icon.blue {
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
    }

    .mode-select-icon.green {
        background: linear-gradient(135deg, #10b981, #34d399);
    }

    .mode-select-icon.yellow {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
    }

    .mode-select-icon.purple {
        background: linear-gradient(135deg, #8b5cf6, #a78bfa);
    }

    .mode-select-info {
        flex: 1;
    }

    .mode-select-name {
        font-size: 0.95rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.125rem;
    }

    .mode-select-desc {
        font-size: 0.75rem;
        color: #64748b;
    }

    .mode-select-check {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.7rem;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .mode-select-check i {
        display: none;
    }

    .mode-select-card.selected .mode-select-check {
        border-color: #8b5cf6;
        background: #8b5cf6;
    }

    .mode-select-card.selected .mode-select-check i {
        display: block;
    }

    /* Bottom Bar with Single Button */
    .step-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0));
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.06);
        z-index: 50;
    }

    .step-continue-btn {
        width: 100%;
        padding: 1rem;
        border-radius: 1rem;
        font-size: 1rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .step-continue-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }

    .step-continue-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Title Section */
    .step-title-section {
        padding: 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 0.75rem 0;
    }

    .selected-set-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .selected-set-label {
        font-size: 0.875rem;
        color: #64748b;
    }

    .selected-set-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: #eff6ff;
        color: #2563eb;
        font-size: 0.8rem;
        font-weight: 600;
        border-radius: 9999px;
        border: 1px solid #bfdbfe;
    }

    .selected-set-chip i {
        font-size: 0.7rem;
    }

    /* Step Content Container */
    .step-content-container {
        min-height: 100%;
        display: flex;
        flex-direction: column;
    }
</style>
{% endblock %}

{% block content %}
<!-- STEP 1: Set Browser -->
<div id="step-browser" class="vocab-step active">
    <div class="vocab-header">
        <a href="{{ url_for('learning.learning_dashboard') }}" class="vocab-back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <span class="vocab-title">Học từ vựng</span>
    </div>

    <div class="vocab-search-wrap">
        <div class="vocab-search">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Tìm kiếm bộ thẻ...">
        </div>
    </div>

    <div class="vocab-tabs">
        <div class="vocab-tab active" data-category="my">Của tôi</div>
        <div class="vocab-tab" data-category="learning">Đang học</div>
        <div class="vocab-tab" data-category="explore">Khám phá</div>
    </div>

    <div class="vocab-scroll">
        <div id="sets-grid" class="vocab-grid">
            <div class="vocab-loading"><i class="fas fa-spinner fa-spin"></i>
                <p>Đang tải...</p>
            </div>
        </div>
    </div>
</div>

<!-- STEP 2: Set Detail -->
<div id="step-detail" class="vocab-step">
    <div class="vocab-header lg:hidden">
        <button class="vocab-back-btn js-back-to-browser"><i class="fas fa-arrow-left"></i></button>
        <span class="vocab-title js-detail-title">Chi tiết bộ thẻ</span>
    </div>

    <div class="vocab-scroll">
        <div class="vocab-detail-hero js-detail-cover">
            <i class="fas fa-book-open"></i>
        </div>

        <div class="vocab-detail-content">
            <h1 class="vocab-detail-title js-detail-title-full">Tên bộ thẻ</h1>
            <p class="vocab-detail-desc js-detail-desc">Mô tả bộ thẻ...</p>

            <div class="vocab-detail-creator">
                <div class="vocab-creator-avatar js-creator-avatar">A</div>
                <div>
                    <div class="vocab-creator-name js-creator-name">Admin</div>
                    <div class="vocab-creator-role">Người tạo</div>
                </div>
            </div>

            <div class="vocab-detail-stats">
                <div class="vocab-stat">
                    <div class="vocab-stat-value js-card-count">0</div>
                    <div class="vocab-stat-label">Flashcard</div>
                </div>
                <div class="vocab-stat">
                    <div class="vocab-stat-value js-memrise-count">0</div>
                    <div class="vocab-stat-label">Memrise</div>
                </div>
            </div>
        </div>
    </div>

    <div class="vocab-footer">
        <button class="vocab-start-btn js-start-learning">
            <i class="fas fa-play-circle"></i> Bắt đầu học
        </button>
    </div>
</div>

<!-- STEP 3: Mode Selector - Select Then Submit -->
<div id="step-modes" class="vocab-step">
    {# Header - 2 Rows Like MCQ #}
    <div class="step-header-left">
        <a href="javascript:void(0)" class="step-back-btn js-back-to-detail">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="step-header-content">
            {# Row 1: Breadcrumb #}
            <div class="step-breadcrumb-left">
                <span>TỪ VỰNG</span>
                <i class="fas fa-chevron-right"></i>
                <span class="active">BƯỚC 1</span>
            </div>
            {# Row 2: Title #}
            <h1 class="step-header-title">Chọn chế độ học</h1>
        </div>
    </div>

    {# Selected Set Display #}
    <div class="step-set-display">
        <span class="step-set-label">Bộ đã chọn:</span>
        <span class="step-set-chip js-selected-set-chip">
            <i class="fas fa-layer-group"></i>
            <span class="js-selected-set-name">Chưa chọn</span>
        </span>
    </div>

    {# Mode Selection Cards #}
    <div class="vocab-scroll step-scroll-with-nav" style="padding: 1rem;">
        <div class="mode-select-card js-mode-select" data-mode="flashcard">
            <div class="mode-select-icon blue"><i class="fas fa-clone"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Flashcard</div>
                <div class="mode-select-desc">Lật thẻ ôn tập truyền thống</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="mcq">
            <div class="mode-select-icon green"><i class="fas fa-list-ul"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Trắc nghiệm</div>
                <div class="mode-select-desc">Chọn đáp án đúng từ 4 lựa chọn</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="listening">
            <div class="mode-select-icon" style="background: linear-gradient(135deg, #6366f1, #818cf8);"><i
                    class="fas fa-headphones-alt"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Luyện nghe (Dictation)</div>
                <div class="mode-select-desc">Nghe & chép chính tả</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="typing">
            <div class="mode-select-icon yellow"><i class="fas fa-keyboard"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Gõ đáp án</div>
                <div class="mode-select-desc">Gõ câu trả lời chính xác</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="matching">
            <div class="mode-select-icon" style="background: linear-gradient(135deg, #ec4899, #f472b6);"><i
                    class="fas fa-puzzle-piece"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Ghép đôi</div>
                <div class="mode-select-desc">Kéo thả ghép từ với nghĩa</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="speed">
            <div class="mode-select-icon" style="background: linear-gradient(135deg, #f97316, #fb923c);"><i
                    class="fas fa-bolt"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Ôn nhanh</div>
                <div class="mode-select-desc">Biết / Không biết trong 3 giây</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>
    </div>

    {# Bottom Bar - Single Continue Button #}
    <div class="step-bottom-bar">
        <button type="button" class="step-continue-btn js-mode-continue" disabled>
            <span>Tiếp tục</span>
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

{# Step 4: Flashcard Options (Sub-selection) - Header in loaded content #}
<div id="step-flashcard-options" class="vocab-step">
    <div id="flashcard-options-container" class="step-content-container">
        <!-- Content loaded dynamically with its own header -->
    </div>
</div>

{# Step 5: MCQ Options - Header in loaded content #}
<div id="step-mcq-options" class="vocab-step">
    <div id="mcq-options-container" class="step-content-container">
        <!-- Content loaded dynamically with its own header -->
    </div>
</div>

{# Modal Options Flashcard #}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function () {
        // State
        let currentCategory = 'my';
        let currentSearch = '';
        let selectedSetId = null;
        let selectedSetData = null;

        // Elements
        const stepBrowser = document.getElementById('step-browser');
        const stepDetail = document.getElementById('step-detail');
        const stepModes = document.getElementById('step-modes');
        const stepFlashcardOptions = document.getElementById('step-flashcard-options');
        const stepMcqOptions = document.getElementById('step-mcq-options');
        const setsGrid = document.getElementById('sets-grid');
        const searchInput = document.getElementById('search-input');
        const flashcardOptionsContainer = document.getElementById('flashcard-options-container');
        const mcqOptionsContainer = document.getElementById('mcq-options-container');

        // Init
        loadSets();

        // Category tabs
        document.querySelectorAll('.vocab-tab').forEach(function (tab) {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.vocab-tab').forEach(function (t) { t.classList.remove('active'); });
                tab.classList.add('active');
                currentCategory = tab.dataset.category;
                loadSets();
            });
        });

        // Search
        let searchTimeout;
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function () {
                currentSearch = searchInput.value;
                loadSets();
            }, 300);
        });

        // Back buttons
        document.querySelectorAll('.js-back-to-browser').forEach(function (btn) {
            btn.addEventListener('click', function () { showStep('browser'); });
        });

        document.querySelectorAll('.js-back-to-detail').forEach(function (btn) {
            btn.addEventListener('click', function () { showStep('detail'); });
        });

        document.querySelectorAll('.js-back-to-modes').forEach(function (btn) {
            btn.addEventListener('click', function () { showStep('modes'); });
        });

        function showStep(step) {
            stepBrowser.classList.remove('active');
            stepDetail.classList.remove('active');
            stepModes.classList.remove('active');
            stepFlashcardOptions.classList.remove('active');
            stepMcqOptions.classList.remove('active');

            if (step === 'browser') stepBrowser.classList.add('active');
            else if (step === 'detail') stepDetail.classList.add('active');
            else if (step === 'modes') stepModes.classList.add('active');
            else if (step === 'flashcard-options') stepFlashcardOptions.classList.add('active');
            else if (step === 'mcq-options') stepMcqOptions.classList.add('active');
        }

        function loadSets() {
            setsGrid.innerHTML = '<div class="vocab-loading" style="grid-column: 1/-1;"><i class="fas fa-spinner fa-spin"></i><p>Đang tải...</p></div>';

            var url = '/learn/vocabulary/api/sets?category=' + currentCategory;
            if (currentSearch) url += '&q=' + encodeURIComponent(currentSearch);

            fetch(url)
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.success && data.sets.length > 0) {
                        renderSets(data.sets);
                    } else {
                        setsGrid.innerHTML = '<div class="vocab-empty" style="grid-column: 1/-1;"><i class="fas fa-folder-open"></i><p>Không có bộ thẻ nào</p></div>';
                    }
                })
                .catch(function () {
                    setsGrid.innerHTML = '<div class="vocab-empty" style="grid-column: 1/-1;"><i class="fas fa-exclamation-triangle"></i><p>Lỗi tải dữ liệu</p></div>';
                });
        }

        function renderSets(sets) {
            var html = '';
            sets.forEach(function (s) {
                var coverStyle = s.cover_image ? 'background-image: url(/static/' + s.cover_image + ')' : '';
                var authorInitial = (s.creator_name || 'U').charAt(0).toUpperCase();
                var authorName = s.creator_name || 'Unknown';

                html += '<div class="vocab-set-card" data-set-id="' + s.id + '">';
                html += '<div class="vocab-set-cover" style="' + coverStyle + '">';
                if (!s.cover_image) html += '<i class="fas fa-book-open"></i>';
                html += '</div>';
                html += '<div class="vocab-set-info">';
                html += '<div class="vocab-set-title">' + s.title + '</div>';
                html += '<div class="vocab-set-meta">';
                html += '<div class="vocab-set-author">';
                html += '<span class="vocab-set-avatar">' + authorInitial + '</span>';
                html += '<span>' + authorName + '</span>';
                html += '</div>';
                html += '<div class="vocab-set-count"><i class="fas fa-clone"></i>' + s.card_count + '</div>';
                html += '</div>';
                html += '</div></div>';
            });
            setsGrid.innerHTML = html;

            // Bind click
            document.querySelectorAll('.vocab-set-card').forEach(function (card) {
                card.addEventListener('click', function () {
                    selectedSetId = card.dataset.setId;
                    loadSetDetail(selectedSetId);
                });
            });
        }

        function loadSetDetail(setId) {
            showStep('detail');

            fetch('/learn/vocabulary/api/set/' + setId)
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.success) {
                        selectedSetData = data.set;
                        renderSetDetail(data.set);
                    }
                });
        }

        function renderSetDetail(s) {
            // Cover
            var coverEl = document.querySelector('.js-detail-cover');
            if (s.cover_image) {
                coverEl.style.backgroundImage = 'url(/static/' + s.cover_image + ')';
                coverEl.innerHTML = '';
            } else {
                coverEl.style.backgroundImage = '';
                coverEl.innerHTML = '<i class="fas fa-book-open"></i>';
            }

            // Info
            document.querySelector('.js-detail-title').textContent = s.title;
            document.querySelector('.js-detail-title-full').textContent = s.title;
            document.querySelector('.js-detail-desc').textContent = s.description || 'Không có mô tả';
            document.querySelector('.js-creator-name').textContent = s.creator_name;
            document.querySelector('.js-creator-avatar').textContent = s.creator_name.charAt(0).toUpperCase();
            document.querySelector('.js-card-count').textContent = s.card_count;
            document.querySelector('.js-memrise-count').textContent = s.memrise_count;
        }

        // Start learning button
        document.querySelectorAll('.js-start-learning').forEach(function (btn) {
            btn.addEventListener('click', function () {
                // Update selected set chip in step-modes
                if (selectedSetData) {
                    var setNameEl = document.querySelector('.js-selected-set-name');
                    if (setNameEl) {
                        setNameEl.textContent = selectedSetData.title;
                    }
                }
                updateModeVisibility();
                showStep('modes');
            });
        });

        function updateModeVisibility() {
            if (!selectedSetData || !selectedSetData.capabilities) {
                // Should not happen, but assume all allowed if missing
                document.querySelectorAll('.js-mode-card').forEach(el => el.style.display = 'flex');
                return;
            }
            const caps = new Set(selectedSetData.capabilities);
            const mapping = {
                'flashcard': 'supports_flashcard',
                'mcq': 'supports_quiz',
                'typing': 'supports_writing',
                'matching': 'supports_matching',
                'speed': 'supports_speed',
                'listening': 'supports_listening',
                'mixed': 'supports_srs' // Not implemented yet
            };

            // Special handling: if capabilities is empty or missing specific flags, current behavior was "all enabled"
            // But now we want filtering. If 'supports_flashcard' is missing from DB (old sets), we should probably Default True?
            // The DB migration didn't happen, so old sets default to False for new flags if column is NULL?
            // LearningContainer model handles Defaults? No.
            // But `capability_flags` method returns what is in JSON.
            // If new flags are stored in JSON, old sets won't have them.
            // **Correction**: To avoid breaking old sets, if NO new flags are present, we might want to default enable some?
            // Or just rely on user editing them.
            // Let's assume user will edit old sets or we rely on 'supports_quiz' which existed.
            // `supports_matching` and `supports_speed` will be False for old sets.
            // That is acceptable. User asked to "Optionalize" them.

            document.querySelectorAll('.js-mode-select').forEach(card => {
                const mode = card.dataset.mode;
                const flag = mapping[mode];

                if (flag && caps.has(flag)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Mode selection (select-then-submit pattern)
        var selectedMode = null;
        var continueBtn = document.querySelector('.js-mode-continue');

        document.querySelectorAll('.js-mode-select').forEach(function (card) {
            card.addEventListener('click', function () {
                // Deselect all
                document.querySelectorAll('.js-mode-select').forEach(function (c) {
                    c.classList.remove('selected');
                });
                // Select this one
                card.classList.add('selected');
                selectedMode = card.dataset.mode;
                // Enable continue button
                if (continueBtn) continueBtn.disabled = false;
            });
        });

        // Continue button handler
        if (continueBtn) {
            continueBtn.addEventListener('click', function () {
                if (!selectedMode) return;
                startSession(selectedMode);
            });
        }

        function startSession(mode) {
            if (!selectedSetId) return;

            if (mode === 'flashcard') {
                loadFlashcardOptions(selectedSetId);
            } else if (mode === 'mcq') {
                loadMcqOptions(selectedSetId);
            } else if (mode === 'typing') {
                window.location.href = '/learn/vocabulary/typing/session/' + selectedSetId;
            } else if (mode === 'mixed') {
                alert('Chế độ Học thông minh đang được phát triển');
            } else if (mode === 'matching') {
                window.location.href = '/learn/vocabulary/matching/session/' + selectedSetId;
            } else if (mode === 'speed') {
                window.location.href = '/learn/vocabulary/speed/session/' + selectedSetId;
            } else if (mode === 'listening') {
                window.location.href = '/learn/vocabulary/listening/session/' + selectedSetId;
            }
        }

        function loadFlashcardOptions(setId) {
            showStep('flashcard-options');
            flashcardOptionsContainer.innerHTML = '<div class="flex justify-center py-8"><i class="fas fa-spinner fa-spin text-blue-500 text-3xl"></i></div>';

            fetch('/learn/vocabulary/flashcard/get_flashcard_options_partial/' + setId)
                .then(r => r.text())
                .then(html => {
                    flashcardOptionsContainer.innerHTML = html;
                    bindFlashcardModeEvents(setId);
                })
                .catch(err => {
                    flashcardOptionsContainer.innerHTML = '<div class="text-center text-red-500 py-4">Lỗi tải tùy chọn. Vui lòng thử lại.</div>';
                });
        }

        function bindFlashcardModeEvents(setId) {
            if (!flashcardOptionsContainer) return;
            var selectedFlashcardMode = null;
            var continueBtn = flashcardOptionsContainer.querySelector('.js-flashcard-continue');
            var autoplaySettings = flashcardOptionsContainer.querySelector('#autoplay-settings-container');

            flashcardOptionsContainer.querySelectorAll('.js-flashcard-mode-select').forEach(function (card) {
                if (card.classList.contains('disabled')) return;

                card.addEventListener('click', function () {
                    // Deselect all
                    flashcardOptionsContainer.querySelectorAll('.js-flashcard-mode-select').forEach(function (c) {
                        c.classList.remove('selected');
                    });
                    // Select this one
                    card.classList.add('selected');
                    selectedFlashcardMode = card.dataset.modeId;
                    // Enable continue button
                    if (continueBtn) continueBtn.disabled = false;

                    // Show/hide autoplay settings
                    if (autoplaySettings) {
                        if (selectedFlashcardMode === 'autoplay') {
                            autoplaySettings.classList.remove('hidden');
                        } else {
                            autoplaySettings.classList.add('hidden');
                        }
                    }
                });
            });

            if (continueBtn) {
                continueBtn.addEventListener('click', function () {
                    if (!selectedFlashcardMode) return;

                    // Button count logic
                    var buttonCountSelect = flashcardOptionsContainer.querySelector('#button-count-select');
                    var buttonCount = buttonCountSelect ? parseInt(buttonCountSelect.value) : 3;

                    var finalMode = selectedFlashcardMode;
                    if (selectedFlashcardMode === 'autoplay') {
                        var scope = document.querySelector('input[name="autoplay-scope"]:checked');
                        finalMode = scope ? scope.value : 'autoplay_learned';
                    }

                    // Save settings first, then redirect
                    fetch('/learn/vocabulary/flashcard/save_flashcard_settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}' // Ensure CSRF token if needed, usually flask-wtf handles this but standard fetch might need header or just work if cookies are sent
                        },
                        body: JSON.stringify({ button_count: buttonCount })
                    })
                        .then(r => r.json())
                        .then(data => {
                            console.log("Settings saved:", data);
                            // Redirect after saving
                            window.location.href = '/learn/vocabulary/flashcard/start_flashcard_session/' + setId + '/' + finalMode;
                        })
                        .catch(err => {
                            console.error("Error saving settings:", err);
                            // Fallback redirect even if save fails
                            window.location.href = '/learn/vocabulary/flashcard/start_flashcard_session/' + setId + '/' + finalMode;
                        });
                });
            }

            // Also bind back button
            flashcardOptionsContainer.querySelectorAll('.js-back-to-modes').forEach(function (btn) {
                btn.addEventListener('click', function () { showStep('modes'); });
            });
        }

        function loadMcqOptions(setId) {
            showStep('mcq-options');
            mcqOptionsContainer.innerHTML = '<div class="flex justify-center py-8"><i class="fas fa-spinner fa-spin text-blue-500 text-3xl"></i></div>';

            fetch('/learn/vocabulary/mcq/get_mcq_options_partial/' + setId)
                .then(r => r.text())
                .then(html => {
                    mcqOptionsContainer.innerHTML = html;
                    // Execute scripts from injected HTML
                    mcqOptionsContainer.querySelectorAll('script').forEach(function (oldScript) {
                        var newScript = document.createElement('script');
                        newScript.textContent = oldScript.textContent;
                        document.body.appendChild(newScript);
                    });
                    // Bind back button
                    mcqOptionsContainer.querySelectorAll('.js-back-to-modes').forEach(function (btn) {
                        btn.addEventListener('click', function () { showStep('modes'); });
                    });
                })
                .catch(err => {
                    mcqOptionsContainer.innerHTML = '<div class="text-center text-red-500 py-4">Lỗi tải tùy chọn. Vui lòng thử lại.</div>';
                });
        }
    })();
</script>
{% endblock %}