{# Vocabulary Learning Hub - Main Dashboard v1.0 #}
{% extends "base.html" %}
{% block title %}Học từ vựng - MindStack{% endblock %}
{% block head %}
{{ super() }}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
    :root {
        --vocab-primary: #6366f1;
        --vocab-primary-light: #818cf8;
        --vocab-primary-dark: #4f46e5;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
    }

    /* Mobile full-screen steps */
    @media (max-width: 1023px) {

        body>header,
        body>footer {
            display: none !important;
        }

        body>main {
            padding: 0 !important;
            margin: 0 !important;
            max-width: none !important;
        }

        .vocab-step {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: #f8fafc;
            flex-direction: column;
            overflow-y: auto;
        }

        .vocab-step.active {
            display: flex;
        }
    }

    @media (min-width: 1024px) {
        .vocab-step {
            display: block !important;
            position: static !important;
        }

        #step-detail,
        #step-modes,
        #step-flashcard-options,
        #step-mcq-options {
            display: none !important;
        }

        #step-detail.active,
        #step-modes.active,
        #step-flashcard-options.active,
        #step-mcq-options.active {
            display: block !important;
        }
    }

    /* Header */
    .vocab-header {
        background: white;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-shrink: 0;
    }

    .vocab-back-btn {
        width: 36px;
        height: 36px;
        border-radius: 0.75rem;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
    }

    .vocab-back-btn:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    .vocab-title {
        font-weight: 700;
        color: #1e293b;
        font-size: 1.125rem;
    }

    /* Search */
    .vocab-search-wrap {
        padding: 0.75rem 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .vocab-search {
        display: flex;
        align-items: center;
        background: #f1f5f9;
        border-radius: 0.75rem;
        padding: 0.5rem 0.75rem;
        gap: 0.5rem;
    }

    .vocab-search i {
        color: #94a3b8;
    }

    .vocab-search input {
        border: none;
        background: transparent;
        flex: 1;
        font-size: 0.875rem;
        outline: none;
    }

    /* Category Tabs */
    .vocab-tabs {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .vocab-tab {
        flex: 1;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: #64748b;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .vocab-tab.active {
        background: var(--vocab-primary);
        color: white;
    }

    /* Grid */
    .vocab-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        padding: 1rem;
    }

    @media (min-width: 640px) {
        .vocab-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .vocab-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
    }

    /* Set Card - Premium App Style */
    .vocab-set-card {
        background: white;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .vocab-set-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px rgba(99, 102, 241, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: rgba(99, 102, 241, 0.3);
    }

    .vocab-set-card:active {
        transform: translateY(-2px) scale(0.98);
    }

    .vocab-set-cover {
        height: 110px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        background-size: cover;
        background-position: center;
        position: relative;
        overflow: hidden;
    }

    .vocab-set-cover::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, transparent 50%, rgba(0, 0, 0, 0.1) 100%);
    }

    .vocab-set-cover i {
        font-size: 2.5rem;
        color: rgba(255, 255, 255, 0.85);
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        position: relative;
        z-index: 1;
    }

    .vocab-set-info {
        padding: 0.875rem;
    }

    .vocab-set-title {
        font-weight: 700;
        color: #1e293b;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.3;
    }

    .vocab-set-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #64748b;
    }

    .vocab-set-count {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        color: #6366f1;
        background: #eef2ff;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
    }

    .vocab-set-count i {
        font-size: 0.65rem;
    }

    .vocab-set-author {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        color: #64748b;
        font-size: 0.7rem;
    }

    .vocab-set-avatar {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.55rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    /* Detail View - Modern Hero */
    .vocab-detail-hero {
        height: 240px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        background-size: 200% 200%;
        background-position: center;
        position: relative;
        overflow: hidden;
        animation: gradientShift 8s ease infinite;
    }

    @keyframes gradientShift {

        0%,
        100% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }
    }

    .vocab-detail-hero::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0.2) 100%);
        pointer-events: none;
    }

    .vocab-detail-hero::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 30% 50%, rgba(255, 255, 255, 0.15) 0%, transparent 50%);
        pointer-events: none;
    }

    .vocab-detail-hero i {
        font-size: 5rem;
        color: rgba(255, 255, 255, 0.95);
        text-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 1;
        animation: floatIcon 3s ease-in-out infinite;
    }

    @keyframes floatIcon {

        0%,
        100% {
            transform: translateY(0px);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    .vocab-detail-content {
        padding: 1.5rem;
    }

    .vocab-detail-title {
        font-size: 1.75rem;
        font-weight: 900;
        background: linear-gradient(135deg, #1e293b 0%, #6366f1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.75rem;
        line-height: 1.2;
    }

    .vocab-detail-desc {
        color: #64748b;
        font-size: 0.9375rem;
        margin-bottom: 1.25rem;
        line-height: 1.6;
    }

    /* Inline Creator Info */
    .vocab-creator-inline {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .vocab-creator-avatar-small {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.6875rem;
        flex-shrink: 0;
    }

    .vocab-creator-name-small {
        font-size: 0.8125rem;
        color: #64748b;
        font-weight: 500;
    }

    .vocab-detail-creator {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%);
        border-radius: 1rem;
        margin-bottom: 1.25rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .vocab-detail-creator:hover {
        border-color: #c4b5fd;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
    }

    .vocab-creator-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.125rem;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .vocab-creator-name {
        font-weight: 700;
        color: #1e293b;
        font-size: 0.9375rem;
    }

    .vocab-creator-role {
        font-size: 0.8125rem;
        color: #8b5cf6;
        font-weight: 600;
    }

    .vocab-detail-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.875rem;
        margin-bottom: 1.5rem;
    }

    .vocab-stat {
        position: relative;
        text-align: center;
        padding: 1.25rem 1rem;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 1rem;
        border: 2px solid transparent;
        background-clip: padding-box;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }

    .vocab-stat::before {
        content: '';
        position: absolute;
        inset: -2px;
        background: linear-gradient(135deg, #818cf8, #a78bfa);
        border-radius: 1rem;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .vocab-stat:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
    }

    .vocab-stat:hover::before {
        opacity: 1;
    }

    .vocab-stat-value {
        font-size: 2rem;
        font-weight: 900;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.25rem;
        line-height: 1;
    }

    .vocab-stat-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Progress Stat Card */
    .vocab-stat-progress {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .vocab-stat-count {
        font-size: 1.5rem !important;
    }

    /* Fixed Footer */
    .vocab-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        z-index: 200;
    }

    .vocab-start-btn {
        width: 100%;
        padding: 1rem;
        background: var(--vocab-primary);
        color: white;
        font-weight: 700;
        font-size: 1rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .vocab-start-btn:hover {
        background: var(--vocab-primary-dark);
    }

    /* Mode Cards */
    .vocab-mode-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        margin-bottom: 0.4rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .vocab-mode-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .vocab-mode-icon {
        width: 50px;
        height: 50px;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vocab-mode-icon i {
        font-size: 1.25rem;
        color: white;
    }

    .vocab-mode-icon.purple {
        background: linear-gradient(135deg, #7c3aed, #a78bfa);
    }

    .vocab-mode-icon.blue {
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
    }

    .vocab-mode-icon.green {
        background: linear-gradient(135deg, #10b981, #34d399);
    }

    .vocab-mode-icon.yellow {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
    }

    .vocab-mode-info {
        flex: 1;
    }

    .vocab-mode-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }

    .vocab-mode-desc {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    /* Scroll area */
    .vocab-scroll {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 160px;
    }

    /* Loading */
    .vocab-loading {
        text-align: center;
        padding: 3rem;
        color: #94a3b8;
    }

    .vocab-loading i {
        font-size: 2rem;
        color: var(--vocab-primary);
    }

    /* Empty */
    .vocab-empty {
        text-align: center;
        padding: 3rem;
        color: #94a3b8;
    }

    .vocab-empty i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #cbd5e1;
    }

    /* Fixed Pagination Bar */
    .vocab-pagination-bar {
        position: fixed;
        bottom: 89px;
        left: 0;
        right: 0;
        display: none;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.25rem 1rem;
        background: white;
        border-top: 1px solid #e2e8f0;
        z-index: 190;
    }

    .vocab-pagination-bar.visible {
        display: flex;
    }

    .pagination-nav-btn {
        width: 40px;
        height: 40px;
        border-radius: 0.75rem;
        background: white;
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .pagination-nav-btn:hover:not(:disabled) {
        background: #f8fafc;
        color: #1e293b;
    }

    .pagination-nav-btn:active:not(:disabled) {
        transform: scale(0.95);
    }

    .pagination-nav-btn:disabled {
        background: #f8fafc;
        border-color: #f1f5f9;
        color: #cbd5e1;
        cursor: not-allowed;
    }

    .pagination-pages {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        padding: 0.25rem;
    }

    .page-num {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        transition: all 0.15s;
        margin: 0 2px;
    }

    .page-num:hover:not(.active):not(.dots) {
        background: #f8fafc;
        color: #1e293b;
    }

    .page-num.active {
        background: var(--vocab-primary);
        color: white;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
    }

    .page-num.dots {
        cursor: default;
        color: #cbd5e1;
        font-size: 0.75rem;
    }

    /* Desktop layout */
    @media (min-width: 1024px) {
        .vocab-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .vocab-desktop-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .vocab-footer {
            position: static;
            box-shadow: none;
            border: none;
            padding: 0;
            margin-top: 1rem;
        }

        .vocab-detail-hero {
            height: 250px;
            border-radius: 1rem;
        }
    }

    /* Step Header (new design) */
    .step-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .step-back-btn,
    .step-home-btn {
        width: 36px;
        height: 36px;
        border-radius: 0.75rem;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .step-back-btn:hover,
    .step-home-btn:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    /* Breadcrumb - larger text as requested */
    .step-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .breadcrumb-item {
        color: #94a3b8;
    }

    .breadcrumb-item.active {
        color: #3b82f6;
    }

    .breadcrumb-sep {
        color: #cbd5e1;
        font-size: 0.65rem;
    }

    /* Simplified Step Header - Centered Breadcrumb */
    .step-header-simple {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-breadcrumb-centered {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Bottom Navigation Bar */
    .step-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0));
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
        z-index: 50;
        gap: 0.75rem;
    }

    .step-nav-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        flex: 1;
    }

    .step-nav-back {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }

    .step-nav-back:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    .step-nav-home {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .step-nav-home:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        color: white;
    }

    /* Scroll area with bottom nav padding */
    .step-scroll-with-nav {
        padding: 0.75rem !important;
        padding-bottom: 100px !important;
    }

    /* Left-Aligned Step Header - 2 Rows */
    .step-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-header-content {
        flex: 1;
    }

    /* Header Info - appears on scroll */
    .step-header-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
        min-width: 0;
    }

    .step-header-title-compact {
        font-size: 0.875rem;
        font-weight: 700;
        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .step-header-meta {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        white-space: nowrap;
    }

    .meta-separator {
        margin: 0 0.25rem;
        color: #cbd5e1;
    }

    .js-header-progress-percent {
        color: #8b5cf6;
        font-weight: 700;
    }

    .step-breadcrumb-left {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #94a3b8;
        margin-bottom: 0.25rem;
    }

    .step-breadcrumb-left i {
        font-size: 0.6rem;
        color: #cbd5e1;
    }

    .step-breadcrumb-left .active {
        color: #8b5cf6;
    }

    .step-header-title {
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    /* Selected Set Display */
    .step-set-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-set-label {
        font-size: 0.8rem;
        color: #64748b;
    }

    .step-set-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #334155;
    }

    .step-set-chip i {
        color: #8b5cf6;
        font-size: 0.7rem;
    }

    /* Selectable Mode Cards */
    .mode-select-card {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 1rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.75rem;
    }

    .mode-select-card:hover {
        border-color: #c4b5fd;
        background: #faf5ff;
    }

    .mode-select-card.selected {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #faf5ff, #ede9fe);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
    }

    .mode-select-icon {
        width: 44px;
        height: 44px;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.125rem;
        flex-shrink: 0;
    }

    .mode-select-icon.blue {
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
    }

    .mode-select-icon.green {
        background: linear-gradient(135deg, #10b981, #34d399);
    }

    .mode-select-icon.yellow {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
    }

    .mode-select-icon.purple {
        background: linear-gradient(135deg, #8b5cf6, #a78bfa);
    }

    .mode-select-info {
        flex: 1;
    }

    .mode-select-name {
        font-size: 0.95rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.125rem;
    }

    .mode-select-desc {
        font-size: 0.75rem;
        color: #64748b;
    }

    .mode-select-check {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.7rem;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .mode-select-check i {
        display: none;
    }

    .mode-select-card.selected .mode-select-check {
        border-color: #8b5cf6;
        background: #8b5cf6;
    }

    .mode-select-card.selected .mode-select-check i {
        display: block;
    }

    /* Bottom Bar with Single Button */
    .step-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0));
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.06);
        z-index: 50;
    }

    .step-continue-btn {
        width: 100%;
        padding: 1rem;
        border-radius: 1rem;
        font-size: 1rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .step-continue-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }

    .step-continue-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Title Section */
    .step-title-section {
        padding: 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .step-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 0.75rem 0;
    }

    .selected-set-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .selected-set-label {
        font-size: 0.875rem;
        color: #64748b;
    }

    .selected-set-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: #eff6ff;
        color: #2563eb;
        font-size: 0.8rem;
        font-weight: 600;
        border-radius: 9999px;
        border: 1px solid #bfdbfe;
    }

    .selected-set-chip i {
        font-size: 0.7rem;
    }

    /* Step Content Container */
    .step-content-container {
        min-height: 100%;
        display: flex;
        flex-direction: column;
    }

    /* Slide In Animation for Word Cards */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Course Overview Styling */
    #course-overview-container {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #f1f5f9;
    }

    #course-overview-container h3 {
        font-size: 1.125rem;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 1rem;
        letter-spacing: -0.01em;
    }

    /* Modern Progress Bar */
    .js-course-progress-bar {
        background: linear-gradient(90deg, #10b981, #059669) !important;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1) !important;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }

    /* Word List Container */
    .js-word-list {
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- STEP 1: Set Browser -->
<div id="step-browser" class="vocab-step active">
    <div class="vocab-header">
        <a href="{{ url_for('learning.learning_dashboard') }}" class="vocab-back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <span class="vocab-title">Học từ vựng</span>
    </div>

    <div class="vocab-search-wrap">
        <div class="vocab-search">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Tìm kiếm bộ thẻ...">
        </div>
    </div>

    <div class="vocab-tabs">
        <div class="vocab-tab active" data-category="my">Của tôi</div>
        <div class="vocab-tab" data-category="learning">Đang học</div>
        <div class="vocab-tab" data-category="explore">Khám phá</div>
    </div>

    <div class="vocab-scroll" style="padding-bottom: 80px;">
        <div id="sets-grid" class="vocab-grid">
            <div class="vocab-loading"><i class="fas fa-spinner fa-spin"></i>
                <p>Đang tải...</p>
            </div>
        </div>
    </div>

    <!-- Fixed Pagination - Premium App Style -->
    <div id="vocab-pagination-bar" class="vocab-pagination-bar">
        <button class="pagination-nav-btn js-vocab-prev-page" disabled>
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="pagination-pages js-vocab-page-numbers">
            <span class="page-num active">1</span>
        </div>
        <button class="pagination-nav-btn js-vocab-next-page" disabled>
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<!-- STEP 2: Set Detail -->
<div id="step-detail" class="vocab-step">
    <div class="step-header-left lg:hidden">
        <a href="/learn/vocabulary/" class="step-back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="step-header-info" style="opacity: 0; transition: opacity 0.3s;">
            <div class="step-header-title-compact js-header-title">Tên bộ thẻ</div>
            <div class="step-header-meta">
                <span class="js-header-card-count">1258</span> thẻ
                <span class="meta-separator">•</span>
                <span class="js-header-progress-percent">3%</span>
            </div>
        </div>
        <a href="{{ url_for('learning.learning_dashboard') }}" class="step-home-btn">
            <i class="fas fa-home"></i>
        </a>
    </div>

    <div class="vocab-scroll">
        <div class="vocab-detail-hero js-detail-cover">
            <i class="fas fa-book-open"></i>
        </div>

        <div class="vocab-detail-content" style="opacity: 0; transition: opacity 0.3s;">
            <h1 class="vocab-detail-title js-detail-title-full">Tên bộ thẻ</h1>
            <div class="vocab-creator-inline">
                <div class="vocab-creator-avatar-small js-creator-avatar">A</div>
                <span class="vocab-creator-name-small js-creator-name">Admin</span>
            </div>
            <p class="vocab-detail-desc js-detail-desc">Mô tả bộ thẻ...</p>

            <div class="vocab-detail-stats">
                <div class="vocab-stat">
                    <div class="vocab-stat-value js-card-count">0</div>
                    <div class="vocab-stat-label">Flashcard</div>
                </div>
                <div class="vocab-stat vocab-stat-progress">
                    <div class="vocab-stat-value vocab-stat-count js-progress-count">0/0</div>
                    <div class="vocab-stat-label">Đã học</div>
                </div>
            </div>

            <!-- Word List -->
            <h3 class="font-bold text-slate-700 mb-3 mt-6">Danh sách từ vựng</h3>
            <div class="js-word-list">
                <!-- Loading spinner initially -->
                <div class="py-12 flex justify-center">
                    <i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i>
                </div>
            </div>

        </div>

    </div>

    <!-- Fixed Pagination for Detail View -->
    <div id="detail-pagination-bar" class="vocab-pagination-bar visible">
        <button class="pagination-nav-btn js-detail-prev-page" disabled>
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="pagination-pages js-detail-page-numbers">
            <span class="page-num active">1</span>
        </div>
        <button class="pagination-nav-btn js-detail-next-page" disabled>
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <div class="vocab-footer">
        <button class="vocab-start-btn js-start-learning">
            <i class="fas fa-play-circle"></i> Bắt đầu học
        </button>
    </div>
</div>

<!-- STEP 3: Mode Selector - Select Then Submit -->
<div id="step-modes" class="vocab-step">
    {# Header - 2 Rows Like MCQ #}
    <div class="step-header-left">
        <a href="javascript:void(0)" class="step-back-btn js-back-to-detail">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="step-header-content">
            {# Row 1: Breadcrumb #}
            <div class="step-breadcrumb-left">
                <span>TỪ VỰNG</span>
                <i class="fas fa-chevron-right"></i>
                <span class="active">BƯỚC 1</span>
            </div>
            {# Row 2: Title #}
            <h1 class="step-header-title">Chọn chế độ học</h1>
        </div>
    </div>

    {# Selected Set Display #}
    <div class="step-set-display">
        <span class="step-set-label">Bộ đã chọn:</span>
        <span class="step-set-chip js-selected-set-chip">
            <i class="fas fa-layer-group"></i>
            <span class="js-selected-set-name">Chưa chọn</span>
        </span>
    </div>

    {# Mode Selection Cards #}
    <div class="vocab-scroll step-scroll-with-nav" style="padding: 1rem;">
        <div class="mode-select-card js-mode-select" data-mode="flashcard">
            <div class="mode-select-icon blue"><i class="fas fa-clone"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Flashcard</div>
                <div class="mode-select-desc">Lật thẻ ôn tập truyền thống</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="mcq">
            <div class="mode-select-icon green"><i class="fas fa-list-ul"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Trắc nghiệm</div>
                <div class="mode-select-desc">Chọn đáp án đúng từ 4 lựa chọn</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="listening">
            <div class="mode-select-icon" style="background: linear-gradient(135deg, #6366f1, #818cf8);"><i
                    class="fas fa-headphones-alt"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Luyện nghe (Dictation)</div>
                <div class="mode-select-desc">Nghe & chép chính tả</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="typing">
            <div class="mode-select-icon yellow"><i class="fas fa-keyboard"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Gõ đáp án</div>
                <div class="mode-select-desc">Gõ câu trả lời chính xác</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="matching">
            <div class="mode-select-icon" style="background: linear-gradient(135deg, #ec4899, #f472b6);"><i
                    class="fas fa-puzzle-piece"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Ghép đôi</div>
                <div class="mode-select-desc">Kéo thả ghép từ với nghĩa</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>

        <div class="mode-select-card js-mode-select" data-mode="speed">
            <div class="mode-select-icon" style="background: linear-gradient(135deg, #f97316, #fb923c);"><i
                    class="fas fa-bolt"></i></div>
            <div class="mode-select-info">
                <div class="mode-select-name">Ôn nhanh</div>
                <div class="mode-select-desc">Biết / Không biết trong 3 giây</div>
            </div>
            <span class="mode-select-check"><i class="fas fa-check"></i></span>
        </div>
    </div>

    {# Bottom Bar - Single Continue Button #}
    <div class="step-bottom-bar">
        <button type="button" class="step-continue-btn js-mode-continue" disabled>
            <span>Tiếp tục</span>
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

{# Step 4: Flashcard Options (Sub-selection) - Inline rendering #}
<div id="step-flashcard-options" class="vocab-step">
    <div class="step-header-left">
        <button type="button" class="step-back-btn js-back-to-modes">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="step-header-center">
            <h1 class="step-header-title">Chọn chế độ Flashcard</h1>
        </div>
    </div>

    {# Selected Set Display #}
    <div class="step-set-display">
        <span class="step-set-label">Bộ đã chọn:</span>
        <span class="step-set-chip js-selected-set-chip-fc">
            <i class="fas fa-layer-group"></i>
            <span class="js-selected-set-name-fc">Chưa chọn</span>
        </span>
    </div>

    {# Flashcard Mode Cards - Loaded dynamically #}
    <div class="vocab-scroll step-scroll-with-nav" style="padding: 1rem;">
        <div id="flashcard-modes-container" class="js-flashcard-modes-container">
            <div class="vocab-loading"><i class="fas fa-spinner fa-spin"></i>
                <p>Đang tải...</p>
            </div>
        </div>
    </div>

    {# Bottom Bar - Continue Button #}
    <div class="step-bottom-bar">
        <button type="button" class="step-continue-btn js-flashcard-mode-continue" disabled>
            <span>Bắt đầu học</span>
            <i class="fas fa-play"></i>
        </button>
    </div>
</div>

{# Step 5: MCQ Options - Header in loaded content #}
<div id="step-mcq-options" class="vocab-step">
    <div id="mcq-options-container" class="step-content-container">
        <!-- Content loaded dynamically with its own header -->
    </div>
</div>

{# Modal Options Flashcard #}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        (function () {
            // State
            let currentCategory = 'my';
            let currentSearch = '';
            let currentPage = 1;
            let selectedSetId = null;
            let selectedSetData = null;
            let selectedMode = null;
            let currentStatsPage = 1;

            // Elements
            const stepBrowser = document.getElementById('step-browser');
            const stepDetail = document.getElementById('step-detail');
            const stepModes = document.getElementById('step-modes');
            const stepFlashcardOptions = document.getElementById('step-flashcard-options');
            const stepMcqOptions = document.getElementById('step-mcq-options');

            const setsGrid = document.getElementById('sets-grid');
            const searchInput = document.getElementById('search-input');
            const flashcardOptionsContainer = document.getElementById('flashcard-options-container');
            const mcqOptionsContainer = document.getElementById('mcq-options-container');

            const continueBtn = document.querySelector('.js-mode-continue');
            const paginationBar = document.getElementById('vocab-pagination-bar');
            const prevPageBtn = document.querySelector('.js-vocab-prev-page');
            const nextPageBtn = document.querySelector('.js-vocab-next-page');

            if (!stepBrowser || !stepDetail || !setsGrid) {
                console.error("Critical elements missing in DOM");
                return;
            }

            // Bind Mode Select Events
            document.querySelectorAll('.js-mode-select').forEach(card => {
                card.addEventListener('click', function () {
                    // Reset all
                    document.querySelectorAll('.js-mode-select').forEach(c => c.classList.remove('selected'));
                    // Select current
                    this.classList.add('selected');
                    selectedMode = this.dataset.mode;

                    // Enable continue button
                    if (continueBtn) {
                        continueBtn.disabled = false;
                        continueBtn.classList.add('active'); // If using specific active style
                    }
                });
            });

            // Init
            loadSets();

            // Category tabs
            document.querySelectorAll('.vocab-tab').forEach(function (tab) {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.vocab-tab').forEach(function (t) { t.classList.remove('active'); });
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    loadSets();
                });
            });

            // Check for active set ID and step from server template
            const activeSetId = {{ active_set_id|default ('null')
        }};
    const activeStep = '{{ active_step|default("browser") }}';
    console.log("Deep Link Check:", activeSetId, "Step:", activeStep);

    if (activeSetId) {
        // Load set detail data first
        loadSetDetail(activeSetId, false);

        // Wait for data to load then show appropriate step
        if (activeStep && activeStep !== 'browser' && activeStep !== 'detail') {
            setTimeout(function () {
                showStep(activeStep);
                // Load mode data if needed
                if (activeStep === 'flashcard-options') {
                    loadFlashcardModes();
                } else if (activeStep === 'mcq-options') {
                    loadMcqOptions();
                }
            }, 500);
        }
    }

    // Search
    let searchTimeout;
    if (searchInput) {
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function () {
                currentSearch = searchInput.value;
                loadSets();
            }, 300);
        });
    }

    // Back buttons
    document.querySelectorAll('.js-back-to-browser').forEach(function (btn) {
        btn.addEventListener('click', function () {
            showStep('browser');
            history.pushState(null, '', '/learn/vocabulary/');
        });
    });

    document.querySelectorAll('.js-back-to-detail').forEach(function (btn) {
        btn.addEventListener('click', function () {
            showStep('detail');
            history.pushState({ step: 'detail', setId: selectedSetId }, '', '/learn/vocabulary/set/' + selectedSetId);
        });
    });

    document.querySelectorAll('.js-back-to-modes').forEach(function (btn) {
        btn.addEventListener('click', function () {
            showStep('modes');
            history.pushState({ step: 'modes', setId: selectedSetId }, '', '/learn/vocabulary/set/' + selectedSetId + '/modes');
        });
    });

    // Handle Browser Back Button
    window.addEventListener('popstate', function (event) {
        const pathname = window.location.pathname;

        if (pathname.includes('/set/')) {
            const parts = pathname.split('/');
            // Check for step suffix
            const lastPart = parts[parts.length - 1];

            if (lastPart === 'modes') {
                const setId = parts[parts.length - 2];
                if (selectedSetId != setId) loadSetDetail(setId, false);
                showStep('modes');
            } else if (lastPart === 'flashcard') {
                const setId = parts[parts.length - 2];
                if (selectedSetId != setId) loadSetDetail(setId, false);
                showStep('flashcard-options');
                loadFlashcardModes();
            } else if (lastPart === 'mcq') {
                const setId = parts[parts.length - 2];
                if (selectedSetId != setId) loadSetDetail(setId, false);
                showStep('mcq-options');
                loadMcqOptions(setId);
            } else if (!isNaN(lastPart)) {
                // Just set ID - show detail
                const setId = lastPart;
                if (selectedSetId != setId) {
                    loadSetDetail(setId, false);
                } else {
                    showStep('detail');
                }
            }
        } else {
            showStep('browser');
        }
    });

    function showStep(step) {
        if (stepBrowser) stepBrowser.classList.remove('active');
        if (stepDetail) stepDetail.classList.remove('active');
        if (stepModes) stepModes.classList.remove('active');
        if (stepFlashcardOptions) stepFlashcardOptions.classList.remove('active');
        if (stepMcqOptions) stepMcqOptions.classList.remove('active');

        if (step === 'browser' && stepBrowser) stepBrowser.classList.add('active');
        else if (step === 'detail' && stepDetail) stepDetail.classList.add('active');
        else if (step === 'modes' && stepModes) stepModes.classList.add('active');
        else if (step === 'flashcard-options' && stepFlashcardOptions) stepFlashcardOptions.classList.add('active');
        else if (step === 'mcq-options' && stepMcqOptions) stepMcqOptions.classList.add('active');
    }

    function loadSets(page) {
        page = page || 1;
        currentPage = page;
        if (!setsGrid) return;
        setsGrid.innerHTML = '<div class="vocab-loading" style="grid-column: 1/-1;"><i class="fas fa-spinner fa-spin"></i><p>Đang tải...</p></div>';

        var url = '/learn/vocabulary/api/sets?category=' + currentCategory + '&page=' + page;
        if (currentSearch) url += '&q=' + encodeURIComponent(currentSearch);

        fetch(url)
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (data.success && data.sets.length > 0) {
                    renderSets(data.sets);
                    updatePagination(data.page, data.has_prev, data.has_next, data.total);
                } else {
                    setsGrid.innerHTML = '<div class="vocab-empty" style="grid-column: 1/-1;"><i class="fas fa-folder-open"></i><p>Không có bộ thẻ nào</p></div>';
                    hidePagination();
                }
            })
            .catch(function () {
                setsGrid.innerHTML = '<div class="vocab-empty" style="grid-column: 1/-1;"><i class="fas fa-exclamation-triangle"></i><p>Lỗi tải dữ liệu</p></div>';
                hidePagination();
            });
    }

    function renderSets(sets) {
        if (!setsGrid) return;
        var html = '';
        sets.forEach(function (s) {
            var coverStyle = s.cover_image ? 'background-image: url(/static/' + s.cover_image + ')' : '';
            var authorInitial = (s.creator_name || 'U').charAt(0).toUpperCase();
            var authorName = s.creator_name || 'Unknown';

            html += '<div class="vocab-set-card" data-set-id="' + s.id + '">';
            html += '<div class="vocab-set-cover" style="' + coverStyle + '">';
            if (!s.cover_image) html += '<i class="fas fa-book-open"></i>';
            html += '</div>';
            html += '<div class="vocab-set-info">';
            html += '<div class="vocab-set-title">' + s.title + '</div>';
            html += '<div class="vocab-set-meta">';
            html += '<div class="vocab-set-author">';
            html += '<span class="vocab-set-avatar">' + authorInitial + '</span>';
            html += '<span>' + authorName + '</span>';
            html += '</div>';
            html += '<div class="vocab-set-count"><i class="fas fa-clone"></i>' + s.card_count + '</div>';
            html += '</div>';
            html += '</div></div>';
        });
        setsGrid.innerHTML = html;

        // Bind click
        document.querySelectorAll('.vocab-set-card').forEach(function (card) {
            card.addEventListener('click', function () {
                selectedSetId = card.dataset.setId;
                loadSetDetail(selectedSetId, true); // true = push state
            });
        });
    }

    function updatePagination(page, hasPrev, hasNext, total) {
        if (!paginationBar) return;

        var totalPages = Math.max(1, Math.ceil(total / 10)); // 10 per page, at least 1

        paginationBar.classList.add('visible');
        if (prevPageBtn) prevPageBtn.disabled = !hasPrev;
        if (nextPageBtn) nextPageBtn.disabled = !hasNext;

        // Render page numbers
        var pageContainer = document.querySelector('.js-vocab-page-numbers');
        if (pageContainer) {
            var html = '';

            for (var i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages ||
                    (i >= page - 1 && i <= page + 1)) {
                    html += '<span class="page-num' + (i === page ? ' active' : '') + '" data-page="' + i + '">' + i + '</span>';
                } else if (i === 2 && page > 3) {
                    html += '<span class="page-num dots">...</span>';
                } else if (i === totalPages - 1 && page < totalPages - 2) {
                    html += '<span class="page-num dots">...</span>';
                }
            }

            pageContainer.innerHTML = html;

            pageContainer.querySelectorAll('.page-num:not(.dots)').forEach(function (el) {
                el.addEventListener('click', function () {
                    var p = parseInt(el.dataset.page);
                    if (p !== currentPage) loadSets(p);
                });
            });
        }
    }

    function hidePagination() {
        if (paginationBar) paginationBar.classList.remove('visible');
    }

    // Pagination button events
    if (prevPageBtn) {
        prevPageBtn.addEventListener('click', function () {
            if (currentPage > 1) loadSets(currentPage - 1);
        });
    }

    if (nextPageBtn) {
        nextPageBtn.addEventListener('click', function () {
            loadSets(currentPage + 1);
        });
    }

    function loadSetDetail(setId, pushState = true) {
        showStep('detail');
        selectedSetId = setId;
        currentStatsPage = 1;

        if (pushState) {
            history.pushState({ setId: setId }, '', '/learn/vocabulary/set/' + setId);
        }

        console.log("Fetching set detail:", setId);

        fetch('/learn/vocabulary/api/set/' + setId + '?page=1')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (data.success) {
                    selectedSetData = data.set;
                    renderSetDetail(data.set, data.course_stats, false, data.pagination_html);
                } else {
                    console.error('Failed to load set data:', data.message);
                    alert('Không thể tải thông tin bộ thẻ: ' + (data.message || 'Lỗi không xác định'));
                }
            })
            .catch(function (err) {
                console.error('Error loading set detail:', err);
                alert('Có lỗi xảy ra khi tải dữ liệu.');
            });
    }

    // Load More Button - replaced by pagination
    const loadMoreBtn = document.querySelector('.js-load-more-words');
    if (loadMoreBtn) loadMoreBtn.style.display = 'none';

    function fetchCourseStatsPage(page) {
        if (!selectedSetId) return;

        // Find list container to show loading state
        const listContainer = document.querySelector('.js-word-list');
        if (listContainer) {
            listContainer.innerHTML = '<div class="py-12 flex justify-center"><i class="fas fa-spinner fa-spin text-2xl text-slate-300"></i></div>';
        }

        fetch('/learn/vocabulary/api/set/' + selectedSetId + '?page=' + page)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.course_stats) {
                    // Pass pagination_html if available
                    renderSetDetail(selectedSetData, data.course_stats, false, data.pagination_html);
                    // Scroll to top of list
                    const overview = document.getElementById('course-overview-container');
                    if (overview) overview.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    console.error("API Error:", data.message);
                    alert("Lỗi server: " + (data.message || "Không thể tải dữ liệu."));
                    // Restore/Clear spinner
                    const listContainer = document.querySelector('.js-word-list');
                    if (listContainer) listContainer.innerHTML = '<div class="text-center text-red-500 py-4">Thử lại sau.</div>';
                }
            })
            .catch(err => {
                console.error("Pagination error:", err);
                alert('Lỗi kết nối.');
            });
    }

    function renderSetDetail(s, stats, append = false, paginationHtml = '') {
        // Cover & Info only update on fresh load
        if (!append) {
            var coverEl = document.querySelector('.js-detail-cover');
            if (coverEl) {
                if (s.cover_image) {
                    coverEl.style.backgroundImage = 'url(/static/' + s.cover_image + ')';
                    coverEl.innerHTML = '';
                } else {
                    coverEl.style.backgroundImage = '';
                    coverEl.innerHTML = '<i class="fas fa-book-open"></i>';
                }
            }

            // Info
            const els = {
                title: document.querySelector('.js-detail-title'),
                titleFull: document.querySelector('.js-detail-title-full'),
                desc: document.querySelector('.js-detail-desc'),
                creator: document.querySelector('.js-creator-name'),
                avatar: document.querySelector('.js-creator-avatar'),
                cardCount: document.querySelector('.js-card-count'),
                progressCount: document.querySelector('.js-progress-count')
            };
            if (els.title) els.title.textContent = s.title;
            if (els.titleFull) els.titleFull.textContent = s.title;
            if (els.desc) els.desc.textContent = s.description || 'Không có mô tả';
            if (els.creator) els.creator.textContent = s.creator_name;
            if (els.avatar) els.avatar.textContent = s.creator_name.charAt(0).toUpperCase();
            if (els.cardCount) els.cardCount.textContent = s.card_count;

            // Update progress stat as count
            const learnedCount = stats && stats.learned_count !== undefined ? stats.learned_count : 0;
            const totalCount = stats && stats.total_count !== undefined ? stats.total_count : s.card_count;
            if (els.progressCount) els.progressCount.textContent = learnedCount + '/' + totalCount;

            // Update header info (for sticky header)
            const headerTitle = document.querySelector('.js-header-title');
            const headerCardCount = document.querySelector('.js-header-card-count');
            const headerProgressPercent = document.querySelector('.js-header-progress-percent');
            if (headerTitle) headerTitle.textContent = s.title;
            if (headerCardCount) headerCardCount.textContent = s.card_count;
            const progressPercent = totalCount > 0 ? Math.round((learnedCount / totalCount) * 100) : 0;
            if (headerProgressPercent) headerProgressPercent.textContent = progressPercent + '%';

            // Show content after data is loaded
            const detailContent = document.querySelector('.vocab-detail-content');
            if (detailContent) {
                detailContent.style.opacity = '1';
            }
        }

        // Hide Course Overview Stats section completely
        const overviewContainer = document.getElementById('course-overview-container');
        if (overviewContainer) {
            overviewContainer.style.display = 'none';
        }

        // Scroll handler for sticky header info
        const vocabScroll = document.querySelector('#step-detail .vocab-scroll');
        const headerInfo = document.querySelector('.step-header-info');
        const detailTitle = document.querySelector('.vocab-detail-title');
        if (vocabScroll && headerInfo && detailTitle) {
            vocabScroll.addEventListener('scroll', function () {
                // Show header when title is scrolled out of view
                const titleRect = detailTitle.getBoundingClientRect();
                const headerHeight = document.querySelector('.step-header-left')?.offsetHeight || 60;

                if (titleRect.bottom < headerHeight) {
                    headerInfo.style.opacity = '1';
                } else {
                    headerInfo.style.opacity = '0';
                }
            });
        }

        // Word List - sort and render if stats available
        if (stats && stats.items) {
            const listContainer = document.querySelector('.js-word-list');
            if (listContainer) {
                let listHtml = '';

                if (stats.items && stats.items.length > 0) {
                    // Sort: Words needing review (low %) first, new words last
                    const sortedItems = [...stats.items].sort((a, b) => {
                        // New items go to end
                        if (a.status === 'new' && b.status !== 'new') return 1;
                        if (b.status === 'new' && a.status !== 'new') return -1;
                        // Both new or both not new: sort by retention (ascending - low % first)
                        return a.retention_rate - b.retention_rate;
                    });

                    sortedItems.forEach(item => {
                        let barColor = 'bg-red-500';
                        let progressGradient = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        if (item.retention_rate >= 80) {
                            barColor = 'bg-green-500';
                            progressGradient = 'linear-gradient(135deg, #10b981, #059669)';
                        } else if (item.retention_rate >= 50) {
                            barColor = 'bg-yellow-500';
                            progressGradient = 'linear-gradient(135deg, #f59e0b, #d97706)';
                        }

                        let statusBadge = '';
                        if (item.status === 'new') {
                            statusBadge = '<span class="px-2 py-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-[10px] font-bold uppercase rounded-full tracking-wider shadow-sm">Mới</span>';
                        }

                        let dueBadge = '';
                        if (item.is_due) {
                            dueBadge = '<span class="px-2 py-1 bg-gradient-to-r from-red-500 to-red-600 text-white text-[10px] font-bold uppercase rounded-full tracking-wider shadow-sm animate-pulse">Ôn tập</span>';
                        }

                        listHtml += `
                        <div class="group p-4 bg-white border border-slate-100 rounded-xl hover:border-indigo-200 hover:shadow-lg transition-all duration-300 mb-3 relative overflow-hidden" style="animation: slideIn 0.3s ease-out;">
                            <div class="absolute inset-0 bg-gradient-to-r from-indigo-50/0 via-indigo-50/50 to-indigo-50/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                            <div class="flex items-start justify-between gap-4 relative z-10">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-base font-bold text-slate-800 truncate">${item.term}</span>
                                        ${statusBadge}
                                        ${dueBadge}
                                    </div>
                                    <p class="text-sm text-slate-500 leading-relaxed truncate group-hover:text-slate-700 transition-colors">${item.definition}</p>
                                </div>
                                <div class="flex flex-col items-center gap-2 flex-shrink-0">
                                    <div class="relative w-14 h-14">
                                        <svg class="transform -rotate-90 w-14 h-14">
                                            <circle cx="28" cy="28" r="24" stroke="#e2e8f0" stroke-width="4" fill="none" />
                                            <circle cx="28" cy="28" r="24" stroke="url(#gradient-${item.retention_rate})" stroke-width="4" fill="none" 
                                                stroke-dasharray="${2 * Math.PI * 24}" 
                                                stroke-dashoffset="${2 * Math.PI * 24 * (1 - item.retention_rate / 100)}"
                                                stroke-linecap="round"
                                                class="transition-all duration-500" />
                                            <defs>
                                                <linearGradient id="gradient-${item.retention_rate}" x1="0%" y1="0%" x2="100%" y2="100%">
                                                    ${item.retention_rate >= 80 ? '<stop offset="0%" style="stop-color:#10b981;stop-opacity:1" /><stop offset="100%" style="stop-color:#059669;stop-opacity:1" />' :
                                item.retention_rate >= 50 ? '<stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" /><stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />' :
                                    '<stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" /><stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />'}
                                                </linearGradient>
                                            </defs>
                                        </svg>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <span class="text-xs font-bold ${item.retention_rate >= 80 ? 'text-green-600' : item.retention_rate >= 50 ? 'text-yellow-600' : 'text-red-600'}">${item.retention_rate}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                } else {
                    listHtml = '<div class="py-12 text-center flex flex-col items-center justify-center text-slate-400"><i class="fas fa-inbox text-4xl mb-3 text-slate-200"></i><span class="text-sm">Chưa có từ vựng nào.</span></div>';
                }

                listContainer.innerHTML = listHtml; // Always replace
            }

            // Pagination Controls - Target fixed pagination bar
            const detailPaginationBar = document.querySelector('#detail-pagination-bar');
            if (detailPaginationBar && paginationHtml) {
                // Inject pagination HTML into fixed bar
                detailPaginationBar.innerHTML = paginationHtml;
                detailPaginationBar.classList.add('visible');

                // Re-bind events for the new HTML links
                detailPaginationBar.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        const url = new URL(this.href);
                        const page = url.searchParams.get('page');
                        if (page) fetchCourseStatsPage(page);
                    });
                });
            } else if (detailPaginationBar && stats.pagination && stats.pagination.pages <= 1) {
                // Hide if only 1 page
                detailPaginationBar.classList.remove('visible');
            }

        } else if (overviewContainer) {
            overviewContainer.style.display = 'none';
        }
    }

    function fetchCourseStatsPage(page) {
        if (!selectedSetId) return;

        // Find list container to show loading state
        const listContainer = document.querySelector('.js-word-list');
        if (listContainer) {
            listContainer.innerHTML = '<div class="py-12 flex justify-center"><i class="fas fa-spinner fa-spin text-2xl text-slate-300"></i></div>';
        }

        const url = '/learn/vocabulary/api/set/' + selectedSetId + '?page=' + page + '&_t=' + new Date().getTime();

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.course_stats) {
                    renderSetDetail(selectedSetData, data.course_stats, false, data.pagination_html); // Pass pagination HTML
                    // Scroll to top of list
                    const overview = document.getElementById('course-overview-container');
                    if (overview) overview.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            })
            .catch(err => {
                console.error("Pagination error:", err);
                alert('Lỗi tải trang.');
            });
    }

    // Start learning button
    document.querySelectorAll('.js-start-learning').forEach(function (btn) {
        btn.addEventListener('click', function () {
            if (selectedSetData) {
                var setNameEl = document.querySelector('.js-selected-set-name');
                if (setNameEl) {
                    setNameEl.textContent = selectedSetData.title;
                }
            }
            updateModeVisibility();
            showStep('modes');
            history.pushState({ step: 'modes', setId: selectedSetId }, '', '/learn/vocabulary/set/' + selectedSetId + '/modes');
        });
    });

    function updateModeVisibility() {
        if (!selectedSetData || !selectedSetData.capabilities) {
            document.querySelectorAll('.js-mode-card').forEach(el => el.style.display = 'flex');
            return;
        }
        const caps = new Set(selectedSetData.capabilities);
        const mapping = {
            'flashcard': 'supports_flashcard',
            'mcq': 'supports_quiz',
            'typing': 'supports_writing',
            'matching': 'supports_matching',
            'speed': 'supports_speed',
            'listening': 'supports_listening',
            'mixed': 'supports_srs'
        };

        document.querySelectorAll('.js-mode-select').forEach(card => {
            const mode = card.dataset.mode;
            const flag = mapping[mode];

            if (flag && caps.has(flag)) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Continue button handler
    if (continueBtn) {
        continueBtn.addEventListener('click', function () {
            if (!selectedMode) return;
            startSession(selectedMode);
        });
    }

    function startSession(mode) {
        if (!selectedSetId) return;

        if (mode === 'flashcard') {
            loadFlashcardOptions(selectedSetId);
        } else if (mode === 'mcq') {
            // Redirect to MCQ setup page for options
            window.location.href = '/learn/vocabulary/mcq/setup/' + selectedSetId;
        } else if (mode === 'typing') {
            window.location.href = '/learn/vocabulary/typing/session/' + selectedSetId;
        } else if (mode === 'mixed') {
            alert('Chế độ Học thông minh đang được phát triển');
        } else if (mode === 'matching') {
            window.location.href = '/learn/vocabulary/matching/session/' + selectedSetId;
        } else if (mode === 'speed') {
            window.location.href = '/learn/vocabulary/speed/session/' + selectedSetId;
        } else if (mode === 'listening') {
            window.location.href = '/learn/vocabulary/listening/session/' + selectedSetId;
        }
    }

    function loadFlashcardOptions(setId) {
        showStep('flashcard-options');
        history.pushState({ step: 'flashcard-options', setId: setId }, '', '/learn/vocabulary/set/' + setId + '/flashcard');

        // Update set name display
        var setNameEl = document.querySelector('.js-selected-set-name-fc');
        if (setNameEl && selectedSetData) {
            setNameEl.textContent = selectedSetData.title || 'Đang tải...';
        }

        var container = document.getElementById('flashcard-modes-container');
        if (!container) return;

        container.innerHTML = '<div class="vocab-loading"><i class="fas fa-spinner fa-spin"></i><p>Đang tải...</p></div>';

        fetch('/learn/vocabulary/api/flashcard-modes/' + setId)
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (data.success && data.modes) {
                    renderFlashcardModes(data.modes, setId);
                } else {
                    container.innerHTML = '<div class="vocab-empty"><i class="fas fa-exclamation-triangle"></i><p>Lỗi tải chế độ học</p></div>';
                }
            })
            .catch(function (err) {
                container.innerHTML = '<div class="vocab-empty"><i class="fas fa-exclamation-triangle"></i><p>Lỗi kết nối</p></div>';
            });
    }

    function renderFlashcardModes(modes, setId) {
        var container = document.getElementById('flashcard-modes-container');
        if (!container) return;

        var modeIcons = {
            'new_only': { icon: 'fa-star', color: 'linear-gradient(135deg, #f59e0b, #fbbf24)' },
            'all_review': { icon: 'fa-redo', color: 'linear-gradient(135deg, #3b82f6, #60a5fa)' },
            'hard_only': { icon: 'fa-fire', color: 'linear-gradient(135deg, #ef4444, #f87171)' },
            'mixed_srs': { icon: 'fa-brain', color: 'linear-gradient(135deg, #8b5cf6, #a78bfa)' }
        };

        var modeNames = {
            'new_only': 'Chỉ làm mới',
            'all_review': 'Ôn tập đã làm',
            'hard_only': 'Ôn tập câu khó',
            'mixed_srs': 'Học thông minh (SRS)'
        };

        var html = '';
        modes.forEach(function (mode) {
            var iconInfo = modeIcons[mode.id] || { icon: 'fa-book', color: 'linear-gradient(135deg, #64748b, #94a3b8)' };
            var displayName = modeNames[mode.id] || mode.name;
            var isDisabled = mode.count === 0;

            html += '<div class="mode-select-card js-flashcard-mode-select' + (isDisabled ? ' disabled' : '') + '" data-mode-id="' + mode.id + '"' + (isDisabled ? ' style="opacity: 0.5; pointer-events: none;"' : '') + '>';
            html += '<div class="mode-select-icon" style="background: ' + iconInfo.color + ';"><i class="fas ' + iconInfo.icon + '"></i></div>';
            html += '<div class="mode-select-info">';
            html += '<div class="mode-select-name">' + displayName + '</div>';
            html += '<div class="mode-select-desc">' + mode.count + ' thẻ</div>';
            html += '</div>';
            html += '<span class="mode-select-check"><i class="fas fa-check"></i></span>';
            html += '</div>';
        });

        container.innerHTML = html;
        bindFlashcardModeEvents(setId);
    }

    var selectedFlashcardMode = null;

    function bindFlashcardModeEvents(setId) {
        var container = document.getElementById('flashcard-modes-container');
        if (!container) return;

        var continueBtn = document.querySelector('.js-flashcard-mode-continue');

        container.querySelectorAll('.js-flashcard-mode-select').forEach(function (card) {
            if (card.classList.contains('disabled')) return;

            card.addEventListener('click', function () {
                // Deselect all
                container.querySelectorAll('.js-flashcard-mode-select').forEach(function (c) {
                    c.classList.remove('selected');
                });
                // Select this one
                card.classList.add('selected');
                selectedFlashcardMode = card.dataset.modeId;

                // Enable continue button
                if (continueBtn) continueBtn.disabled = false;
            });
        });

        if (continueBtn) {
            continueBtn.addEventListener('click', function () {
                if (!selectedFlashcardMode || !selectedSetId) return;
                // Redirect to flashcard session
                window.location.href = '/learn/start_flashcard_session/' + selectedSetId + '/' + selectedFlashcardMode;
            });
        }
    }

    function loadMcqOptions(setId) {
        showStep('mcq-options');
        history.pushState({ step: 'mcq-options', setId: setId }, '', '/learn/vocabulary/set/' + setId + '/mcq');
        mcqOptionsContainer.innerHTML = '<div class="flex justify-center py-8"><i class="fas fa-spinner fa-spin text-blue-500 text-3xl"></i></div>';

        fetch('/learn/get_quiz_modes_partial/' + setId)
            .then(r => r.text())
            .then(html => {
                mcqOptionsContainer.innerHTML = html;
                // Execute scripts from injected HTML
                mcqOptionsContainer.querySelectorAll('script').forEach(function (oldScript) {
                    var newScript = document.createElement('script');
                    newScript.textContent = oldScript.textContent;
                    document.body.appendChild(newScript);
                });
                mcqOptionsContainer.querySelectorAll('.js-back-to-modes').forEach(function (btn) {
                    btn.addEventListener('click', function () { showStep('modes'); });
                });

                bindQuizModeEvents(setId);
            })
            .catch(err => {
                mcqOptionsContainer.innerHTML = '<div class="text-center text-red-500 py-4">Lỗi tải tùy chọn. Vui lòng thử lại.</div>';
            });
    }

    function bindQuizModeEvents(setId) {
        if (!mcqOptionsContainer) return;
        var selectedQuizMode = null;
        var continueBtn = mcqOptionsContainer.querySelector('.js-quiz-continue');

        mcqOptionsContainer.querySelectorAll('.quiz-mode-item').forEach(function (card) {
            if (card.classList.contains('opacity-50')) return; // Check if disabled

            card.addEventListener('click', function () {
                // Deselect all
                mcqOptionsContainer.querySelectorAll('.quiz-mode-item').forEach(function (c) {
                    c.classList.remove('selected', 'border-indigo-500', 'bg-indigo-50');
                    c.classList.add('border-gray-200', 'bg-white');
                });
                // Select this one
                card.classList.remove('border-gray-200', 'bg-white');
                card.classList.add('selected', 'border-indigo-500', 'bg-indigo-50');

                selectedQuizMode = card.dataset.modeId;
                // Enable continue button
                if (continueBtn) continueBtn.disabled = false;
            });
        });

        if (continueBtn) {
            continueBtn.addEventListener('click', function () {
                if (!selectedQuizMode) return;

                // Batch size logic
                var batchSizeSelect = mcqOptionsContainer.querySelector('#session-size-select');
                var batchSize = batchSizeSelect ? parseInt(batchSizeSelect.value) : 10; // Default 10 if not found (mobile might not have dropdown in partial?)

                // Note: Mobile partial usually doesn't have batch size dropdown in this snippet?
                // Step 1712: _quiz_modes_selection_mobile.html does NOT have batch size dropdown.
                // It should probably have one, but let's default or check if it exists in another file. 
                // Assuming desktop has it. If mobile doesn't, allow default.

                window.location.href = '/learn/start_quiz_session/' + setId + '/' + selectedQuizMode + '?batch_size=' + (batchSize || 10);
            });
        }
    }
    }) ();
});
</script>
{% endblock %}