<div class="stats-container" style="padding: 1.5rem 1rem;">
    {% set s = stats %}
    {% set p = s.progress %}
    {% set perf = s.performance %}

    <!-- HEADER: Minimal (Term Only) -->
    <div class="stats-header" style="margin-bottom: 2rem; text-align: center;">
        <h1
            style="font-size: 2.5rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, #4f46e5, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2;">
            {{ s.item.front }}
        </h1>
        {% if s.item.pronunciation %}
        <div style="margin-top:0.5rem; font-family:'Courier New', monospace; color:#6366f1; font-weight: 600;">
            /{{ s.item.pronunciation }}/
        </div>
        {% endif %}

        <div style="margin-top: 1rem;">
            <span class="status-badge"
                style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 1rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; 
                {% if p.status == 'new' %}background: #e0f2fe; color: #0284c7;{% elif p.status == 'learning' %}background: #fef3c7; color: #d97706;{% elif p.status == 'mastered' %}background: #dcfce7; color: #16a34a;{% elif p.status == 'hard' %}background: #fee2e2; color: #dc2626;{% elif p.status == 'due' %}background: #ffedd5; color: #ea580c; border: 1px solid #fdba74;{% endif %}">
                {% if p.status == 'mastered' %}<i class="fas fa-crown"></i> Đã thuộc
                {% elif p.status == 'due' %}<i class="fas fa-clock"></i> Cần ôn tập
                {% elif p.status == 'hard' %}<i class="fas fa-exclamation-circle"></i> Khó
                {% elif p.status == 'learning' %}<i class="fas fa-book-reader"></i> Đang học
                {% else %}<i class="fas fa-star"></i> Mới
                {% endif %}
            </span>
        </div>
    </div>

    <!-- STATS GRID: 2 Columns -->
    <div class="stats-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 2rem;">

        <!-- Metric 1: Mastery -->
        <div class="stat-card"
            style="background: #f8fafc; border-radius: 1rem; padding: 1rem; text-align: center; border: 1px solid #e2e8f0;">
            <div
                style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem;">
                Sức khỏe trí nhớ</div>
            <div style="font-size: 1.75rem; font-weight: 800; color: #6366f1;">{{ p.mastery }}%</div>
        </div>

        <!-- Metric 2: Streak -->
        <div class="stat-card"
            style="background: #f8fafc; border-radius: 1rem; padding: 1rem; text-align: center; border: 1px solid #e2e8f0;">
            <div
                style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem;">
                Chuỗi đúng</div>
            <div
                style="font-size: 1.75rem; font-weight: 800; color: #f59e0b; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i class="fas fa-fire"></i> {{ p.streak }}
            </div>
        </div>

        <!-- Metric 3: Accuracy -->
        <div class="stat-card"
            style="background: #f8fafc; border-radius: 1rem; padding: 1rem; text-align: center; border: 1px solid #e2e8f0;">
            <div
                style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem;">
                Độ chính xác</div>
            <div
                style="font-size: 1.75rem; font-weight: 800; {% if perf.accuracy >= 80 %}color: #10b981;{% else %}color: #1e293b;{% endif %}">
                {{ perf.accuracy }}%</div>
        </div>

        <!-- Metric 4: Ease -->
        <div class="stat-card"
            style="background: #f8fafc; border-radius: 1rem; padding: 1rem; text-align: center; border: 1px solid #e2e8f0;">
            <div
                style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem;">
                Độ khó (Ease)</div>
            <div style="font-size: 1.75rem; font-weight: 800; color: #475569;">{{ p.ease_factor }}</div>
        </div>

        <!-- Metric 5: Total Score -->
        <div class="stat-card"
            style="background: #f8fafc; border-radius: 1rem; padding: 1rem; text-align: center; border: 1px solid #e2e8f0;">
            <div
                style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem;">
                Tổng điểm</div>
            <div
                style="font-size: 1.75rem; font-weight: 800; color: #0891b2; display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                <i class="fas fa-star text-yellow-400" style="font-size: 1.2rem;"></i> {{ perf.total_score }}
            </div>
            <div style="font-size: 0.7rem; color: #94a3b8; font-weight: 500;">{{ perf.total_reviews }} lần ôn</div>
        </div>

        <!-- Metric 6: Next Due SRS -->
        <div class="stat-card"
            style="background: #f8fafc; border-radius: 1rem; padding: 1rem; text-align: center; border: 1px solid #e2e8f0;">
            <div
                style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem;">
                Ngày ôn tiếp</div>
            <div style="font-size: 1.15rem; font-weight: 800; color: #7c3aed; padding: 0.3rem 0;">
                {{ p.due_relative }}
            </div>
            <div style="font-size: 0.7rem; color: #94a3b8; font-weight: 500;">
                {% if p.next_due %}
                {{ p.next_due.strftime('%H:%M %d/%m') }}
                {% else %}
                -
                {% endif %}
            </div>
        </div>
    </div>

    <!-- HISTORY: Timeline Buttons -->
    <div class="history-container">
        <h3
            style="font-size: 1rem; font-weight: 800; color: #334155; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-history text-slate-400"></i> Lịch sử gần đây
        </h3>

        {% if s.history %}
        <div class="history-scroll"
            style="display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 1rem; scrollbar-width: none; -ms-overflow-style: none;">
            {% for log in s.history %}
            <!-- IMPORTANT: onClick calls global window helper now -->
            <button class="history-btn" onclick="window.showLogDetails(this, {{ loop.index0 }})"
                data-timestamp="{{ log.timestamp.strftime('%H:%M %d/%m/%Y') }}" data-mode="{{ log.mode }}"
                data-result="{{ log.result }}" data-answer="{{ log.user_answer or 'Không có' }}"
                data-duration="{{ (log.duration_ms / 1000) | round(1) }}s"
                style="flex-shrink: 0; width: 48px; height: 48px; border-radius: 12px; border: 2px solid transparent; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: all 0.2s;
                {% if log.result == 'Correct' %}background: #dcfce7; color: #16a34a;{% else %}background: #fee2e2; color: #dc2626;{% endif %}">
                {% if log.result == 'Correct' %}<i class="fas fa-check"></i>{% else %}<i class="fas fa-times"></i>{%
                endif %}
            </button>
            {% endfor %}
        </div>

        <!-- Detail Panel -->
        <div id="log-detail-panel"
            style="background: #f1f5f9; border-radius: 1rem; padding: 1rem; margin-top: 0.5rem; display: none; animation: fadeIn 0.3s ease;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span id="detail-timestamp" style="font-size: 0.85rem; font-weight: 600; color: #64748b;">-</span>
                <span id="detail-mode"
                    style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; background: #e2e8f0; color: #475569; padding: 0.2rem 0.6rem; border-radius: 99px;">-</span>
            </div>

            <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 0.85rem; color: #64748b;">Kết quả:</span>
                    <span id="detail-result" style="font-size: 0.9rem; font-weight: 700;">-</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 0.85rem; color: #64748b;">Câu trả lời:</span>
                    <span id="detail-answer"
                        style="font-size: 0.9rem; font-weight: 600; color: #334155; max-width: 200px; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">-</span>
                </div>
            </div>
        </div>

        <!-- Auto trigger first button script logic moved to index.html -->
        {% else %}
        <div
            style="text-align: center; color: #94a3b8; padding: 2rem; background: #f8fafc; border-radius: 1rem; border: 1px dashed #cbd5e1;">
            Chưa có lịch sử ôn tập
        </div>
        {% endif %}
    </div>
</div>