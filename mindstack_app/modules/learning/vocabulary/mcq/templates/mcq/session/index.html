{# MCQ Session Template - Separated Desktop/Mobile Pattern #}
{% extends "base.html" %}
{% block title %}Tr·∫Øc nghi·ªám - {{ container.title }}{% endblock %}

{% block head %}
{{ super() }}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
    /* ===== CRITICAL: ƒê√¢y ph·∫£i l√† c√°c rules ƒê·∫¶U TI√äN ƒë·ªÉ tr√°nh flash ===== */
    /* Desktop: hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh */
    .mcq-desktop-view {
        display: block;
    }

    /* Mobile: ·∫©n m·∫∑c ƒë·ªãnh */
    .mcq-mobile-view {
        display: none;
    }

    /* ƒê·∫£o ng∆∞·ª£c tr√™n m√†n h√¨nh nh·ªè */
    @media (max-width: 1023px) {
        .mcq-desktop-view {
            display: none !important;
        }

        .mcq-mobile-view {
            display: block !important;
        }
    }

    /* ===== END CRITICAL ===== */

    /* ===== CSS chung cho MCQ Session (Core Styles) ===== */
    :root {
        --primary: #8b5cf6;
        --primary-light: #a78bfa;
        --success: #10b981;
        --error: #ef4444;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: #f8fafc;
        margin: 0;
    }

    /* Set viewport height variable for mobile */
    html,
    body {
        height: 100%;
    }

    .mcq-app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: #f8fafc;
    }

    /* === HEADER - 2 ROWS === */
    .mcq-header {
        position: sticky;
        top: 0;
        z-index: 40;
        background: white;
        border-bottom: 1px solid #e2e8f0;
        padding: 0.75rem 1rem;
    }

    .mcq-header-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .mcq-back-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: transparent;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        text-decoration: none;
    }

    .mcq-back-btn:hover {
        background: #f1f5f9;
        color: #1e293b;
    }

    .mcq-header-content {
        flex: 1;
    }

    /* Row 1: Breadcrumb */
    .mcq-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #94a3b8;
        margin-bottom: 0.25rem;
    }

    .mcq-breadcrumb-active {
        color: #8b5cf6;
    }

    .mcq-breadcrumb-sep {
        font-size: 0.6rem;
    }

    /* Row 2: Title */
    .mcq-page-title {
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .mcq-progress-badge {
        font-size: 0.75rem;
        font-weight: 600;
        color: #8b5cf6;
        margin-left: auto;
        flex-shrink: 0;
    }

    /* === MAIN CONTENT === */
    .mcq-main {
        flex: 1;
        padding: 1rem;
        padding-bottom: 100px;
    }

    /* Question Prompt */
    .mcq-prompt-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .mcq-prompt {
        font-size: 2rem;
        font-weight: 800;
        color: #1e293b;
        margin: 0;
        line-height: 1.3;
    }

    /* Options - Selectable Cards */
    .mcq-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .mcq-option {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.25rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .mcq-option:hover {
        border-color: #c4b5fd;
        background: #faf5ff;
    }

    .mcq-option.selected {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #faf5ff, #ede9fe);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
    }

    .mcq-option.correct {
        border-color: #10b981;
        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    }

    .mcq-option.incorrect {
        border-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
    }

    .mcq-option-icon {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        background: white;
        transition: all 0.2s;
    }

    .mcq-option.selected .mcq-option-icon {
        border-color: #8b5cf6;
        background: #8b5cf6;
        color: white;
    }

    .mcq-option.correct .mcq-option-icon {
        border-color: #10b981;
        background: #10b981;
        color: white;
    }

    .mcq-option.incorrect .mcq-option-icon {
        border-color: #ef4444;
        background: #ef4444;
        color: white;
    }

    .mcq-option-icon i {
        font-size: 0.75rem;
        display: none;
    }

    .mcq-option.selected .mcq-option-icon i,
    .mcq-option.correct .mcq-option-icon i,
    .mcq-option.incorrect .mcq-option-icon i {
        display: block;
    }

    .mcq-option-text {
        font-size: 1rem;
        font-weight: 600;
        color: #334155;
        flex: 1;
    }

    /* Result Feedback */
    .mcq-result {
        display: none;
        margin-top: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 1rem;
        border-left: 4px solid #8b5cf6;
    }

    .mcq-result.show {
        display: block;
    }

    .mcq-result.correct {
        border-left-color: #10b981;
        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    }

    .mcq-result.incorrect {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
    }

    .mcq-result-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .mcq-result-icon {
        font-size: 1.75rem;
    }

    .mcq-result-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .mcq-result.incorrect .mcq-result-title {
        color: #dc2626;
    }

    .mcq-result.correct .mcq-result-title {
        color: #047857;
    }

    .mcq-result-body {
        margin-top: 0.75rem;
    }

    .mcq-result-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.375rem;
    }

    .mcq-result-answer {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        background: white;
        border-radius: 0.625rem;
        font-weight: 700;
        font-size: 1rem;
        color: #047857;
        border: 1.5px solid #a7f3d0;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
    }

    /* Info Button on Options */
    .mcq-option-info {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: none;
        /* Hidden by default */
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        margin-left: auto;
        /* FIX: Ensure button is above pseudo-element */
        position: relative;
        z-index: 2;
    }

    /* Show info buttons only after answered */
    .mcq-option.answered .mcq-option-info {
        display: flex;
    }

    .mcq-option-info:hover {
        background: #e2e8f0;
        color: #8b5cf6;
    }

    .mcq-option-info:active {
        transform: scale(0.95);
    }

    /* Item Info Modal */
    .mcq-info-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: flex-end;
        justify-content: center;
        z-index: 200;
        padding: 0;
    }

    .mcq-info-modal.show {
        display: flex;
    }

    .mcq-info-card {
        background: white;
        border-radius: 1.5rem 1.5rem 0 0;
        padding: 1.5rem;
        padding-bottom: calc(1.5rem + env(safe-area-inset-bottom, 0));
        width: 100%;
        max-width: 500px;
        max-height: 70vh;
        overflow-y: auto;
        box-shadow: 0 -20px 40px rgba(0, 0, 0, 0.15);
        animation: slideUpModal 0.3s ease-out;
    }

    @keyframes slideUpModal {
        from {
            opacity: 0;
            transform: translateY(100%);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .mcq-info-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .mcq-info-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .mcq-info-close {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        font-size: 1rem;
    }

    .mcq-info-close:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    .mcq-info-row {
        margin-bottom: 1rem;
    }

    .mcq-info-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #8b5cf6;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.375rem;
    }

    .mcq-info-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
        line-height: 1.5;
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
    }

    /* === BOTTOM BAR === */
    .mcq-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0));
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.06);
        z-index: 50;
    }

    .mcq-submit-btn {
        width: 100%;
        padding: 1rem;
        border-radius: 1rem;
        font-size: 1rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .mcq-submit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }

    .mcq-submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Complete Modal */
    .mcq-complete {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        padding: 1rem;
    }

    .mcq-complete.show {
        display: flex;
    }

    .mcq-complete-box {
        background: white;
        border-radius: 1.5rem;
        padding: 2rem;
        text-align: center;
        max-width: 320px;
        width: 100%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .mcq-complete-icon {
        font-size: 4rem;
        color: #8b5cf6;
        margin-bottom: 1rem;
    }

    .mcq-complete-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }

    .mcq-complete-stats {
        font-size: 1.125rem;
        color: #64748b;
        margin-bottom: 1.5rem;
    }

    .mcq-complete-stats span {
        color: #8b5cf6;
        font-weight: 700;
    }

    .mcq-complete-btn {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        color: white;
        border: none;
        border-radius: 1rem;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
{# Include Desktop v√† Mobile partials - visibility ki·ªÉm so√°t b·ªüi CSS class #}
{% include 'mcq/session/_desktop.html' %}
{% include 'mcq/session/_mobile.html' %}

{# Complete Modal - Shared between Desktop and Mobile #}
<div class="mcq-complete" id="complete-modal">
    <div class="mcq-complete-box">
        <div class="mcq-complete-icon"><i class="fas fa-trophy"></i></div>
        <div class="mcq-complete-title">Ho√†n th√†nh! üéâ</div>
        <div class="mcq-complete-stats">B·∫°n ƒë√£ ƒë√∫ng <span id="final-score">0</span>/<span id="final-total">0</span>
            c√¢u</div>
        <button class="mcq-complete-btn" onclick="location.reload()">
            <i class="fas fa-redo"></i> Ch∆°i l·∫°i
        </button>
    </div>
</div>

{# Item Info Modal - Shared #}
<div class="mcq-info-modal" id="info-modal">
    <div class="mcq-info-card">
        <div class="mcq-info-header">
            <h3 class="mcq-info-title">Chi ti·∫øt t·ª´ v·ª±ng</h3>
            <button class="mcq-info-close" id="info-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="info-content">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function () {
        // Set viewport height for mobile
        function setVh() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setVh();
        window.addEventListener('resize', setVh);

        var setId = Number('{{ container.container_id }}');
        var mode = '{{ mode }}';
        var urlParams = new URLSearchParams(window.location.search);
        var questionCol = urlParams.get('question_column');
        var answerCol = urlParams.get('answer_column');
        var customPairs = urlParams.get('custom_pairs');

        var questions = [];
        var current = 0;
        var score = 0;
        var selectedAnswer = null;
        var answered = false;
        var total = 0;

        // Helper to get all elements with a class (for syncing desktop/mobile)
        function $$(selector) {
            return document.querySelectorAll(selector);
        }

        // Helper to get visible element
        function getVisible(selector) {
            const elements = document.querySelectorAll(selector);
            for (const el of elements) {
                if (el.offsetParent !== null) return el;
            }
            return elements[0] || null;
        }

        // Sync text content across desktop/mobile elements
        function setText(selector, text) {
            $$(selector).forEach(el => el.textContent = text);
        }

        // Sync innerHTML across desktop/mobile elements
        function setHtml(selector, html) {
            $$(selector).forEach(el => el.innerHTML = html);
        }

        // Toggle class on all matching elements
        function toggleClass(selector, className, add) {
            $$(selector).forEach(el => {
                if (add) {
                    el.classList.add(className);
                } else {
                    el.classList.remove(className);
                }
            });
        }

        var questionCount = urlParams.get('count') || '10';
        var answerCount = urlParams.get('answer_count') || '4';

        var fetchUrl = '/learn/vocabulary/mcq/api/questions/' + setId + '?count=' + questionCount + '&answer_count=' + answerCount + '&mode=' + mode;
        if (questionCol) fetchUrl += '&question_column=' + encodeURIComponent(questionCol);
        if (answerCol) fetchUrl += '&answer_column=' + encodeURIComponent(answerCol);
        if (customPairs) fetchUrl += '&custom_pairs=' + encodeURIComponent(customPairs);

        fetch(fetchUrl)
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (data.success) {
                    questions = data.questions;
                    total = questions.length;
                    setText('.js-progress-badge', '0/' + total);
                    showQuestion();
                }
            });

        function showQuestion() {
            if (current >= questions.length) {
                showComplete();
                return;
            }
            var q = questions[current];
            setText('.js-prompt', q.prompt);
            setText('.js-current-num', current + 1);
            selectedAnswer = null;
            answered = false;

            // Disable submit buttons
            $$('.js-submit-btn').forEach(btn => btn.disabled = true);
            setText('.js-btn-text', 'G·ª≠i ƒë√°p √°n');
            toggleClass('.js-result-panel', 'show', false);
            toggleClass('.js-result-panel', 'correct', false);
            toggleClass('.js-result-panel', 'incorrect', false);

            var html = '';
            var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            q.choices.forEach(function (c, idx) {
                var itemId = q.choice_item_ids ? q.choice_item_ids[idx] : null;
                var letter = letters[idx] || (idx + 1);
                html += '<div class="mcq-option" data-choice="' + c + '" data-item-id="' + (itemId || '') + '">';
                html += '<span class="mcq-option-letter">' + letter + '</span>';
                html += '<span class="mcq-option-icon"><i class="fas fa-check"></i></span>';
                html += '<span class="mcq-option-text">' + c + '</span>';
                if (itemId) {
                    html += '<button type="button" class="mcq-option-info js-info-btn" data-item-id="' + itemId + '" title="Xem chi ti·∫øt">';
                    html += '<i class="fas fa-info"></i>';
                    html += '</button>';
                }
                html += '</div>';
            });
            setHtml('.js-choices', html);

            // Attach click handlers to all choice elements
            $$('.js-choices .mcq-option').forEach(function (opt) {
                opt.addEventListener('click', function (e) {
                    // Don't select if clicking info button
                    if (e.target.closest('.mcq-option-info')) return;
                    if (answered) return;
                    selectOption(opt);
                });
            });

            // Attach info button handlers
            $$('.js-info-btn').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    var itemId = btn.dataset.itemId;
                    if (itemId) showItemInfo(itemId);
                });
            });
        }

        function selectOption(opt) {
            var choice = opt.dataset.choice;

            // Remove selected from all options in both views
            $$('.js-choices .mcq-option').forEach(function (o) {
                o.classList.remove('selected');
                // If this is the same choice, add selected
                if (o.dataset.choice === choice) {
                    o.classList.add('selected');
                }
            });

            selectedAnswer = choice;
            $$('.js-submit-btn').forEach(btn => btn.disabled = false);
        }

        // Attach submit handler to all submit buttons
        $$('.js-submit-btn').forEach(function (submitBtn) {
            submitBtn.addEventListener('click', function () {
                if (!selectedAnswer) return;

                if (!answered) {
                    answered = true;
                    var q = questions[current];
                    var isCorrect = selectedAnswer === q.answer;

                    $$('.js-choices .mcq-option').forEach(function (o) {
                        o.classList.add('answered'); // Add answered class to show info buttons
                        if (o.dataset.choice === q.answer) {
                            o.classList.add('correct');
                            o.classList.remove('selected');
                        } else if (o.dataset.choice === selectedAnswer && !isCorrect) {
                            o.classList.add('incorrect');
                            o.classList.remove('selected');
                        } else {
                            o.classList.remove('selected');
                        }
                    });

                    if (isCorrect) {
                        score++;
                        toggleClass('.js-result-panel', 'correct', true);
                        setText('.js-result-icon', '‚úÖ');
                        setText('.js-result-title', 'Ch√≠nh x√°c!');
                    } else {
                        toggleClass('.js-result-panel', 'incorrect', true);
                        setText('.js-result-icon', '‚ùå');
                        setText('.js-result-title', 'Sai r·ªìi!');
                    }

                    var progress = current + 1;
                    setText('.js-progress-badge', progress + '/' + total);

                    // Update stats
                    setText('.js-correct-count', score);
                    var pct = progress > 0 ? Math.round((score / progress) * 100) : 0;
                    setText('.js-score-percent', pct + '%');

                    setText('.js-correct-answer', q.answer);
                    toggleClass('.js-result-panel', 'show', true);
                    setText('.js-btn-text', 'C√¢u ti·∫øp theo');

                    fetch('/learn/vocabulary/mcq/api/check', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_id: q.item_id,
                            answer: selectedAnswer,
                            answer_column: answerCol
                        })
                    });
                } else {
                    current++;
                    showQuestion();
                }
            });
        });

        function showComplete() {
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-total').textContent = questions.length;
            document.getElementById('complete-modal').classList.add('show');
        }

        // Show item info modal
        function showItemInfo(itemId) {
            var infoModal = document.getElementById('info-modal');
            var infoContent = document.getElementById('info-content');

            infoContent.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #8b5cf6;"></i></div>';
            infoModal.classList.add('show');

            // Fetch item details
            fetch('/learn/vocabulary/mcq/api/item/' + itemId)
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.success && data.item) {
                        var item = data.item;
                        var html = '';

                        // Show all content fields
                        var content = item.content || {};
                        var fieldLabels = {
                            'front': 'M·∫∑t tr∆∞·ªõc',
                            'back': 'M·∫∑t sau',
                            'memrise_prompt': 'T·ª´ v·ª±ng',
                            'memrise_answers': 'Nghƒ©a',
                            'example': 'V√≠ d·ª•',
                            'pronunciation': 'Ph√°t √¢m',
                            'notes': 'Ghi ch√∫'
                        };

                        for (var key in content) {
                            var value = content[key];
                            if (typeof value === 'string' && value.trim() && !key.includes('audio') && !key.includes('img')) {
                                var label = fieldLabels[key] || key;
                                html += '<div class="mcq-info-row">';
                                html += '<div class="mcq-info-label">' + label + '</div>';
                                html += '<div class="mcq-info-value">' + value + '</div>';
                                html += '</div>';
                            }
                        }

                        if (!html) {
                            html = '<div style="text-align: center; color: #64748b; padding: 1rem;">Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt</div>';
                        }

                        infoContent.innerHTML = html;
                    } else {
                        infoContent.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 1rem;">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin</div>';
                    }
                })
                .catch(function () {
                    infoContent.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 1rem;">L·ªói khi t·∫£i th√¥ng tin</div>';
                });
        }

        // Close info modal
        document.getElementById('info-close').addEventListener('click', function () {
            document.getElementById('info-modal').classList.remove('show');
        });

        document.getElementById('info-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    })();
</script>
{% endblock %}