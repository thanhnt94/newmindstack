{#
File: _flashcard_session_mobile.html
Phiên bản: 3.0 - Quiz Style với Fixed Bottom Bar
MỤC ĐÍCH: Giao diện Mobile cho Flashcard Session
NOTE: Visibility được control bởi critical CSS trong index.html
#}

<style>
    /* ===== Flashcard Mobile - Quiz Session Style ===== */
    @media (max-width: 1023px) {

        /* Reset and base */
        .flashcard-mobile-view {
            height: 100%;
            background: #f1f5f9;
            padding: 0 !important;
        }

        .flashcard-mobile-view .page-shell {
            height: calc(var(--vh, 1vh) * 100);
            min-height: calc(var(--vh, 1vh) * 100);
            display: flex;
            flex-direction: column;
            padding: 0 !important;
        }

        .flashcard-mobile-view .session-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 0 !important;
            overflow: hidden;
        }

        /* Hide site header/footer on mobile - STRONG selectors */
        body>header,
        body>footer,
        header.bg-white,
        header.shadow-md {
            display: none !important;
            height: 0 !important;
            min-height: 0 !important;
            overflow: hidden !important;
            visibility: hidden !important;
        }

        body>main {
            padding: 0 !important;
            margin: 0 !important;
            max-width: none !important;
        }

        /* Hide stats panel that's not the modal */
        .flashcard-mobile-view .session-layout>.statistics-card,
        .flashcard-mobile-view .desktop-stats-container {
            display: none !important;
        }

        /* ===== HEADER - Stats Bar ===== */
        .flashcard-mobile-view .fc-header {
            position: sticky;
            top: 0;
            z-index: 40;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0;
        }

        /* Context Bar */
        .flashcard-mobile-view .fc-context-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .flashcard-mobile-view .fc-context-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-radius: 100px;
        }

        .flashcard-mobile-view .fc-nav-btns {
            display: flex;
            gap: 0.5rem;
        }

        .flashcard-mobile-view .fc-nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f1f5f9;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            text-decoration: none;
            transition: all 0.2s;
        }

        .flashcard-mobile-view .fc-nav-btn:active {
            background: #e2e8f0;
        }

        /* Settings Dropdown */
        .flashcard-mobile-view .fc-settings-dropdown {
            position: relative;
        }

        .flashcard-mobile-view .fc-settings-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            padding: 0.5rem;
            z-index: 100;
        }

        .flashcard-mobile-view .fc-settings-menu.show {
            display: block;
        }

        .flashcard-mobile-view .fc-settings-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: none;
            background: transparent;
            color: #334155;
            font-size: 0.8125rem;
            font-weight: 500;
            text-decoration: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .flashcard-mobile-view .fc-settings-item:hover,
        .flashcard-mobile-view .fc-settings-item:active {
            background: #f1f5f9;
        }

        .flashcard-mobile-view .fc-settings-item i {
            width: 18px;
            text-align: center;
            color: #64748b;
        }

        .flashcard-mobile-view .fc-settings-item.is-active i {
            color: #f97316;
        }

        /* Stats Row */
        .flashcard-mobile-view .fc-stats-row {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            gap: 0.75rem;
            background: white;
        }

        .flashcard-mobile-view .fc-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        .flashcard-mobile-view .fc-stat-label {
            font-size: 0.625rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .flashcard-mobile-view .fc-stat-value {
            font-size: 1rem;
            font-weight: 900;
            color: #1e293b;
            font-variant-numeric: tabular-nums;
        }

        .flashcard-mobile-view .fc-stat-value.learned {
            color: #10b981;
        }

        .flashcard-mobile-view .fc-stat-value.relearn {
            color: #f97316;
        }

        .flashcard-mobile-view .fc-stat-divider {
            width: 1px;
            height: 24px;
            background: #e2e8f0;
            flex-shrink: 0;
        }

        .flashcard-mobile-view .fc-title-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            overflow: hidden;
        }

        .flashcard-mobile-view .fc-title-label {
            font-size: 0.625rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .flashcard-mobile-view .fc-title-text {
            font-size: 0.8125rem;
            font-weight: 700;
            color: #334155;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* ===== MAIN CONTENT ===== */
        .flashcard-mobile-view .flashcard-wrapper {
            flex: 1;
            padding: 0.5rem;
            padding-bottom: 80px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .flashcard-mobile-view .card-surface {
            flex: 1;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .flashcard-mobile-view .flashcard-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .flashcard-mobile-view .js-flashcard-content {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        /* Card Container */
        .flashcard-mobile-view .flashcard-card-container,
        .flashcard-mobile-view .flashcard-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .flashcard-mobile-view .face {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0.5rem !important;
        }

        /* Card Toolbar - HIDDEN on mobile, moved to header */
        .flashcard-mobile-view .card-toolbar {
            display: none !important;
        }

        .flashcard-mobile-view .toolbar-left,
        .flashcard-mobile-view .toolbar-right {
            display: flex;
            gap: 0.375rem;
        }

        .flashcard-mobile-view .card-toolbar .label {
            font-size: 0.6875rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.5rem;
            background: #f1f5f9;
            border-radius: 0.375rem;
        }

        .flashcard-mobile-view .card-toolbar .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 0.5rem;
            background: #f1f5f9;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .flashcard-mobile-view .card-toolbar .icon-btn:active {
            background: #e2e8f0;
        }

        .flashcard-mobile-view .card-toolbar .icon-btn.is-disabled {
            opacity: 0.4;
        }

        /* Card Content - Small equal padding on all sides */
        .flashcard-mobile-view ._card-container {
            flex: 1;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .flashcard-mobile-view .text-area {
            width: 100%;
            text-align: center;
            padding: 0;
        }

        .flashcard-mobile-view .flashcard-content-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.4;
        }

        .flashcard-mobile-view .media-container {
            margin-top: 1rem;
        }

        .flashcard-mobile-view .media-container img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.75rem;
            object-fit: contain;
        }

        /* Hide buttons inside card - they go in bottom bar */
        .flashcard-mobile-view .flip-btn-container,
        .flashcard-mobile-view .actions {
            display: none !important;
        }

        /* Settings panel */
        .flashcard-mobile-view .toolbar-settings {
            position: relative;
        }

        .flashcard-mobile-view .settings-panel {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            gap: 0.25rem;
            z-index: 100;
        }

        .flashcard-mobile-view .toolbar-settings.is-open .settings-panel {
            display: flex;
        }

        /* ===== FIXED BOTTOM BAR ===== */
        .flashcard-mobile-view .fc-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.75rem 1rem;
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0));
            background: white;
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.06);
            z-index: 50;
        }

        /* Flip Button (Front side) */
        .flashcard-mobile-view .fc-flip-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.9375rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.35);
            transition: all 0.2s;
        }

        .flashcard-mobile-view .fc-flip-btn:active {
            transform: scale(0.98);
        }

        /* Rating Buttons (Back side) */
        .flashcard-mobile-view .fc-rating-btns {
            display: none;
            gap: 0.5rem;
        }

        .flashcard-mobile-view .fc-rating-btns.show {
            display: flex;
        }

        .flashcard-mobile-view .fc-rating-btn {
            flex: 1;
            padding: 0.5rem 0.25rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .flashcard-mobile-view .fc-rating-btn:active {
            transform: scale(0.92);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }

        .flashcard-mobile-view .fc-rating-btn i {
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        /* Rating button colors - vibrant gradients */
        .flashcard-mobile-view .fc-rating-btn.again {
            background: linear-gradient(135deg, #ff6b6b 0%, #e53935 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(229, 57, 53, 0.35);
        }

        .flashcard-mobile-view .fc-rating-btn.hard {
            background: linear-gradient(135deg, #ffa726 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(245, 124, 0, 0.35);
        }

        .flashcard-mobile-view .fc-rating-btn.medium {
            background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%);
            color: #4a4a4a;
            box-shadow: 0 3px 10px rgba(255, 179, 0, 0.35);
        }

        .flashcard-mobile-view .fc-rating-btn.good {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(67, 160, 71, 0.35);
        }

        .flashcard-mobile-view .fc-rating-btn.easy {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(30, 136, 229, 0.35);
        }

        .flashcard-mobile-view .fc-rating-btn.veryeasy {
            background: linear-gradient(135deg, #7c4dff 0%, #651fff 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(101, 31, 255, 0.35);
        }
    }
</style>

{# Mobile Interface - Quiz Session Style #}
<div class="flashcard-mobile-view">
    <div class="page-shell">
        <!-- Header - Stats Bar -->
        <div class="fc-header">
            <!-- Context Bar -->
            <div class="fc-context-bar">
                <span class="fc-context-pill">
                    <i class="fas fa-clone"></i>
                    <span>Flashcard</span>
                </span>
                <div class="fc-nav-btns">
                    <!-- Utility buttons from card toolbar -->
                    <button class="fc-nav-btn open-ai-modal-btn js-fc-ai-btn" title="AI">
                        <i class="fas fa-robot" style="font-size: 0.75rem;"></i>
                    </button>
                    <button class="fc-nav-btn open-note-panel-btn js-fc-note-btn" title="Ghi chú">
                        <i class="fas fa-sticky-note" style="font-size: 0.75rem;"></i>
                    </button>
                    <button class="fc-nav-btn js-fc-audio-btn" title="Phát âm thanh">
                        <i class="fas fa-volume-up" style="font-size: 0.75rem;"></i>
                    </button>
                    <button class="fc-nav-btn open-stats-modal-btn" title="Thống kê">
                        <i class="fas fa-chart-bar" style="font-size: 0.75rem;"></i>
                    </button>
                    <!-- Settings dropdown -->
                    <div class="fc-settings-dropdown">
                        <button class="fc-nav-btn js-fc-settings-toggle" title="Cài đặt">
                            <i class="fas fa-ellipsis-v" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="fc-settings-menu js-fc-settings-menu">
                            <button class="fc-settings-item js-fc-image-toggle">
                                <i class="fas fa-image js-fc-image-icon"></i>
                                <span class="js-fc-image-text">Hiện ảnh</span>
                            </button>
                            <button class="fc-settings-item js-fc-autoplay-toggle">
                                <i class="fas fa-play js-fc-autoplay-icon"></i>
                                <span class="js-fc-autoplay-text">Tự động phát</span>
                            </button>
                            <button class="fc-settings-item js-fc-stats-toggle">
                                <i class="fas fa-chart-line js-fc-stats-icon"></i>
                                <span class="js-fc-stats-text">Ẩn tiến độ</span>
                            </button>
                            <button class="fc-settings-item open-feedback-modal-btn js-fc-feedback-btn">
                                <i class="fas fa-flag"></i>
                                <span>Báo lỗi thẻ</span>
                            </button>
                            <button class="fc-settings-item edit-card-btn js-fc-edit-btn">
                                <i class="fas fa-pencil-alt"></i>
                                <span>Sửa thẻ</span>
                            </button>
                        </div>
                    </div>
                    <!-- Home and Exit buttons outside dropdown -->
                    <a href="/" class="fc-nav-btn" title="Trang chủ">
                        <i class="fas fa-house" style="font-size: 0.75rem;"></i>
                    </a>
                    <a href="javascript:history.back()" class="fc-nav-btn" title="Thoát">
                        <i class="fas fa-right-from-bracket" style="font-size: 0.75rem;"></i>
                    </a>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="fc-stats-row">
                <div class="fc-stat-item">
                    <span class="fc-stat-label">Tiến độ</span>
                    <span class="fc-stat-value js-fc-progress">0/0</span>
                </div>
                <div class="fc-stat-divider"></div>
                <div class="fc-stat-item">
                    <span class="fc-stat-label">Đã thuộc</span>
                    <span class="fc-stat-value learned js-fc-learned">0</span>
                </div>
                <div class="fc-stat-divider"></div>
                <div class="fc-stat-item">
                    <span class="fc-stat-label">Học lại</span>
                    <span class="fc-stat-value relearn js-fc-relearn">0</span>
                </div>
                <div class="fc-stat-divider"></div>
                <div class="fc-title-group">
                    <span class="fc-title-label">Bộ thẻ</span>
                    <span class="fc-title-text js-fc-title">{{ container_name }}</span>
                </div>
            </div>
        </div>

        <div class="session-layout">
            <div class="flashcard-wrapper">
                <div class="card-surface">
                    <div class="flashcard-panel">
                        <div class="js-flashcard-content">
                            <div class="flex flex-col items-center justify-center h-full text-orange-500 min-h-[300px]">
                                <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                                <p>Đang tải thẻ...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% include 'vocab_flashcard/individual/session/_card_mobile.html' %}
        </div>
    </div>

    <!-- Fixed Bottom Bar -->
    <div class="fc-bottom-bar">
        <!-- Flip Button (shown on front) -->
        <button class="fc-flip-btn js-fc-flip-btn">
            <i class="fas fa-sync-alt"></i>
            <span>Lật thẻ</span>
        </button>

        <!-- Rating Buttons (shown on back) - dynamically populated by JavaScript -->
        <div class="fc-rating-btns js-fc-rating-btns" id="mobile-rating-btns">
            <!-- Buttons will be generated dynamically based on user_button_count -->
        </div>
    </div>
</div>

<script>
    (function () {
        // Generate rating buttons dynamically based on user_button_count
        function generateMobileRatingButtons() {
            const container = document.getElementById('mobile-rating-btns');
            if (!container) return;

            const buttonCount = window.userButtonCount || 3;

            const buttonSets = {
                3: [
                    { cssClass: 'again', value: '1', label: 'Quên', icon: 'fas fa-times' },
                    { cssClass: 'hard', value: '2', label: 'Mơ hồ', icon: 'fas fa-question' },
                    { cssClass: 'good', value: '3', label: 'Nhớ', icon: 'fas fa-check' }
                ],
                4: [
                    { cssClass: 'again', value: '1', label: 'Học lại', icon: 'fas fa-undo' },
                    { cssClass: 'hard', value: '2', label: 'Khó', icon: 'fas fa-fire' },
                    { cssClass: 'good', value: '3', label: 'Ổn', icon: 'fas fa-thumbs-up' },
                    { cssClass: 'easy', value: '4', label: 'Dễ', icon: 'fas fa-smile' }
                ],
                6: [
                    { cssClass: 'again', value: '1', label: 'Rất khó', icon: 'fas fa-exclamation-circle' },
                    { cssClass: 'hard', value: '2', label: 'Khó', icon: 'fas fa-fire' },
                    { cssClass: 'medium', value: '3', label: 'TB', icon: 'fas fa-adjust' },
                    { cssClass: 'good', value: '4', label: 'Dễ', icon: 'fas fa-leaf' },
                    { cssClass: 'easy', value: '5', label: 'Rất dễ', icon: 'fas fa-thumbs-up' },
                    { cssClass: 'veryeasy', value: '6', label: 'Dễ dàng', icon: 'fas fa-star' }
                ]
            };

            const buttons = buttonSets[buttonCount] || buttonSets[3];
            container.innerHTML = buttons.map(btn =>
                `<button class="fc-rating-btn ${btn.cssClass} js-rating-btn" data-rating="${btn.value}">
                    <i class="${btn.icon}"></i>
                    <span>${btn.label}</span>
                </button>`
            ).join('');
        }

        // Wait for window.userButtonCount to be set
        function initMobileRatingButtons() {
            if (typeof window.userButtonCount !== 'undefined') {
                generateMobileRatingButtons();
                setupRatingButtonHandlers();
            } else {
                setTimeout(initMobileRatingButtons, 100);
            }
        }

        // Connect bottom bar buttons to existing flashcard logic
        const flipBtn = document.querySelector('.js-fc-flip-btn');
        const ratingBtnsContainer = document.querySelector('.js-fc-rating-btns');

        if (flipBtn) {
            flipBtn.addEventListener('click', function () {
                // Directly add flipped class to the card in MOBILE VIEW
                const mobileView = document.querySelector('.flashcard-mobile-view');
                const card = mobileView ? mobileView.querySelector('.js-flashcard-card') : null;
                const actions = mobileView ? mobileView.querySelector('.js-internal-actions') : null;

                if (card) {
                    card.classList.add('flipped');
                }
                if (actions) {
                    actions.classList.add('visible');
                }

                // Show rating buttons, hide flip
                flipBtn.style.display = 'none';
                ratingBtnsContainer.classList.add('show');
            });
        }

        // Setup rating button handlers after buttons are generated
        function setupRatingButtonHandlers() {
            const ratingBtns = document.querySelectorAll('.js-rating-btn');
            ratingBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const rating = btn.dataset.rating;
                    // Map our rating (1-6) to the answer values used by the card
                    const buttonCount = window.userButtonCount || 3;
                    let answerMap;
                    if (buttonCount === 3) {
                        answerMap = { '1': 'quên', '2': 'mơ_hồ', '3': 'nhớ' };
                    } else if (buttonCount === 4) {
                        answerMap = { '1': 'again', '2': 'hard', '3': 'good', '4': 'easy' };
                    } else {
                        // 6 buttons
                        answerMap = { '1': 'fail', '2': 'very_hard', '3': 'hard', '4': 'medium', '5': 'good', '6': 'very_easy' };
                    }
                    const answerValue = answerMap[rating] || 'good';

                    // Call submitFlashcardAnswer directly instead of simulating button click
                    if (window.currentFlashcardBatch &&
                        typeof window.currentFlashcardIndex !== 'undefined' &&
                        typeof window.submitFlashcardAnswer === 'function') {
                        const card = window.currentFlashcardBatch[window.currentFlashcardIndex];
                        if (card && card.item_id) {
                            window.submitFlashcardAnswer(card.item_id, answerValue);
                        }
                    }

                    // Reset for next card (will also be done by flashcardStatsUpdated event)
                    setTimeout(() => {
                        flipBtn.style.display = 'flex';
                        ratingBtnsContainer.classList.remove('show');
                    }, 100);
                });
            });
        }

        // Initialize rating buttons
        initMobileRatingButtons();

        // Update stats from custom event dispatched by main script
        function updateMobileStats(stats) {
            if (!stats) return;
            // Update progress
            document.querySelectorAll('.js-fc-progress').forEach(el => {
                el.textContent = stats.progress || '0/0';
            });
            // Update learned (correct answers)
            document.querySelectorAll('.js-fc-learned').forEach(el => {
                el.textContent = stats.correct || 0;
            });
            // Update relearn (incorrect + vague)
            document.querySelectorAll('.js-fc-relearn').forEach(el => {
                el.textContent = (stats.incorrect || 0) + (stats.vague || 0);
            });
        }

        // Reset mobile card state when new card loads
        function resetMobileCardState() {
            const mobileView = document.querySelector('.flashcard-mobile-view');
            if (!mobileView) return;

            // Remove flipped class from card
            const card = mobileView.querySelector('.js-flashcard-card');
            if (card) {
                card.classList.remove('flipped');
            }

            // Hide actions
            const actions = mobileView.querySelector('.js-internal-actions');
            if (actions) {
                actions.classList.remove('visible');
            }

            // Reset bottom bar - show flip button, hide rating buttons
            if (flipBtn) {
                flipBtn.style.display = 'flex';
            }
            if (ratingBtnsContainer) {
                ratingBtnsContainer.classList.remove('show');
            }
        }

        // Listen for stats update event (fired when new card loads)
        document.addEventListener('flashcardStatsUpdated', function (e) {
            updateMobileStats(e.detail);
            // Reset card state for new card
            resetMobileCardState();
        });

        // Initial update from window if available
        setTimeout(function () {
            if (window.flashcardSessionStats) {
                updateMobileStats(window.flashcardSessionStats);
            }
        }, 1000);

        // Audio button in header - play current card audio
        const audioBtn = document.querySelector('.js-fc-audio-btn');
        if (audioBtn) {
            audioBtn.addEventListener('click', function () {
                const mobileView = document.querySelector('.flashcard-mobile-view');
                // Check if flipped, play back audio, else play front audio
                const card = mobileView ? mobileView.querySelector('.js-flashcard-card') : null;
                const isFlipped = card && card.classList.contains('flipped');
                const audioTarget = isFlipped ? '#back-audio' : '#front-audio';
                const audioEl = mobileView ? mobileView.querySelector(audioTarget) : null;

                if (audioEl && audioEl.src) {
                    audioEl.currentTime = 0;
                    audioEl.play();
                }
            });
        }

        // Note button in header - open note panel for current card
        const noteBtn = document.querySelector('.js-fc-note-btn');
        if (noteBtn) {
            noteBtn.addEventListener('click', function () {
                if (window.currentFlashcardBatch &&
                    typeof window.currentFlashcardIndex !== 'undefined' &&
                    typeof window.openNotePanel === 'function') {
                    const card = window.currentFlashcardBatch[window.currentFlashcardIndex];
                    if (card && card.item_id) {
                        window.openNotePanel(card.item_id);
                    }
                }
            });
        }

        // Settings dropdown toggle
        const settingsToggle = document.querySelector('.js-fc-settings-toggle');
        const settingsMenu = document.querySelector('.js-fc-settings-menu');

        if (settingsToggle && settingsMenu) {
            settingsToggle.addEventListener('click', function (e) {
                e.stopPropagation();
                settingsMenu.classList.toggle('show');
            });

            // Close when clicking outside
            document.addEventListener('click', function () {
                settingsMenu.classList.remove('show');
            });

            settingsMenu.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        // Image toggle with dynamic text/icon
        const imageToggleBtn = document.querySelector('.js-fc-image-toggle');
        const imageIcon = document.querySelector('.js-fc-image-icon');
        const imageText = document.querySelector('.js-fc-image-text');

        // Get initial state from localStorage
        const storedImageHidden = localStorage.getItem('flashcardHideImages');
        let isImageHidden = storedImageHidden === 'true';

        function updateImageToggleUI() {
            if (imageIcon) {
                imageIcon.className = isImageHidden ? 'fas fa-eye js-fc-image-icon' : 'fas fa-eye-slash js-fc-image-icon';
            }
            if (imageText) {
                imageText.textContent = isImageHidden ? 'Hiện ảnh' : 'Ẩn ảnh';
            }
        }

        function applyImageVisibility() {
            const mediaContainers = document.querySelectorAll('.media-container');
            mediaContainers.forEach(container => {
                container.style.display = isImageHidden ? 'none' : '';
            });
        }

        // Apply initial state
        applyImageVisibility();
        updateImageToggleUI();

        if (imageToggleBtn) {
            imageToggleBtn.addEventListener('click', function () {
                isImageHidden = !isImageHidden;
                localStorage.setItem('flashcardHideImages', isImageHidden);
                applyImageVisibility();
                updateImageToggleUI();
            });
        }

        // Re-apply image visibility when new cards load
        document.addEventListener('flashcardStatsUpdated', function () {
            setTimeout(applyImageVisibility, 100);
        });

        // Audio autoplay toggle with dynamic text/icon
        const autoplayToggleBtn = document.querySelector('.js-fc-autoplay-toggle');
        const autoplayIcon = document.querySelector('.js-fc-autoplay-icon');
        const autoplayText = document.querySelector('.js-fc-autoplay-text');

        // Get initial state from localStorage
        const storedAutoplay = localStorage.getItem('flashcardAutoplayAudio');
        let isAutoplayOn = storedAutoplay === 'true';

        function updateAutoplayToggleUI() {
            if (autoplayIcon) {
                // When ON: show volume-up (audio playing), when OFF: show volume-mute (audio off)
                autoplayIcon.className = isAutoplayOn ? 'fas fa-volume-up js-fc-autoplay-icon' : 'fas fa-volume-mute js-fc-autoplay-icon';
            }
            if (autoplayText) {
                autoplayText.textContent = isAutoplayOn ? 'Tắt tự động' : 'Tự động phát';
            }
        }
        updateAutoplayToggleUI();

        if (autoplayToggleBtn) {
            autoplayToggleBtn.addEventListener('click', function () {
                isAutoplayOn = !isAutoplayOn;
                localStorage.setItem('flashcardAutoplayAudio', isAutoplayOn);
                // Try to call global toggle function if exists
                if (typeof window.toggleAudioAutoplay === 'function') {
                    window.toggleAudioAutoplay();
                }
                updateAutoplayToggleUI();
            });
        }

        // Stats row toggle
        const statsToggleBtn = document.querySelector('.js-fc-stats-toggle');
        const statsIcon = document.querySelector('.js-fc-stats-icon');
        const statsText = document.querySelector('.js-fc-stats-text');
        const statsRow = document.querySelector('.fc-stats-row');
        let isStatsHidden = false;

        function updateStatsToggleUI() {
            if (statsIcon) {
                statsIcon.className = isStatsHidden ? 'fas fa-chart-line js-fc-stats-icon' : 'fas fa-chart-line js-fc-stats-icon';
            }
            if (statsText) {
                statsText.textContent = isStatsHidden ? 'Hiện tiến độ' : 'Ẩn tiến độ';
            }
            if (statsRow) {
                statsRow.style.display = isStatsHidden ? 'none' : 'flex';
            }
        }

        if (statsToggleBtn) {
            statsToggleBtn.addEventListener('click', function () {
                isStatsHidden = !isStatsHidden;
                updateStatsToggleUI();
            });
        }

        // Feedback button - call existing function
        const feedbackBtn = document.querySelector('.js-fc-feedback-btn');
        if (feedbackBtn) {
            feedbackBtn.addEventListener('click', function () {
                if (typeof window.openFeedbackModal === 'function' &&
                    window.currentFlashcardBatch &&
                    typeof window.currentFlashcardIndex !== 'undefined') {
                    const card = window.currentFlashcardBatch[window.currentFlashcardIndex];
                    if (card) {
                        window.openFeedbackModal(card.item_id, card.content?.front || '');
                    }
                }
            });
        }

        // Edit button - construct URL and open modal
        const editBtn = document.querySelector('.js-fc-edit-btn');
        if (editBtn) {
            // Use Jinja2 generated URL template same as index.html
            const editUrlTemplate = "{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=0, item_id=0) }}";
            editBtn.addEventListener('click', function () {
                if (window.currentFlashcardBatch &&
                    typeof window.currentFlashcardIndex !== 'undefined') {
                    const card = window.currentFlashcardBatch[window.currentFlashcardIndex];
                    if (card && card.item_id && card.container_id) {
                        // Replace placeholder IDs with actual values
                        const editUrl = editUrlTemplate.replace('/0', '/' + card.container_id).replace('/0', '/' + card.item_id) + '?is_modal=true';
                        if (typeof window.openModal === 'function') {
                            window.openModal(editUrl);
                        } else if (window.parent && typeof window.parent.openModal === 'function') {
                            window.parent.openModal(editUrl);
                        } else {
                            // Fallback: navigate directly
                            window.location.href = editUrl;
                        }
                    }
                }
            });
        }

        // Render session answer history list in mobile stats
        function renderSessionHistoryList() {
            const container = document.getElementById('session-history-list-mobile');
            if (!container) return;

            const history = window.sessionAnswerHistory || [];

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-slate-400">
                        <i class="fas fa-list-alt text-2xl mb-2"></i>
                        <p class="text-sm">Trả lời thẻ để xem lịch sử.</p>
                    </div>`;
                return;
            }

            // Render history items in reverse order (newest first)
            const historyHtml = history.slice().reverse().map((item, index) => {
                const scoreClass = item.scoreChange > 0 ? 'text-emerald-600' : (item.scoreChange < 0 ? 'text-rose-600' : 'text-slate-500');
                const scoreIcon = item.scoreChange > 0 ? 'fa-plus' : (item.scoreChange < 0 ? 'fa-minus' : 'fa-equals');
                const scoreText = item.scoreChange > 0 ? `+${item.scoreChange}` : item.scoreChange;
                const orderNum = history.length - index;

                return `
                    <div class="bg-white rounded-xl border border-slate-100 p-3 shadow-sm">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="text-xs text-slate-400 mb-1">#${orderNum}</div>
                                <p class="text-sm font-semibold text-slate-800 truncate">${item.front}</p>
                                <p class="text-xs text-slate-500 mt-1">Đáp án: <span class="font-medium">${item.answer}</span></p>
                            </div>
                            <div class="flex-shrink-0 text-right">
                                <div class="${scoreClass} font-bold text-lg">
                                    <i class="fas ${scoreIcon} text-xs mr-0.5"></i>${Math.abs(item.scoreChange)}
                                </div>
                            </div>
                        </div>
                    </div>`;
            }).join('');

            container.innerHTML = historyHtml;
        }

        // Update history when new card is answered
        document.addEventListener('flashcardStatsUpdated', function () {
            renderSessionHistoryList();
        });
    })();
</script>