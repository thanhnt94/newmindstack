{% extends "base.html" %}

{% block title %}Quiz Battle Dashboard{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* === Style đồng bộ Content Management (CM) + nâng cấp thẩm mỹ === */
    /* Container & Layout */
    .cm-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        box-shadow: none;
        overflow: hidden;
    }

    .cm-card--padded {
        padding: 1.25rem;
    }

    .cm-section-header {
        margin-bottom: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    @media (min-width: 768px) {
        .cm-section-header {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
    }

    /* Hero */
    .collab-hero {
        position: relative;
        overflow: hidden;
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        background: #f8fafc;
        color: #0f172a;
        border: 1px solid #e2e8f0;
    }

    .collab-hero__content {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    @media (min-width: 900px) {
        .collab-hero__content {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }
    }

    .collab-hero__headline {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    @media (min-width: 640px) {
        .collab-hero__headline {
            flex-direction: row;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: wrap;
        }
    }

    .collab-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        background: #e2e8f0;
        color: #0f172a;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        font-size: 0.72rem;
    }

    .collab-pill i {
        color: #6366f1;
        /* Indigo for Quiz */
    }

    .collab-eyebrow {
        font-size: 0.72rem;
        letter-spacing: 0.04em;
        font-weight: 700;
        text-transform: uppercase;
        color: #475569;
    }

    .collab-heading {
        font-size: clamp(1.05rem, 2vw, 1.35rem);
        font-weight: 800;
        margin: 0;
        color: #0f172a;
    }

    .collab-subheading {
        color: #334155;
        line-height: 1.35;
        max-width: 640px;
        font-size: 0.9rem;
    }

    .collab-hero__actions {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    @media (min-width: 640px) {
        .collab-hero__actions {
            flex-direction: row;
            align-items: center;
            flex-wrap: wrap;
        }
    }

    /* Typography */
    .cm-heading-group {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .cm-eyebrow {
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #3b82f6;
    }

    .cm-heading {
        font-size: 1.6rem;
        line-height: 2rem;
        font-weight: 700;
        color: #0f172a;
    }

    .cm-subheading {
        font-size: 0.9rem;
        color: #475569;
    }

    /* Grid & Cards */
    .cm-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.2rem;
    }

    @media (min-width: 640px) {
        .cm-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1100px) {
        .cm-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .cm-collection-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.9rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
        height: 100%;
        position: relative;
        transition: border-color 0.15s ease, transform 0.15s ease;
        color: #0f172a;
        box-shadow: none;
        overflow: hidden;
    }

    .cm-collection-card:hover {
        transform: translateY(-2px);
        border-color: #cbd5e1;
    }

    /* Meta Tags */
    .cm-collection-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
        align-items: center;
        font-size: 0.8rem;
        color: #475569;
    }

    .cm-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.35rem 0.7rem;
        border-radius: 0.75rem;
        background: #e2e8f0;
        color: #0f172a;
        font-weight: 600;
        border: 1px solid #cbd5e1;
    }

    .cm-tag i {
        font-size: 0.75rem;
        color: #6366f1;
    }

    .cm-divider {
        height: 1px;
        background: #e2e8f0;
        margin: 0.2rem 0;
    }

    /* Buttons */
    .cm-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.55rem 0.95rem;
        border-radius: 0.75rem;
        font-weight: 700;
        font-size: 0.9rem;
        transition: background-color 0.15s ease, color 0.15s ease, transform 0.15s ease;
        white-space: nowrap;
        border: 1px solid transparent;
    }

    .cm-action-btn--primary {
        background: #6366f1;
        color: white;
        box-shadow: none;
        border-color: #4f46e5;
    }

    .cm-action-btn--primary:hover {
        background: #4f46e5;
        color: white;
        transform: translateY(-1px);
    }

    /* Custom Elements for Collab */
    .collab-main-header {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 0.75rem 1rem 0.25rem;
        background: #f8fafc;
        border-radius: 0.75rem 0.75rem 0 0;
        position: sticky;
        top: 0;
        z-index: 5;
        border-bottom: 1px solid #e5e7eb;
    }

    @media (min-width: 900px) {
        .collab-main-header {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
    }

    .collab-tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .collab-tab-btn {
        padding: 0.7rem 1.1rem;
        font-weight: 700;
        color: #475569;
        border-bottom: 2px solid transparent;
        transition: color 0.15s ease, border-color 0.15s ease;
        font-size: 0.92rem;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
    }

    .collab-tab-btn:hover {
        color: #0f172a;
    }

    .collab-tab-btn.active {
        color: #6366f1;
        border-bottom-color: #6366f1;
    }

    .collab-toolbar {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: flex-start;
    }

    .collab-toolbar .search-wrapper {
        min-width: 260px;
    }

    .join-input-group {
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.65rem;
        padding: 0.25rem 0.35rem;
        box-shadow: none;
    }

    .join-input-group input {
        border: none;
        outline: none;
        padding: 0.4rem 0.55rem;
        font-size: 0.9rem;
        width: 140px;
        text-transform: uppercase;
        font-family: 'DM Mono', 'Roboto Mono', monospace;
        background: transparent;
        color: #0f172a;
        letter-spacing: 0.08em;
    }

    .join-input-group button {
        border-radius: 0.55rem;
    }

    /* Modal */
    .collab-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    .collab-modal-backdrop.open {
        opacity: 1;
        pointer-events: auto;
    }

    .collab-modal-content {
        background: white;
        border-radius: 1rem;
        width: 95%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.95);
        transition: transform 0.3s;
    }

    .collab-modal-backdrop.open .collab-modal-content {
        transform: scale(1);
    }

    .status-badge {
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        padding: 0.22rem 0.6rem;
        border-radius: 0.6rem;
        letter-spacing: 0.04em;
    }

    .status-badge.lobby {
        background: #e0f2fe;
        color: #0369a1;
        border: 1px solid #bfdbfe;
    }

    .status-badge.active {
        background: #dcfce7;
        color: #15803d;
        border: 1px solid #bbf7d0;
    }

    .status-badge.completed {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }

    #collab-loading {
        transition: opacity 0.15s ease;
        pointer-events: none;
        opacity: 0;
        display: none;
    }

    #collab-loading.visible {
        display: flex;
        pointer-events: auto;
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-7xl">

    {# === HERO === #}
    <section class="collab-hero mb-6">
        <div class="collab-hero__content">
            <div class="collab-hero__headline">
                <div class="collab-pill"><i class="fas fa-bolt fa-beat-fade"></i>Real-time Arena</div>
                <p class="collab-eyebrow">Đấu trường tri thức</p>
                <h2 class="collab-heading">Quiz Battle: Tranh tài cùng bạn bè</h2>
            </div>
            <div class="collab-hero__actions">
                {# Khung nhập mã nhanh #}
                <form id="qb-quick-join-form" class="join-input-group">
                    <i class="fas fa-hashtag text-slate-200 pl-2 text-xs"></i>
                    <input type="text" id="qb-quick-join-code" placeholder="Mã phòng..." maxlength="12" required>
                    <button type="submit"
                        class="text-xs font-bold bg-white/90 hover:bg-white text-slate-800 px-3 py-1.5 rounded transition-colors">VÀO</button>
                </form>

                {# Nút tạo phòng #}
                <button type="button" id="open-create-room-modal" class="cm-action-btn cm-action-btn--primary">
                    <i class="fas fa-plus"></i><span>Tạo phòng đấu</span>
                </button>
            </div>
        </div>
    </section>

    {# === MAIN CONTENT (TABS & GRID) === #}
    <div class="cm-card rounded-t-none border-t-0 relative min-h-[400px]">
        {# Tabs + search #}
        <div class="collab-main-header">
            <div class="collab-tabs">
                <button type="button" class="collab-tab-btn active" data-qb-tab="public">
                    <i class="fas fa-globe mr-2"></i>Phòng đang mở
                </button>
                <button type="button" class="collab-tab-btn" data-qb-tab="my">
                    <i class="fas fa-user-astronaut mr-2"></i>Phòng của tôi
                </button>
            </div>
            <div class="collab-toolbar">
                <div class="search-wrapper relative">
                    <input type="text" id="qb-room-search"
                        class="w-full pl-9 pr-3 py-1.5 rounded-lg border border-slate-200 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                        placeholder="Tìm tên phòng...">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                </div>
                <div
                    class="text-xs text-slate-500 bg-white px-3 py-1.5 rounded-lg border border-slate-200 flex items-center gap-2">
                    <i class="fas fa-bullseye text-indigo-500"></i> Danh sách phòng
                </div>
            </div>
        </div>

        {# Content #}
        <div class="p-6 relative">
            {# Loading Overlay #}
            <div id="collab-loading"
                class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center rounded-b-xl">
                <div class="text-center text-indigo-500">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-2"></i>
                    <p class="font-medium">Đang tải dữ liệu...</p>
                </div>
            </div>

            {# Grid hiển thị phòng #}
            <div id="qb-rooms-grid" class="cm-grid">
            </div>

            {# Phân trang #}
            <div id="collab-pagination-container" class="mt-8">
            </div>

            {# Empty State #}
            <div id="collab-empty-template" class="hidden">
                <div
                    class="col-span-full flex flex-col items-center justify-center p-12 text-slate-400 border border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                    <i class="fas fa-gamepad text-4xl mb-3 opacity-50"></i>
                    <h3 class="text-lg font-semibold text-slate-600">Không tìm thấy phòng nào</h3>
                    <p class="text-sm mb-4">Hãy thử tìm kiếm khác hoặc tạo phòng mới.</p>
                    <button type="button" onclick="document.getElementById('open-create-room-modal').click()"
                        class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-indigo-600 font-bold text-sm hover:bg-indigo-50 transition-colors shadow-sm">
                        <i class="fas fa-plus-circle mr-2"></i>Tạo phòng đấu
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{# === CREATE ROOM MODAL === #}
<div id="create-room-modal" class="collab-modal-backdrop">
    <div class="collab-modal-content">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-20">
            <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-gamepad text-indigo-500 mr-2"></i>Thiết lập
                phòng đấu</h3>
            <button type="button" id="close-create-room-modal"
                class="text-slate-400 hover:text-rose-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="p-6 grid lg:grid-cols-2 gap-8">
            {# Cột trái: Form #}
            <div class="space-y-5">
                <form id="battle-settings-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Tên phòng</label>
                        <input type="text" name="title"
                            class="w-full rounded-lg border-slate-200 px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500"
                            placeholder="VD: Đại chiến kiến thức..." required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Chế độ</label>
                            <select name="mode" id="battle-mode"
                                class="w-full rounded-lg border-slate-200 px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="SLOW">Test chậm (Cơ bản)</option>
                                <option value="TIMED">Tính giờ (Kịch tính)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Quyền truy cập</label>
                            <select name="visibility"
                                class="w-full rounded-lg border-slate-200 px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="private">Riêng tư (Cần mã)</option>
                                <option value="public">Công khai</option>
                            </select>
                        </div>
                    </div>

                    <div id="timed-config" class="hidden p-3 bg-amber-50 border border-amber-100 rounded-lg">
                        <label class="block text-xs font-bold text-amber-800 mb-1"><i
                                class="fas fa-stopwatch mr-1"></i>Thời gian mỗi câu (giây)</label>
                        <input type="number" min="5" name="time_per_question_seconds"
                            class="w-full rounded border-amber-200 px-2 py-1 text-sm focus:border-amber-500 focus:ring-amber-500"
                            placeholder="VD: 30">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giới hạn câu hỏi</label>
                        <input type="number" min="1" name="question_limit"
                            class="w-full rounded-lg border-slate-200 px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500"
                            placeholder="Để trống nếu muốn dùng hết bộ">
                    </div>

                    <input type="hidden" name="container_id" id="selected-container-id">

                    <div class="pt-4 border-t border-slate-100">
                        <p class="text-xs text-slate-500 mb-3 flex justify-between items-center">
                            <span>Bộ Quiz đã chọn:</span>
                            <span id="selected-quiz-label" class="font-bold text-rose-600 italic">Chưa chọn</span>
                        </p>
                        <button type="submit"
                            class="w-full cm-action-btn cm-action-btn--primary justify-center py-2.5 shadow-lg shadow-indigo-600/10">
                            <i class="fas fa-rocket"></i><span>Tạo Phòng Ngay</span>
                        </button>
                        <p id="room-creation-result" class="mt-2 text-sm text-center"></p>
                    </div>
                </form>
            </div>

            {# Cột phải: Chọn bộ thẻ #}
            <div class="flex flex-col h-full min-h-[400px]">
                <div class="flex items-center justify-between gap-2 mb-3">
                    <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide">Chọn bộ Quiz</h4>
                    <div class="relative">
                        <input type="text" id="quiz-search-input"
                            class="w-40 rounded-md border-slate-200 pl-7 py-1 text-xs focus:border-indigo-500"
                            placeholder="Tìm bộ quiz...">
                        <i class="fas fa-search absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    </div>
                </div>

                <div id="quiz-selection-grid"
                    class="flex-1 overflow-y-auto pr-2 space-y-2 border border-slate-100 rounded-xl p-2 bg-slate-50/50 max-h-[400px]">
                    <p class="text-center text-slate-400 py-8 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Đang
                        tải...</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    console.log('>>> quiz_dashboard.js: init (v2.0 - CMS Style)');

    const qbUrls = {
        quizSets: "{{ url_for('learning.quiz_battle.list_available_quizzes') }}",
        create: "{{ url_for('learning.quiz_battle.create_room') }}",
        public: "{{ url_for('learning.quiz_battle.list_public_rooms') }}",
        my: "{{ url_for('learning.quiz_battle.list_my_active_rooms') }}",
        join: "{{ url_for('learning.quiz_battle.join_room', room_code='__ROOM_CODE__') }}",
        view: "{{ url_for('learning.quiz_battle.view_room', room_code='__ROOM_CODE__') }}"
    };
    const qbCsrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // State
    let qbState = {
        currentTab: 'public',
        searchQuery: '',
        roomsData: { public: [], my: [] },
        filteredRooms: [],
        pagination: { page: 1, limit: 6 },
        selectedQuizId: null,
        searchQuizTimeout: null
    };

    // --- RENDER UI ---

    function renderRoomCard(room) {
        const participants = room.participants || [];
        const statusMap = { lobby: 'Đang mở', in_progress: 'Đang thi', completed: 'Đã xong' };
        const statusClass = `status-badge ${room.status}`;
        const modeLabel = room.mode === 'TIMED' ? 'Tính giờ' : 'Cơ bản';
        const visibilityIcon = room.is_public ? '<i class="fas fa-globe text-indigo-500"></i>' : '<i class="fas fa-lock text-slate-400"></i>';

        return `
        <article class="cm-collection-card group">
            <div class="flex items-start gap-3">
                <div class="w-11 h-11 rounded-xl bg-slate-100 text-slate-700 flex items-center justify-center text-xl shrink-0">
                    <i class="fas fa-gamepad"></i>
                </div>
                <div class="min-w-0 flex-1 space-y-1">
                    <div class="flex items-center gap-2 mb-1">
                        ${visibilityIcon}
                        <span class="${statusClass}">${statusMap[room.status] || room.status}</span>
                        <span class="text-[11px] font-semibold tracking-[0.12em] uppercase text-slate-700 bg-white px-2 py-0.5 rounded-full border border-slate-200">${modeLabel}</span>
                    </div>
                    <h3 class="truncate text-lg font-bold text-slate-900" title="${room.title}">${room.title || 'Phòng không tên'}</h3>
                    <p class="text-xs text-slate-600 truncate flex items-center gap-1"><i class="fas fa-list-ol"></i> ${room.question_total} câu hỏi</p>
                </div>
            </div>
            <div class="cm-collection-meta mt-auto">
                <span class="cm-tag"><i class="fas fa-users"></i> ${participants.length} người</span>
                <span class="cm-tag"><i class="fas fa-crown text-amber-500"></i> ${room.host_username || 'Ẩn'}</span>
            </div>
            <div class="cm-divider"></div>
            <div class="flex items-center justify-between gap-2">
                 <div class="text-xs font-mono bg-white px-3 py-1.5 rounded border border-slate-200 text-slate-700 flex items-center gap-2 select-all cursor-pointer hover:border-slate-300 hover:text-slate-900 transition-colors" onclick="handleCopyRoomCode('${room.room_code}')">
                    <i class="fas fa-copy text-indigo-500"></i> ${room.room_code}
                 </div>
                 <button type="button" class="cm-action-btn cm-action-btn--primary py-1.5 px-3 text-xs" onclick="joinRoom('${room.room_code}')">
                    <span>Tham gia</span> <i class="fas fa-arrow-right"></i>
                 </button>
            </div>
        </article>
        `;
    }

    function renderPagination() {
        const { page, limit } = qbState.pagination;
        const totalItems = qbState.filteredRooms.length;
        const totalPages = Math.ceil(totalItems / limit);
        const container = document.getElementById('collab-pagination-container');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = `<div class="flex justify-center items-center space-x-2 mt-6 pagination">`;
        if (page > 1) html += `<button onclick="changePage(${page - 1})" class="px-3 py-1 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100">&laquo;</button>`;
        else html += `<span class="px-3 py-1 rounded-md border border-gray-200 text-gray-400 cursor-not-allowed">&laquo;</span>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= page - 1 && i <= page + 1)) {
                if (i === page) html += `<span class="px-3 py-1 rounded-md border border-indigo-500 bg-indigo-500 text-white">${i}</span>`;
                else html += `<button onclick="changePage(${i})" class="px-3 py-1 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100">${i}</button>`;
            } else if (i === page - 2 || i === page + 2) {
                html += `<span class="px-3 py-1 text-gray-700">...</span>`;
            }
        }

        if (page < totalPages) html += `<button onclick="changePage(${page + 1})" class="px-3 py-1 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100">&raquo;</button>`;
        else html += `<span class="px-3 py-1 rounded-md border border-gray-200 text-gray-400 cursor-not-allowed">&raquo;</span>`;

        html += `</div>`;
        container.innerHTML = html;
    }

    function renderMainGrid() {
        const grid = document.getElementById('qb-rooms-grid');
        const emptyTpl = document.getElementById('collab-empty-template');

        let sourceData = qbState.roomsData[qbState.currentTab];
        if (qbState.searchQuery) {
            const q = qbState.searchQuery.toLowerCase();
            qbState.filteredRooms = sourceData.filter(r =>
                (r.title && r.title.toLowerCase().includes(q)) ||
                (r.room_code && r.room_code.toLowerCase().includes(q))
            );
        } else {
            qbState.filteredRooms = sourceData;
        }

        if (qbState.filteredRooms.length === 0) {
            grid.innerHTML = emptyTpl.innerHTML;
            document.getElementById('collab-pagination-container').innerHTML = '';
            return;
        }

        const { page, limit } = qbState.pagination;
        const start = (page - 1) * limit;
        const end = start + limit;
        const itemsToShow = qbState.filteredRooms.slice(start, end);

        grid.innerHTML = itemsToShow.map(renderRoomCard).join('');
        renderPagination();
    }

    // --- LOGIC ---

    async function fetchRooms(type) {
        const loader = document.getElementById('collab-loading');
        if (loader) loader.classList.add('visible');

        try {
            const res = await fetch(qbUrls[type]);
            if (!res.ok) throw new Error();
            const data = await res.json();
            qbState.roomsData[type] = data.rooms || [];
            qbState.pagination.page = 1;

            if (qbState.currentTab === type) renderMainGrid();
        } catch (err) {
            console.error(err);
        } finally {
            if (loader) loader.classList.remove('visible');
        }
    }

    function changePage(pageNum) {
        qbState.pagination.page = pageNum;
        renderMainGrid();
        document.querySelector('.collab-tabs').scrollIntoView({ behavior: 'smooth' });
    }

    function switchTab(tabName) {
        qbState.currentTab = tabName;
        qbState.pagination.page = 1;

        document.querySelectorAll('.collab-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.qbTab === tabName);
        });

        if (qbState.roomsData[tabName].length === 0) {
            fetchRooms(tabName);
        } else {
            renderMainGrid();
        }
    }

    async function joinRoom(code) {
        if (!code) return;
        const cleanCode = code.trim().toUpperCase();
        try {
            const res = await fetch(qbUrls.join.replace('__ROOM_CODE__', cleanCode), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': qbCsrfToken }
            });
            if (!res.ok) throw new Error(await res.text());
            window.location.href = qbUrls.view.replace('__ROOM_CODE__', cleanCode);
        } catch (err) {
            alert('Không thể vào phòng: ' + err.message);
        }
    }

    function handleCopyRoomCode(code) {
        navigator.clipboard.writeText(code);
        // Optional: Show toast
    }

    // --- QUIZ SELECTION ---

    function selectQuiz(id, title) {
        qbState.selectedQuizId = id;
        document.getElementById('selected-container-id').value = id;
        document.getElementById('selected-quiz-label').innerHTML = `Bộ Quiz: <span class="font-bold text-indigo-600">${title}</span>`;

        const items = document.getElementById('quiz-selection-grid').children;
        for (let item of items) {
            if (item.innerHTML.includes(title)) {
                item.className = "p-3 rounded-lg border cursor-pointer transition-all border-indigo-500 bg-indigo-50";
            } else {
                item.className = "p-3 rounded-lg border cursor-pointer transition-all border-slate-200 bg-white hover:border-indigo-300";
            }
        }
    }

    async function loadQuizSets(query = '') {
        const grid = document.getElementById('quiz-selection-grid');
        if (query) grid.innerHTML = '<p class="text-center text-slate-400 py-8 text-xs"><i class="fas fa-spinner fa-spin"></i></p>';
        try {
            const url = new URL(qbUrls.quizSets, window.location.origin);
            if (query) url.searchParams.set('q', query);

            const res = await fetch(url);
            if (!res.ok) throw new Error();
            const data = await res.json();
            const containers = data.containers || [];

            if (!containers.length) {
                grid.innerHTML = `<div class="text-center text-slate-400 py-4 text-xs">Không tìm thấy bộ quiz.</div>`;
                return;
            }

            grid.innerHTML = containers.map(c => `
                <div class="p-3 rounded-lg border border-slate-200 bg-white hover:border-indigo-300 cursor-pointer transition-all"
                     onclick="selectQuiz('${c.container_id}', '${c.title.replace(/'/g, "\\'")}')">
                    <div class="flex justify-between items-start gap-2">
                        <h5 class="text-sm font-semibold text-slate-900 line-clamp-1" title="${c.title}">${c.title}</h5>
                        <div class="w-4 h-4 rounded-full border border-slate-300"></div>
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs text-slate-500">
                        <span><i class="fas fa-list-ol"></i> ${c.question_count || '?'} câu</span>
                        <span class="uppercase tracking-wider text-[10px]">${c.is_public ? 'Public' : 'Private'}</span>
                    </div>
                </div>
            `).join('');
        } catch {
            grid.innerHTML = `<p class="text-center text-rose-400 py-4 text-xs">Lỗi tải dữ liệu.</p>`;
        }
    }

    // --- INIT ---

    document.addEventListener('DOMContentLoaded', () => {
        fetchRooms('public');
        loadQuizSets();

        // Tabs
        document.querySelectorAll('.collab-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.qbTab));
        });

        // Search
        const searchInput = document.getElementById('qb-room-search');
        if (searchInput) {
            let timeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    qbState.searchQuery = searchInput.value.trim();
                    qbState.pagination.page = 1;
                    renderMainGrid();
                }, 300);
            });
        }

        // Quick Join
        document.getElementById('qb-quick-join-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            joinRoom(document.getElementById('qb-quick-join-code').value);
        });

        // Modal
        const modal = document.getElementById('create-room-modal');
        document.getElementById('open-create-room-modal')?.addEventListener('click', () => {
            modal.classList.add('open');
            loadQuizSets();
        });
        document.getElementById('close-create-room-modal')?.addEventListener('click', () => modal.classList.remove('open'));

        // Create Form
        const modeSelect = document.getElementById('battle-mode');
        const timedConfig = document.getElementById('timed-config');
        modeSelect?.addEventListener('change', (e) => {
            timedConfig.classList.toggle('hidden', e.target.value !== 'TIMED');
        });

        document.getElementById('battle-settings-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultBox = document.getElementById('room-creation-result');

            if (!qbState.selectedQuizId) {
                resultBox.innerHTML = `<span class="text-rose-600">Vui lòng chọn bộ Quiz!</span>`;
                return;
            }

            resultBox.innerHTML = `<span class="text-indigo-600"><i class="fas fa-spinner fa-spin"></i> Đang tạo phòng...</span>`;

            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());

            if (!payload.question_limit) delete payload.question_limit;
            if (payload.mode !== 'TIMED') delete payload.time_per_question_seconds;

            try {
                const res = await fetch(qbUrls.create, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': qbCsrfToken },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                window.location.href = qbUrls.view.replace('__ROOM_CODE__', data.room.room_code);
            } catch (err) {
                resultBox.innerHTML = `<span class="text-rose-600">Lỗi: ${err.message}</span>`;
            }
        });

        // Quiz Search
        document.getElementById('quiz-search-input')?.addEventListener('input', (e) => {
            clearTimeout(qbState.searchQuizTimeout);
            qbState.searchQuizTimeout = setTimeout(() => loadQuizSets(e.target.value.trim()), 300);
        });
    });
</script>
{% endblock %}