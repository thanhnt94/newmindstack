{# =============================== #}
{# File: mindstack_app/modules/learning/quiz/templates/_dashboard_collab.html #}
{# Mục đích: Giao diện Quiz Battle (Group) - Style CMS. #}
{# =============================== #}

{% from 'includes/_search_form.html' import render_search_form %}

<style>
    /* === Style CMS cho Battle === */
    .cm-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
    .cm-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 768px) { .cm-grid { grid-template-columns: repeat(2, 1fr); } }
    
    .cm-collection-card {
        background: #fff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.25rem;
        display: flex; flex-direction: column; gap: 1rem; height: 100%; position: relative; transition: all 0.2s ease;
    }
    .cm-collection-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #cbd5e1; }
    
    .cm-tag { display: inline-flex; items-center; gap: 0.375rem; padding: 0.25rem 0.625rem; border-radius: 999px; background: #f1f5f9; color: #475569; font-weight: 500; border: 1px solid #e2e8f0; font-size: 0.75rem; }
    .cm-action-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s; white-space: nowrap; }
    .cm-action-btn--primary { background: #0ea5e9; color: white; }
    .cm-action-btn--primary:hover { background: #0284c7; }

    .collab-tabs { display: flex; border-bottom: 1px solid #e5e7eb; background: white; border-radius: 0.75rem 0.75rem 0 0; padding: 0 1rem; margin-top: 1rem; }
    .collab-tab-btn { padding: 1rem 1.5rem; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; transition: all 0.2s; font-size: 0.9rem; }
    .collab-tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }

    .status-badge { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 0.2rem 0.6rem; border-radius: 999px; }
    .status-badge.lobby { background: #dbeafe; color: #1e40af; }
    .status-badge.in_progress { background: #dcfce7; color: #166534; }
    .status-badge.completed { background: #f1f5f9; color: #64748b; }

    .join-input-group { display: flex; align-items: center; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .join-input-group input { border: none; outline: none; padding: 0.25rem 0.5rem; font-size: 0.875rem; width: 120px; text-transform: uppercase; font-family: monospace; }
    
    /* Modal */
    .collab-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .collab-modal-backdrop.open { opacity: 1; pointer-events: auto; }
    .collab-modal-content { background: white; border-radius: 1rem; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
    .collab-modal-backdrop.open .collab-modal-content { transform: scale(1); }
</style>

<div id="quiz-group-section" class="hidden w-full space-y-6">
    
    {# === HEADER === #}
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div>
            <span class="text-xs font-bold text-blue-500 uppercase tracking-wider">Quiz Battle</span>
            <h2 class="text-3xl font-bold text-gray-900">Đấu trường tri thức</h2>
            <p class="text-sm text-gray-500">Tham gia các phòng thi đấu trực tiếp.</p>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-3 items-center">
            {# Khung nhập mã #}
            <form id="battle-quick-join-form" class="join-input-group">
                <i class="fas fa-key text-slate-400 pl-2 text-xs"></i>
                <input type="text" id="battle-quick-join-code" placeholder="Mã phòng..." maxlength="12" required>
                <button type="submit" class="text-xs font-bold bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded transition-colors">VÀO</button>
            </form>

            <div class="h-8 w-px bg-slate-200 hidden sm:block"></div>

            {# Nút tạo phòng #}
            <button type="button" id="open-battle-modal" class="cm-action-btn cm-action-btn--primary shadow-md shadow-blue-500/20">
                <i class="fas fa-plus"></i><span>Tạo phòng đấu</span>
            </button>
        </div>
    </div>

    {# === SEARCH === #}
    <div class="cm-card p-4 bg-slate-50 border-b-0 rounded-b-none">
        <div class="w-full md:w-2/3 lg:w-1/2 mx-auto">
            <div id="battle-search-wrapper">
                {{ render_search_form(placeholder="Tìm kiếm phòng thi...", search_field='all') }}
            </div>
        </div>
    </div>

    {# === CONTENT === #}
    <div class="cm-card rounded-t-none border-t-0 relative min-h-[400px]">
        <div class="collab-tabs">
            <button type="button" class="collab-tab-btn active" data-battle-tab="public"><i class="fas fa-globe mr-2"></i>Phòng công khai</button>
            <button type="button" class="collab-tab-btn" data-battle-tab="my"><i class="fas fa-user-check mr-2"></i>Phòng của tôi</button>
        </div>

        <div class="p-6">
            <div id="battle-rooms-grid" class="cm-grid"></div>
            <div id="battle-pagination-container" class="mt-8"></div>
            <div id="battle-empty-template" class="hidden">
                <div class="col-span-full flex flex-col items-center justify-center p-12 text-slate-400 border border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                    <i class="fas fa-ghost text-4xl mb-3 opacity-50"></i>
                    <h3 class="text-lg font-semibold text-slate-600">Chưa có phòng nào</h3>
                    <p class="text-sm">Hãy tạo phòng mới để bắt đầu tranh tài.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{# === MODAL TẠO PHÒNG === #}
<div id="create-battle-modal" class="collab-modal-backdrop">
    <div class="collab-modal-content">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-20">
            <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-bolt text-yellow-500 mr-2"></i>Thiết lập trận đấu</h3>
            <button type="button" id="close-battle-modal" class="text-slate-400 hover:text-rose-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="p-6 grid lg:grid-cols-2 gap-8">
            <div class="space-y-5">
                <form id="battle-create-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Tên phòng</label>
                        <input type="text" name="title" class="w-full rounded-lg border-slate-200 px-3 py-2 focus:border-blue-500" placeholder="Đấu trường Quiz..." required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Số câu</label><input type="number" name="question_limit" class="w-full rounded-lg border-slate-200 px-3 py-2" placeholder="All"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Max người</label><input type="number" name="max_players" class="w-full rounded-lg border-slate-200 px-3 py-2" placeholder="∞"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Chế độ</label>
                        <select name="mode" id="modal-battle-mode" class="w-full rounded-lg border-slate-200 px-3 py-2 bg-white">
                            <option value="SLOW">Test chậm (Đồng bộ)</option>
                            <option value="TIMED">Giới hạn thời gian</option>
                        </select>
                    </div>
                    <div id="modal-timed-config" class="hidden">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giây/Câu</label>
                        <input type="number" name="time_per_question_seconds" class="w-full rounded-lg border-slate-200 px-3 py-2" placeholder="30">
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-slate-700 mb-2">Hiển thị</span>
                        <div class="flex gap-4 p-2 bg-slate-50 rounded border border-slate-100">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="visibility" value="public"> Công khai</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="visibility" value="private" checked> Riêng tư</label>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-slate-100">
                        <input type="hidden" name="container_id" id="modal-selected-quiz-id">
                        <p class="text-xs mb-3 flex justify-between"><span>Bộ Quiz:</span> <span id="modal-quiz-preview" class="font-bold text-rose-600">Chưa chọn</span></p>
                        <button type="submit" class="w-full cm-action-btn cm-action-btn--primary justify-center py-2.5 bg-emerald-600 hover:bg-emerald-700"><i class="fas fa-check"></i> Tạo phòng</button>
                        <p id="battle-create-feedback" class="mt-2 text-sm text-center text-rose-600"></p>
                    </div>
                </form>
            </div>

            <div class="flex flex-col h-full min-h-[400px]">
                <div class="flex items-center justify-between gap-2 mb-3">
                    <h4 class="text-sm font-bold text-slate-700 uppercase">Chọn bộ đề</h4>
                    <input type="text" id="modal-quiz-search" class="w-40 rounded border-slate-200 px-2 py-1 text-xs" placeholder="Tìm...">
                </div>
                <div id="modal-quiz-grid" class="flex-1 overflow-y-auto pr-2 space-y-2 border border-slate-100 rounded-xl p-2 bg-slate-50/50 max-h-[400px]"></div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('>>> _dashboard_collab.js: init (Battle Mode)');

const battleUrls = {
    public: "{{ url_for('learning.quiz_battle.list_public_rooms') }}",
    my: "{{ url_for('learning.quiz_battle.list_my_active_rooms') }}",
    quizzes: "{{ url_for('learning.quiz_battle.list_available_quizzes') }}",
    create: "{{ url_for('learning.quiz_battle.create_room') }}",
    joinTemplate: "{{ url_for('learning.quiz_battle.join_room', room_code='__ROOM_CODE__') }}",
    viewTemplate: "{{ url_for('learning.quiz_battle.view_room', room_code='__ROOM_CODE__') }}"
};
const battleCsrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

let battleState = {
    currentTab: 'public',
    rooms: { public: [], my: [] },
    filtered: [],
    searchQuery: '',
    pagination: { page: 1, limit: 6 },
    selectedQuizId: null,
    searchTimeout: null
};

function renderBattleRoom(room) {
    const statusLabels = { lobby: 'Sảnh chờ', in_progress: 'Đang thi', completed: 'Xong' };
    const statusClass = `status-badge ${room.status}`;
    const visibilityIcon = room.is_public ? '<i class="fas fa-globe text-blue-400"></i>' : '<i class="fas fa-lock text-slate-400"></i>';
    
    return `
        <article class="cm-collection-card">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-2 mb-1">${visibilityIcon}<span class="${statusClass}">${statusLabels[room.status] || room.status}</span></div>
                    <h3 class="font-bold text-slate-900 truncate text-lg" title="${room.title}">${room.title}</h3>
                    <p class="text-xs text-slate-500 mt-1"><i class="fas fa-layer-group"></i> ${room.container_title || 'Quiz Set #' + room.container_id}</p>
                </div>
            </div>
            <div class="cm-collection-meta mt-auto">
                <span class="cm-tag"><i class="fas fa-stopwatch"></i> ${room.mode === 'TIMED' ? 'Tính giờ' : 'Thường'}</span>
                <span class="cm-tag"><i class="fas fa-users"></i> ${(room.participants || []).length}</span>
                <span class="cm-tag"><i class="fas fa-crown text-yellow-500"></i> ${room.host_username || 'Admin'}</span>
            </div>
            <div class="cm-divider"></div>
            <div class="flex justify-between items-center">
                <div class="text-xs font-mono bg-slate-100 px-2 py-1 rounded select-all cursor-pointer hover:bg-blue-50" onclick="navigator.clipboard.writeText('${room.room_code}')">${room.room_code}</div>
                <button class="cm-action-btn cm-action-btn--primary text-xs py-1.5 px-3" onclick="joinBattleRoom('${room.room_code}')">Vào ngay <i class="fas fa-arrow-right"></i></button>
            </div>
        </article>
    `;
}

function renderBattlePagination() {
    const { page, limit } = battleState.pagination;
    const total = battleState.filtered.length;
    const totalPages = Math.ceil(total / limit);
    const container = document.getElementById('battle-pagination-container');
    if (totalPages <= 1) { container.innerHTML = ''; return; }
    let html = `<div class="flex justify-center items-center space-x-2 mt-6 pagination">`;
    html += `<button ${page===1?'disabled':''} onclick="changeBattlePage(${page-1})" class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 disabled:opacity-50">&laquo;</button>`;
    for(let i=1; i<=totalPages; i++) html += `<button onclick="changeBattlePage(${i})" class="px-3 py-1 rounded border ${i===page?'border-blue-500 bg-blue-500 text-white':'border-gray-300 hover:bg-gray-100'}">${i}</button>`;
    html += `<button ${page===totalPages?'disabled':''} onclick="changeBattlePage(${page+1})" class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 disabled:opacity-50">&raquo;</button></div>`;
    container.innerHTML = html;
}

function renderBattleGrid() {
    const grid = document.getElementById('battle-rooms-grid');
    const empty = document.getElementById('battle-empty-template');
    const source = battleState.rooms[battleState.currentTab];
    const q = battleState.searchQuery.toLowerCase();
    battleState.filtered = source.filter(r => (r.title && r.title.toLowerCase().includes(q)) || r.room_code.toLowerCase().includes(q));
    
    if (!battleState.filtered.length) { grid.innerHTML = empty.innerHTML; document.getElementById('battle-pagination-container').innerHTML = ''; return; }
    
    const { page, limit } = battleState.pagination;
    const items = battleState.filtered.slice((page-1)*limit, page*limit);
    grid.innerHTML = items.map(renderBattleRoom).join('');
    renderBattlePagination();
}

async function fetchBattleRooms(type) {
    try {
        const res = await fetch(battleUrls[type]);
        if(!res.ok) throw new Error();
        const data = await res.json();
        battleState.rooms[type] = data.rooms || [];
        if(battleState.currentTab === type) { battleState.pagination.page = 1; renderBattleGrid(); }
    } catch(e) { console.error(e); }
}

function changeBattlePage(p) { if(p < 1) return; battleState.pagination.page = p; renderBattleGrid(); }
function switchBattleTab(tab) {
    battleState.currentTab = tab;
    document.querySelectorAll('.collab-tab-btn').forEach(b => b.classList.toggle('active', b.dataset.battleTab === tab));
    if(!battleState.rooms[tab].length) fetchBattleRooms(tab); else renderBattleGrid();
}

async function joinBattleRoom(code) {
    if(!code) return;
    try {
        const res = await fetch(battleUrls.joinTemplate.replace('__ROOM_CODE__', code), { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': battleCsrf } });
        if(!res.ok) throw new Error(await res.text());
        window.location.href = battleUrls.viewTemplate.replace('__ROOM_CODE__', code);
    } catch(e) { alert(e.message); }
}

const modal = document.getElementById('create-battle-modal');
function openBattleModal() { modal.classList.add('open'); loadBattleQuizzes(); }
function closeBattleModal() { modal.classList.remove('open'); }

async function loadBattleQuizzes(q='') {
    const grid = document.getElementById('modal-quiz-grid');
    if(q) grid.innerHTML = '<p class="text-center text-xs text-gray-400">Đang tìm...</p>';
    try {
        const url = new URL(battleUrls.quizzes, window.location.origin);
        url.searchParams.append('limit', 30);
        if(q) url.searchParams.append('q', q);
        const res = await fetch(url);
        const data = await res.json();
        grid.innerHTML = (data.containers || []).map(c => `
            <div class="p-2 border rounded cursor-pointer hover:bg-blue-50 transition flex justify-between items-center" onclick="selectBattleQuiz('${c.container_id}', '${c.title.replace(/'/g, "\\'")}')">
                <div><p class="font-semibold text-sm truncate w-48">${c.title}</p><p class="text-xs text-gray-500">${c.question_count} câu</p></div>
                ${battleState.selectedQuizId == c.container_id ? '<i class="fas fa-check-circle text-blue-500"></i>' : ''}
            </div>`).join('');
    } catch { grid.innerHTML = '<p class="text-center text-xs text-red-400">Lỗi tải quiz.</p>'; }
}

function selectBattleQuiz(id, title) {
    battleState.selectedQuizId = id;
    document.getElementById('modal-selected-quiz-id').value = id;
    document.getElementById('modal-quiz-preview').innerHTML = `<span class="text-emerald-600">${title}</span>`;
    loadBattleQuizzes(document.getElementById('modal-quiz-search').value);
}

function initGroupBattleDeck() {
    fetchBattleRooms('public');
    document.querySelectorAll('.collab-tab-btn').forEach(b => b.addEventListener('click', () => switchBattleTab(b.dataset.battleTab)));
    document.getElementById('battle-search-wrapper').querySelector('form').addEventListener('submit', e => { e.preventDefault(); battleState.searchQuery = e.target.elements.q.value; battleState.pagination.page = 1; renderBattleGrid(); });
    document.getElementById('battle-quick-join-form').addEventListener('submit', e => { e.preventDefault(); joinBattleRoom(document.getElementById('battle-quick-join-code').value.trim().toUpperCase()); });
    document.getElementById('open-battle-modal').addEventListener('click', openBattleModal);
    document.getElementById('close-battle-modal').addEventListener('click', closeBattleModal);
    document.getElementById('modal-quiz-search').addEventListener('input', e => { clearTimeout(battleState.searchTimeout); battleState.searchTimeout = setTimeout(() => loadBattleQuizzes(e.target.value), 300); });
    document.getElementById('modal-battle-mode').addEventListener('change', function() { document.getElementById('modal-timed-config').classList.toggle('hidden', this.value !== 'TIMED'); });
    document.getElementById('battle-create-form').addEventListener('submit', async e => {
        e.preventDefault();
        const fb = document.getElementById('battle-create-feedback');
        const fd = new FormData(e.target);
        const payload = Object.fromEntries(fd.entries());
        if(!payload.container_id) { fb.textContent = "Chưa chọn bộ quiz!"; return; }
        fb.textContent = "Đang tạo...";
        try {
            const res = await fetch(battleUrls.create, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': battleCsrf }, body: JSON.stringify(payload) });
            if(!res.ok) throw new Error(await res.text());
            const data = await res.json();
            window.location.href = battleUrls.viewTemplate.replace('__ROOM_CODE__', data.room.room_code);
        } catch(err) { fb.textContent = err.message; }
    });
}
</script>