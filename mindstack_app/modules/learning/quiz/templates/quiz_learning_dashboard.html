{# =============================== #}
{# File: mindstack_app/modules/learning/quiz_learning/templates/quiz_learning_dashboard.html #}
{# Phiên bản: 1.14 #}
{# Mục đích: Khắc phục lỗi font size và padding quá lớn trên di động. #}
{# ĐÃ SỬA: Tối ưu CSS cho tab, đảm bảo hiển thị trên một hàng và chữ to hơn. #}
{# =============================== #}

{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}

{% block title %}Học Quiz - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .selected-item {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .selected-mode {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .start-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .tab-filter-button.active { 
            border-bottom: 2px solid #3b82f6; 
            color: #3b82f6; 
        }
        .tab-filter-button {
            transition: all 0.2s ease-in-out;
            color: #6b7280;
            font-weight: 500;
        }
        
        .quiz-title-wrapper { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 2rem; 
            width: 100%;
        }
        .quiz-title-badge {
            width: 100%;
            max-width: 100%;
            background: #e0f2fe;
            color: #1e3a8a;
            font-size: 2rem;
            font-weight: 800;
            padding: 0.75rem 2.5rem;
            border-radius: 9999px;
            border: 2px solid #bfdbfe;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-shadow: none;
            letter-spacing: 0.05em;
            transition: all .3s ease;
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
        }
        .quiz-title-badge .fa-question-circle { 
            margin-right: .75rem;
            font-size: 2.25rem;
        }
        .quiz-title-badge:hover {
            box-shadow: 0 6px 14px rgba(30,58,138,0.20);
            border-color: #60a5fa;
            transform: translateY(-2px);
        }

        .study-mode-tabs {
            display: inline-flex;
            background: #e5e7eb;
            border-radius: 9999px;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .study-mode-tab {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            color: #4b5563;
            border: 1px solid transparent;
            background: transparent;
            transition: all 0.2s ease-in-out;
        }

        .study-mode-tab.active {
            background: #ffffff;
            color: #1d4ed8;
            border-color: #bfdbfe;
            box-shadow: 0 4px 6px rgba(0,0,0,0.06);
        }
        
        .quiz-set-item {
            position: relative;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        .quiz-set-item:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); transform: translateY(-2px); }

        .archive-icon {
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s ease;
        }
        .archive-icon:hover {
            color: #3b82f6;
        }
        .archived .archive-icon {
            color: #3b82f6;
        }
        
        .tabs-and-toggle-wrapper {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .tab-group {
            display: flex;
            flex-grow: 1;
            min-width: 0;
            overflow: hidden;
            flex-wrap: nowrap; /* ĐÃ SỬA */
        }
        .tab-filter-button {
            flex-grow: 1;
            flex-shrink: 1;
            padding: 0.75rem 0.5rem;
            text-align: center;
            white-space: nowrap;
            font-size: 0.875rem;
            overflow: hidden; /* THÊM MỚI */
            text-overflow: ellipsis; /* THÊM MỚI */
        }
        .tab-filter-button i {
            margin-right: 0.5rem;
        }
        .tab-filter-button span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        @media (max-width: 639px) {
            .tab-filter-button {
                font-size: 0.875rem !important; /* ĐÃ SỬA: Tăng font size */
                padding: 0.5rem 0.25rem !important;
            }
        }
        @media (min-width: 640px) {
            .tab-group {
                justify-content: space-between;
            }
            .tab-filter-button {
                font-size: 1rem;
            }
        }

        .selected-sets-container {
            margin-bottom: 1rem;
            min-height: 2.5rem;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
            padding: 0.5rem;
            color: #4b5563;
            font-size: 0.875rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .selected-set-item {
            background-color: #dbeafe;
            color: #1e3a8a;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.25rem;
            display: inline-flex;
            align-items: center;
        }
        .selected-set-item i {
            margin-left: 0.5rem;
            font-size: 0.6rem;
            cursor: pointer;
        }

        /* THÊM MỚI: CSS tối ưu cho màn hình di động */
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }
            .quiz-title-wrapper {
                margin-bottom: 1rem;
            }
            .quiz-title-badge {
                font-size: 1.25rem;
                padding: 0.5rem 1rem;
            }
            .quiz-title-badge .fa-question-circle {
                font-size: 1.5rem;
                margin-right: 0.5rem;
            }
            .grid > div {
                padding: 0.5rem;
            }
            h2.sm\:text-2xl {
                font-size: 1.125rem; /* text-lg */
            }
            .p-6 {
                padding: 1rem;
            }
            .mb-4 {
                margin-bottom: 0.75rem;
            }
            .quiz-set-item {
                padding: 0.75rem;
            }
            .quiz-set-item .text-lg {
                font-size: 0.9rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-1 py-4 sm:px-6 sm:py-6 lg:px-8 lg:py-8">
    <div class="quiz-title-wrapper">
        <div id="quizTitle" class="quiz-title-badge"><i class="fas fa-question-circle"></i>Quiz</div>
    </div>

    <div class="flex justify-center mb-6">
        <div class="study-mode-tabs" role="tablist" aria-label="Chế độ làm quiz">
            <button class="study-mode-tab active" data-study-tab="solo" role="tab" aria-selected="true">Học 1 mình</button>
            <button class="study-mode-tab" data-study-tab="group" role="tab" aria-selected="false">Thi đấu nhóm</button>
        </div>
    </div>

    <div id="quiz-solo-section" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mx-auto max-w-full">
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                    <i class="fas fa-list-alt mr-3 text-blue-500"></i> Bước 1: Chọn một bộ câu hỏi
                </h2>
                <div class="mb-4">
                    <div class="tabs-and-toggle-wrapper">
                        <div class="tab-group">
                            <button id="filter-doing" class="tab-filter-button flex items-center justify-center {% if current_filter == 'doing' %}active{% endif %}" data-filter="doing"><i class="fas fa-play-circle mr-2"></i><span>Đang làm</span></button>
                            <button id="filter-explore" class="tab-filter-button flex items-center justify-center {% if current_filter == 'explore' %}active{% endif %}" data-filter="explore"><i class="fas fa-globe mr-2"></i><span>Khám phá</span></button>
                            <button id="filter-archive" class="tab-filter-button flex items-center justify-center {% if current_filter == 'archive' %}active{% endif %}" data-filter="archive"><i class="fas fa-archive mr-2"></i><span>Archive</span></button>
                        </div>
                    </div>
                </div>
                <div id="selected-sets-display" class="selected-sets-container hidden">
                    <span class="text-gray-500">Bộ quiz đã chọn:</span>
                </div>
                <div id="quiz-sets-container" class="flex-grow">
                    <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]">
                        <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                        <p>Đang tải danh sách bộ câu hỏi...</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                <h2 id="step-2-title" class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                    <i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học
                </h2>
                <div id="quiz-modes-container" class="flex-grow">
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                        <i class="fas fa-info-circle text-4xl mb-3"></i>
                        <p>Vui lòng chọn một bộ câu hỏi trước.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            <button id="start-learning-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" style="display: none;">
                <i class="fas fa-play-circle mr-3"></i> Bắt đầu làm bài
            </button>
            <button id="bulk-unarchive-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" style="display: none;">
                <i class="fas fa-box-open mr-3"></i> Bỏ lưu trữ
            </button>
        </div>
    </div>

    <div id="quiz-group-section" class="hidden">
        <div class="space-y-6">
            <div class="p-6 rounded-2xl border border-indigo-100 bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 shadow-inner flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="space-y-2">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/80 text-indigo-700 shadow-sm text-sm font-semibold">
                        <i class="fa-solid fa-bolt"></i>
                        <span>Thi đấu nhóm</span>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-900">Vào phòng nhanh, tạo trận riêng ngay trên dashboard</h2>
                    <p class="text-sm md:text-base text-slate-600 max-w-4xl">Danh sách phòng công khai và phòng bạn tham gia luôn hiển thị. Chỉ cần chọn một phòng hoặc tạo phòng mới để mời đội của bạn.</p>
                    <div class="flex flex-wrap gap-2 text-xs font-semibold">
                        <span class="px-3 py-1 rounded-full bg-white/80 text-emerald-600"><i class="fa-solid fa-shield-heart mr-2"></i>Khóa phòng linh hoạt</span>
                        <span class="px-3 py-1 rounded-full bg-white/80 text-amber-600"><i class="fa-solid fa-stopwatch mr-2"></i>Hai chế độ thi</span>
                        <span class="px-3 py-1 rounded-full bg-white/80 text-indigo-700"><i class="fa-solid fa-chart-line mr-2"></i>Điểm real-time</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                    <div class="px-4 py-3 rounded-2xl bg-white/80 shadow-sm">
                        <p class="text-slate-500">Phòng đang mở</p>
                        <p id="group-stat-public" class="text-2xl font-bold text-indigo-700">—</p>
                    </div>
                    <div class="px-4 py-3 rounded-2xl bg-white/80 shadow-sm">
                        <p class="text-slate-500">Phòng của bạn</p>
                        <p id="group-stat-mine" class="text-2xl font-bold text-purple-700">—</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                <div class="xl:col-span-2 space-y-6">
                    <section class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 space-y-4">
                        <div class="flex items-center justify-between gap-3">
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-indigo-600">Phòng công khai</p>
                                <h3 class="text-xl font-semibold text-slate-900">Vào trận tức thì</h3>
                                <p class="text-sm text-slate-500">Cập nhật liên tục các phòng mở để bạn có thể tham gia ngay.</p>
                            </div>
                            <button id="group-refresh-public" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold border border-slate-200 rounded-xl hover:bg-slate-50">
                                <i class="fa-solid fa-rotate"></i> Tải lại
                            </button>
                        </div>
                        <div id="group-public-rooms" class="space-y-3 text-sm text-slate-600">
                            <div class="flex items-center gap-3 p-4 rounded-xl bg-slate-50 border border-slate-100"><i class="fas fa-spinner fa-spin text-indigo-600"></i> Đang tải phòng công khai...</div>
                        </div>
                    </section>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <section class="bg-white rounded-2xl shadow-lg border border-slate-100 p-5 space-y-3">
                            <div class="flex items-center justify-between gap-3">
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.2em] text-purple-600">Phòng của bạn</p>
                                    <h4 class="text-lg font-semibold text-slate-900">Tiếp tục trận đang chơi</h4>
                                </div>
                                <button id="group-refresh-mine" class="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold border border-slate-200 rounded-xl hover:bg-slate-50">
                                    <i class="fa-solid fa-rotate"></i> Làm mới
                                </button>
                            </div>
                            <div id="group-my-rooms" class="space-y-3 text-sm text-slate-600">
                                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 border border-slate-100"><i class="fas fa-spinner fa-spin text-purple-600"></i> Đang kiểm tra phòng của bạn...</div>
                            </div>
                        </section>

                        <section class="bg-white rounded-2xl shadow-lg border border-slate-100 p-5 space-y-3">
                            <div class="flex items-center gap-2 text-sm font-semibold text-slate-800"><i class="fa-solid fa-key text-amber-500"></i> Tham gia bằng mã</div>
                            <form id="group-join-room-form" class="space-y-3">
                                <div>
                                    <label class="block text-xs font-semibold text-slate-600">Mã phòng</label>
                                    <input type="text" id="group-join-room-code" class="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2 uppercase tracking-[0.35em] focus:border-indigo-500 focus:ring-indigo-500" placeholder="ABC123" maxlength="12" required>
                                </div>
                                <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700">
                                    <i class="fa-solid fa-right-to-bracket"></i> Vào ngay
                                </button>
                            </form>
                        </section>
                    </div>
                </div>

                <div class="space-y-4">
                    <section class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="p-3 rounded-full bg-indigo-50 text-indigo-600"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-indigo-600">Tạo phòng nhanh</p>
                                <h4 class="text-xl font-bold text-slate-900">Chọn bộ quiz &amp; mở trận riêng</h4>
                                <p class="text-sm text-slate-500">Cấu hình thời gian, giới hạn người chơi và chế độ hiển thị ngay tại đây.</p>
                            </div>
                        </div>
                        <form id="group-create-room-form" class="space-y-4">
                            <div class="space-y-2">
                                <div class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                    <i class="fa-solid fa-layer-group text-indigo-500"></i>
                                    <span>Bộ câu hỏi</span>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <input type="text" id="group-quiz-search" class="rounded-xl border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Tìm nhanh tên bộ quiz hoặc tag...">
                                    <select id="group-quiz-select" class="rounded-xl border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white" required>
                                        <option>Đang tải danh sách bộ quiz...</option>
                                    </select>
                                </div>
                                <p id="group-quiz-helper" class="text-xs text-slate-500">Chọn bộ quiz để mở phòng. Chỉ hiển thị những bộ bạn có quyền truy cập.</p>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-xs font-semibold text-slate-600">Tiêu đề phòng</label>
                                <input type="text" id="group-room-title" class="w-full rounded-xl border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Quiz Battle tối nay" required>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div class="space-y-2">
                                    <label class="block text-xs font-semibold text-slate-600">Số câu hỏi (tuỳ chọn)</label>
                                    <input type="number" id="group-question-limit" min="1" class="w-full rounded-xl border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Để trống dùng toàn bộ">
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-xs font-semibold text-slate-600">Giới hạn người chơi</label>
                                    <input type="number" id="group-max-players" min="2" class="w-full rounded-xl border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Mặc định không giới hạn">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-end">
                                <div class="space-y-2">
                                    <label class="block text-xs font-semibold text-slate-600">Chế độ</label>
                                    <select id="group-battle-mode" class="w-full rounded-xl border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="SLOW">Test chậm (đợi mọi người)</option>
                                        <option value="TIMED">Giới hạn thời gian</option>
                                    </select>
                                </div>
                                <div id="group-time-wrapper" class="space-y-2 hidden">
                                    <label class="block text-xs font-semibold text-slate-600">Thời gian mỗi câu (giây)</label>
                                    <input type="number" id="group-time-per-question" min="5" class="w-full rounded-xl border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Ví dụ: 20">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-xs font-semibold text-slate-600">Hiển thị phòng</label>
                                <select id="group-room-visibility" class="w-full rounded-xl border border-slate-200 px-4 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="private">Riêng tư (chia sẻ mã)</option>
                                    <option value="public">Công khai</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700">
                                <i class="fa-solid fa-plus"></i> Tạo phòng &amp; vào ngay
                            </button>
                            <p id="group-room-feedback" class="text-sm"></p>
                        </form>
                    </section>

                    <section class="bg-white rounded-2xl shadow-lg border border-slate-100 p-5 space-y-3">
                        <div class="flex items-center gap-3">
                            <span class="w-10 h-10 rounded-2xl bg-amber-50 text-amber-600 flex items-center justify-center"><i class="fa-solid fa-lightbulb"></i></span>
                            <div>
                                <h5 class="font-semibold text-slate-900">Mẹo thi đấu đẹp mắt</h5>
                                <p class="text-sm text-slate-500">Tối ưu trải nghiệm nhóm với vài gợi ý nhỏ.</p>
                            </div>
                        </div>
                        <ul class="space-y-2 text-sm text-slate-600 list-disc list-inside">
                            <li>Tạo phòng công khai khi muốn tuyển thêm người chơi lạ.</li>
                            <li>Chọn chế độ giới hạn thời gian để so kè phản xạ.</li>
                            <li>Đặt tiêu đề ngắn gọn kèm tên đội để mọi người dễ nhận ra.</li>
                        </ul>
                        <div class="p-3 rounded-xl bg-slate-50 border border-slate-100 text-sm text-slate-700 flex items-start gap-3">
                            <i class="fa-solid fa-circle-info text-indigo-500 mt-0.5"></i>
                            <div>Tất cả thao tác tham gia, rời phòng và xem lịch sử đều gói gọn ngay tại bảng này.</div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    console.log('>>> quiz_learning_dashboard.js: init');

    {# ==== Biến trạng thái ==== #}
    let selectedQuizSetIds = [];
    let selectedQuizMode = null;
    let selectedSessionSize = parseInt("{{ user_default_batch_size | default(10) }}");
    let currentFilter = "{{ current_filter | default('doing') }}";
    let doingPage = 1; let explorePage = 1; let archivePage = 1; let currentPage = (currentFilter === 'doing' ? doingPage : (currentFilter === 'explore' ? explorePage : archivePage));
    let currentSearchQuery = "{{ search_query | default('') }}";
    let currentSearchField = "{{ search_field | default('all') }}";
    let isMultiSelectMode = true;
    let currentStudyMode = 'solo';

    const quizSetsContainer = document.getElementById('quiz-sets-container');
    const quizModesContainer = document.getElementById('quiz-modes-container');
    const startLearningBtn = document.getElementById('start-learning-btn');
    const bulkUnarchiveBtn = document.getElementById('bulk-unarchive-btn');
    const selectedSetsDisplay = document.getElementById('selected-sets-display');
    const step2Title = document.getElementById('step-2-title');
    const studyModeTabs = document.querySelectorAll('[data-study-tab]');
    const soloSection = document.getElementById('quiz-solo-section');
    const groupSection = document.getElementById('quiz-group-section');
    
    const rightPanel = document.querySelector('.lg\\:grid-cols-2 > div:nth-child(2)');

    let allSetsButton = null;

    const quizModesPartialBaseUrlById = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_by_id', set_id=0) or '#' }}";
    const quizModesPartialBaseUrlAll = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_all') or '#' }}";
    const quizModesPartialBaseUrlMulti = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_multi', set_ids_str='0') or '#' }}";
    const startQuizSessionBaseUrlAllTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_all', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlMultiTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_multi', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlByIdTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_by_id', set_id=0, mode='MODE_PLACEHOLDER') }}";
    const getQuizSetsPartialUrl = "{{ url_for('learning.quiz_learning.get_quiz_sets_partial') or '#' }}";
    const saveQuizSettingsUrl = "{{ url_for('learning.quiz_learning.save_quiz_settings') }}";
    const toggleArchiveUrl = "{{ url_for('learning.quiz_learning.toggle_archive', set_id=0) or '#' }}";
    const bulkUnarchiveUrl = "{{ url_for('learning.quiz_learning.bulk_unarchive') }}";
    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfHeaders = csrfTokenMeta ? { 'X-CSRFToken': csrfTokenMeta.getAttribute('content') } : {};

    const groupPublicRoomsContainer = document.getElementById('group-public-rooms');
    const groupMyRoomsContainer = document.getElementById('group-my-rooms');
    const groupRefreshPublicBtn = document.getElementById('group-refresh-public');
    const groupRefreshMineBtn = document.getElementById('group-refresh-mine');
    const groupJoinRoomForm = document.getElementById('group-join-room-form');
    const groupJoinRoomCodeInput = document.getElementById('group-join-room-code');
    const groupCreateRoomForm = document.getElementById('group-create-room-form');
    const groupQuizSelect = document.getElementById('group-quiz-select');
    const groupQuizSearch = document.getElementById('group-quiz-search');
    const groupRoomTitleInput = document.getElementById('group-room-title');
    const groupQuestionLimitInput = document.getElementById('group-question-limit');
    const groupMaxPlayersInput = document.getElementById('group-max-players');
    const groupBattleModeSelect = document.getElementById('group-battle-mode');
    const groupTimeWrapper = document.getElementById('group-time-wrapper');
    const groupTimePerQuestionInput = document.getElementById('group-time-per-question');
    const groupRoomVisibilitySelect = document.getElementById('group-room-visibility');
    const groupRoomFeedback = document.getElementById('group-room-feedback');
    const groupStatPublic = document.getElementById('group-stat-public');
    const groupStatMine = document.getElementById('group-stat-mine');
    const groupQuizHelper = document.getElementById('group-quiz-helper');

    const quizBattlePublicRoomsUrl = "{{ url_for('learning.quiz_battle.list_public_rooms') }}";
    const quizBattleMyRoomsUrl = "{{ url_for('learning.quiz_battle.list_my_active_rooms') }}";
    const quizBattleJoinRoomUrlTemplate = "{{ url_for('learning.quiz_battle.join_room', room_code='__ROOM_CODE__') }}";
    const quizBattleRoomViewUrlTemplate = "{{ url_for('learning.quiz_battle.view_room', room_code='__ROOM_CODE__') }}";
    const quizBattleCreateRoomUrl = "{{ url_for('learning.quiz_battle.create_room') }}";
    const quizBattleAvailableQuizzesUrl = "{{ url_for('learning.quiz_battle.list_available_quizzes') }}";

    let groupBattleInitialized = false;

    studyModeTabs.forEach((tab) => {
        tab.addEventListener('click', () => {
            const selectedMode = tab.dataset.studyTab;
            if (!selectedMode || selectedMode === currentStudyMode) return;

            currentStudyMode = selectedMode;
            studyModeTabs.forEach((btn) => {
                const isActive = btn.dataset.studyTab === selectedMode;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });

            if (selectedMode === 'solo') {
                soloSection.classList.remove('hidden');
                groupSection.classList.add('hidden');
                updateActionButtons();
            } else {
                soloSection.classList.add('hidden');
                groupSection.classList.remove('hidden');
                startLearningBtn.style.display = 'none';
                bulkUnarchiveBtn.style.display = 'none';
                if (!groupBattleInitialized) {
                    initGroupBattleDeck();
                } else {
                    refreshGroupRoomLists();
                }
            }
        });
    });

    function toggleAllSetsButtonVisibility() {
        if (!allSetsButton) {
            allSetsButton = document.querySelector('.quiz-set-item[data-set-id="all"]');
        }
        if (allSetsButton) {
            allSetsButton.style.display = (currentFilter === 'doing') ? 'flex' : 'none';
        }
    }
    
    async function loadQuizSets(page, searchQuery, searchField, filter) {
        console.log('loadQuizSets', page, searchQuery, searchField, filter);
        quizSetsContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải danh sách bộ câu hỏi...</p></div>';
        
        // Load selected IDs from localStorage on initial load
        if (localStorage.getItem('selectedQuizSetIds')) {
            selectedQuizSetIds = JSON.parse(localStorage.getItem('selectedQuizSetIds'));
        } else {
            selectedQuizSetIds = [];
        }

        selectedQuizSetId = null;
        updateSelectedSetsDisplay();

        updateActionButtons();

        if (!getQuizSetsPartialUrl || getQuizSetsPartialUrl === '#') {
            console.error('getQuizSetsPartialUrl không hợp lệ.');
            quizSetsContainer.innerHTML = '<p class="text-red-500 text-center">Lỗi cấu hình URL. Vui lòng liên hệ quản trị viên.</p>';
            return;
        }
        try {
            const url = new URL(getQuizSetsPartialUrl, window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('q', searchQuery || '');
            url.searchParams.append('search_field', searchField || 'all');
            url.searchParams.append('filter', filter || 'doing');
            url.searchParams.append('is_multi_select_mode', 'true');

            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const html = await response.text();
            quizSetsContainer.innerHTML = html;
            addQuizSetClickListeners();
            addPaginationAndSearchListeners();
            addArchiveIconListeners();
            updateQuizSetProgressColors();
            syncMultiSelectionUI();
            
            toggleAllSetsButtonVisibility();
        } catch (e) {
            console.error('Lỗi loadQuizSets:', e);
            quizSetsContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải danh sách bộ câu hỏi. Vui lòng thử lại.</p>';
        }
    }

    async function loadQuizModes(setId) {
        console.log('loadQuizModes ->', setId);
        if (currentFilter === 'archive') { return; } 
        quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải chế độ học...</p></div>';
        try {
            let url;
            if (Array.isArray(setId)) {
                if (setId.length === 0) {
                     quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
                     updateActionButtons();
                     return;
                }
                if (setId.length === 1 && setId[0] === 'all') {
                    url = quizModesPartialBaseUrlAll;
                } else {
                    const setIdsStr = setId.join(',');
                    url = quizModesPartialBaseUrlMulti.replace('/0', '/' + setIdsStr);
                }
            } else if (setId === 'all') {
                url = quizModesPartialBaseUrlAll;
            } else {
                url = quizModesPartialBaseUrlById.replace('/0', '/' + setId);
            }
            if (!url || url === '#') { throw new Error('URL chế độ học không hợp lệ'); }

            const fullUrl = new URL(url, window.location.origin);
            if (selectedQuizMode) { fullUrl.searchParams.append('selected_mode', selectedQuizMode); }
            fullUrl.searchParams.append('user_default_batch_size', selectedSessionSize);

            const response = await fetch(fullUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const html = await response.text();
            quizModesContainer.innerHTML = html;
            addQuizModeClickListeners();

            const sessionSizeSelect = document.getElementById('session-size-select');
            if (sessionSizeSelect) {
                sessionSizeSelect.value = selectedSessionSize;
                sessionSizeSelect.addEventListener('change', async function(){
                    selectedSessionSize = parseInt(this.value);
                    updateActionButtons();
                    try {
                        const headers = { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', ...csrfHeaders };
                        const res = await fetch(saveQuizSettingsUrl, { method: 'POST', headers, body: JSON.stringify({ batch_size: selectedSessionSize }) });
                        const contentType = res.headers.get('content-type') || '';
                        let js = {};
                        if (contentType.includes('application/json')) {
                            js = await res.json();
                        } else {
                            const raw = await res.text();
                            throw new Error(`INVALID_JSON_RESPONSE:${raw.slice(0, 200)}`);
                        }
                        if (!res.ok || !js.success) { console.error('Lưu batch_size lỗi:', js.message || res.statusText); }
                    } catch (err) { console.error('AJAX lưu batch_size lỗi:', err); }
                });
            }

            if (!selectedQuizMode) {
                const available = Array.from(quizModesContainer.querySelectorAll('.quiz-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                if (available.length > 0) { available[0].click(); }
                else { selectedQuizMode = null; updateActionButtons(); }
            } else {
                const prev = quizModesContainer.querySelector('[data-mode-id="' + selectedQuizMode + '"]');
                if (prev && parseInt(prev.dataset.count) > 0) { prev.click(); }
                else {
                    selectedQuizMode = null; updateActionButtons();
                    const available2 = Array.from(quizModesContainer.querySelectorAll('.quiz-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                    if (available2.length > 0) { available2[0].click(); }
                }
            }
        } catch (e) {
            console.error('Lỗi loadQuizModes:', e);
            quizModesContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải chế độ học. Vui lòng thử lại.</p>';
        }
    }

    function syncMultiSelectionUI() {
        if (isMultiSelectMode) {
            document.querySelectorAll('.quiz-set-item').forEach(item => {
                const setId = item.dataset.setId;
                if (selectedQuizSetIds.includes(setId)) {
                    item.classList.add('selected-item');
                } else {
                    item.classList.remove('selected-item');
                }
            });
            updateSelectedSetsDisplay();
        }
        document.querySelectorAll('.archive-icon').forEach(icon => {
            icon.style.display = (currentFilter === 'doing' || currentFilter === 'explore') ? '' : 'none';
        });
    }

    function updateSelectedSetsDisplay() {
        if (selectedQuizSetIds.length > 0) {
            selectedSetsDisplay.classList.remove('hidden');
            selectedSetsDisplay.innerHTML = `<span class="text-gray-500 mr-2">Bộ quiz đã chọn:</span>`;
            
            // Lấy thông tin chi tiết của các bộ đã chọn từ DOM hiện tại hoặc từ localStorage
            const allSelectedItems = new Map();
            document.querySelectorAll('.quiz-set-item').forEach(item => { // Lặp qua TẤT CẢ các item trên trang
                const setId = item.dataset.setId;
                if (selectedQuizSetIds.includes(setId)) {
                     const title = item.querySelector('h3').textContent;
                     allSelectedItems.set(setId, title);
                }
            });
            
            // Cải thiện logic để lấy thông tin từ localStorage nếu không có trên trang hiện tại
            selectedQuizSetIds.forEach(setId => {
                let title;
                if (allSelectedItems.has(setId)) {
                    title = allSelectedItems.get(setId);
                } else if (setId === 'all') {
                    title = 'Làm tất cả các bộ';
                } else {
                    // Lấy title từ localStorage nếu có
                    const storedTitles = JSON.parse(localStorage.getItem('selectedQuizSetTitles')) || {};
                    title = storedTitles[setId] || setId; // Dùng ID làm fallback
                }

                if (title) {
                    const selectedItemHtml = `
                        <div class="selected-set-item" data-set-id="${setId}">
                            <span>${title}</span>
                            <i class="fas fa-times-circle remove-selected-set"></i>
                        </div>
                    `;
                    selectedSetsDisplay.insertAdjacentHTML('beforeend', selectedItemHtml);
                }
            });
            
        } else {
            selectedSetsDisplay.classList.add('hidden');
        }

        document.querySelectorAll('.remove-selected-set').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const setIdToRemove = this.closest('.selected-set-item').dataset.setId;
                handleQuizSetSelection(setIdToRemove);
            });
        });
    }

    function handleQuizSetSelection(setId) {
        // Clear selection if "all" is selected and a new item is clicked
        if (setId !== 'all' && selectedQuizSetIds.includes('all')) {
            const allButton = document.querySelector('.quiz-set-item[data-set-id="all"]');
            if (allButton) {
                allButton.classList.remove('selected-item');
            }
            selectedQuizSetIds = [];
        }
        // Clear selection if an item is selected and "all" is clicked
        if (setId === 'all' && selectedQuizSetIds.some(id => id !== 'all')) {
            document.querySelectorAll('.quiz-set-item.selected-item').forEach(el => el.classList.remove('selected-item'));
            selectedQuizSetIds = [];
        }

        const item = document.querySelector(`.quiz-set-item[data-set-id="${setId}"]`);
        
        if (selectedQuizSetIds.includes(setId)) {
            selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setId);
            if (item) item.classList.remove('selected-item');
        } else {
            selectedQuizSetIds.push(setId);
            if (item) item.classList.add('selected-item');
        }
        
        // Cập nhật localStorage
        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
        // Lấy và lưu title vào localStorage
        const storedTitles = JSON.parse(localStorage.getItem('selectedQuizSetTitles')) || {};
        if (item) {
            storedTitles[setId] = item.querySelector('h3').textContent;
        }
        localStorage.setItem('selectedQuizSetTitles', JSON.stringify(storedTitles));


        selectedQuizMode = null;
        if (selectedQuizSetIds.length > 0 && currentFilter !== 'archive') {
            loadQuizModes(selectedQuizSetIds);
        } else {
            if (currentFilter !== 'archive') {
                quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ câu hỏi trước.</p></div>';
            } else {
                updateStep2Content();
            }
        }
        
        updateActionButtons();
        updateSelectedSetsDisplay();
        toggleAllSetsButtonVisibility();
    }


    function addQuizSetClickListeners() {
        document.querySelectorAll('.quiz-set-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                const totalItems = parseInt(this.dataset.totalItems);
                if (currentFilter !== 'doing' && this.dataset.setId === 'all') { 
                    ev.preventDefault(); ev.stopPropagation(); return; 
                }
                if (currentFilter !== 'archive' && totalItems === 0 && this.dataset.setId !== 'all') { 
                    ev.preventDefault(); ev.stopPropagation(); return; 
                }
                const setId = this.dataset.setId;
                handleQuizSetSelection(setId);
            });
        });
    }

    function addQuizModeClickListeners() {
        document.querySelectorAll('.quiz-mode-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                const modeCount = parseInt(this.dataset.count);
                if (modeCount === 0) {
                    ev.preventDefault();
                    ev.stopPropagation();
                    return;
                }
                document.querySelectorAll('.quiz-mode-item').forEach(function(el){ el.classList.remove('selected-mode'); });
                this.classList.add('selected-mode');
                selectedQuizMode = this.dataset.modeId;
                updateActionButtons();
            });
        });
    }

    function addPaginationAndSearchListeners() {
        const searchForm = quizSetsContainer.querySelector('form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e){
                e.preventDefault();
                // Save selected IDs to localStorage before leaving the page
                localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
                const data = new FormData(searchForm);
                currentSearchQuery = data.get('q') || '';
                currentSearchField = data.get('search_field') || 'all';
                if (currentFilter === 'doing') { doingPage = 1; } else if (currentFilter === 'explore') { explorePage = 1; } else { archivePage = 1; }
                currentPage = 1;
                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            });
        }
        document.querySelectorAll('.pagination a').forEach(function(a){
            a.addEventListener('click', function(e){
                e.preventDefault();
                // Save selected IDs to localStorage before leaving the page
                localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
                const url = new URL(this.href, window.location.origin);
                const page = parseInt(url.searchParams.get('page')) || 1;
                const q = url.searchParams.get('q') || '';
                const search_field = url.searchParams.get('search_field') || 'all';
                const filter = url.searchParams.get('filter') || 'doing';
                if (filter === 'doing') { doingPage = page; } else if (filter === 'explore') { explorePage = page; } else { archivePage = page; }
                currentPage = page;
                loadQuizSets(currentPage, q, search_field, filter);
            });
        });
    }

    function addArchiveIconListeners() {
        document.querySelectorAll('.archive-icon').forEach(function(icon){
            icon.addEventListener('click', async function(event){
                event.stopPropagation();
                const setId = this.dataset.setId;
                if (!setId) return;

                const url = toggleArchiveUrl.replace('/0', '/' + setId);

                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const itemElement = this.closest('.quiz-set-item');
                        if (currentFilter === 'archive' && !result.is_archived) {
                            itemElement.remove();
                        } else if ((currentFilter === 'doing' || currentFilter === 'explore') && result.is_archived) {
                            itemElement.remove();
                        } else {
                            if (result.is_archived) {
                                itemElement.classList.add('archived');
                                this.title = "Bỏ lưu trữ";
                                this.querySelector('i').classList.add('text-blue-500');
                                this.querySelector('i').classList.remove('text-gray-400');
                            } else {
                                itemElement.classList.remove('archived');
                                this.title = "Lưu trữ";
                                this.querySelector('i').classList.remove('text-blue-500');
                                this.querySelector('i').classList.add('text-gray-400');
                            }
                        }
                        
                        // Cập nhật lại danh sách ID đã chọn sau khi thay đổi trạng thái archive
                        selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setId);
                        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));

                        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);

                        window.showFlashMessage(result.message, 'success');

                    } else {
                        window.showFlashMessage(result.message || 'Có lỗi xảy ra khi cập nhật trạng thái lưu trữ.', 'danger');
                    }
                } catch (e) {
                    console.error('Lỗi AJAX toggle archive:', e);
                    window.showFlashMessage('Không thể kết nối đến máy chủ.', 'danger');
                }
            });
        });
    }

    function updateActionButtons() {
        const selectedCount = selectedQuizSetIds.length;
        const isSelected = selectedCount > 0;

        if (currentStudyMode === 'group') {
            startLearningBtn.style.display = 'none';
            bulkUnarchiveBtn.style.display = 'none';
            return;
        }

        if (currentFilter === 'archive') {                
            startLearningBtn.style.display = 'none';
            bulkUnarchiveBtn.style.display = 'block';
            if (isSelected) {
                bulkUnarchiveBtn.disabled = false;
                bulkUnarchiveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                bulkUnarchiveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                bulkUnarchiveBtn.disabled = true;
                bulkUnarchiveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                bulkUnarchiveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        } else {
            bulkUnarchiveBtn.style.display = 'none';
            startLearningBtn.style.display = 'block';
            const modeAvailable = selectedQuizMode !== null;
            const sessionSizeSelect = document.getElementById('session-size-select');
            const isSessionSizeSelected = sessionSizeSelect && sessionSizeSelect.value;
            
            if (isSelected && modeAvailable && isSessionSizeSelected) {
                startLearningBtn.disabled = false;
                startLearningBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                startLearningBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                startLearningBtn.disabled = true;
                startLearningBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                startLearningBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }
    }

    function updateQuizSetProgressColors() {
        document.querySelectorAll('.quiz-set-item').forEach(function(item){
            const pct = parseInt(item.dataset.completionPercentage || '0');
            const txt = item.querySelector('.quiz-set-completion-text');
            if (txt) { txt.style.color = (pct > 50 ? '#111' : '#333'); }
        });
    }
    
    // THAY ĐỔI: Thêm event listener cho nút Start để xóa localStorage
    startLearningBtn.addEventListener('click', function(){
        const currentBatchSize = document.getElementById('session-size-select').value;
        let startUrl;
        
        if (selectedQuizSetIds.length > 0 && selectedQuizMode) {
            localStorage.removeItem('selectedQuizSetIds'); // Xóa localStorage khi bắt đầu phiên học
            const setIdsStr = selectedQuizSetIds.join(',');
            if (selectedQuizSetIds.length === 1 && selectedQuizSetIds[0] === 'all') {
                startUrl = new URL(startQuizSessionBaseUrlAllTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            } else if (selectedQuizSetIds.length === 1 && selectedQuizSetIds[0] !== 'all') {
                startUrl = new URL(startQuizSessionBaseUrlByIdTemplate.replace('0', selectedQuizSetIds[0]).replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            } else {
                startUrl = new URL(startQuizSessionBaseUrlMultiTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
                startUrl.searchParams.append('set_ids', setIdsStr);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            }
            window.location.href = startUrl.toString();
        }
    });
    
    // THAY ĐỔI: Thêm event listener cho nút Unarchive để xóa localStorage
    bulkUnarchiveBtn.addEventListener('click', async function(){
        if (selectedQuizSetIds.length === 0) {
            window.showFlashMessage('Vui lòng chọn ít nhất một bộ quiz để bỏ lưu trữ.', 'warning');
            return;
        }

        try {
            const response = await fetch(bulkUnarchiveUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ set_ids: selectedQuizSetIds })
            });

            const result = await response.json();
            if (response.ok && result.success) {
                localStorage.removeItem('selectedQuizSetIds'); // Xóa localStorage sau khi bỏ lưu trữ
                window.showFlashMessage(result.message, 'success');
                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            } else {
                window.showFlashMessage(result.message || 'Có lỗi xảy ra khi bỏ lưu trữ.', 'danger');
            }
        } catch (e) {
            console.error('Lỗi khi bỏ lưu trữ hàng loạt:', e);
            window.showFlashMessage('Không thể kết nối đến máy chủ.', 'danger');
        }
    });

    function setGroupFeedback(message, tone = 'info') {
        if (!groupRoomFeedback) return;
        groupRoomFeedback.textContent = message || '';
        groupRoomFeedback.className = 'text-sm mt-1';
        if (!message) return;
        const toneClass = {
            success: 'text-emerald-600',
            danger: 'text-rose-600',
            info: 'text-slate-600'
        }[tone] || 'text-slate-600';
        groupRoomFeedback.classList.add(toneClass);
    }

    function toggleTimedFields() {
        const isTimed = groupBattleModeSelect?.value === 'TIMED';
        if (!groupTimeWrapper) return;
        groupTimeWrapper.classList.toggle('hidden', !isTimed);
    }

    function formatBattleStatus(status) {
        const statusLabels = {
            lobby: 'Sảnh chờ',
            in_progress: 'Đang diễn ra',
            awaiting_host: 'Chờ chủ phòng',
            completed: 'Đã kết thúc'
        };
        return statusLabels[status] || status || 'Không rõ';
    }

    function formatBattleMode(mode) {
        return mode === 'TIMED' ? 'Giới hạn thời gian' : 'Test chậm';
    }

    function updateGroupStats(publicCount = null, myCount = null) {
        if (groupStatPublic && publicCount !== null) {
            groupStatPublic.textContent = publicCount;
        }
        if (groupStatMine && myCount !== null) {
            groupStatMine.textContent = myCount;
        }
    }

    function renderGroupRooms(rooms, container, { emptyMessage = 'Chưa có phòng nào.', highlightPrivate = false } = {}) {
        if (!container) return;
        container.innerHTML = '';

        if (!rooms?.length) {
            container.innerHTML = `<div class="p-4 rounded-xl bg-slate-50 border border-slate-100 text-slate-500">${emptyMessage}</div>`;
            return;
        }

        rooms.forEach((room) => {
            const activePlayers = (room.participants || []).filter((p) => p.status === 'active').length;
            const viewUrl = quizBattleRoomViewUrlTemplate.replace('__ROOM_CODE__', encodeURIComponent(room.room_code));
            const statusColor = room.status === 'in_progress' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-700';
            const visibilityBadge = room.is_public ? '<span class="px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 text-[11px] font-semibold"><i class="fa-solid fa-earth-americas mr-1"></i>Công khai</span>' : '<span class="px-2 py-1 rounded-lg bg-rose-50 text-rose-700 text-[11px] font-semibold"><i class="fa-solid fa-lock mr-1"></i>Riêng tư</span>';

            const card = document.createElement('article');
            card.className = 'p-4 rounded-2xl border border-slate-100 shadow-sm bg-white';
            card.innerHTML = `
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <p class="text-sm font-semibold text-slate-900">${room.title || 'Quiz Battle'}</p>
                        <p class="text-xs text-slate-500">Mã phòng: <span class="font-mono tracking-widest">${room.room_code}</span></p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-[11px] font-semibold ${statusColor}">${formatBattleStatus(room.status)}</span>
                </div>
                <div class="flex flex-wrap items-center gap-2 text-[11px] font-semibold text-slate-600 mt-2">${visibilityBadge}</div>
                <div class="grid grid-cols-2 gap-3 text-xs text-slate-600 mt-3">
                    <div class="flex items-center gap-2"><span class="w-8 h-8 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center"><i class="fa-solid fa-users"></i></span><div><p class="font-semibold">${activePlayers}${room.max_players ? '/' + room.max_players : ''}</p><p class="text-[11px] text-slate-500">Đang hoạt động</p></div></div>
                    <div class="flex items-center gap-2"><span class="w-8 h-8 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center"><i class="fa-solid fa-layer-group"></i></span><div><p class="font-semibold">${room.question_total || 0} câu</p><p class="text-[11px] text-slate-500">${formatBattleMode(room.mode)}</p></div></div>
                </div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button type="button" class="group-join-room inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-200 font-semibold text-sm hover:bg-indigo-50" data-room-code="${room.room_code}"><i class="fa-solid fa-right-to-bracket"></i> Tham gia</button>
                    <a class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold text-sm hover:bg-slate-800" href="${viewUrl}"><i class="fa-solid fa-door-open"></i> Vào phòng</a>
                </div>
            `;
            if (!room.is_public && highlightPrivate) {
                card.classList.add('border-rose-100', 'bg-rose-50/50');
            }
            container.appendChild(card);
        });
    }

    async function handleJoinRoom(roomCode) {
        const normalizedCode = (roomCode || '').trim();
        if (!normalizedCode) {
            setGroupFeedback('Vui lòng nhập mã phòng.', 'danger');
            return;
        }
        setGroupFeedback('Đang vào phòng...', 'info');
        const joinUrl = quizBattleJoinRoomUrlTemplate.replace('__ROOM_CODE__', encodeURIComponent(normalizedCode));
        try {
            const response = await fetch(joinUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', ...csrfHeaders },
            });
            if (!response.ok) {
                const message = (await response.text()) || 'Không thể vào phòng.';
                throw new Error(message);
            }
            const data = await response.json();
            const targetUrl = quizBattleRoomViewUrlTemplate.replace('__ROOM_CODE__', encodeURIComponent(data.room.room_code));
            setGroupFeedback('Tham gia thành công, đang chuyển hướng...', 'success');
            window.location.href = targetUrl;
        } catch (error) {
            console.error('Join room failed:', error);
            setGroupFeedback(error.message || 'Không thể vào phòng.', 'danger');
        }
    }

    async function loadGroupPublicRooms() {
        if (!groupPublicRoomsContainer) return;
        groupPublicRoomsContainer.innerHTML = '<div class="flex items-center gap-3 p-4 rounded-xl bg-slate-50 border border-slate-100"><i class="fas fa-spinner fa-spin text-indigo-600"></i> Đang tải phòng công khai...</div>';
        try {
            const response = await fetch(quizBattlePublicRoomsUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error('Không thể tải phòng công khai.');
            const data = await response.json();
            renderGroupRooms(data.rooms || [], groupPublicRoomsContainer, { emptyMessage: 'Chưa có phòng công khai nào.' });
            updateGroupStats(data.rooms?.length ?? 0, null);
        } catch (error) {
            console.error(error);
            groupPublicRoomsContainer.innerHTML = '<div class="p-4 rounded-xl bg-rose-50 border border-rose-100 text-rose-600">Không thể tải phòng công khai.</div>';
        }
    }

    async function loadGroupMyRooms() {
        if (!groupMyRoomsContainer) return;
        groupMyRoomsContainer.innerHTML = '<div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 border border-slate-100"><i class="fas fa-spinner fa-spin text-purple-600"></i> Đang kiểm tra phòng của bạn...</div>';
        try {
            const response = await fetch(quizBattleMyRoomsUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error('Không thể tải phòng của bạn.');
            const data = await response.json();
            renderGroupRooms(data.rooms || [], groupMyRoomsContainer, { emptyMessage: 'Bạn chưa tham gia phòng nào.', highlightPrivate: true });
            updateGroupStats(null, data.rooms?.length ?? 0);
        } catch (error) {
            console.error(error);
            groupMyRoomsContainer.innerHTML = '<div class="p-3 rounded-xl bg-rose-50 border border-rose-100 text-rose-600">Không thể tải phòng của bạn.</div>';
        }
    }

    async function loadAvailableBattleQuizzes(searchTerm = '') {
        if (!groupQuizSelect) return;
        groupQuizSelect.innerHTML = '<option>Đang tải danh sách bộ quiz...</option>';
        try {
            const url = new URL(quizBattleAvailableQuizzesUrl, window.location.origin);
            url.searchParams.append('limit', '30');
            if (searchTerm) {
                url.searchParams.append('q', searchTerm);
            }
            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error('Không thể tải bộ quiz.');
            const data = await response.json();
            const containers = data.containers || [];
            groupQuizSelect.innerHTML = '';
            if (!containers.length) {
                groupQuizSelect.innerHTML = '<option value="">Không tìm thấy bộ quiz phù hợp</option>';
                if (groupQuizHelper) groupQuizHelper.textContent = 'Thử tìm kiếm tên khác hoặc kiểm tra quyền truy cập.';
                return;
            }

            containers.forEach((container) => {
                const option = document.createElement('option');
                option.value = container.container_id;
                const badge = container.tags ? ` • ${container.tags}` : '';
                option.textContent = `${container.title} • ${container.question_count || 0} câu${badge}`;
                groupQuizSelect.appendChild(option);
            });

            if (groupRoomTitleInput && !groupRoomTitleInput.value) {
                groupRoomTitleInput.value = `Quiz Battle: ${containers[0].title}`;
            }
            if (groupQuizHelper) groupQuizHelper.textContent = 'Đã lọc sẵn các bộ bạn có thể sử dụng.';
        } catch (error) {
            console.error(error);
            groupQuizSelect.innerHTML = '<option value="">Không thể tải danh sách bộ quiz</option>';
            if (groupQuizHelper) groupQuizHelper.textContent = 'Vui lòng thử lại sau hoặc làm mới trang.';
        }
    }

    function refreshGroupRoomLists() {
        loadGroupPublicRooms();
        loadGroupMyRooms();
    }

    function initGroupBattleDeck() {
        groupBattleInitialized = true;
        toggleTimedFields();
        loadAvailableBattleQuizzes();
        refreshGroupRoomLists();

        groupBattleModeSelect?.addEventListener('change', toggleTimedFields);
        groupRefreshPublicBtn?.addEventListener('click', loadGroupPublicRooms);
        groupRefreshMineBtn?.addEventListener('click', loadGroupMyRooms);

        groupPublicRoomsContainer?.addEventListener('click', (event) => {
            const joinButton = event.target.closest('.group-join-room');
            if (joinButton?.dataset?.roomCode) {
                handleJoinRoom(joinButton.dataset.roomCode);
            }
        });
        groupMyRoomsContainer?.addEventListener('click', (event) => {
            const joinButton = event.target.closest('.group-join-room');
            if (joinButton?.dataset?.roomCode) {
                handleJoinRoom(joinButton.dataset.roomCode);
            }
        });

        groupJoinRoomForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            const roomCode = (groupJoinRoomCodeInput?.value || '').trim();
            handleJoinRoom(roomCode);
        });

        let quizSearchTimeout;
        groupQuizSearch?.addEventListener('input', (event) => {
            clearTimeout(quizSearchTimeout);
            quizSearchTimeout = setTimeout(() => {
                loadAvailableBattleQuizzes(event.target.value.trim());
            }, 300);
        });

        groupCreateRoomForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!quizBattleCreateRoomUrl) return;
            const payload = {
                container_id: groupQuizSelect?.value,
                title: groupRoomTitleInput?.value,
                question_limit: groupQuestionLimitInput?.value || undefined,
                max_players: groupMaxPlayersInput?.value || undefined,
                mode: groupBattleModeSelect?.value || 'SLOW',
                visibility: groupRoomVisibilitySelect?.value || 'private',
            };

            if (payload.mode === 'TIMED') {
                payload.time_per_question_seconds = groupTimePerQuestionInput?.value || undefined;
            }

            setGroupFeedback('Đang tạo phòng...', 'info');

            try {
                const response = await fetch(quizBattleCreateRoomUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', ...csrfHeaders },
                    body: JSON.stringify(payload),
                });

                const contentType = response.headers.get('content-type') || '';
                const data = contentType.includes('application/json') ? await response.json() : { message: await response.text() };

                if (!response.ok) {
                    throw new Error(data.message || 'Không thể tạo phòng.');
                }

                const redirectUrl = quizBattleRoomViewUrlTemplate.replace('__ROOM_CODE__', encodeURIComponent(data.room.room_code));
                setGroupFeedback('Tạo phòng thành công, đang chuyển hướng...', 'success');
                window.location.href = redirectUrl;
            } catch (error) {
                console.error(error);
                setGroupFeedback(error.message || 'Không thể tạo phòng.', 'danger');
            }
        });
    }

    document.querySelectorAll('.tab-filter-button').forEach(function(button) {
        button.addEventListener('click', function() {
            const newFilter = this.dataset.filter;
            if (currentFilter !== newFilter) {
                if (currentFilter === 'doing') { doingPage = currentPage; }
                else if (currentFilter === 'explore') { explorePage = currentPage; }
                else if (currentFilter === 'archive') { archivePage = currentPage; }

                currentFilter = newFilter;
                if (currentFilter === 'doing') { currentPage = doingPage; }
                else if (currentFilter === 'explore') { currentPage = explorePage; }
                else { currentPage = archivePage; }

                document.querySelectorAll('.tab-filter-button').forEach(function(btn){
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                isMultiSelectMode = true; 
                
                updateStep2Content();
                
                // Save selected IDs to localStorage before loading new page
                localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));

                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            }
        });
    });
    
    function updateStep2Content() {
        const isMobile = window.innerWidth < 640;
        if (currentFilter === 'archive') {
            rightPanel.style.display = isMobile ? 'none' : 'flex';
            step2Title.innerHTML = `<i class="fas fa-info-circle mr-3 text-blue-500"></i> Bỏ lưu trữ`;
            
            if (!isMobile) {
                quizModesContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-700 p-4">
                        <p class="text-base text-center mb-4">
                            Hãy chọn các bộ cần để bỏ lưu trữ trên giao diện.
                        </p>
                    </div>
                `;
            }
        } else {
            rightPanel.style.display = 'flex';
            step2Title.innerHTML = `<i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học`;
            if (selectedQuizSetIds.length > 0) {
                 const setIdsStr = selectedQuizSetIds.join(',');
                 loadQuizModes(setIdsStr);
            } else {
                 quizModesContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                        <i class="fas fa-info-circle text-4xl mb-3"></i>
                        <p>Vui lòng chọn một bộ câu hỏi trước.</p>
                    </div>
                `;
            }
        }
    }


    document.addEventListener('DOMContentLoaded', function(){
        isMultiSelectMode = true;
        updateStep2Content();

        if (groupSection && !groupSection.classList.contains('hidden')) {
            initGroupBattleDeck();
        }

        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
    });
    
    // Xóa localStorage khi người dùng đóng/refresh trang
    window.addEventListener('beforeunload', function() {
        localStorage.removeItem('selectedQuizSetIds');
    });

    </script>
{% endblock %}