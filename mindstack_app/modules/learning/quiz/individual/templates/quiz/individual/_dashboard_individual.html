{# =============================== #}
{# File: mindstack_app/modules/learning/quiz/individual/templates/quiz/individual/_dashboard_individual.html #}
{# Mục đích: Giao diện học Quiz cá nhân (Solo) - Responsive Mobile/Desktop. #}
{# =============================== #}

{% from 'includes/_search_form.html' import render_search_form %}

<style>
    /* === Style CMS cho Individual === */
    .cm-section-card {
        background: white;
        border-radius: 0.75rem;
        /* Match Flashcard shadow-lg */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        border: none;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .tab-filter-button {
        flex-grow: 1;
        padding: 0.75rem;
        text-align: center;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
    }

    .tab-filter-button:hover {
        color: #374151;
    }

    .tab-filter-button.active {
        border-bottom-color: #3b82f6;
        color: #3b82f6;
    }

    .quiz-set-item {
        position: relative;
        background: #fff;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        padding: 1rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .quiz-set-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: #cbd5e1;
    }

    .quiz-set-item.selected-item {
        border-color: #3b82f6 !important;
        background-color: #eff6ff !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }

    .quiz-mode-item {
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .quiz-mode-item:hover {
        border-color: #93c5fd;
        background: #f8fafc;
    }

    .quiz-mode-item.selected-mode {
        border-color: #3b82f6;
        background-color: #eff6ff;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }

    .selected-set-item {
        background-color: #dbeafe;
        color: #1e3a8a;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        margin: 0.25rem;
        display: inline-flex;
        align-items: center;
    }

    .selected-set-item i {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    /* === MOBILE STYLES (max-width: 1023px) === */
    @media (max-width: 1023px) {
        .desktop-only {
            display: none !important;
        }

        /* App-like List Items */
        .quiz-set-item {
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 0.75rem;
            padding: 1rem;
        }

        .quiz-set-item:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Mobile Segmented Control Tabs */
        .mobile-header-section .flex.border-b {
            border: none !important;
            background-color: #f8fafc;
            padding: 0.25rem;
            border-radius: 0.75rem;
            gap: 0.25rem;
            margin-bottom: 1rem !important;
        }

        .tab-filter-button {
            border: none !important;
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-size: 0.8rem;
            color: #64748b;
            margin: 0;
            font-weight: 500;
        }

        .tab-filter-button.active {
            background-color: white;
            color: #0f172a;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            font-weight: 700;
        }

        /* Force body background */
        body {
            background-color: #f8fafc !important;
        }

        /* Step 0: Mode Selection Overlay */
        #mobile-mode-selection {
            position: relative;
            min-height: 80vh;
            overflow: hidden;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        /* Full Screen Containers for Steps */
        #step-1-card,
        #step-2-card {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 999;
            background-color: #f8fafc;
            border-radius: 0;
            border: none;
            margin: 0 !important;
            padding: 0 !important;
            flex-direction: column;
            height: 100dvh;
            box-shadow: none;
        }

        /* Toggle Logic for Steps */
        .mobile-mode-individual #step-1-card {
            display: flex;
        }

        .mobile-mode-individual.mobile-step-2-active #step-1-card {
            display: none;
        }

        .mobile-mode-individual.mobile-step-2-active #step-2-card {
            display: flex;
        }

        .mobile-mode-individual #mobile-mode-selection {
            display: none;
        }

        /* Header Sections (Title, Tabs, Search) */
        .mobile-header-section {
            flex-shrink: 0;
            background: white;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        /* Scrollable Content Areas */
        #quiz-sets-container,
        #quiz-modes-container {
            flex-grow: 1;
            overflow-y: auto;
            max-height: none !important;
            padding: 1rem;
            padding-bottom: 1rem;
            background-color: #f8fafc;
        }

        /* Hide session size selector in content on mobile (moved to footer) */
        #quiz-modes-container .lg\:hidden .mb-4.p-4.bg-white.rounded-lg.border.border-gray-200:has(#session-size-select) {
            display: none !important;
        }

        /* Footer Actions */
        .mobile-footer-section {
            flex-shrink: 0;
            background: white;
            padding: 1rem;
            border-top: 1px solid #f1f5f9;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        /* Button styling overrides for mobile footer */
        #mobile-step-1-next,
        #start-learning-btn,
        #bulk-unarchive-btn {
            width: 100%;
            margin: 0;
            border-radius: 1rem;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        #mobile-step-1-next:disabled {
            background-color: #e2e8f0;
            color: #94a3b8;
            box-shadow: none;
        }

        /* Hide desktop spacers/margins */
        .mb-4 {
            margin-bottom: 0.5rem !important;
        }

        h2 {
            margin-bottom: 0.5rem !important;
        }

        .h2-title-wrapper {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .mobile-control-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0;
            background: #fff;
        }

        .mobile-control-bar #quiz-pagination-slot {
            width: 100%;
            justify-content: center;
            display: flex;
        }

        /* Step 2 Actions Visibility on Mobile */
        #step-2-actions {
            display: none;
        }

        .mobile-step-2-active #step-2-actions {
            display: flex;
        }
    }

    /* === DESKTOP STYLES (min-width: 1024px) === */
    @media (min-width: 1024px) {
        .mobile-only {
            display: none !important;
        }

        #mobile-mode-selection {
            display: none !important;
        }

        #step-1-card,
        #step-2-card {
            display: flex !important;
            position: static !important;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            height: 100%;
        }

        .mobile-header-section {
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        #quiz-control-bar {
            justify-content: space-between;
        }

        #quiz-pagination-slot {
            justify-content: center;
        }

        /* Hide duplicate pagination inside container - already moved to slot */
        #quiz-sets-container .pagination,
        #quiz-sets-container nav[aria-label="Page navigation"] {
            display: none !important;
        }

        #step-2-actions {
            display: block !important;
        }

        .mobile-footer-section {
            position: static;
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
        }
    }
</style>

<div id="quiz-solo-section" class="space-y-6 h-full">

    {# === MOBILE STEP 0: MODE SELECTION === #}
    <div id="mobile-mode-selection" class="lg:hidden space-y-8 w-full max-w-md mx-auto">
        <div class="text-center mb-4">
            <div
                class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-xl shadow-indigo-200 transform rotate-3">
                <i class="fas fa-graduation-cap text-white text-4xl drop-shadow-md"></i>
            </div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">Luyện thi</h1>
            <p class="text-slate-500 font-medium mt-2 text-base">Chọn chế độ học tập của bạn</p>
        </div>

        <div class="space-y-4 w-full">
            <!-- Individual Mode -->
            <button id="btn-mode-individual"
                class="w-full bg-white p-5 rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-100 flex items-center gap-5 active:scale-95 transition-transform group">
                <div
                    class="w-16 h-16 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl shadow-sm group-hover:bg-emerald-500 group-hover:text-white transition-colors">
                    <i class="fas fa-user"></i>
                </div>
                <div class="text-left flex-grow">
                    <h3 class="font-bold text-slate-800 text-lg mb-0.5">Cá nhân</h3>
                    <p class="text-xs text-slate-500 font-medium">Tự ôn luyện theo tốc độ riêng</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </button>

            <!-- Battle Mode -->
            <a href="{{ url_for('learning.quiz_learning.quiz_learning_dashboard', quiz_type='battle') }}"
                class="block w-full bg-white p-5 rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-100 flex items-center gap-5 active:scale-95 transition-transform group">
                <div
                    class="w-16 h-16 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-2xl shadow-sm group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="text-left flex-grow">
                    <h3 class="font-bold text-slate-800 text-lg mb-0.5">Thi đấu</h3>
                    <p class="text-xs text-slate-500 font-medium">Tranh tài trực tiếp cùng bạn bè</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-full">

        {# === STEP 1 === #}
        <div id="step-1-card" class="cm-section-card">

            {# Header Group #}
            <div class="mobile-header-section lg:p-0 lg:bg-transparent lg:border-none lg:shadow-none">

                {# Mobile: Back button + Breadcrumb/Title layout #}
                <div class="lg:hidden flex items-start mb-3">
                    {# Back Button #}
                    <button id="mobile-step-1-back"
                        class="mr-3 bg-slate-100 text-gray-600 hover:bg-slate-200 rounded-full w-9 h-9 flex items-center justify-center flex-shrink-0 mt-1">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    {# Breadcrumb + Title Stack #}
                    <div class="flex flex-col flex-grow">
                        <div class="flex items-center text-xs text-slate-400 font-medium">
                            <span class="text-blue-500">QUIZ</span>
                            <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
                            <span class="text-blue-500">INDIVIDUAL</span>
                            <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
                            <span class="text-slate-600 font-semibold">STEP 1</span>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Chọn bộ câu hỏi</h2>
                    </div>
                    {# Mobile Toggle #}
                    <div class="flex items-center flex-shrink-0 ml-auto mt-2">
                        <span class="text-xs font-semibold text-slate-600 mr-2">Chọn nhiều:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="multi-select-toggle" class="sr-only peer">
                            <div
                                class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>
                </div>

                {# Desktop Title #}
                <h2
                    class="hidden lg:flex text-xl sm:text-2xl font-bold text-gray-800 mb-4 items-center justify-between">
                    <span class="h2-title-wrapper">
                        <i class="fas fa-list-alt mr-3 text-blue-500"></i>
                        <span>Bước 1: Chọn bộ câu hỏi</span>
                    </span>
                    {# Selection Mode Toggle #}
                    <div class="flex items-center flex-shrink-0 ml-auto">
                        <span class="text-xs font-semibold text-slate-600 mr-2 whitespace-nowrap">Chọn nhiều:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="multi-select-toggle" class="sr-only peer">
                            <div
                                class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>
                </h2>

                <div class="flex border-b border-gray-200 mb-4 lg:mb-4">
                    <button id="filter-doing" class="tab-filter-button flex items-center justify-center active"
                        data-filter="doing"><i class="fas fa-play-circle mr-2"></i><span>Đang làm</span></button>
                    <button id="filter-explore" class="tab-filter-button flex items-center justify-center"
                        data-filter="explore"><i class="fas fa-globe mr-2"></i><span>Khám phá</span></button>
                    <button id="filter-archive" class="tab-filter-button flex items-center justify-center"
                        data-filter="archive"><i class="fas fa-archive mr-2"></i><span>Archive</span></button>
                </div>

                <div class="mb-1" id="quiz-search-form-container">
                    {% set display_search_options = {'title':'Tiêu đề','description':'Mô tả','tags':'Thẻ'} %}
                    {{ render_search_form(search_query=search_query, placeholder="Tìm kiếm...",
                    search_field=search_field, search_options=display_search_options) }}
                </div>

                {# Selected Sets Display (Restored) #}
                <div id="selected-sets-display"
                    class="flex flex-wrap items-center gap-2 text-xs hidden bg-blue-50 p-2 rounded-lg mb-2 max-h-24 overflow-y-auto">
                </div>
            </div>

            {# Scrollable List #}
            <div id="quiz-sets-container" class="flex-grow overflow-y-auto max-h-[500px] lg:p-0 space-y-3">
                <div class="flex flex-col items-center justify-center h-48 text-blue-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Đang tải danh sách...</p>
                </div>
            </div>

            {# Fixed Control Bar (Toggle + Pagination) - Moved to bottom #}
            <div id="quiz-control-bar"
                class="flex items-center justify-between py-1 px-1 bg-white border-t border-slate-200 lg:border-t lg:border-slate-100 lg:bg-transparent flex-shrink-0 mobile-control-bar">
                {# Original location of multi-select toggle - NOW REMOVED #}
                {# Pagination will be moved here by JS #}
                <div id="quiz-pagination-slot"
                    class="flex justify-end flex-grow items-center empty:hidden [&_.pagination]:m-0 [&_nav]:m-0 [&_.page-item]:m-0 [&_.page-link]:py-1 [&_.page-link]:px-2 [&_.page-link]:text-xs">
                </div>
            </div>

            {# Mobile Step 1 Navigation Bar #}
            <div class="p-3 bg-white border-t border-gray-200 lg:hidden flex-shrink-0">
                <button id="mobile-step-1-next"
                    class="w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow-sm flex items-center justify-center transition-colors duration-200"
                    disabled>
                    Tiếp tục <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>

        {# === STEP 2 === #}
        <div id="step-2-card" class="cm-section-card">
            {# Header #}
            <div class="mobile-header-section lg:p-0 lg:bg-transparent lg:border-none lg:shadow-none">

                {# Mobile: Back button + Breadcrumb/Title layout #}
                <div class="lg:hidden flex items-start mb-1">
                    {# Back Button #}
                    <button id="mobile-step-2-back"
                        class="mr-3 bg-slate-100 text-gray-600 hover:bg-slate-200 rounded-full w-9 h-9 flex items-center justify-center flex-shrink-0 mt-1">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    {# Breadcrumb + Title Stack #}
                    <div class="flex flex-col">
                        <div class="flex items-center text-xs text-slate-400 font-medium">
                            <span class="text-blue-500">QUIZ</span>
                            <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
                            <span class="text-blue-500">INDIVIDUAL</span>
                            <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
                            <span class="text-slate-600 font-semibold">STEP 2</span>
                        </div>
                        <h2 id="step-2-title" class="text-xl font-bold text-gray-800">Tùy chỉnh phiên học</h2>
                    </div>
                </div>

                {# Desktop Title #}
                <h2 class="hidden lg:flex text-xl sm:text-2xl font-bold text-gray-800 mb-4 items-center truncate">
                    <i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Tùy chỉnh phiên học
                </h2>

                {# Mobile: Selected Sets Display - positioned after header #}
                <div id="mobile-selected-sets-header" class="lg:hidden w-full mb-2 hidden">
                    <div class="text-xs text-slate-500 mb-1 font-medium">Bộ đã chọn:</div>
                    <div id="mobile-selected-sets-chips-header" class="flex flex-wrap gap-1 max-h-12 overflow-y-auto">
                    </div>
                </div>
            </div>
            {# List #}
            <div id="quiz-modes-container" class="flex-grow overflow-y-auto max-h-[500px] lg:p-0">
                <div class="flex flex-col items-center justify-center h-48 text-gray-400">
                    <i class="fas fa-info-circle text-4xl mb-3 opacity-50"></i>
                    <p>Vui lòng chọn bộ câu hỏi ở bước 1.</p>
                </div>
            </div>
        </div>
    </div>
    {# Footer Actions (Global for Desktop, Step 2 for Mobile) #}
    <div id="step-2-actions"
        class="mobile-footer-section mt-4 lg:bg-transparent lg:border-none lg:shadow-none lg:p-0 lg:static fixed bottom-0 left-0 right-0 flex-shrink-0 flex flex-col">

        {# Mobile: Session Size Selector #}
        <div id="mobile-session-size-row" class="lg:hidden w-full mb-2 px-1 hidden">
            <div class="flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2">
                <span class="text-sm text-slate-600 font-medium">Số câu:</span>
                <select id="mobile-session-size-select"
                    class="bg-white border border-slate-200 rounded-lg px-3 py-1.5 text-sm font-medium text-slate-800 focus:ring-2 focus:ring-blue-300 focus:border-blue-400">
                    <option value="1" {% if user_default_batch_size==1 %}selected{% endif %}>1 câu</option>
                    <option value="3" {% if user_default_batch_size==3 %}selected{% endif %}>3 câu</option>
                    <option value="5" {% if user_default_batch_size==5 %}selected{% endif %}>5 câu</option>
                    <option value="10" {% if user_default_batch_size==10 or user_default_batch_size is not defined
                        %}selected{% endif %}>10 câu</option>
                    <option value="20" {% if user_default_batch_size==20 %}selected{% endif %}>20 câu</option>
                    <option value="50" {% if user_default_batch_size==50 %}selected{% endif %}>50 câu</option>
                </select>
            </div>
        </div>

        {# Button row below #}
        <div class="w-full">
            <button id="start-learning-btn"
                class="start-button w-full bg-blue-600 text-white px-4 py-3 rounded-lg text-lg font-bold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center">
                <i class="fas fa-play-circle mr-2"></i> Bắt đầu
            </button>
            <button id="bulk-unarchive-btn"
                class="start-button w-full bg-blue-600 text-white px-4 py-3 rounded-lg text-lg font-bold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md hidden items-center justify-center">
                <i class="fas fa-box-open mr-2"></i> Bỏ lưu trữ
            </button>
        </div>
    </div>
</div>
<script>
    console.log('>>> _dashboard_individual.js: init');

    // ==== Biến trạng thái ====
    let selectedQuizSetIds = [];
    let selectedQuizMode = null;
    let selectedSessionSize = parseInt("{{ user_default_batch_size | default(10) }}");
    let currentFilter = "{{ current_filter | default('doing') }}";
    let doingPage = 1, explorePage = 1, archivePage = 1;
    let currentPage = (currentFilter === 'doing' ? doingPage : (currentFilter === 'explore' ? explorePage : archivePage));
    let currentSearchQuery = "{{ search_query | default('') }}";
    let currentSearchField = "{{ search_field | default('all') }}";
    let isMultiSelectMode = false; // Initialized by toggle state

    const quizSetsContainer = document.getElementById('quiz-sets-container');
    const quizModesContainer = document.getElementById('quiz-modes-container');
    const selectedSetsDisplay = document.getElementById('selected-sets-display');
    const step2Title = document.getElementById('step-2-title');
    const quizSearchForm = document.querySelector('#quiz-search-form-container form');
    const mobileNextBtn = document.getElementById('mobile-step-1-next');
    const mobileBackBtn = document.getElementById('mobile-step-2-back');
    const mobileStep0Btn = document.getElementById('btn-mode-individual');
    const mobileStep1BackBtn = document.getElementById('mobile-step-1-back');
    const quizSection = document.getElementById('quiz-solo-section');

    // --- START: Mobile Mode Selection Logic ---
    if (mobileStep0Btn) {
        mobileStep0Btn.addEventListener('click', () => {
            quizSection.classList.add('mobile-mode-individual');
            // Fix: Update URL to persist state on reload
            const url = new URL(window.location);
            url.searchParams.set('view', 'setup');
            history.pushState({}, '', url);
        });
    }

    if (mobileStep1BackBtn) {
        mobileStep1BackBtn.addEventListener('click', () => {
            quizSection.classList.remove('mobile-mode-individual');
            // Fix: Remove param from URL on back
            const url = new URL(window.location);
            url.searchParams.delete('view');
            history.pushState({}, '', url);
        });
    }

    // Fix: Restore state on load if param exists
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') === 'setup') {
        quizSection.classList.add('mobile-mode-individual');
    }

    const preSelectId = urlParams.get('preSelect');
    if (preSelectId) {
        selectedQuizSetIds = [preSelectId];
        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));

        // Use timeout to allow initial render/state settle
        setTimeout(() => {
            loadQuizModes(selectedQuizSetIds);
            const section = document.getElementById('quiz-solo-section');
            if (section) {
                section.classList.add('mobile-mode-individual');
                section.classList.add('mobile-step-2-active');
            }
        }, 150);
    }
    // --- END: Mobile Mode Selection Logic ---

    // --- START: Mobile Footer Navigation ---
    // (Footer buttons removed per user request)
    // --- END: Mobile Footer Navigation ---


    // --- START: Toggle References and Syncing ---
    const multiSelectToggle = document.getElementById('multi-select-toggle'); // Single toggle element

    // Determine initial state based on toggle state
    if (multiSelectToggle) {
        isMultiSelectMode = multiSelectToggle.checked;
        multiSelectToggle.addEventListener('change', (e) => {
            isMultiSelectMode = e.target.checked;
            handleMultiSelectChange();
        });
    }

    function handleMultiSelectChange() {
        selectedQuizSetIds = []; // Clear selection on mode switch
        localStorage.removeItem('selectedQuizSetIds');
        syncMultiSelectionUI();
        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter); // Reload to update UI (checkbox vs radio)
        updateActionButtons();
    }
    // --- END: Toggle References and Syncing ---


    // URL Configs (Fix paths)
    const quizModesPartialBaseUrlById = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_by_id', set_id=0) or '#' }}";
    const quizModesPartialBaseUrlAll = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_all') or '#' }}";
    const quizModesPartialBaseUrlMulti = "{{ url_for('learning.quiz_learning.get_quiz_modes_partial_multi', set_ids_str='0') or '#' }}";
    const startQuizSessionBaseUrlAllTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_all', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlMultiTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_multi', mode='MODE_PLACEHOLDER') }}";
    const startQuizSessionBaseUrlByIdTemplate = "{{ url_for('learning.quiz_learning.start_quiz_session_by_id', set_id=0, mode='MODE_PLACEHOLDER') }}";
    const getQuizSetsPartialUrl = "{{ url_for('learning.quiz_learning.get_quiz_sets_partial') or '#' }}";
    const saveQuizSettingsUrl = "{{ url_for('learning.quiz_learning.save_quiz_settings') }}";
    const toggleArchiveUrl = "{{ url_for('learning.quiz_learning.toggle_archive', set_id=0) or '#' }}";
    const bulkUnarchiveUrl = "{{ url_for('learning.quiz_learning.bulk_unarchive') }}";

    // === Mobile Navigation ===
    function updateMobileNextButton() {
        if (!mobileNextBtn) return;
        const count = selectedQuizSetIds.length;
        mobileNextBtn.innerHTML = `Tiếp tục <i class="fas fa-arrow-right ml-2"></i>`;
        mobileNextBtn.disabled = count === 0;
        if (count > 0) {
            mobileNextBtn.classList.remove('bg-gray-400');
            mobileNextBtn.classList.add('bg-blue-600');
        } else {
            mobileNextBtn.classList.add('bg-gray-400');
            mobileNextBtn.classList.remove('bg-blue-600');
        }
    }

    mobileNextBtn?.addEventListener('click', () => {
        document.getElementById('quiz-solo-section').classList.add('mobile-step-2-active');
        updateMobileStep2Display();
        // Save step to URL
        const url = new URL(window.location);
        url.searchParams.set('mobile_step', '2');
        window.history.replaceState({}, '', url);
    });

    mobileBackBtn?.addEventListener('click', () => {
        document.getElementById('quiz-solo-section').classList.remove('mobile-step-2-active');
        // Remove step from URL
        const url = new URL(window.location);
        url.searchParams.delete('mobile_step');
        window.history.replaceState({}, '', url);
    });

    // Restore mobile step on page load
    function restoreMobileStep() {
        // Use setTimeout to ensure DOM is ready
        setTimeout(() => {
            const urlParams = new URLSearchParams(window.location.search);
            const mobileStep = urlParams.get('mobile_step');
            console.log('restoreMobileStep called:', mobileStep, 'IDs:', selectedQuizSetIds);

            if (mobileStep === '2' && selectedQuizSetIds.length > 0) {
                const soloSection = document.getElementById('quiz-solo-section');
                console.log('Found soloSection:', soloSection);
                if (soloSection) {
                    // Need BOTH classes for step 2 to display on mobile
                    soloSection.classList.add('mobile-mode-individual');
                    soloSection.classList.add('mobile-step-2-active');
                    console.log('Classes added:', soloSection.className);
                    updateMobileStep2Display();
                    // Also load quiz modes for step 2
                    if (selectedQuizSetIds.length === 1) {
                        loadQuizModes(selectedQuizSetIds[0]);
                    } else {
                        loadQuizModes('multi');
                    }
                }
            }
        }, 100);
    }

    // Update Step 2 mobile selected sets display
    function updateMobileStep2Display() {
        // Selected sets in header
        const headerDisplayEl = document.getElementById('mobile-selected-sets-header');
        const headerChipsEl = document.getElementById('mobile-selected-sets-chips-header');

        // Session size in footer
        const sessionSizeRow = document.getElementById('mobile-session-size-row');
        const mobileSessionSelect = document.getElementById('mobile-session-size-select');

        // Show selected sets in header
        if (headerDisplayEl && headerChipsEl) {
            if (selectedQuizSetIds.length > 0) {
                const chipsHtml = selectedQuizSetIds.map(id => {
                    const title = selectedQuizSetTitles[id] || `Bộ #${id}`;
                    return `<span class="inline-flex items-center bg-blue-100 text-blue-700 text-xs font-medium px-2 py-0.5 rounded-full">${title}</span>`;
                }).join('');
                headerChipsEl.innerHTML = chipsHtml;
                headerDisplayEl.classList.remove('hidden');
            } else {
                headerDisplayEl.classList.add('hidden');
            }
        }

        // Show session size row in footer with default value
        if (sessionSizeRow) {
            sessionSizeRow.classList.remove('hidden');
            if (mobileSessionSelect) {
                mobileSessionSelect.value = selectedSessionSize;
                mobileSessionSelect.onchange = () => {
                    selectedSessionSize = parseInt(mobileSessionSelect.value);
                    // Sync with desktop selector if exists
                    const desktopSelect = document.getElementById('session-size-select');
                    if (desktopSelect) desktopSelect.value = selectedSessionSize;
                };
            }
        }
    }

    async function loadQuizSets(page, searchQuery, searchField, filter) {
        if (!quizSetsContainer) return;
        quizSetsContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-32 text-blue-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Đang tải...</p></div>';

        if (localStorage.getItem('selectedQuizSetIds')) selectedQuizSetIds = JSON.parse(localStorage.getItem('selectedQuizSetIds'));
        else selectedQuizSetIds = [];

        // Fix: Initialize Title Map
        if (localStorage.getItem('selectedQuizSetTitles')) selectedQuizSetTitles = JSON.parse(localStorage.getItem('selectedQuizSetTitles'));
        else selectedQuizSetTitles = {};

        updateSelectedSetsDisplay();
        updateActionButtons();
        updateMobileNextButton(); // Init Mobile Button

        try {
            const url = new URL(getQuizSetsPartialUrl, window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('q', searchQuery || '');
            url.searchParams.append('search_field', searchField || 'all');
            url.searchParams.append('filter', filter || 'doing');
            url.searchParams.append('is_multi_select_mode', isMultiSelectMode.toString());

            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error();

            quizSetsContainer.innerHTML = await response.text();

            // Move pagination to fixed slot
            const paginationSlot = document.getElementById('quiz-pagination-slot');
            const paginationEl = quizSetsContainer.querySelector('.pagination') || quizSetsContainer.querySelector('nav[aria-label="Page navigation"]');

            if (paginationSlot) {
                paginationSlot.innerHTML = '';
                if (paginationEl) {
                    paginationSlot.appendChild(paginationEl);
                    // Center pagination (new request)
                    paginationSlot.classList.add('w-full', 'flex', 'justify-center');
                    paginationSlot.classList.remove('hidden');
                } else {
                    paginationSlot.classList.add('hidden');
                }
            }

            addQuizSetClickListeners();
            addPaginationListeners();
            addArchiveIconListeners();
            syncMultiSelectionUI();
            restoreMobileStep(); // Restore step 2 if reload

        } catch (e) {
            quizSetsContainer.innerHTML = '<p class="text-center text-rose-500 p-4">Lỗi tải dữ liệu.</p>';
        }
    }

    async function loadQuizModes(setId) {
        if (currentFilter === 'archive') return;
        if (!quizModesContainer) return;

        // Reset selected mode when reloading modes to ensure fresh selection
        selectedQuizMode = null;
        updateActionButtons();

        quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-32 text-blue-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Đang tải chế độ...</p></div>';

        try {
            let url;
            if (Array.isArray(setId)) {
                if (setId.length === 0) {
                    quizModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-48 text-gray-400"><i class="fas fa-info-circle text-4xl mb-3 opacity-50"></i><p>Vui lòng chọn bộ câu hỏi.</p></div>';
                    return;
                }
                if (setId.length === 1 && setId[0] === 'all') url = quizModesPartialBaseUrlAll;
                else url = quizModesPartialBaseUrlMulti.replace('/0', '/' + setId.join(','));
            } else if (setId === 'all') {
                url = quizModesPartialBaseUrlAll;
            } else {
                url = quizModesPartialBaseUrlById.replace('/0', '/' + setId);
            }

            const fullUrl = new URL(url, window.location.origin);
            // Remove passing selected_mode since we reset it
            // if (selectedQuizMode) fullUrl.searchParams.append('selected_mode', selectedQuizMode);
            fullUrl.searchParams.append('user_default_batch_size', selectedSessionSize);

            const response = await fetch(fullUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error();

            quizModesContainer.innerHTML = await response.text();

            // Xử lý Dropdown số câu
            const sizeSelect = document.getElementById('session-size-select');
            if (sizeSelect) {
                sizeSelect.value = selectedSessionSize;
                sizeSelect.addEventListener('change', function () { selectedSessionSize = parseInt(this.value); });
            }

            // Xử lý Click Mode
            const modes = quizModesContainer.querySelectorAll('.quiz-mode-item');
            modes.forEach(mode => {
                mode.addEventListener('click', function () {
                    if (parseInt(this.dataset.count) === 0) return;
                    modes.forEach(m => m.classList.remove('selected-mode'));
                    this.classList.add('selected-mode');
                    selectedQuizMode = this.dataset.modeId;
                    updateActionButtons();
                });
            });

            // Auto select REMOVED to force user selection
            // updateActionButtons is already called via reset at top, but calling again is fine or just leave it.

        } catch (e) {
            quizModesContainer.innerHTML = '<p class="text-center text-rose-500">Lỗi tải chế độ học.</p>';
        }
    }

    function syncMultiSelectionUI() {
        document.querySelectorAll('.quiz-set-item').forEach(item => {
            const id = item.dataset.setId;
            if (selectedQuizSetIds.includes(id)) item.classList.add('selected-item');
            else item.classList.remove('selected-item');
        });
        updateSelectedSetsDisplay();
        updateMobileNextButton(); // Sync button
    }

    function updateSelectedSetsDisplay() {
        if (!selectedSetsDisplay) return;

        selectedSetsDisplay.innerHTML = ''; // Clear previous content

        if (selectedQuizSetIds.length > 0) {
            selectedSetsDisplay.classList.remove('hidden');

            const selectedTitlesHtml = selectedQuizSetIds.map(setId => {
                // Fix: Try getting title from map first, then DOM, then fallback
                let title = selectedQuizSetTitles[setId];
                if (!title) {
                    const setItem = document.querySelector(`.quiz-set-item[data-set-id="${setId}"]`);
                    title = setItem ? setItem.dataset.title : `Bộ #${setId}`;
                }
                return `
                <span class="selected-set-item">
                    ${title}
                    <i class="fas fa-times ml-1 cursor-pointer" onclick="removeSelectedQuizSet('${setId}')"></i>
                </span>
            `;
            }).join('');

            selectedSetsDisplay.innerHTML = `
            <span class="text-gray-500 text-sm mr-2">Đã chọn:</span>
            ${selectedTitlesHtml}
        `;

            // Only show "Clear All" button if in multi-select mode
            if (isMultiSelectMode) {
                const clearBtn = document.createElement('button');
                clearBtn.className = "text-xs text-rose-500 font-semibold hover:underline ml-2";
                clearBtn.textContent = "Bỏ chọn tất cả";
                clearBtn.onclick = () => {
                    selectedQuizSetIds = [];
                    selectedQuizSetTitles = {}; // Clear titles
                    localStorage.removeItem('selectedQuizSetIds');
                    localStorage.removeItem('selectedQuizSetTitles');
                    syncMultiSelectionUI();
                    loadQuizModes([]);
                    updateActionButtons();
                };
                selectedSetsDisplay.appendChild(clearBtn);
            }

        } else {
            selectedSetsDisplay.classList.add('hidden');
        }
    }

    // Global function to remove a single selected set
    window.removeSelectedQuizSet = (setIdToRemove) => {
        selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setIdToRemove);
        delete selectedQuizSetTitles[setIdToRemove]; // Remove title
        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
        localStorage.setItem('selectedQuizSetTitles', JSON.stringify(selectedQuizSetTitles)); // Sync storage
        syncMultiSelectionUI();
        loadQuizModes(selectedQuizSetIds);
        updateActionButtons();
    };

    // Fix: Add Title Storage
    let selectedQuizSetTitles = {};

    function handleQuizSetSelection(setId, setTitle = null) {
        if (!isMultiSelectMode) {
            // Single Select Mode logic
            selectedQuizSetIds = [setId];
            selectedQuizSetTitles = {}; // Reset titles
            if (setTitle) selectedQuizSetTitles[setId] = setTitle;
        } else {
            // Multi Select Mode logic
            if (setId === 'all' && !selectedQuizSetIds.includes('all')) {
                selectedQuizSetIds = ['all'];
                selectedQuizSetTitles = { 'all': 'Tất cả các bộ' };
            }
            else if (selectedQuizSetIds.includes('all')) {
                selectedQuizSetIds = [setId];
                selectedQuizSetTitles = {};
                if (setTitle) selectedQuizSetTitles[setId] = setTitle;
            }
            else {
                if (selectedQuizSetIds.includes(setId)) {
                    selectedQuizSetIds = selectedQuizSetIds.filter(id => id !== setId);
                    delete selectedQuizSetTitles[setId];
                }
                else {
                    selectedQuizSetIds.push(setId);
                    if (setTitle) selectedQuizSetTitles[setId] = setTitle;
                }
            }
        }

        localStorage.setItem('selectedQuizSetIds', JSON.stringify(selectedQuizSetIds));
        localStorage.setItem('selectedQuizSetTitles', JSON.stringify(selectedQuizSetTitles)); // Save Titles
        syncMultiSelectionUI();
        loadQuizModes(selectedQuizSetIds);
        updateActionButtons();
    }

    function addQuizSetClickListeners() {
        document.querySelectorAll('.quiz-set-item').forEach(item => {
            item.addEventListener('click', function () { handleQuizSetSelection(this.dataset.setId, this.dataset.title); });
        });
    }

    function addPaginationListeners() {
        document.querySelectorAll('.pagination a').forEach(a => {
            a.addEventListener('click', function (e) {
                e.preventDefault();
                const url = new URL(this.href);
                currentPage = parseInt(url.searchParams.get('page')) || 1;
                loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            });
        });
    }

    function addArchiveIconListeners() {
        document.querySelectorAll('.archive-icon').forEach(icon => {
            icon.addEventListener('click', async (e) => {
                e.stopPropagation();
                const setId = icon.dataset.setId;
                const url = toggleArchiveUrl.replace('/0', '/' + setId);
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (res.ok) loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
                } catch { }
            });
        });
    }

    function updateActionButtons() {
        const startBtn = document.getElementById('start-learning-btn');
        const archiveBtn = document.getElementById('bulk-unarchive-btn');

        if (currentFilter === 'archive') {
            if (startBtn) startBtn.style.display = 'none';
            if (archiveBtn) {
                archiveBtn.style.display = 'flex';
                archiveBtn.disabled = selectedQuizSetIds.length === 0;
            }
        } else {
            if (archiveBtn) archiveBtn.style.display = 'none';
            if (startBtn) {
                startBtn.style.display = 'flex';
                const ready = selectedQuizSetIds.length > 0 && selectedQuizMode;
                startBtn.disabled = !ready;
                startBtn.className = ready
                    ? "start-button bg-blue-600 text-white px-8 py-3 rounded-xl text-lg font-bold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-lg shadow-blue-600/30 flex items-center justify-center mx-auto transform hover:-translate-y-1"
                    : "start-button bg-gray-400 text-white px-8 py-3 rounded-xl text-lg font-bold cursor-not-allowed flex items-center justify-center mx-auto";
            }
        }
    }

    // Listeners
    quizSearchForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        currentSearchQuery = e.target.elements.q.value;
        currentSearchField = e.target.elements.search_field?.value || 'all';
        currentPage = 1;
        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
    });

    document.querySelectorAll('.tab-filter-button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-filter-button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            currentPage = 1;
            updateStep2Content();
            loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
        });
    });

    document.getElementById('start-learning-btn')?.addEventListener('click', () => {
        // Clear previous session state from LocalStorage
        localStorage.removeItem('quiz_session_state');
        localStorage.removeItem('quiz_batch_questions');
        localStorage.removeItem('current_batch');

        // Signal new session to the single quiz page
        localStorage.setItem('force_new_session', 'true');

        // ... existing start logic ...
        let startUrl;
        const batchSize = selectedSessionSize || 10;
        if (selectedQuizSetIds.length === 1 && selectedQuizSetIds[0] === 'all') {
            startUrl = new URL(startQuizSessionBaseUrlAllTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
        } else if (selectedQuizSetIds.length === 1) {
            startUrl = new URL(startQuizSessionBaseUrlByIdTemplate.replace('0', selectedQuizSetIds[0]).replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
        } else {
            startUrl = new URL(startQuizSessionBaseUrlMultiTemplate.replace('MODE_PLACEHOLDER', selectedQuizMode), window.location.origin);
            startUrl.searchParams.append('set_ids', selectedQuizSetIds.join(','));
        }
        startUrl.searchParams.append('batch_size', batchSize);
        localStorage.removeItem('selectedQuizSetIds');
        window.location.href = startUrl.toString();
    });

    function updateStep2Content() {
        if (currentFilter === 'archive') {
            quizModesContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-gray-500"><p>Chọn bộ quiz để bỏ lưu trữ.</p></div>`;
            if (step2Title) step2Title.innerHTML = `<i class="fas fa-info-circle mr-3 text-blue-500"></i> Quản lý Archive`;
        } else {
            if (step2Title) step2Title.innerHTML = `<i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Tùy chỉnh phiên học`;
            if (selectedQuizSetIds.length > 0) loadQuizModes(selectedQuizSetIds);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Reset selection on reload (User Request) but keep if preSelect exists
        const psId = new URLSearchParams(window.location.search).get('preSelect');
        if (!psId) {
            localStorage.removeItem('selectedQuizSetIds');
        }
        loadQuizSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
    });
</script>