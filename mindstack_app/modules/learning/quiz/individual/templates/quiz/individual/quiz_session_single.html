{# =============================== #}
{# File: mindstack_app/modules/learning/quiz/individual/templates/quiz/individual/quiz_session_single.html #}
{# Phi√™n b·∫£n: 4.4 (Responsive Split - Client-Side Toggle) #}
{# =============================== #}

{% extends "base.html" %}

{% block title %}L√†m b√†i Quiz{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* === CORE LAYOUT === */
    body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }

    /* Shared Styles */
    .cm-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: flex; flex-direction: column;
        margin-bottom: 0.5rem; 
    }
    .cm-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f5f9;
        background-color: #ffffff;
        display: flex; align-items: center; justify-content: space-between;
    }
    .cm-card-body { padding: 0.75rem; flex: 1; position: relative; }
    
    .qb-question-text { font-size: 1.25rem; font-weight: 700; color: #1e293b; line-height: 1.5; margin-bottom: 0.25rem; }
    .qb-question-media img { width: 100%; max-height: 320px; object-fit: contain; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: white; margin-bottom: 1rem; }
    
    /* Options */
    .qb-options-grid { display: grid; gap: 0.75rem; }
    .qb-option-label {
        display: flex; align-items: flex-start; gap: 1rem;
        padding: 1rem; border: 2px solid #e2e8f0; border-radius: 0.75rem;
        cursor: pointer; transition: all 0.15s ease; background: white;
    }
    .qb-option-label:hover { border-color: #94a3b8; background: #f8fafc; }
    .qb-option-label.selected { border-color: #3b82f6; background: #eff6ff; ring: 1px solid #3b82f6; }
    .qb-option-label.correct { border-color: #10b981; background: #ecfdf5; }
    .qb-option-label.incorrect { border-color: #ef4444; background: #fef2f2; }
    .qb-option-label.disabled { pointer-events: none; opacity: 0.7; }
    
    .qb-option-letter-circle {
        display: flex; align-items: center; justify-content: center;
        width: 32px; height: 32px; border-radius: 999px;
        background: #f1f5f9; color: #1e293b; font-weight: 700; font-size: 0.9rem;
        border: 1px solid #e2e8f0; flex-shrink: 0; margin-top: 2px;
    }
    .qb-option-label.selected .qb-option-letter-circle { background: #3b82f6; color: white; border-color: #3b82f6; }
    .qb-option-label.correct .qb-option-letter-circle { background: #10b981; color: white; border-color: #10b981; }
    .qb-option-label.incorrect .qb-option-letter-circle { background: #ef4444; color: white; border-color: #ef4444; }

    /* Buttons */
    .cm-btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; border: none; }
    .cm-btn-primary { background: #2563eb; color: white; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }
    .cm-btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    .cm-btn-primary:disabled { background: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }
    .cm-btn-danger { background: white; color: #ef4444; border: 1px solid #fecaca; }
    
    /* === MOBILE SPECIFIC STYLES (Used in _mobile.html) === */
    .qb-mobile-sticky-wrapper {
        position: fixed; top: 0; left: 0; right: 0; z-index: 50; 
        background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    .qb-mobile-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px 16px 4px 16px;
    }
    .qb-mobile-tabs-container { padding: 0 16px 10px 16px; background: white; border-bottom: 1px solid #e2e8f0; }
    .qb-mobile-tabs { display: flex; background: #f1f5f9; border-radius: 10px; padding: 3px; }
    .qb-mobile-tab-item {
        flex: 1; text-align: center; padding: 8px; font-size: 0.9rem; font-weight: 600;
        color: #64748b; border-radius: 8px; cursor: pointer; transition: all 0.2s;
    }
    .qb-mobile-tab-item.active { background: white; color: #2563eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    .qb-bottom-bar {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: white; padding: 12px 16px;
        border-top: 1px solid #e2e8f0; z-index: 60;
        display: flex; gap: 10px; align-items: center;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    .qb-bottom-bar .cm-btn { flex: 1; border-radius: 12px; padding: 14px; font-size: 1rem; margin: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    .qb-mobile-chat-toggle {
        position: relative; background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe;
        border-radius: 12px; width: 3.25rem; height: 3.25rem; display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }

    /* === HUB MODAL === */
    .qb-modal-overlay {
        position: fixed; inset: 0; z-index: 100;
        background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
        opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .qb-modal-container {
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 101;
        background: white; height: 85vh; border-radius: 20px 20px 0 0;
        transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
    }
    .qb-modal-overlay.open { opacity: 1; visibility: visible; }
    .qb-modal-overlay.open .qb-modal-container { transform: translateY(0); }
    
    .qb-hub-header { padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .qb-hub-tabs { display: flex; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
    .qb-hub-tab-item { flex: 1; text-align: center; padding: 12px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; }
    .qb-hub-tab-item.active { color: #2563eb; border-bottom-color: #2563eb; background: white; }
    .qb-hub-content { flex: 1; overflow-y: auto; padding: 1.5rem; background: white; }
    .qb-hub-pane { display: none; }
    .qb-hub-pane.active { display: block; }
    
    /* Logic for tabs */
    .qb-tab-pane { display: none; }
    .qb-tab-pane.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Override for Mobile to hide site elements (Client-side via Media Query) */
    @media (max-width: 1023px) {
        body > header, nav.navbar, footer, .site-footer, .back-to-top { display: none !important; }
        body { 
            padding-top: 100px !important; 
            padding-bottom: 70px;
        }
        .container { padding-left: 12px; padding-right: 12px; max-width: 100%; }
        .cm-card-header { padding: 0.5rem 0.75rem !important; }

        /* Mobile Result Panel - Fixed Bottom Sheet */
        #mobile-result-panel {
            position: fixed !important;
            bottom: 80px !important; /* Above the bottom bar */
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            border-radius: 1rem 1rem 0 0 !important;
            border: none !important;
            border-top: 4px solid #3b82f6 !important;
            box-shadow: 0 -10px 25px -5px rgba(0, 0, 0, 0.1) !important;
            z-index: 50 !important;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    }

    /* === DESKTOP BATCH-LIKE STYLES === */
    @media (min-width: 1024px) {
        body { background-color: #f1f5f9; }
        
        .quiz-shell {
            background: linear-gradient(180deg, rgba(248, 250, 252, 0.9) 0%, rgba(226, 232, 240, 0.35) 100%);
            min-height: 100vh;
        }

        .quiz-shell .cm-container { gap: 1.5rem; }

        .quiz-section-header {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .quiz-heading-group .cm-subheading { max-width: 38rem; }

        /* Stats Card (Top Right) */
        .quiz-progress-card {
            width: 400px;
            padding: 1.25rem 1.5rem;
            border-radius: 1.1rem;
            background: #ffffff;
            border: 1px solid #e2e8f0;
        }
        
        .progress-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .progress-card-title { display: flex; align-items: center; gap: 0.75rem; }
        .progress-card-icon { 
            width: 2.25rem; height: 2.25rem; display: flex; align-items: center; justify-content: center;
            border-radius: 0.6rem; background: #e2e8f0; color: #1d4ed8; 
        }
        .progress-card-heading { font-weight: 700; color: #0f172a; }
        
        .progress-card-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .progress-stat-item { background: #f8fafc; padding: 0.5rem; border-radius: 0.5rem; text-align: center; border: 1px solid #e2e8f0; }
        .progress-stat-value { display: block; font-weight: 700; font-size: 1.25rem; line-height: 1; margin-bottom: 0.25rem; }
        .progress-stat-label { font-size: 0.65rem; text-transform: uppercase; color: #64748b; font-weight: 600; }

        .progress-bar-track { height: 0.4rem; background: #e2e8f0; border-radius: 99px; overflow: hidden; margin-top: 0.5rem; }
        .progress-bar-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }

        /* Main Quiz Card */
        .quiz-card {
            background: white;
            border-radius: 1.25rem;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 24px 50px -35px rgba(15, 23, 42, 0.45);
            padding: 2rem;
            min-height: 500px;
        }

        .question-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, 0.35);
            padding: 2rem;
        }

        .question-meta { display: flex; justify-content: space-between; margin-bottom: 1rem; color: #64748b; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .question-title { font-size: 1.5rem; font-weight: 700; color: #0f172a; margin-bottom: 1.5rem; line-height: 1.4; }

        /* Options */
        .qb-options-grid { display: grid; gap: 1rem; }
        .option-button {
            display: flex; align-items: center; gap: 1rem; width: 100%; padding: 1rem 1.25rem;
            border-radius: 0.75rem; border: 1px solid #cbd5e1; background: white;
            text-align: left; font-size: 1rem; color: #334155; transition: all 0.2s;
            cursor: pointer;
        }
        .option-button:hover { border-color: #3b82f6; background: #eff6ff; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .option-button.selected { border-color: #3b82f6; background: #eff6ff; ring: 2px solid #3b82f6; }
        .option-button.correct { border-color: #10b981; background: #ecfdf5; }
        .option-button.incorrect { border-color: #ef4444; background: #fef2f2; }
        
        .option-key { 
            width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center;
            background: #f1f5f9; border-radius: 50%; font-weight: 700; color: #64748b; flex-shrink: 0;
        }
        .option-button.selected .option-key { background: #3b82f6; color: white; }
        .option-button.correct .option-key { background: #10b981; color: white; }
        .option-button.incorrect .option-key { background: #ef4444; color: white; }

        /* Feedback Desktop */
        .desktop-feedback-box {
            margin-top: 1.5rem; padding: 1rem; border-radius: 0.75rem; display: flex; gap: 1rem;
        }
        .desktop-feedback-box.correct { background: #ecfdf5; border: 1px solid #10b981; color: #065f46; }
        .desktop-feedback-box.incorrect { background: #fef2f2; border: 1px solid #ef4444; color: #991b1b; }
        
        .desktop-action-bar { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }

        /* === BATCH MODE: POST-ANSWER STYLES (Inline) === */
        .question-insights {
            border-top: 1px dashed rgba(148, 163, 184, 0.45);
            padding-top: 2rem; margin-top: 2rem;
            display: flex; flex-direction: column; gap: 1.5rem;
        }

        .question-stats-card {
            background: #ffffff; border-radius: 1rem; padding: 1.25rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            display: flex; flex-direction: column; gap: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .question-stats-header { display: flex; justify-content: space-between; align-items: center; }
        .question-stats-title { font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 0.5rem; }
        
        .question-stats-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        .stat-item { background: #f8fafc; border-radius: 0.75rem; padding: 0.75rem; border: 1px solid #e2e8f0; text-align: center; }
        .stat-value { display: block; font-size: 1.25rem; font-weight: 700; color: #0f172a; }
        .stat-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 600; }

        .extra-info-area { display: flex; flex-direction: column; gap: 1.5rem; }
        .info-section { background: #ffffff; border-radius: 1rem; border: 1px solid #e2e8f0; padding: 1.5rem; }
        .info-section h4 { font-weight: 700; color: #0f172a; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; }
        
        .note-textarea { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem; min-height: 120px; font-size: 0.95rem; }
        .content-display { color: #334155; line-height: 1.6; font-size: 0.95rem; }
    }

    @media (min-width: 1024px) {
        /* Force display block for tab panes used as grid items on desktop */
        #tab-pane-game, #tab-pane-stats { display: block !important; }
    }
</style>
{% endblock %}

{% block content %}
    {# Include BOTH partials, visibility controlled by CSS classes in files (lg:hidden vs hidden lg:block) #}
    {% include "quiz/individual/_quiz_session_single_mobile.html" %}
    {% include "quiz/individual/_quiz_session_single_desktop.html" %}

    {# Hub Modal (Shared structure but styled for Desktop via CSS overrides) #}
    <div id="explanation-hub-modal" class="qb-modal-overlay">
        <div class="qb-modal-container desktop:max-w-xl desktop:mx-auto desktop:h-[80vh] desktop:rounded-2xl">
            <div class="qb-hub-header">
                <h3 class="font-bold text-slate-800 text-lg">Chi ti·∫øt & H·ªçc t·∫≠p</h3>
                <button id="close-hub-btn" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="qb-hub-tabs">
                <div class="qb-hub-tab-item active" data-target="hub-expl">üìñ Gi·∫£i th√≠ch</div>
                <div class="qb-hub-tab-item" data-target="hub-ai">ü§ñ AI Coach</div>
                <div class="qb-hub-tab-item" data-target="hub-note">üìù Ghi ch√∫</div>
            </div>
            <div class="qb-hub-content">
                <!-- Expl Tab -->
                <div id="hub-expl" class="qb-hub-pane active">
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-slate-700 leading-relaxed">
                        <h4 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-circle-info"></i> Gi·∫£i th√≠ch:</h4>
                        <div id="hub-explanation-text">Ch∆∞a c√≥ gi·∫£i th√≠ch.</div>
                    </div>
                </div>
                <!-- AI Tab -->
                <div id="hub-ai" class="qb-hub-pane">
                     <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2 text-indigo-700 font-bold"><i class="fa-solid fa-robot"></i> <span>AI Ph√¢n T√≠ch</span></div>
                            <button id="ai-generate-btn" class="text-xs bg-white text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-200 font-semibold shadow-sm"><i class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o m·ªõi</button>
                        </div>
                        <div id="hub-ai-content" class="text-sm text-slate-700 leading-relaxed min-h-[100px]">Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...</div>
                    </div>
                </div>
                <!-- Note Tab -->
                <div id="hub-note" class="qb-hub-pane">
                    <textarea id="hub-note-input" class="w-full p-3 rounded-xl border border-slate-200 text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition" rows="8" placeholder="Ghi ch√∫ c·ªßa b·∫°n..."></textarea>
                    <button id="hub-note-save" class="mt-2 w-full py-2 rounded-lg bg-blue-100 text-blue-700 font-semibold text-sm hover:bg-blue-200">L∆∞u ghi ch√∫</button>
                </div>
            </div>
        </div>
    </div>
    <style>
        /* Desktop specific overrides for Hub to center it and handle visibility */
        @media (min-width: 1024px) {
            .qb-modal-overlay.open .qb-modal-container { 
                transform: translate(0, -50%) scale(1) !important; 
                top: 50% !important; 
                bottom: auto !important; 
                max-width: 600px; 
                margin: 0 auto;
                height: 80vh;
                border-radius: 1rem;
            }
        }
    </style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
    // URLs & Meta
    const getQuestionBatchUrl = "{{ url_for('learning.quiz_learning.get_question_batch') }}";
    const submitAnswerBatchUrl = "{{ url_for('learning.quiz_learning.submit_answer_batch') }}";
    const quizDashboardUrl = "{{ url_for('learning.quiz_learning.quiz_learning_dashboard') }}";
    const getAiResponseUrl = "{{ url_for('ai_services.get_ai_response') }}";
    const saveNoteUrlTemplate = "{{ url_for('notes.save_note', item_id=0) }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    // State
    let currentBatch = [];
    let currentIndex = 0; 
    let userAnswers = {};
    let sessionStats = { total: 0, correct: 0, total_questions: 0 };
    let currentQuestion = null;

    // Helper: Update text/html for ALL matching elements (Mobile & Desktop)
    const setText = (selector, text) => document.querySelectorAll(selector).forEach(el => el.textContent = text);
    const setHtml = (selector, html) => document.querySelectorAll(selector).forEach(el => el.innerHTML = html);
    const toggleClass = (selector, cls, force) => document.querySelectorAll(selector).forEach(el => el.classList.toggle(cls, force));

    function formatTextForHtml(text) {
        if (text === null || text === undefined) return '';
        const tempDiv = document.createElement('div');
        tempDiv.textContent = text;
        return tempDiv.innerHTML.replace(/\r?\n/g, '<br>');
    }

    // Elements (Single selections for event binding)
    const dom = {
        // Hub
        hubModal: document.getElementById('explanation-hub-modal'),
        openHubBtn: document.getElementById('open-hub-btn'),
        openHubDesktopBtn: document.getElementById('open-hub-desktop-btn'),
        closeHubBtn: document.getElementById('close-hub-btn'),
        
        hubExplText: document.getElementById('hub-explanation-text'),
        hubAiContent: document.getElementById('hub-ai-content'),
        aiGenerateBtn: document.getElementById('ai-generate-btn'),
        hubNoteInput: document.getElementById('hub-note-input'),
        hubNoteSave: document.getElementById('hub-note-save'),
    };

    // --- Core Logic ---

    async function loadBatch() {
        showLoading(true);
        try {
            const res = await fetch(getQuestionBatchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) {
                if (res.status === 404) return finishSession();
                throw new Error('Load failed');
            }
            const data = await res.json();
            currentBatch = data.items || [];
            currentIndex = 0;
            
            // Init Session Stats
            sessionStats.total_questions = data.total_question_groups_in_session || data.total_items_in_session || 0;
            sessionStats.total = data.session_total_answered || 0;
            sessionStats.correct = data.session_correct_answers || 0;
            updateStatsUI();

            if (currentBatch.length > 0) {
                renderQuestion(currentBatch[currentIndex]);
            } else {
                finishSession();
            }
        } catch (e) {
            console.error(e);
            alert('L·ªói t·∫£i c√¢u h·ªèi. Vui l√≤ng th·ª≠ l·∫°i.');
        } finally {
            showLoading(false);
        }
    }

    function renderQuestion(q) {
        currentQuestion = q;
        const qNum = (sessionStats.total + currentIndex + 1);
        setText('.js-question-header', `C√¢u h·ªèi ${qNum}`);
        setHtml('.js-question-text', q.content.question);
        
        // Media
        setHtml('.js-question-media', '');
        toggleClass('.js-question-media', 'hidden', true);
        if (q.content.question_image_file) {
            const imgHtml = `<img src="${q.content.question_image_file}">`;
            document.querySelectorAll('.js-question-media').forEach(el => {
                el.innerHTML = imgHtml;
                el.classList.remove('hidden');
            });
        }

        // Options
        const optionsHtml = Object.entries(q.content.options || {}).map(([key, val]) => `
            <div class="qb-option-label" data-key="${key}">
                <span class="qb-option-letter-circle">${key}</span>
                <span class="text-slate-800 font-medium text-lg leading-tight mt-1">${val}</span>
            </div>
        `).join('');
        setHtml('.js-options-grid', optionsHtml);
        
        // Add listeners to ALL option containers (both views)
        document.querySelectorAll('.js-options-grid').forEach(grid => {
            grid.querySelectorAll('.qb-option-label').forEach(el => {
                el.addEventListener('click', () => selectOption(el.dataset.key));
            });
        });
        
        // Populate Desktop Batch-Like Options
        const desktopOptionsHtml = Object.entries(q.content.options || {}).map(([key, val]) => `
            <button class="option-button" data-option="${key}">
                <span class="option-key">${key}</span>
                <span>${val}</span>
            </button>
        `).join('');
        // We need to inject this into the desktop grid specifically if it uses a different class structure, 
        // but our CSS update made .qb-options-grid work for both. 
        // Ideally, we update the HTML to distinguish or just use the same structure. 
        // For now, let's assume .js-options-grid handles both or we target desktop specifically.
        // Actually, looking at _desktop partial, it uses .js-options-grid too. 
        // Let's inject the BUTTON structure for desktop if we can detect it, or update the partial.
        // Better: Update .js-options-grid in desktop partial to use the button structure directly? 
        // Or just let JS inject different HTML based on parent? 
        // Current JS injects the MOBILE structure (div with .qb-option-label).
        // Let's fix this: We will update the desktop grid manually.
        const desktopGrid = document.querySelector('.hidden.lg\\:block .js-options-grid');
        if(desktopGrid) {
            desktopGrid.innerHTML = desktopOptionsHtml;
            desktopGrid.querySelectorAll('.option-button').forEach(el => {
                el.addEventListener('click', () => selectOption(el.dataset.option));
            });
        }

        // Reset UI
        toggleClass('.js-result-panel', 'hidden', true);
        toggleClass('#desktop-insights-area', 'hidden', true); // Hide desktop inline insights
        if(dom.openHubBtn) dom.openHubBtn.classList.add('hidden');
        if(dom.openHubDesktopBtn) dom.openHubDesktopBtn.classList.add('hidden'); // Hide "Tools" button initially
        
        // Reset Buttons
        updateActionButtons(true, '<i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n', 'submit');
        
        // Reset Content (Both Hub and Desktop Inline)
        setText('#hub-explanation-text', "Ch∆∞a c√≥ gi·∫£i th√≠ch.");
        setHtml('#desktop-explanation-content', "");
        toggleClass('#desktop-explanation', 'hidden', true);

        // AI Content
        const aiDefault = "Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...";
        setText('#hub-ai-content', aiDefault);
        setHtml('#desktop-ai-content', `<span class="italic text-slate-500">${aiDefault}</span>`);
        
        // Note Content
        const noteVal = q.note_content || "";
        if(dom.hubNoteInput) dom.hubNoteInput.value = noteVal;
        const dNote = document.getElementById('desktop-note-input');
        if(dNote) dNote.value = noteVal;
    }

    function selectOption(key) {
        // Update selection in Mobile
        document.querySelectorAll('.qb-option-label').forEach(el => {
            if (el.dataset.key === key) el.classList.add('selected');
            else el.classList.remove('selected');
        });
        
        // Update selection in Desktop
        document.querySelectorAll('.option-button').forEach(el => {
            if (el.dataset.option === key) el.classList.add('selected');
            else el.classList.remove('selected');
        });
        
        userAnswers[currentQuestion.item_id] = key;
        updateActionButtons(false, null, null, true); // Enable primary style
    }

    async function submitAnswer() {
        const itemId = currentQuestion.item_id;
        const answer = userAnswers[itemId];
        if (!answer) return;

        updateActionButtons(true, '<i class="fas fa-circle-notch fa-spin"></i> ƒêang g·ª≠i...');

        try {
            const res = await fetch(submitAnswerBatchUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ answers: [{ item_id: itemId, user_answer: answer }] })
            });
            const data = await res.json();
            const result = data.results[0];

            // Show Feedback
            showFeedback(result);
            
            // Update Stats
            sessionStats.total++;
            if (result.is_correct) sessionStats.correct++;
            updateStatsUI();

            // Setup Next Button
            updateActionButtons(false, '<i class="fa-solid fa-arrow-right"></i> Ti·∫øp theo', 'next');
            
            // Show Hub Button (Mobile)
            if(dom.openHubBtn) dom.openHubBtn.classList.remove('hidden');
            // Show Hub/Tools Button (Desktop - if needed, though now inline)
            // if(dom.openHubDesktopBtn) dom.openHubDesktopBtn.classList.remove('hidden'); 

        } catch (e) {
            console.error(e);
            alert('L·ªói g·ª≠i ƒë√°p √°n.');
            updateActionButtons(false);
        }
    }

    function showFeedback(result) {
        // Highlight Options in Mobile View
        document.querySelectorAll('.qb-option-label').forEach(el => {
            el.classList.add('disabled');
            el.classList.remove('selected');
            if (el.dataset.key === result.correct_answer) el.classList.add('correct');
            if (el.dataset.key === userAnswers[result.item_id] && !result.is_correct) el.classList.add('incorrect');
        });
        
        // Highlight Options in Desktop View (Batch Style)
        document.querySelectorAll('.option-button').forEach(el => {
            el.style.pointerEvents = 'none'; // Disable clicks
            el.classList.remove('selected');
            if (el.dataset.option === result.correct_answer) el.classList.add('correct');
            else if (el.dataset.option === userAnswers[result.item_id] && !result.is_correct) el.classList.add('incorrect');
        });

        // Show Panel
        toggleClass('.js-result-panel', 'hidden', false);
        toggleClass('#desktop-insights-area', 'hidden', false); // Reveal desktop inline insights
        
        // Update Content
        if (result.is_correct) {
            setText('.js-feedback-icon', 'üéâ');
            setText('.js-feedback-title', 'Ch√≠nh x√°c!');
            document.querySelectorAll('.js-feedback-title').forEach(el => el.className = 'text-lg font-bold text-emerald-600 js-feedback-title');
            document.querySelectorAll('.desktop-feedback-box').forEach(el => {
                 el.classList.remove('incorrect'); el.classList.add('correct');
            });
        } else {
            setText('.js-feedback-icon', 'ü§î');
            setText('.js-feedback-title', 'Sai r·ªìi');
            document.querySelectorAll('.js-feedback-title').forEach(el => el.className = 'text-lg font-bold text-rose-600 js-feedback-title');
             document.querySelectorAll('.desktop-feedback-box').forEach(el => {
                 el.classList.remove('correct'); el.classList.add('incorrect');
            });
        }
        setText('.js-feedback-answer', result.correct_answer);

        // Populate Explanations (Hub & Desktop Inline)
        const explanationHtml = result.explanation || "Ch∆∞a c√≥ gi·∫£i th√≠ch.";
        if(dom.hubExplText) dom.hubExplText.innerHTML = explanationHtml;
        
        if (result.explanation) {
             const dtExpl = document.getElementById('desktop-explanation');
             const dtExplContent = document.getElementById('desktop-explanation-content');
             if(dtExpl && dtExplContent) {
                 dtExpl.classList.remove('hidden');
                 dtExplContent.innerHTML = result.explanation;
             }
        }
        
        // Populate AI if already exists
        if (currentQuestion.ai_explanation) {
            if(dom.hubAiContent) dom.hubAiContent.innerHTML = currentQuestion.ai_explanation;
            setHtml('#desktop-ai-content', currentQuestion.ai_explanation);
        }
    }

    function nextQuestion() {
        const dtExpl = document.getElementById('desktop-explanation');
        if(dtExpl) dtExpl.classList.add('hidden');
        
        currentIndex++;
        if (currentIndex < currentBatch.length) {
            renderQuestion(currentBatch[currentIndex]);
        } else {
            loadBatch(); 
        }
    }

    function finishSession() {
        alert('ƒê√£ ho√†n th√†nh phi√™n h·ªçc!');
        window.location.href = quizDashboardUrl;
    }

    // --- Helpers ---
    function showLoading(show) {
        toggleClass('.js-quiz-loading', 'hidden', !show);
        toggleClass('.js-quiz-content', 'hidden', show);
    }

    function updateActionButtons(disabled, text, action, primary) {
        const btns = [document.getElementById('mobile-action-btn'), document.getElementById('desktop-action-btn')];
        btns.forEach(btn => {
            if(!btn) return;
            if(disabled !== undefined) btn.disabled = disabled;
            if(text) btn.innerHTML = text;
            if(action) btn.dataset.action = action;
            if(primary) btn.classList.add('cm-btn-primary');
        });
    }

    function updateStatsUI() {
        const acc = sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0;
        
        setText('.js-stat-total', sessionStats.total); // Covers desktop total + mobile progress parts if mapped
        setText('.js-stat-correct', sessionStats.correct); // Mobile header score
        setText('.js-stat-accuracy', `${acc}%`);
        setText('.js-stat-progress-text', `${sessionStats.total}/${sessionStats.total_questions}`);
        
        document.querySelectorAll('.js-stat-progress-bar').forEach(el => {
            el.style.width = `${(sessionStats.total / sessionStats.total_questions) * 100}%`;
        });
    }

    // --- AI & Notes Handlers (Unified) ---
    const handleAiGenerate = async (btn) => {
        if(!btn) return;
        btn.disabled = true;
        const loadingText = "ƒêang t·∫°o...";
        if(dom.hubAiContent) dom.hubAiContent.textContent = loadingText;
        setHtml('#desktop-ai-content', `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`);
        
        try {
            const res = await fetch(getAiResponseUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ item_id: currentQuestion.item_id, prompt_type: 'explanation' })
            });
            const data = await res.json();
            const content = data.html_content || data.response;
            
            // Update BOTH views
            if(dom.hubAiContent) dom.hubAiContent.innerHTML = content;
            setHtml('#desktop-ai-content', content);
            
            currentQuestion.ai_explanation = content;
        } catch (e) {
            const errHtml = '<span class="text-red-500">L·ªói khi g·ªçi AI.</span>';
            if(dom.hubAiContent) dom.hubAiContent.innerHTML = errHtml;
            setHtml('#desktop-ai-content', errHtml);
        }
        btn.disabled = false;
    };

    const handleSaveNote = async (btn, inputEl) => {
        if(!btn || !inputEl) return;
        const originalText = btn.innerHTML;
        const content = inputEl.value;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> L∆∞u...';
        btn.disabled = true;

        try {
            await fetch(saveNoteUrlTemplate.replace('0', currentQuestion.item_id), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ content })
            });
            currentQuestion.note_content = content;
            
            // Sync value to other view's input
            if(dom.hubNoteInput && dom.hubNoteInput !== inputEl) dom.hubNoteInput.value = content;
            const dInput = document.getElementById('desktop-note-input');
            if(dInput && dInput !== inputEl) dInput.value = content;
            
            alert('ƒê√£ l∆∞u ghi ch√∫.');
        } catch (e) {
            alert('L·ªói l∆∞u ghi ch√∫.');
        }
        btn.innerHTML = originalText;
        btn.disabled = false;
    };

    // Bind AI Buttons
    if(dom.aiGenerateBtn) dom.aiGenerateBtn.addEventListener('click', () => handleAiGenerate(dom.aiGenerateBtn));
    const dAiBtn = document.getElementById('desktop-ai-generate-btn');
    if(dAiBtn) dAiBtn.addEventListener('click', () => handleAiGenerate(dAiBtn));

    // Bind Note Save Buttons
    if(dom.hubNoteSave) dom.hubNoteSave.addEventListener('click', () => handleSaveNote(dom.hubNoteSave, dom.hubNoteInput));
    const dNoteSave = document.getElementById('desktop-note-save');
    const dNoteInput = document.getElementById('desktop-note-input');
    if(dNoteSave) dNoteSave.addEventListener('click', () => handleSaveNote(dNoteSave, dNoteInput));

    // Event Delegation for Action Buttons
    const handleAction = () => {
        const btn = document.getElementById('mobile-action-btn') || document.getElementById('desktop-action-btn');
        if (btn.dataset.action === 'submit') submitAnswer();
        else nextQuestion();
    };

    const mBtn = document.getElementById('mobile-action-btn');
    const dBtn = document.getElementById('desktop-action-btn');
    if(mBtn) mBtn.addEventListener('click', handleAction);
    if(dBtn) dBtn.addEventListener('click', handleAction);

    // Mobile Tabs
    document.querySelectorAll('.qb-mobile-tab-item').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.qb-mobile-tab-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.qb-tab-pane').forEach(p => p.classList.remove('active'));
            
            tab.classList.add('active');
            const pane = document.getElementById(`tab-pane-${tab.dataset.tab}`);
            if(pane) pane.classList.add('active');
        });
    });

    // Hub Modal
    if(dom.hubModal) {
        if(dom.openHubBtn) dom.openHubBtn.addEventListener('click', () => dom.hubModal.classList.add('open'));
        if(dom.openHubDesktopBtn) dom.openHubDesktopBtn.addEventListener('click', () => dom.hubModal.classList.add('open'));
        if(dom.closeHubBtn) dom.closeHubBtn.addEventListener('click', () => dom.hubModal.classList.remove('open'));
    }
    
    // Hub Tabs
    document.querySelectorAll('.qb-hub-tab-item').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.qb-hub-tab-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.qb-hub-pane').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            const pane = document.getElementById(tab.dataset.target);
            if(pane) pane.classList.add('active');
        });
    });

    // Exit
    const exitHandler = () => { if(confirm('K·∫øt th√∫c phi√™n l√†m b√†i?')) finishSession(); };
    const mExit = document.getElementById('mobile-exit-btn');
    if(mExit) mExit.addEventListener('click', exitHandler);
    const dExit = document.getElementById('desktop-exit-btn');
    if(dExit) dExit.addEventListener('click', exitHandler);

    // Init
    loadBatch();

})();
</script>
{% endblock %}