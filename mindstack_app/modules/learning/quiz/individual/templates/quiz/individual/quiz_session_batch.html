<!-- mindstack_app/modules/learning/quiz/individual/templates/quiz/individual/quiz_session_batch.html -->
<!-- Phiên bản: 4.0 (Responsive Batch Mode - Dual Render) -->
<!-- MỤC ĐÍCH: Giao diện làm bài nhiều câu hỏi (Batch) có hỗ trợ giao diện Mobile riêng biệt. -->

{% extends "base.html" %}

{% block title %}Làm bài Quiz{% endblock %}

{% block head %}
{{ super() }}
{% include 'content_management/_shared_styles.html' %}
<style>
    body {
        font-family: 'Inter', sans-serif;
        background: #f1f5f9;
    }

    /* === CORE LAYOUT STYLES (From Original Batch) === */
    .quiz-shell {
        background: linear-gradient(180deg, rgba(248, 250, 252, 0.9) 0%, rgba(226, 232, 240, 0.35) 100%);
        min-height: 100vh;
    }

    .quiz-shell .cm-container {
        gap: 1.5rem;
    }

    .quiz-section-header {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    @media (min-width: 1024px) {
        .quiz-section-header {
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
        }
    }

    .quiz-heading-group .cm-subheading {
        max-width: 38rem;
    }

    .quiz-session-overview {
        display: flex;
        justify-content: flex-end;
        width: 100%;
    }

    .quiz-progress-card {
        position: relative;
        width: min(100%, 440px);
        padding: 1.5rem 1.75rem;
        border-radius: 1.1rem;
        background: #ffffff;
        color: #0f172a;
        border: 1px solid #e2e8f0;
        box-shadow: none;
    }

    .quiz-progress-card::before {
        content: none;
    }

    .quiz-progress-card>* {
        position: relative;
        z-index: 1;
    }

    .progress-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .progress-card-title {
        display: flex;
        align-items: center;
        gap: 0.85rem;
    }

    .progress-card-icon {
        width: 2.5rem;
        height: 2.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem;
        background: #e2e8f0;
        color: #1d4ed8;
        font-size: 1.15rem;
    }

    .progress-card-title-text {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .progress-card-heading {
        font-size: 1.05rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        color: #0f172a;
    }

    .progress-card-subtitle {
        font-size: 0.8rem;
        color: #475569;
    }

    .progress-card-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.35rem 0.8rem;
        border-radius: 9999px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        color: #1e293b;
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.12em;
        text-transform: uppercase;
    }

    .progress-card-body {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .progress-card-stats-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.75rem;
    }

    .progress-stat-item {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        padding: 0.85rem 1rem;
        border-radius: 0.85rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        text-align: center;
    }

    .progress-stat-value {
        font-size: 1.55rem;
        font-weight: 700;
        line-height: 1.1;
        color: #0f172a;
        font-variant-numeric: tabular-nums;
    }

    .progress-stat-value--answered {
        color: #0f172a;
    }

    .progress-stat-value--correct {
        color: #16a34a;
    }

    .progress-stat-value--accuracy {
        color: #0284c7;
    }

    .progress-stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #64748b;
    }

    .progress-metric {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
    }

    .progress-metric-label {
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #64748b;
    }

    .progress-bar-track {
        width: 100%;
        height: 0.55rem;
        border-radius: 9999px;
        background: #e2e8f0;
        overflow: hidden;
        position: relative;
    }

    .progress-bar-fill {
        position: absolute;
        inset: 0;
        width: 0%;
        border-radius: 9999px;
        background: #3b82f6;
        transition: width 0.4s ease;
    }

    .progress-card-footer {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem;
    }

    .progress-footer-item {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        padding: 0.75rem 1rem;
        border-radius: 0.85rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
    }

    .progress-footer-label {
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #64748b;
    }

    .progress-footer-value {
        font-size: 1.15rem;
        font-weight: 700;
        color: #0f172a;
        font-variant-numeric: tabular-nums;
    }

    .quiz-card {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        border-radius: 1.25rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 24px 50px -35px rgba(15, 23, 42, 0.45);
    }

    .quiz-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .question-card {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 1.75rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .question-stats-card {
        background: #ffffff;
        border-radius: 1rem;
        padding: 1.25rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .stat-icon-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #64748b;
        font-size: 0.85rem;
        text-transform: uppercase;
    }

    .stat-icon-label i {
        font-size: 0.95rem;
        color: #1d4ed8;
    }

    /* === MOBILE SPECIFIC STYLES (Copied & Adapted for Batch Mobile View) === */
    .qb-mobile-sticky-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .qb-mobile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px 4px 16px;
    }

    .qb-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 12px 16px;
        border-top: 1px solid #e2e8f0;
        z-index: 60;
        display: flex;
        gap: 10px;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    /* Override defaults for Mobile */
    @media (max-width: 1023px) {

        body>header,
        nav.navbar,
        footer,
        .site-footer,
        .back-to-top {
            display: none !important;
        }

        body {
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            background-color: #f8fafc;
        }

        /* Adjustments for Batch Card in Mobile View handled by partial HTML structure */
        .question-card {
            padding: 1rem;
        }

        .option-button {
            padding: 0.85rem 1rem;
        }
    }

    /* === QUIZ SPECIFIC ELEMENTS === */
    .options-container {
        display: grid;
        gap: 0.75rem;
    }

    .option-button {
        display: flex;
        align-items: flex-start;
        gap: 0.85rem;
        width: 100%;
        padding: 1rem 1.1rem;
        border-radius: 0.9rem;
        border: 1px solid rgba(148, 163, 184, 0.7);
        background: rgba(255, 255, 255, 0.9);
        color: #0f172a;
        font-size: 0.95rem;
        line-height: 1.5;
        transition: all 0.25s ease;
        cursor: pointer;
    }

    .option-button:hover {
        border-color: #1d4ed8;
        box-shadow: 0 10px 24px -18px rgba(29, 78, 216, 0.9);
        transform: translateY(-1px);
    }

    .option-button span:first-child {
        font-weight: 700;
        min-width: 1.5rem;
        color: #1d4ed8;
    }

    .option-button.selected {
        border-color: #1d4ed8;
        background: rgba(37, 99, 235, 0.08);
    }

    .option-button.correct {
        border-color: #16a34a;
        background: rgba(22, 163, 74, 0.12);
    }

    .option-button.incorrect {
        border-color: #dc2626;
        background: rgba(220, 38, 38, 0.12);
    }

    .quiz-image {
        border-radius: 0.9rem;
        box-shadow: 0 14px 34px -28px rgba(15, 23, 42, 0.6);
        max-width: 100%;
    }

    /* Feedback Box */
    .feedback-box {
        border-radius: 0.9rem;
        padding: 1rem 1.15rem;
        font-weight: 500;
        display: flex;
        align-items: flex-start;
        gap: 0.85rem;
    }

    .feedback-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .feedback-text {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .feedback-correct {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(59, 130, 246, 0.08));
        color: #166534;
        border: 1px solid rgba(22, 163, 74, 0.35);
    }

    .feedback-correct .feedback-icon {
        background: rgba(34, 197, 94, 0.25);
        color: #15803d;
    }

    .feedback-incorrect {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(248, 113, 113, 0.12));
        color: #b45309;
        border: 1px solid rgba(251, 191, 36, 0.35);
    }

    .feedback-incorrect .feedback-icon {
        background: rgba(251, 191, 36, 0.3);
        color: #b45309;
    }

    .feedback-explanation {
        background: rgba(241, 245, 249, 0.85);
        border-radius: 0.75rem;
        padding: 0.85rem 1rem;
        margin-top: 0.75rem;
    }

    /* Buttons */
    .cm-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
    }

    .cm-btn-primary {
        background: #2563eb;
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .cm-btn-primary:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
    }

    .control-button {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.85rem 1.6rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: none;
        cursor: pointer;
    }

    .control-button:disabled {
        opacity: 0.65;
        cursor: not-allowed;
    }

    .control-button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 16px 36px -30px rgba(15, 23, 42, 0.65);
    }

    /* Toast */
    .quiz-toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 2000;
        pointer-events: none;
    }

    .quiz-toast {
        background: #1f2937;
        color: #ffffff;
        padding: 0.75rem 1.1rem;
        border-radius: 0.85rem;
        box-shadow: 0 18px 38px -25px rgba(15, 23, 42, 0.65);
        font-size: 0.92rem;
        font-weight: 500;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        pointer-events: auto;
        max-width: 320px;
    }

    .quiz-toast.visible {
        opacity: 1;
        transform: translateY(0);
    }
</style>
{% endblock %}

{% block content %}
{# Include Mobile and Desktop Partials #}
{% include "quiz/individual/_quiz_session_batch_mobile.html" %}
{% include "quiz/individual/_quiz_session_batch_desktop.html" %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // === DUAL RENDERING UPDATE HELPER ===
    // Supports targeting elements in both mobile and desktop views via shared classes.
    const setText = (selector, text) => document.querySelectorAll(selector).forEach(el => el.textContent = text);
    const setHtml = (selector, html) => document.querySelectorAll(selector).forEach(el => el.innerHTML = html);
    const toggleClass = (selector, cls, force) => document.querySelectorAll(selector).forEach(el => el.classList.toggle(cls, force));
    const setStyle = (selector, prop, val) => document.querySelectorAll(selector).forEach(el => el.style[prop] = val);
    const setAttr = (selector, attr, val) => document.querySelectorAll(selector).forEach(el => el.setAttribute(attr, val));

    // --- Global State ---
    let currentQuestionBatch = [];
    let currentBatchMeta = { startIndex: 0, totalItemsInSession: 0 };
    let userAnswers = {};
    let isBatchSubmitted = false;
    let totalQuestionsInSession = 0;
    let sessionTotalAnswered = 0;

    // URLs
    const getQuestionBatchUrl = "{{ url_for('learning.quiz_learning.get_question_batch') }}";
    const submitAnswerBatchUrl = "{{ url_for('learning.quiz_learning.submit_answer_batch') }}";
    const endSessionUrl = "{{ url_for('learning.quiz_learning.end_session') }}";
    const getAiResponseUrl = "{{ url_for('ai_services.get_ai_response') }}";
    const saveNoteUrl = "{{ url_for('notes.save_note', item_id=0) }}";
    const quizDashboardUrl = "{{ url_for('learning.quiz_learning.quiz_learning_dashboard') }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    const csrfHeaders = csrfToken ? { 'X-CSRFToken': csrfToken } : {};

    // --- Init ---
    document.addEventListener('DOMContentLoaded', getNextQuestionBatch);

    // --- Functions ---

    const numberFormatter = new Intl.NumberFormat('vi-VN');
    const percentageFormatter = new Intl.NumberFormat('vi-VN', { maximumFractionDigits: 1, minimumFractionDigits: 0 });

    function updateProgressCard() {
        const totalInSession = Number(totalQuestionsInSession) || 0;
        const answered = Number(sessionTotalAnswered) || 0;
        const hasTotal = totalInSession > 0;

        if (hasTotal) {
            const cappedAnswered = Math.min(answered, totalInSession);
            setText('.js-quiz-total-label', `${numberFormatter.format(cappedAnswered)} / ${numberFormatter.format(totalInSession)}`);
        } else {
            setText('.js-quiz-total-label', numberFormatter.format(answered));
        }

        if (hasTotal) {
            const remaining = Math.max(totalInSession - answered, 0);
            setText('.js-quiz-remaining-label', numberFormatter.format(remaining));
        } else {
            setText('.js-quiz-remaining-label', '--');
        }

        const progressWidth = hasTotal ? Math.min((answered / totalInSession) * 100, 100) : 0;
        setStyle('.js-quiz-progress-fill', 'width', `${progressWidth}%`);
    }

    function updateSessionSummary(correct = 0, total = 0) {
        const safeTotal = Number(total) || 0;
        const safeCorrect = Number(correct) || 0;
        sessionTotalAnswered = safeTotal;

        setText('.js-session-total-count', numberFormatter.format(safeTotal));
        setText('.js-session-correct-count', numberFormatter.format(safeCorrect));

        const accuracy = safeTotal > 0 ? (safeCorrect / safeTotal) * 100 : 0;
        setText('.js-session-accuracy', `${percentageFormatter.format(accuracy)}%`);

        updateProgressCard();
    }

    async function getNextQuestionBatch() {
        setHtml('.js-quiz-content', `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải câu hỏi...</p></div>`);
        toggleControlButtons('loading');

        try {
            const response = await fetch(getQuestionBatchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) {
                if (response.status === 404) {
                    handleSessionComplete(await response.json());
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const batchData = await response.json();
            displayQuestionBatch(batchData);
        }
        catch (error) {
            console.error('Lỗi khi tải nhóm câu hỏi:', error);
            setHtml('.js-quiz-content', `<p class="text-red-500 text-center p-4">Không thể tải câu hỏi. Vui lòng thử lại.</p>`);
            toggleControlButtons('error');
        }
    }

    function displayQuestionBatch(batchData) {
        currentQuestionBatch = batchData.items;
        currentBatchMeta = {
            startIndex: batchData.start_index || 0,
            totalItemsInSession: batchData.total_items_in_session || batchData.items.length
        };
        userAnswers = {};
        isBatchSubmitted = false;

        const totalGroupsFallback = batchData.total_question_groups_in_session || currentBatchMeta.totalItemsInSession;
        totalQuestionsInSession = Number(totalGroupsFallback) || currentQuestionBatch.length;
        updateSessionSummary(batchData.session_correct_answers, batchData.session_total_answered);

        // Render HTML
        const fullBatchContentHtml = currentQuestionBatch
            .map((questionData, index) => buildQuestionCardHtml(questionData, index))
            .join('');

        setHtml('.js-quiz-content', fullBatchContentHtml);

        const startRange = batchData.question_number_min || (currentBatchMeta.startIndex + 1);
        const endRange = batchData.question_number_max || (currentBatchMeta.startIndex + currentQuestionBatch.length);
        const totalInSession = totalQuestionsInSession;
        setText('.js-quiz-group-range', totalInSession ? `Câu ${startRange}-${endRange}` : '---');

        updateProgressCard();
        attachOptionHandlers();
        toggleControlButtons('answering');
    }

    function buildQuestionCardHtml(questionData, index) {
        const questionNumber = questionData.display_number || ((currentBatchMeta.startIndex || 0) + index + 1);
        const totalQuestions = totalQuestionsInSession;
        const content = questionData.content || {};

        // Build Options
        let optionsHtml = '';
        const options = content.options || {};
        ['A', 'B', 'C', 'D'].forEach(key => {
            if (options[key]) {
                optionsHtml += `
                        <button class="option-button" data-question-id="${questionData.item_id}" data-option="${key}">
                            <span>${key}</span> <span>${formatTextForHtml(options[key])}</span>
                        </button>`;
            }
        });

        // Build Media
        let mediaHtml = '';
        if (content.question_image_file) {
            mediaHtml += `<img src="${content.question_image_file}" alt="Hình ảnh" class="quiz-image mb-4">`;
        }
        if (content.question_audio_file) {
            mediaHtml += `<audio controls src="${content.question_audio_file}" class="w-full mb-4"></audio>`;
        }

        return `
                <div class="question-card" data-item-id="${questionData.item_id}">
                    <div class="flex justify-between items-center text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">
                        <span>Câu ${questionNumber}</span>
                    </div>
                    <h2 class="text-xl font-bold text-slate-900 mb-4">${formatTextForHtml(content.question)}</h2>
                    ${mediaHtml}
                    <div class="options-container">${optionsHtml}</div>
                    <div class="feedback-area mt-4"></div>
                </div>
            `;
    }

    function attachOptionHandlers() {
        // Attach to ONE set of buttons but logic updates ALL matching buttons in DOM
        // Actually, for cleaner dual sync, we attach to document body delegation or loop all.
        // Since we have multiple questions loops, querySelectorAll is safely used.
        document.querySelectorAll('.option-button').forEach(button => {
            button.removeEventListener('click', handleOptionClick); // Prevent duplicates if re-runs
            button.addEventListener('click', handleOptionClick);
        });
    }

    function handleOptionClick(e) {
        if (isBatchSubmitted) return;
        const btn = e.currentTarget;
        const questionId = btn.dataset.questionId;
        const selectedOption = btn.dataset.option;

        // Update State
        userAnswers[questionId] = selectedOption;

        // Update UI (Sync across all views)
        // Deselect all for this question
        document.querySelectorAll(`.option-button[data-question-id="${questionId}"]`).forEach(b => b.classList.remove('selected'));
        // Select the clicked option (in both mobile/desktop)
        document.querySelectorAll(`.option-button[data-question-id="${questionId}"][data-option="${selectedOption}"]`).forEach(b => b.classList.add('selected'));
    }

    async function submitAnswerBatch() {
        if (isBatchSubmitted) return;
        const allAnswered = currentQuestionBatch.every(q => userAnswers.hasOwnProperty(q.item_id));
        if (!allAnswered) {
            showCustomAlert("Vui lòng trả lời tất cả các câu hỏi.");
            return;
        }

        isBatchSubmitted = true;
        toggleControlButtons('submitting');

        const answersToSend = Object.keys(userAnswers).map(itemId => ({
            item_id: parseInt(itemId),
            user_answer: userAnswers[itemId]
        }));

        try {
            const response = await fetch(submitAnswerBatchUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...csrfHeaders },
                body: JSON.stringify({ answers: answersToSend })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const responseData = await response.json();

            // Process Results
            responseData.results.forEach(result => {
                // Update UI for each question in ALL views
                const questionCards = document.querySelectorAll(`.question-card[data-item-id="${result.item_id}"]`);
                questionCards.forEach(card => {
                    const feedbackArea = card.querySelector('.feedback-area');

                    // 1. Show Feedback
                    let feedbackHtml = result.is_correct ?
                        `<div class="feedback-box feedback-correct"><span class="feedback-icon"><i class="fas fa-check-circle"></i></span><div class="feedback-text"><strong>Chính xác!</strong></div></div>` :
                        `<div class="feedback-box feedback-incorrect"><span class="feedback-icon"><i class="fas fa-times-circle"></i></span><div class="feedback-text"><strong>Sai rồi</strong><span>Đáp án đúng: ${result.correct_answer}</span></div></div>`;

                    if (result.explanation) {
                        feedbackHtml += `<div class="feedback-explanation"><strong>Giải thích:</strong><div class="mt-1 text-sm text-slate-700">${formatTextForHtml(result.explanation)}</div></div>`;
                    }
                    feedbackArea.innerHTML = feedbackHtml;

                    // 2. Lock Options & Highlight
                    card.querySelectorAll('.option-button').forEach(btn => {
                        btn.classList.remove('selected'); // Remove selection style first
                        const opt = btn.dataset.option;
                        if (opt === result.correct_answer) btn.classList.add('correct');
                        else if (opt === userAnswers[result.item_id] && !result.is_correct) btn.classList.add('incorrect');
                        btn.style.pointerEvents = 'none'; // Disable click
                    });
                });
            });

            updateSessionSummary(responseData.session_correct_answers, responseData.session_total_answered);
            toggleControlButtons('submitted');

        } catch (error) {
            console.error(error);
            showCustomAlert('Có lỗi xảy ra khi gửi đáp án.');
            isBatchSubmitted = false;
            toggleControlButtons('answering');
        }
    }

    function toggleControlButtons(state) {
        // state: loading, error, answering, submitting, submitted
        const submits = document.querySelectorAll('.js-submit-batch-btn');
        const nexts = document.querySelectorAll('.js-next-batch-btn');

        submits.forEach(btn => btn.style.display = 'none');
        nexts.forEach(btn => btn.style.display = 'none');

        if (state === 'answering') {
            submits.forEach(btn => { btn.style.display = 'inline-flex'; btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="control-button-text">Gửi đáp án</span>'; });
        } else if (state === 'submitting') {
            submits.forEach(btn => { btn.style.display = 'inline-flex'; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...'; });
        } else if (state === 'submitted') {
            nexts.forEach(btn => btn.style.display = 'inline-flex');
        }
    }

    function handleSessionComplete(endMessage) {
        setText('.js-quiz-group-range', 'Hoàn thành');
        const msgHtml = `<div class="text-center py-12 px-6"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h3 class="text-xl font-bold text-slate-800 mb-2">Hoàn thành phiên học!</h3><p class="text-slate-500 mb-6">${formatTextForHtml(endMessage.message)}</p><a href="${quizDashboardUrl}" class="cm-btn cm-btn-primary"><i class="fas fa-home"></i> Về Dashboard</a></div>`;
        setHtml('.js-quiz-content', msgHtml);
        toggleControlButtons('complete'); // Hides all
        document.querySelectorAll('.js-end-session-btn').forEach(btn => btn.style.display = 'none');
    }

    async function handleEndSession() {
        if (confirm('Bạn có chắc chắn muốn kết thúc phiên học hiện tại?')) {
            try {
                await fetch(endSessionUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', ...csrfHeaders }, body: JSON.stringify({}) });
                window.location.href = quizDashboardUrl;
            } catch (e) {
                showCustomAlert('Lỗi kết thúc phiên.', 'error');
            }
        }
    }

    // --- Bind Events ---
    document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        if (btn.classList.contains('js-submit-batch-btn')) submitAnswerBatch();
        if (btn.classList.contains('js-next-batch-btn')) getNextQuestionBatch();
        if (btn.classList.contains('js-end-session-btn')) handleEndSession();
    });

    // Utils
    function formatTextForHtml(text) {
        return text ? String(text).replace(/\n/g, '<br>') : '';
    }
    function showCustomAlert(msg, type = 'warning') {
        const container = document.querySelector('.quiz-toast-container') || (() => {
            const c = document.createElement('div'); c.className = 'quiz-toast-container'; document.body.appendChild(c); return c;
        })();
        const toast = document.createElement('div');
        toast.className = `quiz-toast`;
        toast.textContent = msg;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('visible'));
        setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

</script>
{% endblock %}