<!-- mindstack_app/modules/learning/quiz/individual/templates/quiz/individual/quiz_session_batch.html -->
<!-- Phi√™n b·∫£n: 4.2 (Responsive Batch - with Hub & Scroll Tracking) -->
<!-- M·ª§C ƒê√çCH: Giao di·ªán l√†m b√†i nhi·ªÅu c√¢u h·ªèi (Batch) c√≥ h·ªó tr·ª£ giao di·ªán Mobile ri√™ng bi·ªát v√† ch·ª©c nƒÉng Hub + Scroll Spy. -->

{% extends "base.html" %}

{% block title %}L√†m b√†i Quiz{% endblock %}

{% block head %}
{{ super() }}
{% include 'content_management/_shared_styles.html' %}
<style>
    body {
        font-family: 'Inter', sans-serif;
        background: #f1f5f9;
    }

    /* === CORE LAYOUT STYLES (From Original Batch) === */
    .quiz-shell {
        background: linear-gradient(180deg, rgba(248, 250, 252, 0.9) 0%, rgba(226, 232, 240, 0.35) 100%);
        min-height: 100vh;
    }

    .quiz-shell .cm-container {
        gap: 1.5rem;
    }

    .quiz-section-header {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    @media (min-width: 1024px) {
        .quiz-section-header {
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
        }
    }

    .quiz-heading-group .cm-subheading {
        max-width: 38rem;
    }

    .quiz-session-overview {
        display: flex;
        justify-content: flex-end;
        width: 100%;
    }

    .quiz-progress-card {
        position: relative;
        width: min(100%, 440px);
        padding: 1.5rem 1.75rem;
        border-radius: 1.1rem;
        background: #ffffff;
        color: #0f172a;
        border: 1px solid #e2e8f0;
        box-shadow: none;
    }

    .quiz-progress-card::before {
        content: none;
    }

    .quiz-progress-card>* {
        position: relative;
        z-index: 1;
    }

    .progress-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .progress-card-title {
        display: flex;
        align-items: center;
        gap: 0.85rem;
    }

    .progress-card-icon {
        width: 2.5rem;
        height: 2.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem;
        background: #e2e8f0;
        color: #1d4ed8;
        font-size: 1.15rem;
    }

    .progress-card-title-text {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .progress-card-heading {
        font-size: 1.05rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        color: #0f172a;
    }

    .progress-card-subtitle {
        font-size: 0.8rem;
        color: #475569;
    }

    .progress-card-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.35rem 0.8rem;
        border-radius: 9999px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        color: #1e293b;
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.12em;
        text-transform: uppercase;
    }

    .progress-card-body {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .progress-card-stats-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.75rem;
    }

    .progress-stat-item {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        padding: 0.85rem 1rem;
        border-radius: 0.85rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        text-align: center;
    }

    .progress-stat-value {
        font-size: 1.55rem;
        font-weight: 700;
        line-height: 1.1;
        color: #0f172a;
        font-variant-numeric: tabular-nums;
    }

    .progress-stat-value--answered {
        color: #0f172a;
    }

    .progress-stat-value--correct {
        color: #16a34a;
    }

    .progress-stat-value--accuracy {
        color: #0284c7;
    }

    .progress-stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #64748b;
    }

    .progress-metric {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
    }

    .progress-metric-label {
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #64748b;
    }

    .progress-bar-track {
        width: 100%;
        height: 0.55rem;
        border-radius: 9999px;
        background: #e2e8f0;
        overflow: hidden;
        position: relative;
    }

    .progress-bar-fill {
        position: absolute;
        inset: 0;
        width: 0%;
        border-radius: 9999px;
        background: #3b82f6;
        transition: width 0.4s ease;
    }

    .progress-card-footer {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem;
    }

    .progress-footer-item {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        padding: 0.75rem 1rem;
        border-radius: 0.85rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
    }

    .progress-footer-label {
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #64748b;
    }

    .progress-footer-value {
        font-size: 1.15rem;
        font-weight: 700;
        color: #0f172a;
        font-variant-numeric: tabular-nums;
    }

    .quiz-card {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        border-radius: 1.25rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 24px 50px -35px rgba(15, 23, 42, 0.45);
    }

    .quiz-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .question-card {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 1.75rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        position: relative;
        overflow: hidden;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    /* Highlight active card logic for debugging or visual cue (Optional) */
    .question-card.js-active-card {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .question-stats-card {
        background: #ffffff;
        border-radius: 1rem;
        padding: 1.25rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .stat-icon-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #64748b;
        font-size: 0.85rem;
        text-transform: uppercase;
    }

    .stat-icon-label i {
        font-size: 0.95rem;
        color: #1d4ed8;
    }

    /* === MOBILE SPECIFIC STYLES (Copied & Adapted for Batch Mobile View) === */
    .qb-mobile-sticky-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .qb-mobile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px 4px 16px;
    }

    .qb-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 12px 16px;
        border-top: 1px solid #e2e8f0;
        z-index: 60;
        display: flex;
        gap: 10px;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    /* Override defaults for Mobile */
    @media (max-width: 1023px) {

        body>header,
        nav.navbar,
        footer,
        .site-footer,
        .back-to-top {
            display: none !important;
        }

        body {
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            background-color: #f8fafc;
        }

        /* Adjustments for Batch Card in Mobile View handled by partial HTML structure */
        .question-card {
            padding: 1rem;
        }

        .option-button {
            padding: 0.85rem 1rem;
        }
    }

    /* === QUIZ SPECIFIC ELEMENTS === */
    .options-container {
        display: grid;
        gap: 0.75rem;
    }

    .option-button {
        display: flex;
        align-items: center;
        gap: 1rem;
        width: 100%;
        padding: 1rem 1.25rem;
        border-radius: 0.75rem;
        border: 1px solid #cbd5e1;
        background: white;
        text-align: left;
        font-size: 1rem;
        color: #334155;
        transition: all 0.2s;
        cursor: pointer;
    }

    .option-button:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .option-button span:first-child {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: #f1f5f9;
        color: #1e293b;
        font-weight: 700;
        font-size: 0.9rem;
        border: 1px solid #e2e8f0;
        flex-shrink: 0;
    }

    .option-button.selected {
        border-color: #3b82f6;
        background: #eff6ff;
        box-shadow: 0 0 0 1px #3b82f6;
    }

    .option-button.selected span:first-child {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .option-button.correct {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .option-button.correct span:first-child {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    .option-button.incorrect {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .option-button.incorrect span:first-child {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    .quiz-image {
        border-radius: 0.9rem;
        box-shadow: 0 14px 34px -28px rgba(15, 23, 42, 0.6);
        max-width: 100%;
    }

    /* Feedback Box */
    .feedback-box {
        border-radius: 0.9rem;
        padding: 1rem 1.15rem;
        font-weight: 500;
        display: flex;
        align-items: flex-start;
        gap: 0.85rem;
    }

    .feedback-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .feedback-text {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .feedback-correct {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(59, 130, 246, 0.08));
        color: #166534;
        border: 1px solid rgba(22, 163, 74, 0.35);
    }

    .feedback-correct .feedback-icon {
        background: rgba(34, 197, 94, 0.25);
        color: #15803d;
    }

    .feedback-incorrect {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(248, 113, 113, 0.12));
        color: #b45309;
        border: 1px solid rgba(251, 191, 36, 0.35);
    }

    .feedback-incorrect .feedback-icon {
        background: rgba(251, 191, 36, 0.3);
        color: #b45309;
    }

    .feedback-explanation {
        background: rgba(241, 245, 249, 0.85);
        border-radius: 0.75rem;
        padding: 0.85rem 1rem;
        margin-top: 0.75rem;
    }

    /* Buttons */
    .cm-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
    }

    .cm-btn-primary {
        background: #2563eb;
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .cm-btn-primary:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
    }

    .control-button {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.85rem 1.6rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: none;
        cursor: pointer;
    }

    .control-button:disabled {
        opacity: 0.65;
        cursor: not-allowed;
    }

    .control-button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 16px 36px -30px rgba(15, 23, 42, 0.65);
    }

    /* Toast */
    .quiz-toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 2000;
        pointer-events: none;
    }

    .quiz-toast {
        background: #1f2937;
        color: #ffffff;
        padding: 0.75rem 1.1rem;
        border-radius: 0.85rem;
        box-shadow: 0 18px 38px -25px rgba(15, 23, 42, 0.65);
        font-size: 0.92rem;
        font-weight: 500;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        pointer-events: auto;
        max-width: 320px;
    }

    .quiz-toast.visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* === HUB MODAL STYLES === */
    .qb-modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .qb-modal-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 101;
        background: white;
        height: 85vh;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
    }

    .qb-modal-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .qb-modal-overlay.open .qb-modal-container {
        transform: translateY(0);
    }

    .qb-hub-header {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .qb-hub-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
    }

    .qb-hub-tab-item {
        flex: 1;
        text-align: center;
        padding: 12px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .qb-hub-tab-item.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
        background: white;
    }

    .qb-hub-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: white;
    }

    .qb-hub-pane {
        display: none;
    }

    .qb-hub-pane.active {
        display: block;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (min-width: 1024px) {
        .qb-modal-overlay.open .qb-modal-container {
            transform: translate(0, -50%) scale(1) !important;
            top: 50% !important;
            bottom: auto !important;
            max-width: 600px;
            margin: 0 auto;
            height: 80vh;
            border-radius: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
{# Include Mobile and Desktop Partials #}
{% include "quiz/individual/_quiz_session_batch_mobile.html" %}
{% include "quiz/individual/_quiz_session_batch_desktop.html" %}

{# Hub Modal (Shared) #}
<div id="hub-modal" class="qb-modal-overlay">
    <div class="qb-modal-container">
        <div class="qb-hub-header">
            <h3 class="font-bold text-slate-800 text-lg">Chi ti·∫øt & H·ªçc t·∫≠p</h3>
            <button id="close-hub-btn"
                class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="qb-hub-tabs">
            <div class="qb-hub-tab-item active" data-target="hub-expl">üìñ Gi·∫£i th√≠ch</div>
            <div class="qb-hub-tab-item" data-target="hub-ai">ü§ñ AI Coach</div>
            <div class="qb-hub-tab-item" data-target="hub-note">üìù Ghi ch√∫</div>
        </div>
        <div class="qb-hub-content">
            <!-- Expl Tab -->
            <div id="hub-expl" class="qb-hub-pane active">
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-slate-700 leading-relaxed">
                    <h4 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-circle-info"></i> Gi·∫£i th√≠ch:</h4>
                    <div id="hub-explanation-text">Ch∆∞a c√≥ gi·∫£i th√≠ch.</div>
                </div>
            </div>
            <!-- AI Tab -->
            <div id="hub-ai" class="qb-hub-pane">
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-indigo-700 font-bold"><i class="fa-solid fa-robot"></i>
                            <span>AI Ph√¢n T√≠ch</span>
                        </div>
                        <button id="ai-generate-btn"
                            class="text-xs bg-white text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-200 font-semibold shadow-sm"><i
                                class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o m·ªõi</button>
                    </div>
                    <div id="hub-ai-content"
                        class="content-display markdown-body text-sm text-slate-700 leading-relaxed min-h-[100px]">Nh·∫•n
                        n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...</div>
                </div>
            </div>
            <!-- Note Tab -->
            <div id="hub-note" class="qb-hub-pane">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-slate-700">Ghi ch√∫ c·ªßa b·∫°n</h4>
                    <button id="hub-note-edit-btn"
                        class="hidden text-xs bg-blue-100 text-blue-600 border border-blue-200 px-3 py-1.5 rounded hover:bg-blue-200 font-medium"><i
                            class="fa-solid fa-pencil"></i> S·ª≠a</button>
                </div>
                <div id="hub-note-display-mode" class="hidden">
                    <div id="hub-note-content"
                        class="content-display min-h-[100px] bg-slate-50 p-3 rounded-lg text-slate-700 whitespace-pre-wrap">
                    </div>
                </div>
                <div id="hub-note-edit-mode" class="hidden">
                    <textarea id="hub-note-input"
                        class="w-full p-3 rounded-xl border border-slate-200 text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition"
                        rows="8" placeholder="Ghi ch√∫ c·ªßa b·∫°n..."></textarea>
                    <div class="flex justify-end mt-2 gap-2">
                        <button id="hub-note-cancel"
                            class="cm-btn bg-white hover:bg-slate-100 text-slate-600 border border-slate-300 py-1.5 px-4 text-sm rounded-md">H·ªßy</button>
                        <button id="hub-note-save"
                            class="cm-btn bg-blue-600 text-white hover:bg-blue-700 py-1.5 px-4 text-sm rounded-md">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // === DUAL RENDERING UPDATE HELPER ===
    const setText = (selector, text) => document.querySelectorAll(selector).forEach(el => el.textContent = text);
    const setHtml = (selector, html) => document.querySelectorAll(selector).forEach(el => el.innerHTML = html);
    const toggleClass = (selector, cls, force) => document.querySelectorAll(selector).forEach(el => el.classList.toggle(cls, force));
    const setStyle = (selector, prop, val) => document.querySelectorAll(selector).forEach(el => el.style[prop] = val);
    const setAttr = (selector, attr, val) => document.querySelectorAll(selector).forEach(el => el.setAttribute(attr, val));

    // --- Global State ---
    let currentQuestionBatch = [];
    let currentBatchMeta = { startIndex: 0, totalItemsInSession: 0 };
    let userAnswers = {};
    let isBatchSubmitted = false;
    let totalQuestionsInSession = 0;
    let sessionTotalAnswered = 0;
    let activeHubItemId = null; // Currently tracked question ID
    const SESSION_KEY = 'quiz_session_batch_state';

    // URLs
    const getQuestionBatchUrl = "{{ url_for('learning.quiz_learning.get_question_batch') }}";
    const submitAnswerBatchUrl = "{{ url_for('learning.quiz_learning.submit_answer_batch') }}";
    const endSessionUrl = "{{ url_for('learning.quiz_learning.end_session') }}";
    const getAiResponseUrl = "{{ url_for('ai_services.get_ai_response') }}";
    const saveNoteUrlTemplate = "{{ url_for('notes.save_note', item_id=0) }}";
    const quizDashboardUrl = "{{ url_for('learning.quiz_learning.quiz_learning_dashboard') }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    const csrfHeaders = csrfToken ? { 'X-CSRFToken': csrfToken } : {};

    // --- Init ---
    document.addEventListener('DOMContentLoaded', init);
    window.addEventListener('scroll', handleScroll);

    function init() {
        if (!loadState()) {
            getNextQuestionBatch();
        }
    }

    // --- State Management ---
    function saveState() {
        const state = {
            currentQuestionBatch,
            currentBatchMeta,
            userAnswers,
            isBatchSubmitted,
            totalQuestionsInSession,
            sessionTotalAnswered
        };
        try {
            sessionStorage.setItem(SESSION_KEY, JSON.stringify(state));
        } catch (e) { console.error('Error saving state', e); }
    }

    function loadState() {
        try {
            const raw = sessionStorage.getItem(SESSION_KEY);
            if (!raw) return false;
            const state = JSON.parse(raw);

            // Validate basic integrity
            if (!state.currentQuestionBatch || !Array.isArray(state.currentQuestionBatch) || state.currentQuestionBatch.length === 0) {
                return false;
            }

            // Restore
            currentQuestionBatch = state.currentQuestionBatch;
            currentBatchMeta = state.currentBatchMeta || {};
            userAnswers = state.userAnswers || {};
            isBatchSubmitted = state.isBatchSubmitted || false;
            totalQuestionsInSession = state.totalQuestionsInSession || 0;
            sessionTotalAnswered = state.sessionTotalAnswered || 0;

            restoreUI();
            return true;
        } catch (e) {
            console.error('Error loading state', e);
            clearState();
            return false;
        }
    }

    function clearState() {
        sessionStorage.removeItem(SESSION_KEY);
    }

    function restoreUI() {
        // Construct a batchData-like object to reuse display logic
        // We only need basic fields for displayQuestionBatch to run
        const batchData = {
            items: currentQuestionBatch,
            start_index: currentBatchMeta.startIndex,
            total_items_in_session: currentBatchMeta.totalItemsInSession,
            // These might be stale but displayQuestionBatch recalculates or we override below
            session_correct_answers: 0, // Placeholder, will update later
            session_total_answered: sessionTotalAnswered
        };

        displayQuestionBatch(batchData, true); // true = restoring

        // Restore Selections
        Object.entries(userAnswers).forEach(([itemId, answer]) => {
            const qId = parseInt(itemId);
            document.querySelectorAll(`.option-button[data-question-id="${qId}"]`).forEach(b => b.classList.remove('selected'));
            document.querySelectorAll(`.option-button[data-question-id="${qId}"][data-option="${answer}"]`).forEach(b => b.classList.add('selected'));
        });

        // Restore Feedback if submitted
        if (isBatchSubmitted) {
            toggleControlButtons('submitted');
            currentQuestionBatch.forEach(q => {
                renderFeedbackForQuestion(q); // Helper to render feedback
            });
        }
    }

    function renderFeedbackForQuestion(result) {
        const questionCards = document.querySelectorAll(`.question-card[data-item-id="${result.item_id}"]`);
        questionCards.forEach(card => {
            const feedbackArea = card.querySelector('.feedback-area');
            let feedbackHtml = result.is_correct ?
                `<div class="feedback-box feedback-correct"><span class="feedback-icon"><i class="fas fa-check-circle"></i></span><div class="feedback-text"><strong>Ch√≠nh x√°c!</strong></div></div>` :
                `<div class="feedback-box feedback-incorrect"><span class="feedback-icon"><i class="fas fa-times-circle"></i></span><div class="feedback-text"><strong>Sai r·ªìi</strong><span>ƒê√°p √°n ƒë√∫ng: ${result.correct_answer}</span></div></div>`;
            if (result.explanation) {
                feedbackHtml += `<div class="feedback-explanation hidden lg:block"><strong>Gi·∫£i th√≠ch:</strong><div class="mt-1 text-sm text-slate-700">${formatTextForHtml(result.explanation)}</div></div>`;
            }
            feedbackArea.innerHTML = feedbackHtml;
            card.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
                const opt = btn.dataset.option;
                if (opt === result.correct_answer) btn.classList.add('correct');
                else if (opt === userAnswers[result.item_id] && !result.is_correct) btn.classList.add('incorrect');
                btn.style.pointerEvents = 'none';
            });
        });
    }

    // --- Functions ---
    const numberFormatter = new Intl.NumberFormat('vi-VN');
    const percentageFormatter = new Intl.NumberFormat('vi-VN', { maximumFractionDigits: 1, minimumFractionDigits: 0 });

    function updateProgressCard() {
        const totalInSession = Number(totalQuestionsInSession) || 0;
        const answered = Number(sessionTotalAnswered) || 0;
        const hasTotal = totalInSession > 0;

        if (hasTotal) {
            const cappedAnswered = Math.min(answered, totalInSession);
            setText('.js-quiz-total-label', `${numberFormatter.format(cappedAnswered)} / ${numberFormatter.format(totalInSession)}`);
        } else {
            setText('.js-quiz-total-label', numberFormatter.format(answered));
        }

        if (hasTotal) {
            const remaining = Math.max(totalInSession - answered, 0);
            setText('.js-quiz-remaining-label', numberFormatter.format(remaining));
        } else {
            setText('.js-quiz-remaining-label', '--');
        }

        const progressWidth = hasTotal ? Math.min((answered / totalInSession) * 100, 100) : 0;
        setStyle('.js-quiz-progress-fill', 'width', `${progressWidth}%`);
    }

    function updateSessionSummary(correct = 0, total = 0) {
        const safeTotal = Number(total) || 0;
        const safeCorrect = Number(correct) || 0;
        sessionTotalAnswered = safeTotal;
        setText('.js-session-total-count', numberFormatter.format(safeTotal));
        setText('.js-session-correct-count', numberFormatter.format(safeCorrect));
        const accuracy = safeTotal > 0 ? (safeCorrect / safeTotal) * 100 : 0;
        setText('.js-session-accuracy', `${percentageFormatter.format(accuracy)}%`);
        updateProgressCard();
    }

    async function getNextQuestionBatch() {
        setHtml('.js-quiz-content', `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>ƒêang t·∫£i c√¢u h·ªèi...</p></div>`);
        toggleControlButtons('loading');

        try {
            const response = await fetch(getQuestionBatchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) {
                if (response.status === 404) {
                    handleSessionComplete(await response.json());
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const batchData = await response.json();

            // Reset state for new batch
            userAnswers = {};
            isBatchSubmitted = false;

            displayQuestionBatch(batchData);
            saveState();
        }
        catch (error) {
            console.error('L·ªói khi t·∫£i nh√≥m c√¢u h·ªèi:', error);
            setHtml('.js-quiz-content', `<p class="text-red-500 text-center p-4">Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi. Vui l√≤ng th·ª≠ l·∫°i.</p>`);
            toggleControlButtons('error');
        }
    }

    function displayQuestionBatch(batchData, isRestoring = false) {
        if (!isRestoring) {
            currentQuestionBatch = batchData.items;
            currentBatchMeta = {
                startIndex: batchData.start_index || 0,
                totalItemsInSession: batchData.total_items_in_session || batchData.items.length
            };
            const totalGroupsFallback = batchData.total_question_groups_in_session || currentBatchMeta.totalItemsInSession;
            totalQuestionsInSession = Number(totalGroupsFallback) || currentQuestionBatch.length;
        }

        updateSessionSummary(batchData.session_correct_answers, batchData.session_total_answered);

        // Render HTML
        const fullBatchContentHtml = currentQuestionBatch
            .map((questionData, index) => buildQuestionCardHtml(questionData, index))
            .join('');

        setHtml('.js-quiz-content', fullBatchContentHtml);

        const startRange = batchData.question_number_min || (currentBatchMeta.startIndex + 1);
        const endRange = batchData.question_number_max || (currentBatchMeta.startIndex + currentQuestionBatch.length);
        const totalInSession = totalQuestionsInSession;
        setText('.js-quiz-group-range', totalInSession ? `C√¢u ${startRange}-${endRange}` : '---');

        updateProgressCard();
        attachOptionHandlers();
        if (!isRestoring) toggleControlButtons('answering');

        // Allow DOM to settle then trigger scroll check
        setTimeout(handleScroll, 500);
    }

    function buildQuestionCardHtml(questionData, index) {
        const questionNumber = questionData.display_number || ((currentBatchMeta.startIndex || 0) + index + 1);
        const content = questionData.content || {};

        // Build Options
        let optionsHtml = '';
        const options = content.options || {};
        ['A', 'B', 'C', 'D'].forEach(key => {
            if (options[key]) {
                optionsHtml += `
                        <button class="option-button" data-question-id="${questionData.item_id}" data-option="${key}">
                            <span>${key}</span> <span>${formatTextForHtml(options[key])}</span>
                        </button>`;
            }
        });

        // Build Media
        let mediaHtml = '';
        if (content.question_image_file) {
            mediaHtml += `<img src="${content.question_image_file}" alt="H√¨nh ·∫£nh" class="quiz-image mb-4">`;
        }
        if (content.question_audio_file) {
            mediaHtml += `<audio controls src="${content.question_audio_file}" class="w-full mb-4"></audio>`;
        }

        return `
                <div class="question-card" data-item-id="${questionData.item_id}">
                    <div class="flex justify-between items-center text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">
                        <span>C√¢u ${questionNumber}</span>
                        <button class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition js-open-hub-btn" data-item-id="${questionData.item_id}" title="Chi ti·∫øt & H·ªçc t·∫≠p">
                            <i class="fa-solid fa-lightbulb text-lg"></i>
                        </button>
                    </div>
                    <h2 class="text-xl font-bold text-slate-900 mb-4">${formatTextForHtml(content.question)}</h2>
                    ${mediaHtml}
                    <div class="options-container">${optionsHtml}</div>
                    <div class="feedback-area mt-4"></div>
                </div>
            `;
    }

    function attachOptionHandlers() {
        document.querySelectorAll('.option-button').forEach(button => {
            button.removeEventListener('click', handleOptionClick);
            button.addEventListener('click', handleOptionClick);
        });
        // Desktop/Inline Hub Buttons
        document.querySelectorAll('.js-open-hub-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const itemId = e.currentTarget.dataset.itemId;
                openHub(itemId);
            });
        });
        // Mobile Bottom Hub Button
        document.querySelectorAll('.js-mobile-hub-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (activeHubItemId) openHub(activeHubItemId);
                else showCustomAlert("H√£y cu·ªôn t·ªõi m·ªôt c√¢u h·ªèi.", "info");
            });
        });
    }

    function handleOptionClick(e) {
        if (isBatchSubmitted) return;
        const btn = e.currentTarget;
        const questionId = btn.dataset.questionId;
        const selectedOption = btn.dataset.option;
        userAnswers[questionId] = selectedOption;
        document.querySelectorAll(`.option-button[data-question-id="${questionId}"]`).forEach(b => b.classList.remove('selected'));
        document.querySelectorAll(`.option-button[data-question-id="${questionId}"][data-option="${selectedOption}"]`).forEach(b => b.classList.add('selected'));
        saveState();
        checkCompletionStatus();
    }

    function checkCompletionStatus() {
        if (isBatchSubmitted) return;
        const allAnswered = currentQuestionBatch.every(q => userAnswers.hasOwnProperty(q.item_id));
        const submits = document.querySelectorAll('.js-submit-batch-btn');
        if (allAnswered) {
            submits.forEach(btn => {
                btn.style.opacity = '1';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                // Optional: visual pulse or highlight
            });
        } else {
            submits.forEach(btn => {
                btn.style.opacity = '0.5';
                btn.classList.add('opacity-50');
            });
        }
    }

    async function submitAnswerBatch() {
        if (isBatchSubmitted) return;
        const allAnswered = currentQuestionBatch.every(q => userAnswers.hasOwnProperty(q.item_id));
        if (!allAnswered) {
            showCustomAlert("Vui l√≤ng tr·∫£ l·ªùi t·∫•t c·∫£ c√°c c√¢u h·ªèi.");
            return;
        }

        isBatchSubmitted = true;
        toggleControlButtons('submitting');
        const answersToSend = Object.keys(userAnswers).map(itemId => ({ item_id: parseInt(itemId), user_answer: userAnswers[itemId] }));

        try {
            const response = await fetch(submitAnswerBatchUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...csrfHeaders },
                body: JSON.stringify({ answers: answersToSend })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const responseData = await response.json();

            // Process Results
            responseData.results.forEach(result => {
                // Update Local data
                const qIndex = currentQuestionBatch.findIndex(q => q.item_id === result.item_id);
                if (qIndex !== -1) {
                    currentQuestionBatch[qIndex].explanation = result.explanation;
                    currentQuestionBatch[qIndex].correct_answer = result.correct_answer;
                    currentQuestionBatch[qIndex].is_correct = result.is_correct;
                }
                renderFeedbackForQuestion(result);
            });
            updateSessionSummary(responseData.session_correct_answers, responseData.session_total_answered);
            toggleControlButtons('submitted');
            saveState();

        } catch (error) {
            console.error(error);
            showCustomAlert('C√≥ l·ªói x·∫£y ra khi g·ª≠i ƒë√°p √°n.');
            isBatchSubmitted = false;
            toggleControlButtons('answering');
        }
    }

    // === SCROLL TRACKING LOGIC ===
    function handleScroll() {
        // Check visible cards
        // Only effective on mobile view generally, but works for desktop too if needed.
        // Logic: Find the card that takes up the most screen space or is closest to center.
        let maxVisibility = 0;
        let bestCardId = null;

        // Only target visible question cards (in case of desktop/mobile hidden logic, though usually matched classes handle it)
        // But due to dual rendering, we have duplicated cards. We need to check only the currently visible ones.
        // On mobile, .lg:hidden block is visible. On desktop .hidden.lg:block is visible.
        // Since IntersectionObserver/getBoundingClientRect works on actual layout:

        const cards = document.querySelectorAll('.question-card');

        cards.forEach(card => {
            const rect = card.getBoundingClientRect();
            const viewHeight = window.innerHeight;

            // Calculate intersection height
            const intersectTop = Math.max(0, rect.top);
            const intersectBottom = Math.min(viewHeight, rect.bottom);
            const intersectHeight = Math.max(0, intersectBottom - intersectTop);

            if (intersectHeight > maxVisibility) {
                maxVisibility = intersectHeight;
                bestCardId = card.dataset.itemId;
            }
        });

        if (bestCardId && bestCardId !== activeHubItemId) {
            activeHubItemId = bestCardId;
            // Highlight active card? Not necessary requested but good for debug
            // Enable/Update the sticky button context
        }
    }


    // === HUB LOGIC ===
    const dom = {
        hubModal: document.getElementById('hub-modal'),
        closeHubBtn: document.getElementById('close-hub-btn'),
        hubExplText: document.getElementById('hub-explanation-text'),
        hubAiContent: document.getElementById('hub-ai-content'),
        aiGenerateBtn: document.getElementById('ai-generate-btn'),
        hubNoteInput: document.getElementById('hub-note-input'),
        hubNoteSave: document.getElementById('hub-note-save'),
        hubNoteEditBtn: document.getElementById('hub-note-edit-btn'),
        hubNoteCancelBtn: document.getElementById('hub-note-cancel'),
        hubNoteDisplay: document.getElementById('hub-note-display-mode'),
        hubNoteEdit: document.getElementById('hub-note-edit-mode'),
        hubNoteContent: document.getElementById('hub-note-content')
    };

    function openHub(itemId) {
        const questionData = currentQuestionBatch.find(q => q.item_id == itemId);
        if (!questionData) return;
        activeHubItemId = itemId;

        // Populate Hub
        if (questionData.explanation) {
            dom.hubExplText.innerHTML = formatTextForHtml(questionData.explanation);
        } else if (isBatchSubmitted) {
            dom.hubExplText.innerHTML = "Ch∆∞a c√≥ gi·∫£i th√≠ch cho c√¢u h·ªèi n√†y.";
        } else {
            dom.hubExplText.innerHTML = "H√£y ho√†n th√†nh c√¢u h·ªèi ƒë·ªÉ xem gi·∫£i th√≠ch.";
        }

        if (questionData.ai_explanation) {
            dom.hubAiContent.innerHTML = questionData.ai_explanation;
        } else {
            dom.hubAiContent.innerHTML = "Nh·∫•n n√∫t ƒë·ªÉ y√™u c·∫ßu AI ph√¢n t√≠ch...";
        }

        updateNoteUI(questionData.note_content || "");

        dom.hubModal.classList.add('open');
    }

    function updateNoteUI(content) {
        if (content && content.trim()) {
            dom.hubNoteDisplay.classList.remove('hidden');
            dom.hubNoteEdit.classList.add('hidden');
            dom.hubNoteEditBtn.classList.remove('hidden');
            dom.hubNoteContent.textContent = content;
            dom.hubNoteInput.value = content;
        } else {
            dom.hubNoteDisplay.classList.add('hidden');
            dom.hubNoteEdit.classList.remove('hidden');
            dom.hubNoteEditBtn.classList.add('hidden');
            dom.hubNoteInput.value = '';
        }
    }

    // Hub Listeners
    dom.closeHubBtn.addEventListener('click', () => dom.hubModal.classList.remove('open'));

    // Close Hub when clicking outside content (on the overlay)
    dom.hubModal.addEventListener('click', (e) => {
        if (e.target === dom.hubModal) {
            dom.hubModal.classList.remove('open');
        }
    });

    document.querySelectorAll('.qb-hub-tab-item').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.qb-hub-tab-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.qb-hub-pane').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.target)?.classList.add('active');
        });
    });

    // AI Handler
    dom.aiGenerateBtn.addEventListener('click', async () => {
        // Using activeHubItemId global from scroll tracking or click
        if (!activeHubItemId) return;
        const btn = dom.aiGenerateBtn;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        dom.hubAiContent.innerHTML = "ƒêang ph√¢n t√≠ch...";

        try {
            const res = await fetch(getAiResponseUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...csrfHeaders },
                body: JSON.stringify({ item_id: activeHubItemId, prompt_type: 'explanation' })
            });
            const data = await res.json();
            const content = data.html_content || data.response;

            dom.hubAiContent.innerHTML = content;
            const q = currentQuestionBatch.find(q => q.item_id == activeHubItemId);
            if (q) q.ai_explanation = content;
            saveState();

        } catch (e) {
            dom.hubAiContent.innerHTML = '<span class="text-red-500">L·ªói k·∫øt n·ªëi AI.</span>';
        }
        btn.innerHTML = originalText;
        btn.disabled = false;
    });

    // Note Handlers
    dom.hubNoteSave.addEventListener('click', async () => {
        if (!activeHubItemId) return;
        const content = dom.hubNoteInput.value;
        const btn = dom.hubNoteSave;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            await fetch(saveNoteUrlTemplate.replace('0', activeHubItemId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...csrfHeaders },
                body: JSON.stringify({ content })
            });

            const q = currentQuestionBatch.find(q => q.item_id == activeHubItemId);
            if (q) q.note_content = content;

            updateNoteUI(content);
            saveState();
            showCustomAlert("ƒê√£ l∆∞u ghi ch√∫", "success");
        } catch (e) {
            showCustomAlert("L·ªói l∆∞u ghi ch√∫", "error");
        }
        btn.disabled = false;
        btn.innerHTML = "L∆∞u";
    });

    dom.hubNoteEditBtn.addEventListener('click', () => {
        dom.hubNoteDisplay.classList.add('hidden');
        dom.hubNoteEdit.classList.remove('hidden');
        dom.hubNoteEditBtn.classList.add('hidden');
    });

    dom.hubNoteCancelBtn.addEventListener('click', () => {
        const q = currentQuestionBatch.find(q => q.item_id == activeHubItemId);
        updateNoteUI(q ? (q.note_content || "") : "");
    });

    // === END HUB ===

    function toggleControlButtons(state) {
        const submits = document.querySelectorAll('.js-submit-batch-btn');
        const nexts = document.querySelectorAll('.js-next-batch-btn');
        submits.forEach(btn => btn.style.display = 'none');
        nexts.forEach(btn => btn.style.display = 'none');

        if (state === 'answering') {
            submits.forEach(btn => {
                btn.style.display = 'inline-flex';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="control-button-text">G·ª≠i ƒë√°p √°n</span>';
            });
            checkCompletionStatus();
        } else if (state === 'submitting') {
            submits.forEach(btn => {
                btn.style.display = 'inline-flex';
                btn.disabled = true;
                btn.style.opacity = '1';
                btn.classList.remove('opacity-50');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang g·ª≠i...';
            });
        } else if (state === 'submitted') {
            nexts.forEach(btn => btn.style.display = 'inline-flex');
        }
    }

    function handleSessionComplete(endMessage) {
        setText('.js-quiz-group-range', 'Ho√†n th√†nh');
        const msgHtml = `<div class="text-center py-12 px-6"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h3 class="text-xl font-bold text-slate-800 mb-2">Ho√†n th√†nh phi√™n h·ªçc!</h3><p class="text-slate-500 mb-6">${formatTextForHtml(endMessage.message)}</p><a href="${quizDashboardUrl}" class="cm-btn cm-btn-primary"><i class="fas fa-home"></i> V·ªÅ Dashboard</a></div>`;
        setHtml('.js-quiz-content', msgHtml);
        toggleControlButtons('complete');
        document.querySelectorAll('.js-end-session-btn').forEach(btn => btn.style.display = 'none');
    }

    async function handleEndSession() {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k·∫øt th√∫c phi√™n h·ªçc hi·ªán t·∫°i?')) {
            try {
                await fetch(endSessionUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', ...csrfHeaders }, body: JSON.stringify({}) });
                clearState();
                window.location.href = quizDashboardUrl;
            } catch (e) {
                showCustomAlert('L·ªói k·∫øt th√∫c phi√™n.', 'error');
            }
        }
    }

    document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        if (btn.classList.contains('js-submit-batch-btn')) submitAnswerBatch();
        if (btn.classList.contains('js-next-batch-btn')) getNextQuestionBatch();
        if (btn.classList.contains('js-end-session-btn')) handleEndSession();
    });

    function formatTextForHtml(text) { return text ? String(text).replace(/\n/g, '<br>') : ''; }
    function showCustomAlert(msg, type = 'warning') {
        const container = document.querySelector('.quiz-toast-container') || (() => {
            const c = document.createElement('div'); c.className = 'quiz-toast-container'; document.body.appendChild(c); return c;
        })();
        const toast = document.createElement('div');
        toast.className = `quiz-toast`;
        toast.textContent = msg;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('visible'));
        setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
</script>
{% endblock %}