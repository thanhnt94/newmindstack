{# =============================== #}
{# File: mindstack_app/modules/learning/quiz/templates/quiz_battle/room.html #}
{# Phi√™n b·∫£n: 3.2 (Fix Start Error Handling & Leave Redirect) #}
{# =============================== #}

{% extends "base.html" %}

{% block title %}Quiz Battle ¬∑ {{ room_title }}{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* === CMS Style Components === */
    body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }

    .cm-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .cm-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f5f9;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .cm-card-title {
        font-size: 1rem;
        font-weight: 600;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .cm-card-body { padding: 1.25rem; flex: 1; }

    /* Question Styles */
    .qb-question-text { font-size: 1.25rem; font-weight: 700; color: #1e293b; line-height: 1.5; margin-bottom: 1rem; }
    .qb-question-detail { font-size: 0.95rem; color: #64748b; margin-bottom: 1.5rem; line-height: 1.6; }
    .qb-question-media { margin-bottom: 1.5rem; display: grid; gap: 0.75rem; }
    .qb-question-media img { width: 100%; max-height: 320px; object-fit: contain; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: white; }
    .qb-question-media audio { width: 100%; }

    /* Options Grid */
    .qb-options-grid { display: grid; gap: 0.75rem; }
    .qb-option-label {
        display: flex; align-items: center; gap: 1rem;
        padding: 1rem; border: 2px solid #e2e8f0; border-radius: 0.75rem;
        cursor: pointer; transition: all 0.15s ease; background: white;
    }
    .qb-option-label:hover { border-color: #94a3b8; background: #f8fafc; }
    .qb-option-label:has(input:checked) { border-color: #3b82f6; background: #eff6ff; ring: 1px solid #3b82f6; }
    .qb-option-input { width: 1.25rem; height: 1.25rem; accent-color: #2563eb; }
    
    /* Chat Box Fix */
    .qb-chat-panel { position: relative; }
    .qb-chat-container { height: 450px; display: flex; flex-direction: column; }
    .qb-chat-messages { flex: 1; overflow-y: auto; padding: 1rem; background: #f8fafc; scroll-behavior: smooth; }
    .qb-chat-input-area { padding: 0.75rem; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 0.5rem; }
    .qb-chat-bubble { margin-bottom: 0.75rem; display: flex; flex-direction: column; align-items: flex-start; }
    .qb-chat-bubble.me { align-items: flex-end; }
    .qb-msg-meta { font-size: 0.7rem; color: #94a3b8; margin-bottom: 0.1rem; }
    .qb-msg-content { padding: 0.5rem 0.8rem; border-radius: 0.75rem; font-size: 0.9rem; max-width: 85%; word-break: break-word; }
    .qb-chat-bubble.me .qb-msg-content { background: #3b82f6; color: white; border-bottom-right-radius: 0.1rem; }
    .qb-chat-bubble.other .qb-msg-content { background: #e2e8f0; color: #1e293b; border-bottom-left-radius: 0.1rem; }

    .qb-mobile-chat-toggle {
        display: none;
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 70;
        box-shadow: 0 14px 30px rgba(59, 130, 246, 0.3);
        background: linear-gradient(135deg, #4f46e5, #0ea5e9);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.35);
        border-radius: 999px;
        padding: 0.65rem;
        gap: 0.4rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        min-width: 0;
        width: 3.25rem;
        height: 3.25rem;
        align-items: center;
        justify-content: center;
        line-height: 1;
        pointer-events: auto;
        touch-action: manipulation;
        overflow: visible;
    }

    .qb-mobile-chat-toggle i { font-size: 1.05rem; }
    .qb-mobile-chat-label { display: none; }

    .qb-chat-unread {
        position: absolute;
        top: -0.1rem;
        right: -0.1rem;
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 999px;
        background: #ef4444;
        color: white;
        font-size: 0.65rem;
        font-weight: 800;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 18px rgba(239, 68, 68, 0.35);
        border: 2px solid white;
        line-height: 1;
    }

    .qb-chat-unread.is-visible { display: inline-flex; }

    @media (min-width: 520px) and (max-width: 1024px) {
        .qb-mobile-chat-toggle {
            width: auto;
            height: auto;
            padding: 0.65rem 0.95rem;
            border-radius: 999px;
            gap: 0.5rem;
        }

        .qb-mobile-chat-label { display: inline; }
    }

    .qb-mobile-chat-toggle:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 18px 38px rgba(37, 99, 235, 0.32);
        filter: brightness(1.03);
    }

    .qb-mobile-chat-toggle:active { transform: translateY(0); filter: brightness(0.98); }
    .qb-mobile-chat-toggle.is-active { box-shadow: 0 16px 32px rgba(37, 99, 235, 0.35); }

    .qb-close-chat-btn { display: none; }

    /* Status Badge */
    .status-badge { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: 0.35rem 0.75rem; border-radius: 999px; letter-spacing: 0.05em; }
    .status-badge[data-status="lobby"] { background: #e0f2fe; color: #0369a1; }
    .status-badge[data-status="in_progress"] { background: #dcfce7; color: #15803d; }
    .status-badge[data-status="completed"] { background: #f1f5f9; color: #64748b; }

    /* Buttons */
    .cm-btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; }
    .cm-btn-primary { background: #2563eb; color: white; border: 1px solid transparent; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }
    .cm-btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    .cm-btn-primary:disabled { background: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }
    .cm-btn-danger { background: white; color: #ef4444; border: 1px solid #fecaca; }
    .cm-btn-danger:hover { background: #fef2f2; border-color: #fca5a5; }
    .cm-btn-ghost { background: white; color: #475569; border: 1px solid #cbd5e1; }
    .cm-btn-ghost:hover { background: #f8fafc; color: #1e293b; border-color: #94a3b8; }

    .qb-next-mobile-floating {
        box-shadow: 0 14px 30px rgba(37, 99, 235, 0.28);
        justify-content: center;
    }

    /* Responsive Grid */
    .qb-layout-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 1024px) { .qb-layout-grid { grid-template-columns: 2fr 1fr; } }

    @media (max-width: 1024px) {
        .qb-chat-panel { display: flex; position: fixed; inset: 0; z-index: 9990; background: rgba(15, 23, 42, 0.45); backdrop-filter: blur(8px); align-items: flex-end; justify-content: center; padding: 0.75rem; opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.3s ease; }
        .qb-chat-panel .qb-chat-container { width: 100%; max-width: 720px; height: 90vh !important; background: #ffffff; border-radius: 18px 18px 0 0; padding-bottom: 1.5rem; transform: translateY(12%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .qb-chat-panel.open { opacity: 1; visibility: visible; pointer-events: auto; }
        .qb-chat-panel.open .qb-chat-container { transform: translateY(0); }
        .qb-close-chat-btn { display: inline-flex; }
        .qb-mobile-chat-toggle { display: flex; }

        #next-round-btn.qb-next-mobile-floating {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 1rem;
            width: min(calc(100% - 8rem), 280px);
            max-width: 280px;
            z-index: 70;
            font-size: 0.95rem;
            padding: 0.55rem 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-2 py-6 max-w-7xl">
    
    {# === HEADER SECTION === #}
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
        <div>
            <div class="flex items-center gap-3 mb-1">
                <span class="text-xs font-bold text-blue-500 uppercase tracking-widest">Quiz Battle</span>
                <span id="room-status" class="status-badge" data-status="{{ initial_room.status }}">{{ initial_room.status }}</span>
            </div>
            <h1 class="text-2xl font-bold text-slate-900" id="room-title">{{ room_title }}</h1>
            <div class="flex items-center gap-2 mt-1 text-sm text-slate-600">
                <span class="font-medium">M√£ ph√≤ng:</span>
                <code class="bg-slate-100 px-2 py-0.5 rounded border border-slate-200 font-mono font-bold text-slate-800 text-base select-all" id="room-code">{{ room_code }}</code>
                <button id="copy-room-code" class="text-blue-500 hover:text-blue-700" title="Sao ch√©p"><i class="fa-solid fa-copy"></i></button>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
            <button id="start-room-btn" class="cm-btn cm-btn-primary" title="B·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u (Ch·ªâ ch·ªß ph√≤ng)"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu</button>
            <button id="next-round-btn" class="cm-btn cm-btn-primary hidden" title="Chuy·ªÉn sang c√¢u ti·∫øp theo"><i class="fa-solid fa-forward-step"></i> C√¢u ti·∫øp</button>
            <button id="end-room-btn" class="cm-btn cm-btn-danger" title="K·∫øt th√∫c tr·∫≠n ƒë·∫•u (Ch·ªâ ch·ªß ph√≤ng)"><i class="fa-solid fa-flag-checkered"></i> K·∫øt th√∫c</button>
            <button id="leave-room-btn" class="cm-btn cm-btn-ghost"><i class="fa-solid fa-right-from-bracket"></i> R·ªùi ph√≤ng</button>
        </div>
    </header>

    {# === ALERT BOX === #}
    <div id="room-alert" class="mb-6 hidden p-4 rounded-lg border flex items-start gap-3"></div>

    {# === MAIN GRID === #}
    <div class="qb-layout-grid">
        
        {# --- C·ªòT TR√ÅI: C√ÇU H·ªéI & GAMEPLAY --- #}
        <div class="space-y-6">
            
            {# 1. Question Card #}
            <div class="cm-card">
                <div class="cm-card-header">
                    <span class="cm-card-title"><i class="fa-solid fa-circle-question text-blue-500"></i> C√¢u h·ªèi</span>
                    <span id="question-timer" class="text-orange-600 font-bold font-mono text-lg"></span>
                </div>
                <div class="cm-card-body relative">
                    <div id="game-status-overlay" class="hidden absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center text-center p-6">
                        <div class="text-slate-400 mb-2 text-4xl"><i class="fa-solid fa-hourglass-half fa-spin"></i></div>
                        <h3 class="text-xl font-bold text-slate-700" id="game-overlay-title">ƒêang ch·ªù...</h3>
                        <p class="text-slate-500" id="game-overlay-msg">ƒê·ª£i ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u.</p>
                    </div>

                    <h2 id="question-title" class="qb-question-text">ƒêang t·∫£i d·ªØ li·ªáu...</h2>
                    <div id="question-detail" class="qb-question-detail"></div>
                    <div id="question-media" class="qb-question-media" hidden></div>

                    <form id="answer-form">
                        <div id="question-options" class="qb-options-grid">
                            </div>
                        <div class="mt-6 flex items-center justify-between">
                            <p id="answer-inline-feedback" class="text-sm font-medium text-slate-600"></p>
                            <button type="submit" id="submit-answer-btn" class="cm-btn cm-btn-primary w-full sm:w-auto" disabled>
                                <i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n
                            </button>
                        </div>
                    </form>
                </div>
                <div class="bg-slate-50 px-5 py-3 border-t border-slate-100 flex flex-wrap gap-3 justify-between items-center text-xs text-slate-500">
                    <span id="round-progress">Ti·∫øn ƒë·ªô: --/--</span>
                    <span id="player-answered">ƒê√£ tr·∫£ l·ªùi: -- c√¢u</span>
                    <span id="player-score">T·ªïng ƒëi·ªÉm: --</span>
                    <span id="room-mode">Ch·∫ø ƒë·ªô: --</span>
                </div>
            </div>

            {# 2. Feedback & Insight Panel (·∫®n m·∫∑c ƒë·ªãnh) #}
            <div id="answer-feedback-panel" class="cm-card border-l-4 border-l-blue-500" hidden>
                <div class="cm-card-body">
                    <div class="flex items-start gap-4">
                        <div id="answer-feedback-icon" class="text-3xl">üí°</div>
                        <div class="flex-1">
                            <h3 id="answer-feedback-title" class="text-lg font-bold text-slate-900">K·∫øt qu·∫£</h3>
                            <p id="answer-feedback-detail" class="text-sm text-slate-600 mb-3"></p>
                            
                            <div class="flex gap-4 mb-4 text-sm">
                                <div class="bg-slate-50 px-3 py-2 rounded border border-slate-100">
                                    <span class="block text-xs text-slate-400 uppercase">ƒê√°p √°n ƒë√∫ng</span>
                                    <span id="answer-feedback-correct" class="font-bold text-emerald-600">--</span>
                                </div>
                                <div class="bg-slate-50 px-3 py-2 rounded border border-slate-100">
                                    <span class="block text-xs text-slate-400 uppercase">ƒêi·ªÉm c·ªông</span>
                                    <span id="answer-feedback-score" class="font-bold text-blue-600">+0</span>
                                </div>
                            </div>

                            <div class="p-3 bg-blue-50 rounded-lg text-sm text-slate-700 border border-blue-100">
                                <strong>Gi·∫£i th√≠ch:</strong>
                                <div id="answer-feedback-explanation" class="mt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# 3. Insight Tabs (AI, Notes) #}
            <div id="question-insight-panel" class="space-y-4" hidden>
                <div class="cm-card">
                    <div class="cm-card-header bg-gradient-to-r from-indigo-50 to-white flex items-center justify-between gap-3">
                        <span class="cm-card-title text-indigo-700"><i class="fa-solid fa-robot"></i> AI Coach</span>
                        <button id="ai-coach-generate-btn" class="text-xs text-blue-600 font-semibold px-3 py-1 rounded-lg border border-blue-100 bg-white hover:bg-blue-50 hidden">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o h∆∞·ªõng d·∫´n AI
                        </button>
                    </div>
                    <div class="cm-card-body text-sm text-slate-600 leading-relaxed" id="question-ai-content">
                        ƒêang ph√¢n t√≠ch...
                    </div>
                </div>

                <div class="cm-card">
                    <div class="cm-card-header">
                        <span class="cm-card-title"><i class="fa-solid fa-note-sticky text-yellow-500"></i> Ghi ch√∫ c√° nh√¢n</span>
                        <button id="question-note-edit" class="text-xs text-blue-600 hover:underline font-medium">S·ª≠a ghi ch√∫</button>
                    </div>
                    <div class="cm-card-body">
                        <div id="question-note-content" class="text-sm text-slate-600 italic">B·∫°n ch∆∞a c√≥ ghi ch√∫ cho c√¢u n√†y.</div>
                        
                        <div id="question-note-editor" class="hidden mt-2 space-y-2">
                            <textarea id="question-note-input" class="w-full rounded-lg border-slate-300 text-sm p-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Nh·∫≠p ghi ch√∫ c·ªßa b·∫°n..."></textarea>
                            <div class="flex justify-end gap-2">
                                <button id="question-note-cancel" class="px-3 py-1.5 rounded text-xs font-medium text-slate-500 hover:bg-slate-100">H·ªßy</button>
                                <button id="question-note-save" class="px-3 py-1.5 rounded text-xs font-medium bg-blue-600 text-white hover:bg-blue-700">L∆∞u</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="question-feedback-card" class="cm-card">
                    <div class="cm-card-body">
                        <p class="text-xs font-bold uppercase text-slate-400 mb-2">G√≥p √Ω c√¢u h·ªèi</p>
                        <div class="flex gap-2">
                            <input type="text" id="question-feedback-input" class="flex-1 rounded-lg border-slate-200 text-sm p-2" placeholder="B√°o c√°o l·ªói ho·∫∑c g√≥p √Ω...">
                            <button id="question-feedback-submit" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm hover:bg-slate-200"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        {# --- C·ªòT PH·∫¢I: TH·ªêNG K√ä & CHAT --- #}
        <div class="space-y-6">
            
            {# 1. Question Stats #}
            <div class="cm-card">
                <div class="cm-card-header">
                    <span class="cm-card-title"><i class="fa-solid fa-chart-pie text-emerald-500"></i> Th·ªëng k√™</span>
                    <span id="question-stats-round" class="text-xs font-mono bg-slate-100 px-2 py-1 rounded">#--</span>
                </div>
                <div class="cm-card-body">
                    <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                        <div class="p-2 rounded bg-slate-50 border border-slate-100">
                            <div class="text-xs text-slate-400 uppercase">ƒê√£ tr·∫£ l·ªùi</div>
                            <div id="question-stats-total" class="text-xl font-bold text-slate-700">0</div>
                        </div>
                        <div class="p-2 rounded bg-emerald-50 border border-emerald-100">
                            <div class="text-xs text-emerald-600 uppercase">Ch√≠nh x√°c</div>
                            <div id="question-stats-accuracy" class="text-xl font-bold text-emerald-700">--%</div>
                        </div>
                    </div>
                    <p id="question-stats-empty" class="text-xs text-center text-slate-400 italic">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>
                    <div id="option-distribution" class="space-y-2 text-xs">
                        </div>
                </div>
            </div>

            {# 2. Participants #}
            <div class="cm-card max-h-[300px] flex flex-col">
                <div class="cm-card-header sticky top-0 z-10">
                    <span class="cm-card-title"><i class="fa-solid fa-users text-purple-500"></i> Ng∆∞·ªùi tham gia</span>
                </div>
                <div class="flex-1 overflow-y-auto p-0">
                    <ul id="participants-list" class="divide-y divide-slate-50">
                        </ul>
                </div>
            </div>

            {# 3. Chat Box (Fixed / Mobile Popup) #}
            <div id="quiz-chat-panel" class="qb-chat-panel">
                <div class="cm-card qb-chat-container">
                    <div class="cm-card-header py-2 flex items-center justify-between gap-2">
                        <span class="cm-card-title text-sm"><i class="fa-solid fa-comments text-blue-400"></i> Th·∫£o lu·∫≠n</span>
                        <button type="button" id="close-chat-btn" class="qb-close-chat-btn items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-xs font-semibold text-slate-700 hover:bg-slate-200">
                            <i class="fa-solid fa-xmark"></i> ƒê√≥ng
                        </button>
                    </div>

                    <div id="chat-messages" class="qb-chat-messages">
                        <p class="text-center text-xs text-slate-400 mt-4">B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán...</p>
                    </div>

                    <form id="chat-form" class="qb-chat-input-area">
                        <input type="text" id="chat-input" class="flex-1 rounded-full border-slate-200 text-sm px-4 py-2 focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition outline-none" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
                        <button type="submit" class="w-9 h-9 rounded-full bg-blue-500 text-white flex items-center justify-center hover:bg-blue-600 shadow-sm transition">
                            <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<button type="button" id="open-chat-btn" class="qb-mobile-chat-toggle" aria-label="M·ªü chat">
    <i class="fa-solid fa-comments"></i>
    <span class="qb-mobile-chat-label">Chat</span>
    <span id="chat-unread-badge" class="qb-chat-unread" aria-hidden="true">‚Ä¢</span>
</button>
{% endblock %}

{% block scripts %}
{{ super() }}
{% include 'includes/chat_widget.html' %}
<script>
    (function() {
        // Initialize variables from template
        const initialRoom = {{ initial_room | tojson }};
        const roomCode = {{ room_code | tojson }};
        const currentUserId = {{ current_user_id | tojson }};
        const participantId = {{ participant_id | tojson }};
        const isHost = {{ is_host | tojson }};
        const fetchRoomUrl = {{ url_for('learning.quiz_battle.get_room', room_code=room_code) | tojson }};
        const leaveRoomUrl = {{ url_for('learning.quiz_battle.leave_room', room_code=room_code) | tojson }};
        const startRoomUrl = {{ url_for('learning.quiz_battle.start_room', room_code=room_code) | tojson }};
        const endRoomUrl = {{ url_for('learning.quiz_battle.end_room', room_code=room_code) | tojson }};
        const nextRoundUrl = {{ url_for('learning.quiz_battle.start_next_round', room_code=room_code) | tojson }};
        const getAiResponseUrl = {{ url_for('ai_services.get_ai_response') | tojson }};
        const messagesUrl = {{ url_for('shared.list_chat_messages', room_type='quiz-battle', room_code=room_code) | tojson }};
        const postMessageUrl = {{ url_for('shared.post_chat_message', room_type='quiz-battle', room_code=room_code) | tojson }};
        const answerUrlTemplate = {{ url_for('learning.quiz_battle.submit_round_answer', room_code=room_code, sequence_number=0) | tojson }};
        const noteSaveUrlTemplate = {{ url_for('notes.save_note', item_id=0) | tojson }};
        const feedbackSubmitUrl = {{ url_for('feedback.submit_feedback') | tojson }};
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        const chatPanel = document.getElementById('quiz-chat-panel');
        const openChatBtn = document.getElementById('open-chat-btn');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const unreadBadge = document.getElementById('chat-unread-badge');
        const mobileBreakpoint = window.matchMedia('(max-width: 1024px)');

        let roomState = initialRoom || {};
        // Force an initial render even if the server already sent an active round
        let lastRenderMeta = { sequence: null, hasMyAnswer: false };
        let roomPollInterval = null;
        let currentQuestionItemId = null;
        let pendingSelections = {};
        let visibleRound = roomState?.active_round || null;
        let pendingRoundSequence = null;
        let forceShowLatestRound = false;
        let chatController = null;
        const aiCoachContentEl = document.getElementById('question-ai-content');
        const aiCoachGenerateBtn = document.getElementById('ai-coach-generate-btn');
        const aiCoachButtonDefaultHtml = '<i class="fa-solid fa-wand-magic-sparkles"></i> T·∫°o h∆∞·ªõng d·∫´n AI';

        // --- Helper Functions ---
        function setAlert(msg, type='info') {
            const box = document.getElementById('room-alert');
            if(!box) return;
            if(!msg) { box.classList.add('hidden'); return; }
            box.classList.remove('hidden', 'bg-blue-50', 'bg-rose-50', 'text-blue-700', 'text-rose-700', 'border-blue-200', 'border-rose-200');
            
            let icon = '<i class="fa-solid fa-circle-info"></i>';
            if(type === 'error') {
                box.classList.add('bg-rose-50', 'text-rose-700', 'border-rose-200');
                icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
            } else {
                box.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200');
            }
            box.innerHTML = `${icon} <span>${msg}</span>`;
        }

        async function postJson(url, data={}) {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(data)
            });
            
            if(!res.ok) {
                // Tr√≠ch xu·∫•t l·ªói th√¥ng minh h∆°n
                let errorMessage = 'C√≥ l·ªói x·∫£y ra.';
                try {
                    const errorData = await res.json();
                    errorMessage = errorData.description || errorData.message || JSON.stringify(errorData);
                } catch(e) {
                    const text = await res.text();
                    errorMessage = text.substring(0, 100) + (text.length > 100 ? '...' : '');
                }
                throw new Error(errorMessage);
            }
            return res.json();
        }

        function getMyParticipant() {
            return (roomState.participants || []).find(p => p.user_id === currentUserId);
        }

        function syncNextButtonPlacement() {
            const nextBtn = document.getElementById('next-round-btn');
            if(!nextBtn) return;
            const shouldFloat = !nextBtn.classList.contains('hidden') && mobileBreakpoint.matches;
            nextBtn.classList.toggle('qb-next-mobile-floating', shouldFloat);
        }

        const renderAiContent = (value, options = {}) => {
            if(!aiCoachContentEl) return;
            if(window.applyMarkdownToElement) {
                window.applyMarkdownToElement(aiCoachContentEl, value || '', options);
            } else {
                aiCoachContentEl.textContent = value || '';
            }
        };

        async function generateAiCoachContent() {
            if(!currentQuestionItemId || !aiCoachContentEl) return;

            if(aiCoachGenerateBtn) {
                aiCoachGenerateBtn.disabled = true;
                aiCoachGenerateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫°o...';
            }
            renderAiContent('AI ƒëang t·∫°o h∆∞·ªõng d·∫´n...');

            try {
                const res = await postJson(getAiResponseUrl, {
                    item_id: currentQuestionItemId,
                    prompt_type: 'explanation',
                });

                const content = res?.response || res?.html_content || '';
                const treatAsHtml = Boolean(res?.html_content);
                if(content) {
                    renderAiContent(content, { treatAsHtml });
                    if(roomState?.active_round?.question?.item_id === currentQuestionItemId) {
                        roomState.active_round.question.ai_explanation = content;
                    }
                    aiCoachGenerateBtn?.classList.add('hidden');
                } else {
                    renderAiContent(res?.message || 'AI ch∆∞a ph·∫£n h·ªìi h∆∞·ªõng d·∫´n.');
                    aiCoachGenerateBtn?.classList.remove('hidden');
                }
            } catch(err) {
                renderAiContent(`Kh√¥ng t·∫°o ƒë∆∞·ª£c h∆∞·ªõng d·∫´n: ${err.message}`);
                aiCoachGenerateBtn?.classList.remove('hidden');
            } finally {
                if(aiCoachGenerateBtn) {
                    aiCoachGenerateBtn.disabled = false;
                    aiCoachGenerateBtn.innerHTML = aiCoachButtonDefaultHtml;
                }
            }
        }

        function renderChatMessages(msgs) {
            const container = document.getElementById('chat-messages');
            if(!container) return;
            container.innerHTML = '';
            if(!msgs.length) {
                container.innerHTML = '<p class="text-center text-xs text-slate-400 mt-4">Ch∆∞a c√≥ tin nh·∫Øn.</p>';
                return;
            }
            msgs.forEach(msg => {
                const isMe = msg.user_id === currentUserId;
                const div = document.createElement('div');
                div.className = `qb-chat-bubble ${isMe ? 'me' : 'other'}`;
                div.innerHTML = `
                    <div class="qb-msg-meta">${msg.username || 'User'}</div>
                    <div class="qb-msg-content">${msg.content}</div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        // --- Room Logic Functions ---
        function renderParticipants(parts) {
            const list = document.getElementById('participants-list');
            if(!list) return;
            list.innerHTML = parts.map(p => `
                <li class="px-4 py-3 flex justify-between items-center bg-white hover:bg-slate-50 transition">
                    <div>
                        <p class="text-sm font-semibold text-slate-800 ${p.user_id === currentUserId ? 'text-blue-600' : ''}">
                            ${p.username || 'User'} ${p.is_host ? '<i class="fa-solid fa-crown text-yellow-500 text-xs ml-1"></i>' : ''}
                        </p>
                        <p class="text-[10px] text-slate-500 uppercase">${p.status}</p>
                    </div>
                    <div class="text-right">
                        <span class="block text-sm font-bold text-slate-900">${p.session_score || 0}</span>
                        <span class="text-[10px] text-slate-400">ƒëi·ªÉm</span>
                    </div>
                </li>
            `).join('');
        }

        function syncVisibleRound() {
            const activeRound = roomState?.active_round || null;
            const matchingHistory = (roomState?.round_history || []).find(
                r => visibleRound && r.sequence_number === visibleRound.sequence_number
            );

            if(matchingHistory) {
                visibleRound = matchingHistory;
            } else if(
                activeRound &&
                visibleRound &&
                activeRound.sequence_number === visibleRound.sequence_number
            ) {
                visibleRound = activeRound;
            }
            if(forceShowLatestRound) {
                visibleRound = activeRound;
                pendingRoundSequence = null;
                forceShowLatestRound = false;
                return;
            }

            if(!visibleRound) {
                visibleRound = activeRound;
                pendingRoundSequence = null;
                return;
            }

            if(activeRound && activeRound.sequence_number > (visibleRound.sequence_number || 0)) {
                pendingRoundSequence = activeRound.sequence_number;
            } else if(!activeRound) {
                visibleRound = null;
                pendingRoundSequence = null;
            } else {
                pendingRoundSequence = null;
            }
        }

        function renderQuestion(round) {
            const overlay = document.getElementById('game-status-overlay');
            const title = document.getElementById('question-title');
            const detail = document.getElementById('question-detail');
            const mediaDiv = document.getElementById('question-media');
            const optionsDiv = document.getElementById('question-options');
            const submitBtn = document.getElementById('submit-answer-btn');

            if (!round || !round.question) {
                if(overlay) {
                    overlay.classList.remove('hidden');
                    const msgEl = document.getElementById('game-overlay-msg');
                    const titleEl = document.getElementById('game-overlay-title');
                    if(roomState.status === 'lobby') {
                        titleEl.textContent = 'S·∫£nh ch·ªù';
                        msgEl.textContent = 'Ch·ªß ph√≤ng ch∆∞a b·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u.';
                    } else if (roomState.status === 'awaiting_host') {
                        titleEl.textContent = 'Ch·ªù ch·ªß ph√≤ng';
                        msgEl.textContent = 'K·∫øt qu·∫£ ƒë√£ ch·ªët. Ch·ªù chuy·ªÉn sang c√¢u ti·∫øp theo.';
                    } else if (roomState.status === 'completed') {
                        titleEl.textContent = 'K·∫øt th√∫c';
                        msgEl.textContent = 'Tr·∫≠n ƒë·∫•u ƒë√£ ho√†n th√†nh. Ki·ªÉm tra b·∫£ng x·∫øp h·∫°ng!';
                    } else {
                        titleEl.textContent = 'ƒêang chu·∫©n b·ªã';
                        msgEl.textContent = 'ƒê·ª£i v√≤ng ti·∫øp theo...';
                    }
                }
                if(mediaDiv) {
                    mediaDiv.hidden = true;
                    mediaDiv.innerHTML = '';
                }
                return;
            }

            const timerEl = document.getElementById('question-timer');
            if(timerEl) timerEl.textContent = round.time_remaining_seconds ? `${round.time_remaining_seconds}s` : '';

            const opts = round.question.options || {};
            const answers = round.answers || [];
            const myAnswer = answers.find(a => a.participant_id === participantId);
            const hasMyAnswer = !!myAnswer;
            const isRoundActive = round.status === 'active';
            const needFullRender =
                round.sequence_number !== lastRenderMeta.sequence ||
                (hasMyAnswer && !lastRenderMeta.hasMyAnswer);

            if(needFullRender) {
                if(overlay) overlay.classList.add('hidden');

                title.textContent = round.question.question || 'C√¢u h·ªèi...';
                detail.textContent = round.question.passage_text || '';

                if(mediaDiv) {
                    mediaDiv.innerHTML = '';
                    const imageUrl = round.question.question_image_file;
                    const audioUrl = round.question.question_audio_file;

                    if(imageUrl) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = 'H√¨nh ·∫£nh c√¢u h·ªèi';
                        mediaDiv.appendChild(img);
                    }

                    if(audioUrl) {
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.src = audioUrl;
                        mediaDiv.appendChild(audio);
                    }

                    mediaDiv.hidden = mediaDiv.childElementCount === 0;
                }

                const roundKey = round.sequence_number;
                const selectedOption = hasMyAnswer
                    ? myAnswer.selected_option
                    : pendingSelections[roundKey] || null;

                if(!hasMyAnswer && isRoundActive) {
                    pendingSelections[roundKey] = selectedOption;
                }

                optionsDiv.innerHTML = Object.entries(opts).map(([key, val]) => `
                    <label class="qb-option-label ${selectedOption === key || myAnswer?.selected_option === key ? '!border-blue-500 !bg-blue-50' : ''}">
                        <input type="radio" name="selected_option" value="${key}" class="qb-option-input" ${hasMyAnswer ? 'disabled' : ''} ${selectedOption === key ? 'checked' : ''}>
                        <div>
                            <span class="font-bold text-slate-700 mr-2">${key}.</span>
                            <span class="text-slate-600">${val}</span>
                        </div>
                    </label>
                `).join('');

                if(!hasMyAnswer && isRoundActive) {
                    optionsDiv.querySelectorAll('input[name="selected_option"]').forEach(input => {
                        input.addEventListener('change', () => {
                            pendingSelections[round.sequence_number] = input.value;
                            submitBtn.disabled = false;
                        });
                    });
                }

                submitBtn.disabled =
                    hasMyAnswer ||
                    !participantId ||
                    (!hasMyAnswer && !pendingSelections[round.sequence_number]) ||
                    !isRoundActive;
                submitBtn.innerHTML = hasMyAnswer
                    ? '<i class="fa-solid fa-check"></i> ƒê√£ tr·∫£ l·ªùi'
                    : isRoundActive
                        ? '<i class="fa-solid fa-paper-plane"></i> G·ª≠i ƒë√°p √°n'
                        : '<i class="fa-solid fa-hourglass"></i> Ch·ªù c√¢u ti·∫øp theo';

                lastRenderMeta = { sequence: round.sequence_number, hasMyAnswer };
            }

            currentQuestionItemId = round.question.item_id;
            if(hasMyAnswer) updateFeedbackAndInsights(round, myAnswer);
            else {
                document.getElementById('answer-feedback-panel').hidden = true;
                document.getElementById('question-insight-panel').hidden = true;
            }

            renderStats(round);
        }

        function updateFeedbackAndInsights(round, answer) {
            const panel = document.getElementById('answer-feedback-panel');
            const insights = document.getElementById('question-insight-panel');
            if(!answer) return;

            panel.hidden = false;
            insights.hidden = false;

            const isCorrect = answer.is_correct;
            document.getElementById('answer-feedback-icon').textContent = isCorrect ? 'üéâ' : 'ü§î';
            document.getElementById('answer-feedback-title').textContent = isCorrect ? 'Ch√≠nh x√°c!' : 'Ch∆∞a ƒë√∫ng';
            document.getElementById('answer-feedback-detail').textContent = isCorrect ? `B·∫°n nh·∫≠n ƒë∆∞·ª£c +${answer.score_delta} ƒëi·ªÉm.` : 'ƒê·ª´ng lo, h√£y xem gi·∫£i th√≠ch b√™n d∆∞·ªõi.';
            document.getElementById('answer-feedback-correct').textContent = answer.correct_option || '?';
            document.getElementById('answer-feedback-score').textContent = (answer.score_delta > 0 ? '+' : '') + answer.score_delta;
            
            const expDiv = document.getElementById('answer-feedback-explanation');
            const explanationText =
                answer.explanation || round.question.explanation || 'Ch∆∞a c√≥ gi·∫£i th√≠ch.';
            expDiv.innerHTML = explanationText.replace(/\n/g, '<br>');

            const aiExplanation = round.question.ai_explanation || '';
            renderAiContent(aiExplanation || 'AI ƒëang ngh·ªâ ng∆°i...');
            if(aiCoachGenerateBtn) {
                aiCoachGenerateBtn.classList.toggle('hidden', Boolean(aiExplanation));
                aiCoachGenerateBtn.disabled = false;
                aiCoachGenerateBtn.innerHTML = aiCoachButtonDefaultHtml;
            }
            
            const noteContent = round.question.note_content || '';
            document.getElementById('question-note-content').textContent = noteContent || 'B·∫°n ch∆∞a c√≥ ghi ch√∫.';
            document.getElementById('question-note-input').value = noteContent;
        }

        function renderStats(round) {
            const answers = round.answers || [];
            const total = answers.length;
            const correct = answers.filter(a => a.is_correct).length;
            
            document.getElementById('question-stats-round').textContent = `#${round.sequence_number}`;
            document.getElementById('question-stats-total').textContent = total;
            document.getElementById('question-stats-accuracy').textContent = total ? Math.round((correct/total)*100) + '%' : '--%';
            
            const distDiv = document.getElementById('option-distribution');
            if(total === 0) {
                document.getElementById('question-stats-empty').hidden = false;
                distDiv.innerHTML = '';
            } else {
                document.getElementById('question-stats-empty').hidden = true;
                const counts = {};
                answers.forEach(a => counts[a.selected_option] = (counts[a.selected_option] || 0) + 1);
                distDiv.innerHTML = Object.entries(round.question.options || {}).map(([k, v]) => {
                    const c = counts[k] || 0;
                    const p = Math.round((c/total)*100);
                    const isCorrect = k === answers.find(a=>a.participant_id === participantId)?.correct_option;
                    return `
                        <div class="flex items-center gap-2">
                            <span class="w-4 font-bold ${isCorrect ? 'text-emerald-600' : 'text-slate-500'}">${k}</span>
                            <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full ${isCorrect ? 'bg-emerald-500' : 'bg-blue-400'}" style="width: ${p}%"></div>
                            </div>
                            <span class="text-xs text-slate-400 w-8 text-right">${c}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function hydrateUi() {
            document.getElementById('room-status').textContent = roomState.status;
            document.getElementById('room-status').dataset.status = roomState.status;
            document.getElementById('round-progress').textContent = `Ti·∫øn ƒë·ªô: ${roomState.current_round_number || 0}/${roomState.question_total || 0}`;
            const me = getMyParticipant();
            const answeredCount = me ? (me.correct_answers || 0) + (me.incorrect_answers || 0) : null;
            document.getElementById('player-answered').textContent = `ƒê√£ tr·∫£ l·ªùi: ${answeredCount !== null ? answeredCount : '--'} c√¢u`;
            document.getElementById('player-score').textContent = `T·ªïng ƒëi·ªÉm: ${me ? me.session_score || 0 : '--'}`;
            document.getElementById('room-mode').textContent = `Ch·∫ø ƒë·ªô: ${roomState.mode === 'TIMED' ? 'T√≠nh gi·ªù' : 'Th∆∞·ªùng'}`;

            renderParticipants(roomState.participants || []);
            syncVisibleRound();
            renderQuestion(visibleRound);

            const canStart = isHost && roomState.status === 'lobby';
            const canAdvance =
                pendingRoundSequence !== null &&
                roomState.status !== 'completed';
            const canEnd = isHost && roomState.status !== 'completed';
            document.getElementById('start-room-btn').disabled = !canStart;
            document.getElementById('start-room-btn').classList.toggle('hidden', roomState.status !== 'lobby');
            const nextBtn = document.getElementById('next-round-btn');
            nextBtn.classList.toggle('hidden', !canAdvance);
            nextBtn.disabled = !canAdvance;
            document.getElementById('end-room-btn').disabled = !canEnd;
            if(roomState.status === 'completed') {
                document.getElementById('leave-room-btn').innerHTML = '<i class="fa-solid fa-person-walking-arrow-right"></i> Tho√°t';
            }
            syncNextButtonPlacement();
        }

        async function fetchRoomState(forceLatest = false) {
            try {
                const res = await fetch(fetchRoomUrl);
                if(res.ok) {
                    const data = await res.json();
                    roomState = data.room;
                    if(forceLatest) {
                        forceShowLatestRound = true;
                        lastRenderMeta = { sequence: null, hasMyAnswer: false };
                    }
                    hydrateUi();
                }
            } catch(e) { console.error("Sync error", e); }
        }

        // --- Event Listeners (ƒê√£ th√™m error handling) ---

        if(aiCoachGenerateBtn) {
            aiCoachGenerateBtn.innerHTML = aiCoachButtonDefaultHtml;
            aiCoachGenerateBtn.addEventListener('click', generateAiCoachContent);
        }

        mobileBreakpoint.addEventListener('change', syncNextButtonPlacement);

        document.getElementById('start-room-btn').addEventListener('click', async () => {
            try {
                await postJson(startRoomUrl);
                pendingSelections = {};
                forceShowLatestRound = true;
                fetchRoomState(true);
            } catch(e) { setAlert(e.message, 'error'); }
        });

        document.getElementById('end-room-btn').addEventListener('click', async () => {
            if(!confirm('K·∫øt th√∫c tr·∫≠n ƒë·∫•u?')) return;
            try {
                await postJson(endRoomUrl);
                fetchRoomState();
            } catch(e) { setAlert(e.message, 'error'); }
        });

        document.getElementById('next-round-btn').addEventListener('click', async () => {
            try {
                await postJson(nextRoundUrl);
                pendingSelections = {};
                forceShowLatestRound = true;
                fetchRoomState(true);
            } catch(e) { setAlert(e.message, 'error'); }
        });

        document.getElementById('leave-room-btn').addEventListener('click', async () => {
            if(!confirm('R·ªùi ph√≤ng?')) return;
            try {
                await postJson(leaveRoomUrl);
                window.location.href = "{{ url_for('learning.quiz_learning.quiz_learning_dashboard') }}";
            } catch(e) { setAlert(e.message, 'error'); }
        });
        
        document.getElementById('answer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const selected = new FormData(e.target).get('selected_option');
            if(!selected) return setAlert('Ch·ªçn m·ªôt ƒë√°p √°n!', 'error');

            const btn = document.getElementById('submit-answer-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang g·ª≠i...';

            try {
                const seq = (visibleRound || roomState.active_round).sequence_number;
                const url = answerUrlTemplate.replace('/0/', `/${seq}/`);
                const data = await postJson(url, { selected_option: selected });
                roomState = data.room;
                const mergedAnswer = {
                    participant_id: participantId,
                    user_id: currentUserId,
                    selected_option: selected,
                    is_correct: data.answer?.is_correct,
                    score_delta: data.answer?.score_delta,
                    correct_option: data.answer?.correct_option,
                    explanation: data.answer?.explanation,
                    answered_at: new Date().toISOString(),
                };
                const roundFromRoom =
                    (roomState.round_history || []).find(r => r.sequence_number === seq) ||
                    (roomState.active_round?.sequence_number === seq ? roomState.active_round : null) ||
                    visibleRound;
                if(roundFromRoom) {
                    const existing = (roundFromRoom.answers || []).filter(a => a.participant_id !== participantId);
                    roundFromRoom.answers = [...existing, mergedAnswer];
                    visibleRound = roundFromRoom;
                }
                pendingSelections[seq] = null;
                lastRenderMeta = { sequence: seq, hasMyAnswer: true };
                hydrateUi();
            } catch(err) {
                setAlert(err.message, 'error');
                btn.disabled = false;
                btn.innerHTML = 'Th·ª≠ l·∫°i';
            }
        });

        chatController = window.sharedChat?.initChat({
            messagesUrl,
            postMessageUrl,
            currentUserId,
            pollInterval: 5000,
            csrfToken,
            elements: {
                messages: document.getElementById('chat-messages'),
                form: document.getElementById('chat-form'),
                input: document.getElementById('chat-input'),
                panel: chatPanel,
                openButton: openChatBtn,
                closeButton: closeChatBtn,
                unreadBadge,
            },
            renderMessages: renderChatMessages,
        });

        chatPanel?.addEventListener('click', (event) => {
            if (event.target === chatPanel) {
                chatController?.setOpen(false);
            }
        });

        // Notes & Feedback Listeners (Standard toggle logic)
        document.getElementById('question-note-edit').addEventListener('click', () => {
            document.getElementById('question-note-editor').classList.remove('hidden');
            document.getElementById('question-note-content').classList.add('hidden');
        });
        document.getElementById('question-note-cancel').addEventListener('click', () => {
            document.getElementById('question-note-editor').classList.add('hidden');
            document.getElementById('question-note-content').classList.remove('hidden');
        });
        document.getElementById('question-note-save').addEventListener('click', async () => {
            const content = document.getElementById('question-note-input').value;
            const url = noteSaveUrlTemplate.replace('0', currentQuestionItemId);
            try {
                await postJson(url, { content });
                document.getElementById('question-note-content').textContent = content;
                document.getElementById('question-note-editor').classList.add('hidden');
                document.getElementById('question-note-content').classList.remove('hidden');
            } catch(e) { setAlert(e.message, 'error'); }
        });
        
        document.getElementById('copy-room-code').addEventListener('click', () => {
            navigator.clipboard.writeText(roomCode);
            setAlert('ƒê√£ sao ch√©p m√£ ph√≤ng!');
            setTimeout(() => setAlert(''), 2000);
        });

        // Init
        hydrateUi();
        roomPollInterval = setInterval(fetchRoomState, 3000);

        window.addEventListener('beforeunload', () => {
            clearInterval(roomPollInterval);
            chatController?.stopPolling();
        });

    })();
</script>
{% endblock %}