{# =============================== #}
{# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_learning_dashboard.html #}
{# Phiên bản: 1.0 #}
{# Mục đích: Giao diện chính để chọn bộ thẻ và chế độ học Flashcard. #}
{# =============================== #}

{% extends "base.html" %}
{% from 'includes/_search_form.html' import render_search_form %}

{% block title %}Học Flashcard - MindStack{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .selected-item {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .selected-mode {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .start-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .tab-filter-button.active { 
            border-bottom: 2px solid #3b82f6; 
            color: #3b82f6; 
        }
        .tab-filter-button {
            transition: all 0.2s ease-in-out;
            color: #6b7280;
            font-weight: 500;
        }
        
        .flashcard-title-wrapper { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 2rem; 
            width: 100%;
        }
        .flashcard-title-badge {
            width: 100%;
            max-width: 100%;
            background: #e0f2fe;
            color: #1e3a8a;
            font-size: 2rem;
            font-weight: 800;
            padding: 0.75rem 2.5rem;
            border-radius: 9999px;
            border: 2px solid #bfdbfe;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-shadow: none;
            letter-spacing: 0.05em;
            transition: all .3s ease;
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
        }
        .flashcard-title-badge .fa-clone { 
            margin-right: .75rem;
            font-size: 2.25rem;
        }
        .flashcard-title-badge:hover { 
            box-shadow: 0 6px 14px rgba(30,58,138,0.20);
            border-color: #60a5fa;
            transform: translateY(-2px);
        }
        
        .flashcard-set-item {
            position: relative;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        .flashcard-set-item:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); transform: translateY(-2px); }

        .archive-icon {
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s ease;
        }
        .archive-icon:hover {
            color: #3b82f6;
        }
        .archived .archive-icon {
            color: #3b82f6;
        }
        
        .tabs-and-toggle-wrapper {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .tab-group {
            display: flex;
            flex-grow: 1;
            min-width: 0;
            overflow: hidden;
        }
        .tab-filter-button {
            flex-grow: 1;
            flex-shrink: 1;
            padding: 0.75rem 0.5rem;
            text-align: center;
            white-space: nowrap;
            font-size: 0.875rem;
        }
        .tab-filter-button i {
            margin-right: 0.5rem;
        }
        .tab-filter-button span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        @media (max-width: 639px) {
            .tab-filter-button {
                font-size: 0.75rem;
                padding: 0.5rem 0.25rem;
            }
        }
        @media (min-width: 640px) {
            .tab-group {
                justify-content: space-between;
            }
            .tab-filter-button {
                font-size: 1rem;
            }
        }

        .selected-sets-container {
            margin-bottom: 1rem;
            min-height: 2.5rem;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
            padding: 0.5rem;
            color: #4b5563;
            font-size: 0.875rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .selected-set-item {
            background-color: #dbeafe;
            color: #1e3a8a;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.25rem;
            display: inline-flex;
            align-items: center;
        }
        .selected-set-item i {
            margin-left: 0.5rem;
            font-size: 0.6rem;
            cursor: pointer;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-1 py-4 sm:px-6 sm:py-6 lg:px-8 lg:py-8">
    <div class="flashcard-title-wrapper">
        <div id="flashcardTitle" class="flashcard-title-badge"><i class="fas fa-clone"></i>Flashcard</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mx-auto max-w-full">
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                <i class="fas fa-list-alt mr-3 text-blue-500"></i> Bước 1: Chọn một bộ thẻ
            </h2>
            <div class="mb-4">
                <div class="tabs-and-toggle-wrapper">
                    <div class="tab-group">
                        <button id="filter-doing" class="tab-filter-button flex items-center justify-center active" data-filter="doing"><i class="fas fa-play-circle mr-2"></i><span>Đang học</span></button>
                        <button id="filter-explore" class="tab-filter-button flex items-center justify-center" data-filter="explore"><i class="fas fa-globe mr-2"></i><span>Khám phá</span></button>
                        <button id="filter-archive" class="tab-filter-button flex items-center justify-center" data-filter="archive"><i class="fas fa-archive mr-2"></i><span>Archive</span></button>
                    </div>
                </div>
            </div>
            <div id="selected-sets-display" class="selected-sets-container hidden">
                <span class="text-gray-500">Bộ thẻ đã chọn:</span>
            </div>
            <div id="flashcard-sets-container" class="flex-grow">
                <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]">
                    <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                    <p>Đang tải danh sách bộ thẻ...</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
            <h2 id="step-2-title" class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center truncate">
                <i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học
            </h2>
            <div id="flashcard-modes-container" class="flex-grow">
                <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                    <i class="fas fa-info-circle text-4xl mb-3"></i>
                    <p>Vui lòng chọn một bộ thẻ trước.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8 text-center">
        <button id="start-learning-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" style="display: none;">
            <i class="fas fa-play-circle mr-3"></i> Bắt đầu học
        </button>
        <button id="bulk-unarchive-btn" class="start-button bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md flex items-center justify-center mx-auto" style="display: none;">
            <i class="fas fa-box-open mr-3"></i> Bỏ lưu trữ
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    console.log('>>> flashcard_learning_dashboard.js: init');

    {# ==== Biến trạng thái ==== #}
    let selectedFlashcardSetIds = [];
    let selectedFlashcardMode = null;
    let selectedSessionSize = parseInt("{{ user_default_batch_size | default(10) }}");
    let currentFilter = "{{ current_filter | default('doing') }}";
    let doingPage = 1; let explorePage = 1; let archivePage = 1; let currentPage = (currentFilter === 'doing' ? doingPage : (currentFilter === 'explore' ? explorePage : archivePage));
    let currentSearchQuery = "{{ search_query | default('') }}";
    let currentSearchField = "{{ search_field | default('all') }}";
    let isMultiSelectMode = true;

    const flashcardSetsContainer = document.getElementById('flashcard-sets-container');
    const flashcardModesContainer = document.getElementById('flashcard-modes-container');
    const startLearningBtn = document.getElementById('start-learning-btn');
    const bulkUnarchiveBtn = document.getElementById('bulk-unarchive-btn');
    const selectedSetsDisplay = document.getElementById('selected-sets-display');
    const step2Title = document.getElementById('step-2-title');
    
    const rightPanel = document.querySelector('.lg\\:grid-cols-2 > div:nth-child(2)');
    let allSetsButton = null;

    const flashcardModesPartialBaseUrlById = "{{ url_for('learning.flashcard_learning.get_flashcard_modes_partial_by_id', set_id=0) or '#' }}";
    const flashcardModesPartialBaseUrlAll = "{{ url_for('learning.flashcard_learning.get_flashcard_modes_partial_all') or '#' }}";
    const flashcardModesPartialBaseUrlMulti = "{{ url_for('learning.flashcard_learning.get_flashcard_modes_partial_multi', set_ids_str='0') or '#' }}";
    const startFlashcardSessionBaseUrlAllTemplate = "{{ url_for('learning.flashcard_learning.start_flashcard_session_all', mode='MODE_PLACEHOLDER') }}";
    const startFlashcardSessionBaseUrlMultiTemplate = "{{ url_for('learning.flashcard_learning.start_flashcard_session_multi', mode='MODE_PLACEHOLDER') }}";
    const startFlashcardSessionBaseUrlByIdTemplate = "{{ url_for('learning.flashcard_learning.start_flashcard_session_by_id', set_id=0, mode='MODE_PLACEHOLDER') }}";
    const getFlashcardSetsPartialUrl = "{{ url_for('learning.flashcard_learning.get_flashcard_sets_partial') or '#' }}";
    const saveFlashcardSettingsUrl = "{{ url_for('learning.flashcard_learning.save_flashcard_settings') }}";
    const toggleArchiveUrl = "{{ url_for('learning.flashcard_learning.toggle_archive_flashcard', set_id=0) or '#' }}";
    const bulkUnarchiveUrl = "{{ url_for('learning.flashcard_learning.bulk_unarchive_flashcard') }}";

    function toggleAllSetsButtonVisibility() {
        if (!allSetsButton) {
            allSetsButton = document.querySelector('.flashcard-set-item[data-set-id="all"]');
        }
        if (allSetsButton) {
            allSetsButton.style.display = (currentFilter === 'doing') ? 'flex' : 'none';
        }
    }
    
    async function loadFlashcardSets(page, searchQuery, searchField, filter) {
        console.log('loadFlashcardSets', page, searchQuery, searchField, filter);
        flashcardSetsContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải danh sách bộ thẻ...</p></div>';
        
        if (localStorage.getItem('selectedFlashcardSetIds')) {
            selectedFlashcardSetIds = JSON.parse(localStorage.getItem('selectedFlashcardSetIds'));
        } else {
            selectedFlashcardSetIds = [];
        }

        updateSelectedSetsDisplay();
        updateActionButtons();

        if (!getFlashcardSetsPartialUrl || getFlashcardSetsPartialUrl === '#') {
            console.error('getFlashcardSetsPartialUrl không hợp lệ.');
            flashcardSetsContainer.innerHTML = '<p class="text-red-500 text-center">Lỗi cấu hình URL. Vui lòng liên hệ quản trị viên.</p>';
            return;
        }
        try {
            const url = new URL(getFlashcardSetsPartialUrl, window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('q', searchQuery || '');
            url.searchParams.append('search_field', searchField || 'all');
            url.searchParams.append('filter', filter || 'doing');
            url.searchParams.append('is_multi_select_mode', 'true');

            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const html = await response.text();
            flashcardSetsContainer.innerHTML = html;
            addFlashcardSetClickListeners();
            addPaginationAndSearchListeners();
            addArchiveIconListeners();
            updateFlashcardSetProgressColors();
            syncMultiSelectionUI();
            
            toggleAllSetsButtonVisibility();
        } catch (e) {
            console.error('Lỗi loadFlashcardSets:', e);
            flashcardSetsContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải danh sách bộ thẻ. Vui lòng thử lại.</p>';
        }
    }

    async function loadFlashcardModes(setId) {
        console.log('loadFlashcardModes ->', setId);
        if (currentFilter === 'archive') { return; } 
        flashcardModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải chế độ học...</p></div>';
        try {
            let url;
            if (Array.isArray(setId)) {
                if (setId.length === 0) {
                     flashcardModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ thẻ trước.</p></div>';
                     updateActionButtons();
                     return;
                }
                if (setId.length === 1 && setId[0] === 'all') {
                    url = flashcardModesPartialBaseUrlAll;
                } else {
                    const setIdsStr = setId.join(',');
                    url = flashcardModesPartialBaseUrlMulti.replace('/0', '/' + setIdsStr);
                }
            } else if (setId === 'all') {
                url = flashcardModesPartialBaseUrlAll;
            } else {
                url = flashcardModesPartialBaseUrlById.replace('/0', '/' + setId);
            }
            if (!url || url === '#') { throw new Error('URL chế độ học không hợp lệ'); }

            const fullUrl = new URL(url, window.location.origin);
            if (selectedFlashcardMode) { fullUrl.searchParams.append('selected_mode', selectedFlashcardMode); }
            fullUrl.searchParams.append('user_default_batch_size', selectedSessionSize);

            const response = await fetch(fullUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) { throw new Error('HTTP ' + response.status); }
            const html = await response.text();
            flashcardModesContainer.innerHTML = html;
            addFlashcardModeClickListeners();

            const sessionSizeSelect = document.getElementById('session-size-select');
            if (sessionSizeSelect) {
                sessionSizeSelect.value = selectedSessionSize;
                sessionSizeSelect.addEventListener('change', async function(){
                    selectedSessionSize = parseInt(this.value);
                    updateActionButtons();
                    try {
                        const res = await fetch(saveFlashcardSettingsUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ batch_size: selectedSessionSize }) });
                        const js = await res.json();
                        if (!js.success) { console.error('Lưu batch_size lỗi:', js.message); }
                    } catch (err) { console.error('AJAX lưu batch_size lỗi:', err); }
                });
            }
            
            const firstAvailableMode = flashcardModesContainer.querySelector('.flashcard-mode-item[data-count="0"]');
            if (firstAvailableMode) { firstAvailableMode.classList.add('opacity-50', 'cursor-not-allowed'); }

            if (!selectedFlashcardMode) {
                const available = Array.from(flashcardModesContainer.querySelectorAll('.flashcard-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                if (available.length > 0) { available[0].click(); }
                else { selectedFlashcardMode = null; updateActionButtons(); }
            } else {
                const prev = flashcardModesContainer.querySelector('[data-mode-id="' + selectedFlashcardMode + '"]');
                if (prev && parseInt(prev.dataset.count) > 0) { prev.click(); }
                else {
                    selectedFlashcardMode = null; updateActionButtons();
                    const available2 = Array.from(flashcardModesContainer.querySelectorAll('.flashcard-mode-item')).filter(function(x){ return parseInt(x.dataset.count) > 0; });
                    if (available2.length > 0) { available2[0].click(); }
                }
            }
        } catch (e) {
            console.error('Lỗi loadFlashcardModes:', e);
            flashcardModesContainer.innerHTML = '<p class="text-red-500 text-center">Không thể tải chế độ học. Vui lòng thử lại.</p>';
        }
    }

    function syncMultiSelectionUI() {
        if (isMultiSelectMode) {
            document.querySelectorAll('.flashcard-set-item').forEach(item => {
                const setId = item.dataset.setId;
                if (selectedFlashcardSetIds.includes(setId)) {
                    item.classList.add('selected-item');
                } else {
                    item.classList.remove('selected-item');
                }
            });
            updateSelectedSetsDisplay();
        }
        document.querySelectorAll('.archive-icon').forEach(icon => {
            icon.style.display = (currentFilter === 'doing' || currentFilter === 'explore') ? '' : 'none';
        });
    }

    function updateSelectedSetsDisplay() {
        if (selectedFlashcardSetIds.length > 0) {
            selectedSetsDisplay.classList.remove('hidden');
            selectedSetsDisplay.innerHTML = `<span class="text-gray-500 mr-2">Bộ thẻ đã chọn:</span>`;
            
            const allSelectedItems = new Map();
            document.querySelectorAll('.flashcard-set-item').forEach(item => {
                const setId = item.dataset.setId;
                if (selectedFlashcardSetIds.includes(setId)) {
                     const title = item.querySelector('h3').textContent;
                     allSelectedItems.set(setId, title);
                }
            });
            
            selectedFlashcardSetIds.forEach(setId => {
                let title;
                if (allSelectedItems.has(setId)) {
                    title = allSelectedItems.get(setId);
                } else if (setId === 'all') {
                    title = 'Học tất cả các bộ';
                } else {
                    const storedTitles = JSON.parse(localStorage.getItem('selectedFlashcardSetTitles')) || {};
                    title = storedTitles[setId] || setId;
                }

                if (title) {
                    const selectedItemHtml = `
                        <div class="selected-set-item" data-set-id="${setId}">
                            <span>${title}</span>
                            <i class="fas fa-times-circle remove-selected-set"></i>
                        </div>
                    `;
                    selectedSetsDisplay.insertAdjacentHTML('beforeend', selectedItemHtml);
                }
            });
            
        } else {
            selectedSetsDisplay.classList.add('hidden');
        }

        document.querySelectorAll('.remove-selected-set').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const setIdToRemove = this.closest('.selected-set-item').dataset.setId;
                handleFlashcardSetSelection(setIdToRemove);
            });
        });
    }

    function handleFlashcardSetSelection(setId) {
        if (setId !== 'all' && selectedFlashcardSetIds.includes('all')) {
            const allButton = document.querySelector('.flashcard-set-item[data-set-id="all"]');
            if (allButton) {
                allButton.classList.remove('selected-item');
            }
            selectedFlashcardSetIds = [];
        }
        if (setId === 'all' && selectedFlashcardSetIds.some(id => id !== 'all')) {
            document.querySelectorAll('.flashcard-set-item.selected-item').forEach(el => el.classList.remove('selected-item'));
            selectedFlashcardSetIds = [];
        }

        const item = document.querySelector(`.flashcard-set-item[data-set-id="${setId}"]`);
        
        if (selectedFlashcardSetIds.includes(setId)) {
            selectedFlashcardSetIds = selectedFlashcardSetIds.filter(id => id !== setId);
            if (item) item.classList.remove('selected-item');
        } else {
            selectedFlashcardSetIds.push(setId);
            if (item) item.classList.add('selected-item');
        }
        
        localStorage.setItem('selectedFlashcardSetIds', JSON.stringify(selectedFlashcardSetIds));
        const storedTitles = JSON.parse(localStorage.getItem('selectedFlashcardSetTitles')) || {};
        if (item) {
            storedTitles[setId] = item.querySelector('h3').textContent;
        }
        localStorage.setItem('selectedFlashcardSetTitles', JSON.stringify(storedTitles));

        selectedFlashcardMode = null;
        if (selectedFlashcardSetIds.length > 0 && currentFilter !== 'archive') {
            loadFlashcardModes(selectedFlashcardSetIds);
        } else {
            if (currentFilter !== 'archive') {
                flashcardModesContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Vui lòng chọn một bộ thẻ trước.</p></div>';
            } else {
                updateStep2Content();
            }
        }
        
        updateActionButtons();
        updateSelectedSetsDisplay();
        toggleAllSetsButtonVisibility();
    }


    function addFlashcardSetClickListeners() {
        document.querySelectorAll('.flashcard-set-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                const totalItems = parseInt(this.dataset.totalItems);
                if (currentFilter !== 'doing' && this.dataset.setId === 'all') { 
                    ev.preventDefault(); ev.stopPropagation(); return; 
                }
                if (currentFilter !== 'archive' && totalItems === 0 && this.dataset.setId !== 'all') { 
                    ev.preventDefault(); ev.stopPropagation(); return; 
                }
                const setId = this.dataset.setId;
                handleFlashcardSetSelection(setId);
            });
        });
    }

    function addFlashcardModeClickListeners() {
        document.querySelectorAll('.flashcard-mode-item').forEach(function(item){
            item.addEventListener('click', function(ev){
                const modeCount = parseInt(this.dataset.count);
                if (modeCount === 0) {
                    ev.preventDefault();
                    ev.stopPropagation();
                    return;
                }
                document.querySelectorAll('.flashcard-mode-item').forEach(function(el){ el.classList.remove('selected-mode'); });
                this.classList.add('selected-mode');
                selectedFlashcardMode = this.dataset.modeId;
                updateActionButtons();
            });
        });
    }

    function addPaginationAndSearchListeners() {
        const searchForm = flashcardSetsContainer.querySelector('form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e){
                e.preventDefault();
                localStorage.setItem('selectedFlashcardSetIds', JSON.stringify(selectedFlashcardSetIds));
                const data = new FormData(searchForm);
                currentSearchQuery = data.get('q') || '';
                currentSearchField = data.get('search_field') || 'all';
                if (currentFilter === 'doing') { doingPage = 1; } else if (currentFilter === 'explore') { explorePage = 1; } else { archivePage = 1; }
                currentPage = 1;
                loadFlashcardSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            });
        }
        document.querySelectorAll('.pagination a').forEach(function(a){
            a.addEventListener('click', function(e){
                e.preventDefault();
                localStorage.setItem('selectedFlashcardSetIds', JSON.stringify(selectedFlashcardSetIds));
                const url = new URL(this.href, window.location.origin);
                const page = parseInt(url.searchParams.get('page')) || 1;
                const q = url.searchParams.get('q') || '';
                const search_field = url.searchParams.get('search_field') || 'all';
                const filter = url.searchParams.get('filter') || 'doing';
                if (filter === 'doing') { doingPage = page; } else if (filter === 'explore') { explorePage = page; } else { archivePage = page; }
                currentPage = page;
                loadFlashcardSets(currentPage, q, search_field, filter);
            });
        });
    }

    function addArchiveIconListeners() {
        document.querySelectorAll('.archive-icon').forEach(function(icon){
            icon.addEventListener('click', async function(event){
                event.stopPropagation();
                const setId = this.dataset.setId;
                if (!setId) return;

                const url = toggleArchiveUrl.replace('/0', '/' + setId);

                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const itemElement = this.closest('.flashcard-set-item');
                        if (currentFilter === 'archive' && !result.is_archived) {
                            itemElement.remove();
                        } else if ((currentFilter === 'doing' || currentFilter === 'explore') && result.is_archived) {
                            itemElement.remove();
                        } else {
                            if (result.is_archived) {
                                itemElement.classList.add('archived');
                                this.title = "Bỏ lưu trữ";
                                this.querySelector('i').classList.add('text-blue-500');
                                this.querySelector('i').classList.remove('text-gray-400');
                            } else {
                                itemElement.classList.remove('archived');
                                this.title = "Lưu trữ";
                                this.querySelector('i').classList.remove('text-blue-500');
                                this.querySelector('i').classList.add('text-gray-400');
                            }
                        }
                        
                        selectedFlashcardSetIds = selectedFlashcardSetIds.filter(id => id !== setId);
                        localStorage.setItem('selectedFlashcardSetIds', JSON.stringify(selectedFlashcardSetIds));

                        loadFlashcardSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);

                        window.showFlashMessage(result.message, 'success');

                    } else {
                        window.showFlashMessage(result.message || 'Có lỗi xảy ra khi cập nhật trạng thái lưu trữ.', 'danger');
                    }
                } catch (e) {
                    console.error('Lỗi AJAX toggle archive:', e);
                    window.showFlashMessage('Không thể kết nối đến máy chủ.', 'danger');
                }
            });
        });
    }

    function updateActionButtons() {
        const selectedCount = selectedFlashcardSetIds.length;
        const isSelected = selectedCount > 0;

        if (currentFilter === 'archive') {
            startLearningBtn.style.display = 'none';
            bulkUnarchiveBtn.style.display = 'block';
            if (isSelected) {
                bulkUnarchiveBtn.disabled = false;
                bulkUnarchiveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                bulkUnarchiveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                bulkUnarchiveBtn.disabled = true;
                bulkUnarchiveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                bulkUnarchiveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        } else {
            bulkUnarchiveBtn.style.display = 'none';
            startLearningBtn.style.display = 'block';
            const modeAvailable = selectedFlashcardMode !== null;
            const sessionSizeSelect = document.getElementById('session-size-select');
            const isSessionSizeSelected = sessionSizeSelect && sessionSizeSelect.value;
            
            if (isSelected && modeAvailable && isSessionSizeSelected) {
                startLearningBtn.disabled = false;
                startLearningBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                startLearningBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                startLearningBtn.disabled = true;
                startLearningBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                startLearningBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }
    }

    function updateFlashcardSetProgressColors() {
        document.querySelectorAll('.flashcard-set-item').forEach(function(item){
            const pct = parseInt(item.dataset.completionPercentage || '0');
            const txt = item.querySelector('.flashcard-set-completion-text');
            if (txt) { txt.style.color = (pct > 50 ? '#111' : '#333'); }
        });
    }
    
    startLearningBtn.addEventListener('click', function(){
        const currentBatchSize = document.getElementById('session-size-select').value;
        let startUrl;
        
        if (selectedFlashcardSetIds.length > 0 && selectedFlashcardMode && currentBatchSize) {
            localStorage.removeItem('selectedFlashcardSetIds');
            const setIdsStr = selectedFlashcardSetIds.join(',');
            if (selectedFlashcardSetIds.length === 1 && selectedFlashcardSetIds[0] === 'all') {
                startUrl = new URL(startFlashcardSessionBaseUrlAllTemplate.replace('MODE_PLACEHOLDER', selectedFlashcardMode), window.location.origin);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            } else if (selectedFlashcardSetIds.length === 1 && selectedFlashcardSetIds[0] !== 'all') {
                startUrl = new URL(startFlashcardSessionBaseUrlByIdTemplate.replace('0', selectedFlashcardSetIds[0]).replace('MODE_PLACEHOLDER', selectedFlashcardMode), window.location.origin);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            } else {
                startUrl = new URL(startFlashcardSessionBaseUrlMultiTemplate.replace('MODE_PLACEHOLDER', selectedFlashcardMode), window.location.origin);
                startUrl.searchParams.append('set_ids', setIdsStr);
                startUrl.searchParams.append('batch_size', currentBatchSize);
            }
            window.location.href = startUrl.toString();
        }
    });
    
    bulkUnarchiveBtn.addEventListener('click', async function(){
        if (selectedFlashcardSetIds.length === 0) {
            window.showFlashMessage('Vui lòng chọn ít nhất một bộ thẻ để bỏ lưu trữ.', 'warning');
            return;
        }

        try {
            const response = await fetch(bulkUnarchiveUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ set_ids: selectedFlashcardSetIds })
            });

            const result = await response.json();
            if (response.ok && result.success) {
                localStorage.removeItem('selectedFlashcardSetIds');
                window.showFlashMessage(result.message, 'success');
                loadFlashcardSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            } else {
                window.showFlashMessage(result.message || 'Có lỗi xảy ra khi bỏ lưu trữ.', 'danger');
            }
        } catch (e) {
            console.error('Lỗi khi bỏ lưu trữ hàng loạt:', e);
            window.showFlashMessage('Không thể kết nối đến máy chủ.', 'danger');
        }
    });

    document.querySelectorAll('.tab-filter-button').forEach(function(button) {
        button.addEventListener('click', function() {
            const newFilter = this.dataset.filter;
            if (currentFilter !== newFilter) {
                if (currentFilter === 'doing') { doingPage = currentPage; }
                else if (currentFilter === 'explore') { explorePage = currentPage; }
                else if (currentFilter === 'archive') { archivePage = currentPage; }

                currentFilter = newFilter;
                if (currentFilter === 'doing') { currentPage = doingPage; }
                else if (currentFilter === 'explore') { currentPage = explorePage; }
                else { currentPage = archivePage; }

                document.querySelectorAll('.tab-filter-button').forEach(function(btn){
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                isMultiSelectMode = true; 
                
                updateStep2Content();
                
                localStorage.setItem('selectedFlashcardSetIds', JSON.stringify(selectedFlashcardSetIds));

                loadFlashcardSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
            }
        });
    });
    
    function updateStep2Content() {
        const isMobile = window.innerWidth < 640;
        if (currentFilter === 'archive') {
            rightPanel.style.display = isMobile ? 'none' : 'flex';
            step2Title.innerHTML = `<i class="fas fa-info-circle mr-3 text-blue-500"></i> Bỏ lưu trữ`;
            
            if (!isMobile) {
                flashcardModesContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-700 p-4">
                        <p class="text-base text-center mb-4">
                            Hãy chọn các bộ cần để bỏ lưu trữ trên giao diện.
                        </p>
                    </div>
                `;
            }
        } else {
            rightPanel.style.display = 'flex';
            step2Title.innerHTML = `<i class="fas fa-cogs mr-3 text-blue-500"></i> Bước 2: Chọn chế độ học`;
            flashcardModesContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[300px]">
                    <i class="fas fa-info-circle text-4xl mb-3"></i>
                    <p>Vui lòng chọn một bộ thẻ trước.</p>
                </div>
            `;
        }
    }


    document.addEventListener('DOMContentLoaded', function(){
        isMultiSelectMode = true; 
        updateStep2Content();
        
        loadFlashcardSets(currentPage, currentSearchQuery, currentSearchField, currentFilter);
    });
    
    window.addEventListener('beforeunload', function() {
        localStorage.removeItem('selectedFlashcardSetIds');
    });

    </script>
{% endblock %}