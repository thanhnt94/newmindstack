{# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html #}
{# Phiên bản: 21.0 #}
{# Mục đích: Khắc phục lỗi hiển thị trên di động, đảm bảo thẻ flashcard hiển thị tràn viền, không có cuộn và ẩn footer. #}

{% extends "base.html" %}
{% block title %}Học Flashcard{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    /* ===== CSS tùy chỉnh mới cho Flashcard Session ===== */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f9fafb;
    }
    
    /* Ghi đè CSS từ base.html để ẩn footer chỉ trên trang này */
    @media (max-width: 1024px) {
        body > footer {
            display: none !important;
        }
    }

    /* ===== Layout toàn trang (full height) ===== */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Ngăn cuộn trang chính */
    }

    .page-shell {
        position: fixed; /* Sử dụng fixed để chiếm toàn bộ viewport */
        left: 0;
        right: 0;
        top: var(--header-h, 0px);
        bottom: 0; /* Chiếm hết chiều cao còn lại */
        display: flex;
        flex-direction: column;
        padding: 0;
        overflow: hidden;
    }
    
    .page-title {
        color: #1f2937;
        margin-bottom: 2rem;
        font-size: 2.25rem;
        font-weight: 800;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .page-title .text-gray-500 {
        font-size: 1.25rem;
        margin-left: 0.5rem;
        font-weight: 600;
        text-transform: none;
        letter-spacing: normal;
    }
    /* ===== Lưới 2 cột cho session layout (chuyển thành 1 cột trên mobile) ===== */
    .session-layout {
        height: 100%;
        display: grid;
        grid-template-columns: minmax(0, 5fr) minmax(320px, 2fr);
        gap: 2rem;
        max-width: 1680px;
        margin: 0 auto;
        padding: 1.5rem 2rem 1.5rem 2rem;
        align-items: stretch;
        min-height: 0;
        flex-grow: 1;
    }
    
    @media (max-width: 1024px) {
        /* Bố cục trên màn hình di động */
        .page-shell {
            top: var(--header-h, 0px);
            bottom: 0;
            padding: 0;
        }
        .session-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 0;
            overflow: hidden; /* Quan trọng: Loại bỏ cuộn trên layout chính */
        }
        .statistics-card {
            display: none !important;
        }
        .flashcard-wrapper {
            flex: 1; /* Chiếm hết không gian còn lại */
            padding: 0.5rem; /* Giảm padding để thẻ tràn viền hơn */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #flashcard-content {
            flex: 1;
            padding-bottom: 0.5rem; /* Thêm padding dưới để nút không bị dính */
        }
        .flashcard-card-container, .flashcard-card, .face {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Căn trên và dưới */
        }
        .text-area {
            flex: 1;
        }
        .actions {
            margin-top: 1rem !important;
            padding-top: 0;
        }
        .flashcard-card {
            padding: 0.5rem; /* Giảm padding trên thẻ flashcard */
        }
    }

    /* ===== Wrapper cho thẻ Flashcard ===== */
    .flashcard-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
    }

    #flashcard-content {
        flex: 1 1 auto;
        min-height: 0;
    }

    /* ===== Thẻ: Flip 3D (xoay TOÀN BỘ thẻ) ===== */
    .flashcard-card-container {
        perspective: 1200px;
        -webkit-perspective: 1200px;
        width: 100%;
        height: 100%;
        min-height: 300px;
    }

    .flashcard-card {
        width: 100%;
        height: 100%;
        position: relative;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
        overflow: hidden;
        transform-style: preserve-3d;
        -webkit-transform-style: preserve-3d;
        cursor: pointer;
    }
    
    .face {
        position: absolute;
        inset: 0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 10px;
        min-height: 0;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transition: transform .6s ease-in-out;
    }
    
    /* Đảm bảo mặt trước hiển thị đúng chiều ở trạng thái bình thường */
    .front { 
        transform: rotateY(0deg); 
        text-align: center; 
    }
    
    /* Đảm bảo mặt sau bị lật ở trạng thái bình thường để ẩn đi */
    .back { 
        transform: rotateY(180deg);
    }
    
    /* Khi lật thẻ, mặt trước sẽ bị xoay và mặt sau sẽ được xoay về đúng chiều */
    .flashcard-card.flipped .front {
        transform: rotateY(180deg);
    }
    
    .flashcard-card.flipped .back {
        transform: rotateY(360deg);
    }
    
    /* Thanh tiêu đề của thẻ */
    .card-toolbar {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        margin-bottom: .25rem;
    }

    .card-toolbar .label {
        text-transform: uppercase;
        text-align: center;
        font-weight: 700;
        color: #6b7280;
        letter-spacing: .06em;
    }

    /* Nội dung text (căn dọc giữa) */
    .text-area {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
        display: flex;
        align-items: center;
    }

    .text-area > .flashcard-content-text {
        width: 100%;
    }

    .front .text-area .flashcard-content-text {
        text-align: center;
        font-size: 2.2rem;
        font-weight: 700;
        color: #1f2937;
    }

    .back .text-area .flashcard-content-text {
        text-align: left;
        font-size: 22px;
        line-height: 1.5;
        color: #111827;
        white-space: pre-wrap;
    }

    /* Ảnh/Âm thanh đáy thẻ (có nút ×) */
    .media-container {
        flex: 0 0 auto;
        max-height: 40vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-top: 1px solid #e5e7eb;
        padding: 10px;
        position: relative;
    }

    .media-container.hidden {
        display: none;
    }

    .media-container img, .media-container audio {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
    }

    .media-close {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(0, 0, 0, .55);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        font-size: 16px;
        line-height: 28px;
        text-align: center;
        cursor: pointer;
    }

    /* Nút đánh giá trong thẻ */
    .actions {
        display: none;
        gap: .75rem;
        justify-content: center;
        margin-top: .6rem;
    }

    .actions.visible {
        display: flex;
    }

    .btn {
        border: none;
        color: #fff;
        font-weight: 700;
        padding: .75rem 1.2rem;
        border-radius: 9999px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, .06);
        cursor: pointer;
    }

    .btn-quên { background: #ef4444; }
    .btn-mơ-hồ { background: #f59e0b; }
    .btn-nhớ { background: #10b981; }

    /* Ẩn cụm nút ngoài (đã move vào thẻ) */
    #flashcard-buttons {
        display: none !important;
    }

    /* Thống kê */
    @media (min-width: 1024px) {
        .statistics-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }
    }
    
    /* Custom Modal */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .custom-modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 400px;
    }
    /* Styles cho Progress Bar */
    .statistics-card-new {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .progress-bar-group {
      margin-bottom: 1rem;
    }

    .progress-bar-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .progress-bar-container {
      width: 100%;
      background-color: #e5e7eb;
      border-radius: 9999px;
      overflow: hidden;
      height: 1.25rem;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      transition: width 0.5s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      white-space: nowrap;
    }

    .progress-bar-fill-correct { background-color: #10b981; }
    .progress-bar-fill-vague { background-color: #f59e0b; }
    .progress-bar-fill-incorrect { background-color: #ef4444; }

    /* Điều chỉnh font size cho nội dung thẻ trên mobile */
    @media (max-width: 640px) {
        .front .text-area .flashcard-content-text {
            font-size: 1.8rem;
        }
        .back .text-area .flashcard-content-text {
            font-size: 18px;
        }
        .session-layout {
            padding: 0.5rem;
        }
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="session-layout">
    <div class="flashcard-wrapper">
      <div id="flashcard-content">
        <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>
      </div>
      <div id="flashcard-buttons" class="mt-3"></div>
    </div>

    <div class="statistics-card">
        <h3 class="text-lg font-semibold text-center text-gray-800 mb-4">Thống kê phiên học</h3>
        
        <div class="progress-bar-group">
            <div class="progress-bar-label">
                <span>Tổng số thẻ đã học</span>
                <span id="session-total-answered-label">0</span>
            </div>
            <div class="progress-bar-container">
                <div id="session-total-answered-bar" class="progress-bar-fill"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-3">
            <div class="progress-bar-group">
                <div class="progress-bar-label">
                    <span>Thẻ Nhớ</span>
                    <span id="session-correct-count-label">0</span>
                </div>
                <div class="progress-bar-container">
                    <div id="session-correct-bar" class="progress-bar-fill progress-bar-fill-correct"></div>
                </div>
            </div>
            <div class="progress-bar-group">
                <div class="progress-bar-label">
                    <span>Thẻ Mơ hồ</span>
                    <span id="session-vague-count-label">0</span>
                </div>
                <div class="progress-bar-container">
                    <div id="session-vague-bar" class="progress-bar-fill progress-bar-fill-vague"></div>
                </div>
            </div>
            <div class="progress-bar-group">
                <div class="progress-bar-label">
                    <span>Thẻ Quên</span>
                    <span id="session-incorrect-count-label">0</span>
                </div>
                <div class="progress-bar-container">
                    <div id="session-incorrect-bar" class="progress-bar-fill progress-bar-fill-incorrect"></div>
                </div>
            </div>
        </div>

        <hr class="my-6">
        <h3 class="text-lg font-semibold text-center text-gray-800 mb-4">Thống kê thẻ hiện tại</h3>
        <div id="current-card-stats" class="flex-grow space-y-4">
            <div class="text-center text-gray-500">
                <i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.
            </div>
        </div>

        <hr class="my-6">
        <div class="mt-2 flex justify-center">
            <button id="end-session-btn" class="px-6 py-3 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 shadow-sm">Kết thúc phiên</button>
        </div>
    </div>
  </div>
</div>

<div id="endSessionModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <p class="text-lg font-semibold text-gray-800 mb-4">Bạn có chắc chắn muốn kết thúc phiên học hiện tại?</p>
    <p class="text-sm text-gray-600 mb-6">Tiến độ của thẻ chưa trả lời sẽ không được lưu.</p>
    <div class="flex justify-center space-x-4">
      <button id="confirmEndSessionBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Kết thúc</button>
      <button id="cancelEndSessionBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Hủy bỏ</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    /* ===== Tính chiều cao header/footer/title để layout full-height ===== */
    function updateFixedHeights(){
      const header=document.querySelector('header');
      const mainElement = document.querySelector('main');
      const footer=document.querySelector('footer');
      const hh=header?header.offsetHeight:0;
      const fh=footer?footer.offsetHeight:0;

      // Cập nhật biến CSS để main content có thể tính toán chiều cao
      document.documentElement.style.setProperty('--header-h', hh+'px');
      document.documentElement.style.setProperty('--footer-h', fh+'px');
    }
    window.addEventListener('load', updateFixedHeights);
    window.addEventListener('resize', updateFixedHeights);
    new ResizeObserver(updateFixedHeights).observe(document.body);

    /* ===== State ===== */
    let currentFlashcardBatch = [];
    let currentFlashcardIndex = 0;

    const flashcardContentDiv = document.getElementById('flashcard-content');
    const endSessionBtn = document.getElementById('end-session-btn');
    const sessionTotalAnsweredLabel = document.getElementById('session-total-answered-label');
    const sessionTotalAnsweredBar = document.getElementById('session-total-answered-bar');
    const sessionCorrectCountLabel = document.getElementById('session-correct-count-label');
    const sessionCorrectBar = document.getElementById('session-correct-bar');
    const sessionIncorrectCountLabel = document.getElementById('session-incorrect-count-label');
    const sessionIncorrectBar = document.getElementById('session-incorrect-bar');
    const sessionVagueCountLabel = document.getElementById('session-vague-count-label');
    const sessionVagueBar = document.getElementById('session-vague-bar');
    const currentCardStatsDiv = document.getElementById('current-card-stats');

    const endSessionModal = document.getElementById('endSessionModal');
    const confirmEndSessionBtn = document.getElementById('confirmEndSessionBtn');
    const cancelEndSessionBtn = document.getElementById('cancelEndSessionBtn');

    const getFlashcardBatchUrl = "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}";
    const submitAnswerUrl = "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}";
    const endSessionUrl = "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}";

    function formatTextForHtml(text){
      if (text == null) return '';
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML.replace(/\r?\n/g,'<br>');
    }

    /**
     * Cập nhật hiển thị thống kê phiên học với các thanh tiến trình mới.
     * @param {number} correct - Số câu trả lời đúng.
     * @param {number} incorrect - Số câu trả lời sai.
     * @param {number} vague - Số câu trả lời mập mờ.
     * @param {number} total - Tổng số thẻ đã trả lời.
     */
    function updateSessionSummary(correct, incorrect, vague, total){
      // Chỉnh sửa để tìm các ID mới
      const totalAnsweredLabel = document.getElementById('session-total-answered-label');
      if (totalAnsweredLabel) totalAnsweredLabel.textContent = `${total}`;
      
      const correctCountLabel = document.getElementById('session-correct-count-label');
      if (correctCountLabel) correctCountLabel.textContent = `${correct}`;
      
      const incorrectCountLabel = document.getElementById('session-incorrect-count-label');
      if (incorrectCountLabel) incorrectCountLabel.textContent = `${incorrect}`;

      const vagueCountLabel = document.getElementById('session-vague-count-label');
      if (vagueCountLabel) vagueCountLabel.textContent = `${vague}`;
      

      const correctPct = total > 0 ? (correct / total) * 100 : 0;
      const incorrectPct = total > 0 ? (incorrect / total) * 100 : 0;
      const vaguePct = total > 0 ? (vague / total) * 100 : 0;
      
      // Chỉnh sửa để tìm các ID mới
      const correctBar = document.getElementById('session-correct-bar');
      if (correctBar) {
          correctBar.style.width = `${correctPct}%`;
          correctBar.textContent = correct > 0 ? `${Math.round(correctPct)}%` : '';
      }
      
      const incorrectBar = document.getElementById('session-incorrect-bar');
      if (incorrectBar) {
          incorrectBar.style.width = `${incorrectPct}%`;
          incorrectBar.textContent = incorrect > 0 ? `${Math.round(incorrectPct)}%` : '';
      }

      const vagueBar = document.getElementById('session-vague-bar');
      if (vagueBar) {
          vagueBar.style.width = `${vaguePct}%`;
          vagueBar.textContent = vague > 0 ? `${Math.round(vaguePct)}%` : '';
      }
      
      const totalAnsweredBar = document.getElementById('session-total-answered-bar');
      if (totalAnsweredBar) {
          totalAnsweredBar.style.width = `${100}%`;
          totalAnsweredBar.textContent = total > 0 ? 'Phiên học đang diễn ra...' : '';
      }
    }

    function adjustFontSize(){
      const scrollArea = document.querySelector('.back .text-area');
      const txt = document.querySelector('.back .flashcard-content-text');
      const card = document.getElementById('flashcard-card');
      if (!scrollArea || !txt || !card) return;
      txt.style.fontSize = '';
      const isOverflow = () => scrollArea.scrollHeight > scrollArea.clientHeight;
      let current = parseFloat(getComputedStyle(txt).fontSize) || 22;
      const min = 18;
      while (isOverflow() && current > min) {
        current -= 1;
        txt.style.fontSize = current + 'px';
      }
    }

    function renderCard(data){
      const c = data.content;
      const fTxt = c.front || 'Không có nội dung';
      const bTxt = c.back || 'Không có nội dung';
      const fImg = c.front_img ? `<img src="${c.front_img}" alt="Mặt trước" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';">` : '';
      const bImg = c.back_img ? `<img src="${c.back_img}" alt="Mặt sau" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';">` : '';
      const fAud = c.front_audio_url ? `<audio controls src="${c.front_audio_url}" class="w-full mt-2" onerror="this.outerHTML='<p class=\\'text-red-500\\'>Lỗi âm thanh</p>'"></audio>` : '';
      const bAud = c.back_audio_url ? `<audio controls src="${c.back_audio_url}" class="w-full mt-2" onerror="this.outerHTML='<p class=\\'text-red-500\\'>Lỗi âm thanh</p>'"></audio>` : '';

      const html = `
      <div class="flashcard-card-container">
        <div id="flashcard-card" class="flashcard-card">
          <div class="face front">
            <div class="card-toolbar"><span></span><span class="label">MẶT TRƯỚC</span><span></span></div>
            <div class="text-area">
              <div class="flashcard-content-text">${formatTextForHtml(fTxt)}</div>
            </div>
            <div class="media-container ${(fImg||fAud)?'':'hidden'}" id="front-media">${fImg}${fAud}<button class="media-close" data-target="front-media">×</button></div>
          </div>
          <div class="face back">
            <div class="card-toolbar"><span></span><span class="label">MẶT SAU</span><span></span></div>
            <div class="text-area">
              <div class="flashcard-content-text">${formatTextForHtml(bTxt)}</div>
            </div>
            <div class="media-container ${(bImg||bAud)?'':'hidden'}" id="back-media">${bImg}${bAud}<button class="media-close" data-target="back-media">×</button></div>
            <div class="actions" id="internal-actions">
              <button class="btn btn-quên" data-answer="quên">Quên</button>
              <button class="btn btn-mơ-hồ" data-answer="mơ_hồ">Mơ hồ</button>
              <button class="btn btn-nhớ" data-answer="nhớ">Nhớ</button>
            </div>
          </div>
        </div>
      </div>`;

      flashcardContentDiv.innerHTML = html;

      const card = document.getElementById('flashcard-card');
      const actions = document.getElementById('internal-actions');
      card.addEventListener('click', () => {
        card.classList.toggle('flipped');
        if (card.classList.contains('flipped')) {
            actions?.classList.add('visible');
        } else {
            actions?.classList.remove('visible');
        }
        setTimeout(adjustFontSize, 0);
      });

      document.querySelectorAll('.btn').forEach(b => b.addEventListener('click', ev => {
        ev.stopPropagation();
        submitFlashcardAnswer(data.item_id, b.dataset.answer);
      }));
      
      document.querySelectorAll('.media-close').forEach(btn => btn.addEventListener('click', ev => {
        ev.stopPropagation();
        const id = btn.dataset.target;
        document.getElementById(id)?.classList.add('hidden');
        setTimeout(adjustFontSize, 200);
      }));
      setTimeout(adjustFontSize, 0);
    }

    /**
     * @param {object} stats - Các số liệu thống kê của thẻ.
     * @param {number} scoreChange - Điểm số thay đổi trong lần này.
     */
    function renderCardStats(stats, scoreChange) {
        if (!stats) {
            currentCardStatsDiv.innerHTML = `<div class="text-center text-gray-500"><i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.</div>`;
            return;
        }
        
        const totalReviews = stats.total_reviews || 0;
        const correctCount = stats.times_correct || 0;
        const incorrectCount = stats.times_incorrect || 0;
        const vagueCount = stats.times_vague || 0;
        const correctPercentage = totalReviews > 0 ? (correctCount / totalReviews * 100) : 0;
        const incorrectPercentage = totalReviews > 0 ? (incorrectCount / totalReviews * 100) : 0;
        const vaguePercentage = totalReviews > 0 ? (vagueCount / totalReviews * 100) : 0;

        const dueTime = stats.due_time ? new Date(stats.due_time).toLocaleString('vi-VN', { dateStyle: 'medium', timeStyle: 'short' }) : 'Chưa có';
        
        const scoreChangeColor = scoreChange > 0 ? 'text-green-600' : (scoreChange < 0 ? 'text-red-600' : 'text-gray-600');
        const scoreChangeSign = scoreChange > 0 ? '+' : '';

        let statsHtml = `
            <div class="space-y-4">
                <div class="progress-bar-group">
                    <div class="progress-bar-label">
                        <span>Nhớ (${correctCount})</span>
                        <span>${Math.round(correctPercentage)}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill progress-bar-fill-correct" style="width: ${correctPercentage}%;"></div>
                    </div>
                </div>
                <div class="progress-bar-group">
                    <div class="progress-bar-label">
                        <span>Mơ hồ (${vagueCount})</span>
                        <span>${Math.round(vaguePercentage)}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill progress-bar-fill-vague" style="width: ${vaguePercentage}%;"></div>
                    </div>
                </div>
                <div class="progress-bar-group">
                    <div class="progress-bar-label">
                        <span>Quên (${incorrectCount})</span>
                        <span>${Math.round(incorrectPercentage)}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill progress-bar-fill-incorrect" style="width: ${incorrectPercentage}%;"></div>
                    </div>
                </div>
            </div>

            <div class="mt-4 space-y-2">
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Điểm:</span>
                    <span class="font-semibold text-right ${scoreChangeColor}">${scoreChangeSign}${scoreChange}</span>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Trạng thái:</span>
                    <span class="font-semibold text-right">${stats.status}</span>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Lần cuối ôn:</span>
                    <span class="font-semibold text-right">${new Date(stats.last_reviewed).toLocaleString('vi-VN', { dateStyle: 'medium', timeStyle: 'short' })}</span>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Đến hạn ôn lại:</span>
                    <span class="font-semibold text-right">${dueTime}</span>
                </div>
            </div>
        `;

        currentCardStatsDiv.innerHTML = statsHtml;
    }

    async function getNextFlashcardBatch(){
      flashcardContentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>`;
      currentCardStatsDiv.innerHTML = `<div class="text-center text-gray-500"><i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.</div>`;

      try {
        const res = await fetch(getFlashcardBatchUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
        if (!res.ok) {
          if (res.status === 404) {
            const end = await res.json();
            flashcardContentDiv.innerHTML = `
              <div class="text-center py-12 text-gray-600">
                <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Hoàn thành phiên học!</h3>
                <p class="text-gray-500">${formatTextForHtml(end.message)}</p>
                <button id="return-to-dashboard-btn" class="mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-sm">
                  <i class="fas fa-home mr-2"></i> Quay lại Dashboard
                </button>
              </div>`;
            document.getElementById('return-to-dashboard-btn').addEventListener('click', () => {
              window.location.href = "{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}";
            });
            return;
          }
          throw new Error('HTTP ' + res.status);
        }
        const batch = await res.json();
        currentFlashcardBatch = batch.items;
        currentFlashcardIndex = 0;
        renderCard(currentFlashcardBatch[currentFlashcardIndex]);
        updateSessionSummary(batch.session_correct_answers, batch.session_incorrect_answers, batch.session_vague_answers, batch.session_total_answered);
      } catch (e) {
        console.error('Lỗi khi tải nhóm thẻ:', e);
        flashcardContentDiv.innerHTML = `<p class='text-red-500 text-center'>Không thể tải thẻ. Vui lòng thử lại.</p>`;
      }
    }

    async function submitFlashcardAnswer(itemId, answer){
      try {
        const res = await fetch(submitAnswerUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ item_id: itemId, user_answer: answer })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        updateSessionSummary(data.session_correct_answers, data.session_incorrect_answers, data.session_vague_answers, data.session_total_answered);
        
        // Hiển thị thống kê cho thẻ vừa trả lời
        if (data.statistics) {
            renderCardStats(data.statistics, data.score_change);
        }

        setTimeout(() => {
          currentFlashcardIndex++;
          getNextFlashcardBatch();
        }, 900);
      } catch (e) {
        console.error('Lỗi khi gửi đáp án:', e);
        showCustomAlert('Có lỗi khi gửi đáp án. Vui lòng thử lại.');
      }
    }

    // Custom Modal for End Session
    endSessionBtn.addEventListener('click', () => {
      endSessionModal.style.display = 'flex';
    });

    confirmEndSessionBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(endSessionUrl, { method: 'POST' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const r = await res.json();
        window.showFlashMessage(r.message || 'Đã kết thúc phiên.', 'info');
        window.location.href = "{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}";
      } catch (e) {
        window.showFlashMessage('Có lỗi xảy ra khi kết thúc phiên.', 'danger');
      } finally {
        endSessionModal.style.display = 'none';
      }
    });

    cancelEndSessionBtn.addEventListener('click', () => {
      endSessionModal.style.display = 'none';
    });

    // Custom Alert Function
    function showCustomAlert(message) {
      const modalHtml = `
          <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
              <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                  <p class="text-lg font-semibold text-gray-800 mb-4">${formatTextForHtml(message)}</p>
                  <button id="custom-alert-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">OK</button>
              </div>
          </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.getElementById('custom-alert-ok-btn').addEventListener('click', () => {
          document.getElementById('custom-alert-modal').remove();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateFixedHeights();
      getNextFlashcardBatch();
    });
  </script>
{% endblock %}