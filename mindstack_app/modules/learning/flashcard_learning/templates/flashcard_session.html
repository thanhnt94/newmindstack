{#
    # File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html
    # Phiên bản: 69.1
    # MỤC ĐÍCH: Thay đổi vị trí nút Feedback.
    # ĐÃ SỬA: Di chuyển nút Feedback từ toolbar bên trái sang bên phải, đặt cạnh nút Sửa thẻ.
#}

{% extends "base.html" %}
{% from 'includes/_navbar.html' import render_navbar %}
{% block title %}Học Flashcard{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    /* ===== CSS tùy chỉnh mới cho Flashcard Session ===== */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f9fafb;
    }

    /* Ghi đè CSS từ base.html để ẩn footer chỉ trên trang này khi ở màn hình nhỏ */
    @media (max-width: 1024px) {
        body > footer {
            display: none !important;
        }
    }

    /* ===== Layout toàn trang (full height) - ĐÃ CẬP NHẬT ===== */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        /* THAY ĐỔI: Thêm overflow: hidden để ngăn cuộn toàn trang */
        overflow: hidden;
    }

    .page-shell {
        display: flex;
        flex-direction: column;
        height: calc(var(--vh, 1vh) * 100);
        padding: 0;
        overflow: hidden;
    }

    .page-title {
        color: #1f2937;
        margin-bottom: 2rem;
        font-size: 2.25rem;
        font-weight: 800;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .page-title .text-gray-500 {
        font-size: 1.25rem;
        margin-left: 0.5rem;
        font-weight: 600;
        text-transform: none;
        letter-spacing: normal;
    }
    /* ===== Lưới 2 cột cho session layout (chuyển thành 1 cột trên mobile) ===== */
    .session-layout {
        height: 100%;
        display: grid;
        grid-template-columns: minmax(0, 5fr) minmax(400px, 2fr);
        gap: 2rem;
        max-width: 1680px;
        margin: 0 auto;
        padding: 1.5rem 2rem 1.5rem 2rem;
        align-items: stretch;
        min-height: 0;
        flex-grow: 1;
        /* THAY ĐỔI: Cố định layout */
        overflow: hidden;
    }

    @media (max-width: 1024px) {
        /* Bố cục trên màn màn hình di động */
        .page-shell {
            top: var(--header-h, 0px);
            bottom: 0;
            padding: 0;
        }
        .session-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 0 !important;
            overflow: hidden; /* Quan trọng: Loại bỏ cuộn trên layout chính */
        }
        .stats-modal-body .statistics-card { display:block !important; }

        .session-layout > .statistics-card {
            display: none !important;
        }
        .flashcard-wrapper {
            flex: 1; /* Chiếm hết không gian còn lại */
            padding: 0 !important;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #flashcard-content {
            flex: 1;
            padding: 0.5rem; /* Thêm padding nhẹ để nội dung không bị sát viền */
        }
        .flashcard-card-container, .flashcard-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Căn trên và dưới */
        }
        .face {
            /* SỬA LỖI 2: Đảm bảo có đủ padding cho thanh toolbar trên di động */
            padding: 60px 0.5rem 0.5rem 0.5rem !important;
        }
        ._card-container {
            /* THÊM MỚI: Tối ưu layout nội dung trên mobile */
            padding: 0.2rem !important;
        }
        .text-area {
            flex: 1;
        }
        .actions {
            margin-top: 0.5rem !important;
            padding: 0.5rem !important;
            gap: 0rem;
            justify-content: center;
            width: 100%;
        }
        .flashcard-card {
            padding: 0.2rem !important;
        }
    }

    /* ===== Wrapper cho thẻ Flashcard ===== */
    .flashcard-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
        position: relative;
        overflow: hidden;
    }

    #flashcard-content {
        flex: 1 1 auto;
        min-height: 0;
    }

    /* ===== Thẻ: Flip 3D (xoay TOÀN BỘ thẻ) ===== */
    .flashcard-card-container {
        perspective: 1200px;
        -webkit-perspective: 1200px;
        width: 100%;
        height: 100%;
        min-height: 300px;
    }

    .flashcard-card {
        width: 100%;
        height: 100%;
        position: relative;
        background: #fff;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        overflow: hidden;
        transform-style: preserve-3d;
        -webkit-transform-style: preserve-3d;
        transition: box-shadow .3s ease, border-color .3s ease;
    }

    .flashcard-card.flashcard-card--new {
        border-color: #22c55e;
        box-shadow: 0 12px 32px rgba(34, 197, 94, 0.25);
    }

    .flashcard-card.flashcard-card--due {
        border-color: #f97316;
        box-shadow: 0 12px 32px rgba(249, 115, 22, 0.25);
    }

    .flashcard-card.flashcard-card--hard {
        border-color: #ef4444;
        box-shadow: 0 12px 32px rgba(239, 68, 68, 0.28);
    }

    .face {
        position: absolute;
        inset: 0;
        /* ĐÃ SỬA: Tăng padding-top để tạo khoảng trống an toàn cho toolbar */
        padding: 60px 1.5rem 1.5rem 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 10px;
        min-height: 0;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transition: transform .6s ease-in-out;
    }

    .front {
        transform: rotateY(0deg);
    }

    .back {
        transform: rotateY(180deg);
    }

    .flashcard-card.flipped .front {
        transform: rotateY(180deg);
    }

    .flashcard-card.flipped .back {
        transform: rotateY(360deg);
    }

    .card-toolbar {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 10px 1rem 0.5rem 1rem;
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        z-index: 10;
    }

    .toolbar-left, .toolbar-right {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .toolbar-right {
        justify-content: flex-end;
    }

    .card-toolbar .label {
        text-transform: uppercase;
        text-align: center;
        font-weight: 600;
        color: #6b7280;
        letter-spacing: .06em;
        font-size: 1rem;
    }

    .card-toolbar .icon-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: transparent;
        color: #9ca3af;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        cursor: pointer;
        transition: color 0.2s ease, background-color 0.2s ease;
    }

    .card-toolbar .icon-btn:hover {
        background-color: #f3f4f6;
        color: #3b82f6;
    }
    .card-toolbar .icon-btn.is-active {
        color: #3b82f6;
    }
    .card-toolbar .icon-btn.is-disabled {
        background-color: transparent;
        color: #9ca3af;
        cursor: not-allowed;
    }

    .card-toolbar .play-audio-btn {
        background-color: #2563eb;
        color: #ffffff;
        width: 36px;
        height: 36px;
        font-size: 1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer;
    }

    .card-toolbar .play-audio-btn:hover {
        background-color: #1d4ed8;
        color: #ffffff;
    }
    .card-toolbar .play-audio-btn.is-disabled {
        background-color: #9ca3af;
        color: #e5e7eb;
        cursor: not-allowed;
    }

    /* Cấu trúc mới cho nội dung thẻ */
    ._card-container {
        justify-content: flex-start;
        align-items: stretch;
        flex: 1 1 auto;
        min-height: 0;
        padding: 0 1rem;
        margin-top: 0;
        display: flex;
        flex-direction: column;
    }

    .text-area {
        flex-grow: 1;
        min-height: 0;
        width: 100%;
        overflow-y: auto;
        padding: 1rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Ghi đè lại text-align cho mặt sau để căn trái khi có nhiều dòng */
    .back .text-area .flashcard-content-text {
        text-align: left;
    }
    
    /* THÊM MỚI: CSS cho trạng thái có cuộn */
    .text-area.has-scroll {
        justify-content: flex-start;
        align-items: flex-start;
    }
    
    .front .text-area .flashcard-content-text {
        font-size: 2.2rem;
        font-weight: 700;
        color: #1f2937;
    }

    .back .text-area .flashcard-content-text {
        font-size: 22px;
        line-height: 1.5;
        color: #111827;
        white-space: pre-wrap;
    }
    
    .media-container {
        flex-shrink: 0;
        padding-top: 1rem;
        padding-bottom: 1rem;
        width: 100%;
        text-align: center;
        position: relative;
        max-height: 33%;
        overflow: hidden;
    }
    
    .media-container.hidden {
        display: none;
    }
    
    .media-container img {
        max-width: 100%;
        height: auto;
        max-height: 100%;
        object-fit: contain;
        display: block;
        margin: auto;
    }

    .close-media-btn {
        position: absolute;
        top: 0;
        right: 0;
        width: 2rem;
        height: 2rem;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .close-media-btn:hover {
        background-color: rgba(0, 0, 0, 0.7);
        transform: scale(1.1);
    }


    /* Nút đánh giá trong thẻ */
    .actions {
        display: none;
        gap: .75rem;
        justify-content: center;
        padding: 1rem 1.5rem;
        position: relative;
        width: 100%;
        bottom: 0;
        left: 0;
        background: #fff;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0;
    }

    .actions.visible {
        display: flex;
    }

    .btn {
        border: none;
        color: #fff;
        font-weight: 700;
        padding: .75rem 1.2rem;
        border-radius: 9999px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, .06);
        cursor: pointer;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        transition: transform .2s ease, box-shadow .2s ease;
        flex-grow: 1;
        flex-shrink: 1;
        flex-basis: 0;
        white-space: nowrap;
    }

    .btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
    }

    .btn-continue {
        background: linear-gradient(135deg, #2563eb, #16a34a);
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
    }

    .btn-continue:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(37, 99, 235, 0.3);
    }

    .btn-red-dark { background-color: #dc2626; }
    .btn-red-light { background-color: #ef4444; }
    .btn-yellow-dark { background-color: #f59e0b; }
    .btn-yellow-light { background-color: #facc15; }
    .btn-green-light { background-color: #10b981; }
    .btn-green-dark { background-color: #059669; }

    .actions[data-button-count="1"] {
        display: flex !important;
        justify-content: center;
    }

    .actions[data-button-count="1"] .btn {
        flex-basis: auto;
        flex-grow: 0;
        min-width: 180px;
        padding-left: 2rem;
        padding-right: 2rem;
    }

    @media (max-width: 768px) {
        .btn {
            font-size: 0.8rem;
            padding: 0.6rem 0.8rem;
        }
        .actions[data-button-count="3"] {
            display: flex !important;
            flex-wrap: nowrap;
            justify-content: space-around;
        }
        .actions[data-button-count="4"] {
            display: flex !important;
            flex-wrap: nowrap;
            justify-content: space-around;
        }
        .actions[data-button-count="6"] {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        .actions[data-button-count="1"] {
            display: flex !important;
            justify-content: center;
        }
        .actions[data-button-count="1"] .btn {
            min-width: 140px;
        }
    }

    #flashcard-buttons {
        display: none !important;
    }
    
    .flip-card-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        background-color: #3b82f6;
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    .flip-card-btn:hover {
        background-color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 6px 10px -1px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }


    @media (min-width: 1024px) {
        .statistics-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            overflow-y: auto;
            width: 500px;
        }
    }

    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .custom-modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 400px;
    }

    .stats-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        z-index: 999;
        overflow-y: auto;
    }
    .stats-modal-overlay.open {
        display: block;
    }
    .stats-modal-content {
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background-color: #f9fafb;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: -4px 0 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }
    .stats-modal-content.open {
        transform: translateX(0);
    }

    .stats-modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #fff;
    }

    .stats-modal-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
    }

    .stats-modal-close-btn {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #6b7280;
    }

    .stats-modal-body {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
    }

    .card-info-section {
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
        margin-top: 1.5rem;
    }
    .card-info-title {
        display: flex;
        align-items: center;
        font-weight: 600;
        color: #3b82f6;
        cursor: pointer;
        user-select: none;
        margin-bottom: 0.5rem;
    }
    .card-info-title i {
        margin-right: 0.5rem;
        transition: transform 0.2s ease;
    }
    .card-info-title.collapsed i {
        transform: rotate(-90deg);
    }
    .card-info-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .card-info-content.open {
        max-height: 500px;
        padding-top: 0.5rem;
    }
    .card-info-content p {
        font-size: 0.875rem;
        line-height: 1.4;
        color: #4b5563;
        margin-bottom: 0.5rem;
        white-space: pre-wrap;
    }
    .card-info-content .label {
        font-weight: 600;
        color: #1f2937;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }
    .stat-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background-color: #f9fafb;
    }
    .stat-box .icon {
        font-size: 1.5rem;
        color: #3b82f6;
        margin-bottom: 0.5rem;
    }
    .stat-box .value {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
    }
    .stat-box.status .value {
        text-transform: capitalize;
    }

    .flashcard-status-banner {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .flashcard-status-banner i {
        font-size: 1rem;
    }

    .flashcard-status-banner--new {
        background: rgba(34, 197, 94, 0.12);
        border: 1px solid rgba(34, 197, 94, 0.35);
        color: #047857;
    }

    .flashcard-status-banner--preview {
        background: rgba(37, 99, 235, 0.12);
        border: 1px solid rgba(37, 99, 235, 0.35);
        color: #1d4ed8;
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="session-layout">
    <div class="flashcard-wrapper">
      <div id="flashcard-content">
        <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>
      </div>
      <div id="flashcard-buttons" class="mt-3"></div>
      
      {# Nhúng bảng ghi chú #}
      {% include 'notes/_note_panel.html' %}
    </div>

    {# Bao gồm file partial chứa giao diện thống kê #}
    {% include '_flashcard_session_stats.html' %}
  </div>
</div>

<div id="endSessionModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <p class="text-lg font-semibold text-gray-800 mb-4">Bạn có chắc chắn muốn kết thúc phiên học hiện tại?</p>
    <p class="text-sm text-gray-600 mb-6">Tiến độ của thẻ chưa trả lời sẽ không được lưu.</p>
    <div class="flex justify-center space-x-4">
      <button id="confirmEndSessionBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Kết thúc</button>
      <button id="cancelEndSessionBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Hủy bỏ</button>
    </div>
  </div>
</div>

<div id="statsModal" class="stats-modal-overlay">
    <div id="statsModalContent" class="stats-modal-content">
        <header class="bg-white shadow-md">
            {{ render_navbar(current_user, request) }}
        </header>
        <div class="stats-modal-header">
            <h3>Thống kê phiên học</h3>
            <button id="closeStatsModalBtn" class="stats-modal-close-btn">&times;</button>
        </div>
        <div id="statsModalBody" class="stats-modal-body">
            {# Nội dung thống kê sẽ được render vào đây #}
        </div>
    </div>
</div>

{# Nhúng modal AI #}
{% include 'ai_services/_ai_modal.html' %}

{# Nhúng modal Feedback #}
{% include 'feedback/_feedback_modal.html' %}

{% endblock %}

{% block scripts %}
  {{ super() }}
  
  <script>
    function setVh() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', setVh);
    window.addEventListener('DOMContentLoaded', setVh);

    let currentFlashcardBatch = [];
    let currentFlashcardIndex = 0;
    let previousCardStats = null; 

    let sessionScore = 0;
    let currentUserTotalScore = {{ current_user.total_score | default(0) }};

    const flashcardContentDiv = document.getElementById('flashcard-content');
    const endSessionBtn = document.getElementById('end-session-btn');
    
    const currentCardStatsContainer = document.getElementById('current-card-stats');
    const previousCardStatsContainer = document.getElementById('previous-card-stats');

    const endSessionModal = document.getElementById('endSessionModal');
    const confirmEndSessionBtn = document.getElementById('confirmEndSessionBtn');
    const cancelEndSessionBtn = document.getElementById('cancelEndSessionBtn');
    
    const statsModal = document.getElementById('statsModal');
    const statsModalContent = document.getElementById('statsModalContent');
    const closeStatsModalBtn = document.getElementById('closeStatsModalBtn');
    const statsModalBody = document.getElementById('statsModalBody');

    const getFlashcardBatchUrl = "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}";
    const submitAnswerUrl = "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}";
    const endSessionUrl = "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}";
    const regenerateAudioUrl = "{{ url_for('learning.flashcard_learning.regenerate_audio_from_content') }}";
    const userButtonCount = {{ user_button_count }};
    
    const getNoteUrl = "{{ url_for('notes.get_note', item_id=0) }}";
    const saveNoteUrl = "{{ url_for('notes.save_note', item_id=0) }}";

    function formatTextForHtml(text){
      if (text == null) return '';
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML.replace(/\r?\n/g,'<br>');
    }

    function shouldShowPreviewOnly(initialStats = {}) {
      const hasRealReviews = Boolean(initialStats.has_real_reviews);
      if (hasRealReviews) return false;

      const previewCount = initialStats.preview_count ?? 0;
      const hasPreviewHistory = Boolean(initialStats.has_preview_history);

      if (hasPreviewHistory && previewCount > 0) {
        return false;
      }

      return previewCount === 0;
    }

    function determineCardCategory(cardData) {
      if (!cardData) return '';

      const stats = cardData.initial_stats || {};
      const hasPreviewHistory = Boolean(stats.has_preview_history);
      const hasRealReviews = Boolean(stats.has_real_reviews);

      if (!hasPreviewHistory && !hasRealReviews) {
        return 'new';
      }

      if (stats.status === 'hard') {
        return 'hard';
      }

      if (stats.has_preview_only) {
        return 'due';
      }

      if (stats.next_review) {
        const dueDate = new Date(stats.next_review);
        if (!Number.isNaN(dueDate.getTime()) && dueDate <= new Date()) {
          return 'due';
        }
      }

      return '';
    }

    function getPreviewButtonHtml() {
      return '<button class="btn btn-continue" data-answer="continue"><i class="fas fa-arrow-right"></i>Tiếp tục</button>';
    }

    function updateSessionSummary(){
      const desktopTotalScore = document.querySelector('.statistics-card #total-score-display span');
      const desktopSessionScore = document.querySelector('.statistics-card #session-score-display');
      
      const modalTotalScore = document.querySelector('#statsModal #total-score-display span');
      const modalSessionScore = document.querySelector('#statsModal #session-score-display');
      
      if (desktopTotalScore) desktopTotalScore.textContent = currentUserTotalScore;
      if (desktopSessionScore) desktopSessionScore.textContent = `+${sessionScore}`;
      if (modalTotalScore) modalTotalScore.textContent = currentUserTotalScore;
      if (modalSessionScore) modalSessionScore.textContent = `+${sessionScore}`;
    }

    /**
     * Tự động điều chỉnh kích thước font và căn chỉnh nội dung mặt sau thẻ.
     * Áp dụng căn giữa khi không có cuộn, và căn trên khi có cuộn.
     */
    function adjustCardLayout() {
    const card = document.getElementById('flashcard-card');
    if (!card) return;

    const textAreas = card.querySelectorAll('.text-area');

    textAreas.forEach(scrollArea => {
        const txt = scrollArea.querySelector('.flashcard-content-text');
        if (!txt) return;

        // Reset style
        txt.style.fontSize = '';
        scrollArea.classList.remove('has-scroll');
        scrollArea.parentElement?.classList?.remove('has-scroll');

        // Đợi DOM render xong rồi đo
        setTimeout(() => {
        const hasScroll = scrollArea.scrollHeight > scrollArea.clientHeight;

        if (hasScroll) {
            // Ghim lên trên: set class cho cả text-area và container
            scrollArea.classList.add('has-scroll');
            scrollArea.parentElement?.classList?.add('has-scroll');

            // Đảm bảo nhìn thấy từ đầu nội dung
            scrollArea.scrollTop = 0;
        }

        // Thu nhỏ font nếu vẫn tràn
        let current = parseFloat(getComputedStyle(txt).fontSize) || 22;
        const min = 18;
        while (scrollArea.scrollHeight > scrollArea.clientHeight && current > min) {
            current -= 1;
            txt.style.fontSize = current + 'px';
        }
        }, 0);
    });
    }

    function generateDynamicButtons(buttonCount) {
        let buttonsHtml = '';
        const buttonSets = {
            3: [{ class: 'btn-red-dark', text: 'Quên', value: 'quên' }, { class: 'btn-yellow-dark', text: 'Mơ hồ', value: 'mơ_hồ' }, { class: 'btn-green-dark', text: 'Nhớ', value: 'nhớ' }],
            4: [{ class: 'btn-red-dark', text: 'Học lại', value: 'again' }, { class: 'btn-red-light', text: 'Khó', value: 'hard' }, { class: 'btn-yellow-dark', text: 'Bình thường', value: 'good' }, { class: 'btn-green-dark', text: 'Dễ', value: 'easy' }],
            6: [{ class: 'btn-red-dark', text: 'Rất khó', value: 'fail' }, { class: 'btn-red-light', text: 'Khó', value: 'very_hard' }, { class: 'btn-yellow-dark', text: 'Trung bình', value: 'hard' }, { class: 'btn-yellow-light', text: 'Dễ', value: 'medium' }, { class: 'btn-green-light', text: 'Rất dễ', value: 'good' }, { class: 'btn-green-dark', text: 'Dễ dàng', value: 'very_easy' }]
        };
        const buttons = buttonSets[buttonCount] || buttonSets[3];
        buttons.forEach(btn => { buttonsHtml += `<button class="btn ${btn.class}" data-answer="${btn.value}">${btn.text}</button>`; });
        return buttonsHtml;
    }
    
    function getCardToolbar(isMobile, itemId, setId) {
        const hasFrontAudio = currentFlashcardBatch[currentFlashcardIndex].content.front_audio_url || currentFlashcardBatch[currentFlashcardIndex].content.front_audio_content;
        const hasBackAudio = currentFlashcardBatch[currentFlashcardIndex].content.back_audio_url || currentFlashcardBatch[currentFlashcardIndex].content.back_audio_content;
        
        const menuButtonHtml = isMobile ? `<button class="icon-btn open-stats-modal-btn"><i class="fas fa-bars"></i></button>` : '';
        const aiButtonHtml = `<button class="icon-btn open-ai-modal-btn" data-item-id="${itemId}"><i class="fas fa-robot"></i></button>`;
        const noteButtonHtml = `<button class="icon-btn open-note-panel-btn" data-item-id="${itemId}"><i class="fas fa-sticky-note"></i></button>`;
        const feedbackButtonHtml = `<button class="icon-btn open-feedback-modal-btn" data-item-id="${itemId}"><i class="fas fa-flag"></i></button>`;
        const editButtonHtml = `<button class="icon-btn edit-card-btn" onclick="window.parent.openModal('{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=0, item_id=0) }}'.replace('/0', '/${setId}').replace('/0', '/${itemId}'))"><i class="fas fa-pencil-alt"></i></button>`;

        const audioButtonHtmlFront = `<button class="icon-btn play-audio-btn ${hasFrontAudio ? '' : 'is-disabled'}" data-audio-target="#front-audio" data-side="front" data-item-id="${itemId}" data-content-to-read="${currentFlashcardBatch[currentFlashcardIndex].content.front_audio_content || ''}" ${hasFrontAudio ? '' : 'disabled'}><i class="fas fa-volume-up"></i></button>`;
        const audioButtonHtmlBack = `<button class="icon-btn play-audio-btn ${hasBackAudio ? '' : 'is-disabled'}" data-audio-target="#back-audio" data-side="back" data-item-id="${itemId}" data-content-to-read="${currentFlashcardBatch[currentFlashcardIndex].content.back_audio_content || ''}" ${hasBackAudio ? '' : 'disabled'}><i class="fas fa-volume-up"></i></button>`;
        
        const flipButtonHtml = `<button id="flip-card-btn" class="flip-card-btn"><i class="fas fa-sync-alt mr-2"></i>Lật thẻ</button>`;

        const leftToolbarContent = isMobile 
            ? `${menuButtonHtml}${aiButtonHtml}${noteButtonHtml}` 
            : `${aiButtonHtml}${noteButtonHtml}`;
        
        // THAY ĐỔI: Di chuyển nút feedback sang phải
        const rightToolbarContent = `${feedbackButtonHtml}${editButtonHtml}`;

        return {
            front: `<div class="card-toolbar"><div class="toolbar-left">${leftToolbarContent}</div><span class="label">MẶT TRƯỚC</span><div class="toolbar-right">${rightToolbarContent}${audioButtonHtmlFront}</div></div>`,
            back: `<div class="card-toolbar"><div class="toolbar-left">${leftToolbarContent}</div><span class="label">MẶT SAU</span><div class="toolbar-right">${rightToolbarContent}${audioButtonHtmlBack}</div></div>`,
            flipButton: flipButtonHtml
        };
    }

    function renderCard(data){
      const c = data.content;
      const itemId = data.item_id;
      const setId = data.container_id;
      const fTxt = c.front || '';
      const bTxt = c.back || '';
      const initialStats = data.initial_stats || {};
      const cardCategory = determineCardCategory(data);
      const showPreviewOnly = shouldShowPreviewOnly(initialStats);
      const buttonsHtml = showPreviewOnly ? getPreviewButtonHtml() : generateDynamicButtons(userButtonCount);
      const buttonCount = showPreviewOnly ? 1 : userButtonCount;
      const isMobile = window.innerWidth < 1024;

      const toolbars = getCardToolbar(isMobile, itemId, setId);

      const cardClassNames = ['flashcard-card'];
      if (cardCategory) {
        cardClassNames.push(`flashcard-card--${cardCategory}`);
      }

      const html = `
      <div class="flashcard-card-container">
        <div id="flashcard-card" class="${cardClassNames.join(' ')}" data-card-category="${cardCategory || 'default'}">
          <div class="face front">
            ${toolbars.front}
            <div class="_card-container">
              <div class="text-area"><div class="flashcard-content-text">${formatTextForHtml(fTxt)}</div></div>
              ${c.front_img ? `<div class="media-container"><img src="${c.front_img}" alt="Mặt trước" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';"><button class="close-media-btn">&times;</button></div>` : ''}
              <audio id="front-audio" class="hidden" src="${c.front_audio_url || ''}"></audio>
            </div>
            <div class="flex justify-center p-4">
              ${toolbars.flipButton}
            </div>
          </div>
          <div class="face back">
            ${toolbars.back}
            <div class="_card-container">
              <div class="text-area"><div class="flashcard-content-text">${formatTextForHtml(bTxt)}</div></div>
              ${c.back_img ? `<div class="media-container"><img src="${c.back_img}" alt="Mặt sau" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';"><button class="close-media-btn">&times;</button></div>` : ''}
            </div>
            <div class="actions" id="internal-actions" data-button-count="${buttonCount}">${buttonsHtml}</div>
            <audio id="back-audio" class="hidden" src="${c.back_audio_url || ''}"></audio>
          </div>
        </div>
      </div>`;
      flashcardContentDiv.innerHTML = html;
      if (Array.isArray(currentFlashcardBatch) && currentFlashcardBatch[currentFlashcardIndex]) {
        currentFlashcardBatch[currentFlashcardIndex].card_category = cardCategory;
      }
      const card = document.getElementById('flashcard-card');
      const actions = document.getElementById('internal-actions');
      const flipBtn = document.getElementById('flip-card-btn');

      if (card) {
        card.dataset.cardCategory = cardCategory || 'default';
      }

      if (flipBtn) {
        flipBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            card.classList.add('flipped');
            actions?.classList.add('visible');
            flipBtn.style.display = 'none';
            setTimeout(adjustCardLayout, 0);
        });
      }
      
      document.querySelectorAll('.card-toolbar .icon-btn').forEach(btn => {
          btn.addEventListener('click', ev => {
              ev.stopPropagation();
          });
      });
      
      document.querySelectorAll('.btn').forEach(b => b.addEventListener('click', ev => {
        ev.stopPropagation();
        submitFlashcardAnswer(data.item_id, b.dataset.answer);
      }));
      
      document.querySelectorAll('.play-audio-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const audioPlayer = document.querySelector(btn.dataset.audioTarget);
          if (btn.classList.contains('is-disabled')) return;
          if (audioPlayer.src && audioPlayer.src !== window.location.href) {
            audioPlayer.paused ? audioPlayer.play() : (audioPlayer.pause(), audioPlayer.currentTime = 0);
          } else {
            generateAndPlayAudio(btn, audioPlayer);
          }
        });
      });
      document.querySelectorAll('.open-stats-modal-btn').forEach(btn => btn.addEventListener('click', () => {
        toggleStatsModal(true);
      }));
      document.querySelectorAll('.open-ai-modal-btn').forEach(btn => btn.addEventListener('click', () => {
          const itemId = btn.dataset.itemId;
          const currentCard = currentFlashcardBatch[currentFlashcardIndex];
          const termContent = currentCard.content.front;
          const itemContent = currentCard.content;
          window.openAiModal(itemId, termContent, itemContent);
      }));
      document.querySelectorAll('.open-note-panel-btn').forEach(btn => btn.addEventListener('click', () => {
          const itemId = btn.dataset.itemId;
          openNotePanel(itemId);
      }));

      // Gắn listener cho nút feedback
      document.querySelectorAll('.open-feedback-modal-btn').forEach(btn => btn.addEventListener('click', () => {
          const itemId = btn.dataset.itemId;
          const currentCard = currentFlashcardBatch[currentFlashcardIndex];
          const termContent = currentCard.content.front;
          // Gọi hàm từ _feedback_modal.html
          openFeedbackModal(itemId, termContent); 
      }));
      
      document.querySelectorAll('.close-media-btn').forEach(btn => {
        btn.addEventListener('click', ev => {
            ev.stopPropagation();
            const mediaContainer = btn.closest('.media-container');
            if (mediaContainer) {
                mediaContainer.classList.add('hidden');
                setTimeout(adjustCardLayout, 0);
            }
        });
      });
      
      setTimeout(adjustCardLayout, 0);
    }

    async function generateAndPlayAudio(button, audioPlayer) {
      const itemId = button.dataset.itemId;
      const side = button.dataset.side;
      const contentToRead = button.dataset.contentToRead;
      button.classList.add('is-disabled');
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      try {
        const response = await fetch(regenerateAudioUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ item_id: itemId, side: side, content_to_read: contentToRead })
        });
        const result = await response.json();
        if (result.success && result.audio_url) {
          audioPlayer.src = result.audio_url;
          audioPlayer.load();
          audioPlayer.oncanplay = () => {
            audioPlayer.play();
            button.classList.remove('is-disabled');
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
          };
          audioPlayer.onerror = () => {
             showCustomAlert('Không thể phát file âm thanh. Vui lòng thử lại.');
             button.classList.remove('is-disabled');
             button.innerHTML = '<i class="fas fa-volume-up"></i>';
          };
        } else {
          showCustomAlert(result.message || 'Lỗi khi tạo audio.');
          button.classList.remove('is-disabled');
          button.innerHTML = '<i class="fas fa-volume-up"></i>';
        }
      } catch (error) {
        console.error('Lỗi khi tạo audio:', error);
        showCustomAlert('Không thể kết nối đến máy chủ để tạo audio.');
        button.classList.remove('is-disabled');
        button.innerHTML = '<i class="fas fa-volume-up"></i>';
      }
    }

    function formatMinutesAsDuration(minutes) {
        if (minutes <= 0) return 'Dưới 1 phút';
        const M_IN_H = 60, M_IN_D = 1440, M_IN_W = 10080, M_IN_MO = 43200;
        let result = [], remainingMinutes = minutes;
        if (remainingMinutes >= M_IN_MO) { const m = Math.floor(remainingMinutes / M_IN_MO); result.push(`${m} tháng`); remainingMinutes %= M_IN_MO; }
        if (remainingMinutes >= M_IN_W) { const w = Math.floor(remainingMinutes / M_IN_W); result.push(`${w} tuần`); remainingMinutes %= M_IN_W; }
        if (remainingMinutes >= M_IN_D) { const d = Math.floor(remainingMinutes / M_IN_D); result.push(`${d} ngày`); remainingMinutes %= M_IN_D; }
        if (remainingMinutes >= M_IN_H) { const h = Math.floor(remainingMinutes / M_IN_H); result.push(`${h} giờ`); remainingMinutes %= M_IN_H; }
        if (remainingMinutes > 0) result.push(`${remainingMinutes} phút`);
        return result.join(' ');
    }
    
    function renderCardStatsHtml(stats, scoreChange = 0, cardContent = {}, isInitial = false) {
        if (!stats) return `<div class="text-center text-gray-500"><i class="fas fa-info-circle mr-2"></i> ${isInitial ? 'Đây là thẻ mới.' : 'Không có dữ liệu thống kê.'}</div>`;
        const totalReviews = stats.times_reviewed || 0;
        const correctCount = stats.correct_count || 0;
        const incorrectCount = stats.incorrect_count || 0;
        const vagueCount = stats.vague_count || 0;
        const correctPercentage = totalReviews > 0 ? (correctCount / totalReviews) * 100 : 0;
        const incorrectPercentage = totalReviews > 0 ? (incorrectCount / totalReviews) * 100 : 0;
        const vaguePercentage = totalReviews > 0 ? (vagueCount / totalReviews) * 100 : 0;
        const dueTime = stats.next_review ? new Date(stats.next_review).toLocaleString('vi-VN', { dateStyle: 'medium', timeStyle: 'short' }) : 'Chưa có';
        const scoreChangeColor = scoreChange > 0 ? 'text-green-600' : 'text-gray-600';
        const scoreChangeSign = scoreChange > 0 ? '+' : '';
        const formattedInterval = formatMinutesAsDuration(stats.interval);
        const formattedIntervalDisplay = formattedInterval || 'Chưa có';
        const isBrandNew = !stats.has_preview_history && !stats.has_real_reviews;
        const isPreviewStage = stats.has_preview_history && !stats.has_real_reviews;
        const introNotice = isBrandNew
            ? `<div class="flashcard-status-banner flashcard-status-banner--new"><i class="fas fa-seedling"></i><span>Thẻ mới - hãy khám phá nội dung trước khi đánh giá.</span></div>`
            : (isPreviewStage
                ? `<div class="flashcard-status-banner flashcard-status-banner--preview"><i class="fas fa-hourglass-half"></i><span>Thẻ đang ở bước giới thiệu. Nhấn "Tiếp tục" để chuyển sang bước đánh giá.</span></div>`
                : '');

        return `
            ${introNotice}
            <div class="space-y-4">
                <div class="progress-bar-group"><div class="progress-bar-label"><span>Nhớ (${correctCount})</span><span>${Math.round(correctPercentage)}%</span></div><div class="progress-bar-container"><div class="progress-bar-fill progress-bar-fill-correct" style="width: ${correctPercentage}%;"></div></div></div>
                <div class="progress-bar-group"><div class="progress-bar-label"><span>Mơ hồ (${vagueCount})</span><span>${Math.round(vaguePercentage)}%</span></div><div class="progress-bar-container"><div class="progress-bar-fill progress-bar-fill-vague" style="width: ${vaguePercentage}%;"></div></div></div>
                <div class="progress-bar-group"><div class="progress-bar-label"><span>Quên (${incorrectCount})</span><span>${Math.round(incorrectPercentage)}%</span></div><div class="progress-bar-container"><div class="progress-bar-fill progress-bar-fill-incorrect" style="width: ${incorrectPercentage}%;"></div></div></div>
            </div>
            ${cardContent.front ? `
            <div class="card-info-section">
                <div class="card-info-title collapsed" data-toggle="card-details-content">
                    <i class="fas fa-caret-right"></i><span>Chi tiết thẻ</span>
                </div>
                <div class="card-info-content">
                    <p><span class="label">Mặt trước:</span> ${formatTextForHtml(cardContent.front)}</p>
                    <p><span class="label">Mặt sau:</span> ${formatTextForHtml(cardContent.back)}</p>
                </div>
            </div>` : ''}
            <div class="stats-grid">
                ${!isInitial ? `<div class="stat-box"><i class="fas fa-star icon"></i><span class="value ${scoreChangeColor}">${scoreChangeSign}${scoreChange}</span><span class="label">Điểm</span></div>` : ''}
                <div class="stat-box status"><i class="fas fa-signal icon"></i><span class="value">${stats.status}</span><span class="label">Trạng thái</span></div>
                <div class="stat-box"><i class="fas fa-bolt icon"></i><span class="value">${stats.easiness_factor}</span><span class="label">Hệ số dễ (EF)</span></div>
                <div class="stat-box"><i class="fas fa-sync-alt icon"></i><span class="value">${stats.repetitions}</span><span class="label">Lặp lại (n)</span></div>
                <div class="stat-box"><i class="fas fa-clock icon"></i><span class="value">${formattedIntervalDisplay}</span><span class="label">Khoảng thời gian (I)</span></div>
                <div class="stat-box"><i class="fas fa-calendar-check icon"></i><span class="value text-sm">${dueTime}</span><span class="label">Đến hạn ôn lại</span></div>
            </div>
        `;
    }

    function initializeStatsToggleListeners(rootElement) {
        if (!rootElement) return;

        rootElement.querySelectorAll('[data-toggle]').forEach(toggleBtn => {
            if (toggleBtn.dataset.toggleListenerAttached === 'true') return;

            toggleBtn.addEventListener('click', function() {
                const content = this.nextElementSibling;
                this.classList.toggle('collapsed');

                if (!content) return;

                content.classList.toggle('open');

                if (content.classList.contains('open')) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                } else {
                    content.style.maxHeight = null;
                }
            });

            toggleBtn.dataset.toggleListenerAttached = 'true';
        });
    }

    function displayCardStats(container, html) {
        container.innerHTML = html;
        initializeStatsToggleListeners(container);
    }

    async function getNextFlashcardBatch(){
      flashcardContentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>`;
      try {
        const res = await fetch(getFlashcardBatchUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
        if (!res.ok) {
          if (res.status === 404) {
            const end = await res.json();
            flashcardContentDiv.innerHTML = `<div class="text-center py-12 text-gray-600"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h3 class="text-xl font-semibold text-gray-700 mb-2">Hoàn thành phiên học!</h3><p class="text-gray-500">${formatTextForHtml(end.message)}</p><button id="return-to-dashboard-btn" class="mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-sm"><i class="fas fa-home mr-2"></i> Quay lại Dashboard</button></div>`;
            document.getElementById('return-to-dashboard-btn').addEventListener('click', () => { window.location.href = "{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}"; });
            return;
          }
          throw new Error('HTTP ' + res.status);
        }
        const batch = await res.json();
        currentFlashcardBatch = batch.items;
        currentFlashcardIndex = 0;
        const currentCardData = currentFlashcardBatch[currentFlashcardIndex];
        
        const initialStatsHtml = renderCardStatsHtml(currentCardData.initial_stats, 0, currentCardData.content, true);
        displayCardStats(currentCardStatsContainer, initialStatsHtml);
        
        renderCard(currentCardData);
        updateSessionSummary();

      } catch (e) {
        console.error('Lỗi khi tải nhóm thẻ:', e);
        flashcardContentDiv.innerHTML = `<p class='text-red-500 text-center'>Không thể tải thẻ. Vui lòng thử lại.</p>`;
      }
    }

    async function submitFlashcardAnswer(itemId, answer){
      try {
        const res = await fetch(submitAnswerUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ item_id: itemId, user_answer: answer })
        });
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP error! status: ${res.status}, body: ${errorText}`);
        }
        const data = await res.json();
        
        sessionScore += data.score_change;
        currentUserTotalScore = data.updated_total_score;
        
        const previousCardContent = currentFlashcardBatch[currentFlashcardIndex].content;
        previousCardStats = { 
            stats: data.statistics,
            scoreChange: data.score_change,
            cardContent: previousCardContent
        };
        const previousStatsHtml = renderCardStatsHtml(data.statistics, data.score_change, previousCardContent, false);
        displayCardStats(previousCardStatsContainer, previousStatsHtml);

        const prevTabButton = document.querySelector('.stats-tab-button[data-target="previous-card-stats-pane"]');
        if (prevTabButton) {
            prevTabButton.click();
        }
        
        currentFlashcardIndex++;
        getNextFlashcardBatch();
      } catch (e) {
        console.error('Lỗi khi gửi đáp án:', e);
        showCustomAlert('Có lỗi khi gửi đáp án. Vui lòng thử lại.');
      }
    }

    endSessionBtn.addEventListener('click', () => endSessionModal.style.display = 'flex');
    confirmEndSessionBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(endSessionUrl, { method: 'POST' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const r = await res.json();
        window.showFlashMessage(r.message || 'Đã kết thúc phiên.', 'info');
        window.location.href = "{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}";
      } catch (e) {
        window.showFlashMessage('Có lỗi xảy ra khi kết thúc phiên.', 'danger');
      } finally {
        endSessionModal.style.display = 'none';
      }
    });
    cancelEndSessionBtn.addEventListener('click', () => endSessionModal.style.display = 'none');

    function showCustomAlert(message) {
      const modalHtml = `<div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><p class="text-lg font-semibold text-gray-800 mb-4">${formatTextForHtml(message)}</p><button id="custom-alert-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">OK</button></div></div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.getElementById('custom-alert-ok-btn').addEventListener('click', () => document.getElementById('custom-alert-modal').remove());
    }
    
    function toggleStatsModal(show) {
        if (show) {
            statsModal.classList.add('open');
            statsModalContent.classList.add('open');
            document.body.style.overflow = 'hidden';
            
            const currentCardData = currentFlashcardBatch.length > 0 ? currentFlashcardBatch[currentFlashcardIndex] : null;
            let initialStatsHtml;
            if (currentCardData && currentCardData.initial_stats) {
                initialStatsHtml = renderCardStatsHtml(currentCardData.initial_stats, 0, currentCardData.content, true);
            } else {
                initialStatsHtml = '<div class="text-center text-gray-500">Chưa có thẻ nào.</div>';
            }

            const previousStatsHtml = previousCardStats ? renderCardStatsHtml(previousCardStats.stats, previousCardStats.scoreChange, previousCardStats.cardContent, false) : '<div class="text-center text-gray-500">Chưa trả lời thẻ nào.</div>';
            
            const tabsHtml = `
                <div id="current-card-stats-pane" class="stats-tab-pane active">${initialStatsHtml}</div>
                <div id="previous-card-stats-pane" class="stats-tab-pane">${previousStatsHtml}</div>
            `;
            
            const statsHtml = `
                <div class="mobile-nav-header">
                    {# Gọi macro navbar để render thanh điều hướng #}
                    {{ render_navbar(current_user, request) }}
                    <div class="stats-modal-header">
                        <h3>Thống kê phiên học</h3>
                        <button id="closeStatsModalBtn" class="stats-modal-close-btn">&times;</button>
                    </div>
                </div>
                <div class="stats-modal-body">
                    <div class="statistics-card !shadow-none !border-none !p-0">
                        <h3 class="text-lg font-semibold text-center text-gray-800 mb-4">Thống kê phiên học</h3>
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Tổng điểm</span>
                                    <div id="total-score-display" class="text-2xl font-bold text-gray-800 flex items-center justify-center"><i class="fas fa-star text-yellow-400 mr-2"></i><span>${currentUserTotalScore}</span></div>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Điểm phiên này</span>
                                    <div id="session-score-display" class="text-2xl font-bold text-green-600">+${sessionScore}</div>
                                </div>
                            </div>
                        </div>
                        <div class="stats-tab-nav">
                            <button class="stats-tab-button active" data-target="current-card-stats-pane">Thẻ hiện tại</button>
                            <button class="stats-tab-button" data-target="previous-card-stats-pane">Thẻ trước đó</button>
                        </div>
                        <div>
                            ${tabsHtml}
                        </div>
                        <hr class="my-6">
                        <div class="mt-2 flex justify-center"><button id="end-session-modal-btn" class="px-6 py-3 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 shadow-sm">Kết thúc phiên</button></div>
                    </div>
                </div>
            `;

            statsModalContent.innerHTML = statsHtml;

            document.getElementById('closeStatsModalBtn').addEventListener('click', () => toggleStatsModal(false));

            document.querySelectorAll('.stats-tab-button').forEach(btn => btn.addEventListener('click', handleTabClick));
            document.getElementById('end-session-modal-btn')?.addEventListener('click', () => endSessionBtn.click());

            initializeStatsToggleListeners(statsModalContent);

            if (previousCardStats) {
                document.querySelector('button[data-target="previous-card-stats-pane"]').click();
            }
            
        } else {
            statsModal.classList.remove('open');
            statsModalContent.classList.remove('open');
            document.body.style.overflow = '';
        }
    }
    
    closeStatsModalBtn.addEventListener('click', () => toggleStatsModal(false));
    function handleTabClick(event) {
        const targetPaneId = event.target.dataset.target;
        const parentContainer = event.target.closest('.statistics-card');
        parentContainer.querySelectorAll('.stats-tab-button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        parentContainer.querySelectorAll('.stats-tab-pane').forEach(pane => {
            pane.classList.toggle('active', pane.id === targetPaneId);
        });
        
        initializeStatsToggleListeners(parentContainer);
    }

    // ==============================================================================
    // LOGIC CHO AI MODAL (ĐÃ SỬA LỖI LOGIC)
    // ==============================================================================
    
    // Ghi đè hàm openAiModal và closeAiModal được định nghĩa trong _ai_modal.html
    window.openAiModal = function(itemId, termContent, itemContent) {
        const aiModal = document.getElementById('ai-modal');
        if (aiModal && aiModal.classList.contains('open')) {
            console.warn("AI modal đã được mở, bỏ qua lệnh gọi.");
            return;
        }

        const aiModalTerm = document.getElementById('ai-modal-term');
        const aiResponseContainer = document.getElementById('ai-response-container');
        
        currentAiItemId = itemId;
        aiModalTerm.textContent = termContent; 
        aiModal.classList.add('open');
        
        fetchAiResponse('explanation', itemContent);
    };

    window.closeAiModal = function() {
        const aiModal = document.getElementById('ai-modal');
        const aiResponseContainer = document.getElementById('ai-response-container');
        
        aiModal.classList.remove('open');
        currentAiItemId = null;
        aiResponseContainer.innerHTML = `<div class="text-gray-500">Câu trả lời của AI sẽ xuất hiện ở đây.</div>`;
    };
    
    // Các listeners trong _ai_modal.html sẽ gọi các hàm global trên

    // ==============================================================================
    // LOGIC CHO NOTE PANEL
    // ==============================================================================
    const notePanel = document.getElementById('note-panel');
    const noteTextarea = document.getElementById('note-textarea');
    const saveNoteBtn = document.getElementById('save-note-btn');
    const cancelNoteBtn = document.getElementById('cancel-note-btn');
    let currentNoteItemId = null;

    async function openNotePanel(itemId) {
        if (!itemId) return;
        currentNoteItemId = itemId;
        
        noteTextarea.value = 'Đang tải ghi chú...';
        noteTextarea.disabled = true;
        try {
            const response = await fetch(getNoteUrl.replace('/0', `/${itemId}`));
            const result = await response.json();
            if (response.ok && result.success) {
                noteTextarea.value = result.content;
            } else {
                noteTextarea.value = '';
            }
        } catch (error) {
            console.error('Lỗi khi tải ghi chú:', error);
            noteTextarea.value = 'Lỗi khi tải ghi chú.';
        } finally {
            noteTextarea.disabled = false;
        }

        notePanel.classList.add('open');
    }

    function closeNotePanel() {
        notePanel.classList.remove('open');
        currentNoteItemId = null;
        noteTextarea.value = '';
    }

    async function saveNote() {
        if (!currentNoteItemId) return;

        const content = noteTextarea.value;
        saveNoteBtn.disabled = true;
        saveNoteBtn.textContent = 'Đang lưu...';

        try {
            const response = await fetch(saveNoteUrl.replace('/0', `/${currentNoteItemId}`), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                window.showFlashMessage(result.message, 'success');
                closeNotePanel();
            } else {
                window.showFlashMessage(result.message || 'Lỗi khi lưu ghi chú.', 'danger');
            }
        } catch (error) {
            console.error('Lỗi khi lưu ghi chú:', error);
            window.showFlashMessage('Lỗi kết nối khi lưu ghi chú.', 'danger');
        } finally {
            saveNoteBtn.disabled = false;
            saveNoteBtn.textContent = 'Lưu Ghi chú';
        }
    }

    saveNoteBtn.addEventListener('click', saveNote);
    cancelNoteBtn.addEventListener('click', closeNotePanel);


    document.addEventListener('DOMContentLoaded', () => {
      setVh();
      document.body.classList.add('flashcard-session-active');
      
      document.querySelectorAll('.statistics-card .stats-tab-button').forEach(btn => btn.addEventListener('click', handleTabClick));
      updateSessionSummary();
      getNextFlashcardBatch();
    });

    window.addEventListener('resize', () => {
    setVh();
    setTimeout(adjustCardLayout, 0);
    });

  </script>
{% endblock %}