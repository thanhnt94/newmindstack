{# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html #}
{# Phiên bản: 16.0 #}
{# Mục đích: Cập nhật giao diện và logic JavaScript để hiển thị các nút đánh giá Flashcard tùy theo cài đặt của người dùng (3, 4 hoặc 6 nút). #}
{# ĐÃ SỬA: Thay thế 4 nút đánh giá (Học lại, Khó, Bình thường, Dễ) bằng 3 nút mới (Quên, Mơ hồ, Nhớ). #}
{# ĐÃ SỬA: Cập nhật logic JavaScript để gửi đúng giá trị mới đến backend. #}
{# ĐÃ SỬA: Cập nhật các nút đánh giá và thống kê để hỗ trợ 3, 4, và 6 nút. #}

{% extends "base.html" %}
{% block title %}Học Flashcard{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f9fafb;
    }

    /* ===== Layout toàn trang (full height) ===== */
    .page-shell {
        position: absolute;
        left: 0;
        right: 0;
        top: var(--header-h, 0px);
        bottom: var(--footer-h, 0px);
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding-top: 1rem;
    }

    @media (max-width: 1024px) {
        .page-shell {
            top: var(--header-h, 0px);
            bottom: 0;
            padding-top: 0;
        }
    }
    
    .page-title {
        color: #1f2937;
        margin-bottom: 2rem;
        font-size: 2.25rem;
        font-weight: 800;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .page-title .text-gray-500 {
        font-size: 1.25rem;
        margin-left: 0.5rem;
        font-weight: 600;
        text-transform: none;
        letter-spacing: normal;
    }
    /* ===== Lưới 2 cột cho session layout ===== */
    .session-layout {
        height: 100%;
        display: grid;
        grid-template-columns: minmax(0, 5fr) minmax(320px, 2fr);
        gap: 2rem;
        max-width: 1680px;
        margin: 0 auto;
        padding: 1.5rem 2rem 1.5rem 2rem;
        align-items: stretch;
        min-height: 0;
    }

    @media (max-width: 1024px) {
        .session-layout {
            grid-template-columns: 1fr;
            max-width: 100%;
            padding: 1rem;
            height: 100%;
        }
    }

    /* ===== Wrapper cho thẻ Flashcard ===== */
    .flashcard-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
    }

    #flashcard-content {
        flex: 1 1 auto;
        min-height: 0;
    }

    /* ===== Thẻ: Flip 3D (xoay TOÀN BỘ thẻ) ===== */
    .flashcard-card-container {
        perspective: 1200px;
        -webkit-perspective: 1200px;
        width: 100%;
        height: 100%;
        min-height: 300px;
    }

    .flashcard-card {
        width: 100%;
        height: 100%;
        position: relative;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
        overflow: hidden;
        transform-style: preserve-3d;
        -webkit-transform-style: preserve-3d;
        cursor: pointer;
    }
    
    .face {
        position: absolute;
        inset: 0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 10px;
        min-height: 0;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transition: transform .6s ease-in-out;
    }
    
    /* Đảm bảo mặt trước hiển thị đúng chiều ở trạng thái bình thường */
    .front { 
        transform: rotateY(0deg); 
        text-align: center; 
    }
    
    /* Đảm bảo mặt sau bị lật ở trạng thái bình thường để ẩn đi */
    .back { 
        transform: rotateY(180deg);
    }
    
    /* Khi lật thẻ, mặt trước sẽ bị xoay và mặt sau sẽ được xoay về đúng chiều */
    .flashcard-card.flipped .front {
        transform: rotateY(180deg);
    }
    
    .flashcard-card.flipped .back {
        transform: rotateY(360deg);
    }
    
    /* Thanh tiêu đề của thẻ */
    .card-toolbar {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        margin-bottom: .25rem;
    }

    .card-toolbar .label {
        text-transform: uppercase;
        text-align: center;
        font-weight: 700;
        color: #6b7280;
        letter-spacing: .06em;
    }

    /* Nội dung text (căn dọc giữa) */
    .text-area {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
        display: flex;
        align-items: center;
    }

    .text-area > .flashcard-content-text {
        width: 100%;
    }

    .front .text-area .flashcard-content-text {
        text-align: center;
        font-size: 2.2rem;
        font-weight: 700;
        color: #1f2937;
    }

    .back .text-area .flashcard-content-text {
        text-align: left;
        font-size: 22px;
        line-height: 1.5;
        color: #111827;
        white-space: pre-wrap;
    }

    /* Ảnh/Âm thanh đáy thẻ (có nút ×) */
    .media-container {
        flex: 0 0 auto;
        max-height: 40vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-top: 1px solid #e5e7eb;
        padding: 10px;
        position: relative;
    }

    .media-container.hidden {
        display: none;
    }

    .media-container img, .media-container audio {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
    }

    .media-close {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(0, 0, 0, .55);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        font-size: 16px;
        line-height: 28px;
        text-align: center;
        cursor: pointer;
    }

    /* Nút đánh giá trong thẻ */
    .actions {
        display: none;
        gap: .75rem;
        justify-content: center;
        margin-top: .6rem;
    }

    .actions.visible {
        display: flex;
    }

    .btn {
        border: none;
        color: #fff;
        font-weight: 700;
        padding: .75rem 1.2rem;
        border-radius: 9999px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, .06);
        cursor: pointer;
    }

    /* Màu sắc cho các nút khác nhau */
    .btn-quality-0, .btn-quality-1 { background: #ef4444; } /* Red */
    .btn-quality-2 { background: #f59e0b; } /* Amber */
    .btn-quality-3 { background: #3b82f6; } /* Blue */
    .btn-quality-4 { background: #10b981; } /* Green */
    .btn-quality-5 { background: #22c55e; } /* Deeper Green */
    
    /* Màu sắc thống kê */
    .stat-incorrect { color: #ef4444; }
    .stat-vague { color: #f59e0b; }
    .stat-correct { color: #10b981; }
    .stat-very-correct { color: #22c55e; }

    /* Ẩn cụm nút ngoài (đã move vào thẻ) */
    #flashcard-buttons {
        display: none !important;
    }

    /* Thống kê */
    .statistics-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
    }
    
    /* Custom Modal */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .custom-modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 400px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="session-layout">
    <div class="flashcard-wrapper">
      <div id="flashcard-content">
        <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>
      </div>
      <div id="flashcard-buttons" class="mt-3"></div>
    </div>

    <div class="statistics-card">
        <h3 class="text-lg font-semibold text-center text-gray-800">Thống kê phiên học</h3>
        <div id="session-stats-container" class="grid grid-cols-3 gap-3 mt-4">
          <div class="text-center bg-gray-100 rounded-md p-3">
            <div class="text-sm text-gray-500">Quên</div>
            <div id="session-incorrect-count" class="text-2xl font-bold stat-incorrect">0</div>
          </div>
          <div class="text-center bg-gray-100 rounded-md p-3">
            <div class="text-sm text-gray-500">Mơ hồ</div>
            <div id="session-vague-count" class="text-2xl font-bold stat-vague">0</div>
          </div>
          <div class="text-center bg-gray-100 rounded-md p-3">
            <div class="text-sm text-gray-500">Nhớ</div>
            <div id="session-correct-count" class="text-2xl font-bold stat-correct">0</div>
          </div>
        </div>
        <div class="text-center bg-gray-100 rounded-md p-3 mt-3">
            <div class="text-sm text-gray-500">Tổng ôn</div>
            <div id="session-total-answered" class="text-2xl font-bold">0</div>
        </div>

        <hr class="my-6">
        <h3 class="text-lg font-semibold text-center text-gray-800">Thống kê thẻ hiện tại</h3>
        <div id="current-card-stats" class="mt-4 flex-grow space-y-4">
            <div class="text-center text-gray-500">
                <i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.
            </div>
        </div>

        <hr class="my-6">
        <div class="mt-2 flex justify-center">
            <button id="end-session-btn" class="px-6 py-3 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 shadow-sm">Kết thúc phiên</button>
        </div>
    </div>
  </div>
</div>

<div id="endSessionModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <p class="text-lg font-semibold text-gray-800 mb-4">Bạn có chắc chắn muốn kết thúc phiên học hiện tại?</p>
    <p class="text-sm text-gray-600 mb-6">Tiến độ của thẻ chưa trả lời sẽ không được lưu.</p>
    <div class="flex justify-center space-x-4">
      <button id="confirmEndSessionBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Kết thúc</button>
      <button id="cancelEndSessionBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Hủy bỏ</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    /* ===== Tính chiều cao header/footer/title để layout full-height ===== */
    function updateFixedHeights(){
      const header=document.querySelector('header'); const footer=document.querySelector('footer');
      const hh=header?header.offsetHeight:0, fh=footer?footer.offsetHeight:0;
      document.documentElement.style.setProperty('--header-h', hh+'px');
      document.documentElement.style.setProperty('--footer-h', fh+'px');
    }
    window.addEventListener('load', updateFixedHeights); window.addEventListener('resize', updateFixedHeights); new ResizeObserver(updateFixedHeights).observe(document.body);

    /* ===== State ===== */
    let currentFlashcardBatch = [];
    let currentFlashcardIndex = 0;

    const flashcardContentDiv = document.getElementById('flashcard-content');
    const flashcardProgressSpan = document.getElementById('flashcard-progress');
    const endSessionBtn = document.getElementById('end-session-btn');
    const sessionTotalAnsweredSpan = document.getElementById('session-total-answered');
    const sessionCorrectCountSpan = document.getElementById('session-correct-count');
    const sessionIncorrectCountSpan = document.getElementById('session-incorrect-count');
    const sessionVagueCountSpan = document.getElementById('session-vague-count');
    const currentCardStatsDiv = document.getElementById('current-card-stats');

    const endSessionModal = document.getElementById('endSessionModal');
    const confirmEndSessionBtn = document.getElementById('confirmEndSessionBtn');
    const cancelEndSessionBtn = document.getElementById('cancelEndSessionBtn');
    
    // THÊM MỚI: Biến lưu số nút đánh giá của người dùng
    const userButtonCount = parseInt("{{ user_button_count | default(3) }}");

    const getFlashcardBatchUrl = "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}";
    const submitAnswerUrl = "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}";
    const endSessionUrl = "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}";

    function formatTextForHtml(text){
      if (text == null) return '';
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML.replace(/\r?\n/g,'<br>');
    }

    function updateSessionSummary(c, i, v, t){
      sessionCorrectCountSpan.textContent = c;
      sessionIncorrectCountSpan.textContent = i;
      sessionVagueCountSpan.textContent = v;
      sessionTotalAnsweredSpan.textContent = t;
    }
    
    // THÊM MỚI: Cập nhật hàm để tạo các nút đánh giá động
    function createRatingButtons(userButtonCount) {
        let buttons = [];
        if (userButtonCount === 3) {
            buttons = [
                { label: 'Quên', class: 'btn-quality-1', answer: 'quên' },
                { label: 'Mơ hồ', class: 'btn-quality-2', answer: 'mơ_hồ' },
                { label: 'Nhớ', class: 'btn-quality-4', answer: 'nhớ' }
            ];
        } else if (userButtonCount === 4) {
            buttons = [
                { label: 'Again', class: 'btn-quality-1', answer: 'again' },
                { label: 'Hard', class: 'btn-quality-3', answer: 'hard' },
                { label: 'Good', class: 'btn-quality-4', answer: 'good' },
                { label: 'Easy', class: 'btn-quality-5', answer: 'easy' }
            ];
        } else if (userButtonCount === 6) {
            buttons = [
                { label: 'Fail', class: 'btn-quality-0', answer: 'fail' },
                { label: 'Very Hard', class: 'btn-quality-1', answer: 'very_hard' },
                { label: 'Hard', class: 'btn-quality-2', answer: 'hard' },
                { label: 'Good', class: 'btn-quality-3', answer: 'good' },
                { label: 'Easy', class: 'btn-quality-4', answer: 'easy' },
                { label: 'Very Easy', class: 'btn-quality-5', answer: 'very_easy' }
            ];
        }
        return buttons;
    }
    
    function adjustFontSize(){
      const scrollArea = document.querySelector('.back .text-area');
      const txt = document.querySelector('.back .flashcard-content-text');
      const card = document.getElementById('flashcard-card');
      if (!scrollArea || !txt || !card) return;
      txt.style.fontSize = '';
      const isOverflow = () => scrollArea.scrollHeight > scrollArea.clientHeight;
      let current = parseFloat(getComputedStyle(txt).fontSize) || 22;
      const min = 18;
      while (isOverflow() && current > min) {
        current -= 1;
        txt.style.fontSize = current + 'px';
      }
    }

    function renderCard(data){
      const c = data.content;
      const fTxt = c.front || 'Không có nội dung';
      const bTxt = c.back || 'Không có nội dung';
      const fImg = c.front_img ? `<img src="${c.front_img}" alt="Mặt trước" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';">` : '';
      const bImg = c.back_img ? `<img src="${c.back_img}" alt="Mặt sau" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';">` : '';
      const fAud = c.front_audio_url ? `<audio controls src="${c.front_audio_url}" class="w-full mt-2" onerror="this.outerHTML='<p class=\\'text-red-500\\'>Lỗi âm thanh</p>'"></audio>` : '';
      const bAud = c.back_audio_url ? `<audio controls src="${c.back_audio_url}" class="w-full mt-2" onerror="this.outerHTML='<p class=\\'text-red-500\\'>Lỗi âm thanh</p>'"></audio>` : '';
      
      const buttons = createRatingButtons(userButtonCount);
      const buttonHtml = buttons.map(btn => `<button class="btn ${btn.class}" data-answer="${btn.answer}">${btn.label}</button>`).join('');

      const html = `
      <div class="flashcard-card-container">
        <div id="flashcard-card" class="flashcard-card">
          <div class="face front">
            <div class="card-toolbar"><span></span><span class="label">MẶT TRƯỚC</span><span></span></div>
            <div class="text-area">
              <div class="flashcard-content-text">${formatTextForHtml(fTxt)}</div>
            </div>
            <div class="media-container ${(fImg||fAud)?'':'hidden'}" id="front-media">${fImg}${fAud}<button class="media-close" data-target="front-media">×</button></div>
          </div>
          <div class="face back">
            <div class="card-toolbar"><span></span><span class="label">MẶT SAU</span><span></span></div>
            <div class="text-area">
              <div class="flashcard-content-text">${formatTextForHtml(bTxt)}</div>
            </div>
            <div class="media-container ${(bImg||bAud)?'':'hidden'}" id="back-media">${bImg}${bAud}<button class="media-close" data-target="back-media">×</button></div>
            <div class="actions" id="internal-actions">
              ${buttonHtml}
            </div>
          </div>
        </div>
      </div>`;

      flashcardContentDiv.innerHTML = html;

      const card = document.getElementById('flashcard-card');
      const actions = document.getElementById('internal-actions');
      card.addEventListener('click', () => {
        card.classList.toggle('flipped');
        if (card.classList.contains('flipped')) {
            actions?.classList.add('visible');
        } else {
            actions?.classList.remove('visible');
        }
        setTimeout(adjustFontSize, 0);
      });

      document.querySelectorAll('.btn').forEach(b => b.addEventListener('click', ev => {
        ev.stopPropagation();
        submitFlashcardAnswer(data.item_id, b.dataset.answer);
      }));
      
      document.querySelectorAll('.media-close').forEach(btn => btn.addEventListener('click', ev => {
        ev.stopPropagation();
        const id = btn.dataset.target;
        document.getElementById(id)?.classList.add('hidden');
        setTimeout(adjustFontSize, 200);
      }));
      setTimeout(adjustFontSize, 0);
    }

    function renderCardStats(stats, scoreChange) {
        if (!stats) {
            currentCardStatsDiv.innerHTML = `<div class="text-center text-gray-500"><i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.</div>`;
            return;
        }
        
        const totalReviews = stats.times_reviewed || 0;
        const correctCount = stats.correct_count || 0;
        const incorrectCount = stats.incorrect_count || 0;
        const hardCount = stats.hard_count || 0;

        const nextReviewTime = stats.next_review ? new Date(stats.next_review).toLocaleString('vi-VN', { dateStyle: 'medium', timeStyle: 'short' }) : 'Chưa có';
        
        const scoreChangeColor = scoreChange > 0 ? 'text-green-600' : (scoreChange < 0 ? 'text-red-600' : 'text-gray-600');
        const scoreChangeSign = scoreChange > 0 ? '+' : '';

        let statsHtml = `
            <div class="grid grid-cols-2 gap-3 text-center">
                <div class="bg-gray-100 rounded-md p-2">
                    <div class="text-sm text-gray-500">Tổng ôn</div>
                    <div class="text-xl font-bold">${totalReviews}</div>
                </div>
                <div class="bg-gray-100 rounded-md p-2">
                    <div class="text-sm text-gray-500">Đúng</div>
                    <div class="text-xl font-bold text-green-600">${correctCount}</div>
                </div>
                <div class="bg-gray-100 rounded-md p-2">
                    <div class="text-sm text-gray-500">Sai</div>
                    <div class="text-xl font-bold text-red-600">${incorrectCount}</div>
                </div>
                <div class="bg-gray-100 rounded-md p-2">
                    <div class="text-sm text-gray-500">Khó</div>
                    <div class="text-xl font-bold text-yellow-600">${hardCount}</div>
                </div>
            </div>
            
            <div class="mt-4 space-y-2">
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Điểm:</span>
                    <span class="font-semibold text-right ${scoreChangeColor}">${scoreChangeSign}${scoreChange}</span>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Trạng thái:</span>
                    <span class="font-semibold text-right">${stats.status}</span>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Lần cuối ôn:</span>
                    <span class="font-semibold text-right">${new Date(stats.last_reviewed).toLocaleString('vi-VN', { dateStyle: 'medium', timeStyle: 'short' })}</span>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Đến hạn ôn lại:</span>
                    <span class="font-semibold text-right">${nextReviewTime}</span>
                </div>
            </div>
        `;

        currentCardStatsDiv.innerHTML = statsHtml;
    }

    async function getNextFlashcardBatch(){
      flashcardContentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>`;
      currentCardStatsDiv.innerHTML = `<div class="text-center text-gray-500"><i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.</div>`;

      try {
        const res = await fetch(getFlashcardBatchUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
        if (!res.ok) {
          if (res.status === 404) {
            const end = await res.json();
            flashcardContentDiv.innerHTML = `
              <div class="text-center py-12 text-gray-600">
                <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Hoàn thành phiên học!</h3>
                <p class="text-gray-500">${formatTextForHtml(end.message)}</p>
                <button id="return-to-dashboard-btn" class="mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-sm">
                  <i class="fas fa-home mr-2"></i> Quay lại Dashboard
                </button>
              </div>`;
            document.getElementById('return-to-dashboard-btn').addEventListener('click', () => {
              window.location.href = "{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}";
            });
            return;
          }
          throw new Error('HTTP ' + res.status);
        }
        const batch = await res.json();
        currentFlashcardBatch = batch.items;
        currentFlashcardIndex = 0;
        renderCard(currentFlashcardBatch[currentFlashcardIndex]);
        updateSessionSummary(batch.session_correct_answers, batch.session_incorrect_answers, batch.session_vague_answers, batch.session_total_answered);
      } catch (e) {
        console.error('Lỗi khi tải nhóm thẻ:', e);
        flashcardContentDiv.innerHTML = `<p class='text-red-500 text-center'>Không thể tải thẻ. Vui lòng thử lại.</p>`;
      }
    }

    async function submitFlashcardAnswer(itemId, answer){
      try {
        const res = await fetch(submitAnswerUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ item_id: itemId, user_answer: answer })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        updateSessionSummary(data.session_correct_answers, data.session_incorrect_answers, data.session_vague_answers, data.session_total_answered);
        
        // Hiển thị thống kê cho thẻ vừa trả lời
        if (data.statistics) {
            renderCardStats(data.statistics, data.score_change);
        }

        setTimeout(() => {
          currentFlashcardIndex++;
          getNextFlashcardBatch();
        }, 900);
      } catch (e) {
        console.error('Lỗi khi gửi đáp án:', e);
        showCustomAlert('Có lỗi khi gửi đáp án. Vui lòng thử lại.');
      }
    }

    // Custom Modal for End Session
    endSessionBtn.addEventListener('click', () => {
      endSessionModal.style.display = 'flex';
    });

    confirmEndSessionBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(endSessionUrl, { method: 'POST' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const r = await res.json();
        window.showFlashMessage(r.message || 'Đã kết thúc phiên.', 'info');
        window.location.href = "{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}";
      } catch (e) {
        window.showFlashMessage('Có lỗi xảy ra khi kết thúc phiên.', 'danger');
      } finally {
        endSessionModal.style.display = 'none';
      }
    });

    cancelEndSessionBtn.addEventListener('click', () => {
      endSessionModal.style.display = 'none';
    });

    // Custom Alert Function
    function showCustomAlert(message) {
      const modalHtml = `
          <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
              <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                  <p class="text-lg font-semibold text-gray-800 mb-4">${formatTextForHtml(message)}</p>
                  <button id="custom-alert-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">OK</button>
              </div>
          </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.getElementById('custom-alert-ok-btn').addEventListener('click', () => {
          document.getElementById('custom-alert-modal').remove();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateFixedHeights();
      getNextFlashcardBatch();
    });
  </script>
{% endblock %}