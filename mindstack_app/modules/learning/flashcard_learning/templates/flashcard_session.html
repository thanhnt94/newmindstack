{# =============================== #}
{# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html #}
{# Phiên bản: 43.0 #}
{# MỤC ĐÍCH: Khắc phục lỗi "đang tải thẻ..." và lỗi điểm không cập nhật. #}
{# ĐÃ SỬA: Khôi phục lại hàm startTimer trong JavaScript vì nó cần thiết cho logic chạy đúng. #}
{# ĐÃ SỬA: Cập nhật hàm `getNextFlashcardBatch` để đảm bảo `startTimer` được gọi với dữ liệu thời gian chính xác, khắc phục lỗi treo. #}
{# =============================== #}

{% extends "base.html" %}
{% block title %}Học Flashcard{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    /* ===== CSS tùy chỉnh mới cho Flashcard Session ===== */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f9fafb;
    }
    
    @media (max-width: 1024px) {
        body > footer { display: none !important; }
        body { overflow: hidden !important; }
    }

    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; 
    }

    .page-shell {
        display: flex;
        flex-direction: column;
        height: 100vh; /* Fallback */
        height: calc(var(--vh, 1vh) * 100);
        padding: 0;
        overflow: hidden; 
        padding-top: env(safe-area-inset-top);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    .session-layout {
        height: 100%;
        display: grid;
        grid-template-columns: minmax(0, 5fr) minmax(320px, 2fr);
        gap: 2rem;
        max-width: 1680px;
        margin: 0 auto;
        padding: 1.5rem 2rem 1.5rem 2rem;
        align-items: stretch;
        min-height: 0;
        flex-grow: 1;
        overflow: hidden; 
    }
    
    @media (max-width: 1024px) {
        .page-shell {
            top: var(--header-h, 0px);
            bottom: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
        }
        .session-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 0 !important;
            overflow: hidden; 
        }
        .statistics-card { display: none !important; }
        .flashcard-wrapper {
            flex: 1; 
            padding: 0 !important;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        #flashcard-content {
            flex: 1;
            padding: 0.5rem; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .flashcard-card-container, .flashcard-card, .face {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            padding: 0.1rem !important;
            overflow: hidden;
        }
        .text-area {
            flex: 1;
            overflow: auto; 
            padding: 1.5rem 1rem 1rem 1rem !important;
            margin-top: 40px; 
        }
        .actions {
            margin-top: 0.5rem !important; 
            padding: 0.5rem !important; 
            gap: 0rem;
            justify-content: center;
            width: 100%;
            overflow: hidden;
        }
        .flashcard-card {
            padding: 0.2rem !important;
        }
    }

    .flashcard-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
        overflow: hidden; 
    }

    #flashcard-content {
        flex: 1 1 auto;
        min-height: 0;
        overflow: hidden; 
    }

    .flashcard-card-container {
        perspective: 1200px;
        -webkit-perspective: 1200px;
        width: 100%;
        height: 100%;
        min-height: 300px;
        overflow: hidden; 
    }

    .flashcard-card {
        width: 100%;
        height: 100%;
        position: relative;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
        overflow: hidden; 
        transform-style: preserve-3d;
        -webkit-transform-style: preserve-3d;
        cursor: pointer;
    }
    
    .face {
        position: absolute;
        inset: 0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between; 
        gap: 10px;
        min-height: 0;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transition: transform .6s ease-in-out;
        overflow: hidden; 
    }
    
    .front { transform: rotateY(0deg); }
    .back { transform: rotateY(180deg); }
    .flashcard-card.flipped .front { transform: rotateY(180deg); }
    .flashcard-card.flipped .back { transform: rotateY(360deg); }
    
    .card-toolbar {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        margin-bottom: 0;
        padding: 10px 1.5rem 0.5rem 1.5rem;
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        z-index: 10;
    }

    .card-toolbar .label {
        text-transform: uppercase;
        text-align: center;
        font-weight: 600;
        color: #6b7280;
        letter-spacing: .06em;
        font-size: 1rem;
    }
    
    .card-toolbar .icon-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: transparent;
        color: #9ca3af;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        cursor: pointer;
        transition: color 0.2s ease, background-color 0.2s ease;
    }
    
    .card-toolbar .icon-btn:hover { background-color: #f3f4f6; color: #3b82f6; }
    .card-toolbar .icon-btn.is-active { color: #3b82f6; }
    .card-toolbar .icon-btn.is-disabled { background-color: transparent; color: #9ca3af; cursor: not-allowed; }

    .card-toolbar .play-audio-btn {
        background-color: #2563eb; color: #ffffff; width: 36px; height: 36px; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;
    }
    .card-toolbar .play-audio-btn:hover { background-color: #1d4ed8; color: #ffffff; }
    .card-toolbar .play-audio-btn.is-disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; }

    .text-area {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
        display: flex;
        align-items: center; 
        justify-content: center;
        text-align: center;
        padding: 3rem 1rem 1rem 1rem;
        margin-top: 40px;
    }
    .text-area.is-scrollable { align-items: flex-start; }

    .text-area > .flashcard-content-text { width: 100%; }
    .front .text-area .flashcard-content-text { font-size: 2.2rem; font-weight: 700; color: #1f2937; }
    .back .text-area .flashcard-content-text { text-align: left; font-size: 22px; line-height: 1.5; color: #111827; white-space: pre-wrap; }

    .media-container {
        flex: 0 0 auto;
        max-height: 40vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-top: 1px solid #e5e7eb;
        padding: 10px;
        position: relative;
        overflow: hidden;
    }
    .media-container.hidden { display: none; }
    .media-container img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }

    .media-close {
        position: absolute; top: 8px; left: 8px; background: rgba(0, 0, 0, .55); color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 16px; line-height: 28px; text-align: center; cursor: pointer;
    }

    .actions {
        display: none; gap: .75rem; justify-content: center; padding: 1rem 1.5rem; position: relative; width: 100%; bottom: 0; left: 0; background: #fff; border-top: 1px solid #e5e7eb; flex-shrink: 0; overflow: hidden;
    }
    .actions.visible { display: flex; }
    
    .btn {
        border: none; color: #fff; font-weight: 700; padding: .75rem 1.2rem; border-radius: 9999px; box-shadow: 0 1px 2px rgba(0, 0, 0, .06); cursor: pointer; font-size: 1rem; flex-grow: 1; flex-shrink: 1; flex-basis: 0; white-space: nowrap; 
    }

    .btn-quên { background: #ef4444; } .btn-mơ-hồ { background: #f59e0b; } .btn-nhớ { background: #10b981; }
    .btn-fail { background-color: #ef4444; } .btn-hard { background-color: #f59e0b; } .btn-good { background-color: #10b981; } .btn-easy { background-color: #22c55e; } .btn-very-hard { background-color: #dc2626; } .btn-medium { background-color: #facc15; } .btn-very-easy { background-color: #10b981; }
    
    @media (max-width: 768px) {
        .btn { font-size: 0.8rem; padding: 0.6rem 0.8rem; }
        .actions[data-button-count="3"] { display: flex !important; flex-wrap: nowrap; justify-content: space-around; }
        .actions[data-button-count="4"] { display: flex !important; flex-wrap: nowrap; justify-content: space-around; }
        .actions[data-button-count="6"] { display: grid !important; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    }

    #flashcard-buttons { display: none !important; }

    /* THIẾT KẾ LẠI: Khu vực thống kê */
    @media (min-width: 1024px) {
        .statistics-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            gap: 1.5rem;
        }

        .stat-header, .stat-breakdown, .stat-card, #current-card-stats {
            width: 100%;
        }

        .stat-header {
            text-align: center;
        }

        .stat-header .main-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.75rem;
            border: 1px solid #f3f4f6;
        }

        .stat-header .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-header .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
        }

        .stat-header .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-header .stat-value .fas {
            font-size: 1.1rem;
        }
        
        .stat-header .text-green-500 { color: #22c55e; }

        .stat-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .stat-card {
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.75rem;
            text-align: center;
            border: 1px solid #f3f4f6;
        }
        
        .stat-card .fas { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .stat-card .stat-label { font-size: 0.75rem; color: #6b7280; font-weight: 500; }
        .stat-card .stat-value { font-size: 1.25rem; font-weight: 700; }

        .stat-card.green { color: #15803d; background-color: #f0fdf4; border-color: #dcfce7; }
        .stat-card.amber { color: #b45309; background-color: #fffbeb; border-color: #fef3c7; }
        .stat-card.red { color: #b91c1c; background-color: #fef2f2; border-color: #fee2e2; }

    }
    
    .custom-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .custom-modal-content {
      background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; max-width: 400px;
    }

    .progress-bar-group { margin-bottom: 1rem; }
    .progress-bar-label { font-size: 0.875rem; font-weight: 600; color: #374151; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
    .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1.25rem; }
    .progress-bar-fill { height: 100%; width: 0%; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 700; white-space: nowrap; }
    .progress-bar-fill-correct { background-color: #10b981; } .progress-bar-fill-vague { background-color: #f59e0b; } .progress-bar-fill-incorrect { background-color: #ef4444; }

    @media (max-width: 640px) {
        .front .text-area .flashcard-content-text { font-size: 1.8rem; }
        .back .text-area .flashcard-content-text { font-size: 18px; }
        .session-layout { padding: 0.5rem; }
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="session-layout">
    <div class="flashcard-wrapper">
      <div id="flashcard-content">
        <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>
      </div>
      <div id="flashcard-buttons" class="mt-3"></div>
    </div>

    {# KHU VỰC THỐNG KÊ ĐÃ THIẾT KẾ LẠI #}
    <div class="statistics-card">
        <div class="stat-header">
            <h3 class="text-lg font-semibold text-center text-gray-800 mb-4">Thống kê phiên học</h3>
            <div class="main-stats">
                <div class="stat-item">
                    <span class="stat-label">Tổng điểm</span>
                    <span id="user-total-score" class="stat-value"><i class="fas fa-star text-yellow-400"></i>0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Điểm phiên này</span>
                    <span id="session-score" class="stat-value text-green-500">+0</span>
                </div>
            </div>
            <div class="mt-3 text-center text-gray-600 font-semibold" id="session-progress">0 / 0</div>
        </div>
        
        <div class="stat-breakdown">
            <div class="stat-card green">
                <i class="fas fa-check-circle"></i>
                <div id="session-correct-count" class="stat-value">0</div>
                <div class="stat-label">Thẻ Nhớ</div>
            </div>
            <div class="stat-card amber">
                <i class="fas fa-question-circle"></i>
                <div id="session-vague-count" class="stat-value">0</div>
                <div class="stat-label">Thẻ Mơ hồ</div>
            </div>
            <div class="stat-card red">
                <i class="fas fa-times-circle"></i>
                <div id="session-incorrect-count" class="stat-value">0</div>
                <div class="stat-label">Thẻ Quên</div>
            </div>
        </div>

        <hr class="my-2">
        <h3 class="text-lg font-semibold text-center text-gray-800 mb-2">Thống kê thẻ trước đó</h3>
        <div id="current-card-stats" class="flex-grow space-y-4">
            <div class="text-center text-gray-500 p-4">
                <i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.
            </div>
        </div>

        <div class="mt-auto pt-4 flex justify-center">
            <button id="end-session-btn" class="w-full px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 shadow-sm transition-colors">Kết thúc phiên</button>
        </div>
    </div>
  </div>
</div>

<div id="endSessionModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <p class="text-lg font-semibold text-gray-800 mb-4">Bạn có chắc chắn muốn kết thúc phiên học hiện tại?</p>
    <p class="text-sm text-gray-600 mb-6">Tiến độ của thẻ chưa trả lời sẽ không được lưu.</p>
    <div class="flex justify-center space-x-4">
      <button id="confirmEndSessionBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Kết thúc</button>
      <button id="cancelEndSessionBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Hủy bỏ</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    function setViewportHeight() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setViewportHeight();
    window.addEventListener('resize', setViewportHeight);
    
    function updateFixedHeights(){
      const header=document.querySelector('header');
      const mainElement = document.querySelector('main');
      const footer=document.querySelector('footer');
      const hh=header?header.offsetHeight:0;
      const fh=footer?footer.offsetHeight:0;
      document.documentElement.style.setProperty('--header-h', hh+'px');
      document.documentElement.style.setProperty('--footer-h', fh+'px');
    }

    let currentFlashcardBatch = [];
    let currentFlashcardIndex = 0;
    let previousCardStats = null; 
    let initialTotalScore = {{ initial_total_score | default(0) }};
    let sessionScoreGained = 0;

    const flashcardContentDiv = document.getElementById('flashcard-content');
    const endSessionBtn = document.getElementById('end-session-btn');
    const userTotalScoreEl = document.getElementById('user-total-score');
    const sessionScoreEl = document.getElementById('session-score');
    const sessionProgressEl = document.getElementById('session-progress');
    const sessionCorrectCountEl = document.getElementById('session-correct-count');
    const sessionVagueCountEl = document.getElementById('session-vague-count');
    const sessionIncorrectCountEl = document.getElementById('session-incorrect-count');
    const currentCardStatsDiv = document.getElementById('current-card-stats');

    const endSessionModal = document.getElementById('endSessionModal');
    const confirmEndSessionBtn = document.getElementById('confirmEndSessionBtn');
    const cancelEndSessionBtn = document.getElementById('cancelEndSessionBtn');

    const getFlashcardBatchUrl = "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}";
    const submitAnswerUrl = "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}";
    const endSessionUrl = "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}";
    const regenerateAudioUrl = "{{ url_for('learning.flashcard_learning.regenerate_audio_from_content') }}";
    const userButtonCount = {{ user_button_count }};

    function formatTextForHtml(text){
      if (text == null) return '';
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML.replace(/\r?\n/g,'<br>');
    }

    function adjustContentAlignment(card) {
        if (!card) return;
        const textArea = card.querySelector('.back .text-area');
        if (textArea) {
            const isScrollable = textArea.scrollHeight > textArea.clientHeight;
            if (isScrollable) {
                textArea.classList.add('is-scrollable');
            } else {
                textArea.classList.remove('is-scrollable');
            }
        }
    }

    /**
     * Cập nhật giao diện thống kê phiên học.
     */
    function updateSessionSummary(data) {
        sessionScoreGained = (data.updated_total_score || initialTotalScore) - initialTotalScore;
        
        userTotalScoreEl.innerHTML = `<i class="fas fa-star text-yellow-400"></i>${data.updated_total_score}`;
        sessionScoreEl.textContent = `+${sessionScoreGained}`;
        sessionProgressEl.textContent = `${data.session_total_answered} / ${data.total_items_in_session}`;
        sessionCorrectCountEl.textContent = data.session_correct_answers;
        sessionVagueCountEl.textContent = data.session_vague_answers;
        sessionIncorrectCountEl.textContent = data.session_incorrect_answers;
    }

    // KHÔI PHỤC: Hàm startTimer (không có hiển thị)
    let sessionTimerInterval = null;
    function startTimer(startTimeIso) {
        if (sessionTimerInterval) clearInterval(sessionTimerInterval);
        const startTime = new Date(startTimeIso);
        sessionTimerInterval = setInterval(() => {
            // Hàm này vẫn chạy nhưng không cập nhật phần tử nào đã bị xóa
        }, 1000);
    }

    function adjustFontSize(){
      const scrollArea = document.querySelector('.back .text-area');
      const txt = document.querySelector('.back .flashcard-content-text');
      const card = document.getElementById('flashcard-card');
      if (!scrollArea || !txt || !card) return;
      txt.style.fontSize = '';
      const isOverflow = () => scrollArea.scrollHeight > scrollArea.clientHeight;
      let current = parseFloat(getComputedStyle(txt).fontSize) || 22;
      const min = 18;
      while (isOverflow() && current > min) {
        current -= 1;
        txt.style.fontSize = current + 'px';
      }
      adjustContentAlignment(card);
    }

    function generateDynamicButtons(buttonCount) {
        let buttonsHtml = '';
        const buttonSets = {
            3: [
                { class: 'btn-quên', text: 'Quên', value: 'quên' },
                { class: 'btn-mơ-hồ', text: 'Mơ hồ', value: 'mơ_hồ' },
                { class: 'btn-nhớ', text: 'Nhớ', value: 'nhớ' }
            ],
            4: [
                { class: 'btn-fail', text: 'Học lại', value: 'again' },
                { class: 'btn-hard', text: 'Khó', value: 'hard' },
                { class: 'btn-good', text: 'Bình thường', value: 'good' },
                { class: 'btn-easy', text: 'Dễ', value: 'easy' }
            ],
            6: [
                { class: 'btn-fail', text: 'Rất khó', value: 'fail' },
                { class: 'btn-very-hard', text: 'Khó', value: 'very_hard' },
                { class: 'btn-hard', text: 'Trung bình', value: 'hard' },
                { class: 'btn-medium', text: 'Dễ', value: 'medium' },
                { class: 'btn-good', text: 'Rất dễ', value: 'good' },
                { class: 'btn-very-easy', text: 'Dễ dàng', value: 'very_easy' }
            ]
        };
        const buttons = buttonSets[buttonCount] || buttonSets[3];
        buttons.forEach(btn => {
            buttonsHtml += `<button class="btn ${btn.class}" data-answer="${btn.value}">${btn.text}</button>`;
        });
        return buttonsHtml;
    }

    function renderCard(data){
      const c = data.content;
      const itemId = data.item_id;
      const fTxt = c.front || '';
      const bTxt = c.back || '';
      
      const hasFrontAudio = c.front_audio_url || c.front_audio_content;
      const hasBackAudio = c.back_audio_url || c.back_audio_content;

      const buttonsHtml = generateDynamicButtons(userButtonCount);
      
      const html = `
      <div class="flashcard-card-container">
        <div id="flashcard-card" class="flashcard-card">
          <div class="face front">
            <div class="card-toolbar">
                <button class="icon-btn edit-card-btn"><i class="fas fa-pencil-alt"></i></button>
                <span class="label">MẶT TRƯỚC</span>
                <button class="icon-btn play-audio-btn ${hasFrontAudio ? '' : 'is-disabled'}" data-audio-target="#front-audio" data-side="front" data-item-id="${itemId}" data-content-to-read="${c.front_audio_content || ''}" ${hasFrontAudio ? '' : 'disabled'}><i class="fas fa-volume-up"></i></button>
            </div>
            <div class="text-area">
              <div class="flashcard-content-text">${formatTextForHtml(fTxt)}</div>
            </div>
            ${c.front_img ? `<div class="media-container"><img src="${c.front_img}" alt="Mặt trước" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';"></div>` : ''}
            <audio id="front-audio" class="hidden" src="${c.front_audio_url || ''}"></audio>
          </div>
          <div class="face back">
            <div class="card-toolbar">
                <button class="icon-btn edit-card-btn is-disabled"><i class="fas fa-pencil-alt"></i></button>
                <span class="label">MẶT SAU</span>
                <button class="icon-btn play-audio-btn ${hasBackAudio ? '' : 'is-disabled'}" data-audio-target="#back-audio" data-side="back" data-item-id="${itemId}" data-content-to-read="${c.back_audio_content || ''}" ${hasBackAudio ? '' : 'disabled'}><i class="fas fa-volume-up"></i></button>
            </div>
            <div class="text-area">
              <div class="flashcard-content-text">${formatTextForHtml(bTxt)}</div>
            </div>
            ${c.back_img ? `<div class="media-container"><img src="${c.back_img}" alt="Mặt sau" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';"></div>` : ''}
            <div class="actions" id="internal-actions" data-button-count="${userButtonCount}">
              ${buttonsHtml}
            </div>
            <audio id="back-audio" class="hidden" src="${c.back_audio_url || ''}"></audio>
          </div>
        </div>
      </div>`;

      flashcardContentDiv.innerHTML = html;

      const card = document.getElementById('flashcard-card');
      const actions = document.getElementById('internal-actions');
      card.addEventListener('click', () => {
        card.classList.toggle('flipped');
        if (card.classList.contains('flipped')) {
            actions?.classList.add('visible');
            setTimeout(() => adjustContentAlignment(card), 0);
        } else {
            actions?.classList.remove('visible');
        }
        setTimeout(adjustFontSize, 0);
      });

      document.querySelectorAll('.btn').forEach(b => b.addEventListener('click', ev => {
        ev.stopPropagation();
        submitFlashcardAnswer(data.item_id, b.dataset.answer);
      }));
      
      document.querySelectorAll('.play-audio-btn').forEach(btn => {
        btn.addEventListener('click', ev => {
          ev.stopPropagation();
          const audioPlayer = document.querySelector(btn.dataset.audioTarget);
          if (btn.classList.contains('is-disabled')) { return; }
          if (audioPlayer.src && audioPlayer.src !== window.location.href) {
            if (audioPlayer.paused) { audioPlayer.play(); } else { audioPlayer.pause(); audioPlayer.currentTime = 0; }
          } else {
            generateAndPlayAudio(btn, audioPlayer);
          }
        });
      });
      setTimeout(() => adjustContentAlignment(card), 0);
    }

    async function generateAndPlayAudio(button, audioPlayer) {
      const itemId = button.dataset.itemId;
      const side = button.dataset.side;
      const contentToRead = button.dataset.contentToRead;
      
      button.classList.add('is-disabled');
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

      try {
        const response = await fetch(regenerateAudioUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ item_id: itemId, side: side, content_to_read: contentToRead })
        });
        const result = await response.json();

        if (result.success && result.audio_url) {
          audioPlayer.src = result.audio_url;
          audioPlayer.load(); 
          audioPlayer.oncanplay = () => {
            audioPlayer.play();
            button.classList.remove('is-disabled');
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
          };
          audioPlayer.onerror = () => {
             showCustomAlert('Không thể phát file âm thanh. Vui lòng thử lại.');
             button.classList.remove('is-disabled');
             button.innerHTML = '<i class="fas fa-volume-up"></i>';
          };
        } else {
          showCustomAlert(result.message || 'Lỗi khi tạo audio.');
          button.classList.remove('is-disabled');
          button.innerHTML = '<i class="fas fa-volume-up"></i>';
        }
      } catch (error) {
        console.error('Lỗi khi tạo audio:', error);
        showCustomAlert('Không thể kết nối đến máy chủ để tạo audio.');
        button.classList.remove('is-disabled');
        button.innerHTML = '<i class="fas fa-volume-up"></i>';
      }
    }

    function renderCardStats(stats, scoreChange) {
        if (!stats) {
            currentCardStatsDiv.innerHTML = `<div class="text-center text-gray-500 p-4"><i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.</div>`;
            return;
        }
        
        const totalReviews = stats.times_reviewed || 0;
        const correctCount = stats.correct_count || 0;
        const vagueCount = stats.vague_count || 0;
        const correctPercentage = totalReviews > 0 ? (correctCount / totalReviews) * 100 : 0;
        const vaguePercentage = totalReviews > 0 ? ((vagueCount || 0) / totalReviews) * 100 : 0;
        const incorrectPercentage = 100 - correctPercentage - vaguePercentage;
        
        const dueTime = stats.next_review ? new Date(stats.next_review).toLocaleString('vi-VN', { dateStyle: 'medium', timeStyle: 'short' }) : 'Chưa có';
        const scoreChangeColor = scoreChange > 0 ? 'text-green-600' : (scoreChange < 0 ? 'text-red-600' : 'text-gray-600');
        const scoreChangeSign = scoreChange > 0 ? '+' : '';

        let statsHtml = `
            <div class="space-y-2 text-sm">
                <div class="flex justify-between items-center"><span>Điểm:</span><span class="font-semibold ${scoreChangeColor}">${scoreChangeSign}${scoreChange}</span></div>
                <div class="flex justify-between items-center"><span>Trạng thái:</span><span class="font-semibold">${stats.status}</span></div>
                <div class="flex justify-between items-center"><span>Hệ số dễ (EF):</span><span class="font-semibold">${stats.easiness_factor}</span></div>
                <div class="flex justify-between items-center"><span>Lặp lại (n):</span><span class="font-semibold">${stats.repetitions}</span></div>
                <div class="flex justify-between items-center"><span>Khoảng thời gian (I):</span><span class="font-semibold">${stats.interval} ngày</span></div>
                <div class="flex justify-between items-center"><span>Đến hạn ôn lại:</span><span class="font-semibold text-right">${dueTime}</span></div>
            </div>
        `;
        currentCardStatsDiv.innerHTML = statsHtml;
    }

    async function getNextFlashcardBatch(){
      if (previousCardStats) {
        renderCardStats(previousCardStats.stats, previousCardStats.scoreChange);
        previousCardStats = null;
      } else {
        currentCardStatsDiv.innerHTML = `<div class="text-center text-gray-500 p-4"><i class="fas fa-info-circle mr-2"></i> Trả lời thẻ để xem thống kê.</div>`;
      }
      
      flashcardContentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>`;

      try {
        const res = await fetch(getFlashcardBatchUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
        if (!res.ok) {
          if (res.status === 404) {
            const end = await res.json();
            flashcardContentDiv.innerHTML = `
              <div class="text-center py-12 text-gray-600">
                <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Hoàn thành phiên học!</h3>
                <p class="text-gray-500">${formatTextForHtml(end.message)}</p>
                <button id="return-to-dashboard-btn" class="mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-sm">
                  <i class="fas fa-home mr-2"></i> Quay lại Dashboard
                </button>
              </div>`;
            document.getElementById('return-to-dashboard-btn').addEventListener('click', () => {
              window.location.href = "{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}";
            });
            return;
          }
          throw new Error('HTTP ' + res.status);
        }
        const batch = await res.json();
        currentFlashcardBatch = batch.items;
        currentFlashcardIndex = 0;
        
        initialTotalScore = batch.initial_total_score || {{ initial_total_score | default(0) }};
        
        // SỬA: Khởi tạo/Cập nhật thông tin thống kê ban đầu
        updateSessionSummary({
            updated_total_score: initialTotalScore,
            session_total_answered: batch.session_total_answered || 0,
            total_items_in_session: batch.total_items_in_session || 0,
            session_correct_answers: batch.session_correct_answers || 0,
            session_vague_answers: batch.session_vague_answers || 0,
            session_incorrect_answers: batch.session_incorrect_answers || 0
        });

        // SỬA: Đảm bảo startTimer được gọi với giá trị hợp lệ
        if (batch.start_time) {
            startTimer(batch.start_time);
        }

        renderCard(currentFlashcardBatch[currentFlashcardIndex]);
        
      } catch (e) {
        console.error('Lỗi khi tải nhóm thẻ:', e);
        flashcardContentDiv.innerHTML = `<p class='text-red-500 text-center'>Không thể tải thẻ. Vui lòng thử lại.</p>`;
      }
    }

    async function submitFlashcardAnswer(itemId, answer){
      try {
        const res = await fetch(submitAnswerUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ item_id: itemId, user_answer: answer })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        
        if (data.session_total_answered === 1) {
            initialTotalScore = data.updated_total_score - data.score_change;
        }

        updateSessionSummary(data);
        
        if (data.statistics) {
            previousCardStats = {
              stats: data.statistics,
              scoreChange: data.score_change
            };
        }

        currentFlashcardIndex++;
        getNextFlashcardBatch();
      } catch (e) {
        console.error('Lỗi khi gửi đáp án:', e);
        showCustomAlert('Có lỗi khi gửi đáp án. Vui lòng thử lại.');
      }
    }

    endSessionBtn.addEventListener('click', () => {
      endSessionModal.style.display = 'flex';
    });

    confirmEndSessionBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(endSessionUrl, { method: 'POST' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const r = await res.json();
        window.showFlashMessage(r.message || 'Đã kết thúc phiên.', 'info');
        window.location.href = "{{ url_for('learning.flashcard_learning.flashcard_learning_dashboard') }}";
      } catch (e) {
        window.showFlashMessage('Có lỗi xảy ra khi kết thúc phiên.', 'danger');
      } finally {
        endSessionModal.style.display = 'none';
      }
    });

    cancelEndSessionBtn.addEventListener('click', () => {
      endSessionModal.style.display = 'none';
    });

    function showCustomAlert(message) {
      const modalHtml = `
          <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
              <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                  <p class="text-lg font-semibold text-gray-800 mb-4">${formatTextForHtml(message)}</p>
                  <button id="custom-alert-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">OK</button>
              </div>
          </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.getElementById('custom-alert-ok-btn').addEventListener('click', () => {
          document.getElementById('custom-alert-modal').remove();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('flashcard-session-active');
      getNextFlashcardBatch();
    });
  </script>
{% endblock %}

