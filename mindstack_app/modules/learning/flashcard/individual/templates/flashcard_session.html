{#
    # File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html
    # Phiên bản: 69.1
    # MỤC ĐÍCH: Thay đổi vị trí nút Feedback.
    # ĐÃ SỬA: Di chuyển nút Feedback từ toolbar bên trái sang bên phải, đặt cạnh nút Sửa thẻ.
#}

{% extends "base.html" %}
{% from 'includes/_navbar.html' import render_navbar %}
{% block title %}Học Flashcard{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    /* ===== CSS tùy chỉnh mới cho Flashcard Session ===== */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f9fafb;
    }

    :root {
        --flashcard-shell-gap: clamp(24px, 3vw, 32px);
        --flashcard-header-height: 0px;
        --flashcard-footer-height: 0px;
    }

    /* Ghi đè CSS từ base.html để ẩn footer chỉ trên trang này khi ở màn hình nhỏ */
    @media (max-width: 1024px) {
        body > footer {
            display: none !important;
        }
    }

    /* ===== Layout toàn trang (full height) - ĐÃ CẬP NHẬT ===== */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        overflow: hidden;
    }

    body.flashcard-session-active > main {
        padding: 0 !important;
        margin: 0;
        width: 100%;
        max-width: none;
        display: flex;
        flex-direction: column;
        flex: 1 1 auto;
        min-height: 0;
        overflow: hidden;
    }

    .page-shell {
        display: flex;
        flex-direction: column;
        flex: 1 1 auto;
        min-height: 0;
        padding: 0;
        overflow: hidden;
        box-sizing: border-box;
        height: 100%;
        min-height: calc(100vh - var(--flashcard-header-height, 0px) - var(--flashcard-footer-height, 0px));
    }

    .card-surface {
        background: #ffffff;
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 18px;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .flashcard-panel {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        height: 100%;
        padding: 1.25rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(248, 250, 252, 0.96));
    }

    .page-title {
        color: #1f2937;
        margin-bottom: 2rem;
        font-size: 2.25rem;
        font-weight: 800;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .page-title .text-gray-500 {
        font-size: 1.25rem;
        margin-left: 0.5rem;
        font-weight: 600;
        text-transform: none;
        letter-spacing: normal;
    }
    /* ===== Lưới 2 cột cho session layout (chuyển thành 1 cột trên mobile) ===== */
    .session-layout {
        height: 100%;
        display: grid;
        grid-template-columns: minmax(0, 5fr) minmax(400px, 2fr);
        gap: 2rem;
        max-width: 1680px;
        margin: 0 auto;
        padding: var(--flashcard-shell-gap) clamp(24px, 2vw, 32px) calc(var(--flashcard-shell-gap) * 2) clamp(24px, 2vw, 32px);
        align-items: stretch;
        min-height: 0;
        flex-grow: 1;
        box-sizing: border-box;
        /* THAY ĐỔI: Cố định layout */
        overflow: hidden;
        min-height: calc(100vh - var(--flashcard-header-height, 0px) - var(--flashcard-footer-height, 0px) - var(--flashcard-shell-gap));
    }

    @media (max-width: 1024px) {
        /* Bố cục trên màn màn hình di động */
        .page-shell {
            top: var(--header-h, 0px);
            bottom: 0;
            padding: 0.05rem 0.05rem 0;
            height: calc(var(--vh, 1vh) * 100);
            min-height: calc(var(--vh, 1vh) * 100);
        }
        .session-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 0.1rem 0.15rem 0.2rem !important;
            overflow: hidden; /* Quan trọng: Loại bỏ cuộn trên layout chính */
        }
        .stats-modal-body .statistics-card { display:block !important; }

        .session-layout > .statistics-card {
            display: none !important;
        }
        .flashcard-wrapper {
            flex: 1; /* Chiếm hết không gian còn lại */
            padding: 0 !important;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #flashcard-content {
            flex: 1;
            padding: 0.15rem; /* Thêm padding nhẹ để nội dung không bị sát viền */
        }
        .flashcard-card-container, .flashcard-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Căn trên và dưới */
        }
        .face {
            /* SỬA LỖI 2: Đảm bảo có đủ padding cho thanh toolbar trên di động */
            padding: calc(64px + env(safe-area-inset-top, 0px)) 0.1rem 0.2rem 0.1rem !important;
        }
        ._card-container {
            /* THÊM MỚI: Tối ưu layout nội dung trên mobile */
            padding: 0.05rem !important;
        }
        .text-area {
            flex: 1;
            padding: 0.1rem 0.05rem !important;
        }
        .actions {
            margin-top: 0.5rem !important;
            padding: 0.15rem 0.15rem !important;
            gap: 0.15rem;
            justify-content: center;
            width: 100%;
        }
        .flashcard-card {
            padding: 0.05rem !important;
        }
        .flashcard-panel {
            padding: 0.35rem 0.25rem 0.45rem;
            gap: 0.55rem;
        }
    }

    /* ===== Wrapper cho thẻ Flashcard ===== */
    .flashcard-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
        position: relative;
        overflow: hidden;
    }

    #flashcard-content {
        flex: 1 1 auto;
        min-height: 0;
    }

    /* ===== Thẻ: Flip 3D (xoay TOÀN BỘ thẻ) ===== */
    .flashcard-card-container {
        perspective: 1200px;
        -webkit-perspective: 1200px;
        width: 100%;
        height: 100%;
        min-height: 300px;
    }

    .flashcard-card {
        width: 100%;
        height: 100%;
        position: relative;
        background-color: #ffffff;
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 18px;
        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.08);
        overflow: hidden;
        transform-style: preserve-3d;
        -webkit-transform-style: preserve-3d;
        transition: box-shadow .3s ease, transform .3s ease;
        --card-accent-bg: linear-gradient(135deg, #6366f1, #2563eb);
        --card-accent-hover-bg: linear-gradient(135deg, #4f46e5, #1d4ed8);
        --card-accent-rgb: 37, 99, 235;
        --card-accent-shadow: 0 16px 32px rgba(var(--card-accent-rgb), 0.22);
        --card-accent-hover-shadow: 0 20px 40px rgba(var(--card-accent-rgb), 0.3);
    }

    .flashcard-card::before {
        content: "";
        position: absolute;
        inset: -1px;
        border-radius: inherit;
        background: transparent;
        opacity: 0;
        pointer-events: none;
        z-index: 0;
    }

    .flashcard-card:hover {
        box-shadow: 0 28px 56px rgba(var(--card-accent-rgb), 0.25);
        transform: translateY(-3px);
    }

    .flashcard-card[data-card-category="new"] {
        --card-accent-bg: linear-gradient(135deg, #34d399, #10b981);
        --card-accent-hover-bg: linear-gradient(135deg, #22c55e, #059669);
        --card-accent-rgb: 34, 197, 94;
    }

    .flashcard-card[data-card-category="due"] {
        --card-accent-bg: linear-gradient(135deg, #facc15, #f97316);
        --card-accent-hover-bg: linear-gradient(135deg, #f59e0b, #ea580c);
        --card-accent-rgb: 249, 115, 22;
    }

    .flashcard-card[data-card-category="hard"] {
        --card-accent-bg: linear-gradient(135deg, #fb7185, #ef4444);
        --card-accent-hover-bg: linear-gradient(135deg, #f43f5e, #dc2626);
        --card-accent-rgb: 239, 68, 68;
    }

    .flashcard-card[data-card-category="default"] {
        --card-accent-bg: linear-gradient(135deg, #6366f1, #2563eb);
        --card-accent-hover-bg: linear-gradient(135deg, #4f46e5, #1d4ed8);
        --card-accent-rgb: 37, 99, 235;
    }

    .face {
        position: absolute;
        inset: 0;
        /* ĐÃ SỬA: Tăng padding-top để tạo khoảng trống an toàn cho toolbar */
        padding: 72px 1.25rem 1.25rem 1.25rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 10px;
        min-height: 0;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transition: transform .6s ease-in-out, opacity .3s ease-in-out;
        z-index: 1;
        opacity: 0;
        pointer-events: none;
    }

    .front {
        transform: rotateY(0deg);
    }

    .back {
        transform: rotateY(180deg);
    }

    .flashcard-card:not(.flipped) .front {
        opacity: 1;
        pointer-events: auto;
    }

    .flashcard-card:not(.flipped) .back {
        opacity: 0;
        pointer-events: none;
    }

    .flashcard-card.flipped .front {
        transform: rotateY(180deg);
        opacity: 0;
        pointer-events: none;
    }

    .flashcard-card.flipped .back {
        transform: rotateY(360deg);
        opacity: 1;
        pointer-events: auto;
    }

    .card-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        z-index: 10;
        background: rgba(255, 255, 255, 0.94);
        border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        backdrop-filter: blur(8px);
    }

    .toolbar-left, .toolbar-right {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        flex: 1;
        min-width: 0;
        flex-wrap: wrap;
    }

    .toolbar-right {
        justify-content: flex-end;
    }

    .card-toolbar .label {
        text-transform: uppercase;
        text-align: center;
        font-weight: 700;
        color: #475569;
        letter-spacing: .08em;
        font-size: 0.95rem;
        padding: 0;
        background: transparent;
        border: none;
        box-shadow: none;
        border-radius: 0;
        flex: 1;
        min-width: 120px;
        max-width: 100%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }

    .card-toolbar .icon-btn {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background-color: #f8fafc;
        color: #475569;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.05rem;
        cursor: pointer;
        border: 1px solid rgba(148, 163, 184, 0.28);
        transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        flex-shrink: 0;
    }

    @media (max-width: 640px) {
        .card-toolbar {
            padding: 0.4rem 0.55rem;
            gap: 0.35rem;
            row-gap: 0.25rem;
            column-gap: 0.25rem;
        }
        .toolbar-left, .toolbar-right {
            gap: 0.2rem;
            flex: 1 1 0;
        }
        .card-toolbar .label {
            font-size: 0.75rem;
            padding: 0.2rem 0.45rem;
            min-width: 82px;
            flex: 0 1 auto;
        }
        .card-toolbar .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        .actions .btn {
            padding: 0.75rem 0.85rem;
            font-size: 0.95rem;
        }
    }

    .card-toolbar .icon-btn:hover {
        background-color: #eef2ff;
        color: rgba(var(--card-accent-rgb), 1);
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(var(--card-accent-rgb), 0.12);
    }
    .card-toolbar .icon-btn.is-active {
        color: rgba(var(--card-accent-rgb), 1);
        background: #eef2ff;
    }
    .card-toolbar .icon-btn.is-disabled {
        background-color: #f1f5f9;
        color: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    .card-toolbar .play-audio-btn {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: none;
        background: var(--card-accent-bg);
        color: #ffffff;
        font-size: 1rem;
        box-shadow: var(--card-accent-shadow);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .card-toolbar .play-audio-btn:hover {
        background: var(--card-accent-hover-bg);
        color: #ffffff;
        box-shadow: var(--card-accent-hover-shadow);
        transform: translateY(-1px);
    }
    .card-toolbar .play-audio-btn.is-disabled {
        background-color: rgba(148, 163, 184, 0.35);
        color: #e5e7eb;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    @media (max-width: 1024px) {
        .card-toolbar {
            padding: calc(0.3rem + env(safe-area-inset-top, 0px)) 0.4rem 0.4rem;
            gap: 0.35rem;
        }
        .toolbar-left,
        .toolbar-right {
            gap: 0.2rem;
            flex-wrap: nowrap;
        }
        .card-toolbar .label {
            font-size: 0.74rem;
            min-width: 76px;
            padding: 0.25rem 0.4rem;
            letter-spacing: 0.04em;
            flex: 0 1 auto;
        }
        .card-toolbar .icon-btn {
            width: 34px;
            height: 34px;
            font-size: 0.9rem;
        }
        .card-toolbar .play-audio-btn {
            width: 36px;
            height: 36px;
            border-radius: 11px;
            padding: 0;
        }
    }

    /* Cấu trúc mới cho nội dung thẻ */
    ._card-container {
        justify-content: flex-start;
        align-items: stretch;
        flex: 1 1 auto;
        min-height: 0;
        padding: 0 0.85rem;
        margin-top: 0;
        display: flex;
        flex-direction: column;
    }

    .text-area {
        flex-grow: 1;
        min-height: 0;
        width: 100%;
        overflow-y: auto;
        padding: 1rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Ghi đè lại text-align cho mặt sau để căn trái khi có nhiều dòng */
    .back .text-area .flashcard-content-text {
        text-align: left;
    }
    
    /* THÊM MỚI: CSS cho trạng thái có cuộn */
    .text-area.has-scroll {
        justify-content: flex-start;
        align-items: flex-start;
    }
    
    .front .text-area .flashcard-content-text {
        font-size: 2.2rem;
        font-weight: 700;
        color: #1f2937;
    }

    .back .text-area .flashcard-content-text {
        font-size: 22px;
        line-height: 1.5;
        color: #111827;
        white-space: pre-wrap;
    }
    
    .media-container {
        flex-shrink: 0;
        padding: 1rem;
        width: 100%;
        text-align: center;
        position: relative;
        max-height: 40%;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #f8fafc;
    }
    
    .media-container.hidden {
        display: none;
    }
    
    .media-container img {
        max-width: 100%;
        height: auto;
        max-height: 100%;
        object-fit: contain;
        display: block;
        margin: auto;
    }


    /* Nút đánh giá trong thẻ */
    .actions {
        display: none;
        gap: 1rem;
        justify-content: center;
        padding: 1.25rem 1.5rem;
        position: relative;
        width: 100%;
        bottom: 0;
        left: 0;
        background: linear-gradient(180deg, #f8fafc 0%, #ffffff 55%);
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -18px 40px rgba(15, 23, 42, 0.08);
        flex-shrink: 0;
        z-index: 2;
    }

    .actions.visible {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
        grid-auto-rows: 1fr;
        align-items: stretch;
    }

    .actions.visible[data-button-count="3"] {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .actions.visible[data-button-count="4"] {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .actions.visible[data-button-count="6"] {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .btn {
        border: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        border-radius: 0.9rem;
        cursor: pointer;
        font-size: 1rem;
        transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
        text-decoration: none;
    }

    .btn:focus {
        outline: none;
    }

    .actions .btn {
        width: 100%;
        min-width: 0;
        max-width: 100%;
        white-space: normal;
        padding: 0.9rem 1.25rem;
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.08);
    }

    .actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12);
    }

    .actions .btn:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.28);
    }

    .actions .btn:active {
        transform: translateY(0);
        filter: saturate(1.08);
    }

    .rating-btn {
        color: #fff;
        border-radius: 0.9rem;
        padding: 0.75rem 1rem;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
        gap: 0.5rem;
        box-shadow: 0 18px 34px rgba(15, 23, 42, 0.12);
        flex-direction: row;
        text-align: left;
    }

    .rating-btn .rating-btn__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.18);
        font-size: 1.1rem;
    }

    .rating-btn .rating-btn__title {
        font-size: 0.95rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        line-height: 1;
    }

    .rating-btn--again,
    .rating-btn--fail {
        background: linear-gradient(135deg, #f87171, #dc2626);
        box-shadow: 0 18px 36px rgba(220, 38, 38, 0.32);
    }

    .rating-btn--very-hard {
        background: linear-gradient(135deg, #fb923c, #ea580c);
        box-shadow: 0 18px 36px rgba(234, 88, 12, 0.28);
    }

    .rating-btn--hard {
        background: linear-gradient(135deg, #f59e0b, #b45309);
        color: #1f2937;
    }

    .rating-btn--hard .rating-btn__icon {
        background: rgba(15, 23, 42, 0.12);
        color: #1f2937;
    }

    .rating-btn--medium {
        background: linear-gradient(135deg, #38bdf8, #2563eb);
        box-shadow: 0 18px 36px rgba(37, 99, 235, 0.28);
    }

    .rating-btn--good {
        background: linear-gradient(135deg, #34d399, #059669);
        box-shadow: 0 18px 36px rgba(5, 150, 105, 0.28);
    }

    .rating-btn--easy {
        background: linear-gradient(135deg, #4ade80, #16a34a);
        box-shadow: 0 18px 36px rgba(22, 163, 74, 0.28);
    }

    .rating-btn--very-easy {
        background: linear-gradient(135deg, #6ee7b7, #0d9488);
        box-shadow: 0 18px 36px rgba(13, 148, 136, 0.26);
    }

    .actions[data-button-count="1"] {
        display: flex !important;
        justify-content: center;
    }

    .actions[data-button-count="1"] .btn {
        min-width: 200px;
        justify-content: center;
        text-align: center;
    }

    @media (max-width: 1024px) {
        .actions {
            padding: 1rem 1.25rem;
            gap: 0.75rem;
        }
    }

    @media (max-width: 640px) {
        .actions {
            padding: 0.85rem 1rem;
            gap: 0.65rem;
        }

        .actions .btn {
            padding: 0.55rem 0.75rem;
            font-size: 0.9rem;
        }

        .rating-btn {
            padding: 0.55rem 0.75rem;
            gap: 0.4rem;
        }

        .rating-btn .rating-btn__icon {
            width: 1.6rem;
            height: 1.6rem;
            font-size: 0.9rem;
        }

        .rating-btn .rating-btn__title {
            font-size: 0.85rem;
        }
    }

    .btn-continue {
        background: linear-gradient(135deg, #2563eb, #16a34a);
        color: #fff;
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
    }

    .btn-continue:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(37, 99, 235, 0.3);
    }

    #flashcard-buttons {
        display: none !important;
    }
    
    .flip-card-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.85rem 1.75rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        background: linear-gradient(135deg, #f59e0b, #f97316);
        color: white;
        box-shadow: 0 14px 30px rgba(249, 115, 22, 0.25);
        border: none;
        letter-spacing: 0.02em;
    }
    .flip-card-btn:hover {
        background: linear-gradient(135deg, #ea580c, #f97316);
        transform: translateY(-2px);
        box-shadow: 0 18px 36px rgba(234, 88, 12, 0.35);
    }
    .flip-card-btn:focus-visible {
        outline: 3px solid rgba(var(--card-accent-rgb), 0.35);
        outline-offset: 3px;
    }


    @media (min-width: 1024px) {
        .statistics-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            overflow-y: auto;
            width: min(100%, 520px);
        }
    }

    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .custom-modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 400px;
    }

    .stats-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        z-index: 999;
        overflow-y: auto;
    }
    .stats-modal-overlay.open {
        display: block;
    }
    .stats-modal-content {
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background-color: #f9fafb;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: -4px 0 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }
    .stats-modal-content.open {
        transform: translateX(0);
    }

    .stats-modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #fff;
    }

    .stats-modal-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
    }

    .stats-modal-close-btn {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #6b7280;
    }

    .stats-modal-body {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
    }

  </style>
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="session-layout">
    <div class="flashcard-wrapper">
      <div class="card-surface">
        <div class="flashcard-panel">
          <div id="flashcard-content">
            <div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>
          </div>
          <div id="flashcard-buttons" class="mt-3"></div>
        </div>
      </div>
    </div>

    {# Nhúng bảng ghi chú #}
    {% include 'notes/_note_panel.html' %}

    {# Bao gồm file partial chứa giao diện thống kê #}
    {% include '_flashcard_session_stats.html' %}
  </div>
</div>

<div id="endSessionModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <p class="text-lg font-semibold text-gray-800 mb-4">Bạn có chắc chắn muốn kết thúc phiên học hiện tại?</p>
    <p class="text-sm text-gray-600 mb-6">Tiến độ của thẻ chưa trả lời sẽ không được lưu.</p>
    <div class="flex justify-center space-x-4">
      <button id="confirmEndSessionBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Kết thúc</button>
      <button id="cancelEndSessionBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Hủy bỏ</button>
    </div>
  </div>
</div>

<div id="statsModal" class="stats-modal-overlay">
    <div id="statsModalContent" class="stats-modal-content">
        <header class="bg-white shadow-md">
            {{ render_navbar(current_user, request) }}
        </header>
        <div class="stats-modal-header">
            <h3>Thống kê phiên học</h3>
            <button id="closeStatsModalBtn" class="stats-modal-close-btn">&times;</button>
        </div>
        <div id="statsModalBody" class="stats-modal-body">
            {# Nội dung thống kê sẽ được render vào đây #}
        </div>
    </div>
</div>

{# Nhúng modal AI #}
{% include 'ai_services/_ai_modal.html' %}

{# Nhúng modal Feedback #}
{% include 'feedback/_feedback_modal.html' %}

{% endblock %}

{% block scripts %}
  {{ super() }}

  <script src="{{ url_for('learning.flashcard_learning.static', filename='flashcard_viewport.js') }}"></script>

  <script>
    const setVh = () => {
      if (window.flashcardViewport && typeof window.flashcardViewport.refresh === 'function') {
        window.flashcardViewport.refresh();
      }

      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    };

    if (window.flashcardViewport && typeof window.flashcardViewport.refresh === 'function') {
        window.flashcardViewport.refresh();
    }

    let currentFlashcardBatch = [];
    let currentFlashcardIndex = 0;
    let previousCardStats = null; 

    let sessionScore = 0;
    let currentUserTotalScore = {{ current_user.total_score | default(0) }};

    const flashcardContentDiv = document.getElementById('flashcard-content');
    const endSessionBtn = document.getElementById('end-session-btn');
    
    const currentCardStatsContainer = document.getElementById('current-card-stats');
    const previousCardStatsContainer = document.getElementById('previous-card-stats');

    const endSessionModal = document.getElementById('endSessionModal');
    const confirmEndSessionBtn = document.getElementById('confirmEndSessionBtn');
    const cancelEndSessionBtn = document.getElementById('cancelEndSessionBtn');
    
    const statsModal = document.getElementById('statsModal');
    const statsModalContent = document.getElementById('statsModalContent');
    const closeStatsModalBtn = document.getElementById('closeStatsModalBtn');
    const statsModalBody = document.getElementById('statsModalBody');

    const getFlashcardBatchUrl = "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}";
    const flashcardItemApiUrlTemplate = "{{ url_for('learning.flashcard_learning.get_flashcard_item_api', item_id=0) }}";
    const submitAnswerUrl = "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}";
    const endSessionUrl = "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}";
    const regenerateAudioUrl = "{{ url_for('learning.flashcard_learning.regenerate_audio_from_content') }}";
    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
    const csrfHeaders = csrfToken ? { 'X-CSRFToken': csrfToken } : {};
    const userButtonCount = {{ user_button_count }};
    const isAutoplaySession = {{ 'true' if is_autoplay_session else 'false' }};
    const autoplayMode = "{{ autoplay_mode }}";
    let autoplayDelaySeconds = 2;
    let currentAutoplayToken = 0;
    let currentAutoplayTimeouts = [];
    let currentCardElements = { card: null, actions: null, flipBtn: null };

    if (isAutoplaySession) {
      try {
        const storedSettings = localStorage.getItem('flashcardAutoplaySettings');
        if (storedSettings) {
          const parsedSettings = JSON.parse(storedSettings);
          if (parsedSettings && typeof parsedSettings.delaySeconds === 'number' && parsedSettings.delaySeconds >= 0) {
            autoplayDelaySeconds = parsedSettings.delaySeconds;
          }
        }
      } catch (err) {
        console.warn('Không thể đọc cấu hình AutoPlay:', err);
      }
      document.body.classList.add('flashcard-autoplay-active');
    }
    
    const getNoteUrl = "{{ url_for('notes.get_note', item_id=0) }}";
    const saveNoteUrl = "{{ url_for('notes.save_note', item_id=0) }}";

    function formatTextForHtml(text){
      if (text == null) return '';
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML.replace(/\r?\n/g,'<br>');
    }

    function extractPlainText(text) {
      if (text == null) return '';
      if (typeof text !== 'string') {
        text = String(text);
      }
      const temp = document.createElement('div');
      temp.innerHTML = text;
      const plain = temp.textContent || temp.innerText || '';
      return plain.trim();
    }

    function playAudioAfterLoad(audioPlayer, { restart = true, awaitCompletion = false } = {}) {
      return new Promise(resolve => {
        if (!audioPlayer) {
          resolve();
          return;
        }

        const cleanup = () => {
          audioPlayer.removeEventListener('canplay', onCanPlay);
          if (awaitCompletion) {
            audioPlayer.removeEventListener('ended', onEnded);
            audioPlayer.removeEventListener('error', onError);
          }
        };

        const onEnded = () => {
          cleanup();
          resolve();
        };

        const onError = () => {
          cleanup();
          resolve();
        };

        const onCanPlay = () => {
          audioPlayer.removeEventListener('canplay', onCanPlay);
          if (restart) {
            try {
              audioPlayer.pause();
              audioPlayer.currentTime = 0;
            } catch (err) {
              console.warn('Không thể đặt lại audio:', err);
            }
          }
          const playPromise = audioPlayer.play();
          if (!awaitCompletion) {
            cleanup();
            if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch(() => {});
            }
            resolve();
          } else if (playPromise && typeof playPromise.catch === 'function') {
            playPromise.catch(() => {
              cleanup();
              resolve();
            });
          }
        };

        if (awaitCompletion) {
          audioPlayer.addEventListener('ended', onEnded, { once: true });
          audioPlayer.addEventListener('error', onError, { once: true });
        }

        if (audioPlayer.readyState >= 2) {
          onCanPlay();
        } else {
          audioPlayer.addEventListener('canplay', onCanPlay);
          try {
            audioPlayer.load();
          } catch (err) {
            cleanup();
            resolve();
          }
        }
      });
    }

    function stopAllFlashcardAudio(exceptAudio = null) {
      const audioElements = document.querySelectorAll('#flashcard-content audio');
      audioElements.forEach(audioEl => {
        if (exceptAudio && audioEl === exceptAudio) {
          return;
        }
        try {
          if (!audioEl.paused) {
            audioEl.pause();
          }
          audioEl.currentTime = 0;
        } catch (err) {
          console.warn('Không thể dừng audio:', err);
        }
      });
    }

    function playAudioForButton(button, options = {}) {
      if (!button) return Promise.resolve();
      const audioPlayer = document.querySelector(button.dataset.audioTarget);
      if (!audioPlayer || button.classList.contains('is-disabled')) {
        return Promise.resolve();
      }

      const awaitCompletion = options.await === true;
      const restart = options.restart !== false;
      const suppressLoadingUi = options.suppressLoadingUi === true;
      const hasAudioSource = audioPlayer.src && audioPlayer.src !== window.location.href;

      if (hasAudioSource) {
        stopAllFlashcardAudio(audioPlayer);
        return playAudioAfterLoad(audioPlayer, { restart, awaitCompletion });
      }

      stopAllFlashcardAudio(audioPlayer);
      return generateAndPlayAudio(button, audioPlayer, { awaitCompletion, suppressLoadingUi, restart });
    }

    function autoPlaySide(side) {
      const button = document.querySelector(`.play-audio-btn[data-side="${side}"]`);
      if (!button) return;
      playAudioForButton(button, { suppressLoadingUi: true }).catch(() => {});
    }

    function autoPlayFrontSide() {
      autoPlaySide('front');
    }

    function autoPlayBackSide() {
      autoPlaySide('back');
    }

    function cancelAutoplaySequence() {
      currentAutoplayToken += 1;
      currentAutoplayTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
      currentAutoplayTimeouts = [];
      stopAllFlashcardAudio();
    }

    function waitForAutoplayDelay(token) {
      return new Promise(resolve => {
        const delayMs = Math.max(0, autoplayDelaySeconds) * 1000;
        if (delayMs === 0) {
          resolve();
          return;
        }
        const timeoutId = setTimeout(() => {
          currentAutoplayTimeouts = currentAutoplayTimeouts.filter(id => id !== timeoutId);
          if (token === currentAutoplayToken) {
            resolve();
          }
        }, delayMs);
        currentAutoplayTimeouts.push(timeoutId);
      });
    }

    async function playAutoplayAudioForSide(side, token) {
      if (token !== currentAutoplayToken) return;
      const button = document.querySelector(`.play-audio-btn[data-side="${side}"]`);
      if (!button) return;
      try {
        await playAudioForButton(button, { await: true, suppressLoadingUi: true });
      } catch (err) {
        console.warn('Không thể phát audio tự động:', err);
      }
    }

    function revealBackSideForAutoplay(token) {
      if (token !== currentAutoplayToken) return;
      const { card, actions, flipBtn } = currentCardElements;
      if (!card) return;
      if (!card.classList.contains('flipped')) {
        stopAllFlashcardAudio();
        card.classList.add('flipped');
        actions?.classList.add('visible');
        if (flipBtn) {
          flipBtn.style.display = 'none';
        }
        setTimeout(adjustCardLayout, 0);
      } else if (actions) {
        actions.classList.add('visible');
      }
    }

    async function startAutoplaySequence() {
      cancelAutoplaySequence();
      const token = currentAutoplayToken;
      try {
        await playAutoplayAudioForSide('front', token);
        if (token !== currentAutoplayToken) return;
        await waitForAutoplayDelay(token);
        if (token !== currentAutoplayToken) return;
        revealBackSideForAutoplay(token);
        await playAutoplayAudioForSide('back', token);
        if (token !== currentAutoplayToken) return;
        await waitForAutoplayDelay(token);
        if (token !== currentAutoplayToken) return;
        getNextFlashcardBatch();
      } catch (err) {
        console.warn('AutoPlay gặp lỗi:', err);
      }
    }

    function shouldShowPreviewOnly(initialStats = {}) {
      const hasRealReviews = Boolean(initialStats.has_real_reviews);
      if (hasRealReviews) return false;

      const previewCount = initialStats.preview_count ?? 0;
      const hasPreviewHistory = Boolean(initialStats.has_preview_history);

      if (hasPreviewHistory && previewCount > 0) {
        return false;
      }

      return previewCount === 0;
    }

    function determineCardCategory(cardData) {
      if (!cardData) return '';

      const stats = cardData.initial_stats || {};
      const hasPreviewHistory = Boolean(stats.has_preview_history);
      const hasRealReviews = Boolean(stats.has_real_reviews);

      if (!hasPreviewHistory && !hasRealReviews) {
        return 'new';
      }

      if (stats.status === 'hard') {
        return 'hard';
      }

      if (stats.has_preview_only) {
        return 'due';
      }

      if (stats.next_review) {
        const dueDate = new Date(stats.next_review);
        if (!Number.isNaN(dueDate.getTime()) && dueDate <= new Date()) {
          return 'due';
        }
      }

      return '';
    }

    function getPreviewButtonHtml() {
      return '<button class="btn btn-continue" data-answer="continue"><i class="fas fa-arrow-right"></i>Tiếp tục</button>';
    }

    function updateSessionSummary(){
      const desktopTotalScore = document.querySelector('.statistics-card #total-score-display span');
      const desktopSessionScore = document.querySelector('.statistics-card #session-score-display');
      
      const modalTotalScore = document.querySelector('#statsModal #total-score-display span');
      const modalSessionScore = document.querySelector('#statsModal #session-score-display');
      
      if (desktopTotalScore) desktopTotalScore.textContent = currentUserTotalScore;
      if (desktopSessionScore) desktopSessionScore.textContent = `+${sessionScore}`;
      if (modalTotalScore) modalTotalScore.textContent = currentUserTotalScore;
      if (modalSessionScore) modalSessionScore.textContent = `+${sessionScore}`;
    }

    /**
     * Tự động điều chỉnh kích thước font và căn chỉnh nội dung mặt sau thẻ.
     * Áp dụng căn giữa khi không có cuộn, và căn trên khi có cuộn.
     */
    function adjustCardLayout() {
    const card = document.getElementById('flashcard-card');
    if (!card) return;

    const textAreas = card.querySelectorAll('.text-area');

    textAreas.forEach(scrollArea => {
        const txt = scrollArea.querySelector('.flashcard-content-text');
        if (!txt) return;

        // Reset style
        txt.style.fontSize = '';
        scrollArea.classList.remove('has-scroll');
        scrollArea.parentElement?.classList?.remove('has-scroll');

        // Đợi DOM render xong rồi đo
        setTimeout(() => {
        const hasScroll = scrollArea.scrollHeight > scrollArea.clientHeight;

        if (hasScroll) {
            // Ghim lên trên: set class cho cả text-area và container
            scrollArea.classList.add('has-scroll');
            scrollArea.parentElement?.classList?.add('has-scroll');

            // Đảm bảo nhìn thấy từ đầu nội dung
            scrollArea.scrollTop = 0;
        }

        // Thu nhỏ font nếu vẫn tràn
        let current = parseFloat(getComputedStyle(txt).fontSize) || 22;
        const min = 18;
        while (scrollArea.scrollHeight > scrollArea.clientHeight && current > min) {
            current -= 1;
            txt.style.fontSize = current + 'px';
        }
        }, 0);
    });
    }

    function generateDynamicButtons(buttonCount) {
        const buttonSets = {
            3: [
                { variant: 'again', value: 'quên', title: 'Quên', icon: 'fas fa-redo-alt' },
                { variant: 'hard', value: 'mơ_hồ', title: 'Mơ hồ', icon: 'fas fa-question-circle' },
                { variant: 'easy', value: 'nhớ', title: 'Nhớ', icon: 'fas fa-check-circle' }
            ],
            4: [
                { variant: 'again', value: 'again', title: 'Học lại', icon: 'fas fa-undo' },
                { variant: 'very-hard', value: 'hard', title: 'Khó', icon: 'fas fa-fire' },
                { variant: 'good', value: 'good', title: 'Bình thường', icon: 'fas fa-thumbs-up' },
                { variant: 'easy', value: 'easy', title: 'Dễ', icon: 'fas fa-smile' }
            ],
            6: [
                { variant: 'fail', value: 'fail', title: 'Rất khó', icon: 'fas fa-exclamation-circle' },
                { variant: 'very-hard', value: 'very_hard', title: 'Khó', icon: 'fas fa-fire' },
                { variant: 'hard', value: 'hard', title: 'Trung bình', icon: 'fas fa-adjust' },
                { variant: 'medium', value: 'medium', title: 'Dễ', icon: 'fas fa-leaf' },
                { variant: 'good', value: 'good', title: 'Rất dễ', icon: 'fas fa-thumbs-up' },
                { variant: 'very-easy', value: 'very_easy', title: 'Dễ dàng', icon: 'fas fa-star' }
            ]
        };
        const buttons = buttonSets[buttonCount] || buttonSets[3];
        return buttons.map(btn => {
            const iconHtml = btn.icon ? `<span class="rating-btn__icon"><i class="${btn.icon}"></i></span>` : '';
            return `<button class="btn rating-btn rating-btn--${btn.variant}" data-answer="${btn.value}">${iconHtml}<span class="rating-btn__title">${btn.title}</span></button>`;
        }).join('');
    }
    
    function getCardToolbar(isMobile, itemId, setId) {
        const hasFrontAudio = currentFlashcardBatch[currentFlashcardIndex].content.front_audio_url || currentFlashcardBatch[currentFlashcardIndex].content.front_audio_content;
        const hasBackAudio = currentFlashcardBatch[currentFlashcardIndex].content.back_audio_url || currentFlashcardBatch[currentFlashcardIndex].content.back_audio_content;
        const frontTextRaw = currentFlashcardBatch[currentFlashcardIndex].content.front || '';
        const backTextRaw = currentFlashcardBatch[currentFlashcardIndex].content.back || '';
        const menuButtonHtml = isMobile ? `<button class="icon-btn open-stats-modal-btn"><i class="fas fa-bars"></i></button>` : '';
        const aiButtonHtml = `<button class="icon-btn open-ai-modal-btn" data-item-id="${itemId}"><i class="fas fa-robot"></i></button>`;
        const noteButtonHtml = `<button class="icon-btn open-note-panel-btn" data-item-id="${itemId}"><i class="fas fa-sticky-note"></i></button>`;
        const feedbackButtonHtml = `<button class="icon-btn open-feedback-modal-btn" data-item-id="${itemId}"><i class="fas fa-flag"></i></button>`;
        const editButtonHtml = `<button class="icon-btn edit-card-btn" onclick="window.parent.openModal('{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=0, item_id=0) }}'.replace('/0', '/${setId}').replace('/0', '/${itemId}'))"><i class="fas fa-pencil-alt"></i></button>`;

        const audioButtonHtmlFront = `<button class="icon-btn play-audio-btn ${hasFrontAudio ? '' : 'is-disabled'}" data-audio-target="#front-audio" data-side="front" data-item-id="${itemId}" data-content-to-read="${currentFlashcardBatch[currentFlashcardIndex].content.front_audio_content || ''}" ${hasFrontAudio ? '' : 'disabled'}><i class="fas fa-volume-up"></i></button>`;
        const audioButtonHtmlBack = `<button class="icon-btn play-audio-btn ${hasBackAudio ? '' : 'is-disabled'}" data-audio-target="#back-audio" data-side="back" data-item-id="${itemId}" data-content-to-read="${currentFlashcardBatch[currentFlashcardIndex].content.back_audio_content || ''}" ${hasBackAudio ? '' : 'disabled'}><i class="fas fa-volume-up"></i></button>`;

        const flipButtonHtml = `<button id="flip-card-btn" class="flip-card-btn"><i class="fas fa-sync-alt mr-2"></i>Lật thẻ</button>`;

        const leftToolbarContent = isMobile 
            ? `${menuButtonHtml}${aiButtonHtml}${noteButtonHtml}` 
            : `${aiButtonHtml}${noteButtonHtml}`;
        
        // THAY ĐỔI: Di chuyển nút feedback sang phải
        const rightToolbarContent = `${feedbackButtonHtml}${editButtonHtml}`;

        return {
            front: `<div class="card-toolbar"><div class="toolbar-left">${leftToolbarContent}</div><span class="label">MẶT TRƯỚC</span><div class="toolbar-right">${rightToolbarContent}${audioButtonHtmlFront}</div></div>`,
            back: `<div class="card-toolbar"><div class="toolbar-left">${leftToolbarContent}</div><span class="label">MẶT SAU</span><div class="toolbar-right">${rightToolbarContent}${audioButtonHtmlBack}</div></div>`,
            flipButton: flipButtonHtml
        };
    }

    function renderCard(data){
      if (isAutoplaySession) {
        cancelAutoplaySequence();
      }
      const c = data.content;
      const itemId = data.item_id;
      const setId = data.container_id;
      const fTxt = c.front || '';
      const bTxt = c.back || '';
      const initialStats = data.initial_stats || {};
      const cardCategory = determineCardCategory(data);
      const showPreviewOnly = shouldShowPreviewOnly(initialStats);
      const shouldRenderButtons = !isAutoplaySession && !showPreviewOnly;
      const buttonsHtml = showPreviewOnly ? getPreviewButtonHtml() : (shouldRenderButtons ? generateDynamicButtons(userButtonCount) : '');
      const buttonCount = showPreviewOnly ? 1 : (shouldRenderButtons ? userButtonCount : 0);
      const isMobile = window.innerWidth < 1024;

      const toolbars = getCardToolbar(isMobile, itemId, setId);

      const cardClassNames = ['flashcard-card'];
      if (cardCategory) {
        cardClassNames.push(`flashcard-card--${cardCategory}`);
      }

      stopAllFlashcardAudio();

      const html = `
      <div class="flashcard-card-container">
        <div id="flashcard-card" class="${cardClassNames.join(' ')}" data-card-category="${cardCategory || 'default'}">
          <div class="face front">
            ${toolbars.front}
            <div class="_card-container">
              <div class="text-area"><div class="flashcard-content-text">${formatTextForHtml(fTxt)}</div></div>
              ${c.front_img ? `<div class="media-container"><img src="${c.front_img}" alt="Mặt trước" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';"></div>` : ''}
              <audio id="front-audio" class="hidden" src="${c.front_audio_url || ''}"></audio>
            </div>
            <div class="flex justify-center p-4">
              ${toolbars.flipButton}
            </div>
          </div>
          <div class="face back">
            ${toolbars.back}
            <div class="_card-container">
              <div class="text-area"><div class="flashcard-content-text">${formatTextForHtml(bTxt)}</div></div>
              ${c.back_img ? `<div class="media-container"><img src="${c.back_img}" alt="Mặt sau" onerror="this.onerror=null;this.src='https://placehold.co/200x120?text=Loi+anh';"></div>` : ''}
            </div>
            <div class="actions" id="internal-actions" data-button-count="${buttonCount}">${buttonsHtml}</div>
            <audio id="back-audio" class="hidden" src="${c.back_audio_url || ''}"></audio>
          </div>
        </div>
      </div>`;
      flashcardContentDiv.innerHTML = html;
      if (Array.isArray(currentFlashcardBatch) && currentFlashcardBatch[currentFlashcardIndex]) {
        currentFlashcardBatch[currentFlashcardIndex].card_category = cardCategory;
      }
      const card = document.getElementById('flashcard-card');
      const actions = document.getElementById('internal-actions');
      const flipBtn = document.getElementById('flip-card-btn');
      currentCardElements = { card, actions, flipBtn };

      if (window.flashcardViewport && typeof window.flashcardViewport.refresh === 'function') {
        window.flashcardViewport.refresh();
      }

      if (card) {
        card.dataset.cardCategory = cardCategory || 'default';
      }

      const flipToBack = () => {
        stopAllFlashcardAudio();
        card.classList.add('flipped');
        actions?.classList.add('visible');
        if (flipBtn) {
          flipBtn.style.display = 'none';
        }
        setTimeout(adjustCardLayout, 0);
        if (!isAutoplaySession) {
          autoPlayBackSide();
        }
      };

      const flipToFront = () => {
        stopAllFlashcardAudio();
        card.classList.remove('flipped');
        actions?.classList.remove('visible');
        if (flipBtn) {
          flipBtn.style.display = '';
        }
        setTimeout(adjustCardLayout, 0);
      };

      if (flipBtn) {
        flipBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            flipToBack();
        });
      }

      const frontLabel = card?.querySelector('.front .card-toolbar .label');
      const backLabel = card?.querySelector('.back .card-toolbar .label');

      if (frontLabel) {
        frontLabel.addEventListener('click', (ev) => {
          ev.stopPropagation();
          flipToBack();
        });
      }

      if (backLabel) {
        backLabel.addEventListener('click', (ev) => {
          ev.stopPropagation();
          flipToFront();
        });
      }
      
      document.querySelectorAll('.card-toolbar .icon-btn').forEach(btn => {
          btn.addEventListener('click', ev => {
              ev.stopPropagation();
          });
      });

      if (!isAutoplaySession) {
        document.querySelectorAll('.actions .btn').forEach(b => b.addEventListener('click', ev => {
          ev.stopPropagation();
          submitFlashcardAnswer(data.item_id, b.dataset.answer);
        }));
      }

      document.querySelectorAll('.play-audio-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const audioPlayer = document.querySelector(btn.dataset.audioTarget);
          if (!audioPlayer || btn.classList.contains('is-disabled')) return;
          if (!audioPlayer.paused && audioPlayer.currentTime > 0) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            return;
          }
          playAudioForButton(btn).catch(() => {});
        });
      });
      document.querySelectorAll('.open-stats-modal-btn').forEach(btn => btn.addEventListener('click', () => {
        toggleStatsModal(true);
      }));
      document.querySelectorAll('.open-ai-modal-btn').forEach(btn => btn.addEventListener('click', () => {
          const itemId = btn.dataset.itemId;
          const currentCard = currentFlashcardBatch[currentFlashcardIndex];
          const termContent = currentCard.content.front;
          window.openAiModal(itemId, termContent);
      }));
      document.querySelectorAll('.open-note-panel-btn').forEach(btn => btn.addEventListener('click', () => {
          const itemId = btn.dataset.itemId;
          openNotePanel(itemId);
      }));

      // Gắn listener cho nút feedback
      document.querySelectorAll('.open-feedback-modal-btn').forEach(btn => btn.addEventListener('click', () => {
          const itemId = btn.dataset.itemId;
          const currentCard = currentFlashcardBatch[currentFlashcardIndex];
          const termContent = currentCard.content.front;
          // Gọi hàm từ _feedback_modal.html
          openFeedbackModal(itemId, termContent); 
      }));
      
      setTimeout(adjustCardLayout, 0);

      if (isAutoplaySession) {
        startAutoplaySequence();
      } else {
        autoPlayFrontSide();
      }
    }

    async function generateAndPlayAudio(button, audioPlayer, options = {}) {
      const itemId = button.dataset.itemId;
      const side = button.dataset.side;
      const contentToRead = button.dataset.contentToRead;
      const awaitCompletion = options.awaitCompletion === true;
      const suppressLoadingUi = options.suppressLoadingUi === true;
      const restart = options.restart !== false;

      const originalHtml = button.dataset.originalHtml || button.innerHTML;
      if (!button.dataset.originalHtml) {
        button.dataset.originalHtml = originalHtml;
      }

      if (!suppressLoadingUi) {
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      }

      button.classList.add('is-disabled');
      let playbackPromise = Promise.resolve();

      try {
        const response = await fetch(regenerateAudioUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...csrfHeaders },
          body: JSON.stringify({ item_id: itemId, side: side, content_to_read: contentToRead })
        });
        const result = await response.json();
        if (result.success && result.audio_url) {
          audioPlayer.src = result.audio_url;
          playbackPromise = playAudioAfterLoad(audioPlayer, { restart, awaitCompletion });
          if (awaitCompletion) {
            await playbackPromise;
          }
        } else {
          showCustomAlert(result.message || 'Lỗi khi tạo audio.');
        }
      } catch (error) {
        console.error('Lỗi khi tạo audio:', error);
        showCustomAlert('Không thể kết nối đến máy chủ để tạo audio.');
      } finally {
        button.classList.remove('is-disabled');
        if (!suppressLoadingUi) {
          button.innerHTML = button.dataset.originalHtml || '<i class="fas fa-volume-up"></i>';
        }
      }

      return playbackPromise;
    }

    function formatMinutesAsDuration(minutes) {
        if (minutes <= 0) return 'Dưới 1 phút';
        const M_IN_H = 60, M_IN_D = 1440, M_IN_W = 10080, M_IN_MO = 43200;
        let result = [], remainingMinutes = minutes;
        if (remainingMinutes >= M_IN_MO) { const m = Math.floor(remainingMinutes / M_IN_MO); result.push(`${m} tháng`); remainingMinutes %= M_IN_MO; }
        if (remainingMinutes >= M_IN_W) { const w = Math.floor(remainingMinutes / M_IN_W); result.push(`${w} tuần`); remainingMinutes %= M_IN_W; }
        if (remainingMinutes >= M_IN_D) { const d = Math.floor(remainingMinutes / M_IN_D); result.push(`${d} ngày`); remainingMinutes %= M_IN_D; }
        if (remainingMinutes >= M_IN_H) { const h = Math.floor(remainingMinutes / M_IN_H); result.push(`${h} giờ`); remainingMinutes %= M_IN_H; }
        if (remainingMinutes > 0) result.push(`${remainingMinutes} phút`);
        return result.join(' ');
    }

    function formatDateTime(value, fallback = 'Chưa có') {
        if (!value) return fallback;
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return fallback;
        }
        try {
            return date.toLocaleString('vi-VN', { dateStyle: 'medium', timeStyle: 'short' });
        } catch (err) {
            return fallback;
        }
    }

    function renderCardStatsHtml(stats, scoreChange = 0, cardContent = {}, isInitial = false) {
        if (!stats) {
            return `<div class="empty-state"><i class="fas fa-info-circle"></i> ${isInitial ? 'Đây là thẻ mới.' : 'Không có dữ liệu thống kê.'}</div>`;
        }

        const totalReviews = Number(stats.times_reviewed) || 0;
        const correctCount = Number(stats.correct_count) || 0;
        const incorrectCount = Number(stats.incorrect_count) || 0;
        const vagueCount = Number(stats.vague_count) || 0;
        const previewCount = Number(stats.preview_count) || 0;
        const correctWidth = totalReviews > 0 ? (correctCount / totalReviews) * 100 : 0;
        const vagueWidth = totalReviews > 0 ? (vagueCount / totalReviews) * 100 : 0;
        const incorrectWidth = totalReviews > 0 ? (incorrectCount / totalReviews) * 100 : 0;
        const correctPercentDisplay = Math.round(correctWidth);
        const vaguePercentDisplay = Math.round(vagueWidth);
        const incorrectPercentDisplay = Math.round(incorrectWidth);
        const dueTime = formatDateTime(stats.next_review, 'Chưa có');
        const lastReviewed = formatDateTime(stats.last_reviewed, totalReviews > 0 ? 'Chưa có' : 'Chưa ôn');
        const firstSeen = formatDateTime(stats.first_seen, 'Chưa mở');
        const formattedIntervalDisplay = formatMinutesAsDuration(stats.interval);
        const scoreChangeSign = scoreChange > 0 ? '+' : '';
        const scoreChangeClass = scoreChange > 0 ? 'positive' : (scoreChange < 0 ? 'negative' : '');
        const isBrandNew = !stats.has_preview_history && !stats.has_real_reviews;
        const isPreviewStage = stats.has_preview_history && !stats.has_real_reviews;
        const statusKeyRaw = (stats.status || 'new').toString();
        const statusKey = statusKeyRaw.toLowerCase().replace(/\s+/g, '-');
        const statusLabelMap = {
            'new': 'Mới',
            'learning': 'Đang học',
            'review': 'Ôn tập',
            'relearning': 'Ôn lại',
            'hard': 'Khó',
            'easy': 'Dễ',
            'suspended': 'Tạm dừng'
        };
        const statusLabel = statusLabelMap[statusKeyRaw.toLowerCase()] || statusKeyRaw;
        const correctRateDisplay = typeof stats.correct_rate === 'number' ? Math.round(stats.correct_rate) : correctPercentDisplay;
        const repetitions = Number(stats.repetitions) || 0;
        const easinessFactor = typeof stats.easiness_factor === 'number' ? Number(stats.easiness_factor).toFixed(2) : '—';
        const currentStreak = Number(stats.current_streak) || 0;
        const longestStreak = Number(stats.longest_streak) || 0;
        const formatRecentTimestamp = (value) => {
            if (!value) return 'Không rõ';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return 'Không rõ';
            try {
                const timePart = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const datePart = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
                return `${timePart} · ${datePart}`;
            } catch (err) {
                return 'Không rõ';
            }
        };
        const recentReviews = Array.isArray(stats.recent_reviews) ? [...stats.recent_reviews].slice(-10).reverse() : [];
        const recentReviewConfig = {
            'correct': { label: 'Nhớ', icon: 'fas fa-check-circle' },
            'vague': { label: 'Mơ hồ', icon: 'fas fa-adjust' },
            'incorrect': { label: 'Quên', icon: 'fas fa-times-circle' },
            'preview': { label: 'Xem trước', icon: 'fas fa-eye' }
        };
        const introNotice = isBrandNew
            ? `<div class="insight-banner"><i class="fas fa-seedling"></i><span>Thẻ mới - khám phá nội dung trước khi chấm điểm.</span></div>`
            : (isPreviewStage
                ? `<div class="insight-banner"><i class="fas fa-hourglass-half"></i><span>Thẻ đang ở giai đoạn giới thiệu. Nhấn "Tiếp tục" để bước vào phần đánh giá.</span></div>`
                : '');

        const hasHistoricData = totalReviews > 0 || previewCount > 0;
        const progressSection = hasHistoricData
            ? `
                <div class="stats-section stats-section--performance">
                    <div class="stats-section__header">
                        <div class="icon-bubble"><i class="fas fa-chart-line"></i></div>
                        <div>
                            <h4>Hiệu suất trả lời</h4>
                            <p>Tỷ lệ ghi nhớ dựa trên toàn bộ lịch sử của thẻ.</p>
                        </div>
                    </div>
                    <div class="progress-stack">
                        <div class="progress-bar-group">
                            <div class="progress-bar-label">
                                <span class="label-title"><span class="progress-dot"></span> Nhớ</span>
                                <span class="progress-bar-stat">${correctCount} lượt · ${correctPercentDisplay}%</span>
                            </div>
                            <div class="progress-bar-container"><div class="progress-bar-fill progress-bar-fill-correct" style="--progress:${correctWidth}%;"></div></div>
                        </div>
                        <div class="progress-bar-group">
                            <div class="progress-bar-label">
                                <span class="label-title"><span class="progress-dot vague"></span> Mơ hồ</span>
                                <span class="progress-bar-stat">${vagueCount} lượt · ${vaguePercentDisplay}%</span>
                            </div>
                            <div class="progress-bar-container"><div class="progress-bar-fill progress-bar-fill-vague" style="--progress:${vagueWidth}%;"></div></div>
                        </div>
                        <div class="progress-bar-group">
                            <div class="progress-bar-label">
                                <span class="label-title"><span class="progress-dot incorrect"></span> Quên</span>
                                <span class="progress-bar-stat">${incorrectCount} lượt · ${incorrectPercentDisplay}%</span>
                            </div>
                            <div class="progress-bar-container"><div class="progress-bar-fill progress-bar-fill-incorrect" style="--progress:${incorrectWidth}%;"></div></div>
                        </div>
                    </div>
                </div>
            `
            : `
                <div class="stats-section stats-section--performance">
                    <div class="stats-section__header">
                        <div class="icon-bubble"><i class="fas fa-chart-line"></i></div>
                        <div>
                            <h4>Hiệu suất trả lời</h4>
                            <p>Thống kê sẽ xuất hiện sau khi bạn chấm điểm thẻ này.</p>
                        </div>
                    </div>
                    <div class="empty-state"><i class="fas fa-info-circle"></i> Bắt đầu trả lời để mở khóa biểu đồ hiệu suất.</div>
                </div>
            `;

        const insightSection = `
            <div class="stats-section stats-section--insight">
                <div class="stats-section__header">
                    <div class="icon-bubble"><i class="fas fa-bullseye"></i></div>
                    <div>
                        <h4>Chỉ số ghi nhớ</h4>
                        <p>Tổng hợp theo thuật toán SM-2.</p>
                    </div>
                </div>
                <div class="insight-grid">
                    ${!isInitial ? `<div class="insight-card insight-card--highlight"><span class="insight-card__label">Điểm phiên này</span><span class="insight-card__value ${scoreChangeClass}">${scoreChangeSign}${scoreChange}</span><span class="insight-card__muted">Sau lượt trả lời vừa rồi</span></div>` : ''}
                    <div class="insight-card">
                        <span class="insight-card__label">Trạng thái</span>
                        <span class="status-chip status-${statusKey}"><i class="fas fa-circle"></i> ${statusLabel}</span>
                        <span class="insight-card__muted">Theo tiến trình hiện tại</span>
                    </div>
                    <div class="insight-card">
                        <span class="insight-card__label">Tỷ lệ chính xác</span>
                        <span class="insight-card__value">${correctRateDisplay}%</span>
                        <span class="insight-card__muted">${totalReviews > 0 ? `${correctCount} đúng · ${incorrectCount} sai` : 'Chưa có lượt ôn'}</span>
                    </div>
                    <div class="insight-card">
                        <span class="insight-card__label">Lượt ôn</span>
                        <span class="insight-card__value">${totalReviews}</span>
                        <span class="insight-card__muted">${previewCount > 0 ? `${previewCount} lần xem thử` : 'Chưa xem trước'}</span>
                    </div>
                    <div class="insight-card">
                        <span class="insight-card__label">Chuỗi hiện tại</span>
                        <span class="insight-card__value">${currentStreak}</span>
                        <span class="insight-card__muted">${currentStreak > 0 ? 'Lượt đúng liên tiếp' : 'Chưa có chuỗi'}</span>
                    </div>
                    <div class="insight-card">
                        <span class="insight-card__label">Chuỗi dài nhất</span>
                        <span class="insight-card__value">${longestStreak}</span>
                        <span class="insight-card__muted">${longestStreak > 0 ? 'Kỷ lục ghi nhớ' : 'Chưa xác định'}</span>
                    </div>
                    <div class="insight-card">
                        <span class="insight-card__label">Hệ số dễ (EF)</span>
                        <span class="insight-card__value">${easinessFactor}</span>
                        <span class="insight-card__muted">Điều chỉnh sau mỗi lần ôn</span>
                    </div>
                    <div class="insight-card">
                        <span class="insight-card__label">Lặp lại (n)</span>
                        <span class="insight-card__value">${repetitions}</span>
                        <span class="insight-card__muted">Số lần đã ghi nhớ</span>
                    </div>
                    <div class="insight-card">
                        <span class="insight-card__label">Khoảng cách (I)</span>
                        <span class="insight-card__value">${formattedIntervalDisplay || 'Chưa có'}</span>
                        <span class="insight-card__muted">Thời gian đến lần ôn tiếp theo</span>
                    </div>
                </div>
            </div>
        `;

        const recentSection = recentReviews.length
            ? `
                <div class="stats-section stats-section--recent">
                    <div class="stats-section__header">
                        <div class="icon-bubble"><i class="fas fa-history"></i></div>
                        <div>
                            <h4>Lượt trả lời gần đây</h4>
                            <p>Theo dõi tối đa 10 lượt mới nhất bằng biểu tượng màu sắc.</p>
                        </div>
                    </div>
                    <div class="recent-answers-track" role="list">
                        ${recentReviews.map(entry => {
                            const resultKey = (entry.result || '').toLowerCase();
                            const config = recentReviewConfig[resultKey] || recentReviewConfig.preview;
                            const timestampDisplay = formatRecentTimestamp(entry.timestamp);
                            const qualityScore = typeof entry.user_answer_quality === 'number' ? entry.user_answer_quality : '—';
                            const tooltip = `${config.label} · ${timestampDisplay} · Điểm: ${qualityScore}`;
                            return `
                                <div class="recent-answer-dot recent-answer-dot--${resultKey || 'preview'}" role="listitem" title="${tooltip}">
                                    <i class="${config.icon}" aria-hidden="true"></i>
                                    <span class="sr-only">${tooltip}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `
            : '';

        const timelineSection = `
            <div class="stats-section stats-section--timeline">
                <div class="stats-section__header">
                    <div class="icon-bubble"><i class="fas fa-route"></i></div>
                    <div>
                        <h4>Mốc thời gian học</h4>
                        <p>Quản lý lịch sử ôn tập của riêng bạn.</p>
                    </div>
                </div>
                <div class="timeline-card">
                    <div class="timeline-item">
                        <div class="timeline-icon"><i class="fas fa-flag"></i></div>
                        <div>
                            <div class="timeline-label">Lần đầu gặp</div>
                            <div class="timeline-value">${firstSeen}</div>
                            <div class="timeline-subtle">Thời điểm bạn mở thẻ lần đầu</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon"><i class="fas fa-redo"></i></div>
                        <div>
                            <div class="timeline-label">Ôn gần nhất</div>
                            <div class="timeline-value">${lastReviewed}</div>
                            <div class="timeline-subtle">${totalReviews > 0 ? `${totalReviews} lượt đã ghi nhận` : 'Chưa có lượt ôn thực tế'}</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon"><i class="fas fa-calendar-check"></i></div>
                        <div>
                            <div class="timeline-label">Lịch ôn tiếp theo</div>
                            <div class="timeline-value">${dueTime}</div>
                            <div class="timeline-subtle">${stats.has_real_reviews ? 'Theo lịch SM-2 cá nhân hóa' : 'Cần trả lời để tạo lịch ôn'}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const cardDetails = cardContent.front ? `
            <div class="card-info-section">
                <div class="card-info-title collapsed" data-toggle="card-details-content">
                    <i class="fas fa-caret-right"></i><span>Chi tiết thẻ</span>
                </div>
                <div class="card-info-content">
                    <p><span class="label">Mặt trước</span>${formatTextForHtml(cardContent.front)}</p>
                    <p><span class="label">Mặt sau</span>${formatTextForHtml(cardContent.back)}</p>
                </div>
            </div>
        `.trim() : '';

        return [
            cardDetails,
            introNotice,
            progressSection,
            insightSection,
            recentSection,
            timelineSection
        ].join('');
    }

    function initializeStatsToggleListeners(rootElement) {
        if (!rootElement) return;

        rootElement.querySelectorAll('[data-toggle]').forEach(toggleBtn => {
            if (toggleBtn.dataset.toggleListenerAttached === 'true') return;

            toggleBtn.addEventListener('click', function() {
                const content = this.nextElementSibling;
                this.classList.toggle('collapsed');

                if (!content) return;

                content.classList.toggle('open');

                if (content.classList.contains('open')) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                } else {
                    content.style.maxHeight = null;
                }
            });

            toggleBtn.dataset.toggleListenerAttached = 'true';
        });
    }

    function displayCardStats(container, html) {
        container.innerHTML = html;
        initializeStatsToggleListeners(container);
    }

    window.updateFlashcardCard = async function(itemId, setId) {
        const numericItemId = Number(itemId);
        const numericSetId = Number(setId);

        if (!Number.isInteger(numericItemId) || numericItemId <= 0) {
            const message = 'Không thể xác định thẻ cần cập nhật.';
            if (window.showFlashMessage) {
                window.showFlashMessage(message, 'warning');
            }
            throw new Error(message);
        }

        const apiUrl = flashcardItemApiUrlTemplate.replace('/0', `/${numericItemId}`);

        try {
            const response = await fetch(apiUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            let payload = null;

            try {
                payload = await response.json();
            } catch (parseError) {
                payload = null;
            }

            if (!response.ok || !payload || !payload.success || !payload.item) {
                const errorMessage = (payload && payload.message) ? payload.message : 'Không thể tải lại thẻ sau khi chỉnh sửa.';
                throw new Error(errorMessage);
            }

            const updatedItem = payload.item;

            if (Number.isInteger(numericSetId) && updatedItem.container_id !== numericSetId) {
                const message = 'Thẻ vừa chỉnh sửa không thuộc bộ hiện tại.';
                if (window.showFlashMessage) {
                    window.showFlashMessage(message, 'warning');
                }
                return updatedItem;
            }

            const targetIndex = currentFlashcardBatch.findIndex(card => Number(card.item_id) === Number(updatedItem.item_id));

            if (targetIndex === -1) {
                const message = 'Không tìm thấy thẻ đang hiển thị trong phiên để cập nhật.';
                if (window.showFlashMessage) {
                    window.showFlashMessage(message, 'info');
                }
                return updatedItem;
            }

            currentFlashcardBatch[targetIndex] = updatedItem;

            if (targetIndex === currentFlashcardIndex) {
                stopAllFlashcardAudio();
                renderCard(updatedItem);
                const initialStatsHtml = renderCardStatsHtml(updatedItem.initial_stats, 0, updatedItem.content, true);
                displayCardStats(currentCardStatsContainer, initialStatsHtml);
            }

            return updatedItem;
        } catch (error) {
            console.error('Không thể tải lại thẻ sau khi chỉnh sửa:', error);
            if (window.showFlashMessage) {
                window.showFlashMessage(error.message || 'Không thể tải lại thẻ sau khi chỉnh sửa.', 'danger');
            }
            throw error;
        }
    };

    async function getNextFlashcardBatch(){
      stopAllFlashcardAudio();
      flashcardContentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-500 min-h-[300px]"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Đang tải thẻ...</p></div>`;
      try {
        const res = await fetch(getFlashcardBatchUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
        if (!res.ok) {
          if (res.status === 404) {
            const end = await res.json();
            if (isAutoplaySession) {
              cancelAutoplaySequence();
            }
            flashcardContentDiv.innerHTML = `<div class="text-center py-12 text-gray-600"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h3 class="text-xl font-semibold text-gray-700 mb-2">Hoàn thành phiên học!</h3><p class="text-gray-500">${formatTextForHtml(end.message)}</p><button id="return-to-dashboard-btn" class="mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-sm"><i class="fas fa-home mr-2"></i> Quay lại Dashboard</button></div>`;
            document.getElementById('return-to-dashboard-btn').addEventListener('click', () => { window.location.href = "{{ url_for('learning.flashcard.dashboard') }}"; });
            return;
          }
          throw new Error('HTTP ' + res.status);
        }
        const batch = await res.json();
        currentFlashcardBatch = batch.items;
        currentFlashcardIndex = 0;
        const currentCardData = currentFlashcardBatch[currentFlashcardIndex];
        
        const initialStatsHtml = renderCardStatsHtml(currentCardData.initial_stats, 0, currentCardData.content, true);
        displayCardStats(currentCardStatsContainer, initialStatsHtml);
        
        renderCard(currentCardData);
        updateSessionSummary();

      } catch (e) {
        console.error('Lỗi khi tải nhóm thẻ:', e);
        flashcardContentDiv.innerHTML = `<p class='text-red-500 text-center'>Không thể tải thẻ. Vui lòng thử lại.</p>`;
      }
    }

    async function submitFlashcardAnswer(itemId, answer){
      stopAllFlashcardAudio();
      try {
        const res = await fetch(submitAnswerUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...csrfHeaders },
          body: JSON.stringify({ item_id: itemId, user_answer: answer })
        });
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP error! status: ${res.status}, body: ${errorText}`);
        }
        const data = await res.json();
        
        sessionScore += data.score_change;
        currentUserTotalScore = data.updated_total_score;
        
        const previousCardContent = currentFlashcardBatch[currentFlashcardIndex].content;
        previousCardStats = { 
            stats: data.statistics,
            scoreChange: data.score_change,
            cardContent: previousCardContent
        };
        const previousStatsHtml = renderCardStatsHtml(data.statistics, data.score_change, previousCardContent, false);
        displayCardStats(previousCardStatsContainer, previousStatsHtml);

        const prevTabButton = document.querySelector('.stats-tab-button[data-target="previous-card-stats-pane"]');
        if (prevTabButton) {
            prevTabButton.click();
        }
        
        currentFlashcardIndex++;
        getNextFlashcardBatch();
      } catch (e) {
        console.error('Lỗi khi gửi đáp án:', e);
        showCustomAlert('Có lỗi khi gửi đáp án. Vui lòng thử lại.');
      }
    }

    endSessionBtn.addEventListener('click', () => endSessionModal.style.display = 'flex');
    confirmEndSessionBtn.addEventListener('click', async () => {
      if (isAutoplaySession) {
        cancelAutoplaySequence();
      }
      try {
        const res = await fetch(endSessionUrl, { method: 'POST', headers: csrfHeaders });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const r = await res.json();
        window.showFlashMessage(r.message || 'Đã kết thúc phiên.', 'info');
        window.location.href = "{{ url_for('learning.flashcard.dashboard') }}";
      } catch (e) {
        window.showFlashMessage('Có lỗi xảy ra khi kết thúc phiên.', 'danger');
      } finally {
        endSessionModal.style.display = 'none';
      }
    });
    cancelEndSessionBtn.addEventListener('click', () => endSessionModal.style.display = 'none');

    function showCustomAlert(message) {
      const modalHtml = `<div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><p class="text-lg font-semibold text-gray-800 mb-4">${formatTextForHtml(message)}</p><button id="custom-alert-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">OK</button></div></div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.getElementById('custom-alert-ok-btn').addEventListener('click', () => document.getElementById('custom-alert-modal').remove());
    }
    
    function toggleStatsModal(show) {
        if (show) {
            statsModal.classList.add('open');
            statsModalContent.classList.add('open');
            document.body.style.overflow = 'hidden';
            
            const currentCardData = currentFlashcardBatch.length > 0 ? currentFlashcardBatch[currentFlashcardIndex] : null;
            let initialStatsHtml;
            if (currentCardData && currentCardData.initial_stats) {
                initialStatsHtml = renderCardStatsHtml(currentCardData.initial_stats, 0, currentCardData.content, true);
            } else {
                initialStatsHtml = '<div class="empty-state"><i class="fas fa-info-circle"></i> Chưa có thẻ nào.</div>';
            }

            const previousStatsHtml = previousCardStats ? renderCardStatsHtml(previousCardStats.stats, previousCardStats.scoreChange, previousCardStats.cardContent, false) : '<div class="empty-state"><i class="fas fa-info-circle"></i> Chưa trả lời thẻ nào.</div>';
            
            const tabsHtml = `
                <div id="current-card-stats-pane" class="stats-tab-pane active">${initialStatsHtml}</div>
                <div id="previous-card-stats-pane" class="stats-tab-pane">${previousStatsHtml}</div>
            `;
            
            const statsHtml = `
                <div class="mobile-nav-header">
                    {# Gọi macro navbar để render thanh điều hướng #}
                    {{ render_navbar(current_user, request) }}
                    <div class="stats-modal-header">
                        <h3>Thống kê phiên học</h3>
                        <button id="closeStatsModalBtn" class="stats-modal-close-btn">&times;</button>
                    </div>
                </div>
                <div class="stats-modal-body">
                    <div class="statistics-card statistics-card--modal">
                        <div class="statistics-card__header">
                            <div>
                                <span class="statistics-card__subtitle">Phiên học Flashcard</span>
                                <h3 class="statistics-card__title">Thống kê thời gian thực</h3>
                            </div>
                            <span class="statistics-card__badge"><i class="fas fa-bolt"></i> Đang cập nhật</span>
                        </div>
                        <div class="session-overview">
                            <div class="summary-card summary-card--total">
                                <span class="summary-card__label">Tổng điểm</span>
                                <div id="total-score-display" class="summary-card__value"><i class="fas fa-star"></i><span>${currentUserTotalScore}</span></div>
                                <p class="summary-card__hint">Cộng dồn toàn bộ điểm Flashcard</p>
                            </div>
                            <div class="summary-card summary-card--session">
                                <span class="summary-card__label">Điểm phiên này</span>
                                <div id="session-score-display" class="summary-card__value summary-card__value--accent">+${sessionScore}</div>
                                <p class="summary-card__hint">Cập nhật sau mỗi câu trả lời</p>
                            </div>
                        </div>
                        <div class="stats-tab-nav">
                            <button class="stats-tab-button active" data-target="current-card-stats-pane"><i class="fas fa-dot-circle"></i> Thẻ hiện tại</button>
                            <button class="stats-tab-button" data-target="previous-card-stats-pane"><i class="fas fa-history"></i> Thẻ trước đó</button>
                        </div>
                        <div class="stats-tab-content">
                            ${tabsHtml}
                        </div>
                        <div class="statistics-card__footer">
                            <button id="end-session-modal-btn" class="session-end-btn"><i class="fas fa-flag-checkered"></i> <span>Kết thúc phiên</span></button>
                        </div>
                    </div>
                </div>
            `;

            statsModalContent.innerHTML = statsHtml;

            document.getElementById('closeStatsModalBtn').addEventListener('click', () => toggleStatsModal(false));

            document.querySelectorAll('.stats-tab-button').forEach(btn => btn.addEventListener('click', handleTabClick));
            document.getElementById('end-session-modal-btn')?.addEventListener('click', () => endSessionBtn.click());

            initializeStatsToggleListeners(statsModalContent);

            if (previousCardStats) {
                document.querySelector('button[data-target="previous-card-stats-pane"]').click();
            }
            
        } else {
            statsModal.classList.remove('open');
            statsModalContent.classList.remove('open');
            document.body.style.overflow = '';
        }
    }
    
    closeStatsModalBtn.addEventListener('click', () => toggleStatsModal(false));
    function handleTabClick(event) {
        const button = event.currentTarget || event.target.closest('.stats-tab-button');
        if (!button) return;

        const targetPaneId = button.dataset.target;
        if (!targetPaneId) return;

        const parentContainer = button.closest('.statistics-card');
        if (!parentContainer) return;

        parentContainer.querySelectorAll('.stats-tab-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        parentContainer.querySelectorAll('.stats-tab-pane').forEach(pane => {
            pane.classList.toggle('active', pane.id === targetPaneId);
        });

        initializeStatsToggleListeners(parentContainer);
    }

    // ==============================================================================
    // LOGIC CHO AI MODAL (ĐÃ SỬA LỖI LOGIC)
    // ==============================================================================
    
    // Ghi đè hàm openAiModal và closeAiModal được định nghĩa trong _ai_modal.html
    window.openAiModal = function(itemId, termContent) {
        const aiModal = document.getElementById('ai-modal');
        if (aiModal && aiModal.classList.contains('open')) {
            console.warn("AI modal đã được mở, bỏ qua lệnh gọi.");
            return;
        }

        const aiModalTerm = document.getElementById('ai-modal-term');
        const aiResponseContainer = document.getElementById('ai-response-container');

        currentAiItemId = itemId;
        aiModalTerm.textContent = termContent;
        aiModal.classList.add('open');

        fetchAiResponse();
    };

    window.closeAiModal = function() {
        const aiModal = document.getElementById('ai-modal');
        const aiResponseContainer = document.getElementById('ai-response-container');
        
        aiModal.classList.remove('open');
        currentAiItemId = null;
        aiResponseContainer.innerHTML = `<div class="text-gray-500">Câu trả lời của AI sẽ xuất hiện ở đây.</div>`;
    };
    
    // Các listeners trong _ai_modal.html sẽ gọi các hàm global trên

    // ==============================================================================
    // LOGIC CHO NOTE PANEL
    // ==============================================================================
    const notePanel = document.getElementById('note-panel');
    const noteTextarea = document.getElementById('note-textarea');
    const saveNoteBtn = document.getElementById('save-note-btn');
    const cancelNoteBtn = document.getElementById('cancel-note-btn');
    let currentNoteItemId = null;

    async function openNotePanel(itemId) {
        if (!itemId) return;
        currentNoteItemId = itemId;
        
        noteTextarea.value = 'Đang tải ghi chú...';
        noteTextarea.disabled = true;
        try {
            const response = await fetch(getNoteUrl.replace('/0', `/${itemId}`));
            const result = await response.json();
            if (response.ok && result.success) {
                noteTextarea.value = result.content;
            } else {
                noteTextarea.value = '';
            }
        } catch (error) {
            console.error('Lỗi khi tải ghi chú:', error);
            noteTextarea.value = 'Lỗi khi tải ghi chú.';
        } finally {
            noteTextarea.disabled = false;
        }

        notePanel.classList.add('open');
    }

    function closeNotePanel() {
        notePanel.classList.remove('open');
        currentNoteItemId = null;
        noteTextarea.value = '';
    }

    async function saveNote() {
        if (!currentNoteItemId) return;

        const content = noteTextarea.value;
        saveNoteBtn.disabled = true;
        saveNoteBtn.textContent = 'Đang lưu...';

        try {
            const response = await fetch(saveNoteUrl.replace('/0', `/${currentNoteItemId}`), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...csrfHeaders },
                body: JSON.stringify({ content: content })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                window.showFlashMessage(result.message, 'success');
                closeNotePanel();
            } else {
                window.showFlashMessage(result.message || 'Lỗi khi lưu ghi chú.', 'danger');
            }
        } catch (error) {
            console.error('Lỗi khi lưu ghi chú:', error);
            window.showFlashMessage('Lỗi kết nối khi lưu ghi chú.', 'danger');
        } finally {
            saveNoteBtn.disabled = false;
            saveNoteBtn.textContent = 'Lưu Ghi chú';
        }
    }

    saveNoteBtn.addEventListener('click', saveNote);
    cancelNoteBtn.addEventListener('click', closeNotePanel);


    document.addEventListener('DOMContentLoaded', () => {
      setVh();
      document.body.classList.add('flashcard-session-active');
      
      document.querySelectorAll('.statistics-card .stats-tab-button').forEach(btn => btn.addEventListener('click', handleTabClick));
      updateSessionSummary();
      getNextFlashcardBatch();
    });

    window.addEventListener('resize', () => {
    setVh();
    setTimeout(adjustCardLayout, 0);
    });

  </script>
{% endblock %}