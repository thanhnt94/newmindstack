{#
# File: mindstack_app/modules/learning/flashcard_learning/templates/flashcard_session.html
# Phiên bản: 69.1
# MỤC ĐÍCH: Thay đổi vị trí nút Feedback.
# ĐÃ SỬA: Di chuyển nút Feedback từ toolbar bên trái sang bên phải, đặt cạnh nút Sửa thẻ.
#}

{% extends "flashcard/individual/cardsession/v2/_base.html" %}
{% from 'includes/_navbar.html' import render_navbar %}
{% block title %}Học Flashcard{% endblock %}

{# CRITICAL: Add flashcard-session-active class to body to hide header/footer on mobile #}
{% block body_class %} flashcard-session-active{% endblock %}

{% block head %}
{{ super() }}
<script>
  // Remove Tailwind padding from main on mobile viewport
  (function () {
    if (window.innerWidth <= 1023) {
      document.addEventListener('DOMContentLoaded', function () {
        var main = document.querySelector('body > main');
        if (main) {
          main.classList.remove('py-4', 'px-2', 'sm:py-2', 'sm:px-3', 'md:py-4');
          main.style.padding = '0';
          main.style.margin = '0';
        }
        var header = document.querySelector('body > header');
        if (header) {
          header.style.display = 'none';
        }
      });
    }
  })();
</script>
<link rel="stylesheet" href="{{ url_for('learning.flashcard_learning.static', filename='css/session_v2.css') }}">
{% endblock %}

{% block content %}
{# Include Desktop và Mobile partials - visibility kiểm soát bởi CSS class #}
{% include template_base_path ~ '/_desktop.html' %}
{% include template_base_path ~ '/_mobile.html' %}
{% include template_base_path ~ '/_stats_mobile.html' %}

{# === SHARED MODALS - Dùng chung cho cả Desktop và Mobile === #}

<div id="endSessionModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <p class="text-lg font-semibold text-gray-800 mb-4">Bạn có chắc chắn muốn kết thúc phiên học hiện tại?</p>
    <p class="text-sm text-gray-600 mb-6">Tiến độ của thẻ chưa trả lời sẽ không được lưu.</p>
    <div class="flex justify-center space-x-4">
      <button id="confirmEndSessionBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Kết
        thúc</button>
      <button id="cancelEndSessionBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Hủy
        bỏ</button>
    </div>
  </div>
</div>

<div id="statsModal" class="stats-modal-overlay">
  <div id="statsModalContent" class="stats-modal-content">
    <header class="bg-white shadow-md">
      {{ render_navbar(current_user, request) }}
    </header>
    <div class="stats-modal-header">
      <h3>Thống kê phiên học</h3>
      <button id="closeStatsModalBtn" class="stats-modal-close-btn">&times;</button>
    </div>
    <div id="statsModalBody" class="stats-modal-body">
      {# Nội dung thống kê sẽ được render vào đây #}
    </div>
  </div>
</div>

{# Nhúng modal AI #}
{% include 'ai_services/_ai_modal.html' %}

{# Nhúng modal Ghi chú #}
{% include 'notes/_note_panel.html' %}

{# Nhúng modal Feedback #}
{% include 'feedback/_feedback_modal.html' %}

{% endblock %}

{% block scripts %}
{{ super() }}

<script src="{{ url_for('learning.flashcard_learning.static', filename='flashcard_viewport.js') }}"></script>

{# Config injection for static JS #}
<script>
window.FC = {
  urls: {
    getFlashcardBatch: "{{ url_for('learning.flashcard_learning.get_flashcard_batch') }}",
    flashcardItemApi: "{{ url_for('learning.flashcard_learning.get_flashcard_item_api', item_id=0) }}",
    submitAnswer: "{{ url_for('learning.flashcard_learning.submit_flashcard_answer') }}",
    endSession: "{{ url_for('learning.flashcard_learning.end_session_flashcard') }}",
    regenerateAudio: "{{ url_for('learning.flashcard_learning.regenerate_audio_from_content') }}",
    getNote: "{{ url_for('notes.get_note', item_id=0) }}",
    saveNote: "{{ url_for('notes.save_note', item_id=0) }}",
    editFlashcard: "{{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=0, item_id=0) }}"
  },
  userTotalScore: {{ current_user.total_score | default(0) }},
  buttonCount: {{ user_button_count }},
  isAutoplay: {{ 'true' if is_autoplay_session else 'false' }},
  autoplayMode: "{{ autoplay_mode }}"
};
</script>

<script src="{{ url_for('learning.flashcard_learning.static', filename='js/session_v2.js') }}"></script>
{% endblock %}