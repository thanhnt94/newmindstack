{% extends 'base.html' %}
{% block title %}Phòng học Flashcard chung - {{ room_payload.room_code }}{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    :root {
      --flashcard-shell-gap: clamp(24px, 3vw, 32px);
      --flashcard-header-height: 0px;
      --flashcard-footer-height: 0px;
    }

    /* --- 1. GLOBAL LAYOUT RESET (Application Mode) --- */
    html {
      height: 100%;
      overflow: hidden; /* Chặn scroll ở root */
      box-sizing: border-box;
    }

    body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Chặn scroll ở body */
      background-color: #f9fafb;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    /* Ngăn scroll còn sót lại khi kích hoạt chế độ học chung */
    body.flashcard-session-active {
      height: 100vh;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Ép footer xuống đáy, main chiếm hết phần còn lại */
    body > footer {
      flex-shrink: 0;
      z-index: 10;
    }

    /* Main container của base.html */
    body > main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Quan trọng để flex con scroll được */
      padding: 0 !important;
      margin: 0 !important;
      max-width: none !important;
      width: 100%;
      overflow: hidden;
    }

    body.flashcard-session-active > main {
      height: 100%;
      max-height: 100%;
      overflow: hidden !important;
    }

    /* --- 2. PAGE SHELL (Lớp vỏ) --- */
    .page-shell {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%; /* Fill 100% main */
      padding: var(--flashcard-shell-gap) 0;
      gap: 1rem;
      background: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08), transparent 25%),
        radial-gradient(circle at 90% 30%, rgba(59, 130, 246, 0.06), transparent 25%),
        #f8fafc;
      overflow: hidden; /* Không scroll ở đây */
      box-sizing: border-box;
      min-height: calc(100vh - var(--flashcard-header-height, 0px) - var(--flashcard-footer-height, 0px));
    }

    .collab-hero {
      position: relative;
      overflow: hidden;
      margin: 0 auto;
      width: min(1320px, 100%);
      padding: 1.5rem clamp(18px, 2vw, 28px);
      border-radius: 24px;
      background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.14), transparent 28%),
        radial-gradient(circle at 80% 0%, rgba(16, 185, 129, 0.16), transparent 25%),
        linear-gradient(145deg, #0f172a, #0b1221 55%, #0f172a);
      border: 1px solid rgba(255, 255, 255, 0.07);
      box-shadow: 0 22px 55px rgba(15, 23, 42, 0.36);
      color: #e2e8f0;
      isolation: isolate;
    }

    .collab-hero::before,
    .collab-hero::after {
      content: '';
      position: absolute;
      border-radius: 999px;
      filter: blur(60px);
      opacity: 0.32;
      z-index: 0;
    }

    .collab-hero::before { inset: -20% auto 30% 35%; background: #38bdf8; }
    .collab-hero::after { inset: 20% 35% -30% auto; background: #a855f7; }

    .collab-hero__grid {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 2fr 1.1fr;
      gap: 1.25rem;
      align-items: stretch;
    }

    .collab-hero__meta { display: flex; flex-direction: column; gap: 0.75rem; }

    .hero-kicker {
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #a5b4fc;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .hero-kicker .dot { width: 8px; height: 8px; border-radius: 50%; background: #22d3ee; display: inline-block; box-shadow: 0 0 0 6px rgba(34, 211, 238, 0.18); }

    .collab-hero__title {
      font-size: clamp(1.6rem, 3vw, 2rem);
      font-weight: 800;
      color: #f8fafc;
      line-height: 1.15;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .collab-hero__subtitle { color: #cbd5e1; font-size: 0.98rem; max-width: 800px; line-height: 1.6; }

    .collab-hero__chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
    }

    .hero-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.55rem 0.85rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #e2e8f0;
      font-weight: 600;
      backdrop-filter: blur(8px);
    }

    .hero-chip strong { color: #fff; }

    .collab-hero__stats {
      position: relative;
      overflow: hidden;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 18px;
      padding: 1.1rem 1.2rem;
      display: grid;
      gap: 0.8rem;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .hero-stat-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; }

    .hero-stat {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0.9rem;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      color: #e5e7eb;
    }

    .hero-stat small { color: #cbd5e1; letter-spacing: 0.04em; text-transform: uppercase; font-weight: 700; }
    .hero-stat span { font-size: 1.25rem; font-weight: 800; color: #fefefe; }

    .hero-status {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      padding: 0.65rem 0.75rem;
      border-radius: 14px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.18);
      color: #bbf7d0;
      font-weight: 700;
      min-height: 54px;
    }

    .hero-actions { display: flex; gap: 0.65rem; flex-wrap: wrap; }

    .hero-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: #e2e8f0;
      background: linear-gradient(120deg, rgba(59, 130, 246, 0.4), rgba(59, 130, 246, 0.18));
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.28);
      font-weight: 700;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      cursor: pointer;
    }

    .hero-btn.secondary { background: rgba(255, 255, 255, 0.05); box-shadow: none; color: #e2e8f0; }
    .hero-btn:hover { transform: translateY(-1px); box-shadow: 0 14px 36px rgba(59, 130, 246, 0.34); }

    @media (max-width: 1024px) { .collab-hero__grid { grid-template-columns: 1fr; gap: 1rem; } }
    @media (max-width: 640px) {
      .collab-hero { padding: 1.1rem 0.85rem; border-radius: 18px; }
      .collab-hero__title { font-size: 1.35rem; }
      .hero-stat span { font-size: 1.05rem; }
    }

    @media (max-width: 1024px) {
      .page-shell {
        top: var(--header-h, 0px);
        bottom: 0;
        padding: 0.05rem 0.05rem 0;
        height: calc(var(--vh, 1vh) * 100);
        min-height: calc(var(--vh, 1vh) * 100);
        gap: 0;
        background: #f8fafc;
      }
      body > footer { display: none !important; }
    }

    body.flashcard-session-active .page-shell {
      min-height: 0;
      height: 100vh;
    }

    /* --- 3. SESSION LAYOUT (Content Chính) --- */
    .session-layout {
      display: grid;
      grid-template-columns: minmax(0, 5fr) minmax(360px, 2fr);
      gap: 1.25rem;

      /* Layout Fill */
      width: 100%;
      max-width: 1440px;
      margin: 0 auto;
      padding: var(--flashcard-shell-gap) clamp(24px, 2vw, 32px) calc(var(--flashcard-shell-gap) * 2) clamp(24px, 2vw, 32px);
      flex: 1; /* Chiếm toàn bộ chiều cao còn lại */
      min-height: 0; /* Cho phép con scroll */
      overflow: hidden; /* Chặn scroll tràn ra ngoài */
      box-sizing: border-box;
      min-height: calc(100vh - var(--flashcard-header-height, 0px) - var(--flashcard-footer-height, 0px) - var(--flashcard-shell-gap));
    }

    @media (max-width: 1024px) {
      .session-layout {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        padding: 0.1rem 0.15rem 0.2rem !important;
        overflow: hidden; /* Quan trọng: Loại bỏ cuộn trên layout chính */
      }
    }

    .flashcard-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      position: relative;
      overflow: hidden;
    }

    /* --- 4. LEFT COLUMN: FLASHCARD --- */
    .card-surface {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.1);
      overflow: hidden;
    }

    .flashcard-panel {
      display: flex;
      flex-direction: column;
      height: 100%; /* Fill cột trái */
      padding: 1.25rem;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(248, 250, 252, 0.96));
      gap: 1rem;
      min-height: 0; /* Fix flex overflow */
    }

    @media (max-width: 1024px) {
      .flashcard-panel { padding: 1rem; gap: 0.75rem; }
    }

    .flashcard-card-container {
      perspective: 1200px;
      width: 100%;
      flex: 1; /* Fill phần còn lại của panel */
      display: flex;
      flex-direction: column;
      min-height: 0; /* Fix flex overflow */
      position: relative;
    }

    .flashcard-card {
      width: 100%;
      height: 100%; /* Card chiếm hết container */
      position: relative;
      background-color: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 18px;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.08);
      transform-style: preserve-3d;
      transition: box-shadow .3s ease, transform .3s ease;
      /* Vars */
      --card-accent-bg: linear-gradient(135deg, #6366f1, #2563eb);
      --card-accent-hover-bg: linear-gradient(135deg, #4f46e5, #1d4ed8);
      --card-accent-rgb: 37, 99, 235;
      --card-accent-shadow: 0 16px 32px rgba(var(--card-accent-rgb), 0.22);
      --card-accent-hover-shadow: 0 20px 40px rgba(var(--card-accent-rgb), 0.3);
    }

    .face {
      position: absolute; inset: 0;
      padding: 60px 1.5rem 1.5rem 1.5rem;
      display: flex; flex-direction: column; justify-content: space-between;
      gap: 10px; backface-visibility: hidden;
      transition: transform .6s ease-in-out, opacity .3s ease-in-out;
      z-index: 1; opacity: 0; pointer-events: none;
      overflow: hidden;
    }

    .front { transform: rotateY(0deg); }
    .back { transform: rotateY(180deg); }

    .flashcard-card:not(.flipped) .front { opacity: 1; pointer-events: auto; }
    .flashcard-card:not(.flipped) .back { opacity: 0; pointer-events: none; }
    .flashcard-card.flipped .front { transform: rotateY(180deg); opacity: 0; pointer-events: none; }
    .flashcard-card.flipped .back { transform: rotateY(360deg); opacity: 1; pointer-events: auto; }

    ._card-container {
      justify-content: flex-start;
      align-items: stretch;
      flex: 1 1 auto;
      min-height: 0;
      padding: 0 0.85rem;
      margin-top: 0;
      display: flex;
      flex-direction: column;
    }

    .text-area {
      flex-grow: 1;
      min-height: 0;
      width: 100%;
      overflow-y: auto; /* Scroll nội dung thẻ nếu dài */
      padding: 1rem 0;
      display: flex;
      align-items: center;
      justify-content: center;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 transparent;
    }

    ._card-container.media-hidden .text-area {
      align-items: center;
      justify-content: center;
    }

    .back ._card-container.media-hidden .text-area,
    .text-area.has-scroll {
      align-items: flex-start;
      justify-content: flex-start;
    }

    .back .text-area .flashcard-content-text {
      text-align: left;
    }

    /* --- 5. RIGHT COLUMN: SIDEBAR (Quan trọng) --- */
    .session-sidebar {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      height: 100%; /* Fill chiều cao lưới cha */
      min-height: 0; /* Fix flex overflow */
      overflow: hidden; /* Chặn scroll tổng sidebar */
    }

    .sidebar-card {
      padding: 1.1rem 1.2rem;
      display: flex; flex-direction: column; gap: 0.75rem;
      flex-shrink: 0; /* Info cards không bị bóp méo */
    }

    .room-meta-card {
      gap: 0.6rem;
    }

    .room-meta-pills {
      gap: 0.4rem;
    }

    .room-meta-pills .pill {
      padding: 0.4rem 0.55rem;
    }

    .status-compact {
      gap: 0.5rem;
    }

    .status-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .status-badges .pill {
      padding: 0.35rem 0.55rem;
    }

    .compact-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 0.45rem 0;
    }

    .compact-list li:first-child { padding-top: 0; }
    .compact-list li:last-child { padding-bottom: 0; }

    .combined-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    /* CHAT PANEL TRONG SIDEBAR */
    .session-sidebar .chat-panel {
      flex: 1; /* Chiếm hết không gian còn lại */
      min-height: 0; /* Quan trọng: cho phép co lại */
      display: flex;
      flex-direction: column;
      background: transparent; /* Bỏ background overlay của mobile */
      padding: 0;
      position: relative;
      inset: auto;
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* CHAT BOX */
    .chat-box {
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border-radius: 18px; /* Khớp bo góc */
      border: 1px solid rgba(148, 163, 184, 0.22);
      display: flex;
      flex-direction: column;
      height: 100%; /* Fill chat panel */
      min-height: 0;
      padding: 1rem 1.1rem;
      gap: 0.75rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.25rem 0 0.35rem;
    }

    .chat-header__title {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    /* KHUNG TIN NHẮN */
    .chat-messages {
      flex: 1; /* Chiếm hết không gian trống giữa header và input */
      min-height: 0; /* Cho phép scroll */
      overflow-y: auto; /* Bật scroll dọc */
      padding: 0.75rem;
      border-radius: 14px;
      background: linear-gradient(180deg, #f8fafc, #eef2ff);
      border: 1px solid #e2e8f0;
      /* Styling scrollbar */
      scrollbar-width: thin;
    }

    .chat-messages p.text-slate-500 { text-align: center; margin-top: 1rem; }

    .chat-bubble {
      padding: 0.75rem 0.85rem;
      border-radius: 14px;
      background: #fff;
      border: 1px solid #e2e8f0;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .chat-bubble__meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: #64748b;
    }

    .chat-bubble__author {
      font-weight: 700;
      color: #0f172a;
    }

    .chat-bubble__content {
      color: #1f2937;
      line-height: 1.5;
    }

    .chat-form {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      padding-top: 0.25rem;
    }

    .chat-input {
      flex: 1;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      padding: 0.7rem 0.85rem;
      font-size: 0.95rem;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .chat-input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .chat-send-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      border: none;
      background: linear-gradient(135deg, #4f46e5, #0ea5e9);
      color: #fff;
      padding: 0.7rem 0.95rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.95rem;
      box-shadow: 0 12px 28px rgba(79, 70, 229, 0.24);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .chat-send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(79, 70, 229, 0.28);
    }

    /* --- OTHER UI --- */
    .card-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 30;
      background: rgba(255, 255, 255, 0.94);
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      backdrop-filter: blur(8px);
    }
    .toolbar-left, .toolbar-right {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      flex: 1;
      min-width: 0;
      flex-wrap: wrap;
    }
    .toolbar-right { justify-content: flex-end; }
    .card-toolbar .mobile-info-btn { display: none !important; }

    .card-toolbar .label {
      text-transform: uppercase;
      text-align: center;
      font-weight: 700;
      color: #475569;
      letter-spacing: 0.08em;
      font-size: 0.95rem;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
      border-radius: 0;
      flex: 1;
      min-width: 120px;
      max-width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .card-toolbar .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background-color: #f8fafc;
      color: #475569;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.05rem;
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, 0.28);
      transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      flex-shrink: 0;
    }

    .toolbar-settings {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .toolbar-settings .settings-panel {
      position: absolute;
      right: calc(100% + 0.35rem);
      top: 50%;
      transform: translateY(-50%) translateX(8px);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.28);
      padding: 0.35rem 0.45rem;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 15;
    }

    .toolbar-settings.is-open .settings-panel {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(-50%) translateX(0);
    }

    .card-toolbar .icon-btn:hover {
      background-color: #eef2ff;
      color: rgba(var(--card-accent-rgb), 1);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(var(--card-accent-rgb), 0.12);
    }

    .card-toolbar .icon-btn.is-active {
      color: rgba(var(--card-accent-rgb), 1);
      background: #eef2ff;
    }

    .card-toolbar .icon-btn.is-disabled {
      background-color: #f1f5f9;
      color: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .card-toolbar .play-audio-btn {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: none;
      background: var(--card-accent-bg);
      color: #ffffff;
      font-size: 1rem;
      box-shadow: var(--card-accent-shadow);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .card-toolbar .play-audio-btn:hover {
      background: var(--card-accent-hover-bg);
      color: #ffffff;
      box-shadow: var(--card-accent-hover-shadow);
      transform: translateY(-1px);
    }

    .card-toolbar .play-audio-btn.is-disabled {
      background-color: rgba(148, 163, 184, 0.35);
      color: #e5e7eb;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .flashcard-content-text { font-size: 2.2rem; font-weight: 700; color: #1f2937; text-align: center; max-width: 100%; }
    .back .flashcard-content-text { font-size: 22px; line-height: 1.5; color: #111827; text-align: left; white-space: pre-wrap; }
    .media-container { flex-shrink: 0; padding: 1rem; width: 100%; text-align: center; position: relative; max-height: 40%; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 12px; background: #f8fafc; }
    .media-container img { max-width: 100%; height: auto; max-height: 100%; object-fit: contain; display: block; margin: auto; }
    .media-container.hidden { display: none; }

    .card-toolbar .image-toggle-btn.is-active {
      background: #e0f2fe;
      color: #0369a1;
      border-color: rgba(3, 105, 161, 0.4);
      box-shadow: 0 10px 24px rgba(3, 105, 161, 0.12);
    }

    .actions { display: none; gap: 1rem; justify-content: center; padding: 1.25rem 1.5rem; position: relative; width: 100%; bottom: 0; left: 0; background: linear-gradient(180deg, #f8fafc 0%, #ffffff 55%); border-top: 1px solid #e2e8f0; box-shadow: 0 -18px 40px rgba(15, 23, 42, 0.08); flex-shrink: 0; z-index: 2; }
    .actions.visible { display: grid; grid-template-columns: repeat(auto-fit, minmax(0, 1fr)); grid-auto-rows: 1fr; align-items: stretch; }
    .actions.visible[data-button-count="3"] { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .actions.visible[data-button-count="4"] { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .actions.visible[data-button-count="6"] { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .btn { border: none; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; border-radius: 0.9rem; cursor: pointer; font-size: 1rem; transition: transform .2s ease, box-shadow .2s ease, filter .2s ease; text-decoration: none; }
    .btn:focus { outline: none; }
    .actions .btn { width: 100%; min-width: 0; max-width: 100%; white-space: normal; padding: 0.9rem 1.25rem; box-shadow: 0 12px 26px rgba(15, 23, 42, 0.08); }
    .actions .btn:hover { transform: translateY(-2px); box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12); }
    .actions .btn:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.28); }
    .actions .btn:active { transform: translateY(0); filter: saturate(1.08); }
    .rating-btn { color: #fff; border-radius: 0.9rem; padding: 0.75rem 1rem; justify-content: center; align-items: center; position: relative; overflow: hidden; gap: 0.5rem; box-shadow: 0 18px 34px rgba(15, 23, 42, 0.12); flex-direction: row; text-align: left; }
    .rating-btn .rating-btn__icon { display: inline-flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; border-radius: 999px; background: rgba(255, 255, 255, 0.18); font-size: 1.1rem; }
    .rating-btn .rating-btn__title { font-size: 0.95rem; font-weight: 700; letter-spacing: 0.01em; line-height: 1; }
    .rating-btn--again { background: linear-gradient(135deg, #f87171, #dc2626); box-shadow: 0 18px 36px rgba(220, 38, 38, 0.32); }
    .rating-btn--fail { background: linear-gradient(135deg, #f87171, #dc2626); box-shadow: 0 18px 36px rgba(220, 38, 38, 0.32); }
    .rating-btn--very-hard { background: linear-gradient(135deg, #fb923c, #ea580c); box-shadow: 0 18px 36px rgba(234, 88, 12, 0.28); }
    .rating-btn--hard { background: linear-gradient(135deg, #f59e0b, #b45309); color: #1f2937; }
    .rating-btn--hard .rating-btn__icon { background: rgba(15, 23, 42, 0.12); color: #1f2937; }
    .rating-btn--medium { background: linear-gradient(135deg, #38bdf8, #2563eb); box-shadow: 0 18px 36px rgba(37, 99, 235, 0.28); }
    .rating-btn--easy { background: linear-gradient(135deg, #34d399, #059669); box-shadow: 0 18px 36px rgba(5, 150, 105, 0.28); }
    .rating-btn--good { background: linear-gradient(135deg, #34d399, #059669); box-shadow: 0 18px 36px rgba(5, 150, 105, 0.28); }
    .rating-btn--very-easy { background: linear-gradient(135deg, #6ee7b7, #0d9488); box-shadow: 0 18px 36px rgba(13, 148, 136, 0.26); }
    .pill { display: inline-flex; align-items: center; gap: 0.4rem; border-radius: 999px; padding: 0.4rem 0.85rem; font-weight: 600; font-size: 0.85rem; }

    .flip-card-btn {
      display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.85rem 1.75rem;
      border-radius: 0.75rem; font-weight: 600; transition: all 0.2s ease-in-out;
      background: linear-gradient(135deg, #f59e0b, #f97316); color: white;
      box-shadow: 0 14px 30px rgba(249, 115, 22, 0.25); border: none; letter-spacing: 0.02em;
    }
    .flip-card-btn:hover {
      background: linear-gradient(135deg, #ea580c, #f97316); transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(234, 88, 12, 0.35);
    }
    .flip-card-btn:focus-visible {
      outline: 3px solid rgba(244, 114, 182, 0.35);
      outline-offset: 3px;
    }

    .mobile-chat-toggle {
      display: none;
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 80;
      box-shadow: 0 14px 30px rgba(59, 130, 246, 0.3);
      background: linear-gradient(135deg, #4f46e5, #0ea5e9);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 999px;
      padding: 0.65rem;
      gap: 0.4rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      min-width: 0;
      width: 3.25rem;
      height: 3.25rem;
      align-items: center;
      justify-content: center;
      line-height: 1;
      pointer-events: auto;
      touch-action: manipulation;
    }

    .mobile-chat-toggle i { font-size: 1.05rem; }
    .mobile-chat-label { display: none; }

    @media (min-width: 520px) and (max-width: 1024px) {
      .mobile-chat-toggle {
        width: auto;
        height: auto;
        padding: 0.65rem 0.95rem;
        border-radius: 999px;
        gap: 0.5rem;
      }

      .mobile-chat-label { display: inline; }
    }

    .mobile-chat-toggle:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 18px 38px rgba(37, 99, 235, 0.32);
      filter: brightness(1.03);
    }

    .mobile-chat-toggle:active { transform: translateY(0); filter: brightness(0.98); }
    .mobile-chat-toggle.is-active { box-shadow: 0 16px 32px rgba(37, 99, 235, 0.35); }
    .chat-panel .close-chat-btn { display: none; }
    .mobile-score-banner { display: none; }
    .mobile-info-panel { display: none; }

    @media (max-width: 1024px) {
      .card-toolbar {
        padding: calc(0.3rem + env(safe-area-inset-top, 0px)) 0.4rem 0.4rem;
        gap: 0.35rem;
      }
      .toolbar-left,
      .toolbar-right {
        gap: 0.2rem;
        flex-wrap: nowrap;
      }
      .card-toolbar .label {
        font-size: 0.74rem;
        min-width: 76px;
        padding: 0.25rem 0.4rem;
        letter-spacing: 0.04em;
        flex: 0 1 auto;
      }
      .card-toolbar .icon-btn {
        width: 34px;
        height: 34px;
        font-size: 0.9rem;
      }
      .card-toolbar .play-audio-btn {
        width: 36px;
        height: 36px;
        border-radius: 11px;
        padding: 0;
      }
      .session-sidebar { display: none !important; } /* Ẩn cột phải ở mobile */
      .flashcard-wrapper { flex: 1; padding: 0 !important; overflow: hidden; display: flex; flex-direction: column; }
      .flashcard-panel { padding: 0.35rem 0.25rem 0.45rem; gap: 0.55rem; }
      .flashcard-card-container, .flashcard-card { height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
      .face { padding: calc(64px + env(safe-area-inset-top, 0px)) 0.1rem 0.2rem 0.1rem !important; }
      ._card-container { padding: 0.05rem !important; }
      .text-area { flex: 1; padding: 0.1rem 0.05rem !important; }
      .actions { margin-top: 0.5rem !important; padding: 0.15rem 0.15rem !important; gap: 0.15rem; justify-content: center; width: 100%; position: sticky; bottom: 0; }
      .flashcard-card { padding: 0.05rem !important; }
      .flashcard-card-container { min-height: 60vh; }
      .card-toolbar .mobile-info-btn { display: inline-flex !important; }

      /* Chat Panel Mobile Overlay */
      .chat-panel {
        display: flex; position: fixed; inset: 0; z-index: 9990;
        background: rgba(15, 23, 42, 0.45); backdrop-filter: blur(8px);
        align-items: flex-end; justify-content: center; padding: 0.75rem;
        opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.3s ease;
      }
      .chat-panel .chat-box {
        width: 100%; max-width: 720px; height: 90vh !important; 
        background: #ffffff; border-radius: 18px 18px 0 0; padding-bottom: 1.5rem;
        transform: translateY(12%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .chat-panel.open { opacity: 1; visibility: visible; pointer-events: auto; }
      .chat-panel.open .chat-box { transform: translateY(0); }
      .chat-panel .close-chat-btn { display: inline-flex; } /* Hiện nút đóng ở mobile */
      
      .mobile-chat-toggle { display: flex; }
      .mobile-info-panel { display: none; position: fixed; inset: 0; z-index: 50; background: rgba(15, 23, 42, 0.4); align-items: flex-end; justify-content: center; }
      .mobile-info-panel.open { display: flex; }
      .mobile-info-sheet { width: 100%; max-width: 720px; background: #ffffff; border-radius: 18px 18px 0 0; padding: 1.25rem; overflow-y: auto; max-height: 78vh; }
      .mobile-score-banner { display: flex; flex-direction: column; gap: 0.75rem; padding: 0.75rem; border-radius: 12px; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; }
    }
    @media (max-width: 640px) {
      .card-toolbar {
        padding: 0.35rem 0.4rem;
        gap: 0.3rem;
      }
      .toolbar-left, .toolbar-right { gap: 0.2rem; }
      .card-toolbar .label {
        font-size: 0.74rem;
        padding: 0.2rem 0.4rem;
        min-width: 76px;
      }
      .card-toolbar .icon-btn {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        font-size: 0.88rem;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="collab-hero">
    <div class="collab-hero__grid">
      <div class="collab-hero__meta">
        <span class="hero-kicker"><span class="dot"></span>Flashcard Collab</span>
        <div class="collab-hero__title">
          {{ room_payload.title or 'Phòng học chung' }}
          <span class="hero-chip"><i class="fas fa-fingerprint"></i> Mã phòng <strong>{{ room_payload.room_code }}</strong></span>
        </div>
        <p class="collab-hero__subtitle">
          Tham gia học cùng nhau với bộ "{{ room_payload.container_title or ('Bộ #' ~ room_payload.container_id) }}".
          Mọi người trả lời đồng thời và thẻ mới chỉ xuất hiện khi cả phòng đã hoàn tất lượt hiện tại.
        </p>
        <div class="collab-hero__chips">
          <span class="hero-chip"><i class="fas fa-bolt"></i> Chế độ {{ room_payload.mode }}</span>
          <span class="hero-chip"><i class="fas fa-sliders-h"></i> {{ room_payload.button_count or 3 }} nút chọn đáp án</span>
          <span class="hero-chip"><i class="fas fa-user"></i> Chủ phòng: {{ room_payload.host_username or '—' }}</span>
        </div>
        <div class="hero-actions">
          <button type="button" class="hero-btn" id="collab-refresh-round-hero"><i class="fas fa-rotate"></i> Làm mới thẻ</button>
          <a href="{{ url_for('learning.flashcard.dashboard') }}" class="hero-btn secondary"><i class="fas fa-th-large"></i> Quay lại dashboard</a>
        </div>
      </div>
      <div class="collab-hero__stats">
        <div class="hero-stat-row">
          <div class="hero-stat">
            <div>
              <small>Thành viên</small>
              <span id="collab-participant-count-hero">{{ room_payload.participants | length }}</span>
            </div>
            <i class="fas fa-users"></i>
          </div>
          <div class="hero-stat">
            <div>
              <small>Thứ tự thẻ</small>
              <span id="collab-round-step-hero">—</span>
            </div>
            <i class="fas fa-layer-group"></i>
          </div>
          <div class="hero-stat">
            <div>
              <small>Điểm của bạn</small>
              <span>{{ current_user.total_score or 0 }}</span>
            </div>
            <i class="fas fa-star"></i>
          </div>
        </div>
        <div class="hero-status" id="collab-round-status-hero">
          <i class="fas fa-circle-notch fa-spin"></i>
          <span>Đang chuẩn bị thẻ đầu tiên...</span>
        </div>
      </div>
    </div>
  </div>

  <div class="session-layout">
    <!-- CỘT TRÁI: FLASHCARD -->
    <div class="flashcard-wrapper">
      <div class="card-surface flashcard-panel" id="collab-learning-card">
        <div class="flex items-start justify-between gap-3 collab-room-meta hidden lg:flex">
          <div>
            <p class="text-sm text-slate-500">Thẻ tiếp theo sẽ xuất hiện khi tất cả thành viên đã trả lời.</p>
            <div class="flex items-center gap-2 mt-2 text-sm text-slate-600">
              <span class="pill bg-amber-50 text-amber-700"><i class="fas fa-circle-notch animate-spin"></i> Đang tải thẻ đầu tiên...</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-right">
              <p class="text-xs text-slate-500">Điểm của bạn</p>
              <p class="text-2xl font-extrabold text-indigo-600" id="collab-user-score">{{ current_user.total_score or 0 }}</p>
            </div>
            <button type="button" id="collab-refresh-round" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
              <i class="fas fa-rotate"></i> Làm mới thẻ
            </button>
          </div>
        </div>

        <div class="flashcard-card-container">
          <div class="flashcard-card" id="collab-card">
            <div class="face front">
              <div class="card-toolbar">
                <div class="toolbar-left">
                  <button type="button" class="icon-btn mobile-info-btn open-mobile-info-btn" title="Mở menu phòng"><i class="fas fa-bars"></i></button>
                  <button type="button" class="icon-btn collab-ai-btn" title="Mindstack AI"><i class="fas fa-robot"></i></button>
                  <button type="button" class="icon-btn collab-note-btn" title="Ghi chú"><i class="fas fa-sticky-note"></i></button>
                </div>
                <span class="label">MẶT TRƯỚC</span>
                <div class="toolbar-right">
                  <button type="button" class="icon-btn play-audio-btn collab-audio-btn" data-side="front" data-audio-target="#collab-front-audio" title="Nghe nội dung"><i class="fas fa-volume-up"></i></button>
                  <div class="toolbar-settings">
                    <div class="settings-panel">
                      <button type="button" class="icon-btn collab-feedback-btn" title="Phản hồi"><i class="fas fa-flag"></i></button>
                      {% if can_edit_flashcards %}
                      <button type="button" class="icon-btn collab-edit-btn" title="Chỉnh sửa"><i class="fas fa-pencil-alt"></i></button>
                      {% endif %}
                      <button type="button" class="icon-btn image-toggle-btn collab-image-toggle-btn" aria-pressed="false" title="Tắt ảnh"><i class="fas fa-image"></i></button>
                      <button type="button" class="icon-btn collab-autoplay-toggle-btn" aria-pressed="true" title="Tắt tự động phát audio"><i class="fas fa-volume-up"></i></button>
                    </div>
                    <button type="button" class="icon-btn settings-toggle-btn" aria-expanded="false" title="Mở cài đặt"><i class="fas fa-ellipsis-v"></i></button>
                  </div>
                </div>
              </div>
              <div class="_card-container">
                <div class="text-area"><div id="collab-card-front" class="flashcard-content-text">—</div></div>
                <div class="media-container hidden" id="collab-card-front-media"></div>
                <audio id="collab-front-audio" class="hidden"></audio>
              </div>
              <div class="flex justify-center p-4">
                <button type="button" id="collab-flip-btn" class="flip-card-btn">
                  <i class="fas fa-sync-alt"></i> Lật thẻ
                </button>
              </div>
            </div>
            <div class="face back">
              <div class="card-toolbar">
                <div class="toolbar-left">
                  <button type="button" class="icon-btn mobile-info-btn open-mobile-info-btn" title="Mở menu phòng"><i class="fas fa-bars"></i></button>
                  <button type="button" class="icon-btn collab-ai-btn" title="Mindstack AI"><i class="fas fa-robot"></i></button>
                  <button type="button" class="icon-btn collab-note-btn" title="Ghi chú"><i class="fas fa-sticky-note"></i></button>
                </div>
                <span class="label">MẶT SAU</span>
                <div class="toolbar-right">
                  <button type="button" class="icon-btn play-audio-btn collab-audio-btn" data-side="back" data-audio-target="#collab-back-audio" title="Nghe nội dung"><i class="fas fa-volume-up"></i></button>
                  <div class="toolbar-settings">
                    <div class="settings-panel">
                      <button type="button" class="icon-btn collab-feedback-btn" title="Phản hồi"><i class="fas fa-flag"></i></button>
                      {% if can_edit_flashcards %}
                      <button type="button" class="icon-btn collab-edit-btn" title="Chỉnh sửa"><i class="fas fa-pencil-alt"></i></button>
                      {% endif %}
                      <button type="button" class="icon-btn image-toggle-btn collab-image-toggle-btn" aria-pressed="false" title="Tắt ảnh"><i class="fas fa-image"></i></button>
                      <button type="button" class="icon-btn collab-autoplay-toggle-btn" aria-pressed="true" title="Tắt tự động phát audio"><i class="fas fa-volume-up"></i></button>
                    </div>
                    <button type="button" class="icon-btn settings-toggle-btn" aria-expanded="false" title="Mở cài đặt"><i class="fas fa-ellipsis-v"></i></button>
                  </div>
                </div>
              </div>
              <div class="_card-container">
                <div class="text-area"><div id="collab-card-back" class="flashcard-content-text">—</div></div>
                <div class="media-container hidden" id="collab-card-back-media"></div>
                <audio id="collab-back-audio" class="hidden"></audio>
              </div>
              <div class="actions" id="collab-answer-actions" data-button-count="{{ room_payload.button_count or 3 }}"></div>
              <p id="collab-answer-feedback" class="text-xs text-slate-600 px-6 pb-2"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CỘT PHẢI: SIDEBAR + CHAT -->
    <div class="session-sidebar" id="sidebar-container">
      <!-- Room meta -->
      <div class="card-surface sidebar-card room-meta-card">
        <div class="flex items-start justify-between gap-3">
          <div class="space-y-2">
            <div class="space-y-1">
              <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Phòng học Flashcard</p>
              <p class="text-xl font-bold text-slate-900 leading-tight">{{ room_payload.title or 'Phòng học chung' }}</p>
            </div>
            <div class="flex flex-wrap items-center text-xs text-slate-600 room-meta-pills">
              <span class="pill bg-slate-100 text-slate-700"><i class="fas fa-layer-group"></i> {{ room_payload.container_title or ('Bộ #' ~ room_payload.container_id) }}</span>
              <span class="pill bg-indigo-50 text-indigo-700"><i class="fas fa-bolt"></i> {{ room_payload.mode }}</span>
              <span class="pill bg-amber-50 text-amber-700"><i class="fas fa-sliders-h"></i> {{ room_payload.button_count or 3 }} nút</span>
              <span class="pill bg-emerald-50 text-emerald-700"><i class="fas fa-user"></i> {{ room_payload.host_username or '—' }}</span>
              <span class="pill bg-slate-200 text-slate-800 font-mono">{{ room_payload.room_code }}</span>
            </div>
          </div>
          <div class="flex flex-col gap-2 shrink-0 text-right">
            <button type="button" id="copy-room-code" class="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-xs font-semibold bg-white shadow-sm hover:bg-slate-50">
              <i class="fas fa-copy"></i> Sao chép
            </button>
            <a href="{{ url_for('learning.flashcard.dashboard') }}" class="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-xs font-semibold bg-white shadow-sm hover:bg-slate-50">
              <i class="fas fa-arrow-left"></i> Danh sách phòng
            </a>
          </div>
        </div>
      </div>

      <!-- Status card -->
      <div class="card-surface sidebar-card status-compact">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Tiến trình</p>
            <p class="text-sm font-semibold text-slate-900">Lượt & thành viên</p>
          </div>
          <div class="status-badges">
            <span class="pill bg-slate-100 text-slate-700 text-xs">Thứ tự: <span id="collab-round-step" class="font-semibold">—</span></span>
            <span class="pill bg-slate-100 text-slate-700 text-xs">Thành viên: <span id="collab-participant-count" class="font-semibold">{{ room_payload.participants | length }}</span></span>
          </div>
        </div>

        <div class="space-y-3">
          <div class="space-y-1">
            <p class="text-xs uppercase tracking-wide text-slate-500">Diễn biến lượt</p>
            <div id="collab-round-status" class="flex flex-col gap-1 text-sm text-slate-700"></div>
          </div>
          <div class="space-y-1">
            <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-500">
              <span>Danh sách tham gia</span>
            </div>
            <ul id="collab-round-participants" class="compact-list divide-y divide-slate-200 text-sm text-slate-700"></ul>
          </div>
        </div>
      </div>

      <!-- Chat Panel (Desktop: Sẽ được JS move vào đây) -->
      <!-- Lưu ý: Khi ở trong sidebar, nó sẽ chiếm flex: 1 -->
    </div>
  </div>

  <!-- CHAT PANEL: Mặc định nằm ngoài để JS move -->
  <div id="collab-chat-panel" class="chat-panel">
    <!-- class chat-box sẽ là flex container -->
    <div class="chat-box">
      <div class="chat-header flex-shrink-0">
        <div class="chat-header__title">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Trò chuyện</p>
          <p class="text-lg font-semibold text-slate-900">Trao đổi trong phòng</p>
        </div>
        <button type="button" class="close-chat-btn inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-sm font-semibold text-slate-700 hover:bg-slate-200">
          <i class="fas fa-times"></i> Đóng
        </button>
      </div>
      
      <div class="mobile-score-banner flex-shrink-0">
        <div id="collab-chat-round-status" class="text-sm font-medium text-slate-700 pb-2 border-b border-slate-100">
           Đang tải trạng thái...
        </div>
        <div class="pt-2">
           <div class="flex justify-between items-center mb-1">
              <p class="text-xs uppercase tracking-wide text-slate-500">Bảng xếp hạng</p>
              <span class="text-xs text-slate-400" id="collab-chat-participant-count">0 thành viên</span>
           </div>
           <ul id="collab-chat-participants" class="grid grid-cols-2 gap-2 text-sm"></ul>
        </div>
      </div>

      <div id="collab-chat-messages" class="chat-messages space-y-2 text-sm text-slate-800">
        <p class="text-slate-500">Đang tải tin nhắn...</p>
      </div>

      <form id="collab-chat-form" class="chat-form flex-shrink-0">
        <input id="collab-chat-input" type="text" class="chat-input" placeholder="Nhập tin nhắn..." autocomplete="off">
        <button type="submit" class="chat-send-btn">
          <i class="fas fa-paper-plane"></i> Gửi
        </button>
      </form>
    </div>
  </div>

  <!-- MOBILE INFO PANEL -->
  <div id="collab-mobile-info-panel" class="mobile-info-panel">
    <div class="mobile-info-sheet space-y-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Phòng học Flashcard</p>
          <p class="text-xl font-bold text-slate-900">{{ room_payload.title or 'Phòng học chung' }}</p>
          <p class="text-sm text-slate-600">Chế độ: {{ room_payload.mode }} · {{ room_payload.button_count or 3 }} nút · Mã: {{ room_payload.room_code }}</p>
        </div>
        <button type="button" class="icon-btn close-mobile-info-btn" title="Đóng"><i class="fas fa-times"></i></button>
      </div>

      <div class="rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-2">
        <p class="text-sm text-slate-600">Thẻ tiếp theo sẽ xuất hiện khi tất cả thành viên đã trả lời.</p>
        <div id="collab-round-status-mobile" class="flex flex-wrap items-center gap-2 text-sm text-slate-700">
          <span class="pill bg-amber-50 text-amber-700"><i class="fas fa-circle-notch animate-spin"></i> Đang tải thẻ đầu tiên...</span>
        </div>
        <div class="flex items-center justify-between gap-3 pt-2 border-t border-slate-200">
          <div>
            <p class="text-xs text-slate-500">Điểm của bạn</p>
            <p class="text-2xl font-extrabold text-indigo-600" id="collab-user-score-mobile-menu">{{ current_user.total_score or 0 }}</p>
          </div>
          <div class="text-right">
            <p class="text-xs text-slate-500">Thứ tự thẻ</p>
            <p class="text-sm font-semibold text-slate-800" id="collab-round-step-mobile">—</p>
          </div>
          <button type="button" id="collab-refresh-round-mobile" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-sm font-semibold bg-white shadow-sm hover:bg-slate-50">
            <i class="fas fa-rotate"></i> Làm mới thẻ
          </button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 text-sm text-slate-700">
        <div class="bg-slate-50 rounded-lg p-3">
          <p class="text-xs text-slate-500">Chủ phòng</p>
          <p class="font-semibold">{{ room_payload.host_username or '—' }}</p>
        </div>
        <div class="bg-slate-50 rounded-lg p-3">
          <p class="text-xs text-slate-500">Trạng thái</p>
          <p class="font-semibold capitalize">{{ room_payload.status }}</p>
        </div>
        <div class="bg-slate-50 rounded-lg p-3">
          <p class="text-xs text-slate-500">Mã phòng</p>
          <p class="font-mono tracking-widest text-sm">{{ room_payload.room_code }}</p>
        </div>
        <div class="bg-slate-50 rounded-lg p-3">
          <p class="text-xs text-slate-500">Tổng thành viên</p>
          <p class="font-semibold" id="collab-participant-count-mobile">{{ room_payload.participants | length }}</p>
        </div>
      </div>

      <div class="space-y-2">
        <p class="text-sm font-semibold text-slate-800">Danh sách tham gia</p>
        <ul id="collab-round-participants-mobile" class="divide-y divide-slate-200 text-sm text-slate-700"></ul>
      </div>
    </div>
  </div>

  <button type="button" id="open-chat-btn" class="mobile-chat-toggle" aria-label="Mở chat">
    <i class="fas fa-comments" aria-hidden="true"></i>
  </button>

  {% include 'notes/_note_panel.html' %}
  {% include 'ai_services/_ai_modal.html' %}
  {% include 'feedback/_feedback_modal.html' %}
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('learning.flashcard_learning.static', filename='flashcard_viewport.js') }}"></script>
  <script>
    const refreshViewportSizing = () => {
      if (window.flashcardViewport && typeof window.flashcardViewport.refresh === 'function') {
        window.flashcardViewport.refresh();
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('flashcard-session-active');
      refreshViewportSizing();
    });
    window.addEventListener('beforeunload', () => {
      document.body.classList.remove('flashcard-session-active');
    });
    window.addEventListener('orientationchange', refreshViewportSizing, { passive: true });
    window.addEventListener('resize', refreshViewportSizing, { passive: true });

    document.getElementById('copy-room-code')?.addEventListener('click', () => {
      const code = {{ room_payload.room_code | tojson }};
      navigator.clipboard.writeText(code).catch(() => {});
    });

    // --- FIX: LOGIC TỰ ĐỘNG CHUYỂN VỊ TRÍ KHUNG CHAT ---
    (() => {
      const chatPanel = document.getElementById('collab-chat-panel');
      const sidebarContainer = document.getElementById('sidebar-container');
      const pageShell = document.querySelector('.page-shell');

      const repositionChat = () => {
        if (!chatPanel || !sidebarContainer || !pageShell) return;
        
        const isMobile = window.innerWidth <= 1024;

        if (isMobile) {
          if (chatPanel.parentElement !== pageShell) {
            pageShell.appendChild(chatPanel);
          }
        } else {
          if (chatPanel.parentElement !== sidebarContainer) {
            sidebarContainer.appendChild(chatPanel);
          }
        }
      };

      repositionChat();
      window.addEventListener('resize', repositionChat);
    })();

    // Flashcard Logic
    (() => {
      const nextCardUrl = {{ url_for('learning.flashcard_collab.get_next_card', room_code=room_payload.room_code) | tojson }};
      const submitAnswerUrl = {{ url_for('learning.flashcard_collab.submit_collab_answer', room_code=room_payload.room_code) | tojson }};
      const roomButtonCount = Number({{ room_payload.button_count or 3 }}) || 3;
      const regenerateAudioUrl = {{ url_for('learning.flashcard_learning.regenerate_audio_from_content') | tojson }};
      const currentUserId = {{ current_user.user_id }};
      const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfHeaders = csrfTokenMeta ? { 'X-CSRFToken': csrfTokenMeta.getAttribute('content') } : {};

      const cardFrontEl = document.getElementById('collab-card-front');
      const cardBackEl = document.getElementById('collab-card-back');
      const cardFrontMediaEl = document.getElementById('collab-card-front-media');
      const cardBackMediaEl = document.getElementById('collab-card-back-media');
      const frontAudioEl = document.getElementById('collab-front-audio');
      const backAudioEl = document.getElementById('collab-back-audio');
      const cardEl = document.getElementById('collab-card');
      const mediaContainers = [cardFrontMediaEl, cardBackMediaEl].filter(Boolean);
      const cardContainers = Array.from(document.querySelectorAll('#collab-card ._card-container'));
      const frontLabel = cardEl?.querySelector('.front .card-toolbar .label');
      const backLabel = cardEl?.querySelector('.back .card-toolbar .label');
      const statusEl = document.getElementById('collab-round-status');
      const participantsEl = document.getElementById('collab-round-participants');
      const heroRoundStatusEl = document.getElementById('collab-round-status-hero');
      let answerButtons = [];
      const answerActionsEl = document.getElementById('collab-answer-actions');
      const feedbackEl = document.getElementById('collab-answer-feedback');
      const refreshBtn = document.getElementById('collab-refresh-round');
      const refreshBtnHero = document.getElementById('collab-refresh-round-hero');
      const refreshBtnMobile = document.getElementById('collab-refresh-round-mobile');
      const flipBtn = document.getElementById('collab-flip-btn');
      const roundStepEl = document.getElementById('collab-round-step');
      const heroRoundStepEl = document.getElementById('collab-round-step-hero');
      const userScoreEl = document.getElementById('collab-user-score');
      const mobileUserScoreMenuEl = document.getElementById('collab-user-score-mobile-menu');
      
      const chatRoundStatusEl = document.getElementById('collab-chat-round-status');
      const chatParticipantsEl = document.getElementById('collab-chat-participants');
      const chatParticipantCountEl = document.getElementById('collab-chat-participant-count');

      const participantCountEls = [
        document.getElementById('collab-participant-count'),
        document.getElementById('collab-participant-count-mobile'),
        document.getElementById('collab-participant-count-hero'),
      ].filter(Boolean);
      const noteButtons = document.querySelectorAll('.collab-note-btn');
      const aiButtons = document.querySelectorAll('.collab-ai-btn');
      const feedbackButtons = document.querySelectorAll('.collab-feedback-btn');
      const editButtons = document.querySelectorAll('.collab-edit-btn');
      const imageToggleButtons = document.querySelectorAll('.collab-image-toggle-btn');
      const audioButtons = document.querySelectorAll('.collab-audio-btn');
      const notePanel = document.getElementById('note-panel');
      const noteTextarea = document.getElementById('note-textarea');
      const saveNoteBtn = document.getElementById('save-note-btn');
      const cancelNoteBtn = document.getElementById('cancel-note-btn');
      const mobileInfoPanel = document.getElementById('collab-mobile-info-panel');
      const openMobileInfoBtns = document.querySelectorAll('.open-mobile-info-btn');
      const closeMobileInfoBtn = document.querySelector('.close-mobile-info-btn');
      const mobileRoundStatusEl = document.getElementById('collab-round-status-mobile');
      const mobileRoundParticipantsEl = document.getElementById('collab-round-participants-mobile');
      const mobileRoundStepEl = document.getElementById('collab-round-step-mobile');
      const autoplayToggleButtons = document.querySelectorAll('.collab-autoplay-toggle-btn');

      const editUrlTemplate = {{ url_for('content_management.content_management_flashcards.edit_flashcard_item', set_id=room_payload.container_id, item_id=0) | tojson }};

      let isMediaHidden = false;
      let isAudioAutoplayEnabled = true;
      let storedAudioAutoplay = null;
      try {
        const storedState = localStorage.getItem('flashcardHideImages');
        if (storedState === 'true') {
          isMediaHidden = true;
        }
        storedAudioAutoplay = localStorage.getItem('flashcardAutoPlayAudio');
      } catch (err) {
        console.warn('Không thể đọc trạng thái hiển thị ảnh:', err);
      }

      if (storedAudioAutoplay === 'false') {
        isAudioAutoplayEnabled = false;
      }

      let currentRound = null;
      let currentCardId = null;
      let isFetching = false;
      let pollHandle = null;
      let hasAnsweredCurrentCard = false;
      let frontAutoplayedItemId = null;
      let backAutoplayedItemId = null;
      let currentFrontAudioUrl = '';
      let currentBackAudioUrl = '';

      const toggleMobileInfoPanel = (isOpen) => {
        if (!mobileInfoPanel) return;
        mobileInfoPanel.classList.toggle('open', isOpen);
      };

      const adjustCardLayout = () => {
        const textAreas = cardEl?.querySelectorAll('.text-area') || [];

        textAreas.forEach((scrollArea) => {
          const txt = scrollArea.querySelector('.flashcard-content-text');
          if (!txt) return;

          txt.style.fontSize = '';
          scrollArea.classList.remove('has-scroll');
          scrollArea.parentElement?.classList?.remove('has-scroll');

          setTimeout(() => {
            const hasScroll = scrollArea.scrollHeight > scrollArea.clientHeight;

            if (hasScroll) {
              scrollArea.classList.add('has-scroll');
              scrollArea.parentElement?.classList?.add('has-scroll');
              scrollArea.scrollTop = 0;
            }

            let current = parseFloat(getComputedStyle(txt).fontSize) || 22;
            const min = 18;
            while (scrollArea.scrollHeight > scrollArea.clientHeight && current > min) {
              current -= 1;
              txt.style.fontSize = `${current}px`;
            }
          }, 0);
        });
      };

      const applyMediaVisibility = () => {
        mediaContainers.forEach((container) => {
          const hasMedia = container?.dataset.hasMedia === 'true';
          container?.classList.toggle('hidden', isMediaHidden || !hasMedia);
        });

        cardContainers.forEach((container) => {
          container.classList.toggle('media-hidden', isMediaHidden);
        });

        imageToggleButtons.forEach((btn) => {
          btn.classList.toggle('is-active', isMediaHidden);
          btn.setAttribute('aria-pressed', isMediaHidden ? 'true' : 'false');
          btn.title = isMediaHidden ? 'Bật ảnh' : 'Tắt ảnh';
          const icon = btn.querySelector('i');
          if (icon) {
            icon.className = `fas ${isMediaHidden ? 'fa-image-slash' : 'fa-image'}`;
          }
        });

        adjustCardLayout();
      };

      const setMediaHiddenState = (hidden) => {
        isMediaHidden = hidden;
        try {
          localStorage.setItem('flashcardHideImages', hidden ? 'true' : 'false');
        } catch (err) {
          console.warn('Không thể lưu trạng thái hiển thị ảnh:', err);
        }

        applyMediaVisibility();
      };

      const persistAudioAutoplayPreference = (enabled) => {
        try {
          localStorage.setItem('flashcardAutoPlayAudio', enabled ? 'true' : 'false');
        } catch (err) {
          console.warn('Không thể lưu cấu hình tự động phát audio:', err);
        }
      };

      const updateAudioAutoplayToggleButtons = () => {
        autoplayToggleButtons.forEach((btn) => {
          btn.classList.toggle('is-active', isAudioAutoplayEnabled);
          btn.setAttribute('aria-pressed', isAudioAutoplayEnabled ? 'true' : 'false');
          btn.title = isAudioAutoplayEnabled ? 'Tắt tự động phát audio' : 'Bật tự động phát audio';
          const icon = btn.querySelector('i');
          if (icon) {
            icon.className = `fas ${isAudioAutoplayEnabled ? 'fa-volume-up' : 'fa-volume-mute'}`;
          }
        });
      };

      const setAudioAutoplayEnabled = (enabled) => {
        isAudioAutoplayEnabled = enabled;
        persistAudioAutoplayPreference(enabled);
        updateAudioAutoplayToggleButtons();
        if (!enabled) {
          stopAllFlashcardAudio();
        }
      };

      const closeAllSettingsMenus = () => {
        document.querySelectorAll('.toolbar-settings').forEach((menu) => {
          menu.classList.remove('is-open');
          const toggleBtn = menu.querySelector('.settings-toggle-btn');
          if (toggleBtn) {
            toggleBtn.setAttribute('aria-expanded', 'false');
          }
        });
      };

      const toggleSettingsMenu = (menuEl) => {
        if (!menuEl) return;
        const isOpen = menuEl.classList.contains('is-open');
        closeAllSettingsMenus();
        menuEl.classList.toggle('is-open', !isOpen);
        const toggleBtn = menuEl.querySelector('.settings-toggle-btn');
        if (toggleBtn) {
          toggleBtn.setAttribute('aria-expanded', (!isOpen).toString());
        }
      };

      document.addEventListener('click', (evt) => {
        const settingsToggle = evt.target.closest('.settings-toggle-btn');
        if (settingsToggle) {
          evt.stopPropagation();
          toggleSettingsMenu(settingsToggle.closest('.toolbar-settings'));
          return;
        }

        const autoplayToggle = evt.target.closest('.collab-autoplay-toggle-btn');
        if (autoplayToggle) {
          evt.stopPropagation();
          setAudioAutoplayEnabled(!isAudioAutoplayEnabled);
          return;
        }

        if (!evt.target.closest('.toolbar-settings')) {
          closeAllSettingsMenus();
        }
      });

      function stopAllFlashcardAudio(exceptAudio = null) {
        const audioElements = document.querySelectorAll('#collab-card audio');
        audioElements.forEach((audioEl) => {
          if (exceptAudio && audioEl === exceptAudio) return;
          try {
            if (!audioEl.paused) {
              audioEl.pause();
            }
            audioEl.currentTime = 0;
          } catch (err) {
            console.warn('Không thể dừng audio:', err);
          }
        });
      }

      function playAudioAfterLoad(audioPlayer, { restart = true, awaitCompletion = false } = {}) {
        return new Promise((resolve) => {
          if (!audioPlayer) {
            resolve();
            return;
          }

          const cleanup = () => {
            audioPlayer.removeEventListener('canplay', onCanPlay);
            if (awaitCompletion) {
              audioPlayer.removeEventListener('ended', onEnded);
              audioPlayer.removeEventListener('error', onError);
            }
          };

          const onEnded = () => {
            cleanup();
            resolve();
          };

          const onError = () => {
            cleanup();
            resolve();
          };

          const onCanPlay = () => {
            audioPlayer.removeEventListener('canplay', onCanPlay);
            if (restart) {
              try {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
              } catch (err) {
                console.warn('Không thể đặt lại audio:', err);
              }
            }

            const playPromise = audioPlayer.play();
            if (!awaitCompletion) {
              cleanup();
              if (playPromise && typeof playPromise.catch === 'function') {
                playPromise.catch(() => {});
              }
              resolve();
            } else if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch(() => {
                cleanup();
                resolve();
              });
            }
          };

          if (awaitCompletion) {
            audioPlayer.addEventListener('ended', onEnded, { once: true });
            audioPlayer.addEventListener('error', onError, { once: true });
          }

          if (audioPlayer.readyState >= 2) {
            onCanPlay();
          } else {
            audioPlayer.addEventListener('canplay', onCanPlay);
            try {
              audioPlayer.load();
            } catch (err) {
              cleanup();
              resolve();
            }
          }
        });
      }

      async function generateAndPlayAudio(button, audioPlayer, options = {}) {
        const itemId = button.dataset.itemId;
        const side = button.dataset.side;
        const contentToRead = button.dataset.contentToRead;
        const awaitCompletion = options.awaitCompletion === true;
        const suppressLoadingUi = options.suppressLoadingUi === true;
        const restart = options.restart !== false;

        const originalHtml = button.dataset.originalHtml || button.innerHTML;
        if (!button.dataset.originalHtml) {
          button.dataset.originalHtml = originalHtml;
        }

        if (!suppressLoadingUi) {
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        button.classList.add('is-disabled');
        let playbackPromise = Promise.resolve();

        try {
          const response = await fetch(regenerateAudioUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            body: JSON.stringify({ item_id: itemId, side, content_to_read: contentToRead }),
          });
          const result = await response.json();
          if (result.success && result.audio_url) {
            audioPlayer.src = result.audio_url;
            playbackPromise = playAudioAfterLoad(audioPlayer, { restart, awaitCompletion });
            if (awaitCompletion) {
              await playbackPromise;
            }
          } else {
            const message = result.message || 'Lỗi khi tạo audio.';
            if (window.showFlashMessage) {
              window.showFlashMessage(message, 'danger');
            }
          }
        } catch (error) {
          console.error('Lỗi khi tạo audio:', error);
          if (window.showFlashMessage) {
            window.showFlashMessage('Không thể kết nối đến máy chủ để tạo audio.', 'danger');
          }
        } finally {
          button.classList.remove('is-disabled');
          if (!suppressLoadingUi) {
            button.innerHTML = button.dataset.originalHtml || '<i class="fas fa-volume-up"></i>';
          }
        }

        return playbackPromise;
      }

      function playAudioForButton(button, options = {}) {
        if (!button) return Promise.resolve();
        const audioPlayer = document.querySelector(button.dataset.audioTarget);
        if (!audioPlayer || button.classList.contains('is-disabled')) {
          return Promise.resolve();
        }

        const awaitCompletion = options.await === true;
        const restart = options.restart !== false;
        const suppressLoadingUi = options.suppressLoadingUi === true;
        const hasAudioSource = audioPlayer.src && audioPlayer.src !== window.location.href;

        if (hasAudioSource) {
          stopAllFlashcardAudio(audioPlayer);
          return playAudioAfterLoad(audioPlayer, { restart, awaitCompletion });
        }

        stopAllFlashcardAudio(audioPlayer);
        return generateAndPlayAudio(button, audioPlayer, { awaitCompletion, suppressLoadingUi, restart });
      }

      function autoPlaySide(side) {
        if (!isAudioAutoplayEnabled) return;
        const button = document.querySelector(`.collab-audio-btn[data-side="${side}"]`);
        if (!button) return;
        playAudioForButton(button, { suppressLoadingUi: true }).catch(() => {});
      }

      updateAudioAutoplayToggleButtons();
      closeAllSettingsMenus();

      const setCardContent = (textEl, mediaEl, rawText, imageUrl, fallbackText, altLabel) => {
        if (textEl) {
          const cleanedText = (rawText || '').trim();
          textEl.textContent = cleanedText || fallbackText;
        }

        if (!mediaEl) return;

        if (imageUrl) {
          mediaEl.innerHTML = `<img src="${imageUrl}" alt="${altLabel || 'Flashcard image'}" onerror="this.onerror=null;this.src='https://placehold.co/240x160?text=Anh+loi';">`;
          mediaEl.dataset.hasMedia = 'true';
        } else {
          mediaEl.innerHTML = '';
          mediaEl.dataset.hasMedia = 'false';
        }

        applyMediaVisibility();
      };

      applyMediaVisibility();

      imageToggleButtons.forEach((btn) => {
        btn.addEventListener('click', () => setMediaHiddenState(!isMediaHidden));
      });

      const syncAnswerButtonsAvailability = () => {
        const shouldDisable = hasAnsweredCurrentCard || !cardEl?.classList.contains('flipped');
        answerButtons.forEach((btn) => {
          btn.disabled = shouldDisable;
          btn.classList.toggle('opacity-60', shouldDisable);
        });
      };

      const generateAnswerButtons = (buttonCount) => {
        const presets = {
          3: [
            { variant: 'again', value: 'quên', title: 'Quên', icon: 'fas fa-redo-alt' },
            { variant: 'hard', value: 'mơ_hồ', title: 'Mơ hồ', icon: 'fas fa-question-circle' },
            { variant: 'easy', value: 'nhớ', title: 'Nhớ', icon: 'fas fa-check-circle' },
          ],
          4: [
            { variant: 'again', value: 'again', title: 'Học lại', icon: 'fas fa-undo' },
            { variant: 'very-hard', value: 'hard', title: 'Khó', icon: 'fas fa-fire' },
            { variant: 'good', value: 'good', title: 'Bình thường', icon: 'fas fa-thumbs-up' },
            { variant: 'easy', value: 'easy', title: 'Dễ', icon: 'fas fa-smile' },
          ],
          6: [
            { variant: 'fail', value: 'fail', title: 'Rất khó', icon: 'fas fa-exclamation-circle' },
            { variant: 'very-hard', value: 'very_hard', title: 'Khó', icon: 'fas fa-fire' },
            { variant: 'hard', value: 'hard', title: 'Trung bình', icon: 'fas fa-adjust' },
            { variant: 'medium', value: 'medium', title: 'Dễ', icon: 'fas fa-leaf' },
            { variant: 'good', value: 'good', title: 'Rất dễ', icon: 'fas fa-thumbs-up' },
            { variant: 'very-easy', value: 'very_easy', title: 'Dễ dàng', icon: 'fas fa-star' },
          ],
        };

        const buttons = presets[buttonCount] || presets[3];
        return buttons
          .map(
            (btn) => `
              <button type="button" data-answer="${btn.value}" class="collab-answer-btn btn rating-btn rating-btn--${btn.variant}">
                <span class="rating-btn__icon"><i class="${btn.icon}"></i></span>
                <span class="rating-btn__title">${btn.title}</span>
              </button>
            `,
          )
          .join('');
      };

      const renderAnswerButtons = (buttonCount) => {
        if (!answerActionsEl) return;
        answerActionsEl.dataset.buttonCount = buttonCount;
        answerActionsEl.innerHTML = generateAnswerButtons(buttonCount);
        answerButtons = Array.from(answerActionsEl.querySelectorAll('.collab-answer-btn'));
        syncAnswerButtonsAvailability();
        answerButtons.forEach((btn) => {
          btn.addEventListener('click', () => submitAnswer(btn.dataset.answer));
        });
      };

      const showFrontSide = () => {
        if (!cardEl) return;
        cardEl.classList.remove('flipped');
        answerActionsEl?.classList.remove('visible');
        flipBtn?.classList.remove('hidden');
        feedbackEl.textContent = '';
        hasAnsweredCurrentCard = false;
        syncAnswerButtonsAvailability();
      };

      const showBackSide = () => {
        if (!cardEl) return;
        cardEl.classList.add('flipped');
        answerActionsEl?.classList.add('visible');
        flipBtn?.classList.add('hidden');
        syncAnswerButtonsAvailability();
        if (isAudioAutoplayEnabled && currentCardId && backAutoplayedItemId !== currentCardId) {
          autoPlaySide('back');
          backAutoplayedItemId = currentCardId;
        }
      };

      const setLoadingState = (message) => {
        const content = message || 'Đang tải...';
        const loadingHtml = `<span class="text-slate-600">${content}</span>`;
        
        if (statusEl) statusEl.innerHTML = content;
        if (heroRoundStatusEl) heroRoundStatusEl.innerHTML = `<span class="text-slate-100">${content}</span>`;
        if (mobileRoundStatusEl) mobileRoundStatusEl.innerHTML = loadingHtml;
        if (chatRoundStatusEl) chatRoundStatusEl.innerHTML = loadingHtml;
      };

      const renderParticipants = (participants = []) => {
        if (!participants.length) {
          const emptyHtml = '<li class="py-2 text-slate-500">Chưa có thành viên đang hoạt động.</li>';
          participantsEl.innerHTML = emptyHtml;
          if (mobileRoundParticipantsEl) mobileRoundParticipantsEl.innerHTML = emptyHtml;
          if (chatParticipantsEl) chatParticipantsEl.innerHTML = '<li class="col-span-2 text-xs text-slate-500 italic">Trống</li>';
          
          participantCountEls.forEach((el) => el.textContent = '0');
          if (chatParticipantCountEl) chatParticipantCountEl.textContent = '0 thành viên';
          return;
        }

        const renderedParticipants = participants.map((participant) => {
          const statusLabel = participant.has_answered ? 'Đã trả lời' : 'Chưa trả lời';
          const statusClass = participant.has_answered ? 'text-green-600' : 'text-slate-500';
          return `
            <li class="py-2 flex items-center justify-between">
              <div>
                <p class="font-semibold">${participant.username || 'Người dùng #' + participant.user_id}</p>
                <p class="text-xs text-slate-500">ID: ${participant.user_id}</p>
              </div>
              <span class="text-xs font-semibold ${statusClass}">${statusLabel}</span>
            </li>
          `;
        }).join('');

        const renderedChatParticipants = participants.map((participant) => {
          const isMe = Number(participant.user_id) === Number(currentUserId);
          const statusDot = participant.has_answered 
            ? '<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>' 
            : '<span class="inline-block w-2 h-2 rounded-full bg-slate-300 mr-1"></span>';
          const score = participant.total_score || 0;
          
          return `
            <li class="flex items-center justify-between bg-white rounded border border-slate-100 px-2 py-1 shadow-sm">
              <div class="flex items-center truncate mr-2">
                ${statusDot}
                <span class="truncate font-medium text-slate-700 ${isMe ? 'text-indigo-600' : ''}">
                  ${isMe ? 'Bạn' : (participant.username || `#${participant.user_id}`)}
                </span>
              </div>
              <span class="font-bold text-slate-900">${score}</span>
            </li>
          `;
        }).join('');

        participantsEl.innerHTML = renderedParticipants;
        if (mobileRoundParticipantsEl) mobileRoundParticipantsEl.innerHTML = renderedParticipants;
        if (chatParticipantsEl) chatParticipantsEl.innerHTML = renderedChatParticipants;

        participantCountEls.forEach((el) => el.textContent = participants.length);
        if (chatParticipantCountEl) chatParticipantCountEl.textContent = `${participants.length} thành viên`;
      };

      const renderRound = (roundPayload) => {
        currentRound = roundPayload;
        const { item, participants = [], all_answered: allAnswered, status } = roundPayload;
        const buttonCount = Number(roundPayload?.button_count || roomButtonCount) || roomButtonCount;
        renderAnswerButtons(buttonCount);

        const itemId = item?.item_id || null;
        const isNewCard = itemId && itemId !== currentCardId;

        if (isNewCard) {
          currentCardId = itemId;
          showFrontSide();
          frontAutoplayedItemId = null;
          backAutoplayedItemId = null;
          stopAllFlashcardAudio();
        }

        setCardContent(
          cardFrontEl,
          cardFrontMediaEl,
          item?.content?.front,
          item?.content?.front_img,
          'Không có nội dung mặt trước',
          'Mặt trước'
        );
        setCardContent(
          cardBackEl,
          cardBackMediaEl,
          item?.content?.back,
          item?.content?.back_img,
          'Không có nội dung mặt sau',
          'Mặt sau'
        );

        const frontAudioUrl = item?.content?.front_audio_url || '';
        const backAudioUrl = item?.content?.back_audio_url || '';
        const frontAudioContent = item?.content?.front_audio_content || '';
        const backAudioContent = item?.content?.back_audio_content || '';

        const normalizedFrontAudioUrl = frontAudioUrl || '';
        const normalizedBackAudioUrl = backAudioUrl || '';

        if (frontAudioEl && (isNewCard || normalizedFrontAudioUrl !== currentFrontAudioUrl)) {
          frontAudioEl.src = normalizedFrontAudioUrl;
          currentFrontAudioUrl = normalizedFrontAudioUrl;
        }
        if (backAudioEl && (isNewCard || normalizedBackAudioUrl !== currentBackAudioUrl)) {
          backAudioEl.src = normalizedBackAudioUrl;
          currentBackAudioUrl = normalizedBackAudioUrl;
        }

        const hasFrontAudio = Boolean(frontAudioUrl || frontAudioContent);
        const hasBackAudio = Boolean(backAudioUrl || backAudioContent);

        audioButtons.forEach((btn) => {
          const side = btn.dataset.side;
          const hasAudio = side === 'front' ? hasFrontAudio : hasBackAudio;
          const contentToRead = side === 'front' ? frontAudioContent : backAudioContent;
          btn.dataset.itemId = itemId || '';
          btn.dataset.contentToRead = contentToRead || '';
          btn.classList.toggle('is-disabled', !hasAudio);
          if (!hasAudio) {
            btn.setAttribute('disabled', 'true');
          } else {
            btn.removeAttribute('disabled');
          }
        });

        adjustCardLayout();
        renderParticipants(participants);

        const currentUserParticipation = participants.find((p) => Number(p.user_id) === Number(currentUserId));
        hasAnsweredCurrentCard = !!currentUserParticipation?.has_answered;
        feedbackEl.textContent = hasAnsweredCurrentCard ? 'Bạn đã trả lời, vui lòng chờ mọi người hoàn tất.' : '';
        if (hasAnsweredCurrentCard) {
          showBackSide();
        } else {
          syncAnswerButtonsAvailability();
        }

        let statusHtml = '';
        if (status === 'completed' && allAnswered) {
          statusHtml = '<span class="pill bg-emerald-50 text-emerald-700"><i class="fas fa-check-circle"></i> Tất cả thành viên đã trả lời. Đang chuẩn bị thẻ tiếp theo...</span>';
        } else if (!allAnswered) {
          statusHtml = '<span class="pill bg-amber-50 text-amber-700"><i class="fas fa-hourglass-half"></i> Đang chờ tất cả thành viên trả lời...</span>';
        } else {
          statusHtml = '<span class="pill bg-indigo-50 text-indigo-700"><i class="fas fa-circle"></i> Đang hiển thị thẻ mới.</span>';
        }

        if (statusEl) statusEl.innerHTML = statusHtml;
        if (heroRoundStatusEl) heroRoundStatusEl.innerHTML = statusHtml;
        if (mobileRoundStatusEl) mobileRoundStatusEl.innerHTML = statusHtml;
        if (chatRoundStatusEl) chatRoundStatusEl.innerHTML = statusHtml;

        const roundStepText = `Thẻ #${item?.item_id || '—'}`;
        roundStepEl.textContent = roundStepText;
        if (heroRoundStepEl) heroRoundStepEl.textContent = roundStepText;
        if (mobileRoundStepEl) mobileRoundStepEl.textContent = `Thẻ #${item?.item_id || '—'}`;

        if (
          isNewCard &&
          isAudioAutoplayEnabled &&
          itemId &&
          frontAutoplayedItemId !== itemId &&
          !cardEl?.classList.contains('flipped')
        ) {
          autoPlaySide('front');
          frontAutoplayedItemId = itemId;
        }
      };

      const fetchRound = async (showLoader = false) => {
        if (isFetching) return;
        isFetching = true;
        if (showLoader) setLoadingState('Đang tải thẻ...');
        try {
          const response = await fetch(nextCardUrl, { credentials: 'same-origin' });
          if (!response.ok) {
            throw new Error('Không thể tải thẻ.');
          }
          const payload = await response.json();
          if (payload) {
            renderRound(payload);
          }
        } catch (err) {
          const errorHtml = `<span class="text-rose-600">${err.message || 'Không thể tải thẻ.'}</span>`;
          if (statusEl) statusEl.innerHTML = errorHtml;
          if (heroRoundStatusEl) heroRoundStatusEl.innerHTML = errorHtml;
          if (mobileRoundStatusEl) mobileRoundStatusEl.innerHTML = errorHtml;
          if (chatRoundStatusEl) chatRoundStatusEl.innerHTML = errorHtml;
        } finally {
          isFetching = false;
        }
      };

      const submitAnswer = async (answerLabel) => {
        if (!currentRound?.item?.item_id || isFetching) return;
        isFetching = true;
        feedbackEl.textContent = 'Đang gửi câu trả lời...';

        if (cardEl && !cardEl.classList.contains('flipped')) {
          showBackSide();
        }

        try {
          const response = await fetch(submitAnswerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({
              item_id: currentRound.item.item_id,
              answer: answerLabel,
            }),
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload?.description || 'Không thể gửi câu trả lời.');
          }

          const payload = await response.json();
          if (payload?.round) {
            renderRound(payload.round);
          }

          const result = payload?.result;
          if (result && typeof result.updated_total_score === 'number') {
            if (userScoreEl) userScoreEl.textContent = result.updated_total_score;
            if (mobileUserScoreMenuEl) mobileUserScoreMenuEl.textContent = result.updated_total_score;
          }
          if (result?.answer_result === 'correct') {
            feedbackEl.textContent = 'Bạn đã trả lời đúng. Chờ các thành viên khác để chuyển thẻ.';
          } else if (result?.answer_result === 'incorrect') {
            feedbackEl.textContent = 'Bạn đã trả lời sai. Chờ các thành viên khác để chuyển thẻ.';
          } else {
            feedbackEl.textContent = 'Đã ghi nhận câu trả lời của bạn.';
          }
          hasAnsweredCurrentCard = true;
          syncAnswerButtonsAvailability();
        } catch (err) {
          feedbackEl.textContent = err.message || 'Có lỗi xảy ra.';
          fetchRound(true);
        } finally {
          isFetching = false;
        }
      };

      const startPolling = () => {
        if (pollHandle) return;
        pollHandle = setInterval(() => fetchRound(false), 4000);
      };

      const stopPolling = () => {
        if (!pollHandle) return;
        clearInterval(pollHandle);
        pollHandle = null;
      };

      frontLabel?.addEventListener('click', (evt) => {
        evt.stopPropagation();
        showBackSide();
      });

      backLabel?.addEventListener('click', (evt) => {
        evt.stopPropagation();
        showFrontSide();
      });

      flipBtn?.addEventListener('click', showBackSide);

      const handleRefresh = () => fetchRound(true);
      refreshBtn?.addEventListener('click', handleRefresh);
      refreshBtnHero?.addEventListener('click', handleRefresh);
      refreshBtnMobile?.addEventListener('click', handleRefresh);

      openMobileInfoBtns.forEach((btn) => btn.addEventListener('click', () => toggleMobileInfoPanel(true)));
      closeMobileInfoBtn?.addEventListener('click', () => toggleMobileInfoPanel(false));
      mobileInfoPanel?.addEventListener('click', (evt) => {
        if (evt.target === mobileInfoPanel) toggleMobileInfoPanel(false);
      });

      audioButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          playAudioForButton(btn).catch(() => {});
        });
      });

      const toggleNotePanel = (isOpen) => {
        if (!notePanel) return;
        notePanel.classList.toggle('open', isOpen);
      };

      const loadNote = async (itemId) => {
        if (!itemId || !noteTextarea) return;
        noteTextarea.value = 'Đang tải ghi chú...';
        try {
          const response = await fetch(`{{ url_for('notes.get_note', item_id=0) }}`.replace('0', itemId), { credentials: 'same-origin' });
          const payload = await response.json();
          noteTextarea.value = payload?.content || '';
        } catch (err) {
          noteTextarea.value = 'Không thể tải ghi chú.';
        }
      };

      const saveNote = async (itemId) => {
        if (!itemId || !noteTextarea) return;
        try {
          const response = await fetch(`{{ url_for('notes.save_note', item_id=0) }}`.replace('0', itemId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({ content: noteTextarea.value || '' }),
          });
          const payload = await response.json();
          if (!response.ok || !payload?.success) {
            throw new Error(payload?.message || 'Không thể lưu ghi chú.');
          }
          feedbackEl.textContent = 'Đã lưu ghi chú của bạn.';
          toggleNotePanel(false);
        } catch (err) {
          feedbackEl.textContent = err.message || 'Có lỗi khi lưu ghi chú.';
        }
      };

      noteButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!currentCardId) {
            feedbackEl.textContent = 'Chưa có thẻ để tạo ghi chú.';
            return;
          }
          toggleNotePanel(true);
          loadNote(currentCardId);
        });
      });

      cancelNoteBtn?.addEventListener('click', () => toggleNotePanel(false));
      saveNoteBtn?.addEventListener('click', () => saveNote(currentCardId));

      aiButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!currentCardId) return;
          openAiModal(currentCardId, cardFrontEl.textContent || '');
        });
      });

      feedbackButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!currentCardId || !window.openFeedbackModal) return;
          openFeedbackModal(currentCardId, cardFrontEl.textContent || '');
        });
      });

      editButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!currentCardId || !editUrlTemplate) return;
          const url = editUrlTemplate.replace('/0', `/${currentCardId}`);
          if (window.parent && typeof window.parent.openModal === 'function') {
            window.parent.openModal(url);
          } else {
            window.open(url, '_blank');
          }
        });
      });

      fetchRound(true);
      startPolling();

      window.addEventListener('beforeunload', stopPolling);
    })();

    // Chat Logic
    document.addEventListener('DOMContentLoaded', () => {
      const messagesUrl = {{ url_for('shared.list_chat_messages', room_type='flashcard-collab', room_code=room_payload.room_code) | tojson }};
      const postMessageUrl = {{ url_for('shared.post_chat_message', room_type='flashcard-collab', room_code=room_payload.room_code) | tojson }};
      const chatMessages = document.getElementById('collab-chat-messages');
      const chatForm = document.getElementById('collab-chat-form');
      const chatInput = document.getElementById('collab-chat-input');
      const chatPanel = document.getElementById('collab-chat-panel');
      const openChatBtn = document.getElementById('open-chat-btn');
      const closeChatBtn = chatPanel?.querySelector('.close-chat-btn');
      const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfHeaders = csrfTokenMeta ? { 'X-CSRFToken': csrfTokenMeta.getAttribute('content') } : {};

      if (!openChatBtn) return;

      let pollHandle = null;

      const renderMessages = (messages = []) => {
        chatMessages.innerHTML = '';

        if (!messages.length) {
          chatMessages.innerHTML = '<p class="text-slate-500">Chưa có tin nhắn nào.</p>';
          return;
        }

        messages.forEach((message) => {
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble';

          const metaRow = document.createElement('div');
          metaRow.className = 'chat-bubble__meta';

          const author = document.createElement('span');
          author.className = 'chat-bubble__author';
          author.textContent = message.username || `Người dùng #${message.user_id}`;

          const timestamp = document.createElement('span');
          timestamp.textContent = message.created_at
            ? new Date(message.created_at).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
            : '';

          metaRow.appendChild(author);
          metaRow.appendChild(timestamp);

          const content = document.createElement('p');
          content.className = 'chat-bubble__content';
          content.textContent = message.content;

          bubble.appendChild(metaRow);
          bubble.appendChild(content);
          chatMessages.appendChild(bubble);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      const loadMessages = async () => {
        try {
          const response = await fetch(messagesUrl, { credentials: 'same-origin' });
          if (!response.ok) {
            throw new Error('Không thể tải tin nhắn.');
          }
          const payload = await response.json();
          renderMessages(payload?.messages || []);
        } catch (err) {
          chatMessages.innerHTML = `<p class="text-sm text-rose-600">${err.message || 'Không thể tải tin nhắn.'}</p>`;
        }
      };

      const sendMessage = async (content) => {
        if (!content.trim()) return;

        chatInput.disabled = true;
        try {
          const response = await fetch(postMessageUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeaders },
            credentials: 'same-origin',
            body: JSON.stringify({ content }),
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload?.description || 'Không thể gửi tin nhắn.');
          }

          chatInput.value = '';
          await loadMessages();
        } catch (err) {
          chatMessages.insertAdjacentHTML(
            'beforeend',
            `<p class="text-sm text-rose-600">${err.message || 'Không thể gửi tin nhắn.'}</p>`
          );
        } finally {
          chatInput.disabled = false;
          chatInput.focus();
        }
      };

      chatForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        sendMessage(chatInput.value || '');
      });

      const setChatOpen = (isOpen) => {
        if (!chatPanel) return;
        
        if (isOpen) {
            chatPanel.classList.add('open');
            chatPanel.style.opacity = '1'; 
            chatPanel.style.visibility = 'visible';
            chatPanel.style.pointerEvents = 'auto';
        } else {
            chatPanel.classList.remove('open');
            chatPanel.style.opacity = ''; 
            chatPanel.style.visibility = '';
            chatPanel.style.pointerEvents = '';
        }
        
        openChatBtn.classList.toggle('is-active', isOpen);
        openChatBtn.setAttribute('aria-pressed', isOpen ? 'true' : 'false');

        if (isOpen && window.matchMedia('(max-width: 1024px)').matches) {
          setTimeout(() => chatInput?.focus({ preventScroll: true }), 100);
        }
      };

      openChatBtn.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        setChatOpen(!chatPanel?.classList.contains('open'));
      });
      
      closeChatBtn?.addEventListener('click', () => setChatOpen(false));
      chatPanel?.addEventListener('click', (event) => {
        if (event.target === chatPanel) {
          setChatOpen(false);
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          setChatOpen(false);
        }
      });

      const startPolling = () => {
        if (pollHandle) return;
        pollHandle = setInterval(loadMessages, 7000);
      };

      const stopPolling = () => {
        if (!pollHandle) return;
        clearInterval(pollHandle);
        pollHandle = null;
      };

      loadMessages();
      startPolling();
      window.addEventListener('beforeunload', stopPolling);
    });
  </script>
{% endblock %}