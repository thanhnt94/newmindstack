{% extends 'base.html' %}
{% block title %}Bảng điều khiển - Thống kê{% endblock %}

{% block head %}
    {{ super() }}
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --background-color: #f9fafb;
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --cal-heatmap-scrolly-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; font-family: 'Inter', sans-serif; }
        .dashboard-header { font-size: 2.25rem; font-weight: 800; color: var(--text-primary); text-align: center; margin-bottom: 2.5rem; }
        .stats-section { background-color: var(--card-background); border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); margin-bottom: 2rem; }
        .section-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1.5rem; display: flex; align-items: center; }
        .section-title i { color: var(--primary-color); margin-right: 0.75rem; }

        
        /* Bảng xếp hạng */
        .leaderboard-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        .form-group { display: flex; align-items: center; gap: 0.5rem; }
        .form-control { padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background-color: #f9fafb; }
        .timeframe-tabs { display: flex; background-color: #f3f4f6; border-radius: 0.5rem; padding: 0.25rem; }
        .tab-button { padding: 0.5rem 1rem; border: none; background-color: transparent; border-radius: 0.375rem; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: var(--card-background); color: var(--primary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
        .leaderboard-item:last-child { border-bottom: none; }
        .rank { font-size: 1.125rem; font-weight: 700; color: var(--text-secondary); width: 3rem; text-align: center; }
        .rank .fa-medal { font-size: 1.5rem; }
        .gold-medal { color: #facc15; }
        .silver-medal { color: #d1d5db; }
        .bronze-medal { color: #cd7f32; }
        .username { font-weight: 600; color: var(--text-primary); }
        .score-value { margin-left: auto; font-weight: 700; color: var(--primary-color); }
        .empty-message { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .loader-container { display: flex; justify-content: center; padding: 2rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Bổ sung cột thứ 3 cho Khoá học */
        .stats-main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { .stats-main-grid { grid-template-columns: repeat(3, 1fr); } }
        
        .stat-cards-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .stat-card { display: flex; align-items: center; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); }
        .stat-card-icon { width: 3rem; height: 3rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; font-size: 1.5rem; flex-shrink: 0; }
        .stat-card-icon.score { background-color: #fef3c7; color: #f59e0b; }
        .stat-card-icon.learned { background-color: #dcfce7; color: #22c55e; }
        .stat-card-icon.sets { background-color: #dbeafe; color: #3b82f6; }
        .stat-card-value { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .stat-card-label { font-size: 0.875rem; color: var(--text-secondary); }

        .stat-detail-section { margin-top: 1.75rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
        .stat-detail-header { display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .stat-detail-header label { font-weight: 600; color: var(--text-primary); }
        .stat-detail-select { min-width: 220px; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background-color: #f9fafb; }
        .stat-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .stat-detail-card { background-color: #f9fafb; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; }
        .stat-detail-label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.35rem; }
        .stat-detail-value { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .stat-detail-note { margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary); }
        .stat-detail-list-container { margin-top: 1.25rem; }
        .stat-detail-subtitle { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem; }
        .stat-detail-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 0.75rem; }
        .stat-detail-list-item { padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; background-color: #f9fafb; }
        .stat-detail-list-item strong { display: block; color: var(--text-primary); margin-bottom: 0.35rem; }
        .stat-detail-list-item span { display: block; color: var(--text-secondary); font-size: 0.875rem; }
        .stat-detail-meta { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.35rem; }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1 class="dashboard-header"><i class="fas fa-chart-pie"></i> Thống kê</h1>

    <div class="stats-section leaderboard-section">
        <h2 class="section-title"><i class="fas fa-trophy"></i> Bảng xếp hạng Người dùng</h2>
        
        <div class="leaderboard-controls">
            <div class="form-group sort-by-group">
                <label for="sort_by">Sắp xếp theo:</label>
                <select id="sort_by" name="sort_by" class="form-control">
                    <option value="total_score" {% if current_sort_by == 'total_score' %}selected{% endif %}>Tổng điểm (trong kỳ)</option>
                    <option value="total_reviews" disabled>Số lượt ôn tập (Flashcard)</option>
                </select>
            </div>
            <div class="form-group timeframe-group">
                <div class="timeframe-tabs">
                    <button type="button" class="tab-button {% if current_timeframe == 'day' %}active{% endif %}" data-timeframe="day">Hôm nay</button>
                    <button type="button" class="tab-button {% if current_timeframe == 'week' %}active{% endif %}" data-timeframe="week">Tuần này</button>
                    <button type="button" class="tab-button {% if current_timeframe == 'month' %}active{% endif %}" data-timeframe="month">Tháng này</button>
                    <button type="button" class="tab-button {% if current_timeframe == 'all_time' %}active{% endif %}" data-timeframe="all_time">Toàn bộ</button>
                </div>
            </div>
        </div>

        <div id="leaderboard-content">
            <ul class="leaderboard-list" id="leaderboard-list-container">
                {% include '_leaderboard_list.html' %}
            </ul>
            <p class="empty-message" id="leaderboard-empty-message" style="display: {% if not leaderboard_data %}block{% else %}none{% endif %};">Không có dữ liệu bảng xếp hạng để hiển thị.</p>
            <div class="loader-container" id="leaderboard-loader" style="display: none;">
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <div class="stats-main-grid">
        <div class="stats-column flashcard-stats-column">
            <div class="stats-section">
                <h2 class="section-title">Tổng quan Flashcard</h2>
                <div class="stat-cards-grid">
                    <div class="stat-card">
                        <div class="stat-card-icon score"><i class="fas fa-star"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.flashcard_score }}</span>
                            <span class="stat-card-label">Tổng điểm Flashcard</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon learned"><i class="fas fa-check-circle"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.learned_distinct_overall }}</span>
                            <span class="stat-card-label">Thẻ đã học</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon sets"><i class="fas fa-layer-group"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.learned_sets_count }}</span>
                            <span class="stat-card-label">Bộ đã học</span>
                        </div>
                    </div>
                </div>
                <div class="stat-detail-section">
                    <div class="stat-detail-header">
                        <label for="flashcard-set-select">Chi tiết theo bộ</label>
                        <select id="flashcard-set-select" class="stat-detail-select" data-has-options="{{ 'true' if flashcard_sets else 'false' }}" {% if not flashcard_sets %}disabled{% endif %}>
                            {% if flashcard_sets %}
                                {% for flashcard_set in flashcard_sets %}
                                    <option value="{{ flashcard_set.id }}" {% if loop.first %}selected{% endif %}>{{ flashcard_set.title }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">Chưa có bộ Flashcard nào</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="loader-container" id="flashcard-detail-loader" style="display: none;">
                        <div class="loader"></div>
                    </div>
                    <p class="empty-message" id="flashcard-detail-empty" style="display: {{ 'none' if flashcard_sets else 'block' }};">Bạn chưa có bộ Flashcard nào đang học.</p>
                    <div class="stat-detail-grid" id="flashcard-detail-metrics" style="display: none;">
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Tổng số thẻ</span>
                            <span class="stat-detail-value" data-flashcard-metric="total_cards">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Đã ôn tập</span>
                            <span class="stat-detail-value" data-flashcard-metric="studied_cards">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Thẻ thành thạo</span>
                            <span class="stat-detail-value" data-flashcard-metric="learned_cards">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Độ chính xác</span>
                            <span class="stat-detail-value" data-flashcard-metric="accuracy">--</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Chuỗi đúng TB</span>
                            <span class="stat-detail-value" data-flashcard-metric="avg_streak">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Chuỗi đúng tốt nhất</span>
                            <span class="stat-detail-value" data-flashcard-metric="best_streak">0</span>
                        </div>
                    </div>
                    <div class="stat-detail-list-container" id="flashcard-learned-container" style="display: none;">
                        <h4 class="stat-detail-subtitle">Thẻ thành thạo gần đây</h4>
                        <ul class="stat-detail-list" id="flashcard-learned-list"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-column quiz-stats-column">
            <div class="stats-section">
                <h2 class="section-title">Tổng quan Trắc nghiệm</h2>
                <div class="stat-cards-grid">
                    <div class="stat-card">
                        <div class="stat-card-icon score" style="background-color: #fce7f3; color: #db2777;"><i class="fas fa-trophy"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.quiz_score }}</span>
                            <span class="stat-card-label">Tổng điểm Trắc nghiệm</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon learned" style="background-color: #e0e7ff; color: #4f46e5;"><i class="fas fa-question-circle"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.questions_answered_count }}</span>
                            <span class="stat-card-label">Câu đã trả lời</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon sets" style="background-color: #fee2e2; color: #ef4444;"><i class="fas fa-tasks"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.quiz_sets_started_count }}</span>
                            <span class="stat-card-label">Bộ đã làm</span>
                        </div>
                    </div>
                </div>
                <div class="stat-detail-section">
                    <div class="stat-detail-header">
                        <label for="quiz-set-select">Chi tiết theo bộ</label>
                        <select id="quiz-set-select" class="stat-detail-select" data-has-options="{{ 'true' if quiz_sets else 'false' }}" {% if not quiz_sets %}disabled{% endif %}>
                            {% if quiz_sets %}
                                {% for quiz_set in quiz_sets %}
                                    <option value="{{ quiz_set.id }}" {% if loop.first %}selected{% endif %}>{{ quiz_set.title }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">Chưa có bộ Trắc nghiệm nào</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="loader-container" id="quiz-detail-loader" style="display: none;">
                        <div class="loader"></div>
                    </div>
                    <p class="empty-message" id="quiz-detail-empty" style="display: {{ 'none' if quiz_sets else 'block' }};">Bạn chưa có bộ Trắc nghiệm nào đang làm.</p>
                    <div class="stat-detail-grid" id="quiz-detail-metrics" style="display: none;">
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Tổng số câu hỏi</span>
                            <span class="stat-detail-value" data-quiz-metric="total_questions">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Đã trả lời</span>
                            <span class="stat-detail-value" data-quiz-metric="attempted_questions">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Trả lời đúng</span>
                            <span class="stat-detail-value" data-quiz-metric="total_correct">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Độ chính xác</span>
                            <span class="stat-detail-value" data-quiz-metric="accuracy">--</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Chuỗi đúng TB</span>
                            <span class="stat-detail-value" data-quiz-metric="avg_streak">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Chuỗi đúng tốt nhất</span>
                            <span class="stat-detail-value" data-quiz-metric="best_streak">0</span>
                        </div>
                    </div>
                    <div class="stat-detail-list-container" id="quiz-correct-container" style="display: none;">
                        <h4 class="stat-detail-subtitle">Câu trả lời đúng gần đây</h4>
                        <ul class="stat-detail-list" id="quiz-correct-list"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-column course-stats-column">
            <div class="stats-section">
                <h2 class="section-title">Tổng quan Khoá học</h2>
                <div class="stat-cards-grid">
                    <div class="stat-card">
                        <div class="stat-card-icon learned" style="background-color: #d1fae5; color: #059669;"><i class="fas fa-book-reader"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.lessons_completed_count }}</span>
                            <span class="stat-card-label">Bài học hoàn thành</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon sets" style="background-color: #eef2ff; color: #4338ca;"><i class="fas fa-graduation-cap"></i></div>
                        <div>
                            <span class="stat-card-value">{{ dashboard_data.courses_started_count }}</span>
                            <span class="stat-card-label">Khoá học đã bắt đầu</span>
                        </div>
                    </div>
                </div>
                <div class="stat-detail-section">
                    <div class="stat-detail-header">
                        <label for="course-set-select">Chi tiết theo khoá học</label>
                        <select id="course-set-select" class="stat-detail-select" data-has-options="{{ 'true' if course_sets else 'false' }}" {% if not course_sets %}disabled{% endif %}>
                            {% if course_sets %}
                                {% for course_set in course_sets %}
                                    <option value="{{ course_set.id }}" {% if loop.first %}selected{% endif %}>{{ course_set.title }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">Chưa có khoá học nào</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="loader-container" id="course-detail-loader" style="display: none;">
                        <div class="loader"></div>
                    </div>
                    <p class="empty-message" id="course-detail-empty" style="display: {{ 'none' if course_sets else 'block' }};">Bạn chưa bắt đầu khoá học nào.</p>
                    <div class="stat-detail-grid" id="course-detail-metrics" style="display: none;">
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Tổng số bài học</span>
                            <span class="stat-detail-value" data-course-metric="total_lessons">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Đã mở</span>
                            <span class="stat-detail-value" data-course-metric="lessons_started">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Hoàn thành</span>
                            <span class="stat-detail-value" data-course-metric="lessons_completed">0</span>
                        </div>
                        <div class="stat-detail-card">
                            <span class="stat-detail-label">Hoàn thành trung bình</span>
                            <span class="stat-detail-value" data-course-metric="avg_completion">--</span>
                        </div>
                    </div>
                    <p class="stat-detail-note" id="course-detail-note" style="display: none;">Hoạt động gần nhất: <span data-course-metric="last_activity">--</span></p>
                    <div class="stat-detail-list-container" id="course-recent-container" style="display: none;">
                        <h4 class="stat-detail-subtitle">Bài học gần đây</h4>
                        <ul class="stat-detail-list" id="course-recent-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="leaderboard-item-template">
    <li class="leaderboard-item">
        <span class="rank"></span>
        <span class="username"></span>
        <span class="score-value"></span>
    </li>
</template>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Logic cho Leaderboard động
            const timeframeTabs = document.querySelector('.timeframe-tabs');
            const sortBySelect = document.getElementById('sort_by');
            const listContainer = document.getElementById('leaderboard-list-container');
            const loader = document.getElementById('leaderboard-loader');
            const emptyMessage = document.getElementById('leaderboard-empty-message');

            function fetchAndUpdateLeaderboard() {
                if (!timeframeTabs) return;
                const activeTab = timeframeTabs.querySelector('.tab-button.active');
                const timeframe = activeTab ? activeTab.dataset.timeframe : 'all_time';
                const sortBy = sortBySelect ? sortBySelect.value : 'total_score';

                if (loader) loader.style.display = 'flex';
                if (listContainer) listContainer.style.display = 'none';
                if (emptyMessage) emptyMessage.style.display = 'none';

                const apiUrl = `{{ url_for('stats.get_leaderboard_data_api') }}?sort_by=${sortBy}&timeframe=${timeframe}`;

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            renderLeaderboard(result.data);
                        }
                    })
                    .catch(error => console.error('Lỗi fetch leaderboard:', error))
                    .finally(() => {
                        if (loader) loader.style.display = 'none';
                    });
            }

            function renderLeaderboard(data) {
                if (!listContainer) return;
                listContainer.innerHTML = '';
                if (data && data.length > 0) {
                    if (emptyMessage) emptyMessage.style.display = 'none';
                    listContainer.style.display = 'block';

                    const template = document.getElementById('leaderboard-item-template');
                    data.forEach((entry, index) => {
                        const clone = template.content.cloneNode(true);
                        const rankSpan = clone.querySelector('.rank');

                        if (index === 0) rankSpan.innerHTML = '<i class="fas fa-medal gold-medal"></i>';
                        else if (index === 1) rankSpan.innerHTML = '<i class="fas fa-medal silver-medal"></i>';
                        else if (index === 2) rankSpan.innerHTML = '<i class="fas fa-medal bronze-medal"></i>';
                        else rankSpan.textContent = index + 1;

                        const usernameText = entry.display_username || entry.username || 'N/A';
                        const usernameElement = clone.querySelector('.username');
                        usernameElement.textContent = usernameText;
                        clone.querySelector('.score-value').textContent = `${entry.current_period_score} điểm`;

                        listContainer.appendChild(clone);
                    });
                } else {
                    listContainer.style.display = 'none';
                    if (emptyMessage) emptyMessage.style.display = 'block';
                }
            }

            if (timeframeTabs) {
                timeframeTabs.addEventListener('click', function(event) {
                    if (event.target.tagName === 'BUTTON') {
                        const previouslyActive = timeframeTabs.querySelector('.tab-button.active');
                        if (previouslyActive !== event.target) {
                            if (previouslyActive) previouslyActive.classList.remove('active');
                            event.target.classList.add('active');
                            fetchAndUpdateLeaderboard();
                        }
                    }
                });
            }

            if (sortBySelect) {
                sortBySelect.addEventListener('change', fetchAndUpdateLeaderboard);
            }

            const flashcardEndpoint = "{{ url_for('stats.get_flashcard_set_metrics_api') }}";
            const quizEndpoint = "{{ url_for('stats.get_quiz_set_metrics_api') }}";
            const courseEndpoint = "{{ url_for('stats.get_course_metrics_api') }}";

            const numberFormatter = new Intl.NumberFormat('vi-VN');

            function formatNumber(value) {
                if (value === null || value === undefined) return '0';
                const numeric = Number(value);
                if (Number.isNaN(numeric)) return '0';
                return numberFormatter.format(numeric);
            }

            function formatPercent(value) {
                if (value === null || value === undefined) return '--';
                const numeric = Number(value);
                if (Number.isNaN(numeric)) return '--';
                return `${numeric.toFixed(1)}%`;
            }

            function formatDateTime(value) {
                if (!value) return '--';
                const dateValue = new Date(value);
                if (Number.isNaN(dateValue.getTime())) return '--';
                return dateValue.toLocaleString('vi-VN');
            }

            function setupFlashcardMetrics() {
                const select = document.getElementById('flashcard-set-select');
                if (!select) return;
                const hasOptions = select.dataset.hasOptions === 'true';
                const loaderEl = document.getElementById('flashcard-detail-loader');
                const emptyEl = document.getElementById('flashcard-detail-empty');
                const metricsGrid = document.getElementById('flashcard-detail-metrics');
                const listWrapper = document.getElementById('flashcard-learned-container');
                const listEl = document.getElementById('flashcard-learned-list');
                const fields = {
                    total_cards: metricsGrid ? metricsGrid.querySelector('[data-flashcard-metric="total_cards"]') : null,
                    studied_cards: metricsGrid ? metricsGrid.querySelector('[data-flashcard-metric="studied_cards"]') : null,
                    learned_cards: metricsGrid ? metricsGrid.querySelector('[data-flashcard-metric="learned_cards"]') : null,
                    accuracy: metricsGrid ? metricsGrid.querySelector('[data-flashcard-metric="accuracy"]') : null,
                    avg_streak: metricsGrid ? metricsGrid.querySelector('[data-flashcard-metric="avg_streak"]') : null,
                    best_streak: metricsGrid ? metricsGrid.querySelector('[data-flashcard-metric="best_streak"]') : null,
                };

                function showEmpty(message) {
                    if (emptyEl) {
                        emptyEl.textContent = message;
                        emptyEl.style.display = 'block';
                    }
                    if (metricsGrid) metricsGrid.style.display = 'none';
                    if (listWrapper) listWrapper.style.display = 'none';
                }

                function render(data) {
                    if (!data) {
                        showEmpty('Không tìm thấy dữ liệu cho bộ đã chọn.');
                        return;
                    }

                    if (fields.total_cards) fields.total_cards.textContent = formatNumber(data.total_cards);
                    if (fields.studied_cards) fields.studied_cards.textContent = formatNumber(data.studied_cards);
                    if (fields.learned_cards) fields.learned_cards.textContent = formatNumber(data.learned_cards);
                    if (fields.accuracy) fields.accuracy.textContent = data.accuracy_percent !== null ? formatPercent(data.accuracy_percent) : '--';
                    if (fields.avg_streak) {
                        const avg = data.avg_correct_streak !== null && data.avg_correct_streak !== undefined ? Number(data.avg_correct_streak) : 0;
                        fields.avg_streak.textContent = avg.toFixed(1);
                    }
                    if (fields.best_streak) fields.best_streak.textContent = formatNumber(data.best_correct_streak);

                    if (metricsGrid) metricsGrid.style.display = 'grid';

                    if (listWrapper && listEl) {
                        listEl.innerHTML = '';
                        const examples = Array.isArray(data.learned_examples) ? data.learned_examples : [];
                        if (examples.length > 0) {
                            examples.forEach(example => {
                                const li = document.createElement('li');
                                li.className = 'stat-detail-list-item';
                                const titleText = example.front || `Thẻ #${example.item_id}`;
                                const backText = example.back ? `<span>${example.back}</span>` : '';
                                const timestamp = example.last_reviewed || example.first_seen;
                                const metaText = timestamp ? `<span class="stat-detail-meta">Ôn gần nhất: ${formatDateTime(timestamp)}</span>` : '';
                                li.innerHTML = `<strong>${titleText}</strong>${backText}${metaText}`;
                                listEl.appendChild(li);
                            });
                            listWrapper.style.display = 'block';
                        } else {
                            listWrapper.style.display = 'none';
                        }
                    }

                    if (emptyEl) emptyEl.style.display = 'none';
                }

                function load(containerId) {
                    if (!containerId) {
                        showEmpty('Hãy chọn một bộ Flashcard để xem chi tiết.');
                        return;
                    }

                    if (loaderEl) loaderEl.style.display = 'flex';
                    if (metricsGrid) metricsGrid.style.display = 'none';
                    if (listWrapper) listWrapper.style.display = 'none';
                    if (emptyEl) emptyEl.style.display = 'none';

                    fetch(`${flashcardEndpoint}?container_id=${containerId}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                const payload = result.data ? (result.data[String(containerId)] || result.data[Object.keys(result.data)[0]]) : null;
                                render(payload);
                            } else {
                                showEmpty('Không thể tải dữ liệu chi tiết.');
                            }
                        })
                        .catch(() => showEmpty('Không thể tải dữ liệu chi tiết.'))
                        .finally(() => {
                            if (loaderEl) loaderEl.style.display = 'none';
                        });
                }

                if (!hasOptions) {
                    showEmpty('Bạn chưa có bộ Flashcard nào đang học.');
                    return;
                }

                select.addEventListener('change', event => load(event.target.value));

                const initialId = select.value;
                if (initialId) {
                    load(initialId);
                } else {
                    showEmpty('Hãy chọn một bộ Flashcard để xem chi tiết.');
                }
            }

            function setupQuizMetrics() {
                const select = document.getElementById('quiz-set-select');
                if (!select) return;
                const hasOptions = select.dataset.hasOptions === 'true';
                const loaderEl = document.getElementById('quiz-detail-loader');
                const emptyEl = document.getElementById('quiz-detail-empty');
                const metricsGrid = document.getElementById('quiz-detail-metrics');
                const listWrapper = document.getElementById('quiz-correct-container');
                const listEl = document.getElementById('quiz-correct-list');
                const fields = {
                    total_questions: metricsGrid ? metricsGrid.querySelector('[data-quiz-metric="total_questions"]') : null,
                    attempted_questions: metricsGrid ? metricsGrid.querySelector('[data-quiz-metric="attempted_questions"]') : null,
                    total_correct: metricsGrid ? metricsGrid.querySelector('[data-quiz-metric="total_correct"]') : null,
                    accuracy: metricsGrid ? metricsGrid.querySelector('[data-quiz-metric="accuracy"]') : null,
                    avg_streak: metricsGrid ? metricsGrid.querySelector('[data-quiz-metric="avg_streak"]') : null,
                    best_streak: metricsGrid ? metricsGrid.querySelector('[data-quiz-metric="best_streak"]') : null,
                };

                function showEmpty(message) {
                    if (emptyEl) {
                        emptyEl.textContent = message;
                        emptyEl.style.display = 'block';
                    }
                    if (metricsGrid) metricsGrid.style.display = 'none';
                    if (listWrapper) listWrapper.style.display = 'none';
                }

                function render(data) {
                    if (!data) {
                        showEmpty('Không tìm thấy dữ liệu cho bộ đã chọn.');
                        return;
                    }

                    if (fields.total_questions) fields.total_questions.textContent = formatNumber(data.total_questions);
                    if (fields.attempted_questions) fields.attempted_questions.textContent = formatNumber(data.attempted_questions);
                    if (fields.total_correct) fields.total_correct.textContent = formatNumber(data.total_correct);
                    if (fields.accuracy) fields.accuracy.textContent = data.accuracy_percent !== null ? formatPercent(data.accuracy_percent) : '--';
                    if (fields.avg_streak) {
                        const avg = data.avg_correct_streak !== null && data.avg_correct_streak !== undefined ? Number(data.avg_correct_streak) : 0;
                        fields.avg_streak.textContent = avg.toFixed(1);
                    }
                    if (fields.best_streak) fields.best_streak.textContent = formatNumber(data.best_correct_streak);

                    if (metricsGrid) metricsGrid.style.display = 'grid';

                    if (listWrapper && listEl) {
                        listEl.innerHTML = '';
                        const examples = Array.isArray(data.correct_examples) ? data.correct_examples : [];
                        if (examples.length > 0) {
                            examples.forEach(example => {
                                const li = document.createElement('li');
                                li.className = 'stat-detail-list-item';
                                const titleText = example.question || `Câu hỏi #${example.item_id}`;
                                const statsText = `<span>Đúng ${formatNumber(example.times_correct)} - Sai ${formatNumber(example.times_incorrect)}</span>`;
                                const metaText = example.last_reviewed ? `<span class="stat-detail-meta">Lần gần nhất: ${formatDateTime(example.last_reviewed)}</span>` : '';
                                li.innerHTML = `<strong>${titleText}</strong>${statsText}${metaText}`;
                                listEl.appendChild(li);
                            });
                            listWrapper.style.display = 'block';
                        } else {
                            listWrapper.style.display = 'none';
                        }
                    }

                    if (emptyEl) emptyEl.style.display = 'none';
                }

                function load(containerId) {
                    if (!containerId) {
                        showEmpty('Hãy chọn một bộ Trắc nghiệm để xem chi tiết.');
                        return;
                    }

                    if (loaderEl) loaderEl.style.display = 'flex';
                    if (metricsGrid) metricsGrid.style.display = 'none';
                    if (listWrapper) listWrapper.style.display = 'none';
                    if (emptyEl) emptyEl.style.display = 'none';

                    fetch(`${quizEndpoint}?container_id=${containerId}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                const payload = result.data ? (result.data[String(containerId)] || result.data[Object.keys(result.data)[0]]) : null;
                                render(payload);
                            } else {
                                showEmpty('Không thể tải dữ liệu chi tiết.');
                            }
                        })
                        .catch(() => showEmpty('Không thể tải dữ liệu chi tiết.'))
                        .finally(() => {
                            if (loaderEl) loaderEl.style.display = 'none';
                        });
                }

                if (!hasOptions) {
                    showEmpty('Bạn chưa có bộ Trắc nghiệm nào đang làm.');
                    return;
                }

                select.addEventListener('change', event => load(event.target.value));

                const initialId = select.value;
                if (initialId) {
                    load(initialId);
                } else {
                    showEmpty('Hãy chọn một bộ Trắc nghiệm để xem chi tiết.');
                }
            }

            function setupCourseMetrics() {
                const select = document.getElementById('course-set-select');
                if (!select) return;
                const hasOptions = select.dataset.hasOptions === 'true';
                const loaderEl = document.getElementById('course-detail-loader');
                const emptyEl = document.getElementById('course-detail-empty');
                const metricsGrid = document.getElementById('course-detail-metrics');
                const noteEl = document.getElementById('course-detail-note');
                const lastActivityField = noteEl ? noteEl.querySelector('[data-course-metric="last_activity"]') : null;
                const listWrapper = document.getElementById('course-recent-container');
                const listEl = document.getElementById('course-recent-list');
                const fields = {
                    total_lessons: metricsGrid ? metricsGrid.querySelector('[data-course-metric="total_lessons"]') : null,
                    lessons_started: metricsGrid ? metricsGrid.querySelector('[data-course-metric="lessons_started"]') : null,
                    lessons_completed: metricsGrid ? metricsGrid.querySelector('[data-course-metric="lessons_completed"]') : null,
                    avg_completion: metricsGrid ? metricsGrid.querySelector('[data-course-metric="avg_completion"]') : null,
                };

                function showEmpty(message) {
                    if (emptyEl) {
                        emptyEl.textContent = message;
                        emptyEl.style.display = 'block';
                    }
                    if (metricsGrid) metricsGrid.style.display = 'none';
                    if (noteEl) noteEl.style.display = 'none';
                    if (listWrapper) listWrapper.style.display = 'none';
                }

                function render(data) {
                    if (!data) {
                        showEmpty('Không tìm thấy dữ liệu cho khoá học đã chọn.');
                        return;
                    }

                    if (fields.total_lessons) fields.total_lessons.textContent = formatNumber(data.total_lessons);
                    if (fields.lessons_started) fields.lessons_started.textContent = formatNumber(data.lessons_started);
                    if (fields.lessons_completed) fields.lessons_completed.textContent = formatNumber(data.lessons_completed);
                    if (fields.avg_completion) fields.avg_completion.textContent = formatPercent(data.avg_completion_percent);

                    if (metricsGrid) metricsGrid.style.display = 'grid';

                    if (noteEl && lastActivityField) {
                        if (data.last_activity) {
                            lastActivityField.textContent = formatDateTime(data.last_activity);
                            noteEl.style.display = 'block';
                        } else {
                            noteEl.style.display = 'none';
                        }
                    }

                    if (listWrapper && listEl) {
                        listEl.innerHTML = '';
                        const lessons = Array.isArray(data.recent_lessons) ? data.recent_lessons : [];
                        if (lessons.length > 0) {
                            lessons.forEach(lesson => {
                                const li = document.createElement('li');
                                li.className = 'stat-detail-list-item';
                                const titleText = lesson.title || `Bài học #${lesson.item_id}`;
                                const progressText = `<span>Hoàn thành: ${formatNumber(lesson.completion_percentage)}%</span>`;
                                const metaText = lesson.last_updated ? `<span class="stat-detail-meta">Cập nhật: ${formatDateTime(lesson.last_updated)}</span>` : '';
                                li.innerHTML = `<strong>${titleText}</strong>${progressText}${metaText}`;
                                listEl.appendChild(li);
                            });
                            listWrapper.style.display = 'block';
                        } else {
                            listWrapper.style.display = 'none';
                        }
                    }

                    if (emptyEl) emptyEl.style.display = 'none';
                }

                function load(containerId) {
                    if (!containerId) {
                        showEmpty('Hãy chọn một khoá học để xem chi tiết.');
                        return;
                    }

                    if (loaderEl) loaderEl.style.display = 'flex';
                    if (metricsGrid) metricsGrid.style.display = 'none';
                    if (listWrapper) listWrapper.style.display = 'none';
                    if (noteEl) noteEl.style.display = 'none';
                    if (emptyEl) emptyEl.style.display = 'none';

                    fetch(`${courseEndpoint}?container_id=${containerId}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                const payload = result.data ? (result.data[String(containerId)] || result.data[Object.keys(result.data)[0]]) : null;
                                render(payload);
                            } else {
                                showEmpty('Không thể tải dữ liệu chi tiết.');
                            }
                        })
                        .catch(() => showEmpty('Không thể tải dữ liệu chi tiết.'))
                        .finally(() => {
                            if (loaderEl) loaderEl.style.display = 'none';
                        });
                }

                if (!hasOptions) {
                    showEmpty('Bạn chưa bắt đầu khoá học nào.');
                    return;
                }

                select.addEventListener('change', event => load(event.target.value));

                const initialId = select.value;
                if (initialId) {
                    load(initialId);
                } else {
                    showEmpty('Hãy chọn một khoá học để xem chi tiết.');
                }
            }

            setupFlashcardMetrics();
            setupQuizMetrics();
            setupCourseMetrics();
        });
    </script>
{% endblock %}