{% extends "admin_layout.html" %}
{% set active_page = 'settings' %}

{% block title %}Cài đặt hệ thống{% endblock %}
{% block page_title %}Cài đặt & trạng thái hệ thống{% endblock %}
{% block page_subtitle %}Bật chế độ bảo trì và điều chỉnh các tham số vận hành quan trọng cho Mindstack.{% endblock %}

{% block content %}
<div class="data-card max-w-3xl">
    <div class="data-card-header px-6 py-5">
        <h2 class="text-xl font-semibold text-slate-900">Trạng thái hoạt động</h2>
        <p class="text-sm text-slate-500 mt-1">Giữ cho người dùng luôn nhận được thông báo chính xác về tình hình hệ
            thống.</p>
    </div>
    <div class="px-6 py-6">
        <form action="{{ url_for('admin.manage_system_settings') }}" method="post" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900">Chế độ bảo trì</h3>
                    <p class="text-sm text-slate-500 mt-1">Khi bật, người dùng thông thường sẽ không thể truy cập ứng
                        dụng.</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="maintenance_mode" class="sr-only peer" {% if maintenance_mode
                        %}checked{% endif %}>
                    <div
                        class="w-14 h-7 bg-slate-300 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-200 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600">
                    </div>
                </label>
            </div>
            <p class="text-xs text-slate-500">Chỉ quản trị viên mới có thể đăng nhập khi chế độ bảo trì đang hoạt động.
            </p>

            <div class="pt-4 flex justify-end">
                <button type="submit"
                    class="inline-flex items-center gap-2 bg-slate-900 text-white px-5 py-2.5 rounded-md shadow hover:bg-slate-800 transition">
                    <i class="fas fa-save"></i> Lưu cài đặt
                </button>
            </div>
        </form>
    </div>
</div>

<div class="data-card mt-8">
    <div class="data-card-header px-6 py-5">
        <h2 class="text-xl font-semibold text-slate-900">Cấu hình vận hành nhanh</h2>
        <p class="text-sm text-slate-500 mt-1">Điều chỉnh các tham số quan trọng như phân trang và thư mục lưu trữ.</p>
    </div>
    <div class="px-6 py-6">
        <form action="{{ url_for('admin.update_core_settings') }}" method="post" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for field in core_settings %}
                <div class="border border-slate-200 rounded-lg p-4 bg-slate-50/60">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">{{ field.label }}</p>
                            <p class="text-xs text-slate-500 mt-1">{{ field.description }}</p>
                        </div>
                        <span class="text-[11px] font-semibold px-2 py-0.5 rounded bg-slate-200 text-slate-700">{{
                            field.data_type|upper }}</span>
                    </div>
                    <div class="mt-3">
                        <label class="block text-xs text-slate-500">Giá trị hiện tại</label>
                        {% if field.key == 'AI_PROVIDER' %}
                        <select name="{{ field.key }}" id="ai_provider_select"
                            class="mt-1 w-full rounded-md border-slate-200" required
                            onchange="toggleProviderSettings()">
                            <option value="gemini" {% if field.value=='gemini' %}selected{% endif %}>Google Gemini
                            </option>
                            <option value="huggingface" {% if field.value=='huggingface' %}selected{% endif %}>Hugging
                                Face</option>
                        </select>
                        {% elif field.key == 'GEMINI_MODEL' %}
                        <div id="gemini_model_container">
                            <!-- Hidden input storing the actual comma-separated value -->
                            <input type="hidden" name="{{ field.key }}" id="gemini_model_value"
                                value="{{ field.value }}">

                            <!-- Visual display of selected models -->
                            <div class="mb-2">
                                <div class="text-xs font-semibold text-slate-700 mb-1">Model đã chọn (Ưu tiên từ trái
                                    qua phải):</div>
                                <div id="gemini_selected_badges"
                                    class="flex flex-wrap gap-1 min-h-[2rem] p-2 bg-white border border-slate-200 rounded-md">
                                    <!-- Badges will be injected here by JS -->
                                    {% if field.value %}
                                    {% for m in field.value.split(',') %}
                                    {% if m.strip() %}
                                    <span
                                        class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">
                                        {{ m.strip() }}
                                    </span>
                                    {% endif %}
                                    {% endfor %}
                                    {% else %}
                                    <span class="text-slate-400 text-xs italic">Chưa chọn model nào</span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Load Button -->
                            <button type="button" onclick="fetchGeminiModels()"
                                class="w-full mb-3 px-4 py-2 bg-slate-100 border border-slate-300 rounded text-slate-700 font-medium hover:bg-slate-200 hover:text-slate-900 transition flex items-center justify-center gap-2">
                                <i class="fas fa-cloud-download-alt"></i> Tải danh sách Model từ Google
                            </button>

                            <!-- Checkbox Container -->
                            <div id="gemini_checkbox_list"
                                class="hidden space-y-2 max-h-60 overflow-y-auto p-2 border border-slate-200 rounded bg-slate-50/50">
                                <p class="text-center text-xs text-slate-400 py-2">Nhấn nút phía trên để tải danh
                                    sách...</p>
                            </div>

                            <p class="text-xs text-slate-500 mt-2">
                                <i class="fas fa-info-circle"></i> Chọn nhiều model để kích hoạt <b>Fallback tự
                                    động</b>. Hệ thống sẽ thử model đầu tiên, nếu hết quota sẽ thử model tiếp theo.
                            </p>
                        </div>
                        {% elif field.key == 'HUGGINGFACE_MODEL' %}
                        <div id="hf_model_container" class="hidden">
                            <div class="flex gap-2">
                                <select name="{{ field.key }}" id="hf_model_select"
                                    class="mt-1 w-full rounded-md border-slate-200">
                                    <optgroup label="Default">
                                        <option value="{{ field.value }}" selected>{{ field.value }} (Hiện tại)</option>
                                    </optgroup>
                                    <optgroup label="Recommended">
                                        <option value="google/gemma-7b-it">Gemma 7B IT</option>
                                        <option value="meta-llama/Llama-2-7b-chat-hf">Llama 2 7B Chat</option>
                                    </optgroup>
                                    <option value="custom">Khác (Nhập tay)...</option>
                                </select>
                                <button type="button" onclick="fetchHFModels()"
                                    class="mt-1 px-3 py-2 bg-slate-100 border border-slate-300 rounded text-slate-600 hover:bg-slate-200"
                                    title="Cập nhật từ Hugging Face">
                                    <i class="fas fa-cloud-download-alt"></i>
                                </button>
                            </div>
                            <input name="{{ field.key }}_custom" id="hf_custom_input"
                                class="mt-2 w-full rounded-md border-slate-200 text-sm hidden"
                                placeholder="Nhập tên model Hugging Face...">
                        </div>
                        {% elif field.data_type == 'int' %}
                        <input type="number" name="{{ field.key }}" value="{{ field.value }}"
                            class="mt-1 w-full rounded-md border-slate-200" placeholder="{{ field.placeholder }}"
                            required>
                        {% else %}
                        <input name="{{ field.key }}" value="{{ field.value }}"
                            class="mt-1 w-full rounded-md border-slate-200" placeholder="{{ field.placeholder }}"
                            required>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="flex justify-end pt-2">
                <button type="submit"
                    class="inline-flex items-center gap-2 bg-blue-600 text-white px-5 py-2.5 rounded-md shadow hover:bg-blue-700 transition">
                    <i class="fas fa-save"></i> Lưu cấu hình
                </button>
            </div>
        </form>
    </div>
</div>

<div class="data-card mt-8">
    <div class="data-card-header px-6 py-5">
        <h2 class="text-xl font-semibold text-slate-900">Đặt lại tiến độ học tập</h2>
        <p class="text-sm text-slate-500 mt-1">Xóa toàn bộ tiến độ, ghi chú và log điểm theo người dùng hoặc theo bộ câu
            hỏi. Bạn cần gõ đúng chuỗi xác nhận để thực hiện.</p>
    </div>
    <div class="px-6 py-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="border border-slate-200 rounded-lg p-5 bg-slate-50/60">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <p class="text-lg font-semibold text-slate-900">Đặt lại theo người dùng</p>
                    <p class="text-sm text-slate-500 mt-1">Xóa toàn bộ tiến độ, ghi chú và log điểm của một tài khoản.
                    </p>
                </div>
                <span class="admin-chip bg-rose-100 text-rose-700">Mạnh</span>
            </div>
            <form action="{{ url_for('admin.reset_learning_progress') }}" method="post" class="space-y-4 mt-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="reset_scope" value="user">
                <div>
                    <label class="block text-sm font-medium text-slate-700">Chọn người dùng</label>
                    <select name="user_id" class="mt-1 w-full rounded-md border-slate-200" required>
                        <option value="" disabled selected>-- Chọn tài khoản --</option>
                        {% for user in users %}
                        <option value="{{ user.user_id }}">{{ user.username }} (ID {{ user.user_id }})</option>
                        {% endfor %}
                    </select>
                    {% if not users %}
                    <p class="text-xs text-amber-700 mt-1">Chưa có người dùng để đặt lại.</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Xác nhận</label>
                    <p class="text-xs text-slate-500">Nhập <code>RESET USER &lt;tên người dùng&gt;</code> để đồng ý.</p>
                    <input name="confirmation" class="mt-1 w-full rounded-md border-slate-200"
                        placeholder="RESET USER username" required>
                </div>
                <div class="flex justify-end">
                    <button type="submit"
                        class="inline-flex items-center gap-2 bg-rose-600 text-white px-4 py-2.5 rounded-md shadow hover:bg-rose-700 transition"
                        {% if not users %}disabled{% endif %}>
                        <i class="fas fa-rotate-left"></i> Đặt lại người dùng
                    </button>
                </div>
            </form>
        </div>
        <div class="border border-slate-200 rounded-lg p-5 bg-slate-50/60">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <p class="text-lg font-semibold text-slate-900">Đặt lại theo bộ câu hỏi</p>
                    <p class="text-sm text-slate-500 mt-1">Xóa tiến độ của tất cả người dùng đối với bộ câu hỏi được
                        chọn.</p>
                </div>
                <span class="admin-chip bg-blue-100 text-blue-700">Theo nội dung</span>
            </div>
            <form action="{{ url_for('admin.reset_learning_progress') }}" method="post" class="space-y-4 mt-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="reset_scope" value="container">
                <div>
                    <label class="block text-sm font-medium text-slate-700">Chọn bộ câu hỏi (Quiz set)</label>
                    <select name="container_id" class="mt-1 w-full rounded-md border-slate-200" required>
                        <option value="" disabled selected>-- Chọn bộ câu hỏi --</option>
                        {% for container in quiz_sets %}
                        <option value="{{ container.container_id }}">{{ container.title }} (ID {{ container.container_id
                            }})</option>
                        {% endfor %}
                    </select>
                    {% if not quiz_sets %}
                    <p class="text-xs text-amber-700 mt-1">Chưa có bộ câu hỏi nào để đặt lại.</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Xác nhận</label>
                    <p class="text-xs text-slate-500">Nhập <code>RESET CONTAINER &lt;ID&gt;</code> để đồng ý.</p>
                    <input name="confirmation" class="mt-1 w-full rounded-md border-slate-200"
                        placeholder="RESET CONTAINER 12" required>
                </div>
                <div class="flex justify-end">
                    <button type="submit"
                        class="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2.5 rounded-md shadow hover:bg-blue-700 transition"
                        {% if not quiz_sets %}disabled{% endif %}>
                        <i class="fas fa-rotate"></i> Đặt lại bộ câu hỏi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="data-card mt-8">
    <div class="data-card-header px-6 py-5">
        <h2 class="text-xl font-semibold text-slate-900">Cấu hình Telegram Bot</h2>
        <p class="text-sm text-slate-500 mt-1">Kết nối Mindstack với Telegram Bot của bạn để gửi thông báo và nhắc nhở.
        </p>
    </div>
    <div class="px-6 py-6">
        <form action="{{ url_for('admin.save_telegram_token') }}" method="post" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="key" value="telegram_bot_token"> {# Để dùng cho tạo mới nếu chưa có #}
            <div>
                <label class="block text-sm font-medium text-slate-700">Telegram Bot Token</label>
                <input type="text" name="value"
                    value="{{ telegram_token_setting.value if telegram_token_setting else '' }}"
                    class="mt-1 w-full rounded-md border-slate-200" placeholder="Nhập token từ BotFather" required>
                <p class="text-xs text-slate-500 mt-1">Bạn có thể tạo bot và lấy token từ @BotFather trên Telegram.</p>
            </div>
            <div class="flex justify-end">
                <button type="submit"
                    class="inline-flex items-center gap-2 bg-blue-600 text-white px-5 py-2.5 rounded-md shadow hover:bg-blue-700 transition">
                    <i class="fas fa-save"></i> Lưu Telegram Token
                </button>
            </div>
        </form>
    </div>
</div>

<div class="data-card mt-8">
    <div class="data-card-header px-6 py-5">
        <h2 class="text-xl font-semibold text-slate-900">Cấu hình theo danh mục</h2>
        <p class="text-sm text-slate-500 mt-1">Thêm mới hoặc chỉnh sửa cấu hình được lưu trong cơ sở dữ liệu, nhóm theo
            danh mục để tránh trùng lặp với phần vận hành nhanh.</p>
        <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded text-sm text-amber-800">
            <p class="font-semibold">Lưu ý bảo mật</p>
            <p class="mt-1">Các khóa nhạy cảm như <code>SECRET_KEY</code> và <code>SQLALCHEMY_DATABASE_URI</code> chỉ
                được thiết lập qua biến môi trường và không hiển thị tại đây. Các khóa có sẵn ở mục "Cấu hình vận hành
                nhanh" sẽ không lặp lại bên dưới.</p>
        </div>
    </div>
    <div class="px-6 py-6 space-y-6">
        <form action="{{ url_for('admin.create_system_setting') }}" method="post"
            class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div>
                <label class="block text-sm font-medium text-slate-700">Khóa cấu hình</label>
                <input name="key" class="mt-1 w-full rounded-md border-slate-200" placeholder="FLASHCARD_PREVIEW_BONUS"
                    required>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700">Kiểu dữ liệu</label>
                <select name="data_type" class="mt-1 w-full rounded-md border-slate-200">
                    {% for option in data_type_options %}
                    <option value="{{ option }}">{{ option|upper }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Giá trị</label>
                <input name="value" class="mt-1 w-full rounded-md border-slate-200"
                    placeholder="/absolute/path hoặc số điểm">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Mô tả</label>
                <textarea name="description" class="mt-1 w-full rounded-md border-slate-200" rows="2"
                    placeholder="Giải thích mục đích cấu hình"></textarea>
            </div>
            <div class="md:col-span-2 flex justify-end">
                <button type="submit"
                    class="inline-flex items-center gap-2 bg-blue-600 text-white px-5 py-2.5 rounded-md shadow hover:bg-blue-700 transition">
                    <i class="fas fa-plus"></i> Thêm cấu hình
                </button>
            </div>
        </form>

        {% for category in category_order %}
        {% set entries = settings_by_category.get(category, []) %}
        <div class="border border-slate-200 rounded-lg p-5 bg-slate-50/60">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <p class="text-lg font-semibold text-slate-900">{{ category_labels.get(category, category.title())
                        }}</p>
                    <p class="text-sm text-slate-500 mt-1">
                        {% if category == 'paths' %}
                        Quản lý các đường dẫn, thư mục uploads/backups và file hệ thống.
                        {% elif category == 'flashcard' %}
                        Tùy chỉnh điểm thưởng/phạt cho hành vi học flashcard.
                        {% elif category == 'quiz' %}
                        Quy định điểm cho quiz trắc nghiệm (lần đầu, trả lời đúng,...).
                        {% elif category == 'course' %}
                        Điểm thưởng khi hoàn thành bài học hoặc khóa học.
                        {% else %}
                        Các cấu hình khác không thuộc nhóm trên.
                        {% endif %}
                    </p>
                </div>
                <span class="admin-chip bg-slate-200 text-slate-700">{{ entries|length }} mục</span>
            </div>

            <div class="overflow-x-auto mt-4">
                {% if entries %}
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Khóa</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Kiểu</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Giá trị</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Mô tả</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Hành động</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 bg-white">
                        {% for setting in entries %}
                        <tr>
                            <td class="px-4 py-3 align-top text-sm font-semibold text-slate-900">{{ setting.key }}</td>
                            <td class="px-4 py-3 align-top text-sm text-slate-600">{{ (setting.data_type or
                                'string')|upper }}</td>
                            <td class="px-4 py-3 align-top text-sm text-slate-700">
                                {% if setting.data_type == 'json' %}
                                <pre
                                    class="text-xs bg-slate-50 p-2 rounded border border-slate-200">{{ setting.value | tojson(indent=2) }}</pre>
                                {% else %}
                                {{ setting.value }}
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 align-top text-sm text-slate-600 w-64">{{ setting.description or '—' }}
                            </td>
                            <td class="px-4 py-3 align-top text-sm text-slate-600 space-y-2 w-64">
                                <form
                                    action="{{ url_for('admin.update_system_setting', setting_id=setting.setting_id) }}"
                                    method="post" class="space-y-2">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div>
                                        <label class="block text-xs text-slate-500">Giá trị mới</label>
                                        <input name="value" class="mt-1 w-full rounded-md border-slate-200"
                                            value="{{ setting.value }}">
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs text-slate-500">Kiểu dữ liệu</label>
                                            <select name="data_type" class="mt-1 w-full rounded-md border-slate-200">
                                                {% for option in data_type_options %}
                                                <option value="{{ option }}" {% if option==(setting.data_type
                                                    or 'string' ) %}selected{% endif %}>{{ option|upper }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-slate-500">Mô tả</label>
                                            <input name="description" class="mt-1 w-full rounded-md border-slate-200"
                                                value="{{ setting.description }}">
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button type="submit"
                                            class="inline-flex items-center gap-1 bg-slate-900 text-white px-3 py-1.5 rounded hover:bg-slate-800 transition">
                                            <i class="fas fa-save"></i> Lưu
                                        </button>
                                        <button type="submit"
                                            formaction="{{ url_for('admin.delete_system_setting', setting_id=setting.setting_id) }}"
                                            class="inline-flex items-center gap-1 bg-red-50 text-red-700 px-3 py-1.5 rounded hover:bg-red-100 transition"
                                            onclick="return confirm('Bạn có chắc muốn xóa cấu hình này?');">
                                            <i class="fas fa-trash"></i> Xóa
                                        </button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-sm text-slate-500">Chưa có cấu hình nào trong danh mục này.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endblock %}

    {% block extra_scripts %}
    <script>
        function toggleProviderSettings() {
            const provider = document.getElementById('ai_provider_select').value;
            const geminiContainer = document.getElementById('gemini_model_container');
            const hfContainer = document.getElementById('hf_model_container');

            // Cần tìm thẻ cha chứa field để ẩn hiện cả label (optional, ở đây ta ẩn nội dung field thôi)
            // Trong loop jinja, mỗi field nằm trong một div riêng biệt, nên việc ẩn hiện div con
            // có thể để lại label trống.
            // Tuy nhiên, cách đơn giản nhất là dùng CSS để ẩn hiện container model.

            // Vì cấu trúc HTML đang render phẳng (các field ngang hàng trong loop), 
            // ta sẽ dùng JS tìm div cha (parent của geminiContainer) để ẩn hiện nếu muốn đẹp hơn.
            // Nhưng ở đây ta cứ ẩn hiện container nội dung trước.

            if (provider === 'gemini') {
                if (geminiContainer) {
                    geminiContainer.style.display = 'block';
                    // Tìm parent của container để hiện
                    geminiContainer.closest('.border').style.display = 'block';
                }
                if (hfContainer) {
                    hfContainer.style.display = 'none';
                    // Tìm parent của container để ẩn
                    hfContainer.closest('.border').style.display = 'none';
                }
            } else {
                if (geminiContainer) {
                    geminiContainer.style.display = 'none';
                    geminiContainer.closest('.border').style.display = 'none';
                }
                if (hfContainer) {
                    hfContainer.style.display = 'block';
                    hfContainer.closest('.border').style.display = 'block';
                }
            }
        }

        function setupCustomInput(selectId, inputId) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            if (!select || !input) return;

            // convention: inputId="xxx_custom_input" -> helpId="xxx_custom_help"
            const helpId = inputId.replace('input', 'help');
            const helpText = document.getElementById(helpId);

            select.addEventListener('change', () => {
                if (select.value === 'custom') {
                    input.classList.remove('hidden');
                    input.value = '';
                    input.required = true;
                    if (helpText) helpText.classList.remove('hidden');
                } else {
                    input.classList.add('hidden');
                    input.value = select.value;
                    input.required = false;
                    if (helpText) helpText.classList.add('hidden');
                }
            });
        }

        // --- DRAG & DROP LOGIC ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            this.style.opacity = '0.4';
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                // Swap ID and Content
                const srcId = dragSrcEl.dataset.modelId;
                const destId = this.dataset.modelId;

                // Swap DOM content for visual
                const srcHTML = dragSrcEl.innerHTML;
                dragSrcEl.innerHTML = this.innerHTML;
                this.innerHTML = srcHTML;

                // Swap dataset
                dragSrcEl.dataset.modelId = destId;
                this.dataset.modelId = srcId;

                // Re-sync hidden input
                syncHiddenInputFromBadges();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            document.querySelectorAll('#gemini_selected_badges .badge-item').forEach(item => {
                item.classList.remove('over');
            });
        }

        function syncHiddenInputFromBadges() {
            const badgeContainer = document.getElementById('gemini_selected_badges');
            const badges = badgeContainer.querySelectorAll('.badge-item');
            const newOrder = Array.from(badges).map(b => b.dataset.modelId);

            const hiddenInput = document.getElementById('gemini_model_value');
            hiddenInput.value = newOrder.join(',');

            // Also update the checkboxes if the list is open? No, checkboxes just show presence.
            // Actually, checkboxes showing "checked" is enough, order is determined by hidden input.
            // But if we toggle a checkbox, we need to respect the *current* visual order + new item.
        }

        // --- Helper to update badges with DnD ---
        function updateGeminiBadges(selectedModels) {
            const badgeContainer = document.getElementById('gemini_selected_badges');
            if (!badgeContainer) return;

            // If empty
            if (selectedModels.length === 0) {
                badgeContainer.innerHTML = '<span class="text-slate-400 text-xs italic">Chưa chọn model nào</span>';
                return;
            }

            // We want to preserve existing order if possible when updating from Checkbox
            // But for "updateGeminiBadges" called from Checkbox change, 
            // usually we just append/remove.
            // The simple strategy: Re-render all based on input array order.

            // IMPORTANT: The input `selectedModels` usually comes from checkboxes.
            // Checkboxes have no order. We must rely on the HIDDEN INPUT for order.
            // Step 1: Get current ordered list
            const hiddenInput = document.getElementById('gemini_model_value');
            let currentOrder = hiddenInput.value.split(',').map(s => s.trim()).filter(s => s);

            // Step 2: Merge with new selection
            // Keep items in currentOrder IF they are still in selectedModels
            // Add new items from selectedModels that are NOT in currentOrder

            const newSet = new Set(selectedModels);
            let finalOrder = currentOrder.filter(m => newSet.has(m));

            selectedModels.forEach(m => {
                if (!finalOrder.includes(m)) {
                    finalOrder.push(m);
                }
            });

            // Update hidden input immediately to reflect this merge
            hiddenInput.value = finalOrder.join(',');

            // Clear and Render
            badgeContainer.innerHTML = '';
            finalOrder.forEach(m => {
                const badge = document.createElement('div');
                badge.className = 'badge-item inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200 cursor-move select-none hover:bg-blue-200 transition-colors gap-1';
                badge.setAttribute('draggable', 'true');
                badge.dataset.modelId = m;
                badge.innerHTML = `<span>${m}</span> <i class="fas fa-grip-lines text-blue-400 text-[10px]"></i>`;

                // Add DnD listeners
                badge.addEventListener('dragstart', handleDragStart);
                badge.addEventListener('dragover', handleDragOver);
                badge.addEventListener('drop', handleDrop);
                badge.addEventListener('dragend', handleDragEnd);

                badgeContainer.appendChild(badge);
            });
        }

        async function fetchGeminiModels() {
            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            const checkboxList = document.getElementById('gemini_checkbox_list');
            const hiddenInput = document.getElementById('gemini_model_value');

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tải...';
            btn.disabled = true;

            try {
                const response = await fetch("{{ url_for('admin.fetch_gemini_models_api') }}");
                const data = await response.json();

                if (data.success) {
                    checkboxList.innerHTML = '';
                    checkboxList.classList.remove('hidden');

                    const currentValues = hiddenInput.value.split(',').map(s => s.trim()).filter(s => s);
                    // Initial render of badges to ensure DnD is active even before check
                    updateGeminiBadges(currentValues);

                    data.models.forEach(m => {
                        const div = document.createElement('div');
                        div.className = 'flex items-start gap-2 p-1 hover:bg-slate-100 rounded';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `chk_${m.id}`;
                        checkbox.value = m.id;
                        checkbox.className = 'mt-1 rounded border-slate-300 text-blue-600 focus:ring-blue-500';
                        if (currentValues.includes(m.id)) {
                            checkbox.checked = true;
                        }

                        checkbox.addEventListener('change', () => {
                            // Collect all checked boxes
                            const allChecked = Array.from(checkboxList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                            // Use updateGeminiBadges to merge logic and save order
                            updateGeminiBadges(allChecked);
                        });

                        const label = document.createElement('label');
                        label.htmlFor = `chk_${m.id}`;
                        label.className = 'text-sm text-slate-700 cursor-pointer flex-1';
                        label.innerHTML = `<span class="font-medium">${m.display_name}</span> <span class="text-slate-500 text-xs">(${m.id})</span>`;

                        div.appendChild(checkbox);
                        div.appendChild(label);
                        checkboxList.appendChild(div);
                    });

                    // Handle missing models (same as before)
                    currentValues.forEach(val => {
                        if (!data.models.find(m => m.id === val)) {
                            const div = document.createElement('div');
                            div.className = 'flex items-start gap-2 p-1 bg-amber-50 rounded border border-amber-100';
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = true;
                            checkbox.value = val;
                            checkbox.className = 'mt-1 rounded border-amber-300 text-amber-600 focus:ring-amber-500';

                            checkbox.addEventListener('change', () => {
                                const allChecked = Array.from(checkboxList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                                updateGeminiBadges(allChecked);
                            });

                            const label = document.createElement('label');
                            label.className = 'text-sm text-amber-800 cursor-pointer flex-1 italic';
                            label.innerHTML = `${val} (Không có trong danh sách API)`;

                            div.appendChild(checkbox);
                            div.appendChild(label);
                            checkboxList.prepend(div);
                        }
                    });

                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (e) {
                alert('Lỗi kết nối: ' + e);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        async function fetchHFModels() {
            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            const select = document.getElementById('hf_model_select');

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const response = await fetch("{{ url_for('admin.fetch_hf_models_api') }}");
                const data = await response.json();

                if (data.success) {
                    select.innerHTML = '';
                    const group = document.createElement('optgroup');
                    group.label = "Popular Text Generation Models";
                    data.models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.text = `${m.display_name} (${m.description})`;
                        group.appendChild(opt);
                    });
                    select.appendChild(group);

                    const customOpt = document.createElement('option');
                    customOpt.value = 'custom';
                    customOpt.text = 'Khác...';
                    select.appendChild(customOpt);

                    alert(`Đã cập nhật ${data.models.length} model từ Hugging Face.`);
                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (e) {
                alert('Lỗi kết nối: ' + e);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupCustomInput('gemini_model_select', 'gemini_custom_input');
            setupCustomInput('hf_model_select', 'hf_custom_input');

            // Initial state
            toggleProviderSettings();

            // Initialize Draggable Badges for Gemini
            const geminiHidden = document.getElementById('gemini_model_value');
            if (geminiHidden && geminiHidden.value) {
                const initialModels = geminiHidden.value.split(',').map(s => s.trim()).filter(s => s);
                updateGeminiBadges(initialModels);
            }
        });
    </script>
    {% endblock %}