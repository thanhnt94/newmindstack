{% extends "admin_layout.html" %}
{% set active_page = 'tasks' %}

{% block title %}Quản lý tác vụ nền{% endblock %}
{% block page_title %}Tác vụ hệ thống & xử lý nền{% endblock %}
{% block page_subtitle %}Theo dõi, khởi chạy và kiểm soát các tác vụ nền phục vụ việc tối ưu dữ liệu học tập.{% endblock %}

{% block extra_head %}
    <style>
        .data-card {
            border-radius: 1rem;
            background-color: #ffffff;
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 18px 40px -30px rgba(15, 23, 42, 0.45);
        }
        .data-card-header {
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
        .progress-bar-container {
            width: 100%;
            background-color: rgba(148, 163, 184, 0.2);
            border-radius: 9999px;
            overflow: hidden;
            height: 1.1rem;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(37,99,235,0.9), rgba(59,130,246,0.8));
            transition: width 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            font-size: 0.7rem;
        }
        .task-status-badge {
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-idle { background-color: #f1f5f9; color: #475569; }
        .status-running { background-color: #dbeafe; color: #1d4ed8; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-error { background-color: #fee2e2; color: #dc2626; }
    </style>
{% endblock %}

{% block content %}
<div class="data-card">
    <div class="data-card-header px-6 py-5 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
            <h2 class="text-xl font-semibold text-slate-900">Trạng thái tác vụ</h2>
            <p class="text-sm text-slate-500">Giữ cho thư viện nội dung luôn tối ưu bằng cách chủ động kích hoạt các tiến trình cần thiết.</p>
        </div>
        <a href="{{ url_for('admin.manage_background_tasks') }}" class="inline-flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800">
            <i class="fas fa-rotate-right"></i> Làm mới danh sách
        </a>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
                <tr>
                    <th class="px-6 py-3 text-left font-semibold">Tên tác vụ</th>
                    <th class="px-6 py-3 text-left font-semibold">Trạng thái</th>
                    <th class="px-6 py-3 text-left font-semibold">Tiến độ</th>
                    <th class="px-6 py-3 text-left font-semibold">Thông tin</th>
                    <th class="px-6 py-3 text-left font-semibold">Bật/Tắt</th>
                    <th class="px-6 py-3 text-left font-semibold">Hành động</th>
                </tr>
            </thead>
            <tbody id="tasks-table-body" class="divide-y divide-slate-100 text-sm">
                {% for task in tasks %}
                <tr class="hover:bg-slate-50" data-task-id="{{ task.task_id }}" data-task-name="{{ task.task_name }}">
                    <td class="px-6 py-4 font-medium text-slate-900">{{ task.task_name }}</td>
                    <td class="px-6 py-4">
                        <span class="task-status-badge status-{{ task.status }}">{{ task.status }}</span>
                    </td>
                    <td class="px-6 py-4">
                        {% set progress_percentage = (task.progress / task.total * 100) if task.total > 0 else 0 %}
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: {{ progress_percentage }}%;">{{ progress_percentage|int }}%</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-slate-600">{{ task.message }}</td>
                    <td class="px-6 py-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer toggle-task-checkbox" {% if task.is_enabled %}checked{% endif %} {% if task.status == 'running' %}disabled{% endif %}>
                            <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-200 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[3px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col gap-3">
                            {% if task.task_name in ['generate_audio_cache', 'generate_image_cache', 'generate_ai_explanations'] %}
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-2">
                                    {% if task.task_name == 'generate_image_cache' %}
                                        Phạm vi tạo ảnh minh họa
                                    {% elif task.task_name == 'generate_ai_explanations' %}
                                        Phạm vi tạo AI Explain
                                    {% else %}
                                        Phạm vi tạo cache audio
                                    {% endif %}
                                </label>
                                <select class="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400 flashcard-scope-select" data-default-label="{{ 'tất cả học liệu' if task.task_name == 'generate_ai_explanations' else 'tất cả bộ thẻ Flashcard' }}" {% if task.status == 'running' %}disabled{% endif %}>
                                    <option value="">Tất cả bộ thẻ Flashcard</option>
                                    {% for container in flashcard_containers %}
                                        <option value="{{ container.container_id }}">{{ container.title }}</option>
                                    {% endfor %}
                                </select>
                                <p class="text-xs text-slate-400 mt-1">
                                    {% if task.task_name == 'generate_image_cache' %}
                                        Chọn một bộ thẻ cụ thể nếu chỉ muốn bổ sung ảnh minh họa cho bộ đó.
                                    {% elif task.task_name == 'generate_ai_explanations' %}
                                        Chọn bộ thẻ cần tạo AI Explain tự động, hoặc để trống để áp dụng cho tất cả.
                                    {% else %}
                                        Chọn một bộ thẻ cụ thể để giới hạn phạm vi xử lý audio.
                                    {% endif %}
                                </p>
                            </div>
                            {% endif %}
                            {% if task.task_name == 'generate_ai_explanations' %}
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-2">Khoảng dừng giữa các yêu cầu (giây)</label>
                                <input type="number" step="0.5" min="0" value="{{ default_request_interval }}" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400 request-interval-input" {% if task.status == 'running' %}disabled{% endif %}>
                                <p class="text-xs text-slate-400 mt-1">Chọn thời gian nghỉ giữa các request để tránh bị giới hạn hoặc chặn.</p>
                            </div>
                            {% endif %}
                            <div class="flex items-center gap-2">
                                <button type="button" class="bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-md hover:bg-emerald-200 transition start-task-btn" {% if task.status == 'running' or not task.is_enabled %}disabled{% endif %}>
                                    <i class="fas fa-play"></i>
                                </button>
                                <button type="button" class="bg-rose-100 text-rose-700 px-3 py-1.5 rounded-md hover:bg-rose-200 transition stop-task-btn" {% if task.status != 'running' %}disabled{% endif %}>
                                    <i class="fas fa-stop"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-10 text-slate-500">Chưa có tác vụ nền nào được tạo.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.getElementById('tasks-table-body');

        function updateTaskRow(row, taskData) {
            const statusBadge = row.querySelector('.task-status-badge');
            const progressBarFill = row.querySelector('.progress-bar-fill');
            const startBtn = row.querySelector('.start-task-btn');
            const stopBtn = row.querySelector('.stop-task-btn');
            const toggleCheckbox = row.querySelector('.toggle-task-checkbox');
            const progressPercentage = taskData.total > 0 ? Math.round((taskData.progress / taskData.total) * 100) : 0;

            statusBadge.textContent = taskData.status;
            statusBadge.className = `task-status-badge status-${taskData.status}`;
            row.querySelector('td:nth-child(4)').textContent = taskData.message;

            progressBarFill.style.width = `${progressPercentage}%`;
            progressBarFill.textContent = `${progressPercentage}%`;

            startBtn.disabled = taskData.status === 'running' || !taskData.is_enabled;
            stopBtn.disabled = taskData.status !== 'running';
            toggleCheckbox.disabled = taskData.status === 'running';
            toggleCheckbox.checked = taskData.is_enabled;

            const scopeSelect = row.querySelector('.flashcard-scope-select');
            if (scopeSelect) {
                scopeSelect.disabled = taskData.status === 'running';
            }

            const intervalInput = row.querySelector('.request-interval-input');
            if (intervalInput) {
                intervalInput.disabled = taskData.status === 'running';
            }

            if (typeof taskData.progress === 'number') {
                row.dataset.progress = taskData.progress;
            } else if (!row.dataset.progress) {
                row.dataset.progress = 0;
            }

            if (typeof taskData.total === 'number') {
                row.dataset.total = taskData.total;
            } else if (!row.dataset.total) {
                row.dataset.total = 0;
            }
        }

        tableBody.addEventListener('change', async function(event) {
            if (event.target.classList.contains('toggle-task-checkbox')) {
                const row = event.target.closest('tr');
                const taskId = row.dataset.taskId;
                try {
                    const response = await axios.post(`/admin/tasks/toggle/${taskId}`);
                    if (response.data.success) {
                        showFlashMessage(`Tác vụ đã được ${response.data.is_enabled ? 'bật' : 'tắt'}.`, 'success');
                        row.querySelector('.start-task-btn').disabled = !response.data.is_enabled || response.data.status === 'running';
                    }
                } catch (error) {
                    console.error('Error toggling task:', error);
                    showFlashMessage('Lỗi khi thay đổi trạng thái tác vụ.', 'danger');
                }
            }
        });

        tableBody.addEventListener('click', async function(event) {
            const startBtn = event.target.closest('.start-task-btn');
            const stopBtn = event.target.closest('.stop-task-btn');
            const row = event.target.closest('tr');
            const taskId = row.dataset.taskId;

            if (startBtn && !startBtn.disabled) {
                const scopeSelect = row.querySelector('.flashcard-scope-select');
                const defaultScopeLabel = scopeSelect ? scopeSelect.dataset.defaultLabel || 'tất cả bộ thẻ Flashcard' : 'tất cả tác vụ';
                let containerId = null;
                let scopeLabel = defaultScopeLabel;

                if (scopeSelect) {
                    const rawValue = scopeSelect.value;
                    if (rawValue) {
                        containerId = rawValue;
                        const selectedOption = scopeSelect.options[scopeSelect.selectedIndex];
                        scopeLabel = selectedOption.textContent.trim();
                    }
                }

                const intervalInput = row.querySelector('.request-interval-input');
                let requestIntervalSeconds = intervalInput ? parseFloat(intervalInput.value) : null;
                if (Number.isNaN(requestIntervalSeconds)) {
                    requestIntervalSeconds = null;
                }

                try {
                    const response = await axios.post(`/admin/tasks/start/${taskId}`, {
                        container_id: containerId,
                        request_interval_seconds: requestIntervalSeconds
                    });

                    if (response.data.success) {
                        showFlashMessage(`Đã khởi chạy tác vụ cho ${response.data.scope_label || scopeLabel}.`, 'success');
                        row.querySelector('.start-task-btn').disabled = true;
                        row.querySelector('.stop-task-btn').disabled = false;
                        const toggleCheckbox = row.querySelector('.toggle-task-checkbox');
                        if (toggleCheckbox) {
                            toggleCheckbox.disabled = true;
                        }
                    }
                } catch (error) {
                    console.error('Error starting task:', error);
                    showFlashMessage('Không thể khởi chạy tác vụ. Vui lòng thử lại.', 'danger');
                }
            }

            if (stopBtn && !stopBtn.disabled) {
                try {
                    const response = await axios.post(`/admin/tasks/stop/${taskId}`);
                    if (response.data.success) {
                        showFlashMessage(response.data.message, 'info');
                        row.querySelector('.stop-task-btn').disabled = true;
                    }
                } catch (error) {
                    console.error('Error stopping task:', error);
                    showFlashMessage('Không thể dừng tác vụ. Vui lòng thử lại.', 'danger');
                }
            }
        });
    });
</script>
{% endblock %}
