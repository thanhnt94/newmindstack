{% extends "admin/admin_layout.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Bảng điều khiển quản trị{% endblock %}
{% block page_title %}Bảng điều khiển Mindstack{% endblock %}
{% block page_subtitle %}Theo dõi trạng thái hệ thống, nội dung học tập và hoạt động người dùng trong một giao diện trực quan.{% endblock %}

{% block extra_head %}
    <style>
        .metric-card {
            border-radius: 1rem;
            background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(30,64,175,0.85));
            color: #f8fafc;
            position: relative;
            overflow: hidden;
        }
        .metric-card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.25), transparent 55%);
            opacity: 0.6;
        }
        .metric-card > div {
            position: relative;
            z-index: 1;
        }
        .data-card {
            border-radius: 1rem;
            background-color: #ffffff;
            border: 1px solid rgba(15, 23, 42, 0.05);
            box-shadow: 0 25px 45px -25px rgba(15, 23, 42, 0.35);
        }
        .data-card-header {
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        }
    </style>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <section class="grid gap-5 sm:grid-cols-2 xl:grid-cols-4">
        <div class="metric-card px-6 py-6">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-sm uppercase tracking-widest text-slate-200/80">Người dùng</p>
                    <p class="text-3xl font-semibold mt-2">{{ stats_data.total_users }}</p>
                </div>
                <span class="text-4xl"><i class="fas fa-users"></i></span>
            </div>
            <p class="mt-4 text-sm text-slate-200/90">{{ stats_data.users_last_24h }} người dùng hoạt động trong 24h qua.</p>
        </div>
        <div class="metric-card px-6 py-6">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-sm uppercase tracking-widest text-slate-200/80">Bộ học liệu</p>
                    <p class="text-3xl font-semibold mt-2">{{ stats_data.total_containers }}</p>
                </div>
                <span class="text-4xl"><i class="fas fa-layer-group"></i></span>
            </div>
            <p class="mt-4 text-sm text-slate-200/90">Bao gồm flashcards, quiz và khóa học.</p>
        </div>
        <div class="metric-card px-6 py-6">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-sm uppercase tracking-widest text-slate-200/80">Học liệu con</p>
                    <p class="text-3xl font-semibold mt-2">{{ stats_data.total_items }}</p>
                </div>
                <span class="text-4xl"><i class="fas fa-shapes"></i></span>
            </div>
            <p class="mt-4 text-sm text-slate-200/90">Số lượng thẻ, câu hỏi và bài học chi tiết.</p>
        </div>
        <div class="metric-card px-6 py-6">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-sm uppercase tracking-widest text-slate-200/80">API keys</p>
                    <p class="text-3xl font-semibold mt-2">{{ stats_data.active_api_keys }}</p>
                </div>
                <span class="text-4xl"><i class="fas fa-key"></i></span>
            </div>
            <p class="mt-4 text-sm text-slate-200/90">{{ stats_data.exhausted_api_keys }} key đã cạn giới hạn.</p>
        </div>
    </section>

    <section class="grid gap-6 xl:grid-cols-3">
        <div class="xl:col-span-2 space-y-6">
            <div class="grid gap-4 md:grid-cols-3">
                <a href="{{ url_for('user_management.manage_users') }}" class="data-card px-6 py-5 hover:shadow-xl transition-transform hover:-translate-y-1">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-wide text-slate-400">Quản lý người dùng</p>
                            <h3 class="text-lg font-semibold text-slate-900 mt-2">Tài khoản & phân quyền</h3>
                        </div>
                        <span class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-900/90 text-white"><i class="fas fa-user-shield"></i></span>
                    </div>
                    <p class="mt-3 text-sm text-slate-500">Xem, tạo mới và cập nhật thông tin thành viên.</p>
                </a>
                <a href="{{ url_for('content_management.content_dashboard') }}" class="data-card px-6 py-5 hover:shadow-xl transition-transform hover:-translate-y-1">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-wide text-slate-400">Kho nội dung</p>
                            <h3 class="text-lg font-semibold text-slate-900 mt-2">Quản lý học liệu</h3>
                        </div>
                        <span class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-600 text-white"><i class="fas fa-box-archive"></i></span>
                    </div>
                    <p class="mt-3 text-sm text-slate-500">Điều phối flashcard set, quiz và khóa học.</p>
                </a>
                <a href="{{ url_for('admin.media_library') }}" class="data-card px-6 py-5 hover:shadow-xl transition-transform hover:-translate-y-1">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-wide text-slate-400">Tài nguyên</p>
                            <h3 class="text-lg font-semibold text-slate-900 mt-2">Thư viện media</h3>
                        </div>
                        <span class="w-10 h-10 flex items-center justify-center rounded-full bg-emerald-500 text-white"><i class="fas fa-photo-video"></i></span>
                    </div>
                    <p class="mt-3 text-sm text-slate-500">Quản lý hình ảnh, audio và tài liệu đính kèm.</p>
                </a>
            </div>

            <div class="data-card">
                <div class="data-card-header px-6 py-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-900">Hoạt động gần đây của người dùng</h2>
                    <a href="{{ url_for('user_management.manage_users') }}" class="text-sm text-blue-600 hover:text-blue-800">Xem tất cả</a>
                </div>
                <div class="px-6 py-4">
                    {% if recent_users %}
                        <ul class="divide-y divide-slate-100">
                            {% for user in recent_users %}
                                <li class="py-3 flex items-center justify-between">
                                    <div>
                                        <p class="font-medium text-slate-900">{{ user.username }}</p>
                                        <p class="text-xs text-slate-500 mt-1">Lần cuối truy cập: {{ user.last_seen.strftime('%d/%m/%Y %H:%M') }}</p>
                                    </div>
                                    <span class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600 uppercase tracking-wide">{{ user.user_role }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-sm text-slate-500">Chưa có dữ liệu đăng nhập gần đây.</p>
                    {% endif %}
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header px-6 py-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-900">Bộ học liệu mới tạo</h2>
                    <a href="{{ url_for('content_management.content_dashboard') }}" class="text-sm text-blue-600 hover:text-blue-800">Đi tới kho nội dung</a>
                </div>
                <div class="px-6 py-4">
                    {% if recent_containers %}
                        <ul class="divide-y divide-slate-100">
                            {% for container in recent_containers %}
                                <li class="py-3">
                                    <p class="font-medium text-slate-900">{{ container.title }}</p>
                                    <div class="mt-1 text-xs text-slate-500 flex items-center gap-3">
                                        <span class="inline-flex items-center gap-1"><i class="fas fa-stream"></i> {{ container.container_type }}</span>
                                        <span><i class="far fa-clock"></i> {{ container.created_at.strftime('%d/%m/%Y %H:%M') if container.created_at else 'Chưa cập nhật' }}</span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-sm text-slate-500">Chưa có bộ học liệu nào được tạo gần đây.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="data-card">
                <div class="data-card-header px-6 py-4">
                    <h2 class="text-lg font-semibold text-slate-900">Tình trạng hệ thống</h2>
                </div>
                <div class="px-6 py-5 space-y-4 text-sm text-slate-600">
                    <div class="flex items-center justify-between">
                        <span>Chế độ bảo trì</span>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold {{ 'bg-rose-100 text-rose-700' if overview_metrics.maintenance_mode else 'bg-emerald-100 text-emerald-700' }}">
                            {{ 'Đang bật' if overview_metrics.maintenance_mode else 'Hoạt động bình thường' }}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>API key khả dụng</span>
                        <span class="font-semibold text-slate-800">{{ overview_metrics.active_api_keys }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Người dùng hoạt động (7 ngày)</span>
                        <span class="font-semibold text-slate-800">{{ overview_metrics.active_weekly_users }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Lần sao lưu gần nhất</span>
                        <span class="font-semibold text-slate-800">{{ overview_metrics.last_backup or 'Chưa có bản sao lưu' }}</span>
                    </div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header px-6 py-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-900">Tác vụ nền</h2>
                    <a href="{{ url_for('admin.manage_background_tasks') }}" class="text-sm text-blue-600 hover:text-blue-800">Chi tiết</a>
                </div>
                <div class="px-6 py-5 space-y-4 text-sm">
                    {% if recent_tasks %}
                        {% for task in recent_tasks %}
                            <div class="p-4 border border-slate-100 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <p class="font-semibold text-slate-900">{{ task.task_name }}</p>
                                    <span class="text-xs font-semibold px-3 py-1 rounded-full
                                        {% if task.status == 'running' %}bg-blue-100 text-blue-700{% elif task.status == 'completed' %}bg-emerald-100 text-emerald-700{% elif task.status == 'error' %}bg-rose-100 text-rose-700{% else %}bg-slate-100 text-slate-600{% endif %}">
                                        {{ task.status|capitalize }}
                                    </span>
                                </div>
                                <p class="mt-2 text-xs text-slate-500">{{ task.message or 'Đang chờ thực thi.' }}</p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-slate-500">Chưa có tác vụ nào được cấu hình.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}
